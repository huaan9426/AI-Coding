# ç¬¬12ç«  Kubernetesé¡¹ç›®å®æˆ˜ä¸æœ€ä½³å®è·µ

## æœ¬ç« æ¦‚è¿°

ç»è¿‡å‰11ç« çš„ç³»ç»Ÿå­¦ä¹ ï¼Œä½ å·²ç»æŒæ¡äº†Kubernetesçš„æ ¸å¿ƒæ¦‚å¿µã€èµ„æºç®¡ç†ã€ç½‘ç»œå­˜å‚¨ã€å®‰å…¨æœºåˆ¶ã€ç›‘æ§å¯è§‚æµ‹æ€§ã€é«˜çº§ç‰¹æ€§ä»¥åŠæ•…éšœæ’æŸ¥ç­‰å®Œæ•´çŸ¥è¯†ä½“ç³»ã€‚æœ¬ç« å°†é€šè¿‡çœŸå®çš„é¡¹ç›®å®æˆ˜ï¼Œå°†è¿™äº›çŸ¥è¯†èä¼šè´¯é€šï¼Œå¸®åŠ©ä½ æ„å»ºç”Ÿäº§çº§çš„Kubernetesåº”ç”¨ã€‚

**ä¸ºä»€ä¹ˆéœ€è¦é¡¹ç›®å®æˆ˜ï¼Ÿ**

ç†è®ºçŸ¥è¯†å’Œå®é™…åº”ç”¨ä¹‹é—´å­˜åœ¨å·¨å¤§é¸¿æ²Ÿï¼š

ğŸ“š **ç†è®ºå­¦ä¹ é˜¶æ®µ**ï¼š
- ç†è§£Podã€Serviceã€Deploymentç­‰æ¦‚å¿µ
- çŸ¥é“å¦‚ä½•ç¼–å†™YAMLé…ç½®æ–‡ä»¶
- äº†è§£ç½‘ç»œã€å­˜å‚¨ã€å®‰å…¨çš„å·¥ä½œåŸç†
- æŒæ¡ç›‘æ§å’Œæ•…éšœæ’æŸ¥æ–¹æ³•

ğŸš€ **ç”Ÿäº§å®æˆ˜é˜¶æ®µ**ï¼š
- å¦‚ä½•è®¾è®¡é«˜å¯ç”¨çš„åº”ç”¨æ¶æ„ï¼Ÿ
- å¦‚ä½•å¤„ç†æœ‰çŠ¶æ€åº”ç”¨çš„éƒ¨ç½²ï¼Ÿ
- å¦‚ä½•å®ç°é›¶åœæœºæ»šåŠ¨æ›´æ–°ï¼Ÿ
- å¦‚ä½•ä¿è¯åº”ç”¨çš„å®‰å…¨æ€§å’Œæ€§èƒ½ï¼Ÿ
- å¦‚ä½•å»ºç«‹å®Œæ•´çš„CI/CDæµç¨‹ï¼Ÿ
- å¦‚ä½•åº”å¯¹çªå‘æµé‡å’Œæ•…éšœï¼Ÿ

**æœ¬ç« å®æˆ˜é¡¹ç›®**ï¼š

æˆ‘ä»¬å°†é€šè¿‡ä¸€ä¸ªå®Œæ•´çš„å¾®æœåŠ¡ç”µå•†ç³»ç»Ÿï¼Œæ¶µç›–Kubernetesç”Ÿäº§å®æˆ˜çš„å„ä¸ªæ–¹é¢ï¼š

```
ç”µå•†ç³»ç»Ÿæ¶æ„:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ç”¨æˆ·å±‚                                 â”‚
â”‚  Webæµè§ˆå™¨  â†â†’  ç§»åŠ¨App  â†â†’  ç¬¬ä¸‰æ–¹ç³»ç»Ÿ                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Ingresså±‚                                 â”‚
â”‚  Nginx Ingress Controller + TLSè¯ä¹¦ + é™æµ                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    APIç½‘å…³å±‚                                  â”‚
â”‚  Kong/APISIX - è®¤è¯ã€é‰´æƒã€é™æµã€ç†”æ–­                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   å¾®æœåŠ¡å±‚                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ç”¨æˆ·æœåŠ¡  â”‚  â”‚å•†å“æœåŠ¡  â”‚  â”‚è®¢å•æœåŠ¡  â”‚  â”‚æ”¯ä»˜æœåŠ¡  â”‚  â”‚
â”‚  â”‚(Go)      â”‚  â”‚(Java)    â”‚  â”‚(Python)  â”‚  â”‚(Node.js) â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æ•°æ®å±‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚MySQL     â”‚  â”‚Redis     â”‚  â”‚MongoDB   â”‚  â”‚RabbitMQ  â”‚  â”‚
â”‚  â”‚(ä¸»ä»)    â”‚  â”‚(é›†ç¾¤)    â”‚  â”‚(å‰¯æœ¬é›†)  â”‚  â”‚(é›†ç¾¤)    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æœ¬ç« ä¸»è¦å†…å®¹**ï¼š

1. **ä»é›¶æ­å»ºç”Ÿäº§çº§Kubernetesé›†ç¾¤** (12.1)
   - é›†ç¾¤è§„åˆ’ä¸æ¶æ„è®¾è®¡
   - é«˜å¯ç”¨æ§åˆ¶å¹³é¢éƒ¨ç½²
   - ç½‘ç»œå’Œå­˜å‚¨æ–¹æ¡ˆé€‰æ‹©
   - å®‰å…¨åŠ å›ºä¸æœ€ä½³å®è·µ

2. **å¾®æœåŠ¡åº”ç”¨å®¹å™¨åŒ–** (12.2)
   - Dockerfileæœ€ä½³å®è·µ
   - å¤šé˜¶æ®µæ„å»ºä¼˜åŒ–
   - é•œåƒå®‰å…¨æ‰«æ
   - ç§æœ‰é•œåƒä»“åº“æ­å»º

3. **åº”ç”¨éƒ¨ç½²ä¸é…ç½®ç®¡ç†** (12.3)
   - Helm Chartç¼–å†™
   - å¤šç¯å¢ƒé…ç½®ç®¡ç†
   - Secretå’ŒConfigMapç®¡ç†
   - åº”ç”¨ç‰ˆæœ¬ç®¡ç†

4. **æœåŠ¡ç½‘æ ¼ä¸æµé‡ç®¡ç†** (12.4)
   - IstioæœåŠ¡ç½‘æ ¼éƒ¨ç½²
   - ç°åº¦å‘å¸ƒä¸é‡‘ä¸é›€éƒ¨ç½²
   - æµé‡è·¯ç”±ä¸ç†”æ–­
   - åˆ†å¸ƒå¼è¿½è¸ª

5. **CI/CDæµæ°´çº¿æ„å»º** (12.5)
   - GitOpså·¥ä½œæµ
   - Jenkins/GitLab CIé›†æˆ
   - è‡ªåŠ¨åŒ–æµ‹è¯•
   - è‡ªåŠ¨åŒ–éƒ¨ç½²

6. **ç›‘æ§å‘Šè­¦ä¸æ—¥å¿—åˆ†æ** (12.6)
   - Prometheusç›‘æ§ä½“ç³»
   - Grafanaä»ªè¡¨æ¿
   - EFKæ—¥å¿—èšåˆ
   - å‘Šè­¦è§„åˆ™é…ç½®

7. **æ€§èƒ½ä¼˜åŒ–ä¸æˆæœ¬æ§åˆ¶** (12.7)
   - èµ„æºé…é¢ä¼˜åŒ–
   - HPA/VPAè‡ªåŠ¨æ‰©ç¼©å®¹
   - é›†ç¾¤æˆæœ¬åˆ†æ
   - æ€§èƒ½è°ƒä¼˜å®è·µ

8. **æœ¬ç« æ€»ç»“** (12.8)
   - é¡¹ç›®å®æˆ˜å›é¡¾
   - ç”Ÿäº§ç»éªŒæ€»ç»“
   - æŒç»­å­¦ä¹ è·¯å¾„

**å­¦ä¹ ç›®æ ‡**ï¼š

- âœ… èƒ½å¤Ÿä»é›¶æ­å»ºç”Ÿäº§çº§Kubernetesé›†ç¾¤
- âœ… æŒæ¡å¾®æœåŠ¡åº”ç”¨çš„å®¹å™¨åŒ–å’Œéƒ¨ç½²
- âœ… ç†è§£æœåŠ¡ç½‘æ ¼å’Œæµé‡ç®¡ç†
- âœ… å»ºç«‹å®Œæ•´çš„CI/CDæµæ°´çº¿
- âœ… å®æ–½å…¨é¢çš„ç›‘æ§å‘Šè­¦ä½“ç³»
- âœ… è¿›è¡Œæ€§èƒ½ä¼˜åŒ–å’Œæˆæœ¬æ§åˆ¶
- âœ… å…·å¤‡ç‹¬ç«‹è¿ç»´ç”Ÿäº§é›†ç¾¤çš„èƒ½åŠ›

**å‰ç½®çŸ¥è¯†**ï¼š

- ç†Ÿç»ƒæŒæ¡ç¬¬1-11ç« çš„æ‰€æœ‰å†…å®¹
- å…·å¤‡Linuxç³»ç»Ÿç®¡ç†ç»éªŒ
- äº†è§£Dockerå®¹å™¨æŠ€æœ¯
- ç†Ÿæ‚‰è‡³å°‘ä¸€é—¨ç¼–ç¨‹è¯­è¨€
- ç†è§£å¾®æœåŠ¡æ¶æ„ç†å¿µ

**æŠ€èƒ½ç­‰çº§è¦æ±‚**ï¼š

```yaml
åˆçº§å·¥ç¨‹å¸ˆ:
  - èƒ½å¤ŸæŒ‰ç…§æ–‡æ¡£æ­å»ºæµ‹è¯•é›†ç¾¤
  - ä¼šéƒ¨ç½²ç®€å•çš„æ— çŠ¶æ€åº”ç”¨
  - äº†è§£åŸºæœ¬çš„æ•…éšœæ’æŸ¥æ–¹æ³•

ä¸­çº§å·¥ç¨‹å¸ˆ:
  - èƒ½å¤Ÿæ­å»ºç”Ÿäº§çº§é«˜å¯ç”¨é›†ç¾¤
  - æŒæ¡æœ‰çŠ¶æ€åº”ç”¨çš„éƒ¨ç½²
  - ä¼šé…ç½®CI/CDæµæ°´çº¿
  - èƒ½å¤Ÿè¿›è¡Œæ€§èƒ½è°ƒä¼˜

é«˜çº§å·¥ç¨‹å¸ˆ/æ¶æ„å¸ˆ:
  - èƒ½å¤Ÿè®¾è®¡å¤§è§„æ¨¡é›†ç¾¤æ¶æ„
  - æŒæ¡æœåŠ¡ç½‘æ ¼å’Œé«˜çº§ç‰¹æ€§
  - ä¼šåˆ¶å®šæŠ€æœ¯é€‰å‹å’Œæœ€ä½³å®è·µ
  - èƒ½å¤Ÿè§£å†³å¤æ‚çš„ç”Ÿäº§é—®é¢˜
```

---

## æœ¬ç« å†…å®¹æ¦‚è§ˆ

```
ç¬¬12ç« : Kubernetesé¡¹ç›®å®æˆ˜ä¸æœ€ä½³å®è·µ
â”œâ”€â”€ 12.1 ä»é›¶æ­å»ºç”Ÿäº§çº§Kubernetesé›†ç¾¤
â”‚   â”œâ”€â”€ é›†ç¾¤è§„åˆ’ä¸æ¶æ„è®¾è®¡
â”‚   â”œâ”€â”€ é«˜å¯ç”¨æ§åˆ¶å¹³é¢éƒ¨ç½²
â”‚   â”œâ”€â”€ ç½‘ç»œæ–¹æ¡ˆé€‰æ‹©ä¸é…ç½®
â”‚   â”œâ”€â”€ å­˜å‚¨æ–¹æ¡ˆé€‰æ‹©ä¸é…ç½®
â”‚   â””â”€â”€ å®‰å…¨åŠ å›ºä¸æœ€ä½³å®è·µ
â”‚
â”œâ”€â”€ 12.2 å¾®æœåŠ¡åº”ç”¨å®¹å™¨åŒ–
â”‚   â”œâ”€â”€ Dockerfileæœ€ä½³å®è·µ
â”‚   â”œâ”€â”€ å¤šé˜¶æ®µæ„å»ºä¼˜åŒ–
â”‚   â”œâ”€â”€ é•œåƒå®‰å…¨æ‰«æ
â”‚   â””â”€â”€ ç§æœ‰é•œåƒä»“åº“æ­å»º
â”‚
â”œâ”€â”€ 12.3 åº”ç”¨éƒ¨ç½²ä¸é…ç½®ç®¡ç†
â”‚   â”œâ”€â”€ Helm Chartç¼–å†™
â”‚   â”œâ”€â”€ å¤šç¯å¢ƒé…ç½®ç®¡ç†
â”‚   â”œâ”€â”€ Secretå’ŒConfigMapç®¡ç†
â”‚   â””â”€â”€ åº”ç”¨ç‰ˆæœ¬ç®¡ç†
â”‚
â”œâ”€â”€ 12.4 æœåŠ¡ç½‘æ ¼ä¸æµé‡ç®¡ç†
â”‚   â”œâ”€â”€ IstioæœåŠ¡ç½‘æ ¼éƒ¨ç½²
â”‚   â”œâ”€â”€ ç°åº¦å‘å¸ƒä¸é‡‘ä¸é›€éƒ¨ç½²
â”‚   â”œâ”€â”€ æµé‡è·¯ç”±ä¸ç†”æ–­
â”‚   â””â”€â”€ åˆ†å¸ƒå¼è¿½è¸ª
â”‚
â”œâ”€â”€ 12.5 CI/CDæµæ°´çº¿æ„å»º
â”‚   â”œâ”€â”€ GitOpså·¥ä½œæµ
â”‚   â”œâ”€â”€ Jenkins/GitLab CIé›†æˆ
â”‚   â”œâ”€â”€ è‡ªåŠ¨åŒ–æµ‹è¯•
â”‚   â””â”€â”€ è‡ªåŠ¨åŒ–éƒ¨ç½²
â”‚
â”œâ”€â”€ 12.6 ç›‘æ§å‘Šè­¦ä¸æ—¥å¿—åˆ†æ
â”‚   â”œâ”€â”€ Prometheusç›‘æ§ä½“ç³»
â”‚   â”œâ”€â”€ Grafanaä»ªè¡¨æ¿
â”‚   â”œâ”€â”€ EFKæ—¥å¿—èšåˆ
â”‚   â””â”€â”€ å‘Šè­¦è§„åˆ™é…ç½®
â”‚
â”œâ”€â”€ 12.7 æ€§èƒ½ä¼˜åŒ–ä¸æˆæœ¬æ§åˆ¶
â”‚   â”œâ”€â”€ èµ„æºé…é¢ä¼˜åŒ–
â”‚   â”œâ”€â”€ HPA/VPAè‡ªåŠ¨æ‰©ç¼©å®¹
â”‚   â”œâ”€â”€ é›†ç¾¤æˆæœ¬åˆ†æ
â”‚   â””â”€â”€ æ€§èƒ½è°ƒä¼˜å®è·µ
â”‚
â””â”€â”€ 12.8 æœ¬ç« æ€»ç»“
    â”œâ”€â”€ é¡¹ç›®å®æˆ˜å›é¡¾
    â”œâ”€â”€ ç”Ÿäº§ç»éªŒæ€»ç»“
    â””â”€â”€ æŒç»­å­¦ä¹ è·¯å¾„
```

---

## 12.1 ä»é›¶æ­å»ºç”Ÿäº§çº§Kubernetesé›†ç¾¤

æ­å»ºä¸€ä¸ªç”Ÿäº§çº§çš„Kubernetesé›†ç¾¤æ˜¯ä¸€é¡¹ç³»ç»Ÿå·¥ç¨‹ï¼Œéœ€è¦ç»¼åˆè€ƒè™‘é«˜å¯ç”¨æ€§ã€å®‰å…¨æ€§ã€æ€§èƒ½å’Œå¯ç»´æŠ¤æ€§ã€‚æœ¬èŠ‚å°†å¸¦ä½ ä»é›¶å¼€å§‹ï¼Œæ„å»ºä¸€ä¸ªç¬¦åˆç”Ÿäº§æ ‡å‡†çš„Kubernetesé›†ç¾¤ã€‚

### 12.1.1 é›†ç¾¤è§„åˆ’ä¸æ¶æ„è®¾è®¡

åœ¨å¼€å§‹éƒ¨ç½²ä¹‹å‰ï¼Œå¿…é¡»è¿›è¡Œå……åˆ†çš„è§„åˆ’å’Œè®¾è®¡ã€‚

#### é›†ç¾¤è§„æ¨¡è¯„ä¼°

**æ ¹æ®ä¸šåŠ¡éœ€æ±‚ç¡®å®šé›†ç¾¤è§„æ¨¡**ï¼š

```yaml
å°å‹é›†ç¾¤ (å¼€å‘/æµ‹è¯•ç¯å¢ƒ):
  èŠ‚ç‚¹æ•°é‡: 3-5ä¸ªèŠ‚ç‚¹
  MasterèŠ‚ç‚¹: 1ä¸ª
  WorkerèŠ‚ç‚¹: 2-4ä¸ª
  é€‚ç”¨åœºæ™¯:
    - å¼€å‘æµ‹è¯•ç¯å¢ƒ
    - å°å‹åº”ç”¨ (<50ä¸ªPod)
    - å­¦ä¹ å’Œå®éªŒ

ä¸­å‹é›†ç¾¤ (ç”Ÿäº§ç¯å¢ƒ):
  èŠ‚ç‚¹æ•°é‡: 10-50ä¸ªèŠ‚ç‚¹
  MasterèŠ‚ç‚¹: 3ä¸ª (é«˜å¯ç”¨)
  WorkerèŠ‚ç‚¹: 7-47ä¸ª
  é€‚ç”¨åœºæ™¯:
    - ä¸­å°å‹ä¼ä¸šç”Ÿäº§ç¯å¢ƒ
    - åº”ç”¨æ•°é‡: 50-500ä¸ªPod
    - æ—¥å‡è¯·æ±‚: ç™¾ä¸‡çº§

å¤§å‹é›†ç¾¤ (å¤§è§„æ¨¡ç”Ÿäº§):
  èŠ‚ç‚¹æ•°é‡: 50-5000ä¸ªèŠ‚ç‚¹
  MasterèŠ‚ç‚¹: 3-5ä¸ª (é«˜å¯ç”¨ + è´Ÿè½½å‡è¡¡)
  WorkerèŠ‚ç‚¹: 47-4995ä¸ª
  é€‚ç”¨åœºæ™¯:
    - å¤§å‹äº’è”ç½‘å…¬å¸
    - åº”ç”¨æ•°é‡: 500+ä¸ªPod
    - æ—¥å‡è¯·æ±‚: åƒä¸‡çº§ä»¥ä¸Š
```

**èµ„æºè§„åˆ’ç¤ºä¾‹**ï¼š

```yaml
# ä¸­å‹ç”Ÿäº§é›†ç¾¤èµ„æºè§„åˆ’
é›†ç¾¤æ€»è§ˆ:
  èŠ‚ç‚¹æ€»æ•°: 15ä¸ª
  MasterèŠ‚ç‚¹: 3ä¸ª
  WorkerèŠ‚ç‚¹: 12ä¸ª

MasterèŠ‚ç‚¹é…ç½®:
  CPU: 4æ ¸
  å†…å­˜: 16GB
  ç£ç›˜:
    - ç³»ç»Ÿç›˜: 100GB SSD
    - etcdæ•°æ®ç›˜: 200GB SSD (IOPS >3000)
  ç½‘ç»œ: ä¸‡å…†ç½‘å¡

WorkerèŠ‚ç‚¹é…ç½®:
  CPU: 16æ ¸
  å†…å­˜: 64GB
  ç£ç›˜:
    - ç³»ç»Ÿç›˜: 100GB SSD
    - å®¹å™¨å­˜å‚¨: 500GB SSD
    - æ•°æ®å­˜å‚¨: 1TB SSD (æ ¹æ®éœ€æ±‚)
  ç½‘ç»œ: ä¸‡å…†ç½‘å¡

ç½‘ç»œè§„åˆ’:
  Pod CIDR: 10.244.0.0/16 (æ”¯æŒ65536ä¸ªPod)
  Service CIDR: 10.96.0.0/12 (æ”¯æŒ1048576ä¸ªService)
  èŠ‚ç‚¹ç½‘ç»œ: 192.168.1.0/24
```

#### é«˜å¯ç”¨æ¶æ„è®¾è®¡

**ç”Ÿäº§çº§é«˜å¯ç”¨æ¶æ„**ï¼š

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚      å¤–éƒ¨è´Ÿè½½å‡è¡¡å™¨ (HAProxy/LVS)    â”‚
                    â”‚      VIP: 192.168.1.100             â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                                      â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                     â”‚            â”‚                      â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
    â”‚ Master1 â”‚          â”‚ Master2 â”‚  â”‚ Master3 â”‚
    â”‚         â”‚          â”‚         â”‚  â”‚         â”‚
    â”‚ API     â”‚          â”‚ API     â”‚  â”‚ API     â”‚
    â”‚ Server  â”‚          â”‚ Server  â”‚  â”‚ Server  â”‚
    â”‚         â”‚          â”‚         â”‚  â”‚         â”‚
    â”‚ Sched   â”‚          â”‚ Sched   â”‚  â”‚ Sched   â”‚
    â”‚ uler    â”‚          â”‚ uler    â”‚  â”‚ uler    â”‚
    â”‚         â”‚          â”‚         â”‚  â”‚         â”‚
    â”‚ Ctrl    â”‚          â”‚ Ctrl    â”‚  â”‚ Ctrl    â”‚
    â”‚ Manager â”‚          â”‚ Manager â”‚  â”‚ Manager â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
         â”‚                    â”‚            â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   etcdé›†ç¾¤ (3èŠ‚ç‚¹) â”‚
                    â”‚   - etcd1          â”‚
                    â”‚   - etcd2          â”‚
                    â”‚   - etcd3          â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                                          â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
    â”‚ Worker1 â”‚  â”‚ Worker2  â”‚  â”‚ Worker3  â”‚  â”‚ Worker12â”‚
    â”‚         â”‚  â”‚          â”‚  â”‚          â”‚  â”‚         â”‚
    â”‚ kubelet â”‚  â”‚ kubelet  â”‚  â”‚ kubelet  â”‚  â”‚ kubelet â”‚
    â”‚ kube-   â”‚  â”‚ kube-    â”‚  â”‚ kube-    â”‚  â”‚ kube-   â”‚
    â”‚ proxy   â”‚  â”‚ proxy    â”‚  â”‚ proxy    â”‚  â”‚ proxy   â”‚
    â”‚         â”‚  â”‚          â”‚  â”‚          â”‚  â”‚         â”‚
    â”‚ å®¹å™¨    â”‚  â”‚ å®¹å™¨     â”‚  â”‚ å®¹å™¨     â”‚  â”‚ å®¹å™¨    â”‚
    â”‚ è¿è¡Œæ—¶  â”‚  â”‚ è¿è¡Œæ—¶   â”‚  â”‚ è¿è¡Œæ—¶   â”‚  â”‚ è¿è¡Œæ—¶  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**é«˜å¯ç”¨å…³é”®ç‚¹**ï¼š

1. **æ§åˆ¶å¹³é¢é«˜å¯ç”¨**ï¼š
   - 3ä¸ªMasterèŠ‚ç‚¹ï¼Œå¥‡æ•°ä¸ªé¿å…è„‘è£‚
   - é€šè¿‡è´Ÿè½½å‡è¡¡å™¨æä¾›ç»Ÿä¸€å…¥å£
   - API Serveræ— çŠ¶æ€ï¼Œå¯æ°´å¹³æ‰©å±•

2. **etcdé›†ç¾¤é«˜å¯ç”¨**ï¼š
   - 3ä¸ªetcdèŠ‚ç‚¹ï¼Œæ”¯æŒ1ä¸ªèŠ‚ç‚¹æ•…éšœ
   - ç‹¬ç«‹éƒ¨ç½²æˆ–ä¸MasterèŠ‚ç‚¹æ··éƒ¨
   - ä½¿ç”¨SSDç£ç›˜ï¼Œç¡®ä¿IOPS >3000

3. **è´Ÿè½½å‡è¡¡å™¨é«˜å¯ç”¨**ï¼š
   - HAProxy + Keepalivedå®ç°VIPæ¼‚ç§»
   - æˆ–ä½¿ç”¨äº‘å‚å•†çš„è´Ÿè½½å‡è¡¡æœåŠ¡

#### èŠ‚ç‚¹è§’è‰²è§„åˆ’

**èŠ‚ç‚¹åˆ†ç±»ä¸èŒè´£**ï¼š

```yaml
MasterèŠ‚ç‚¹ (æ§åˆ¶å¹³é¢):
  ç»„ä»¶:
    - kube-apiserver: APIæœåŠ¡å™¨
    - kube-scheduler: è°ƒåº¦å™¨
    - kube-controller-manager: æ§åˆ¶å™¨ç®¡ç†å™¨
    - etcd: åˆ†å¸ƒå¼é”®å€¼å­˜å‚¨
  ç‰¹ç‚¹:
    - ä¸è¿è¡Œä¸šåŠ¡Pod (é€šè¿‡æ±¡ç‚¹å®ç°)
    - éœ€è¦é«˜å¯ç”¨å’Œé«˜æ€§èƒ½
    - èµ„æºéœ€æ±‚ç›¸å¯¹ç¨³å®š

WorkerèŠ‚ç‚¹ (å·¥ä½œè´Ÿè½½):
  ç»„ä»¶:
    - kubelet: èŠ‚ç‚¹ä»£ç†
    - kube-proxy: ç½‘ç»œä»£ç†
    - å®¹å™¨è¿è¡Œæ—¶: containerd/CRI-O
  ç‰¹ç‚¹:
    - è¿è¡Œä¸šåŠ¡Pod
    - å¯æ ¹æ®è´Ÿè½½åŠ¨æ€æ‰©ç¼©å®¹
    - èµ„æºéœ€æ±‚æ³¢åŠ¨è¾ƒå¤§

è¾¹ç¼˜èŠ‚ç‚¹ (å¯é€‰):
  ç”¨é€”:
    - è¿è¡ŒIngress Controller
    - è¿è¡Œç›‘æ§ç»„ä»¶
    - è¿è¡Œæ—¥å¿—æ”¶é›†ç»„ä»¶
  ç‰¹ç‚¹:
    - å›ºå®šIPæˆ–åŸŸå
    - è¾ƒé«˜çš„ç½‘ç»œå¸¦å®½
    - ç‹¬ç«‹çš„èµ„æºé…é¢
```

#### ç½‘ç»œæ–¹æ¡ˆé€‰æ‹©

**å¸¸è§CNIæ’ä»¶å¯¹æ¯”**ï¼š

| CNIæ’ä»¶ | æ€§èƒ½ | åŠŸèƒ½ | å¤æ‚åº¦ | é€‚ç”¨åœºæ™¯ |
|---------|------|------|--------|----------|
| **Flannel** | â­â­â­ | â­â­ | â­ ç®€å• | å°å‹é›†ç¾¤ã€å­¦ä¹ ç¯å¢ƒ |
| **Calico** | â­â­â­â­ | â­â­â­â­â­ | â­â­â­ ä¸­ç­‰ | ç”Ÿäº§ç¯å¢ƒã€éœ€è¦NetworkPolicy |
| **Cilium** | â­â­â­â­â­ | â­â­â­â­â­ | â­â­â­â­ å¤æ‚ | å¤§è§„æ¨¡é›†ç¾¤ã€éœ€è¦eBPF |
| **Weave** | â­â­â­ | â­â­â­ | â­â­ ç®€å• | ä¸­å°å‹é›†ç¾¤ |

**æ¨èæ–¹æ¡ˆï¼šCalico**

```yaml
é€‰æ‹©ç†ç”±:
  1. æ€§èƒ½ä¼˜ç§€: åŸºäºBGPè·¯ç”±ï¼Œæ€§èƒ½æ¥è¿‘åŸç”Ÿç½‘ç»œ
  2. åŠŸèƒ½å®Œå–„: æ”¯æŒNetworkPolicyã€IPAMã€BGPç­‰
  3. ç¤¾åŒºæ´»è·ƒ: æ–‡æ¡£å®Œå–„ï¼Œé—®é¢˜å®¹æ˜“è§£å†³
  4. ç”Ÿäº§éªŒè¯: å¤§é‡ä¼ä¸šç”Ÿäº§ç¯å¢ƒä½¿ç”¨

ç½‘ç»œæ¨¡å¼é€‰æ‹©:
  - IPIPæ¨¡å¼: è·¨å­ç½‘é€šä¿¡ï¼Œå…¼å®¹æ€§å¥½
  - BGPæ¨¡å¼: åŒå­ç½‘é€šä¿¡ï¼Œæ€§èƒ½æœ€ä½³
  - VXLANæ¨¡å¼: äº‘ç¯å¢ƒæ¨è
```

#### å­˜å‚¨æ–¹æ¡ˆé€‰æ‹©

**å­˜å‚¨ç±»å‹å¯¹æ¯”**ï¼š

```yaml
æœ¬åœ°å­˜å‚¨ (Local PV):
  ä¼˜ç‚¹:
    - æ€§èƒ½æœ€å¥½ (ç›´æ¥è®¿é—®æœ¬åœ°ç£ç›˜)
    - å»¶è¿Ÿæœ€ä½
    - æˆæœ¬æœ€ä½
  ç¼ºç‚¹:
    - ä¸æ”¯æŒPodè¿ç§»
    - æ•°æ®å¯é æ€§ä¾èµ–èŠ‚ç‚¹
  é€‚ç”¨åœºæ™¯:
    - ç¼“å­˜æ•°æ®
    - ä¸´æ—¶æ•°æ®
    - é«˜æ€§èƒ½æ•°æ®åº“ (é…åˆå‰¯æœ¬)

ç½‘ç»œå­˜å‚¨ (NFS/Ceph/GlusterFS):
  ä¼˜ç‚¹:
    - æ”¯æŒPodè¿ç§»
    - æ•°æ®é«˜å¯ç”¨
    - æ”¯æŒå¤šèŠ‚ç‚¹å…±äº«
  ç¼ºç‚¹:
    - æ€§èƒ½è¾ƒå·®
    - ç½‘ç»œä¾èµ–
    - è¿ç»´å¤æ‚
  é€‚ç”¨åœºæ™¯:
    - å…±äº«æ–‡ä»¶å­˜å‚¨
    - æ—¥å¿—æ”¶é›†
    - é…ç½®æ–‡ä»¶

äº‘å­˜å‚¨ (EBS/äº‘ç›˜):
  ä¼˜ç‚¹:
    - é«˜å¯ç”¨
    - æ˜“äºç®¡ç†
    - æŒ‰éœ€æ‰©å®¹
  ç¼ºç‚¹:
    - æˆæœ¬è¾ƒé«˜
    - æ€§èƒ½å—é™äºäº‘å‚å•†
    - å‚å•†é”å®š
  é€‚ç”¨åœºæ™¯:
    - äº‘ä¸Šéƒ¨ç½²
    - å¿«é€Ÿä¸Šçº¿
    - ä¸­å°è§„æ¨¡åº”ç”¨
```

**æ¨èæ–¹æ¡ˆï¼šæ··åˆå­˜å‚¨**

```yaml
å­˜å‚¨åˆ†å±‚ç­–ç•¥:
  é«˜æ€§èƒ½å±‚ (Local PV + Rook-Ceph):
    - æ•°æ®åº“: MySQL/PostgreSQL/MongoDB
    - ç¼“å­˜: Redis/Memcached
    - æ¶ˆæ¯é˜Ÿåˆ—: Kafka/RabbitMQ
  
  æ ‡å‡†å±‚ (Ceph RBD):
    - åº”ç”¨æ•°æ®
    - ç”¨æˆ·ä¸Šä¼ æ–‡ä»¶
    - æ—¥å¿—æ•°æ®
  
  å½’æ¡£å±‚ (å¯¹è±¡å­˜å‚¨):
    - å¤‡ä»½æ•°æ®
    - å†å²æ—¥å¿—
    - å†·æ•°æ®
```

### 12.1.2 é«˜å¯ç”¨æ§åˆ¶å¹³é¢éƒ¨ç½²

ä½¿ç”¨kubeadméƒ¨ç½²é«˜å¯ç”¨Kubernetesé›†ç¾¤ã€‚

#### ç¯å¢ƒå‡†å¤‡

**èŠ‚ç‚¹ä¿¡æ¯**ï¼š

```bash
# èŠ‚ç‚¹è§„åˆ’
192.168.1.11  k8s-master1  # MasterèŠ‚ç‚¹1
192.168.1.12  k8s-master2  # MasterèŠ‚ç‚¹2
192.168.1.13  k8s-master3  # MasterèŠ‚ç‚¹3
192.168.1.21  k8s-worker1  # WorkerèŠ‚ç‚¹1
192.168.1.22  k8s-worker2  # WorkerèŠ‚ç‚¹2
192.168.1.23  k8s-worker3  # WorkerèŠ‚ç‚¹3
192.168.1.100 k8s-api-vip  # API Server VIP
```

**ç³»ç»Ÿè¦æ±‚**ï¼š

```bash
# æ“ä½œç³»ç»Ÿ
Ubuntu 22.04 LTS / CentOS 8 Stream / Rocky Linux 8

# å†…æ ¸ç‰ˆæœ¬
>= 4.19

# ç³»ç»Ÿé…ç½®
- å…³é—­swap
- å…³é—­SELinux/AppArmor (æˆ–é…ç½®ä¸ºPermissive)
- é…ç½®é˜²ç«å¢™è§„åˆ™
- åŒæ­¥æ—¶é—´
```

#### æ­¥éª¤1ï¼šæ‰€æœ‰èŠ‚ç‚¹åŸºç¡€é…ç½®

```bash
# 1. é…ç½®ä¸»æœºåå’Œhosts
cat >> /etc/hosts << EOF
192.168.1.11 k8s-master1
192.168.1.12 k8s-master2
192.168.1.13 k8s-master3
192.168.1.21 k8s-worker1
192.168.1.22 k8s-worker2
192.168.1.23 k8s-worker3
192.168.1.100 k8s-api-vip
EOF

# 2. å…³é—­swap
swapoff -a
sed -i '/swap/d' /etc/fstab

# 3. åŠ è½½å†…æ ¸æ¨¡å—
cat > /etc/modules-load.d/k8s.conf << EOF
overlay
br_netfilter
EOF

modprobe overlay
modprobe br_netfilter

# 4. é…ç½®å†…æ ¸å‚æ•°
cat > /etc/sysctl.d/k8s.conf << EOF
net.bridge.bridge-nf-call-iptables  = 1
net.bridge.bridge-nf-call-ip6tables = 1
net.ipv4.ip_forward                 = 1
EOF

sysctl --system

# 5. å®‰è£…å®¹å™¨è¿è¡Œæ—¶ (containerd)
# Ubuntu
apt-get update
apt-get install -y containerd

# CentOS/Rocky
dnf install -y containerd

# é…ç½®containerd
mkdir -p /etc/containerd
containerd config default > /etc/containerd/config.toml

# ä¿®æ”¹é…ç½®ä½¿ç”¨systemd cgroup driver
sed -i 's/SystemdCgroup = false/SystemdCgroup = true/' /etc/containerd/config.toml

# é‡å¯containerd
systemctl restart containerd
systemctl enable containerd

# 6. å®‰è£…kubeadmã€kubeletã€kubectl
# Ubuntu
apt-get update
apt-get install -y apt-transport-https ca-certificates curl
curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.28/deb/Release.key | gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg
echo 'deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.28/deb/ /' | tee /etc/apt/sources.list.d/kubernetes.list
apt-get update
apt-get install -y kubelet=1.28.0-1.1 kubeadm=1.28.0-1.1 kubectl=1.28.0-1.1
apt-mark hold kubelet kubeadm kubectl

# CentOS/Rocky
cat > /etc/yum.repos.d/kubernetes.repo << EOF
[kubernetes]
name=Kubernetes
baseurl=https://pkgs.k8s.io/core:/stable:/v1.28/rpm/
enabled=1
gpgcheck=1
gpgkey=https://pkgs.k8s.io/core:/stable:/v1.28/rpm/repodata/repomd.xml.key
EOF

dnf install -y kubelet-1.28.0 kubeadm-1.28.0 kubectl-1.28.0
systemctl enable kubelet
```

#### æ­¥éª¤2ï¼šéƒ¨ç½²è´Ÿè½½å‡è¡¡å™¨

åœ¨æ‰€æœ‰MasterèŠ‚ç‚¹ä¸Šéƒ¨ç½²HAProxy + Keepalivedï¼š

```bash
# å®‰è£…HAProxyå’ŒKeepalived
apt-get install -y haproxy keepalived

# é…ç½®HAProxy
cat > /etc/haproxy/haproxy.cfg << 'HAPROXY_EOF'
global
    log /dev/log local0
    log /dev/log local1 notice
    chroot /var/lib/haproxy
    stats socket /run/haproxy/admin.sock mode 660 level admin
    stats timeout 30s
    user haproxy
    group haproxy
    daemon

defaults
    log     global
    mode    tcp
    option  tcplog
    option  dontlognull
    timeout connect 5000
    timeout client  50000
    timeout server  50000

frontend k8s-api
    bind *:6443
    mode tcp
    option tcplog
    default_backend k8s-api-backend

backend k8s-api-backend
    mode tcp
    option tcp-check
    balance roundrobin
    server k8s-master1 192.168.1.11:6443 check fall 3 rise 2
    server k8s-master2 192.168.1.12:6443 check fall 3 rise 2
    server k8s-master3 192.168.1.13:6443 check fall 3 rise 2
HAPROXY_EOF

# é…ç½®Keepalived (Master1)
cat > /etc/keepalived/keepalived.conf << 'KEEPALIVED_EOF'
vrrp_script check_haproxy {
    script "/usr/bin/killall -0 haproxy"
    interval 2
    weight 2
}

vrrp_instance VI_1 {
    state MASTER
    interface eth0
    virtual_router_id 51
    priority 100
    advert_int 1
    authentication {
        auth_type PASS
        auth_pass k8s_ha_pass
    }
    virtual_ipaddress {
        192.168.1.100
    }
    track_script {
        check_haproxy
    }
}
KEEPALIVED_EOF

# Master2å’ŒMaster3çš„priorityåˆ†åˆ«è®¾ç½®ä¸º99å’Œ98

# å¯åŠ¨æœåŠ¡
systemctl restart haproxy
systemctl enable haproxy
systemctl restart keepalived
systemctl enable keepalived
```

#### æ­¥éª¤3ï¼šåˆå§‹åŒ–ç¬¬ä¸€ä¸ªMasterèŠ‚ç‚¹

```bash
# åœ¨k8s-master1ä¸Šæ‰§è¡Œ

# åˆ›å»ºkubeadmé…ç½®æ–‡ä»¶
cat > kubeadm-config.yaml << 'KUBEADM_EOF'
apiVersion: kubeadm.k8s.io/v1beta3
kind: ClusterConfiguration
kubernetesVersion: v1.28.0
controlPlaneEndpoint: "192.168.1.100:6443"
networking:
  podSubnet: "10.244.0.0/16"
  serviceSubnet: "10.96.0.0/12"
apiServer:
  certSANs:
  - "192.168.1.100"
  - "k8s-api-vip"
  - "192.168.1.11"
  - "192.168.1.12"
  - "192.168.1.13"
  extraArgs:
    authorization-mode: "Node,RBAC"
etcd:
  local:
    dataDir: /var/lib/etcd
    extraArgs:
      listen-metrics-urls: "http://0.0.0.0:2381"
---
apiVersion: kubelet.config.k8s.io/v1beta1
kind: KubeletConfiguration
cgroupDriver: systemd
KUBEADM_EOF

# åˆå§‹åŒ–é›†ç¾¤
kubeadm init --config=kubeadm-config.yaml --upload-certs

# é…ç½®kubectl
mkdir -p $HOME/.kube
cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
chown $(id -u):$(id -g) $HOME/.kube/config

# è®°å½•è¾“å‡ºçš„joinå‘½ä»¤ï¼Œåç»­éœ€è¦ä½¿ç”¨
```

#### æ­¥éª¤4ï¼šåŠ å…¥å…¶ä»–MasterèŠ‚ç‚¹

```bash
# åœ¨k8s-master2å’Œk8s-master3ä¸Šæ‰§è¡Œ
# ä½¿ç”¨kubeadm initè¾“å‡ºçš„joinå‘½ä»¤

kubeadm join 192.168.1.100:6443 --token <token> \
    --discovery-token-ca-cert-hash sha256:<hash> \
    --control-plane --certificate-key <certificate-key>

# é…ç½®kubectl
mkdir -p $HOME/.kube
cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
chown $(id -u):$(id -g) $HOME/.kube/config
```

#### æ­¥éª¤5ï¼šåŠ å…¥WorkerèŠ‚ç‚¹

```bash
# åœ¨æ‰€æœ‰WorkerèŠ‚ç‚¹ä¸Šæ‰§è¡Œ

kubeadm join 192.168.1.100:6443 --token <token> \
    --discovery-token-ca-cert-hash sha256:<hash>
```

#### æ­¥éª¤6ï¼šå®‰è£…ç½‘ç»œæ’ä»¶

```bash
# åœ¨ä»»æ„MasterèŠ‚ç‚¹ä¸Šæ‰§è¡Œ

# å®‰è£…Calico
kubectl apply -f https://raw.githubusercontent.com/projectcalico/calico/v3.26.0/manifests/calico.yaml

# ç­‰å¾…æ‰€æœ‰Podè¿è¡Œ
kubectl get pods -n kube-system -w

# éªŒè¯èŠ‚ç‚¹çŠ¶æ€
kubectl get nodes
```

#### æ­¥éª¤7ï¼šéªŒè¯é›†ç¾¤

```bash
# 1. æ£€æŸ¥èŠ‚ç‚¹çŠ¶æ€
kubectl get nodes
# æ‰€æœ‰èŠ‚ç‚¹åº”è¯¥æ˜¯ReadyçŠ¶æ€

# 2. æ£€æŸ¥ç»„ä»¶çŠ¶æ€
kubectl get pods -n kube-system

# 3. æ£€æŸ¥etcdé›†ç¾¤
kubectl -n kube-system exec -it etcd-k8s-master1 -- etcdctl \
  --endpoints=https://127.0.0.1:2379 \
  --cacert=/etc/kubernetes/pki/etcd/ca.crt \
  --cert=/etc/kubernetes/pki/etcd/server.crt \
  --key=/etc/kubernetes/pki/etcd/server.key \
  member list

# 4. æµ‹è¯•é«˜å¯ç”¨
# åœæ­¢master1çš„kubelet
systemctl stop kubelet

# åœ¨å…¶ä»–èŠ‚ç‚¹éªŒè¯API Serverä»ç„¶å¯ç”¨
kubectl get nodes

# æ¢å¤master1
systemctl start kubelet
```


### 12.1.3 ç½‘ç»œå’Œå­˜å‚¨é…ç½®

#### Calicoç½‘ç»œé…ç½®ä¼˜åŒ–

```bash
# ä¸‹è½½Calicoé…ç½®æ–‡ä»¶
curl -O https://raw.githubusercontent.com/projectcalico/calico/v3.26.0/manifests/calico.yaml

# ä¿®æ”¹é…ç½®
# 1. ä¿®æ”¹Pod CIDR (å¦‚æœä¸kubeadmé…ç½®ä¸åŒ)
# 2. å¯ç”¨IP-in-IPæˆ–VXLANæ¨¡å¼
# 3. é…ç½®MTUå¤§å°

# åº”ç”¨é…ç½®
kubectl apply -f calico.yaml

# éªŒè¯CalicoçŠ¶æ€
kubectl get pods -n kube-system -l k8s-app=calico-node
kubectl get pods -n kube-system -l k8s-app=calico-kube-controllers

# æŸ¥çœ‹CalicoèŠ‚ç‚¹çŠ¶æ€
kubectl exec -n kube-system calico-node-xxxxx -- calicoctl node status
```

**Calico NetworkPolicyç¤ºä¾‹**ï¼š

```yaml
# é™åˆ¶Podåªèƒ½è¢«ç‰¹å®šå‘½åç©ºé—´è®¿é—®
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-from-frontend
  namespace: backend
spec:
  podSelector:
    matchLabels:
      app: api
  policyTypes:
  - Ingress
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          name: frontend
    ports:
    - protocol: TCP
      port: 8080
```

#### éƒ¨ç½²Rook-Cephå­˜å‚¨

```bash
# 1. å…‹éš†Rookä»“åº“
git clone --single-branch --branch v1.12.0 https://github.com/rook/rook.git
cd rook/deploy/examples

# 2. éƒ¨ç½²Rook Operator
kubectl apply -f crds.yaml
kubectl apply -f common.yaml
kubectl apply -f operator.yaml

# 3. éªŒè¯Operatorè¿è¡Œ
kubectl -n rook-ceph get pod

# 4. åˆ›å»ºCephé›†ç¾¤
kubectl apply -f cluster.yaml

# 5. ç­‰å¾…é›†ç¾¤å°±ç»ª
kubectl -n rook-ceph get cephcluster

# 6. åˆ›å»ºStorageClass
kubectl apply -f csi/rbd/storageclass.yaml

# 7. éªŒè¯StorageClass
kubectl get storageclass
```

**Cephå­˜å‚¨é…ç½®ç¤ºä¾‹**ï¼š

```yaml
apiVersion: ceph.rook.io/v1
kind: CephCluster
metadata:
  name: rook-ceph
  namespace: rook-ceph
spec:
  cephVersion:
    image: quay.io/ceph/ceph:v17.2.6
  dataDirHostPath: /var/lib/rook
  mon:
    count: 3
    allowMultiplePerNode: false
  mgr:
    count: 2
    allowMultiplePerNode: false
  dashboard:
    enabled: true
    ssl: true
  storage:
    useAllNodes: true
    useAllDevices: false
    deviceFilter: "^sd[b-z]"
    config:
      osdsPerDevice: "1"
```

### 12.1.4 å®‰å…¨åŠ å›ºä¸æœ€ä½³å®è·µ

#### RBACæƒé™é…ç½®

```yaml
# åˆ›å»ºåªè¯»ç”¨æˆ·
apiVersion: v1
kind: ServiceAccount
metadata:
  name: readonly-user
  namespace: default
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: readonly-role
rules:
- apiGroups: [""]
  resources: ["pods", "services", "configmaps"]
  verbs: ["get", "list", "watch"]
- apiGroups: ["apps"]
  resources: ["deployments", "statefulsets"]
  verbs: ["get", "list", "watch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: readonly-binding
subjects:
- kind: ServiceAccount
  name: readonly-user
  namespace: default
roleRef:
  kind: ClusterRole
  name: readonly-role
  apiGroup: rbac.authorization.k8s.io
```

#### Pod Security Standards

```yaml
# åœ¨å‘½åç©ºé—´çº§åˆ«å¯ç”¨Pod Security
apiVersion: v1
kind: Namespace
metadata:
  name: production
  labels:
    pod-security.kubernetes.io/enforce: restricted
    pod-security.kubernetes.io/audit: restricted
    pod-security.kubernetes.io/warn: restricted
```

#### å®¡è®¡æ—¥å¿—é…ç½®

```yaml
# API Serverå®¡è®¡ç­–ç•¥
apiVersion: audit.k8s.io/v1
kind: Policy
rules:
- level: Metadata
  resources:
  - group: ""
    resources: ["secrets", "configmaps"]
- level: RequestResponse
  resources:
  - group: ""
    resources: ["pods"]
  verbs: ["create", "delete", "update", "patch"]
- level: Metadata
  omitStages:
  - RequestReceived
```

#### è¯ä¹¦ç®¡ç†

```bash
# æ£€æŸ¥è¯ä¹¦æœ‰æ•ˆæœŸ
kubeadm certs check-expiration

# ç»­æœŸæ‰€æœ‰è¯ä¹¦
kubeadm certs renew all

# é‡å¯æ§åˆ¶å¹³é¢ç»„ä»¶
systemctl restart kubelet
```

#### å®‰å…¨åŠ å›ºæ£€æŸ¥æ¸…å•

```yaml
åŸºç¡€å®‰å…¨:
  - [ ] å…³é—­ä¸å¿…è¦çš„ç«¯å£
  - [ ] é…ç½®é˜²ç«å¢™è§„åˆ™
  - [ ] ç¦ç”¨root SSHç™»å½•
  - [ ] ä½¿ç”¨å¯†é’¥è®¤è¯
  - [ ] å®šæœŸæ›´æ–°ç³»ç»Ÿè¡¥ä¸

Kuberneteså®‰å…¨:
  - [ ] å¯ç”¨RBAC
  - [ ] é…ç½®Pod Security Standards
  - [ ] å¯ç”¨å®¡è®¡æ—¥å¿—
  - [ ] é…ç½®NetworkPolicy
  - [ ] ä½¿ç”¨Secretç®¡ç†æ•æ„Ÿä¿¡æ¯
  - [ ] å®šæœŸè½®æ¢è¯ä¹¦
  - [ ] é™åˆ¶API Serverè®¿é—®
  - [ ] é…ç½®èµ„æºé…é¢

å®¹å™¨å®‰å…¨:
  - [ ] ä½¿ç”¨érootç”¨æˆ·è¿è¡Œå®¹å™¨
  - [ ] è®¾ç½®åªè¯»æ ¹æ–‡ä»¶ç³»ç»Ÿ
  - [ ] ç¦ç”¨ç‰¹æƒå®¹å™¨
  - [ ] æ‰«æé•œåƒæ¼æ´
  - [ ] ä½¿ç”¨ç§æœ‰é•œåƒä»“åº“
  - [ ] é…ç½®é•œåƒæ‹‰å–ç­–ç•¥

ç½‘ç»œå®‰å…¨:
  - [ ] å¯ç”¨TLSåŠ å¯†
  - [ ] é…ç½®Ingress TLS
  - [ ] ä½¿ç”¨NetworkPolicyéš”ç¦»
  - [ ] é™åˆ¶å‡ºç«™æµé‡
  - [ ] é…ç½®DNSç­–ç•¥

æ•°æ®å®‰å…¨:
  - [ ] åŠ å¯†etcdæ•°æ®
  - [ ] åŠ å¯†Secret
  - [ ] é…ç½®å­˜å‚¨åŠ å¯†
  - [ ] å®šæœŸå¤‡ä»½
  - [ ] æµ‹è¯•æ¢å¤æµç¨‹
```

---

**æœ¬èŠ‚å°ç»“**

åœ¨12.1èŠ‚ä¸­ï¼Œæˆ‘ä»¬å®Œæˆäº†ç”Ÿäº§çº§Kubernetesé›†ç¾¤çš„æ­å»ºï¼š

1. **é›†ç¾¤è§„åˆ’**ï¼šæ ¹æ®ä¸šåŠ¡éœ€æ±‚ç¡®å®šé›†ç¾¤è§„æ¨¡ï¼Œè®¾è®¡é«˜å¯ç”¨æ¶æ„ï¼Œé€‰æ‹©åˆé€‚çš„ç½‘ç»œå’Œå­˜å‚¨æ–¹æ¡ˆ
2. **é«˜å¯ç”¨éƒ¨ç½²**ï¼šä½¿ç”¨kubeadméƒ¨ç½²3èŠ‚ç‚¹Masteré›†ç¾¤ï¼Œé…ç½®HAProxy+Keepalivedå®ç°è´Ÿè½½å‡è¡¡å’ŒVIPæ¼‚ç§»
3. **ç½‘ç»œé…ç½®**ï¼šéƒ¨ç½²Calicoç½‘ç»œæ’ä»¶ï¼Œé…ç½®NetworkPolicyå®ç°ç½‘ç»œéš”ç¦»
4. **å­˜å‚¨é…ç½®**ï¼šéƒ¨ç½²Rook-Cephæä¾›åˆ†å¸ƒå¼å­˜å‚¨ï¼Œæ”¯æŒåŠ¨æ€å·ä¾›åº”
5. **å®‰å…¨åŠ å›º**ï¼šé…ç½®RBACã€Pod Security Standardsã€å®¡è®¡æ—¥å¿—ï¼Œå»ºç«‹å®Œæ•´çš„å®‰å…¨ä½“ç³»

é€šè¿‡æœ¬èŠ‚çš„å®è·µï¼Œä½ å·²ç»æŒæ¡äº†ä»é›¶æ­å»ºç”Ÿäº§çº§Kubernetesé›†ç¾¤çš„å®Œæ•´æµç¨‹ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†åœ¨è¿™ä¸ªé›†ç¾¤ä¸Šéƒ¨ç½²å¾®æœåŠ¡åº”ç”¨ï¼

---

