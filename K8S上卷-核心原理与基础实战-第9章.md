# ç¬¬9ç«  ç›‘æ§ä¸å¯è§‚æµ‹æ€§

åœ¨å‰é¢çš„ç« èŠ‚ä¸­ï¼Œæˆ‘ä»¬æ·±å…¥å­¦ä¹ äº†Kubernetesçš„æ ¸å¿ƒç»„ä»¶ã€å·¥ä½œè´Ÿè½½ç®¡ç†ã€æœåŠ¡å‘ç°ã€é…ç½®ç®¡ç†ã€èµ„æºè°ƒåº¦å’Œå­˜å‚¨ç®¡ç†ã€‚è¿™äº›çŸ¥è¯†è®©æˆ‘ä»¬èƒ½å¤ŸæˆåŠŸéƒ¨ç½²å’Œè¿è¡Œå®¹å™¨åŒ–åº”ç”¨ã€‚ä½†åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œä»…ä»…è®©åº”ç”¨è¿è¡Œèµ·æ¥æ˜¯è¿œè¿œä¸å¤Ÿçš„ï¼Œæˆ‘ä»¬è¿˜éœ€è¦å›ç­”ä»¥ä¸‹å…³é”®é—®é¢˜ï¼š

**è¿ç»´ä¸‰å¤§çµé­‚æ‹·é—®**ï¼š
1. **ç³»ç»Ÿç°åœ¨æ€ä¹ˆæ ·ï¼Ÿ** - å®æ—¶ç›‘æ§ï¼ˆMetricsï¼‰
2. **å‡ºé—®é¢˜äº†æ€ä¹ˆåŠï¼Ÿ** - æ—¥å¿—è¿½è¸ªï¼ˆLoggingï¼‰
3. **ä¸ºä»€ä¹ˆä¼šè¿™æ ·ï¼Ÿ** - é“¾è·¯è¿½è¸ªï¼ˆTracingï¼‰

è€ƒè™‘ä»¥ä¸‹ç”Ÿäº§åœºæ™¯ï¼š

ğŸ“Š **ç›‘æ§åœºæ™¯**ï¼š
- Podå†…å­˜ä½¿ç”¨ç‡çªç„¶ä»30%é£™å‡åˆ°95%ï¼Œä½†æ²¡æœ‰å‘Šè­¦
- èŠ‚ç‚¹CPUæŒç»­é«˜è´Ÿè½½ï¼Œä½†ä¸çŸ¥é“æ˜¯å“ªä¸ªPodå¯¼è‡´çš„
- PVCå­˜å‚¨å®¹é‡å³å°†è€—å°½ï¼Œæ²¡æœ‰æå‰é¢„è­¦
- API Serverè¯·æ±‚å»¶è¿Ÿå¢åŠ 3å€ï¼Œç”¨æˆ·å¼€å§‹æŠ•è¯‰

ğŸ” **æ—¥å¿—åœºæ™¯**ï¼š
- ç”¨æˆ·æŠ¥å‘Šæ”¯ä»˜å¤±è´¥ï¼Œä½†ä¸çŸ¥é“é”™è¯¯å‘ç”Ÿåœ¨å“ªä¸ªå¾®æœåŠ¡
- åº”ç”¨å´©æºƒé‡å¯ï¼Œä½†æ—¥å¿—éšå®¹å™¨æ¶ˆå¤±æ— æ³•æ’æŸ¥
- å¤šä¸ªPodåˆ†å¸ƒåœ¨ä¸åŒèŠ‚ç‚¹ï¼Œæ—¥å¿—åˆ†æ•£æ— æ³•ç»Ÿä¸€æŸ¥è¯¢
- æ—¥å¿—é‡å·¨å¤§ï¼ˆTBçº§ï¼‰ï¼Œæœç´¢é€Ÿåº¦æ…¢ä¸”æˆæœ¬é«˜

ğŸ”— **è¿½è¸ªåœºæ™¯**ï¼š
- ä¸€ä¸ªAPIè¯·æ±‚ç»è¿‡10ä¸ªå¾®æœåŠ¡ï¼Œæ€»è€—æ—¶5ç§’ï¼Œç“¶é¢ˆåœ¨å“ªï¼Ÿ
- è®¢å•å¤„ç†å¤±è´¥ï¼Œä½†ä¸çŸ¥é“æ˜¯åº“å­˜æœåŠ¡è¿˜æ˜¯æ”¯ä»˜æœåŠ¡çš„é—®é¢˜
- åˆ†å¸ƒå¼äº‹åŠ¡è·¨è¶Šå¤šä¸ªæœåŠ¡ï¼Œæ— æ³•å®šä½å¤±è´¥åŸå› 

è¿™å°±æ˜¯**å¯è§‚æµ‹æ€§ (Observability)** è¦è§£å†³çš„æ ¸å¿ƒé—®é¢˜ã€‚å¯è§‚æµ‹æ€§æ˜¯ç°ä»£äº‘åŸç”Ÿåº”ç”¨çš„åŸºçŸ³ï¼Œå®ƒè®©æˆ‘ä»¬èƒ½å¤Ÿï¼š
- **ä¸»åŠ¨å‘ç°é—®é¢˜** - åœ¨ç”¨æˆ·æŠ•è¯‰å‰å°±å‘ç°å¼‚å¸¸
- **å¿«é€Ÿå®šä½æ ¹å› ** - åˆ†é’Ÿçº§è€Œéå°æ—¶çº§æ•…éšœæ’æŸ¥
- **ä¼˜åŒ–ç³»ç»Ÿæ€§èƒ½** - åŸºäºæ•°æ®é©±åŠ¨çš„æ€§èƒ½è°ƒä¼˜
- **å®¹é‡è§„åˆ’å†³ç­–** - å‡†ç¡®é¢„æµ‹èµ„æºéœ€æ±‚ï¼Œé™ä½æˆæœ¬

## å¯è§‚æµ‹æ€§ä¸‰å¤§æ”¯æŸ±

Kubernetesç”Ÿæ€æä¾›äº†å®Œæ•´çš„å¯è§‚æµ‹æ€§è§£å†³æ–¹æ¡ˆï¼Œéµå¾ªä¸šç•Œå…¬è®¤çš„"ä¸‰å¤§æ”¯æŸ±"ç†å¿µï¼š

### 1ï¸âƒ£ Metrics (æŒ‡æ ‡ç›‘æ§)

**å®šä¹‰**ï¼šèšåˆçš„æ•°å€¼å‹æ—¶åºæ•°æ®ï¼Œç”¨äºé‡åŒ–ç³»ç»ŸçŠ¶æ€

**å…¸å‹æŒ‡æ ‡**ï¼š
- **åŸºç¡€è®¾æ–½å±‚**ï¼šCPUä½¿ç”¨ç‡ã€å†…å­˜å ç”¨ã€ç£ç›˜IOPSã€ç½‘ç»œå¸¦å®½
- **å®¹å™¨å±‚**ï¼šPodé‡å¯æ¬¡æ•°ã€å®¹å™¨OOMæ¬¡æ•°ã€é•œåƒæ‹‰å–æ—¶é•¿
- **åº”ç”¨å±‚**ï¼šHTTPè¯·æ±‚QPSã€APIå»¶è¿ŸP99ã€é”™è¯¯ç‡ã€ä¸šåŠ¡æŒ‡æ ‡ï¼ˆè®¢å•é‡ï¼‰

**æŠ€æœ¯æ ˆ**ï¼šPrometheus + Grafana

### 2ï¸âƒ£ Logging (æ—¥å¿—è¿½è¸ª)

**å®šä¹‰**ï¼šç¦»æ•£çš„äº‹ä»¶è®°å½•ï¼Œç”¨äºæè¿°ç³»ç»Ÿè¡Œä¸º

**æ—¥å¿—ç±»å‹**ï¼š
- **åº”ç”¨æ—¥å¿—**ï¼šä¸šåŠ¡é€»è¾‘è¾“å‡ºï¼ˆè®¢å•åˆ›å»ºã€ç”¨æˆ·ç™»å½•ï¼‰
- **å®¡è®¡æ—¥å¿—**ï¼šå®‰å…¨åˆè§„è®°å½•ï¼ˆAPIè°ƒç”¨ã€æƒé™å˜æ›´ï¼‰
- **ç³»ç»Ÿæ—¥å¿—**ï¼šç»„ä»¶è¿è¡Œæ—¥å¿—ï¼ˆkubeletã€kube-proxyï¼‰

**æŠ€æœ¯æ ˆ**ï¼šEFK (Elasticsearch + Fluentd + Kibana) æˆ– Loki + Promtail

### 3ï¸âƒ£ Tracing (é“¾è·¯è¿½è¸ª)

**å®šä¹‰**ï¼šåˆ†å¸ƒå¼è¯·æ±‚çš„å®Œæ•´è°ƒç”¨é“¾è·¯ï¼Œç”¨äºåˆ†ææœåŠ¡ä¾èµ–

**è¿½è¸ªå†…å®¹**ï¼š
- è¯·æ±‚ä»ç½‘å…³åˆ°æ•°æ®åº“çš„å®Œæ•´è·¯å¾„
- æ¯ä¸ªå¾®æœåŠ¡çš„å¤„ç†è€—æ—¶å’Œä¾èµ–å…³ç³»
- è·¨æœåŠ¡è°ƒç”¨çš„ä¸Šä¸‹æ–‡ä¼ é€’

**æŠ€æœ¯æ ˆ**ï¼šJaeger / Zipkin / Tempo

## æœ¬ç« å­¦ä¹ ç›®æ ‡

é€šè¿‡æœ¬ç« å­¦ä¹ ï¼Œä½ å°†æŒæ¡ï¼š

âœ… **Metricsç›‘æ§ä½“ç³»**: ç†è§£Prometheusæ¶æ„ï¼ŒæŒæ¡PromQLæŸ¥è¯¢è¯­è¨€ï¼Œé…ç½®Grafanaä»ªè¡¨ç›˜
âœ… **æŒ‡æ ‡é‡‡é›†å®æˆ˜**: éƒ¨ç½²Metrics Serverã€Node Exporterã€kube-state-metrics
âœ… **å‘Šè­¦è§„åˆ™é…ç½®**: ä½¿ç”¨AlertManagerå®ç°å¤šæ¸ é“å‘Šè­¦ï¼ˆé‚®ä»¶/Slack/é’‰é’‰/ä¼ä¸šå¾®ä¿¡ï¼‰
âœ… **æ—¥å¿—æ”¶é›†æ¶æ„**: éƒ¨ç½²EFKæ ˆï¼Œå®ç°å®¹å™¨æ—¥å¿—çš„é›†ä¸­æ”¶é›†ã€ç´¢å¼•å’ŒæŸ¥è¯¢
âœ… **æ—¥å¿—æŸ¥è¯¢åˆ†æ**: æŒæ¡Kibana/LokiæŸ¥è¯¢è¯­æ³•ï¼Œå¿«é€Ÿå®šä½é—®é¢˜æ—¥å¿—
âœ… **åˆ†å¸ƒå¼è¿½è¸ª**: éƒ¨ç½²Jaegerï¼Œå®ç°å¾®æœåŠ¡è°ƒç”¨é“¾è·¯çš„å¯è§†åŒ–åˆ†æ
âœ… **æ€§èƒ½åˆ†æå·¥å…·**: ä½¿ç”¨kubectl topã€PrometheusæŸ¥è¯¢ã€ç«ç„°å›¾åˆ†ææ€§èƒ½ç“¶é¢ˆ
âœ… **ç”Ÿäº§æœ€ä½³å®è·µ**: ç›‘æ§æŒ‡æ ‡ä½“ç³»è®¾è®¡ã€å‘Šè­¦ç­–ç•¥åˆ¶å®šã€æˆæœ¬ä¼˜åŒ–

## æœ¬ç« å†…å®¹æ¦‚è§ˆ

```
ç¬¬9ç« : ç›‘æ§ä¸å¯è§‚æµ‹æ€§
â”œâ”€â”€ 9.1 ç›‘æ§åŸºç¡€ä¸æ¶æ„è®¾è®¡
â”‚   â”œâ”€â”€ å¯è§‚æµ‹æ€§æ ¸å¿ƒæ¦‚å¿µ
â”‚   â”œâ”€â”€ Kubernetesç›‘æ§æ¶æ„
â”‚   â”œâ”€â”€ Metrics APIä¸èµ„æºæŒ‡æ ‡
â”‚   â””â”€â”€ ç›‘æ§æ•°æ®é‡‡é›†è·¯å¾„
â”‚
â”œâ”€â”€ 9.2 Prometheusæ ¸å¿ƒåŸç†ä¸å®æˆ˜
â”‚   â”œâ”€â”€ Prometheusæ¶æ„ä¸æ•°æ®æ¨¡å‹
â”‚   â”œâ”€â”€ æœåŠ¡å‘ç°ä¸ç›®æ ‡æŠ“å–
â”‚   â”œâ”€â”€ PromQLæŸ¥è¯¢è¯­è¨€è¯¦è§£
â”‚   â”œâ”€â”€ Recording Rulesæ€§èƒ½ä¼˜åŒ–
â”‚   â””â”€â”€ æ•°æ®æŒä¹…åŒ–ä¸é«˜å¯ç”¨
â”‚
â”œâ”€â”€ 9.3 Grafanaå¯è§†åŒ–ä¸ä»ªè¡¨ç›˜
â”‚   â”œâ”€â”€ Grafanaéƒ¨ç½²ä¸é…ç½®
â”‚   â”œâ”€â”€ æ•°æ®æºé›†æˆï¼ˆPrometheus/Loki/Jaegerï¼‰
â”‚   â”œâ”€â”€ ä»ªè¡¨ç›˜è®¾è®¡æœ€ä½³å®è·µ
â”‚   â”œâ”€â”€ å˜é‡ä¸æ¨¡æ¿åº”ç”¨
â”‚   â””â”€â”€ ä¼ä¸šçº§ä»ªè¡¨ç›˜ç¤ºä¾‹
â”‚
â”œâ”€â”€ 9.4 å‘Šè­¦è§„åˆ™ä¸AlertManager
â”‚   â”œâ”€â”€ AlertManageræ¶æ„ä¸é…ç½®
â”‚   â”œâ”€â”€ å‘Šè­¦è§„åˆ™ç¼–å†™ï¼ˆCPU/å†…å­˜/ç£ç›˜/Podï¼‰
â”‚   â”œâ”€â”€ å‘Šè­¦è·¯ç”±ä¸åˆ†ç»„
â”‚   â”œâ”€â”€ æŠ‘åˆ¶ä¸é™é»˜ç­–ç•¥
â”‚   â””â”€â”€ å¤šæ¸ é“é€šçŸ¥é›†æˆï¼ˆé’‰é’‰/ä¼ä¸šå¾®ä¿¡/PagerDutyï¼‰
â”‚
â”œâ”€â”€ 9.5 æ—¥å¿—ç®¡ç†ä¸EFKæ ˆ
â”‚   â”œâ”€â”€ æ—¥å¿—æ”¶é›†æ¶æ„è®¾è®¡
â”‚   â”œâ”€â”€ Fluentd/Fluent Bitéƒ¨ç½²
â”‚   â”œâ”€â”€ Elasticsearché›†ç¾¤æ­å»º
â”‚   â”œâ”€â”€ Kibanaæ—¥å¿—æŸ¥è¯¢ä¸åˆ†æ
â”‚   â””â”€â”€ Lokiè½»é‡çº§æ—¥å¿—æ–¹æ¡ˆ
â”‚
â”œâ”€â”€ 9.6 åˆ†å¸ƒå¼è¿½è¸ªä¸Jaeger
â”‚   â”œâ”€â”€ OpenTelemetryæ ‡å‡†
â”‚   â”œâ”€â”€ Jaegeræ¶æ„ä¸éƒ¨ç½²
â”‚   â”œâ”€â”€ åº”ç”¨åŸ‹ç‚¹ä¸SDKé›†æˆ
â”‚   â”œâ”€â”€ è°ƒç”¨é“¾è·¯åˆ†æå®æˆ˜
â”‚   â””â”€â”€ æ€§èƒ½ç“¶é¢ˆå®šä½
â”‚
â”œâ”€â”€ 9.7 Kubernetesäº‹ä»¶ç›‘æ§
â”‚   â”œâ”€â”€ Eventsèµ„æºè¯¦è§£
â”‚   â”œâ”€â”€ kube-eventeréƒ¨ç½²
â”‚   â”œâ”€â”€ äº‹ä»¶æŒä¹…åŒ–å­˜å‚¨
â”‚   â””â”€â”€ å…³é”®äº‹ä»¶å‘Šè­¦
â”‚
â””â”€â”€ 9.8 ç›‘æ§æœ€ä½³å®è·µä¸ç”Ÿäº§æ¡ˆä¾‹
    â”œâ”€â”€ ç›‘æ§æŒ‡æ ‡ä½“ç³»è®¾è®¡ï¼ˆUSE/REDæ–¹æ³•ï¼‰
    â”œâ”€â”€ é»„é‡‘æŒ‡æ ‡ä¸SLI/SLO/SLA
    â”œâ”€â”€ æˆæœ¬ä¼˜åŒ–ï¼ˆæ•°æ®ä¿ç•™ç­–ç•¥/é‡‡æ ·ç‡ï¼‰
    â”œâ”€â”€ ç”Ÿäº§æ•…éšœæ¡ˆä¾‹ï¼ˆOOM/ç£ç›˜æ»¡/é›ªå´©ï¼‰
    â””â”€â”€ ä¼ä¸šçº§ç›‘æ§å¹³å°æ¶æ„
```

## å­¦ä¹ è·¯å¾„å»ºè®®

**åˆå­¦è€…è·¯å¾„**ï¼ˆæŒæ¡åŸºç¡€ç›‘æ§ï¼‰ï¼š
1. å…ˆå­¦ä¹  9.1 ç›‘æ§åŸºç¡€ï¼Œç†è§£æ ¸å¿ƒæ¦‚å¿µ
2. éƒ¨ç½² Metrics Serverï¼Œä½¿ç”¨ `kubectl top` æŸ¥çœ‹èµ„æº
3. å­¦ä¹  9.2 Prometheus åŸºç¡€ï¼Œéƒ¨ç½²å•æœºç‰ˆ
4. é…ç½® 9.3 Grafana ä»ªè¡¨ç›˜ï¼Œå¯è§†åŒ–é›†ç¾¤çŠ¶æ€
5. å®è·µ 9.4 ç®€å•å‘Šè­¦è§„åˆ™ï¼ˆCPU/å†…å­˜é˜ˆå€¼ï¼‰

**è¿›é˜¶è·¯å¾„**ï¼ˆæ„å»ºå®Œæ•´å¯è§‚æµ‹æ€§ï¼‰ï¼š
1. æ·±å…¥å­¦ä¹  9.2 PromQLï¼Œç¼–å†™å¤æ‚æŸ¥è¯¢
2. éƒ¨ç½² 9.5 EFK æ ˆï¼Œå®ç°æ—¥å¿—é›†ä¸­ç®¡ç†
3. é…ç½® 9.4 é«˜çº§å‘Šè­¦ï¼ˆåŸºäºå˜åŒ–ç‡/è¶‹åŠ¿é¢„æµ‹ï¼‰
4. å­¦ä¹  9.6 Jaegerï¼Œåˆ†æå¾®æœåŠ¡è°ƒç”¨é“¾
5. æŒæ¡ 9.8 æœ€ä½³å®è·µï¼Œè®¾è®¡ä¼ä¸šçº§ç›‘æ§ä½“ç³»

**ç”Ÿäº§ç¯å¢ƒå‡†å¤‡**ï¼š
- Prometheusé›†ç¾¤é«˜å¯ç”¨ï¼ˆå¤šå‰¯æœ¬+Thanosï¼‰
- æ—¥å¿—å­˜å‚¨æˆæœ¬ä¼˜åŒ–ï¼ˆå†·çƒ­åˆ†ç¦»+ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼‰
- å‘Šè­¦é™å™ªç­–ç•¥ï¼ˆæŠ‘åˆ¶è§„åˆ™+åˆ†çº§é€šçŸ¥ï¼‰
- ç›‘æ§æ•°æ®å®‰å…¨ï¼ˆRBAC+åŠ å¯†ä¼ è¾“ï¼‰

---

## æŠ€æœ¯æ ˆæ€»è§ˆ

æœ¬ç« æ¶‰åŠçš„æ ¸å¿ƒæŠ€æœ¯æ ˆï¼š

| ç±»åˆ« | å¼€æºæ–¹æ¡ˆ | å•†ä¸šæ–¹æ¡ˆ | äº‘åŸç”Ÿæ–¹æ¡ˆ |
|------|---------|---------|-----------|
| **Metrics** | Prometheus + Grafana | Datadog, New Relic | AWS CloudWatch, GCP Monitoring |
| **Logging** | EFK (Elasticsearch + Fluentd + Kibana) | Splunk, Sumo Logic | AWS CloudWatch Logs, GCP Logging |
| **Tracing** | Jaeger, Zipkin | Datadog APM, Dynatrace | AWS X-Ray, GCP Trace |
| **é›†æˆæ–¹æ¡ˆ** | Loki + Tempo + Grafana (LGTMæ ˆ) | Elastic Observability | - |

**æœ¬ç« é€‰æ‹©å¼€æºæ–¹æ¡ˆçš„åŸå› **ï¼š
- âœ… é›¶æˆæœ¬ï¼Œé€‚åˆå­¦ä¹ å’Œä¸­å°ä¼ä¸š
- âœ… ç¤¾åŒºæ´»è·ƒï¼Œæ–‡æ¡£ä¸°å¯Œ
- âœ… äº‘å‚å•†å…¼å®¹ï¼ˆå¯æ— ç¼è¿ç§»åˆ°æ‰˜ç®¡æœåŠ¡ï¼‰
- âœ… ä¼ä¸šçº§ç”Ÿäº§éªŒè¯ï¼ˆNetflixã€Uberã€Shopifyç­‰ä½¿ç”¨ï¼‰

---

**å‡†å¤‡å¥½äº†å—ï¼Ÿ** è®©æˆ‘ä»¬ä»ç›‘æ§åŸºç¡€å¼€å§‹ï¼Œé€æ­¥æ„å»ºå®Œæ•´çš„Kuberneteså¯è§‚æµ‹æ€§å¹³å°ï¼

---


## 9.1 ç›‘æ§åŸºç¡€ä¸æ¶æ„è®¾è®¡

### 9.1.1 å¯è§‚æµ‹æ€§æ ¸å¿ƒæ¦‚å¿µ

#### ä»€ä¹ˆæ˜¯å¯è§‚æµ‹æ€§ï¼Ÿ

**å¯è§‚æµ‹æ€§ (Observability)** ä¸ç­‰äºç›‘æ§ (Monitoring)ï¼Œå®ƒæ˜¯ä¸€ä¸ªæ›´å¹¿æ³›çš„æ¦‚å¿µï¼š

```
ç›‘æ§ (Monitoring)ï¼š
  - å·²çŸ¥é—®é¢˜çš„æ£€æµ‹ï¼ˆæˆ‘çŸ¥é“å¯èƒ½ä¼šå‡ºç°CPUè¿‡é«˜ï¼Œæ‰€ä»¥è®¾ç½®å‘Šè­¦ï¼‰
  - é¢„å®šä¹‰æŒ‡æ ‡çš„æ”¶é›†ï¼ˆå›ºå®šçš„Dashboardï¼‰
  - è¢«åŠ¨å“åº”ï¼ˆæ”¶åˆ°å‘Šè­¦åæ’æŸ¥ï¼‰

å¯è§‚æµ‹æ€§ (Observability)ï¼š
  - æœªçŸ¥é—®é¢˜çš„æ¢ç´¢ï¼ˆç³»ç»Ÿå‡ºç°ä»æœªè§è¿‡çš„å¼‚å¸¸ï¼Œèƒ½å¿«é€Ÿå®šä½ï¼‰
  - ä»»æ„ç»´åº¦çš„æŸ¥è¯¢ï¼ˆå¯ä»¥è‡ªç”±ç»„åˆå„ç§æ¡ä»¶æŸ¥è¯¢ï¼‰
  - ä¸»åŠ¨æ´å¯Ÿï¼ˆé€šè¿‡æ•°æ®å‘ç°æ½œåœ¨é—®é¢˜ï¼‰
```

**æ ¸å¿ƒåŒºåˆ«ç¤ºä¾‹**ï¼š

å‡è®¾ç”Ÿäº§ç¯å¢ƒå‡ºç°"ç”¨æˆ·æ”¯ä»˜æˆåŠŸç‡ä»99.5%é™åˆ°95%"ï¼š

```
ä¼ ç»Ÿç›‘æ§æ€è·¯ï¼š
1. æŸ¥çœ‹é¢„è®¾çš„Dashboard â†’ æ²¡æœ‰"æ”¯ä»˜æˆåŠŸç‡"è¿™ä¸ªæŒ‡æ ‡
2. ç™»å½•å„ä¸ªPodæŸ¥çœ‹æ—¥å¿— â†’ è€—æ—¶ä¸”åˆ†æ•£
3. çŒœæµ‹å¯èƒ½çš„åŸå›  â†’ æ•°æ®åº“ï¼Ÿç½‘ç»œï¼Ÿä»£ç bugï¼Ÿ
4. é€ä¸ªæ’æŸ¥ â†’ å¯èƒ½éœ€è¦æ•°å°æ—¶

å¯è§‚æµ‹æ€§æ€è·¯ï¼š
1. Metrics: æŸ¥è¯¢æ”¯ä»˜APIçš„P99å»¶è¿Ÿ â†’ å‘ç°ä»200mså‡åˆ°2s
2. Tracing: è°ƒç”¨é“¾åˆ†æ â†’ å®šä½åˆ°"åº“å­˜æŸ¥è¯¢"æ­¥éª¤è€—æ—¶å¢åŠ 
3. Logging: æŸ¥çœ‹åº“å­˜æœåŠ¡æ—¥å¿— â†’ å‘ç°å¤§é‡"connection timeout"
4. æ ¹å› å®šä½ï¼šåº“å­˜æœåŠ¡æ•°æ®åº“è¿æ¥æ± è€—å°½ â†’ 5åˆ†é’Ÿå†…ä¿®å¤
```

#### å¯è§‚æµ‹æ€§çš„ä»·å€¼

**ä¸šåŠ¡ä»·å€¼**ï¼š

| ç»´åº¦ | ä¼ ç»Ÿæ–¹å¼ | å¯è§‚æµ‹æ€§æ–¹å¼ | ä»·å€¼æå‡ |
|------|---------|-------------|---------|
| **æ•…éšœå‘ç°** | ç”¨æˆ·æŠ•è¯‰åè¢«åŠ¨å‘ç° | æå‰5-30åˆ†é’Ÿä¸»åŠ¨å‘Šè­¦ | å‡å°‘ç”¨æˆ·å½±å“é¢80% |
| **æ•…éšœå®šä½** | å¹³å‡2-4å°æ—¶ (MTTR) | å¹³å‡5-15åˆ†é’Ÿ | MTTRé™ä½90% |
| **å®¹é‡è§„åˆ’** | åŸºäºç»éªŒçŒœæµ‹ | åŸºäºå†å²è¶‹åŠ¿é¢„æµ‹ | æˆæœ¬é™ä½30-50% |
| **æ€§èƒ½ä¼˜åŒ–** | æ„Ÿè§‰å“ªé‡Œæ…¢å°±ä¼˜åŒ–å“ªé‡Œ | æ•°æ®é©±åŠ¨ï¼Œç²¾å‡†å®šä½ç“¶é¢ˆ | ä¼˜åŒ–æ•ˆæœæå‡5-10å€ |

**çœŸå®æ¡ˆä¾‹**ï¼š

æŸç”µå•†å…¬å¸åœ¨å¼•å…¥å®Œæ•´å¯è§‚æµ‹æ€§ä½“ç³»åï¼š
- âœ… 99.9% SLAè¾¾æˆç‡ä»92%æå‡åˆ°99.7%
- âœ… å¹³å‡æ•…éšœæ¢å¤æ—¶é—´ä»3.5å°æ—¶é™è‡³12åˆ†é’Ÿ
- âœ… é€šè¿‡å®¹é‡ä¼˜åŒ–èŠ‚çœäº‘æˆæœ¬38%ï¼ˆå¹´çœ200ä¸‡ç¾å…ƒï¼‰
- âœ… æ€§èƒ½é—®é¢˜å®šä½æ—¶é—´ä»å¹³å‡2å¤©é™è‡³1å°æ—¶

#### å¯è§‚æµ‹æ€§ä¸‰å¤§æ”¯æŸ±è¯¦è§£

##### 1. Metrics (æŒ‡æ ‡ç›‘æ§)

**æ•°æ®ç‰¹ç‚¹**ï¼š
- èšåˆçš„æ•°å€¼å‹æ•°æ®ï¼ˆå¦‚ï¼šå¹³å‡å€¼ã€P99ã€ç´¯åŠ å€¼ï¼‰
- æ—¶åºå­˜å‚¨ï¼ˆæ—¶é—´æˆ³ + æ ‡ç­¾ + æ•°å€¼ï¼‰
- ä½å­˜å‚¨æˆæœ¬ï¼ˆæ¯ä¸ªæŒ‡æ ‡çº¦1-2 bytes/sampleï¼‰

**å…¸å‹åº”ç”¨åœºæ™¯**ï¼š
```yaml
# åœºæ™¯1: èµ„æºç›‘æ§
node_cpu_usage{node="node1", cpu="0"} 45.2    # CPUä½¿ç”¨ç‡45.2%
container_memory_usage{pod="nginx-abc", namespace="prod"} 256000000  # å†…å­˜256MB

# åœºæ™¯2: åº”ç”¨æ€§èƒ½
http_requests_total{method="GET", path="/api/users", status="200"} 15840  # è¯·æ±‚æ€»æ•°
http_request_duration_seconds{quantile="0.99"} 0.235  # P99å»¶è¿Ÿ235ms

# åœºæ™¯3: ä¸šåŠ¡æŒ‡æ ‡
order_created_total{region="us-west", payment_method="credit_card"} 3580  # è®¢å•æ•°
payment_success_rate 0.995  # æ”¯ä»˜æˆåŠŸç‡99.5%
```

**ä¼˜åŠ¿**ï¼š
- âœ… æŸ¥è¯¢é€Ÿåº¦å¿«ï¼ˆæ¯«ç§’çº§ï¼‰
- âœ… å­˜å‚¨æˆæœ¬ä½ï¼ˆTBçº§æ•°æ®/æœˆä»…éœ€å‡ GBï¼‰
- âœ… é€‚åˆå®æ—¶å‘Šè­¦ï¼ˆç§’çº§æ£€æµ‹é˜ˆå€¼ï¼‰
- âœ… æ˜“äºå¯è§†åŒ–ï¼ˆæŠ˜çº¿å›¾ã€é¥¼å›¾ã€çƒ­åŠ›å›¾ï¼‰

**å±€é™**ï¼š
- âŒ æ— æ³•æŸ¥çœ‹è¯¦ç»†äº‹ä»¶ï¼ˆåªçŸ¥é“é”™è¯¯ç‡å‡é«˜ï¼Œä¸çŸ¥é“å…·ä½“é”™è¯¯ä¿¡æ¯ï¼‰
- âŒ ä¸¢å¤±ä¸Šä¸‹æ–‡ï¼ˆä¸çŸ¥é“æ˜¯å“ªä¸ªç”¨æˆ·ã€å“ªä¸ªè®¢å•å‡ºé”™ï¼‰

##### 2. Logging (æ—¥å¿—è¿½è¸ª)

**æ•°æ®ç‰¹ç‚¹**ï¼š
- ç¦»æ•£çš„äº‹ä»¶è®°å½•ï¼ˆæ¯æ¡æ—¥å¿—æ˜¯ä¸€ä¸ªå®Œæ•´äº‹ä»¶ï¼‰
- åŒ…å«ä¸°å¯Œä¸Šä¸‹æ–‡ï¼ˆæ—¶é—´ã€çº§åˆ«ã€æ¶ˆæ¯ã€å †æ ˆç­‰ï¼‰
- å­˜å‚¨æˆæœ¬é«˜ï¼ˆæ¯GBæ—¥å¿—çº¦å ç”¨1-3GBå­˜å‚¨ï¼‰

**æ—¥å¿—çº§åˆ«**ï¼š
```python
# åº”ç”¨æ—¥å¿—ç¤ºä¾‹
DEBUG: [2024-01-20 10:30:15] User session cache hit: user_id=12345
INFO:  [2024-01-20 10:30:16] Order created: order_id=ORD-789, amount=99.99, user=12345
WARN:  [2024-01-20 10:30:17] Payment retry attempt 2/3: gateway_timeout
ERROR: [2024-01-20 10:30:18] Payment failed: order=ORD-789, error=ConnectionTimeout
FATAL: [2024-01-20 10:30:19] Database connection pool exhausted
```

**ç»“æ„åŒ–æ—¥å¿— vs éç»“æ„åŒ–æ—¥å¿—**ï¼š

```json
// éç»“æ„åŒ–æ—¥å¿— (éš¾ä»¥æŸ¥è¯¢)
"2024-01-20 10:30:16 User john@example.com created order ORD-789 with amount $99.99"

// ç»“æ„åŒ–æ—¥å¿— (æ˜“äºæŸ¥è¯¢å’Œåˆ†æ)
{
  "timestamp": "2024-01-20T10:30:16Z",
  "level": "INFO",
  "message": "Order created",
  "order_id": "ORD-789",
  "user_email": "john@example.com",
  "amount": 99.99,
  "currency": "USD",
  "trace_id": "a1b2c3d4e5f6"  // å…³è”Tracing
}
```

**ä¼˜åŠ¿**ï¼š
- âœ… åŒ…å«å®Œæ•´ä¸Šä¸‹æ–‡ï¼ˆèƒ½çœ‹åˆ°è¯¦ç»†é”™è¯¯ä¿¡æ¯ã€å †æ ˆè¿½è¸ªï¼‰
- âœ… æ”¯æŒå…¨æ–‡æœç´¢ï¼ˆå¿«é€Ÿæ‰¾åˆ°ç‰¹å®šé”™è¯¯æ¶ˆæ¯ï¼‰
- âœ… é€‚åˆé—®é¢˜æ’æŸ¥ï¼ˆç»“åˆæ—¶é—´æˆ³ç²¾å‡†å®šä½ï¼‰

**å±€é™**ï¼š
- âŒ å­˜å‚¨æˆæœ¬é«˜ï¼ˆæ—¥å¿—é‡å¤§çš„ç³»ç»Ÿæ¯æœˆæ•°TBï¼‰
- âŒ æŸ¥è¯¢é€Ÿåº¦æ…¢ï¼ˆå…¨æ–‡æœç´¢TBçº§æ•°æ®å¯èƒ½éœ€è¦æ•°ç§’åˆ°æ•°åˆ†é’Ÿï¼‰
- âŒ éš¾ä»¥èšåˆåˆ†æï¼ˆä¸é€‚åˆç»Ÿè®¡è¶‹åŠ¿ï¼‰

##### 3. Tracing (é“¾è·¯è¿½è¸ª)

**æ•°æ®ç‰¹ç‚¹**ï¼š
- åˆ†å¸ƒå¼è¯·æ±‚çš„å®Œæ•´è°ƒç”¨é“¾ï¼ˆä¸€æ¬¡ç”¨æˆ·è¯·æ±‚å¯èƒ½è·¨è¶Š10+æœåŠ¡ï¼‰
- åŒ…å«æ—¶åºå…³ç³»å’Œä¾èµ–ï¼ˆå“ªä¸ªæ­¥éª¤å…ˆæ‰§è¡Œï¼Œå“ªä¸ªæœåŠ¡è°ƒç”¨äº†å“ªä¸ªæœåŠ¡ï¼‰
- é‡‡æ ·å­˜å‚¨ï¼ˆé€šå¸¸åªä¿å­˜1-10%çš„è¯·æ±‚ï¼Œå¦åˆ™æ•°æ®é‡è¿‡å¤§ï¼‰

**æ ¸å¿ƒæ¦‚å¿µ**ï¼š

```
Trace (è¿½è¸ª): ä¸€æ¬¡å®Œæ•´çš„è¯·æ±‚é“¾è·¯
  â””â”€â”€ Span (è·¨åº¦): é“¾è·¯ä¸­çš„ä¸€ä¸ªæ“ä½œæ­¥éª¤
      â”œâ”€â”€ Span ID: å½“å‰æ­¥éª¤çš„å”¯ä¸€æ ‡è¯†
      â”œâ”€â”€ Parent Span ID: çˆ¶çº§æ­¥éª¤çš„ID
      â”œâ”€â”€ Start Time: å¼€å§‹æ—¶é—´
      â”œâ”€â”€ Duration: æŒç»­æ—¶é•¿
      â””â”€â”€ Tags/Logs: é™„åŠ ä¿¡æ¯ï¼ˆHTTPçŠ¶æ€ç ã€é”™è¯¯ä¿¡æ¯ç­‰ï¼‰
```

**å®é™…æ¡ˆä¾‹**ï¼š

ä¸€æ¬¡"ç”¨æˆ·ä¸‹å•"è¯·æ±‚çš„å®Œæ•´Traceï¼š

```
[Trace ID: a1b2c3d4e5f6]
â”‚
â”œâ”€â”€ [Span 1] API Gateway (æ€»è€—æ—¶: 1250ms)
â”‚   â”‚
â”‚   â”œâ”€â”€ [Span 2] ç”¨æˆ·è®¤è¯æœåŠ¡ (100ms)
â”‚   â”‚   â””â”€â”€ [Span 3] RedisæŸ¥è¯¢ç¼“å­˜ (5ms)
â”‚   â”‚
â”‚   â”œâ”€â”€ [Span 4] è®¢å•æœåŠ¡ (1100ms)
â”‚   â”‚   â”œâ”€â”€ [Span 5] åº“å­˜æœåŠ¡ (800ms) â† ç“¶é¢ˆï¼
â”‚   â”‚   â”‚   â””â”€â”€ [Span 6] MySQLæŸ¥è¯¢åº“å­˜ (780ms) â† æ ¹å› ï¼šæ…¢æŸ¥è¯¢
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ [Span 7] ä¼˜æƒ åˆ¸æœåŠ¡ (50ms)
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ [Span 8] æ”¯ä»˜æœåŠ¡ (200ms)
â”‚   â”‚       â””â”€â”€ [Span 9] ç¬¬ä¸‰æ–¹æ”¯ä»˜ç½‘å…³ (180ms)
â”‚   â”‚
â”‚   â””â”€â”€ [Span 10] æ—¥å¿—è®°å½• (50ms)
```

é€šè¿‡Tracingå¯ä»¥ä¸€çœ¼çœ‹å‡ºï¼š
- âœ… æ€»è€—æ—¶1250msï¼Œå…¶ä¸­åº“å­˜æœåŠ¡å 64%ï¼ˆ800msï¼‰
- âœ… åº“å­˜æœåŠ¡çš„ç“¶é¢ˆåœ¨MySQLæŸ¥è¯¢ï¼ˆ780msï¼‰
- âœ… ä¼˜åŒ–æ–¹å‘ï¼šä¼˜åŒ–åº“å­˜æŸ¥è¯¢SQLæˆ–å¢åŠ ç¼“å­˜

**ä¼˜åŠ¿**ï¼š
- âœ… å¯è§†åŒ–æœåŠ¡ä¾èµ–ï¼ˆè‡ªåŠ¨ç”ŸæˆæœåŠ¡æ‹“æ‰‘å›¾ï¼‰
- âœ… ç²¾å‡†å®šä½ç“¶é¢ˆï¼ˆæ¯ä¸ªæ­¥éª¤çš„è€—æ—¶ä¸€ç›®äº†ç„¶ï¼‰
- âœ… ç†è§£å¤æ‚è°ƒç”¨é“¾ï¼ˆå¾®æœåŠ¡æ¶æ„ä¸‹å°¤ä¸ºé‡è¦ï¼‰

**å±€é™**ï¼š
- âŒ éœ€è¦åº”ç”¨åŸ‹ç‚¹ï¼ˆä»£ç ä¾µå…¥ï¼Œå¢åŠ å¼€å‘æˆæœ¬ï¼‰
- âŒ é‡‡æ ·ç‡æƒè¡¡ï¼ˆ100%é‡‡æ ·å­˜å‚¨æˆæœ¬é«˜ï¼Œä½é‡‡æ ·ç‡å¯èƒ½æ¼æ‰å…³é”®è¯·æ±‚ï¼‰
- âŒ å­¦ä¹ æ›²çº¿ï¼ˆéœ€è¦ç†è§£åˆ†å¸ƒå¼è¿½è¸ªæ¦‚å¿µï¼‰

#### ä¸‰å¤§æ”¯æŸ±çš„ååŒä½¿ç”¨

**å…¸å‹æ•…éšœæ’æŸ¥æµç¨‹**ï¼š

```
æ­¥éª¤1: Metricså‘ç°å¼‚å¸¸
  â†’ Grafana Dashboardæ˜¾ç¤º"APIé”™è¯¯ç‡ä»0.1%å‡åˆ°5%"

æ­¥éª¤2: Metricså®šä½æ—¶é—´å’ŒèŒƒå›´
  â†’ PromQLæŸ¥è¯¢: rate(http_requests_total{status=~"5.."}[5m])
  â†’ å‘ç°æ˜¯"è®¢å•æœåŠ¡"åœ¨"10:30-10:45"é”™è¯¯ç‡å¼‚å¸¸

æ­¥éª¤3: Tracingå®šä½å…·ä½“æœåŠ¡
  â†’ JaegeræŸ¥è¯¢"è®¢å•æœåŠ¡"åœ¨è¯¥æ—¶é—´æ®µçš„Trace
  â†’ å‘ç°80%çš„æ…¢è¯·æ±‚éƒ½å¡åœ¨"åº“å­˜æŸ¥è¯¢"æ­¥éª¤

æ­¥éª¤4: LoggingæŸ¥çœ‹è¯¦ç»†é”™è¯¯
  â†’ Kibanaæœç´¢: service="inventory" AND level="ERROR" AND time:[10:30 TO 10:45]
  â†’ æ‰¾åˆ°é”™è¯¯æ—¥å¿—: "com.mysql.jdbc.exceptions.MySQLTimeoutException: Connection timeout"

æ­¥éª¤5: æ ¹å› åˆ†æ
  â†’ ç»“åˆMetrics: MySQLè¿æ¥æ•°ä»50çªå¢åˆ°200ï¼ˆè¿æ¥æ± ä¸Šé™ï¼‰
  â†’ ç»“åˆLogging: å‘ç°æŸä¸ªå®šæ—¶ä»»åŠ¡åœ¨10:30å¯åŠ¨ï¼Œæ‰§è¡Œäº†å¤§é‡æ…¢æŸ¥è¯¢
  â†’ è§£å†³æ–¹æ¡ˆ: ä¼˜åŒ–æ…¢æŸ¥è¯¢SQLï¼Œå¢åŠ è¿æ¥æ± å¤§å°

æ€»è€—æ—¶: 5-10åˆ†é’Ÿï¼ˆå¦‚æœåªç”¨Loggingå¯èƒ½éœ€è¦1-2å°æ—¶ï¼‰
```

**ååŒä»·å€¼æ€»ç»“**ï¼š

| é—®é¢˜ç±»å‹ | ä¸»è¦ä½¿ç”¨å·¥å…· | è¾…åŠ©å·¥å…· |
|---------|------------|---------|
| å‘ç°å¼‚å¸¸ | Metrics (Prometheuså‘Šè­¦) | - |
| å®šä½æœåŠ¡ | Tracing (Jaeger) | Metrics (ç¼©å°æ—¶é—´èŒƒå›´) |
| æŸ¥çœ‹è¯¦æƒ… | Logging (Kibana) | Tracing (è·å–Trace ID) |
| è¶‹åŠ¿åˆ†æ | Metrics (Grafana Dashboard) | - |
| å®¹é‡è§„åˆ’ | Metrics (å†å²æ•°æ®åˆ†æ) | Logging (é”™è¯¯æ—¥å¿—ç»Ÿè®¡) |

---

### 9.1.2 Kubernetesç›‘æ§æ¶æ„

#### Kubernetesç›‘æ§å±‚æ¬¡

Kubernetesçš„ç›‘æ§éœ€è¦è¦†ç›–å¤šä¸ªå±‚æ¬¡ï¼Œæ¯ä¸€å±‚éƒ½æœ‰ä¸åŒçš„å…³æ³¨ç‚¹ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     åº”ç”¨å±‚ (Application)                      â”‚
â”‚  â— ä¸šåŠ¡æŒ‡æ ‡: è®¢å•é‡ã€æ”¯ä»˜æˆåŠŸç‡ã€ç”¨æˆ·æ´»è·ƒåº¦                     â”‚
â”‚  â— åº”ç”¨æ€§èƒ½: APIå»¶è¿Ÿã€é”™è¯¯ç‡ã€QPS                              â”‚
â”‚  â— è‡ªå®šä¹‰Metrics: /metricsç«¯ç‚¹æš´éœ²çš„ä¸šåŠ¡æŒ‡æ ‡                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                   å®¹å™¨å±‚ (Container)                          â”‚
â”‚  â— å®¹å™¨èµ„æº: CPUã€å†…å­˜ã€ç½‘ç»œã€ç£ç›˜IO                            â”‚
â”‚  â— å®¹å™¨çŠ¶æ€: é‡å¯æ¬¡æ•°ã€OOMæ¬¡æ•°ã€é•œåƒæ‹‰å–æ—¶é•¿                     â”‚
â”‚  â— å®¹å™¨æ—¥å¿—: stdout/stderrè¾“å‡º                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                    Podå±‚ (Pod)                               â”‚
â”‚  â— PodçŠ¶æ€: Running/Pending/Failed/CrashLoopBackOff          â”‚
â”‚  â— Podäº‹ä»¶: è°ƒåº¦å¤±è´¥ã€å¥åº·æ£€æŸ¥å¤±è´¥ã€VolumeæŒ‚è½½å¤±è´¥               â”‚
â”‚  â— Podèµ„æº: requests/limitsè®¾ç½®ã€å®é™…ä½¿ç”¨é‡                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚              Kubernetesèµ„æºå±‚ (K8s Resources)                â”‚
â”‚  â— Deployment: å‰¯æœ¬æ•°ã€å¯ç”¨å‰¯æœ¬ã€æ›´æ–°çŠ¶æ€                       â”‚
â”‚  â— Service: Endpointæ•°é‡ã€æµé‡åˆ†å¸ƒ                            â”‚
â”‚  â— PVC/PV: å­˜å‚¨ä½¿ç”¨ç‡ã€IOPSã€ååé‡                           â”‚
â”‚  â— Node: èŠ‚ç‚¹çŠ¶æ€ã€å¯è°ƒåº¦èµ„æºã€æ±¡ç‚¹å’Œæ ‡ç­¾                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                   èŠ‚ç‚¹å±‚ (Node)                              â”‚
â”‚  â— ç³»ç»Ÿèµ„æº: CPUã€å†…å­˜ã€ç£ç›˜ã€ç½‘ç»œ                             â”‚
â”‚  â— ç³»ç»ŸæœåŠ¡: kubeletã€kube-proxyã€å®¹å™¨è¿è¡Œæ—¶                   â”‚
â”‚  â— ç³»ç»Ÿæ—¥å¿—: /var/log/messagesã€journalctl                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚               æ§åˆ¶å¹³é¢å±‚ (Control Plane)                      â”‚
â”‚  â— API Server: è¯·æ±‚å»¶è¿Ÿã€é”™è¯¯ç‡ã€å®¡è®¡æ—¥å¿—                      â”‚
â”‚  â— etcd: æ•°æ®åº“å¤§å°ã€å†™å…¥å»¶è¿Ÿã€Leaderé€‰ä¸¾                      â”‚
â”‚  â— Scheduler: è°ƒåº¦å»¶è¿Ÿã€é˜Ÿåˆ—é•¿åº¦ã€å¤±è´¥æ¬¡æ•°                     â”‚
â”‚  â— Controller Manager: Reconcileå¾ªç¯è€—æ—¶ã€å·¥ä½œé˜Ÿåˆ—æ·±åº¦        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### KubernetesåŸç”Ÿç›‘æ§æ¶æ„

Kubernetesæä¾›äº†ä¸¤å¥—å®˜æ–¹ç›‘æ§APIï¼š

##### 1. Resource Metrics API (èµ„æºæŒ‡æ ‡)

**ç”¨é€”**ï¼šæä¾›Podå’ŒNodeçš„CPU/å†…å­˜ä½¿ç”¨æƒ…å†µï¼Œç”¨äºHPAå’ŒVPA

**æ¶æ„**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ kubectl top  â”‚  (æŸ¥è¯¢CPU/å†…å­˜)
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   API Server (Metrics API)           â”‚
â”‚   /apis/metrics.k8s.io/v1beta1/      â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Metrics Server                     â”‚  (èšåˆå™¨)
â”‚   - ä»kubeletæŠ“å–æŒ‡æ ‡                 â”‚
â”‚   - å†…å­˜å­˜å‚¨(æœ€è¿‘15åˆ†é’Ÿ)               â”‚
â”‚   - ä¸æŒä¹…åŒ–                          â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   kubelet (æ¯ä¸ªNode)                 â”‚
â”‚   - cAdvisor: å®¹å™¨èµ„æºæ•°æ®            â”‚
â”‚   - /stats/summary API               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Metrics Serverçš„å±€é™**ï¼š
- âŒ åªä¿å­˜æœ€è¿‘15åˆ†é’Ÿæ•°æ®ï¼ˆæ— æ³•æŸ¥çœ‹å†å²è¶‹åŠ¿ï¼‰
- âŒ åªæœ‰CPU/å†…å­˜ï¼ˆæ— æ³•æŸ¥çœ‹ç½‘ç»œã€ç£ç›˜IOï¼‰
- âŒ æ— æ³•è‡ªå®šä¹‰æŒ‡æ ‡ï¼ˆåªèƒ½çœ‹èµ„æºï¼Œçœ‹ä¸åˆ°ä¸šåŠ¡æŒ‡æ ‡ï¼‰
- âŒ ä¸æ”¯æŒå‘Šè­¦ï¼ˆéœ€è¦é…åˆå…¶ä»–å·¥å…·ï¼‰

**é€‚ç”¨åœºæ™¯**ï¼š
- âœ… HPAè‡ªåŠ¨æ‰©ç¼©å®¹ï¼ˆåŸºäºCPU/å†…å­˜ï¼‰
- âœ… å¿«é€ŸæŸ¥çœ‹å½“å‰èµ„æºä½¿ç”¨ï¼ˆkubectl topï¼‰
- âœ… è½»é‡çº§éƒ¨ç½²ï¼ˆå°å‹é›†ç¾¤ï¼‰

##### 2. Custom Metrics API (è‡ªå®šä¹‰æŒ‡æ ‡)

**ç”¨é€”**ï¼šæ”¯æŒä»»æ„è‡ªå®šä¹‰æŒ‡æ ‡ï¼ˆå¦‚ï¼šQPSã€é”™è¯¯ç‡ï¼‰ï¼Œç”¨äºé«˜çº§HPA

**æ¶æ„**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   HPA Controller                     â”‚
â”‚   (æ ¹æ®è‡ªå®šä¹‰æŒ‡æ ‡æ‰©ç¼©å®¹)               â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   API Server                         â”‚
â”‚   /apis/custom.metrics.k8s.io/v1beta1â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Prometheus Adapter                 â”‚  (é€‚é…å™¨)
â”‚   - å°†PrometheusæŒ‡æ ‡è½¬æ¢ä¸ºK8s API     â”‚
â”‚   - æ”¯æŒPromQLæŸ¥è¯¢                    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Prometheus                         â”‚
â”‚   - æŠ“å–åº”ç”¨çš„/metricsç«¯ç‚¹            â”‚
â”‚   - å­˜å‚¨æ—¶åºæ•°æ®                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ç¤ºä¾‹**ï¼šåŸºäºQPSè‡ªåŠ¨æ‰©ç¼©å®¹

```yaml
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: web-hpa
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: web
  minReplicas: 2
  maxReplicas: 10
  metrics:
  - type: Pods
    pods:
      metric:
        name: http_requests_per_second  # è‡ªå®šä¹‰æŒ‡æ ‡
      target:
        type: AverageValue
        averageValue: "1000"  # æ¯ä¸ªPodå¤„ç†1000 QPSæ—¶æ‰©å®¹
```

#### å®Œæ•´çš„ç”Ÿäº§çº§ç›‘æ§æ¶æ„

```
                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                         â”‚      å¤–éƒ¨ç”¨æˆ·/è¿ç»´äººå‘˜                â”‚
                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                  â”‚                  â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚   Grafana      â”‚  â”‚  Kibana    â”‚  â”‚  Jaeger UI     â”‚
            â”‚  (å¯è§†åŒ–)       â”‚  â”‚ (æ—¥å¿—æŸ¥è¯¢)  â”‚  â”‚  (é“¾è·¯è¿½è¸ª)     â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚                 â”‚                  â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚          â”‚                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â” â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Prometheus  â”‚ â”‚ Elasticsearchâ”‚ â”‚ Jaeger Collectorâ”‚
â”‚ (Metrics)   â”‚ â”‚  (æ—¥å¿—å­˜å‚¨)   â”‚ â”‚  (Traceå­˜å‚¨)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â–²â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â–²â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚          â”‚                â”‚
         â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  â”‚   Fluentd      â”‚  â”‚ Jaeger Agent â”‚
         â”‚  â”‚  (æ—¥å¿—æ”¶é›†)     â”‚  â”‚  (Traceé‡‡é›†) â”‚
         â”‚  â””â”€â”€â”€â”€â”€â”€â”€â–²â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â–²â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚          â”‚                â”‚
         â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  â”‚                                       â”‚
    â”Œâ”€â”€â”€â”€â–¼â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
    â”‚         Kubernetes Cluster                 â”‚ â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
    â”‚  â”‚ kube-state-metrics (K8sèµ„æºçŠ¶æ€)      â”‚â—„â”€â”˜ â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
    â”‚  â”‚ Node Exporter (èŠ‚ç‚¹æŒ‡æ ‡)              â”‚â—„â”€â”€â”€â”¤
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
    â”‚  â”‚ Application Pods (åº”ç”¨æŒ‡æ ‡/æ—¥å¿—)      â”‚â—„â”€â”€â”€â”˜
    â”‚  â”‚  - /metrics (Prometheusæ ¼å¼)          â”‚
    â”‚  â”‚  - stdout/stderræ—¥å¿—                  â”‚
    â”‚  â”‚  - OpenTelemetry SDK (TracingåŸ‹ç‚¹)    â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å„ç»„ä»¶èŒè´£**ï¼š

| ç»„ä»¶ | èŒè´£ | æ•°æ®é‡çº§ |
|------|------|---------|
| **Prometheus** | æŠ“å–å’Œå­˜å‚¨Metrics | ä¸­ç­‰ï¼ˆæ¯ç§’æ•°åƒæ ·æœ¬ï¼‰ |
| **kube-state-metrics** | æš´éœ²K8sèµ„æºçŠ¶æ€ä¸ºMetrics | ä½ï¼ˆèµ„æºå¯¹è±¡çº§åˆ«ï¼‰ |
| **Node Exporter** | æš´éœ²èŠ‚ç‚¹ç³»ç»ŸæŒ‡æ ‡ | ä¸­ç­‰ï¼ˆæ¯ä¸ªèŠ‚ç‚¹æ•°ç™¾æŒ‡æ ‡ï¼‰ |
| **Fluentd/Fluent Bit** | æ”¶é›†å®¹å™¨æ—¥å¿—å¹¶è½¬å‘åˆ°ES | é«˜ï¼ˆæ¯ç§’GBçº§åˆ«ï¼‰ |
| **Elasticsearch** | å­˜å‚¨å’Œç´¢å¼•æ—¥å¿— | æé«˜ï¼ˆTBçº§åˆ«ï¼‰ |
| **Kibana** | æ—¥å¿—æŸ¥è¯¢å’Œå¯è§†åŒ– | - |
| **Jaeger Agent** | æ¥æ”¶åº”ç”¨Traceæ•°æ®å¹¶è½¬å‘ | ä¸­ç­‰ï¼ˆé‡‡æ ·åï¼‰ |
| **Jaeger Collector** | èšåˆTraceå¹¶å†™å…¥å­˜å‚¨ | ä¸­ç­‰ |
| **Grafana** | ç»Ÿä¸€å¯è§†åŒ–å¹³å° | - |

---

### 9.1.3 Metrics APIä¸èµ„æºæŒ‡æ ‡

#### Metrics Serverè¯¦è§£

**Metrics Serveræ˜¯ä»€ä¹ˆï¼Ÿ**

Metrics Serveræ˜¯Kuberneteså®˜æ–¹æä¾›çš„è½»é‡çº§ã€çŸ­æœŸçš„èµ„æºæŒ‡æ ‡æ”¶é›†å™¨ã€‚å®ƒä»æ¯ä¸ªèŠ‚ç‚¹çš„kubeletæ”¶é›†CPUå’Œå†…å­˜ä½¿ç”¨æ•°æ®ï¼Œå¹¶é€šè¿‡Metrics APIæš´éœ²ç»™Kubernetesç»„ä»¶ï¼ˆå¦‚HPAã€VPAã€kubectl topï¼‰ã€‚

**æ ¸å¿ƒç‰¹ç‚¹**ï¼š
- âœ… å®˜æ–¹ç»´æŠ¤ï¼Œç¨³å®šå¯é 
- âœ… éƒ¨ç½²ç®€å•ï¼ˆå•ä¸ªDeploymentï¼‰
- âœ… èµ„æºå ç”¨ä½ï¼ˆæ¯ä¸ªèŠ‚ç‚¹ä»…éœ€10-20MBå†…å­˜ï¼‰
- âœ… ä¸kubectlé›†æˆï¼ˆkubectl topå‘½ä»¤ï¼‰
- âŒ åªä¿å­˜æœ€è¿‘æ•°æ®ï¼ˆä¸é€‚åˆå†å²åˆ†æï¼‰
- âŒ åŠŸèƒ½æœ‰é™ï¼ˆä»…CPU/å†…å­˜ï¼‰

**æ¶æ„å›¾**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Kubernetes API Server                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Aggregation Layer (APIèšåˆå±‚)                       â”‚   â”‚
â”‚  â”‚  - /apis/metrics.k8s.io/v1beta1/nodes                â”‚   â”‚
â”‚  â”‚  - /apis/metrics.k8s.io/v1beta1/pods                 â”‚   â”‚
â”‚  â”‚  - /apis/metrics.k8s.io/v1beta1/namespaces/{ns}/pods â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   Metrics Server           â”‚
        â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
        â”‚  â”‚ In-Memory Storage    â”‚  â”‚ (ä»…ä¿ç•™15åˆ†é’Ÿæ•°æ®)
        â”‚  â”‚ - CPU/Memory         â”‚  â”‚
        â”‚  â”‚ - 60ç§’åˆ·æ–°é—´éš”        â”‚  â”‚
        â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
        â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
        â”‚  â”‚ Kubelet Client       â”‚  â”‚ (æŠ“å–kubeletæ•°æ®)
        â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚             â”‚             â”‚
â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”
â”‚kubelet â”‚   â”‚kubelet â”‚   â”‚kubelet â”‚
â”‚ Node1  â”‚   â”‚ Node2  â”‚   â”‚ Node3  â”‚
â”‚  â””â”€â”€â”  â”‚   â”‚  â””â”€â”€â”  â”‚   â”‚  â””â”€â”€â”  â”‚
â”‚ cAdvâ”‚  â”‚   â”‚ cAdvâ”‚  â”‚   â”‚ cAdvâ”‚  â”‚ (å®¹å™¨èµ„æºç›‘æ§)
â””â”€â”€â”€â”€â”€â”˜  â”‚   â””â”€â”€â”€â”€â”€â”˜  â”‚   â””â”€â”€â”€â”€â”€â”˜  â”‚
   Pod1     Pod2        Pod3
```

#### éƒ¨ç½²Metrics Server

**1. å¿«é€Ÿéƒ¨ç½²ï¼ˆå®˜æ–¹YAMLï¼‰**

```bash
# ä¸‹è½½å®˜æ–¹éƒ¨ç½²æ–‡ä»¶
kubectl apply -f https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/components.yaml
```

**2. è‡ªå®šä¹‰éƒ¨ç½²ï¼ˆç”Ÿäº§ç¯å¢ƒæ¨èï¼‰**

```yaml
# metrics-server-deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: metrics-server
  namespace: kube-system
  labels:
    k8s-app: metrics-server
spec:
  replicas: 1  # ç”Ÿäº§ç¯å¢ƒå»ºè®®2ä¸ªå‰¯æœ¬ï¼ˆé«˜å¯ç”¨ï¼‰
  selector:
    matchLabels:
      k8s-app: metrics-server
  template:
    metadata:
      labels:
        k8s-app: metrics-server
    spec:
      serviceAccountName: metrics-server
      containers:
      - name: metrics-server
        image: registry.k8s.io/metrics-server/metrics-server:v0.7.0
        imagePullPolicy: IfNotPresent
        args:
        - --cert-dir=/tmp
        - --secure-port=10250
        - --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname
        - --kubelet-use-node-status-port
        - --metric-resolution=15s  # æ•°æ®é‡‡é›†é—´éš”ï¼ˆé»˜è®¤60sï¼Œå¯è°ƒæ•´ä¸º15sæé«˜ç²¾åº¦ï¼‰
        # å¦‚æœkubeletä½¿ç”¨è‡ªç­¾åè¯ä¹¦ï¼Œéœ€è¦æ·»åŠ ä»¥ä¸‹å‚æ•°ï¼ˆæµ‹è¯•ç¯å¢ƒï¼‰
        # - --kubelet-insecure-tls
        ports:
        - containerPort: 10250
          name: https
          protocol: TCP
        livenessProbe:
          httpGet:
            path: /livez
            port: https
            scheme: HTTPS
          initialDelaySeconds: 20
          periodSeconds: 10
          failureThreshold: 3
        readinessProbe:
          httpGet:
            path: /readyz
            port: https
            scheme: HTTPS
          initialDelaySeconds: 20
          periodSeconds: 10
          failureThreshold: 3
        resources:
          requests:
            cpu: 100m
            memory: 200Mi
          limits:
            cpu: 1000m
            memory: 1Gi
        securityContext:
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: true
          runAsNonRoot: true
          runAsUser: 1000
          seccompProfile:
            type: RuntimeDefault
          capabilities:
            drop:
            - ALL
        volumeMounts:
        - name: tmp-dir
          mountPath: /tmp
      volumes:
      - name: tmp-dir
        emptyDir: {}
      priorityClassName: system-cluster-critical
      nodeSelector:
        kubernetes.io/os: linux
---
apiVersion: v1
kind: Service
metadata:
  name: metrics-server
  namespace: kube-system
  labels:
    k8s-app: metrics-server
spec:
  selector:
    k8s-app: metrics-server
  ports:
  - port: 443
    protocol: TCP
    targetPort: https
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: metrics-server
  namespace: kube-system
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: system:metrics-server
rules:
- apiGroups:
  - ""
  resources:
  - nodes/metrics
  verbs:
  - get
- apiGroups:
  - ""
  resources:
  - pods
  - nodes
  verbs:
  - get
  - list
  - watch
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: system:metrics-server
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: system:metrics-server
subjects:
- kind: ServiceAccount
  name: metrics-server
  namespace: kube-system
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: system:aggregated-metrics-reader
  labels:
    rbac.authorization.k8s.io/aggregate-to-view: "true"
    rbac.authorization.k8s.io/aggregate-to-edit: "true"
    rbac.authorization.k8s.io/aggregate-to-admin: "true"
rules:
- apiGroups:
  - metrics.k8s.io
  resources:
  - pods
  - nodes
  verbs:
  - get
  - list
  - watch
---
apiVersion: apiregistration.k8s.io/v1
kind: APIService
metadata:
  name: v1beta1.metrics.k8s.io
spec:
  service:
    name: metrics-server
    namespace: kube-system
  group: metrics.k8s.io
  version: v1beta1
  insecureSkipTLSVerify: true
  groupPriorityMinimum: 100
  versionPriority: 100
```

**3. éƒ¨ç½²å¹¶éªŒè¯**

```bash
# éƒ¨ç½²
kubectl apply -f metrics-server-deployment.yaml

# æ£€æŸ¥PodçŠ¶æ€
kubectl get pod -n kube-system -l k8s-app=metrics-server

# è¾“å‡ºç¤ºä¾‹:
# NAME                              READY   STATUS    RESTARTS   AGE
# metrics-server-5f8d6b7c9d-7x4ml   1/1     Running   0          2m

# æ£€æŸ¥APIæ³¨å†Œ
kubectl get apiservice v1beta1.metrics.k8s.io

# è¾“å‡ºç¤ºä¾‹:
# NAME                     SERVICE                      AVAILABLE   AGE
# v1beta1.metrics.k8s.io   kube-system/metrics-server   True        2m

# æµ‹è¯•æŸ¥è¯¢ï¼ˆç­‰å¾…1-2åˆ†é’Ÿæ•°æ®é‡‡é›†å®Œæˆï¼‰
kubectl top nodes
kubectl top pods -A
```

**å¸¸è§é—®é¢˜æ’æŸ¥**ï¼š

```bash
# é—®é¢˜1: Metrics Server PodçŠ¶æ€ä¸ºCrashLoopBackOff
kubectl logs -n kube-system -l k8s-app=metrics-server

# å¸¸è§é”™è¯¯: "x509: cannot validate certificate for xxx because it doesn't contain any IP SANs"
# è§£å†³: æ·»åŠ  --kubelet-insecure-tls å‚æ•°ï¼ˆä»…é™æµ‹è¯•ç¯å¢ƒï¼‰

# é—®é¢˜2: kubectl top nodes æŠ¥é”™ "Error from server (ServiceUnavailable): the server is currently unable to handle the request"
# åŸå› : Metrics Serverè¿˜åœ¨é‡‡é›†æ•°æ®ï¼Œç­‰å¾…1-2åˆ†é’Ÿ

# é—®é¢˜3: æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
kubectl logs -n kube-system deploy/metrics-server --tail=100 -f
```

#### ä½¿ç”¨kubectl topæŸ¥çœ‹èµ„æº

**1. æŸ¥çœ‹èŠ‚ç‚¹èµ„æº**

```bash
# æŸ¥çœ‹æ‰€æœ‰èŠ‚ç‚¹çš„CPUå’Œå†…å­˜ä½¿ç”¨
kubectl top nodes

# è¾“å‡ºç¤ºä¾‹:
# NAME       CPU(cores)   CPU%   MEMORY(bytes)   MEMORY%
# node1      450m         22%    3500Mi          45%
# node2      320m         16%    2800Mi          36%
# node3      580m         29%    4200Mi          54%
```

**è§£è¯»**ï¼š
- `CPU(cores)`: ä½¿ç”¨çš„CPUæ ¸å¿ƒæ•°ï¼ˆ450m = 0.45æ ¸ï¼‰
- `CPU%`: å èŠ‚ç‚¹æ€»CPUçš„ç™¾åˆ†æ¯”ï¼ˆå‡è®¾èŠ‚ç‚¹æœ‰2æ ¸ï¼Œ450m/2000m = 22.5%ï¼‰
- `MEMORY(bytes)`: å†…å­˜ä½¿ç”¨é‡ï¼ˆ3500Mi â‰ˆ 3.5GBï¼‰
- `MEMORY%`: å èŠ‚ç‚¹æ€»å†…å­˜çš„ç™¾åˆ†æ¯”

**2. æŸ¥çœ‹Podèµ„æº**

```bash
# æŸ¥çœ‹æ‰€æœ‰å‘½åç©ºé—´çš„Pod
kubectl top pods -A

# æŸ¥çœ‹ç‰¹å®šå‘½åç©ºé—´
kubectl top pods -n production

# æŸ¥çœ‹ç‰¹å®šPodçš„å®¹å™¨çº§åˆ«èµ„æº
kubectl top pods nginx-deployment-abc123 --containers

# è¾“å‡ºç¤ºä¾‹:
# POD                          CONTAINER    CPU(cores)   MEMORY(bytes)
# nginx-deployment-abc123      nginx        10m          50Mi
# nginx-deployment-abc123      sidecar      2m           20Mi

# æ’åºï¼ˆæŒ‰CPUé™åºï¼‰
kubectl top pods -A --sort-by=cpu

# æ’åºï¼ˆæŒ‰å†…å­˜é™åºï¼‰
kubectl top pods -A --sort-by=memory
```

**3. ç»“åˆå…¶ä»–å‘½ä»¤åˆ†æ**

```bash
# æ‰¾å‡ºå†…å­˜ä½¿ç”¨TOP 10çš„Pod
kubectl top pods -A --sort-by=memory | head -11

# æ‰¾å‡ºCPUä½¿ç”¨è¶…è¿‡100mçš„Pod
kubectl top pods -A | awk '$2 > 100'

# å¯¹æ¯”requests/limitsé…ç½®
kubectl get pods nginx-abc -o json | jq '.spec.containers[].resources'
kubectl top pod nginx-abc
```

#### Metrics APIçš„ç¼–ç¨‹ä½¿ç”¨

**1. ç›´æ¥è°ƒç”¨API**

```bash
# æŸ¥è¯¢æ‰€æœ‰èŠ‚ç‚¹æŒ‡æ ‡
kubectl get --raw /apis/metrics.k8s.io/v1beta1/nodes | jq .

# è¾“å‡ºç¤ºä¾‹:
# {
#   "kind": "NodeMetricsList",
#   "apiVersion": "metrics.k8s.io/v1beta1",
#   "metadata": {},
#   "items": [
#     {
#       "metadata": {
#         "name": "node1",
#         "creationTimestamp": "2024-01-20T10:30:00Z"
#       },
#       "timestamp": "2024-01-20T10:29:45Z",
#       "window": "30s",
#       "usage": {
#         "cpu": "450m",
#         "memory": "3500Mi"
#       }
#     }
#   ]
# }

# æŸ¥è¯¢ç‰¹å®šPodæŒ‡æ ‡
kubectl get --raw /apis/metrics.k8s.io/v1beta1/namespaces/default/pods/nginx-abc | jq .
```

**2. ä½¿ç”¨client-goè®¿é—®Metrics API (Go)**

```go
package main

import (
    "context"
    "fmt"
    metav1 "k8s.io/apimachinery/pkg/apis/meta/v1"
    "k8s.io/client-go/kubernetes"
    "k8s.io/client-go/tools/clientcmd"
    metricsv "k8s.io/metrics/pkg/client/clientset/versioned"
)

func main() {
    // åŠ è½½kubeconfig
    config, err := clientcmd.BuildConfigFromFlags("", "/home/user/.kube/config")
    if err != nil {
        panic(err)
    }

    // åˆ›å»ºMetricså®¢æˆ·ç«¯
    metricsClient, err := metricsv.NewForConfig(config)
    if err != nil {
        panic(err)
    }

    // æŸ¥è¯¢èŠ‚ç‚¹æŒ‡æ ‡
    nodeMetrics, err := metricsClient.MetricsV1beta1().NodeMetricses().List(context.TODO(), metav1.ListOptions{})
    if err != nil {
        panic(err)
    }

    for _, node := range nodeMetrics.Items {
        cpu := node.Usage.Cpu().MilliValue()  // è½¬æ¢ä¸ºæ¯«æ ¸
        memory := node.Usage.Memory().Value() / 1024 / 1024  // è½¬æ¢ä¸ºMiB
        fmt.Printf("Node: %s, CPU: %dm, Memory: %dMi\n", node.Name, cpu, memory)
    }

    // æŸ¥è¯¢PodæŒ‡æ ‡
    podMetrics, err := metricsClient.MetricsV1beta1().PodMetricses("default").List(context.TODO(), metav1.ListOptions{})
    if err != nil {
        panic(err)
    }

    for _, pod := range podMetrics.Items {
        for _, container := range pod.Containers {
            cpu := container.Usage.Cpu().MilliValue()
            memory := container.Usage.Memory().Value() / 1024 / 1024
            fmt.Printf("Pod: %s, Container: %s, CPU: %dm, Memory: %dMi\n",
                pod.Name, container.Name, cpu, memory)
        }
    }
}
```

**3. ä½¿ç”¨Pythonè®¿é—®Metrics API**

```python
from kubernetes import client, config

# åŠ è½½kubeconfig
config.load_kube_config()

# åˆ›å»ºAPIå®¢æˆ·ç«¯
api_client = client.ApiClient()
custom_api = client.CustomObjectsApi(api_client)

# æŸ¥è¯¢èŠ‚ç‚¹æŒ‡æ ‡
node_metrics = custom_api.list_cluster_custom_object(
    group="metrics.k8s.io",
    version="v1beta1",
    plural="nodes"
)

for node in node_metrics['items']:
    name = node['metadata']['name']
    cpu = node['usage']['cpu']
    memory = node['usage']['memory']
    print(f"Node: {name}, CPU: {cpu}, Memory: {memory}")

# æŸ¥è¯¢PodæŒ‡æ ‡
pod_metrics = custom_api.list_namespaced_custom_object(
    group="metrics.k8s.io",
    version="v1beta1",
    namespace="default",
    plural="pods"
)

for pod in pod_metrics['items']:
    pod_name = pod['metadata']['name']
    for container in pod['containers']:
        container_name = container['name']
        cpu = container['usage']['cpu']
        memory = container['usage']['memory']
        print(f"Pod: {pod_name}, Container: {container_name}, CPU: {cpu}, Memory: {memory}")
```

#### HPAåŸºäºMetricsè‡ªåŠ¨æ‰©ç¼©å®¹

**1. åŸºäºCPUçš„HPA**

```yaml
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: nginx-hpa
  namespace: default
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: nginx
  minReplicas: 2
  maxReplicas: 10
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70  # CPUä½¿ç”¨ç‡è¶…è¿‡70%æ—¶æ‰©å®¹
  behavior:
    scaleDown:
      stabilizationWindowSeconds: 300  # ç¼©å®¹å‰ç­‰å¾…5åˆ†é’Ÿè§‚å¯Ÿ
      policies:
      - type: Percent
        value: 50
        periodSeconds: 60  # æ¯åˆ†é’Ÿæœ€å¤šç¼©å®¹50%
    scaleUp:
      stabilizationWindowSeconds: 0
      policies:
      - type: Percent
        value: 100
        periodSeconds: 30  # æ¯30ç§’æœ€å¤šæ‰©å®¹100%ï¼ˆç¿»å€ï¼‰
      - type: Pods
        value: 4
        periodSeconds: 30  # æ¯30ç§’æœ€å¤šå¢åŠ 4ä¸ªPod
      selectPolicy: Max  # é€‰æ‹©æ‰©å®¹æœ€å¿«çš„ç­–ç•¥
```

**2. åŸºäºå†…å­˜çš„HPA**

```yaml
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: java-app-hpa
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: java-app
  minReplicas: 3
  maxReplicas: 20
  metrics:
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 80  # å†…å­˜ä½¿ç”¨ç‡è¶…è¿‡80%æ—¶æ‰©å®¹
```

**3. å¤šæŒ‡æ ‡ç»„åˆHPA**

```yaml
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: web-hpa
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: web
  minReplicas: 5
  maxReplicas: 50
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 80
  # ä»»æ„ä¸€ä¸ªæŒ‡æ ‡è¾¾åˆ°é˜ˆå€¼å°±è§¦å‘æ‰©å®¹
```

**4. éªŒè¯HPA**

```bash
# éƒ¨ç½²HPA
kubectl apply -f nginx-hpa.yaml

# æŸ¥çœ‹HPAçŠ¶æ€
kubectl get hpa nginx-hpa

# è¾“å‡ºç¤ºä¾‹:
# NAME        REFERENCE          TARGETS   MINPODS   MAXPODS   REPLICAS   AGE
# nginx-hpa   Deployment/nginx   15%/70%   2         10        2          5m

# æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯
kubectl describe hpa nginx-hpa

# æ¨¡æ‹Ÿè´Ÿè½½æµ‹è¯•ï¼ˆè§¦å‘æ‰©å®¹ï¼‰
kubectl run -it --rm load-generator --image=busybox --restart=Never -- sh -c "while true; do wget -q -O- http://nginx; done"

# è§‚å¯ŸHPAè‡ªåŠ¨æ‰©å®¹
kubectl get hpa nginx-hpa --watch
```

---

### 9.1.4 ç›‘æ§æ•°æ®é‡‡é›†è·¯å¾„

#### kubeletçš„cAdvisor

**cAdvisor (Container Advisor)** æ˜¯kubeletå†…ç½®çš„å®¹å™¨èµ„æºç›‘æ§ç»„ä»¶ï¼Œè´Ÿè´£æ”¶é›†èŠ‚ç‚¹ä¸Šæ‰€æœ‰å®¹å™¨çš„èµ„æºä½¿ç”¨æƒ…å†µã€‚

**cAdvisoræš´éœ²çš„APIç«¯ç‚¹**ï¼š

```bash
# 1. Summary API (Metrics Serverä½¿ç”¨)
# æä¾›èŠ‚ç‚¹å’ŒPodçº§åˆ«çš„èšåˆæ•°æ®
curl -k https://NODE_IP:10250/stats/summary \
  --header "Authorization: Bearer $(kubectl get secret -n kube-system -o jsonpath='{.items[?(@.metadata.annotations.kubernetes\.io/service-account\.name=="default")].data.token}' | base64 -d)"

# è¿”å›ç¤ºä¾‹:
# {
#   "node": {
#     "nodeName": "node1",
#     "cpu": {
#       "time": "2024-01-20T10:30:00Z",
#       "usageNanoCores": 450000000,  // 450m CPU
#       "usageCoreNanoSeconds": 1234567890
#     },
#     "memory": {
#       "time": "2024-01-20T10:30:00Z",
#       "usageBytes": 3670016000,  // 3.5GB
#       "workingSetBytes": 3500000000
#     }
#   },
#   "pods": [...]
# }

# 2. Metrics API (Prometheusä½¿ç”¨)
# æä¾›æ›´è¯¦ç»†çš„å®¹å™¨çº§åˆ«æ•°æ®
curl -k https://NODE_IP:10250/metrics

# è¿”å›Prometheusæ ¼å¼:
# container_cpu_usage_seconds_total{container="nginx",namespace="default",pod="nginx-abc"} 12.34
# container_memory_working_set_bytes{container="nginx",namespace="default",pod="nginx-abc"} 52428800
```

**cAdvisorç›‘æ§çš„æŒ‡æ ‡ç»´åº¦**ï¼š

| æŒ‡æ ‡ç±»åˆ« | å…·ä½“æŒ‡æ ‡ | è¯´æ˜ |
|---------|---------|------|
| **CPU** | cpu.usageNanoCores | å½“å‰CPUä½¿ç”¨ï¼ˆçº³æ ¸ï¼‰ |
|  | cpu.usageCoreNanoSeconds | ç´¯è®¡CPUä½¿ç”¨æ—¶é—´ |
| **å†…å­˜** | memory.usageBytes | æ€»å†…å­˜ä½¿ç”¨ï¼ˆåŒ…æ‹¬ç¼“å­˜ï¼‰ |
|  | memory.workingSetBytes | å·¥ä½œé›†å†…å­˜ï¼ˆçœŸå®ä½¿ç”¨ï¼‰ |
|  | memory.rssBytes | RSSå†…å­˜ï¼ˆåŒ¿åå†…å­˜ï¼‰ |
|  | memory.pageFaults | é¡µé¢é”™è¯¯æ¬¡æ•° |
| **ç½‘ç»œ** | network.rxBytes | æ¥æ”¶å­—èŠ‚æ•° |
|  | network.txBytes | å‘é€å­—èŠ‚æ•° |
|  | network.rxErrors | æ¥æ”¶é”™è¯¯æ•° |
| **ç£ç›˜** | fs.usedBytes | æ–‡ä»¶ç³»ç»Ÿä½¿ç”¨é‡ |
|  | fs.capacityBytes | æ–‡ä»¶ç³»ç»Ÿæ€»å®¹é‡ |
| **å®¹å™¨** | startTime | å®¹å™¨å¯åŠ¨æ—¶é—´ |
|  | restartCount | é‡å¯æ¬¡æ•° |

#### Prometheusæ•°æ®é‡‡é›†æµç¨‹

Prometheusé‡‡ç”¨**æ‹‰æ¨¡å¼ (Pull Model)** é‡‡é›†æ•°æ®ï¼Œä¸ä¼ ç»Ÿçš„æ¨æ¨¡å¼ï¼ˆå¦‚StatsDï¼‰ä¸åŒã€‚

**å®Œæ•´çš„æ•°æ®æµ**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Prometheus Server                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  Service Discovery (æœåŠ¡å‘ç°)                       â”‚     â”‚
â”‚  â”‚  - Kubernetes API (è‡ªåŠ¨å‘ç°Pod/Service/Node)        â”‚     â”‚
â”‚  â”‚  - é™æ€é…ç½®æ–‡ä»¶                                      â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚            â”‚                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  Scraper (æŠ“å–å™¨)                                   â”‚     â”‚
â”‚  â”‚  - å®šæœŸHTTP GET /metrics                            â”‚     â”‚
â”‚  â”‚  - é»˜è®¤é—´éš”: 15s-60s                                â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚            â”‚                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  TSDB (æ—¶åºæ•°æ®åº“)                                  â”‚     â”‚
â”‚  â”‚  - å‹ç¼©å­˜å‚¨ (æ¯ä¸ªæ ·æœ¬çº¦1-2å­—èŠ‚)                      â”‚     â”‚
â”‚  â”‚  - é»˜è®¤ä¿ç•™15å¤©                                     â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â”‚ HTTP GET /metrics (æ¯15s)
                          â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                â”‚                â”‚                  â”‚
    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”
    â”‚kubelet   â”‚    â”‚kube-stateâ”‚    â”‚  Node    â”‚      â”‚  App     â”‚
    â”‚/metrics  â”‚    â”‚-metrics  â”‚    â”‚ Exporter â”‚      â”‚ /metrics â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    (å®¹å™¨èµ„æº)       (K8sèµ„æºçŠ¶æ€)   (èŠ‚ç‚¹ç³»ç»ŸæŒ‡æ ‡)     (åº”ç”¨æŒ‡æ ‡)
```

**Prometheusé…ç½®ç¤ºä¾‹**ï¼š

```yaml
# prometheus-config.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-config
  namespace: monitoring
data:
  prometheus.yml: |
    global:
      scrape_interval: 15s  # å…¨å±€æŠ“å–é—´éš”
      evaluation_interval: 15s  # è§„åˆ™è¯„ä¼°é—´éš”
      external_labels:
        cluster: 'production'
        region: 'us-west-2'

    # æŠ“å–é…ç½®
    scrape_configs:
    # 1. æŠ“å–kubelet (å®¹å™¨èµ„æºæŒ‡æ ‡)
    - job_name: 'kubernetes-kubelet'
      scheme: https
      tls_config:
        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
      kubernetes_sd_configs:
      - role: node  # æœåŠ¡å‘ç°: æ‰€æœ‰èŠ‚ç‚¹
      relabel_configs:
      - action: labelmap
        regex: __meta_kubernetes_node_label_(.+)
      - target_label: __address__
        replacement: kubernetes.default.svc:443
      - source_labels: [__meta_kubernetes_node_name]
        regex: (.+)
        target_label: __metrics_path__
        replacement: /api/v1/nodes/${1}/proxy/metrics

    # 2. æŠ“å–kube-state-metrics (K8sèµ„æºçŠ¶æ€)
    - job_name: 'kube-state-metrics'
      kubernetes_sd_configs:
      - role: service
      relabel_configs:
      - source_labels: [__meta_kubernetes_service_label_app_kubernetes_io_name]
        action: keep
        regex: kube-state-metrics

    # 3. æŠ“å–Node Exporter (èŠ‚ç‚¹ç³»ç»ŸæŒ‡æ ‡)
    - job_name: 'node-exporter'
      kubernetes_sd_configs:
      - role: node
      relabel_configs:
      - source_labels: [__address__]
        regex: '(.*):10250'
        replacement: '${1}:9100'
        target_label: __address__

    # 4. æŠ“å–åº”ç”¨Pod (è‡ªå®šä¹‰æŒ‡æ ‡)
    - job_name: 'kubernetes-pods'
      kubernetes_sd_configs:
      - role: pod
      relabel_configs:
      # åªæŠ“å–å¸¦æœ‰ prometheus.io/scrape=true æ³¨è§£çš„Pod
      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
        action: keep
        regex: true
      # è‡ªå®šä¹‰æŠ“å–ç«¯å£ (é»˜è®¤/metrics)
      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_port]
        action: replace
        target_label: __address__
        regex: (.+)
        replacement: $1
      # è‡ªå®šä¹‰æŠ“å–è·¯å¾„
      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]
        action: replace
        target_label: __metrics_path__
        regex: (.+)
      # æ·»åŠ å‘½åç©ºé—´æ ‡ç­¾
      - source_labels: [__meta_kubernetes_namespace]
        target_label: kubernetes_namespace
      # æ·»åŠ Podåç§°æ ‡ç­¾
      - source_labels: [__meta_kubernetes_pod_name]
        target_label: kubernetes_pod_name
```

**åº”ç”¨å¦‚ä½•æš´éœ²Metrics**ï¼š

```yaml
# ç¤ºä¾‹: Goåº”ç”¨æš´éœ²PrometheusæŒ‡æ ‡
apiVersion: v1
kind: Pod
metadata:
  name: my-app
  annotations:
    prometheus.io/scrape: "true"  # å‘Šè¯‰PrometheusæŠ“å–æ­¤Pod
    prometheus.io/port: "8080"    # æŒ‡æ ‡ç«¯å£
    prometheus.io/path: "/metrics"  # æŒ‡æ ‡è·¯å¾„
spec:
  containers:
  - name: app
    image: my-app:v1.0
    ports:
    - containerPort: 8080
      name: metrics
```

```go
// Goåº”ç”¨ä»£ç ç¤ºä¾‹
package main

import (
    "net/http"
    "github.com/prometheus/client_golang/prometheus"
    "github.com/prometheus/client_golang/prometheus/promhttp"
)

var (
    // è‡ªå®šä¹‰CounteræŒ‡æ ‡
    httpRequestsTotal = prometheus.NewCounterVec(
        prometheus.CounterOpts{
            Name: "http_requests_total",
            Help: "Total number of HTTP requests",
        },
        []string{"method", "endpoint", "status"},
    )

    // è‡ªå®šä¹‰HistogramæŒ‡æ ‡
    httpRequestDuration = prometheus.NewHistogramVec(
        prometheus.HistogramOpts{
            Name: "http_request_duration_seconds",
            Help: "HTTP request latency",
            Buckets: []float64{0.01, 0.05, 0.1, 0.5, 1, 2, 5},
        },
        []string{"method", "endpoint"},
    )
)

func init() {
    // æ³¨å†ŒæŒ‡æ ‡
    prometheus.MustRegister(httpRequestsTotal)
    prometheus.MustRegister(httpRequestDuration)
}

func main() {
    // æš´éœ²/metricsç«¯ç‚¹
    http.Handle("/metrics", promhttp.Handler())
    
    // ä¸šåŠ¡Handler
    http.HandleFunc("/api/users", func(w http.ResponseWriter, r *http.Request) {
        timer := prometheus.NewTimer(httpRequestDuration.WithLabelValues(r.Method, "/api/users"))
        defer timer.ObserveDuration()

        // ä¸šåŠ¡é€»è¾‘...
        
        httpRequestsTotal.WithLabelValues(r.Method, "/api/users", "200").Inc()
        w.Write([]byte("OK"))
    })

    http.ListenAndServe(":8080", nil)
}
```

**è®¿é—®/metricsç«¯ç‚¹çš„è¾“å‡º**ï¼š

```
# HELP http_requests_total Total number of HTTP requests
# TYPE http_requests_total counter
http_requests_total{method="GET",endpoint="/api/users",status="200"} 15840

# HELP http_request_duration_seconds HTTP request latency
# TYPE http_request_duration_seconds histogram
http_request_duration_seconds_bucket{method="GET",endpoint="/api/users",le="0.01"} 8500
http_request_duration_seconds_bucket{method="GET",endpoint="/api/users",le="0.05"} 14200
http_request_duration_seconds_bucket{method="GET",endpoint="/api/users",le="0.1"} 15600
http_request_duration_seconds_bucket{method="GET",endpoint="/api/users",le="0.5"} 15820
http_request_duration_seconds_bucket{method="GET",endpoint="/api/users",le="1"} 15838
http_request_duration_seconds_bucket{method="GET",endpoint="/api/users",le="+Inf"} 15840
http_request_duration_seconds_sum{method="GET",endpoint="/api/users"} 458.92
http_request_duration_seconds_count{method="GET",endpoint="/api/users"} 15840
```

#### æ—¥å¿—é‡‡é›†æµç¨‹

**å®¹å™¨æ—¥å¿—çš„ç”Ÿå‘½å‘¨æœŸ**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Application Pod                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  Application Container                          â”‚     â”‚
â”‚  â”‚  - stdout: æ ‡å‡†è¾“å‡º                              â”‚     â”‚
â”‚  â”‚  - stderr: æ ‡å‡†é”™è¯¯                              â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â†“
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  Container Runtime (Docker/containerd) â”‚
  â”‚  - å†™å…¥æ—¥å¿—æ–‡ä»¶:                     â”‚
  â”‚    /var/log/pods/<namespace>_<pod>_<uid>/<container>/0.log  â”‚
  â”‚  - JSONæ ¼å¼:                         â”‚
  â”‚    {"log":"[INFO] User logged in\n", "stream":"stdout", "time":"2024-01-20T10:30:00Z"} â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â†“
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  kubelet (æ—¥å¿—è½®è½¬)                 â”‚
  â”‚  - é»˜è®¤å•æ–‡ä»¶ä¸Šé™: 10MB              â”‚
  â”‚  - é»˜è®¤ä¿ç•™æ–‡ä»¶æ•°: 5                â”‚
  â”‚  - è¶…è¿‡é™åˆ¶è‡ªåŠ¨è½®è½¬                  â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â†“
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  Fluentd/Fluent Bit (DaemonSet)    â”‚
  â”‚  - ä½¿ç”¨tail -fç›‘å¬æ—¥å¿—æ–‡ä»¶           â”‚
  â”‚  - è§£æJSONæ ¼å¼                     â”‚
  â”‚  - æ·»åŠ K8så…ƒæ•°æ®(Podå/å‘½åç©ºé—´)     â”‚
  â”‚  - è¿‡æ»¤/è½¬æ¢/è·¯ç”±                   â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â†“
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  Elasticsearch / Loki              â”‚
  â”‚  - ç´¢å¼•å’Œå­˜å‚¨æ—¥å¿—                   â”‚
  â”‚  - æ”¯æŒå…¨æ–‡æœç´¢                     â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Fluentdé…ç½®ç¤ºä¾‹**ï¼š

```yaml
# fluentd-daemonset.yaml
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: fluentd
  namespace: kube-system
spec:
  selector:
    matchLabels:
      app: fluentd
  template:
    metadata:
      labels:
        app: fluentd
    spec:
      serviceAccountName: fluentd
      containers:
      - name: fluentd
        image: fluent/fluentd-kubernetes-daemonset:v1-debian-elasticsearch
        env:
        - name: FLUENT_ELASTICSEARCH_HOST
          value: "elasticsearch.monitoring.svc.cluster.local"
        - name: FLUENT_ELASTICSEARCH_PORT
          value: "9200"
        - name: FLUENT_UID
          value: "0"  # ä»¥rootè¿è¡Œï¼ˆéœ€è¦è¯»å–æ—¥å¿—æ–‡ä»¶ï¼‰
        resources:
          requests:
            cpu: 100m
            memory: 200Mi
          limits:
            cpu: 1000m
            memory: 512Mi
        volumeMounts:
        - name: varlog
          mountPath: /var/log
          readOnly: true
        - name: varlibdockercontainers
          mountPath: /var/lib/docker/containers
          readOnly: true
        - name: fluentd-config
          mountPath: /fluentd/etc/
      volumes:
      - name: varlog
        hostPath:
          path: /var/log
      - name: varlibdockercontainers
        hostPath:
          path: /var/lib/docker/containers
      - name: fluentd-config
        configMap:
          name: fluentd-config
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: fluentd-config
  namespace: kube-system
data:
  fluent.conf: |
    # è¾“å…¥: å®¹å™¨æ—¥å¿—
    <source>
      @type tail
      path /var/log/containers/*.log
      pos_file /var/log/fluentd-containers.log.pos
      tag kubernetes.*
      read_from_head true
      <parse>
        @type json
        time_key time
        time_format %Y-%m-%dT%H:%M:%S.%NZ
      </parse>
    </source>

    # è¿‡æ»¤: æ·»åŠ Kuberneteså…ƒæ•°æ®
    <filter kubernetes.**>
      @type kubernetes_metadata
      @id filter_kube_metadata
    </filter>

    # è¿‡æ»¤: æ’é™¤ç³»ç»Ÿå‘½åç©ºé—´çš„DEBUGæ—¥å¿—
    <filter kubernetes.**>
      @type grep
      <exclude>
        key log
        pattern /DEBUG/
      </exclude>
      <exclude>
        key $.kubernetes.namespace_name
        pattern /^(kube-system|kube-public)$/
      </exclude>
    </filter>

    # è¾“å‡º: å‘é€åˆ°Elasticsearch
    <match kubernetes.**>
      @type elasticsearch
      host elasticsearch.monitoring.svc.cluster.local
      port 9200
      logstash_format true
      logstash_prefix kubernetes
      <buffer>
        @type file
        path /var/log/fluentd-buffers/kubernetes.buffer
        flush_mode interval
        flush_interval 5s
        flush_at_shutdown true
        retry_max_interval 30
      </buffer>
    </match>
```

---

**ğŸ“Š 9.1èŠ‚æ€»ç»“**

æœ¬èŠ‚æˆ‘ä»¬æ·±å…¥å­¦ä¹ äº†Kubernetesç›‘æ§çš„åŸºç¡€æ¦‚å¿µå’Œæ¶æ„è®¾è®¡ï¼š

âœ… **å¯è§‚æµ‹æ€§ä¸‰å¤§æ”¯æŸ±**ï¼š
- Metrics: èšåˆçš„æ—¶åºæ•°æ®ï¼Œå¿«é€Ÿå‘ç°å¼‚å¸¸
- Logging: ç¦»æ•£çš„äº‹ä»¶è®°å½•ï¼ŒæŸ¥çœ‹è¯¦ç»†ä¸Šä¸‹æ–‡
- Tracing: åˆ†å¸ƒå¼è°ƒç”¨é“¾è·¯ï¼Œå®šä½æ€§èƒ½ç“¶é¢ˆ

âœ… **Kubernetesç›‘æ§æ¶æ„**ï¼š
- 6å±‚ç›‘æ§ä½“ç³»ï¼ˆåº”ç”¨â†’å®¹å™¨â†’Podâ†’K8sèµ„æºâ†’èŠ‚ç‚¹â†’æ§åˆ¶å¹³é¢ï¼‰
- Metrics Serveræä¾›åŸºç¡€èµ„æºæŒ‡æ ‡
- Prometheusç”Ÿæ€æä¾›å®Œæ•´ç›‘æ§æ–¹æ¡ˆ

âœ… **Metrics APIå®æˆ˜**ï¼š
- éƒ¨ç½²Metrics Server
- ä½¿ç”¨kubectl topæŸ¥çœ‹èµ„æº
- é…ç½®HPAè‡ªåŠ¨æ‰©ç¼©å®¹
- ç¼–ç¨‹è®¿é—®Metrics API

âœ… **ç›‘æ§æ•°æ®é‡‡é›†**ï¼š
- kubeletçš„cAdvisoræš´éœ²å®¹å™¨æŒ‡æ ‡
- Prometheusæ‹‰æ¨¡å¼é‡‡é›†æ•°æ®
- Fluentdæ”¶é›†å’Œè½¬å‘æ—¥å¿—

**ä¸‹ä¸€èŠ‚é¢„å‘Š**ï¼šæˆ‘ä»¬å°†æ·±å…¥å­¦ä¹ Prometheusçš„æ ¸å¿ƒåŸç†ï¼ŒåŒ…æ‹¬æ•°æ®æ¨¡å‹ã€PromQLæŸ¥è¯¢è¯­è¨€ã€æœåŠ¡å‘ç°æœºåˆ¶ï¼Œä»¥åŠå¦‚ä½•åœ¨ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²é«˜å¯ç”¨çš„Prometheusé›†ç¾¤ã€‚

---
