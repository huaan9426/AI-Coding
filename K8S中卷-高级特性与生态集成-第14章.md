# ç¬¬14ç« ï¼šå‡†å…¥æ§åˆ¶ä¸ç­–ç•¥ç®¡ç†

## ç« èŠ‚æ¦‚è¿°

åœ¨ç¬¬13ç« ä¸­ï¼Œæˆ‘ä»¬å­¦ä¹ äº†å¦‚ä½•é€šè¿‡CRDå’ŒOperatoræ‰©å±•Kubernetesçš„åŠŸèƒ½ã€‚æœ¬ç« å°†æ·±å…¥å­¦ä¹ Kubernetesçš„**å‡†å…¥æ§åˆ¶ï¼ˆAdmission Controlï¼‰**æœºåˆ¶ï¼Œè¿™æ˜¯Kuberneteså®‰å…¨å’Œç­–ç•¥ç®¡ç†çš„æ ¸å¿ƒç»„ä»¶ã€‚

**æœ¬ç« æ ¸å¿ƒç›®æ ‡**ï¼š
- æ·±å…¥ç†è§£å‡†å…¥æ§åˆ¶å™¨çš„å·¥ä½œåŸç†
- æŒæ¡Validating Webhookå’ŒMutating Webhookçš„å¼€å‘
- å­¦ä¹ ä½¿ç”¨OPAï¼ˆOpen Policy Agentï¼‰å®æ–½ç­–ç•¥ç®¡ç†
- æŒæ¡Kyvernoç­–ç•¥å¼•æ“çš„ä½¿ç”¨
- å®æˆ˜ï¼šæ„å»ºä¼ä¸šçº§ç­–ç•¥ç®¡ç†ç³»ç»Ÿ

**ä¸ºä»€ä¹ˆéœ€è¦å‡†å…¥æ§åˆ¶ï¼Ÿ**

```
Kubernetes APIè¯·æ±‚æµç¨‹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. ç”¨æˆ·/ç³»ç»Ÿå‘èµ·APIè¯·æ±‚                    â”‚
â”‚     kubectl apply -f pod.yaml              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. è®¤è¯ï¼ˆAuthenticationï¼‰                 â”‚
â”‚     éªŒè¯ç”¨æˆ·èº«ä»½                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. æˆæƒï¼ˆAuthorizationï¼‰                  â”‚
â”‚     éªŒè¯ç”¨æˆ·æƒé™ï¼ˆRBACï¼‰                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  4. å‡†å…¥æ§åˆ¶ï¼ˆAdmission Controlï¼‰â­        â”‚
â”‚     â”œâ”€ Mutating Admissionï¼ˆä¿®æ”¹è¯·æ±‚ï¼‰      â”‚
â”‚     â””â”€ Validating Admissionï¼ˆéªŒè¯è¯·æ±‚ï¼‰    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  5. æŒä¹…åŒ–åˆ°etcd                           â”‚
â”‚     èµ„æºåˆ›å»ºæˆåŠŸ                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å‡†å…¥æ§åˆ¶çš„ä½œç”¨**ï¼š

```
å‡†å…¥æ§åˆ¶å™¨çš„å…¸å‹åº”ç”¨åœºæ™¯ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å®‰å…¨ç­–ç•¥                                   â”‚
â”‚  â”œâ”€ ç¦æ­¢ç‰¹æƒå®¹å™¨                           â”‚
â”‚  â”œâ”€ å¼ºåˆ¶é•œåƒæ¥æºéªŒè¯                       â”‚
â”‚  â”œâ”€ è¦æ±‚è®¾ç½®èµ„æºé™åˆ¶                       â”‚
â”‚  â””â”€ ç¦æ­¢hostPathæŒ‚è½½                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  èµ„æºç®¡ç†                                   â”‚
â”‚  â”œâ”€ è‡ªåŠ¨æ³¨å…¥èµ„æºé™åˆ¶                       â”‚
â”‚  â”œâ”€ è‡ªåŠ¨æ·»åŠ æ ‡ç­¾å’Œæ³¨è§£                     â”‚
â”‚  â”œâ”€ è‡ªåŠ¨è®¾ç½®é»˜è®¤å€¼                         â”‚
â”‚  â””â”€ é…é¢ç®¡ç†                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  åˆè§„æ€§                                     â”‚
â”‚  â”œâ”€ å¼ºåˆ¶å‘½åè§„èŒƒ                           â”‚
â”‚  â”œâ”€ è¦æ±‚ç‰¹å®šæ ‡ç­¾                           â”‚
â”‚  â”œâ”€ å®¡è®¡æ—¥å¿—                               â”‚
â”‚  â””â”€ æ•°æ®ä¿æŠ¤                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  è¿ç»´è‡ªåŠ¨åŒ–                                 â”‚
â”‚  â”œâ”€ è‡ªåŠ¨æ³¨å…¥Sidecar                        â”‚
â”‚  â”œâ”€ è‡ªåŠ¨é…ç½®ç½‘ç»œç­–ç•¥                       â”‚
â”‚  â”œâ”€ è‡ªåŠ¨æ·»åŠ ç›‘æ§é…ç½®                       â”‚
â”‚  â””â”€ è‡ªåŠ¨è®¾ç½®äº²å’Œæ€§                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æœ¬ç« å­¦ä¹ è·¯å¾„**ï¼š

```
14.1 å‡†å…¥æ§åˆ¶å™¨åŸç†
  â†“
14.2 Validating Webhook
  â†“
14.3 Mutating Webhook
  â†“
14.4 OPA (Open Policy Agent)
  â†“
14.5 Kyvernoç­–ç•¥å¼•æ“
  â†“
14.6 å®æˆ˜ï¼šå®æ–½ä¼ä¸šçº§ç­–ç•¥ç®¡ç†
```

---

## 14.1 å‡†å…¥æ§åˆ¶å™¨åŸç†

### 14.1.1 å‡†å…¥æ§åˆ¶å™¨æ¦‚è¿°

å‡†å…¥æ§åˆ¶å™¨ï¼ˆAdmission Controllerï¼‰æ˜¯Kubernetes API Serverçš„æ’ä»¶ï¼Œç”¨äºåœ¨å¯¹è±¡æŒä¹…åŒ–ä¹‹å‰æ‹¦æˆªAPIè¯·æ±‚ã€‚

**å‡†å…¥æ§åˆ¶å™¨çš„ç±»å‹**ï¼š

```
å‡†å…¥æ§åˆ¶å™¨åˆ†ç±»ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. å†…ç½®å‡†å…¥æ§åˆ¶å™¨ï¼ˆBuilt-inï¼‰              â”‚
â”‚     - KubernetesåŸç”Ÿæä¾›                   â”‚
â”‚     - ç¼–è¯‘åˆ°API Serverä¸­                   â”‚
â”‚     - é€šè¿‡--enable-admission-pluginså¯ç”¨   â”‚
â”‚     - ç¤ºä¾‹ï¼š                               â”‚
â”‚       * NamespaceLifecycle                 â”‚
â”‚       * LimitRanger                        â”‚
â”‚       * ServiceAccount                     â”‚
â”‚       * ResourceQuota                      â”‚
â”‚       * PodSecurityPolicy                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  2. åŠ¨æ€å‡†å…¥æ§åˆ¶å™¨ï¼ˆDynamicï¼‰               â”‚
â”‚     - é€šè¿‡Webhookå®ç°                      â”‚
â”‚     - å¯ä»¥ç‹¬ç«‹éƒ¨ç½²å’Œæ›´æ–°                   â”‚
â”‚     - åˆ†ä¸ºä¸¤ç±»ï¼š                           â”‚
â”‚       * Mutating Admission Webhook         â”‚
â”‚       * Validating Admission Webhook       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 14.1.2 å‡†å…¥æ§åˆ¶æµç¨‹

**å®Œæ•´çš„å‡†å…¥æ§åˆ¶æµç¨‹**ï¼š

```
APIè¯·æ±‚å¤„ç†æµç¨‹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. APIè¯·æ±‚åˆ°è¾¾                              â”‚
â”‚     POST /api/v1/namespaces/default/pods     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. è®¤è¯ï¼ˆAuthenticationï¼‰                   â”‚
â”‚     - å®¢æˆ·ç«¯è¯ä¹¦                             â”‚
â”‚     - Bearer Token                           â”‚
â”‚     - ServiceAccount                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. æˆæƒï¼ˆAuthorizationï¼‰                    â”‚
â”‚     - RBACæ£€æŸ¥                               â”‚
â”‚     - éªŒè¯ç”¨æˆ·æ˜¯å¦æœ‰æƒé™æ‰§è¡Œæ“ä½œ             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  4. Mutating Admissionï¼ˆå˜æ›´å‡†å…¥ï¼‰           â”‚
â”‚     æŒ‰é¡ºåºæ‰§è¡Œæ‰€æœ‰Mutating Webhookï¼š         â”‚
â”‚     â”œâ”€ Webhook 1: æ·»åŠ é»˜è®¤æ ‡ç­¾              â”‚
â”‚     â”œâ”€ Webhook 2: æ³¨å…¥Sidecarå®¹å™¨           â”‚
â”‚     â”œâ”€ Webhook 3: è®¾ç½®èµ„æºé™åˆ¶              â”‚
â”‚     â””â”€ Webhook 4: æ·»åŠ ç¯å¢ƒå˜é‡              â”‚
â”‚     æ³¨æ„ï¼šæ¯ä¸ªWebhookå¯ä»¥ä¿®æ”¹è¯·æ±‚å¯¹è±¡        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  5. SchemaéªŒè¯                               â”‚
â”‚     éªŒè¯å¯¹è±¡æ˜¯å¦ç¬¦åˆAPI Schema               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  6. Validating Admissionï¼ˆéªŒè¯å‡†å…¥ï¼‰         â”‚
â”‚     å¹¶è¡Œæ‰§è¡Œæ‰€æœ‰Validating Webhookï¼š         â”‚
â”‚     â”œâ”€ Webhook 1: éªŒè¯é•œåƒæ¥æº              â”‚
â”‚     â”œâ”€ Webhook 2: éªŒè¯èµ„æºé…é¢              â”‚
â”‚     â”œâ”€ Webhook 3: éªŒè¯å®‰å…¨ç­–ç•¥              â”‚
â”‚     â””â”€ Webhook 4: éªŒè¯å‘½åè§„èŒƒ              â”‚
â”‚     æ³¨æ„ï¼šä»»ä½•ä¸€ä¸ªWebhookæ‹’ç»åˆ™è¯·æ±‚å¤±è´¥      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  7. æŒä¹…åŒ–åˆ°etcd                             â”‚
â”‚     å¯¹è±¡åˆ›å»ºæˆåŠŸ                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Mutating vs Validating**ï¼š

| ç‰¹æ€§ | Mutating Admission | Validating Admission |
|------|-------------------|---------------------|
| **æ‰§è¡Œé¡ºåº** | å…ˆæ‰§è¡Œ | åæ‰§è¡Œ |
| **æ‰§è¡Œæ–¹å¼** | ä¸²è¡Œï¼ˆé¡ºåºæ‰§è¡Œï¼‰ | å¹¶è¡Œï¼ˆåŒæ—¶æ‰§è¡Œï¼‰ |
| **ä¸»è¦ä½œç”¨** | ä¿®æ”¹è¯·æ±‚å¯¹è±¡ | éªŒè¯è¯·æ±‚å¯¹è±¡ |
| **å…¸å‹ç”¨é€”** | æ³¨å…¥Sidecarã€è®¾ç½®é»˜è®¤å€¼ | ç­–ç•¥éªŒè¯ã€åˆè§„æ£€æŸ¥ |
| **å¤±è´¥å½±å“** | ç»§ç»­æ‰§è¡Œä¸‹ä¸€ä¸ª | ç«‹å³æ‹’ç»è¯·æ±‚ |
| **è¿”å›ç»“æœ** | ä¿®æ”¹åçš„å¯¹è±¡ | å…è®¸/æ‹’ç» |

### 14.1.3 å†…ç½®å‡†å…¥æ§åˆ¶å™¨

**å¸¸ç”¨çš„å†…ç½®å‡†å…¥æ§åˆ¶å™¨**ï¼š

```yaml
# æŸ¥çœ‹API Serverå¯ç”¨çš„å‡†å…¥æ§åˆ¶å™¨
kubectl exec -n kube-system kube-apiserver-master --   kube-apiserver -h | grep enable-admission-plugins
```

**1. NamespaceLifecycle**

é˜²æ­¢åœ¨ä¸å­˜åœ¨æˆ–æ­£åœ¨åˆ é™¤çš„Namespaceä¸­åˆ›å»ºèµ„æºã€‚

```bash
# ç¤ºä¾‹ï¼šå°è¯•åœ¨ä¸å­˜åœ¨çš„Namespaceåˆ›å»ºPod
kubectl run nginx --image=nginx -n non-existent-ns
# Error: namespaces "non-existent-ns" not found
```

**2. LimitRanger**

ä¸ºPodå’Œå®¹å™¨è®¾ç½®é»˜è®¤çš„èµ„æºè¯·æ±‚å’Œé™åˆ¶ã€‚

```yaml
# LimitRangeç¤ºä¾‹
apiVersion: v1
kind: LimitRange
metadata:
  name: mem-limit-range
  namespace: default
spec:
  limits:
  - default:  # é»˜è®¤é™åˆ¶
      memory: 512Mi
      cpu: 500m
    defaultRequest:  # é»˜è®¤è¯·æ±‚
      memory: 256Mi
      cpu: 250m
    type: Container
```

**3. ServiceAccount**

è‡ªåŠ¨ä¸ºPodæ³¨å…¥ServiceAccountã€‚

```yaml
# Podä¼šè‡ªåŠ¨æ³¨å…¥default ServiceAccount
apiVersion: v1
kind: Pod
metadata:
  name: my-pod
spec:
  containers:
  - name: nginx
    image: nginx
  # è‡ªåŠ¨æ·»åŠ ï¼š
  # serviceAccountName: default
  # volumes:
  # - name: kube-api-access-xxxxx
  #   projected:
  #     sources:
  #     - serviceAccountToken: ...
```

**4. ResourceQuota**

å¼ºåˆ¶æ‰§è¡ŒNamespaceçš„èµ„æºé…é¢ã€‚

```yaml
# ResourceQuotaç¤ºä¾‹
apiVersion: v1
kind: ResourceQuota
metadata:
  name: compute-quota
  namespace: default
spec:
  hard:
    requests.cpu: "10"
    requests.memory: 20Gi
    limits.cpu: "20"
    limits.memory: 40Gi
    pods: "50"
```

```bash
# è¶…è¿‡é…é¢æ—¶åˆ›å»ºPodä¼šå¤±è´¥
kubectl run nginx --image=nginx --requests=cpu=15
# Error: exceeded quota: compute-quota
```

**5. PodSecurityPolicyï¼ˆå·²å¼ƒç”¨ï¼Œä½¿ç”¨Pod Security Admissionæ›¿ä»£ï¼‰**

æ§åˆ¶Podçš„å®‰å…¨ç›¸å…³é…ç½®ã€‚

```yaml
# Pod Security Admissionï¼ˆPSAï¼‰
apiVersion: v1
kind: Namespace
metadata:
  name: my-namespace
  labels:
    pod-security.kubernetes.io/enforce: restricted
    pod-security.kubernetes.io/audit: restricted
    pod-security.kubernetes.io/warn: restricted
```

**6. NodeRestriction**

é™åˆ¶kubeletåªèƒ½ä¿®æ”¹è‡ªå·±èŠ‚ç‚¹ä¸Šçš„èµ„æºã€‚

```bash
# kubeletåªèƒ½ä¿®æ”¹è‡ªå·±èŠ‚ç‚¹çš„Nodeå¯¹è±¡å’ŒPod
# é˜²æ­¢æ¶æ„kubeletä¿®æ”¹å…¶ä»–èŠ‚ç‚¹çš„èµ„æº
```

**7. AlwaysPullImages**

å¼ºåˆ¶æ¯æ¬¡éƒ½æ‹‰å–é•œåƒï¼Œé˜²æ­¢ä½¿ç”¨æœ¬åœ°ç¼“å­˜çš„é•œåƒã€‚

```yaml
# å¯ç”¨åï¼Œæ‰€æœ‰Podçš„imagePullPolicyéƒ½ä¼šè¢«è®¾ç½®ä¸ºAlways
apiVersion: v1
kind: Pod
metadata:
  name: my-pod
spec:
  containers:
  - name: nginx
    image: nginx
    # è‡ªåŠ¨è®¾ç½®ï¼šimagePullPolicy: Always
```

### 14.1.4 é…ç½®å‡†å…¥æ§åˆ¶å™¨

**æŸ¥çœ‹å½“å‰å¯ç”¨çš„å‡†å…¥æ§åˆ¶å™¨**ï¼š

```bash
# æ–¹æ³•1ï¼šæŸ¥çœ‹API Serveré…ç½®
kubectl get pod -n kube-system kube-apiserver-master -o yaml | grep admission

# æ–¹æ³•2ï¼šæŸ¥çœ‹API Serverè¿›ç¨‹å‚æ•°
ps aux | grep kube-apiserver | grep admission-plugins

# æ–¹æ³•3ï¼šæŸ¥çœ‹API Server manifest
cat /etc/kubernetes/manifests/kube-apiserver.yaml | grep admission
```

**å¯ç”¨/ç¦ç”¨å‡†å…¥æ§åˆ¶å™¨**ï¼š

```yaml
# /etc/kubernetes/manifests/kube-apiserver.yaml
apiVersion: v1
kind: Pod
metadata:
  name: kube-apiserver
  namespace: kube-system
spec:
  containers:
  - command:
    - kube-apiserver
    # å¯ç”¨å‡†å…¥æ§åˆ¶å™¨
    - --enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,MutatingAdmissionWebhook,ValidatingAdmissionWebhook,ResourceQuota,PodSecurity
    # ç¦ç”¨å‡†å…¥æ§åˆ¶å™¨
    - --disable-admission-plugins=AlwaysPullImages
    # ... å…¶ä»–å‚æ•°
```

**æ¨èçš„å‡†å…¥æ§åˆ¶å™¨é…ç½®**ï¼š

```bash
# ç”Ÿäº§ç¯å¢ƒæ¨èé…ç½®
--enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,MutatingAdmissionWebhook,ValidatingAdmissionWebhook,ResourceQuota,PodSecurity,NodeRestriction,Priority,StorageObjectInUseProtection,PersistentVolumeClaimResize
```

### 14.1.5 å‡†å…¥æ§åˆ¶å™¨æœ€ä½³å®è·µ

**1. å®‰å…¨ç›¸å…³**

```yaml
# âœ… æ¨èå¯ç”¨çš„å®‰å…¨å‡†å…¥æ§åˆ¶å™¨
- PodSecurity              # Podå®‰å…¨æ ‡å‡†
- NodeRestriction          # é™åˆ¶kubeletæƒé™
- ServiceAccount           # è‡ªåŠ¨æ³¨å…¥ServiceAccount
- AlwaysPullImages         # å¼ºåˆ¶æ‹‰å–é•œåƒï¼ˆå¯é€‰ï¼‰

# âœ… ä½¿ç”¨Webhookå®æ–½è‡ªå®šä¹‰å®‰å…¨ç­–ç•¥
- éªŒè¯é•œåƒç­¾å
- ç¦æ­¢ç‰¹æƒå®¹å™¨
- å¼ºåˆ¶ä½¿ç”¨érootç”¨æˆ·
- é™åˆ¶hostPathä½¿ç”¨
```

**2. èµ„æºç®¡ç†**

```yaml
# âœ… æ¨èå¯ç”¨çš„èµ„æºç®¡ç†å‡†å…¥æ§åˆ¶å™¨
- LimitRanger              # è®¾ç½®é»˜è®¤èµ„æºé™åˆ¶
- ResourceQuota            # å¼ºåˆ¶èµ„æºé…é¢
- PersistentVolumeClaimResize  # å…è®¸PVCæ‰©å®¹

# âœ… ä½¿ç”¨Webhookå®æ–½è‡ªå®šä¹‰èµ„æºç­–ç•¥
- è‡ªåŠ¨è®¾ç½®èµ„æºè¯·æ±‚å’Œé™åˆ¶
- éªŒè¯èµ„æºé…ç½®åˆç†æ€§
- é˜²æ­¢èµ„æºè¿‡åº¦åˆ†é…
```

**3. è¿ç»´è‡ªåŠ¨åŒ–**

```yaml
# âœ… ä½¿ç”¨Mutating Webhookè‡ªåŠ¨åŒ–è¿ç»´ä»»åŠ¡
- è‡ªåŠ¨æ³¨å…¥Sidecarå®¹å™¨ï¼ˆå¦‚Istioã€Linkerdï¼‰
- è‡ªåŠ¨æ·»åŠ æ ‡ç­¾å’Œæ³¨è§£
- è‡ªåŠ¨é…ç½®ç¯å¢ƒå˜é‡
- è‡ªåŠ¨è®¾ç½®äº²å’Œæ€§å’Œå®¹å¿åº¦
```

**4. åˆè§„æ€§**

```yaml
# âœ… ä½¿ç”¨Validating Webhookå®æ–½åˆè§„ç­–ç•¥
- å¼ºåˆ¶å‘½åè§„èŒƒ
- è¦æ±‚ç‰¹å®šæ ‡ç­¾
- éªŒè¯é•œåƒæ¥æº
- å®¡è®¡æ—¥å¿—è®°å½•
```

### 14.1.6 å‡†å…¥æ§åˆ¶å™¨è°ƒè¯•

**1. æŸ¥çœ‹å‡†å…¥æ§åˆ¶å™¨æ—¥å¿—**

```bash
# æŸ¥çœ‹API Serveræ—¥å¿—
kubectl logs -n kube-system kube-apiserver-master | grep admission

# æŸ¥çœ‹Webhookæ—¥å¿—
kubectl logs -n webhook-system webhook-server-xxx
```

**2. æµ‹è¯•å‡†å…¥æ§åˆ¶å™¨**

```bash
# ä½¿ç”¨--dry-runæµ‹è¯•
kubectl apply -f pod.yaml --dry-run=server

# æŸ¥çœ‹è¯¦ç»†é”™è¯¯ä¿¡æ¯
kubectl apply -f pod.yaml -v=8
```

**3. è°ƒè¯•Webhook**

```yaml
# åœ¨Webhooké…ç½®ä¸­å¯ç”¨è¯¦ç»†æ—¥å¿—
apiVersion: admissionregistration.k8s.io/v1
kind: ValidatingWebhookConfiguration
metadata:
  name: my-webhook
webhooks:
- name: my-webhook.example.com
  # å¤±è´¥ç­–ç•¥ï¼šIgnoreè¡¨ç¤ºWebhookå¤±è´¥æ—¶å…è®¸è¯·æ±‚é€šè¿‡
  failurePolicy: Ignore  # è°ƒè¯•æ—¶ä½¿ç”¨ï¼Œç”Ÿäº§ç¯å¢ƒä½¿ç”¨Fail
  # è¶…æ—¶æ—¶é—´
  timeoutSeconds: 10
  # ... å…¶ä»–é…ç½®
```

**4. å¸¸è§é—®é¢˜æ’æŸ¥**

```bash
# é—®é¢˜1ï¼šWebhookè¶…æ—¶
# æ£€æŸ¥WebhookæœåŠ¡æ˜¯å¦æ­£å¸¸
kubectl get svc -n webhook-system
kubectl get endpoints -n webhook-system

# é—®é¢˜2ï¼šè¯ä¹¦é”™è¯¯
# æ£€æŸ¥Webhookè¯ä¹¦
kubectl get validatingwebhookconfiguration my-webhook -o yaml | grep caBundle

# é—®é¢˜3ï¼šè¯·æ±‚è¢«æ‹’ç»
# æŸ¥çœ‹æ‹’ç»åŸå› 
kubectl describe pod my-pod | grep -A 10 Events
```

### 14.1.7 å‡†å…¥æ§åˆ¶å™¨æ€§èƒ½è€ƒè™‘

**æ€§èƒ½å½±å“å› ç´ **ï¼š

```
å‡†å…¥æ§åˆ¶å™¨æ€§èƒ½å½±å“ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. Webhookæ•°é‡                            â”‚
â”‚     - æ¯ä¸ªWebhookå¢åŠ å»¶è¿Ÿ                  â”‚
â”‚     - å»ºè®®ï¼šåˆå¹¶ç›¸å…³Webhook                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  2. Webhookå“åº”æ—¶é—´                        â”‚
â”‚     - ç½‘ç»œå»¶è¿Ÿ                             â”‚
â”‚     - å¤„ç†æ—¶é—´                             â”‚
â”‚     - å»ºè®®ï¼šä¼˜åŒ–Webhooké€»è¾‘ï¼Œè®¾ç½®è¶…æ—¶      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  3. å¤±è´¥ç­–ç•¥                               â”‚
â”‚     - Failï¼šWebhookå¤±è´¥åˆ™è¯·æ±‚å¤±è´¥          â”‚
â”‚     - Ignoreï¼šWebhookå¤±è´¥åˆ™è¯·æ±‚é€šè¿‡        â”‚
â”‚     - å»ºè®®ï¼šç”Ÿäº§ç¯å¢ƒä½¿ç”¨Fail               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  4. å¯¹è±¡å¤§å°                               â”‚
â”‚     - å¤§å¯¹è±¡å¢åŠ åºåˆ—åŒ–/ååºåˆ—åŒ–æ—¶é—´        â”‚
â”‚     - å»ºè®®ï¼šé¿å…åœ¨Webhookä¸­å¤„ç†å¤§å¯¹è±¡      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ€§èƒ½ä¼˜åŒ–å»ºè®®**ï¼š

```yaml
# 1. è®¾ç½®åˆç†çš„è¶…æ—¶æ—¶é—´
timeoutSeconds: 5  # é»˜è®¤10ç§’ï¼Œå¯ä»¥æ ¹æ®å®é™…æƒ…å†µè°ƒæ•´

# 2. ä½¿ç”¨objectSelectorå‡å°‘Webhookè°ƒç”¨
objectSelector:
  matchLabels:
    webhook: enabled

# 3. ä½¿ç”¨namespaceSelectoré™åˆ¶ä½œç”¨èŒƒå›´
namespaceSelector:
  matchExpressions:
  - key: environment
    operator: In
    values: ["production"]

# 4. é…ç½®åˆç†çš„å¤±è´¥ç­–ç•¥
failurePolicy: Fail  # ç”Ÿäº§ç¯å¢ƒ
# failurePolicy: Ignore  # å¼€å‘ç¯å¢ƒ

# 5. ä½¿ç”¨sideEffectså£°æ˜å‰¯ä½œç”¨
sideEffects: None  # è¡¨ç¤ºWebhookæ²¡æœ‰å‰¯ä½œç”¨ï¼Œå¯ä»¥å®‰å…¨åœ°å¹¶è¡Œè°ƒç”¨
```

---

**å½“å‰ç¬¬14ç« è¿›åº¦**ï¼š
- âœ… 14.1 å‡†å…¥æ§åˆ¶å™¨åŸç†ï¼ˆå®Œæˆï¼‰
- â³ 14.2 Validating Webhookï¼ˆå¾…ç¼–å†™ï¼‰
- ğŸ“… 14.3 Mutating Webhookï¼ˆå¾…ç¼–å†™ï¼‰
- ğŸ“… 14.4 OPA (Open Policy Agent)ï¼ˆå¾…ç¼–å†™ï¼‰
- ğŸ“… 14.5 Kyvernoç­–ç•¥å¼•æ“ï¼ˆå¾…ç¼–å†™ï¼‰
- ğŸ“… 14.6 å®æˆ˜ï¼šå®æ–½ä¼ä¸šçº§ç­–ç•¥ç®¡ç†ï¼ˆå¾…ç¼–å†™ï¼‰

æ¥ä¸‹æ¥å°†ç»§ç»­ç¼–å†™14.2èŠ‚çš„å†…å®¹ã€‚
