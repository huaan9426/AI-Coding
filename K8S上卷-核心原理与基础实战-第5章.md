# ç¬¬5ç« : å­˜å‚¨ç®¡ç† - æ•°æ®æŒä¹…åŒ–ä¸é…ç½®ç®¡ç†

åœ¨å‰é¢çš„ç« èŠ‚ä¸­ï¼Œæˆ‘ä»¬å­¦ä¹ äº†Podã€å·¥ä½œè´Ÿè½½æ§åˆ¶å™¨ã€Serviceå’ŒIngressï¼Œè¿™äº›çŸ¥è¯†è®©æˆ‘ä»¬èƒ½å¤Ÿéƒ¨ç½²å’Œè®¿é—®åº”ç”¨ã€‚ä½†åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œæˆ‘ä»¬è¿˜é¢ä¸´ä¸€ä¸ªå…³é”®é—®é¢˜ï¼š**åº”ç”¨äº§ç”Ÿçš„æ•°æ®å¦‚ä½•æŒä¹…åŒ–ï¼Ÿé…ç½®å’Œå¯†é’¥å¦‚ä½•å®‰å…¨ç®¡ç†ï¼Ÿ**

è€ƒè™‘ä»¥ä¸‹å®é™…åœºæ™¯ï¼š

1. **å®¹å™¨é‡å¯æ•°æ®ä¸¢å¤±**ï¼šPodä¸­çš„å®¹å™¨é»˜è®¤ä½¿ç”¨ä¸´æ—¶å­˜å‚¨ï¼Œé‡å¯åæ•°æ®å…¨éƒ¨ä¸¢å¤±
2. **æ•°æ®åº“æŒä¹…åŒ–éœ€æ±‚**ï¼šMySQLã€PostgreSQLç­‰æ•°æ®åº“éœ€è¦å¯é çš„æŒä¹…åŒ–å­˜å‚¨
3. **é…ç½®æ–‡ä»¶ç®¡ç†**ï¼šåº”ç”¨é…ç½®ä¸åº”ç¡¬ç¼–ç åœ¨é•œåƒä¸­ï¼Œéœ€è¦åŠ¨æ€æ³¨å…¥
4. **å¯†é’¥å®‰å…¨å­˜å‚¨**ï¼šæ•°æ®åº“å¯†ç ã€APIå¯†é’¥ç­‰æ•æ„Ÿä¿¡æ¯éœ€è¦åŠ å¯†ç®¡ç†
5. **å¤šå®¹å™¨æ•°æ®å…±äº«**ï¼šåŒä¸€Podå†…çš„å¤šä¸ªå®¹å™¨å¦‚ä½•å…±äº«æ•°æ®ï¼Ÿ
6. **è·¨èŠ‚ç‚¹æ•°æ®è¿ç§»**ï¼šPodè¿ç§»åˆ°å…¶ä»–èŠ‚ç‚¹åå¦‚ä½•è®¿é—®åŸæœ‰æ•°æ®ï¼Ÿ

è¿™å°±æ˜¯æœ¬ç« è¦è§£å†³çš„æ ¸å¿ƒé—®é¢˜ã€‚Kubernetesæä¾›äº†å®Œæ•´çš„å­˜å‚¨æŠ½è±¡ä½“ç³»ï¼š

- **Volumeï¼ˆå·ï¼‰**ï¼šå®¹å™¨æ•°æ®çš„æŒ‚è½½ç‚¹ï¼Œç”Ÿå‘½å‘¨æœŸä¸Podç»‘å®š
- **PersistentVolumeï¼ˆPVï¼‰**ï¼šé›†ç¾¤çº§çš„æŒä¹…åŒ–å­˜å‚¨èµ„æº
- **PersistentVolumeClaimï¼ˆPVCï¼‰**ï¼šç”¨æˆ·å¯¹å­˜å‚¨èµ„æºçš„ç”³è¯·
- **StorageClass**ï¼šåŠ¨æ€ä¾›ç»™å­˜å‚¨çš„æ¨¡æ¿
- **ConfigMap**ï¼šéæ•æ„Ÿé…ç½®æ•°æ®çš„ç®¡ç†
- **Secret**ï¼šæ•æ„Ÿä¿¡æ¯çš„åŠ å¯†å­˜å‚¨

## æœ¬ç« å­¦ä¹ ç›®æ ‡

é€šè¿‡æœ¬ç« å­¦ä¹ ï¼Œä½ å°†æŒæ¡ï¼š

âœ… **å­˜å‚¨åŸºç¡€æ¦‚å¿µ**ï¼šç†è§£å®¹å™¨å­˜å‚¨çš„æŒ‘æˆ˜å’ŒKubernetesçš„è§£å†³æ–¹æ¡ˆ
âœ… **Volumeå·ç±»å‹**ï¼šæŒæ¡emptyDirã€hostPathã€ConfigMapã€Secretç­‰å¸¸ç”¨å·ç±»å‹
âœ… **PVå’ŒPVCæœºåˆ¶**ï¼šç†è§£é™æ€ä¾›ç»™å’ŒåŠ¨æ€ä¾›ç»™çš„å·¥ä½œåŸç†
âœ… **StorageClass**ï¼šé…ç½®NFSã€Cephç­‰åŠ¨æ€å­˜å‚¨ä¾›ç»™
âœ… **ConfigMapç®¡ç†**ï¼šå®ç°é…ç½®ä¸ä»£ç åˆ†ç¦»ã€é…ç½®çƒ­æ›´æ–°
âœ… **Secretç®¡ç†**ï¼šå®‰å…¨å­˜å‚¨å¯†ç ã€è¯ä¹¦ç­‰æ•æ„Ÿä¿¡æ¯
âœ… **æœ‰çŠ¶æ€åº”ç”¨éƒ¨ç½²**ï¼šéƒ¨ç½²MySQLã€Redisç­‰éœ€è¦æŒä¹…åŒ–çš„åº”ç”¨
âœ… **ç”Ÿäº§æœ€ä½³å®è·µ**ï¼šå­˜å‚¨æ€§èƒ½ä¼˜åŒ–ã€å¤‡ä»½æ¢å¤ã€å®¹é‡è§„åˆ’

## æœ¬ç« å†…å®¹æ¦‚è§ˆ

```
ç¬¬5ç« : å­˜å‚¨ç®¡ç†
â”œâ”€â”€ 5.1 å­˜å‚¨åŸºç¡€æ¦‚å¿µ
â”‚   â”œâ”€â”€ å®¹å™¨å­˜å‚¨çš„æŒ‘æˆ˜
â”‚   â”œâ”€â”€ Kuberneteså­˜å‚¨æ¶æ„
â”‚   â”œâ”€â”€ å­˜å‚¨ç±»å‹åˆ†ç±»
â”‚   â””â”€â”€ å­˜å‚¨ç”Ÿå‘½å‘¨æœŸ

â”œâ”€â”€ 5.2 Volumeå·ç±»å‹è¯¦è§£
â”‚   â”œâ”€â”€ emptyDirï¼ˆä¸´æ—¶å­˜å‚¨ï¼‰
â”‚   â”œâ”€â”€ hostPathï¼ˆèŠ‚ç‚¹æœ¬åœ°å­˜å‚¨ï¼‰
â”‚   â”œâ”€â”€ ConfigMapï¼ˆé…ç½®æ–‡ä»¶ï¼‰
â”‚   â”œâ”€â”€ Secretï¼ˆå¯†é’¥ï¼‰
â”‚   â”œâ”€â”€ downwardAPIï¼ˆPodå…ƒæ•°æ®ï¼‰
â”‚   â””â”€â”€ projectedï¼ˆç»„åˆå·ï¼‰

â”œâ”€â”€ 5.3 PersistentVolumeå’ŒPersistentVolumeClaim
â”‚   â”œâ”€â”€ PVèµ„æºå¯¹è±¡
â”‚   â”œâ”€â”€ PVCèµ„æºå¯¹è±¡
â”‚   â”œâ”€â”€ ç»‘å®šæœºåˆ¶
â”‚   â”œâ”€â”€ è®¿é—®æ¨¡å¼ï¼ˆRWO/ROX/RWXï¼‰
â”‚   â”œâ”€â”€ å›æ”¶ç­–ç•¥ï¼ˆRetain/Recycle/Deleteï¼‰
â”‚   â””â”€â”€ é™æ€ä¾›ç»™å®æˆ˜

â”œâ”€â”€ 5.4 StorageClassåŠ¨æ€ä¾›ç»™
â”‚   â”œâ”€â”€ StorageClasså·¥ä½œåŸç†
â”‚   â”œâ”€â”€ NFSåŠ¨æ€ä¾›ç»™
â”‚   â”œâ”€â”€ äº‘å­˜å‚¨é›†æˆï¼ˆAWS EBS/Azure Diskï¼‰
â”‚   â”œâ”€â”€ é»˜è®¤StorageClass
â”‚   â””â”€â”€ Volumeæ‰©å®¹

â”œâ”€â”€ 5.5 ConfigMapå’ŒSecretæ·±åº¦è§£æ
â”‚   â”œâ”€â”€ ConfigMapåˆ›å»ºæ–¹å¼
â”‚   â”œâ”€â”€ ConfigMapä½¿ç”¨æ–¹å¼ï¼ˆç¯å¢ƒå˜é‡/Volumeï¼‰
â”‚   â”œâ”€â”€ ConfigMapçƒ­æ›´æ–°
â”‚   â”œâ”€â”€ Secretç±»å‹ï¼ˆOpaque/TLS/DockerRegistryï¼‰
â”‚   â”œâ”€â”€ Secretä½¿ç”¨æ–¹å¼
â”‚   â””â”€â”€ SecretåŠ å¯†å­˜å‚¨

â”œâ”€â”€ 5.6 å®æˆ˜é¡¹ç›®ï¼šå®Œæ•´çš„æ•°æ®æŒä¹…åŒ–æ–¹æ¡ˆ
â”‚   â”œâ”€â”€ éƒ¨ç½²NFS Server
â”‚   â”œâ”€â”€ é…ç½®NFS StorageClass
â”‚   â”œâ”€â”€ éƒ¨ç½²MySQLä½¿ç”¨æŒä¹…åŒ–å­˜å‚¨
â”‚   â”œâ”€â”€ éƒ¨ç½²Redis Clusterï¼ˆStatefulSet + PVCï¼‰
â”‚   â”œâ”€â”€ ConfigMapç®¡ç†åº”ç”¨é…ç½®
â”‚   â”œâ”€â”€ Secretç®¡ç†æ•°æ®åº“å¯†ç 
â”‚   â””â”€â”€ å¤‡ä»½å’Œæ¢å¤éªŒè¯

â””â”€â”€ 5.7 æœ¬ç« å°ç»“
    â”œâ”€â”€ æ ¸å¿ƒçŸ¥è¯†ç‚¹å›é¡¾
    â”œâ”€â”€ å­˜å‚¨ç±»å‹é€‰æ‹©æŒ‡å—
    â”œâ”€â”€ ç”Ÿäº§æœ€ä½³å®è·µ
    â”œâ”€â”€ å¸¸ç”¨å‘½ä»¤é€ŸæŸ¥
    â”œâ”€â”€ æ•…éšœæ’æŸ¥æ¸…å•
    â””â”€â”€ ç¬¬6ç« é¢„å‘Š
```

## ç« èŠ‚å¼•è¨€

åœ¨å¾®æœåŠ¡æ¶æ„ä¸­ï¼Œå­˜å‚¨æ˜¯æœ€å®¹æ˜“è¢«å¿½è§†ä½†åˆè‡³å…³é‡è¦çš„ä¸€ç¯ã€‚ä¼ ç»Ÿè™šæ‹Ÿæœºæ—¶ä»£ï¼Œæˆ‘ä»¬ä¹ æƒ¯äºå°†æ•°æ®ç›´æ¥å­˜å‚¨åœ¨è™šæ‹Ÿæœºçš„ç£ç›˜ä¸Šï¼Œé‡å¯åæ•°æ®ä¾ç„¶å­˜åœ¨ã€‚ä½†å®¹å™¨æ˜¯ä¸ºæ— çŠ¶æ€åº”ç”¨è®¾è®¡çš„ï¼Œé»˜è®¤æƒ…å†µä¸‹å®¹å™¨é‡å¯åæ‰€æœ‰æ•°æ®éƒ½ä¼šä¸¢å¤±ã€‚

Kubernetesé€šè¿‡Volumeã€PV/PVCã€StorageClassç­‰æŠ½è±¡å±‚ï¼Œä¼˜é›…åœ°è§£å†³äº†è¿™ä¸€é—®é¢˜ï¼š

**Volumeè§£å†³çš„æ˜¯"ä¸´æ—¶æ•°æ®å…±äº«"çš„é—®é¢˜**ï¼š
- æä¾›å®¹å™¨çš„æ•°æ®æŒ‚è½½ç‚¹
- ç”Ÿå‘½å‘¨æœŸä¸Podç»‘å®šï¼ˆPodåˆ é™¤ï¼ŒVolumeä¹Ÿåˆ é™¤ï¼‰
- æ”¯æŒå¤šç§åç«¯å­˜å‚¨ï¼ˆæœ¬åœ°ç£ç›˜ã€ç½‘ç»œå­˜å‚¨ã€äº‘å­˜å‚¨ï¼‰

**PV/PVCè§£å†³çš„æ˜¯"æŒä¹…åŒ–æ•°æ®ç®¡ç†"çš„é—®é¢˜**ï¼š
- PVæ˜¯é›†ç¾¤çº§çš„å­˜å‚¨èµ„æºï¼ˆç±»ä¼¼Nodeï¼‰
- PVCæ˜¯ç”¨æˆ·å¯¹å­˜å‚¨çš„ç”³è¯·ï¼ˆç±»ä¼¼Podï¼‰
- æ•°æ®ç‹¬ç«‹äºPodç”Ÿå‘½å‘¨æœŸï¼ˆPodåˆ é™¤ï¼Œæ•°æ®ä¾ç„¶å­˜åœ¨ï¼‰

**StorageClassè§£å†³çš„æ˜¯"è‡ªåŠ¨åŒ–ä¾›ç»™"çš„é—®é¢˜**ï¼š
- ç”¨æˆ·æ— éœ€æ‰‹åŠ¨åˆ›å»ºPV
- å£°æ˜PVCæ—¶è‡ªåŠ¨åˆ›å»ºå¯¹åº”çš„PV
- æ”¯æŒåŠ¨æ€å‚æ•°é…ç½®ï¼ˆå¤§å°ã€æ€§èƒ½ç­‰çº§ï¼‰

**ConfigMap/Secretè§£å†³çš„æ˜¯"é…ç½®ç®¡ç†"çš„é—®é¢˜**ï¼š
- é…ç½®ä¸ä»£ç åˆ†ç¦»ï¼ˆ12-FactoråŸåˆ™ï¼‰
- æ•æ„Ÿä¿¡æ¯åŠ å¯†å­˜å‚¨
- æ”¯æŒé…ç½®çƒ­æ›´æ–°ï¼ˆæ— éœ€é‡å¯Podï¼‰

è®©æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªç®€å•ç¤ºä¾‹ç›´è§‚ç†è§£å®ƒä»¬çš„å…³ç³»ï¼š

```
ä¼ ç»Ÿæ–¹å¼ï¼ˆç¡¬ç¼–ç ï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   åº”ç”¨é•œåƒ      â”‚
â”‚  - åº”ç”¨ä»£ç      â”‚
â”‚  - é…ç½®æ–‡ä»¶     â”‚  â† âŒ é…ç½®ç¡¬ç¼–ç åœ¨é•œåƒä¸­
â”‚  - æ•°æ®åº“å¯†ç    â”‚  â† âŒ å¯†ç æš´éœ²åœ¨é•œåƒä¸­
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â–¼
   [å®¹å™¨é‡å¯]
       â–¼
   æ•°æ®å…¨éƒ¨ä¸¢å¤±  â† âŒ æ— æ³•æŒä¹…åŒ–


Kubernetesæ–¹å¼ï¼ˆè§£è€¦ï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   åº”ç”¨é•œåƒ      â”‚
â”‚  - åº”ç”¨ä»£ç      â”‚  â† âœ… é•œåƒåªåŒ…å«ä»£ç 
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â–¼
   [Podè¿è¡Œ]
       â”‚
       â”œâ”€> [ConfigMap]     â† âœ… é…ç½®å¤–éƒ¨ç®¡ç†
       â”œâ”€> [Secret]        â† âœ… å¯†ç åŠ å¯†å­˜å‚¨
       â””â”€> [PVC â†’ PV]      â† âœ… æ•°æ®æŒä¹…åŒ–
                â–¼
           [ç½‘ç»œå­˜å‚¨/äº‘å­˜å‚¨]
                â–¼
          æ•°æ®æ°¸ä¹…ä¿å­˜  â† âœ… Podåˆ é™¤æ•°æ®ä¾ç„¶å­˜åœ¨
```

æ¥ä¸‹æ¥ï¼Œè®©æˆ‘ä»¬æ·±å…¥å­¦ä¹ Kubernetesçš„å­˜å‚¨ä½“ç³»ï¼ŒæŒæ¡ç”Ÿäº§ç¯å¢ƒä¸­çš„æ•°æ®æŒä¹…åŒ–å’Œé…ç½®ç®¡ç†æŠ€èƒ½ï¼

---


## 5.1 å­˜å‚¨åŸºç¡€æ¦‚å¿µ

### 5.1.1 å®¹å™¨å­˜å‚¨çš„æŒ‘æˆ˜

**é—®é¢˜1ï¼šå®¹å™¨æ–‡ä»¶ç³»ç»Ÿæ˜¯ä¸´æ—¶çš„**

å®¹å™¨ä½¿ç”¨Union FSï¼ˆè”åˆæ–‡ä»¶ç³»ç»Ÿï¼‰ï¼Œæ¯ä¸ªå®¹å™¨éƒ½æœ‰è‡ªå·±çš„å¯å†™å±‚ã€‚å½“å®¹å™¨é‡å¯æ—¶ï¼Œå¯å†™å±‚çš„æ‰€æœ‰æ•°æ®éƒ½ä¼šä¸¢å¤±ã€‚

```
å®¹å™¨æ–‡ä»¶ç³»ç»Ÿç»“æ„ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å®¹å™¨å¯å†™å±‚ (ä¸´æ—¶)        â”‚  â† å®¹å™¨å†™å…¥çš„æ•°æ®å­˜å‚¨åœ¨è¿™é‡Œ
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     å®¹å™¨åˆ é™¤/é‡å¯åæ•°æ®ä¸¢å¤±
â”‚  é•œåƒå±‚4 (åªè¯»)           â”‚
â”‚  é•œåƒå±‚3 (åªè¯»)           â”‚
â”‚  é•œåƒå±‚2 (åªè¯»)           â”‚  â† é•œåƒå±‚ä¸å¯ä¿®æ”¹
â”‚  é•œåƒå±‚1 (åªè¯»)           â”‚     æ‰€æœ‰å®¹å™¨å…±äº«
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç¤ºä¾‹ï¼š
$ docker run -it ubuntu bash
# echo "test data" > /tmp/data.txt
# cat /tmp/data.txt
test data

# exit  â† å®¹å™¨é€€å‡º
$ docker run -it ubuntu bash
# cat /tmp/data.txt
cat: /tmp/data.txt: No such file or directory  â† æ•°æ®ä¸¢å¤±ï¼
```

**é—®é¢˜2ï¼šåŒä¸€Podå†…çš„å¤šä¸ªå®¹å™¨éœ€è¦å…±äº«æ•°æ®**

```
åœºæ™¯ï¼šåº”ç”¨å®¹å™¨ + Sidecaræ—¥å¿—æ”¶é›†å®¹å™¨

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Pod                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ App Containerâ”‚  â”‚ Sidecar  â”‚ â”‚
â”‚  â”‚  å†™æ—¥å¿—       â”‚  â”‚ è¯»æ—¥å¿—    â”‚ â”‚
â”‚  â”‚  â†“           â”‚  â”‚  â†‘       â”‚ â”‚
â”‚  â”‚ /var/log/    â”‚  â”‚ /var/log/â”‚ â”‚  â† å¦‚ä½•å…±äº«/var/logç›®å½•ï¼Ÿ
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**é—®é¢˜3ï¼šPodé‡æ–°è°ƒåº¦åéœ€è¦è®¿é—®åŸæœ‰æ•°æ®**

```
åœºæ™¯ï¼šMySQL Podä»Node1è¿ç§»åˆ°Node2

Node1                         Node2
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  MySQL Pod   â”‚   è¿ç§»      â”‚  MySQL Pod   â”‚
â”‚  æ•°æ®åœ¨æœ¬åœ°  â”‚   â”€â”€â”€>     â”‚  å¦‚ä½•è®¿é—®     â”‚
â”‚  /var/lib/   â”‚             â”‚  åŸæœ‰æ•°æ®ï¼Ÿ   â”‚
â”‚  mysql       â”‚             â”‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â–¼                            â–¼
   [æœ¬åœ°ç£ç›˜]                  [æœ¬åœ°ç£ç›˜æ˜¯ç©ºçš„]

è§£å†³æ–¹æ¡ˆï¼šä½¿ç”¨ç½‘ç»œå­˜å‚¨ï¼ˆNFSã€Cephç­‰ï¼‰
```

### 5.1.2 Kuberneteså­˜å‚¨æ¶æ„

Kubernetesé‡‡ç”¨åˆ†å±‚çš„å­˜å‚¨æ¶æ„ï¼Œå°†å­˜å‚¨æŠ½è±¡ä¸ºå¤šä¸ªå±‚æ¬¡ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     åº”ç”¨å±‚                                   â”‚
â”‚               [Podä½¿ç”¨Volume]                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   å­˜å‚¨å£°æ˜å±‚                                 â”‚
â”‚          [PVC - PersistentVolumeClaim]                     â”‚
â”‚          ç”¨æˆ·å£°æ˜ï¼šæˆ‘éœ€è¦10GBå­˜å‚¨ï¼Œæ€§èƒ½è¦æ±‚SSD               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   å­˜å‚¨ä¾›ç»™å±‚                                 â”‚
â”‚     [StorageClass + Provisioner]                           â”‚
â”‚     è‡ªåŠ¨åˆ›å»ºPVï¼Œæ”¯æŒåŠ¨æ€å‚æ•°                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   å­˜å‚¨èµ„æºå±‚                                 â”‚
â”‚           [PV - PersistentVolume]                          â”‚
â”‚           é›†ç¾¤ç®¡ç†å‘˜é¢„å…ˆåˆ›å»ºæˆ–è‡ªåŠ¨åˆ›å»ºçš„å­˜å‚¨èµ„æº               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   ç‰©ç†å­˜å‚¨å±‚                                 â”‚
â”‚     [NFS/Ceph/iSCSI/äº‘å­˜å‚¨(AWS EBS/Azure Disk)]            â”‚
â”‚     å®é™…çš„å­˜å‚¨è®¾å¤‡                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å·¥ä½œæµç¨‹ç¤ºä¾‹ï¼š**

```
1. ç”¨æˆ·åˆ›å»ºPVCï¼š
   apiVersion: v1
   kind: PersistentVolumeClaim
   metadata:
     name: mysql-pvc
   spec:
     storageClassName: nfs-storage
     accessModes:
     - ReadWriteOnce
     resources:
       requests:
         storage: 10Gi

2. StorageClassè‡ªåŠ¨åˆ›å»ºPVï¼š
   apiVersion: v1
   kind: PersistentVolume
   metadata:
     name: pvc-abc123-auto-generated
   spec:
     capacity:
       storage: 10Gi
     accessModes:
     - ReadWriteOnce
     nfs:
       server: 192.168.1.100
       path: /data/mysql-pvc-abc123

3. PVCç»‘å®šåˆ°PVï¼š
   STATUS: Bound

4. Podä½¿ç”¨PVCï¼š
   apiVersion: v1
   kind: Pod
   spec:
     volumes:
     - name: mysql-data
       persistentVolumeClaim:
         claimName: mysql-pvc
     containers:
     - name: mysql
       volumeMounts:
       - name: mysql-data
         mountPath: /var/lib/mysql
```

### 5.1.3 å­˜å‚¨ç±»å‹åˆ†ç±»

Kubernetesæ”¯æŒå¤šç§å­˜å‚¨ç±»å‹ï¼Œå¯ä»¥æŒ‰ç”Ÿå‘½å‘¨æœŸå’Œç”¨é€”åˆ†ç±»ï¼š

**æŒ‰ç”Ÿå‘½å‘¨æœŸåˆ†ç±»ï¼š**

| ç±»å‹ | ç”Ÿå‘½å‘¨æœŸ | é€‚ç”¨åœºæ™¯ | ç¤ºä¾‹ |
|-----|---------|---------|------|
| **ä¸´æ—¶å­˜å‚¨** | ä¸Podç»‘å®š | ç¼“å­˜ã€ä¸´æ—¶æ–‡ä»¶ | emptyDir |
| **èŠ‚ç‚¹å­˜å‚¨** | ä¸Nodeç»‘å®š | æ—¥å¿—ã€é…ç½® | hostPath |
| **æŒä¹…åŒ–å­˜å‚¨** | ç‹¬ç«‹äºPodå’ŒNode | æ•°æ®åº“ã€ç”¨æˆ·æ–‡ä»¶ | PV/PVC |

**æŒ‰ç”¨é€”åˆ†ç±»ï¼š**

| ç±»å‹ | ç”¨é€” | ç‰¹ç‚¹ | ç¤ºä¾‹å·ç±»å‹ |
|-----|------|------|-----------|
| **æ•°æ®å­˜å‚¨** | æŒä¹…åŒ–ä¸šåŠ¡æ•°æ® | éœ€è¦å¤‡ä»½ã€é«˜å¯ç”¨ | PVCã€NFSã€Ceph |
| **é…ç½®å­˜å‚¨** | æ³¨å…¥é…ç½®æ–‡ä»¶ | åªè¯»ã€æ”¯æŒçƒ­æ›´æ–° | ConfigMapã€Secret |
| **å…±äº«å­˜å‚¨** | å¤šå®¹å™¨æ•°æ®å…±äº« | åŒPodå†…å…±äº« | emptyDirã€PVC |
| **ä¸´æ—¶å­˜å‚¨** | ç¼“å­˜ã€ä¸­é—´æ–‡ä»¶ | å¯ä»¥ä¸¢å¤± | emptyDir |

**æŒ‰è®¿é—®æ¨¡å¼åˆ†ç±»ï¼š**

| è®¿é—®æ¨¡å¼ | ç®€å†™ | è¯´æ˜ | å…¸å‹ä½¿ç”¨åœºæ™¯ |
|---------|------|------|-------------|
| **ReadWriteOnce** | RWO | å•èŠ‚ç‚¹è¯»å†™ | MySQLã€PostgreSQL |
| **ReadOnlyMany** | ROX | å¤šèŠ‚ç‚¹åªè¯» | é™æ€ç½‘ç«™ã€é…ç½®æ–‡ä»¶ |
| **ReadWriteMany** | RWX | å¤šèŠ‚ç‚¹è¯»å†™ | å…±äº«æ–‡ä»¶ç³»ç»Ÿã€æ—¥å¿—èšåˆ |
| **ReadWriteOncePod** | RWOP | å•Podè¯»å†™ï¼ˆK8s 1.22+ï¼‰ | ä¸¥æ ¼å•å®ä¾‹åº”ç”¨ |

### 5.1.4 å­˜å‚¨ç”Ÿå‘½å‘¨æœŸç®¡ç†

**PVçš„ç”Ÿå‘½å‘¨æœŸçŠ¶æ€ï¼š**

```
1. Provisioningï¼ˆä¾›ç»™ï¼‰
   â”œâ”€> Staticï¼ˆé™æ€ï¼‰ï¼šç®¡ç†å‘˜æ‰‹åŠ¨åˆ›å»ºPV
   â””â”€> Dynamicï¼ˆåŠ¨æ€ï¼‰ï¼šStorageClassè‡ªåŠ¨åˆ›å»ºPV

2. Bindingï¼ˆç»‘å®šï¼‰
   PVCå‘èµ·ç”³è¯· â†’ åŒ¹é…åˆé€‚çš„PV â†’ ç»‘å®š

3. Usingï¼ˆä½¿ç”¨ä¸­ï¼‰
   Podé€šè¿‡PVCä½¿ç”¨PVä¸­çš„å­˜å‚¨

4. Reclaimingï¼ˆå›æ”¶ï¼‰
   PVCåˆ é™¤åï¼ŒPVçš„å¤„ç†ç­–ç•¥ï¼š
   â”œâ”€> Retainï¼ˆä¿ç•™ï¼‰ï¼šPVä¿ç•™ï¼Œæ•°æ®ä¸åˆ é™¤ï¼Œéœ€è¦æ‰‹åŠ¨æ¸…ç†
   â”œâ”€> Deleteï¼ˆåˆ é™¤ï¼‰ï¼šPVå’Œåº•å±‚å­˜å‚¨ä¸€èµ·åˆ é™¤
   â””â”€> Recycleï¼ˆå›æ”¶ï¼‰ï¼šåˆ é™¤æ•°æ®ä½†ä¿ç•™PVï¼ˆå·²åºŸå¼ƒï¼‰
```

**çŠ¶æ€è½¬æ¢å›¾ï¼š**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Available   â”‚  â† PVå·²åˆ›å»ºï¼Œç­‰å¾…ç»‘å®š
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼ (PVCåˆ›å»ºå¹¶åŒ¹é…)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Bound     â”‚  â† PVå·²ç»‘å®šåˆ°PVC
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼ (PVCåˆ é™¤)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Released   â”‚  â† PVå·²é‡Šæ”¾ä½†æœªæ¸…ç†
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”œâ”€> (persistentVolumeReclaimPolicy: Retain)
       â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚   â”‚   Failed    â”‚  â† éœ€è¦æ‰‹åŠ¨æ¸…ç†
       â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â””â”€> (persistentVolumeReclaimPolicy: Delete)
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚   Deleted   â”‚  â† PVå’Œæ•°æ®è¢«åˆ é™¤
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ç¤ºä¾‹ï¼šæŸ¥çœ‹PVçŠ¶æ€å˜åŒ–**

```bash
# 1. åˆ›å»ºPVï¼ˆStatic Provisioningï¼‰
kubectl apply -f pv.yaml

# æŸ¥çœ‹çŠ¶æ€
kubectl get pv
# NAME      CAPACITY   ACCESS MODES   STATUS      CLAIM   STORAGECLASS
# mysql-pv  10Gi       RWO            Available           manual

# 2. åˆ›å»ºPVC
kubectl apply -f pvc.yaml

# æŸ¥çœ‹ç»‘å®š
kubectl get pv
# NAME      CAPACITY   ACCESS MODES   STATUS   CLAIM             STORAGECLASS
# mysql-pv  10Gi       RWO            Bound    default/mysql-pvc manual

kubectl get pvc
# NAME        STATUS   VOLUME     CAPACITY   ACCESS MODES
# mysql-pvc   Bound    mysql-pv   10Gi       RWO

# 3. Podä½¿ç”¨PVC
kubectl apply -f pod.yaml

# 4. åˆ é™¤PVC
kubectl delete pvc mysql-pvc

# æŸ¥çœ‹PVçŠ¶æ€ï¼ˆRetainç­–ç•¥ï¼‰
kubectl get pv
# NAME      CAPACITY   ACCESS MODES   STATUS     CLAIM             STORAGECLASS
# mysql-pv  10Gi       RWO            Released   default/mysql-pvc manual
#                                     â†‘ çŠ¶æ€å˜ä¸ºReleased
```

### 5.1.5 Volumeæ’ä»¶ä½“ç³»

Kubernetesé€šè¿‡æ’ä»¶æœºåˆ¶æ”¯æŒå¤šç§å­˜å‚¨åç«¯ï¼š

**æ’ä»¶ç±»å‹ï¼š**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              In-Treeæ’ä»¶ï¼ˆå†…ç½®ï¼‰                        â”‚
â”‚  ç›´æ¥ç¼–è¯‘åœ¨Kubernetesä»£ç ä¸­                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â€¢ emptyDir, hostPath, configMap, secret              â”‚
â”‚  â€¢ nfs, iscsi, fc (å…‰çº¤)                              â”‚
â”‚  â€¢ awsElasticBlockStore, azureDisk, gcePersistentDisk â”‚
â”‚  â€¢ cephfs, rbd, glusterfs                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼ (é€æ­¥è¿ç§»)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Out-of-Treeæ’ä»¶                            â”‚
â”‚  é€šè¿‡CSI (Container Storage Interface)å®ç°              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â€¢ CSI Driverç‹¬ç«‹äºKubernetesç‰ˆæœ¬                       â”‚
â”‚  â€¢ æ”¯æŒåŠ¨æ€ä¾›ç»™ã€å¿«ç…§ã€å…‹éš†ç­‰é«˜çº§åŠŸèƒ½                     â”‚
â”‚  â€¢ äº‘å‚å•†å’Œå­˜å‚¨å‚å•†ç‹¬ç«‹ç»´æŠ¤                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**CSIæ¶æ„ï¼š**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Kubernetes                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚      kubelet (Volume Plugin)             â”‚           â”‚
â”‚  â”‚   è°ƒç”¨CSI DriveræŒ‚è½½/å¸è½½Volume           â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚ (gRPC)
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              CSI Driver (DaemonSet)                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚  Node Plugin                             â”‚           â”‚
â”‚  â”‚  - æŒ‚è½½Volumeåˆ°Pod                        â”‚           â”‚
â”‚  â”‚  - å¸è½½Volume                             â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚  Controller Plugin                       â”‚           â”‚
â”‚  â”‚  - åˆ›å»º/åˆ é™¤Volume                        â”‚           â”‚
â”‚  â”‚  - æ‰©å®¹Volume                             â”‚           â”‚
â”‚  â”‚  - åˆ›å»ºå¿«ç…§                               â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            åº•å±‚å­˜å‚¨ç³»ç»Ÿ                                   â”‚
â”‚  NFS / Ceph / AWS EBS / Azure Disk / GCP PD             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

é€šè¿‡æœ¬èŠ‚å­¦ä¹ ï¼Œæˆ‘ä»¬ç†è§£äº†Kuberneteså­˜å‚¨çš„åŸºç¡€æ¦‚å¿µå’Œæ¶æ„ã€‚æ¥ä¸‹æ¥å°†è¯¦ç»†å­¦ä¹ å„ç§Volumeç±»å‹çš„ä½¿ç”¨æ–¹æ³•ã€‚

---


## 5.2 Volumeå·ç±»å‹è¯¦è§£

åœ¨ä¸Šä¸€èŠ‚ä¸­ï¼Œæˆ‘ä»¬äº†è§£äº†Kuberneteså­˜å‚¨æ¶æ„çš„æ•´ä½“è®¾è®¡ã€‚æœ¬èŠ‚å°†æ·±å…¥å­¦ä¹ å„ç§Volumeç±»å‹çš„å…·ä½“ä½¿ç”¨æ–¹æ³•ã€‚Volumeæ˜¯Podçš„ä¸€éƒ¨åˆ†ï¼Œå…¶ç”Ÿå‘½å‘¨æœŸä¸Podç»‘å®šï¼ŒPodåˆ é™¤åVolumeä¹Ÿä¼šè¢«åˆ é™¤ï¼ˆé™¤äº†PVCï¼‰ã€‚

### 5.2.1 emptyDir - ä¸´æ—¶å­˜å‚¨

**æ¦‚å¿µï¼š**

emptyDiræ˜¯æœ€ç®€å•çš„Volumeç±»å‹ï¼ŒPodåˆ›å»ºæ—¶ä¼šåˆ›å»ºä¸€ä¸ªç©ºç›®å½•ï¼ŒPodåˆ é™¤æ—¶ç›®å½•ä¹Ÿä¼šè¢«åˆ é™¤ã€‚åŒä¸€Podå†…çš„æ‰€æœ‰å®¹å™¨éƒ½å¯ä»¥è¯»å†™è¿™ä¸ªç›®å½•ã€‚

```
ç”Ÿå‘½å‘¨æœŸï¼š
Podåˆ›å»º â†’ emptyDiråˆ›å»ºï¼ˆç©ºç›®å½•ï¼‰
        â†“
Podè¿è¡Œ â†’ å®¹å™¨è¯»å†™æ•°æ®
        â†“
Podåˆ é™¤ â†’ emptyDiråˆ é™¤ï¼ˆæ•°æ®ä¸¢å¤±ï¼‰
```

**é€‚ç”¨åœºæ™¯ï¼š**

âœ… **ä¸´æ—¶ç¼“å­˜**ï¼šåº”ç”¨çš„ä¸´æ—¶ç¼“å­˜æ•°æ®
âœ… **ä¸­é—´æ–‡ä»¶**ï¼šè®¡ç®—è¿‡ç¨‹ä¸­çš„ä¸´æ—¶æ–‡ä»¶
âœ… **å®¹å™¨é—´æ•°æ®å…±äº«**ï¼šåŒä¸€Podå†…å¤šä¸ªå®¹å™¨å…±äº«æ•°æ®
âœ… **Checkpointæ–‡ä»¶**ï¼šåº”ç”¨å´©æºƒæ¢å¤çš„æ£€æŸ¥ç‚¹

âŒ **ä¸é€‚åˆ**ï¼šéœ€è¦æŒä¹…åŒ–çš„æ•°æ®ï¼ˆPodé‡å¯æ•°æ®ä¼šä¸¢å¤±ï¼‰

**åŸºæœ¬ç¤ºä¾‹ï¼šå•å®¹å™¨ä½¿ç”¨emptyDir**

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: emptydir-demo
spec:
  containers:
  - name: app
    image: busybox
    command: ['sh', '-c', 'echo "Hello from emptyDir" > /cache/data.txt && cat /cache/data.txt && sleep 3600']
    volumeMounts:
    - name: cache-volume
      mountPath: /cache    # æŒ‚è½½åˆ°å®¹å™¨çš„/cacheç›®å½•
  volumes:
  - name: cache-volume
    emptyDir: {}           # åˆ›å»ºemptyDirå·
```

**æµ‹è¯•ï¼š**

```bash
# åˆ›å»ºPod
kubectl apply -f emptydir-demo.yaml

# æŸ¥çœ‹æ—¥å¿—
kubectl logs emptydir-demo
# è¾“å‡º: Hello from emptyDir

# è¿›å…¥å®¹å™¨éªŒè¯
kubectl exec -it emptydir-demo -- sh
/ # ls -la /cache/
total 4
drwxrwxrwx    2 root     root            60 Dec 24 10:00 .
drwxr-xr-x    1 root     root          4096 Dec 24 10:00 ..
-rw-r--r--    1 root     root            21 Dec 24 10:00 data.txt

/ # cat /cache/data.txt
Hello from emptyDir

# åˆ é™¤Podåæ•°æ®æ¶ˆå¤±
kubectl delete pod emptydir-demo
kubectl apply -f emptydir-demo.yaml
kubectl exec -it emptydir-demo -- cat /cache/data.txt
# æ–‡ä»¶ä¸å­˜åœ¨ï¼ˆæ–°Podé‡æ–°åˆ›å»ºäº†ç©ºçš„emptyDirï¼‰
```

**å®æˆ˜æ¡ˆä¾‹ï¼šå¤šå®¹å™¨å…±äº«æ•°æ®ï¼ˆåº”ç”¨ + Sidecaræ—¥å¿—æ”¶é›†ï¼‰**

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: sidecar-logger
spec:
  containers:
  # ä¸»åº”ç”¨å®¹å™¨ï¼šå†™æ—¥å¿—
  - name: app
    image: busybox
    command:
    - sh
    - -c
    - |
      while true; do
        echo "[$(date)] Application log entry" >> /var/log/app.log
        sleep 5
      done
    volumeMounts:
    - name: logs
      mountPath: /var/log

  # Sidecarå®¹å™¨ï¼šè¯»æ—¥å¿—å¹¶å¤„ç†
  - name: log-collector
    image: busybox
    command:
    - sh
    - -c
    - |
      tail -f /var/log/app.log | while read line; do
        echo "ğŸ“¨ Collected: $line"
      done
    volumeMounts:
    - name: logs
      mountPath: /var/log

  volumes:
  - name: logs
    emptyDir: {}
```

**æµ‹è¯•å¤šå®¹å™¨å…±äº«ï¼š**

```bash
# åˆ›å»ºPod
kubectl apply -f sidecar-logger.yaml

# æŸ¥çœ‹ä¸»åº”ç”¨æ—¥å¿—
kubectl logs sidecar-logger -c app
# [Tue Dec 24 10:05:23 UTC 2024] Application log entry
# [Tue Dec 24 10:05:28 UTC 2024] Application log entry

# æŸ¥çœ‹Sidecaræ—¥å¿—ï¼ˆå®æ—¶é‡‡é›†ï¼‰
kubectl logs sidecar-logger -c log-collector
# ğŸ“¨ Collected: [Tue Dec 24 10:05:23 UTC 2024] Application log entry
# ğŸ“¨ Collected: [Tue Dec 24 10:05:28 UTC 2024] Application log entry

# éªŒè¯ä¸¤ä¸ªå®¹å™¨çœ‹åˆ°çš„æ˜¯åŒä¸€ä¸ªæ–‡ä»¶
kubectl exec sidecar-logger -c app -- cat /var/log/app.log
kubectl exec sidecar-logger -c log-collector -- cat /var/log/app.log
# è¾“å‡ºå®Œå…¨ä¸€è‡´
```

**emptyDirçš„å­˜å‚¨ä»‹è´¨é€‰é¡¹ï¼š**

```yaml
# 1. é»˜è®¤ï¼šä½¿ç”¨èŠ‚ç‚¹çš„é»˜è®¤å­˜å‚¨ï¼ˆé€šå¸¸æ˜¯ç£ç›˜ï¼‰
volumes:
- name: cache
  emptyDir: {}

# 2. ä½¿ç”¨å†…å­˜ï¼ˆtmpfsï¼‰ï¼šé€Ÿåº¦å¿«ä½†é‡å¯ä¸¢å¤±
volumes:
- name: cache
  emptyDir:
    medium: Memory      # ä½¿ç”¨RAM
    sizeLimit: 1Gi      # é™åˆ¶å¤§å°ï¼ˆé¿å…OOMï¼‰
```

**å†…å­˜emptyDirç¤ºä¾‹ï¼š**

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: memory-cache
spec:
  containers:
  - name: app
    image: nginx
    volumeMounts:
    - name: cache
      mountPath: /cache
    resources:
      limits:
        memory: "2Gi"   # Podå†…å­˜é™åˆ¶å¿…é¡»å¤§äºemptyDir.sizeLimit
  volumes:
  - name: cache
    emptyDir:
      medium: Memory    # ä½¿ç”¨å†…å­˜ï¼ˆé€Ÿåº¦å¿«ï¼‰
      sizeLimit: 512Mi  # é™åˆ¶512MB
```

**æŸ¥çœ‹emptyDirå®é™…å­˜å‚¨ä½ç½®ï¼š**

```bash
# æŸ¥çœ‹Podè¿è¡Œåœ¨å“ªä¸ªèŠ‚ç‚¹
kubectl get pod emptydir-demo -o wide
# NAME            READY   STATUS    NODE
# emptydir-demo   1/1     Running   worker-node1

# SSHåˆ°å¯¹åº”èŠ‚ç‚¹
ssh worker-node1

# æŸ¥çœ‹emptyDirå®é™…è·¯å¾„ï¼ˆ/var/lib/kubelet/pods/<pod-uid>/volumes/kubernetes.io~empty-dir/<volume-name>ï¼‰
sudo find /var/lib/kubelet/pods -name cache-volume
# /var/lib/kubelet/pods/abc123.../volumes/kubernetes.io~empty-dir/cache-volume

# æŸ¥çœ‹å†…å®¹
sudo ls -la /var/lib/kubelet/pods/abc123.../volumes/kubernetes.io~empty-dir/cache-volume
# -rw-r--r-- 1 root root 21 Dec 24 10:00 data.txt
```

**emptyDiræœ€ä½³å®è·µï¼š**

| å®è·µ | è¯´æ˜ |
|-----|------|
| âœ… **è®¾ç½®sizeLimit** | é˜²æ­¢ç£ç›˜è¢«å†™æ»¡ |
| âœ… **ä½¿ç”¨Memoryå­˜å‚¨ä¸´æ—¶æ•æ„Ÿæ•°æ®** | å¯†é’¥ä¸´æ—¶è§£å¯†åå­˜å‚¨åœ¨å†…å­˜ä¸­ |
| âœ… **åº”ç”¨ç¼“å­˜åœºæ™¯** | Redisæœ¬åœ°ç¼“å­˜ã€Nginxä¸´æ—¶æ–‡ä»¶ |
| âŒ **é¿å…å­˜å‚¨é‡è¦æ•°æ®** | Podåˆ é™¤/é‡å¯æ•°æ®ä¼šä¸¢å¤± |
| âŒ **é¿å…å¤§æ–‡ä»¶** | emptyDirå ç”¨èŠ‚ç‚¹å­˜å‚¨ç©ºé—´ |

---

### 5.2.2 hostPath - èŠ‚ç‚¹æœ¬åœ°å­˜å‚¨

**æ¦‚å¿µï¼š**

hostPathå°†å®¿ä¸»æœºï¼ˆNodeï¼‰çš„æ–‡ä»¶æˆ–ç›®å½•æŒ‚è½½åˆ°Podä¸­ã€‚ä¸emptyDirä¸åŒï¼ŒhostPathçš„æ•°æ®ç‹¬ç«‹äºPodç”Ÿå‘½å‘¨æœŸï¼ŒPodåˆ é™¤åæ•°æ®ä¾ç„¶å­˜åœ¨äºèŠ‚ç‚¹ä¸Šã€‚

```
ç”Ÿå‘½å‘¨æœŸï¼š
Podåˆ›å»º â†’ æŒ‚è½½Nodeä¸Šçš„è·¯å¾„
        â†“
Podè¿è¡Œ â†’ è¯»å†™Nodeä¸Šçš„æ–‡ä»¶
        â†“
Podåˆ é™¤ â†’ æ•°æ®ä¾ç„¶ä¿ç•™åœ¨Nodeä¸Š
        â†“
æ–°Podåˆ›å»º â†’ å¦‚æœè°ƒåº¦åˆ°åŒä¸€Nodeï¼Œå¯ä»¥è¯»å–åŸæœ‰æ•°æ®
```

**é€‚ç”¨åœºæ™¯ï¼š**

âœ… **ç³»ç»Ÿçº§ç›‘æ§**ï¼šè¯»å–èŠ‚ç‚¹çš„/procã€/sysç­‰ç³»ç»Ÿä¿¡æ¯
âœ… **æ—¥å¿—æ”¶é›†**ï¼šæ”¶é›†èŠ‚ç‚¹ä¸Šçš„å®¹å™¨æ—¥å¿—ï¼ˆ/var/logï¼‰
âœ… **Dockerè®¿é—®**ï¼šæŒ‚è½½/var/run/docker.sockè®¿é—®Docker API
âœ… **å¼€å‘æµ‹è¯•**ï¼šæœ¬åœ°ä»£ç æŒ‚è½½åˆ°Podï¼ˆç±»ä¼¼docker -vï¼‰

âŒ **ä¸é€‚åˆ**ï¼šç”Ÿäº§ç¯å¢ƒçš„æŒä¹…åŒ–æ•°æ®ï¼ˆPodå¯èƒ½è°ƒåº¦åˆ°å…¶ä»–èŠ‚ç‚¹ï¼‰

**hostPathç±»å‹ï¼š**

| ç±»å‹ | è¯´æ˜ | ä½¿ç”¨åœºæ™¯ |
|-----|------|---------|
| `DirectoryOrCreate` | ç›®å½•ä¸å­˜åœ¨åˆ™åˆ›å»º | é€šç”¨åœºæ™¯ |
| `Directory` | å¿…é¡»å­˜åœ¨çš„ç›®å½• | æŒ‚è½½å·²æœ‰é…ç½®ç›®å½• |
| `FileOrCreate` | æ–‡ä»¶ä¸å­˜åœ¨åˆ™åˆ›å»º | æ—¥å¿—æ–‡ä»¶ |
| `File` | å¿…é¡»å­˜åœ¨çš„æ–‡ä»¶ | æŒ‚è½½è¯ä¹¦æ–‡ä»¶ |
| `Socket` | UNIX socketæ–‡ä»¶ | æŒ‚è½½Docker socket |
| `CharDevice` | å­—ç¬¦è®¾å¤‡ | GPUè®¾å¤‡è®¿é—® |
| `BlockDevice` | å—è®¾å¤‡ | åŸå§‹ç£ç›˜è®¿é—® |

**ç¤ºä¾‹1ï¼šæŒ‚è½½èŠ‚ç‚¹ç›®å½•**

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: hostpath-demo
spec:
  containers:
  - name: app
    image: busybox
    command: ['sh', '-c', 'echo "Node hostname: $(hostname)" > /host-data/pod.txt && cat /host-data/pod.txt && sleep 3600']
    volumeMounts:
    - name: host-volume
      mountPath: /host-data
  volumes:
  - name: host-volume
    hostPath:
      path: /tmp/k8s-data     # èŠ‚ç‚¹ä¸Šçš„è·¯å¾„
      type: DirectoryOrCreate # ä¸å­˜åœ¨åˆ™åˆ›å»º
```

**æµ‹è¯•ï¼š**

```bash
# åˆ›å»ºPod
kubectl apply -f hostpath-demo.yaml

# æŸ¥çœ‹Podè¿è¡Œåœ¨å“ªä¸ªèŠ‚ç‚¹
kubectl get pod hostpath-demo -o wide
# NAME            NODE
# hostpath-demo   worker-node1

# åœ¨èŠ‚ç‚¹ä¸ŠéªŒè¯æ•°æ®ï¼ˆSSHåˆ°worker-node1ï¼‰
ssh worker-node1
cat /tmp/k8s-data/pod.txt
# Node hostname: worker-node1

# åˆ é™¤Pod
kubectl delete pod hostpath-demo

# æ•°æ®ä¾ç„¶å­˜åœ¨
cat /tmp/k8s-data/pod.txt
# Node hostname: worker-node1

# é‡æ–°åˆ›å»ºPodï¼ˆå¯èƒ½è°ƒåº¦åˆ°ä¸åŒèŠ‚ç‚¹ï¼‰
kubectl apply -f hostpath-demo.yaml
kubectl get pod hostpath-demo -o wide
# NAME            NODE
# hostpath-demo   worker-node2  â† è°ƒåº¦åˆ°äº†ä¸åŒèŠ‚ç‚¹

# åœ¨æ–°èŠ‚ç‚¹ä¸ŠæŸ¥çœ‹ï¼ˆæ•°æ®ä¸å­˜åœ¨ï¼‰
ssh worker-node2
ls /tmp/k8s-data/
# pod.txt  â† æ–°æ–‡ä»¶ï¼Œå†…å®¹æ˜¯worker-node2çš„hostname
```

**ç¤ºä¾‹2ï¼šè®¿é—®Docker Socketï¼ˆå®¹å™¨å†…è¿è¡ŒDockerå‘½ä»¤ï¼‰**

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: docker-cli
spec:
  containers:
  - name: docker
    image: docker:latest
    command: ['sh', '-c', 'docker ps && sleep 3600']
    volumeMounts:
    - name: docker-sock
      mountPath: /var/run/docker.sock
  volumes:
  - name: docker-sock
    hostPath:
      path: /var/run/docker.sock
      type: Socket    # æŒ‡å®šä¸ºSocketç±»å‹
```

**æµ‹è¯•Dockerè®¿é—®ï¼š**

```bash
# åˆ›å»ºPod
kubectl apply -f docker-cli.yaml

# æŸ¥çœ‹æ—¥å¿—ï¼ˆæ˜¾ç¤ºèŠ‚ç‚¹ä¸Šæ‰€æœ‰å®¹å™¨ï¼‰
kubectl logs docker-cli
# CONTAINER ID   IMAGE                  COMMAND
# abc123...      nginx                  "nginx -g 'daemon ..."
# def456...      k8s.gcr.io/pause:3.5   "/pause"

# åœ¨Podå†…æ‰§è¡ŒDockerå‘½ä»¤
kubectl exec -it docker-cli -- docker images
# REPOSITORY          TAG       IMAGE ID       CREATED
# nginx               latest    abc123...      2 days ago

# âš ï¸ å®‰å…¨è­¦å‘Šï¼šè¿™å…è®¸Podå®Œå…¨æ§åˆ¶èŠ‚ç‚¹çš„Dockerï¼Œç”Ÿäº§ç¯å¢ƒéœ€è°¨æ…ä½¿ç”¨
```

**ç¤ºä¾‹3ï¼šèŠ‚ç‚¹æ—¥å¿—æ”¶é›†ï¼ˆFluentd/Filebeatæ¨¡å¼ï¼‰**

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: log-collector
spec:
  containers:
  - name: fluentd
    image: fluent/fluentd:latest
    volumeMounts:
    - name: varlog
      mountPath: /var/log           # æ”¶é›†èŠ‚ç‚¹æ—¥å¿—
      readOnly: true                # åªè¯»æ¨¡å¼
    - name: varlibdockercontainers
      mountPath: /var/lib/docker/containers
      readOnly: true                # æ”¶é›†å®¹å™¨æ—¥å¿—
  volumes:
  - name: varlog
    hostPath:
      path: /var/log
      type: Directory
  - name: varlibdockercontainers
    hostPath:
      path: /var/lib/docker/containers
      type: Directory
```

**ç¤ºä¾‹4ï¼šå¼€å‘ç¯å¢ƒä»£ç çƒ­æ›´æ–°**

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: dev-app
spec:
  containers:
  - name: python-app
    image: python:3.9
    command: ['python', '/app/main.py']
    volumeMounts:
    - name: code
      mountPath: /app
  volumes:
  - name: code
    hostPath:
      path: /Users/developer/myapp  # æœ¬åœ°å¼€å‘ç›®å½•
      type: Directory
```

**hostPathå®‰å…¨é£é™©ï¼š**

```
âš ï¸ å®‰å…¨é£é™©ï¼š
1. å®¹å™¨é€ƒé€¸ï¼šæŒ‚è½½/var/run/docker.sockå¯ä»¥å®Œå…¨æ§åˆ¶èŠ‚ç‚¹
2. æ•°æ®æ³„éœ²ï¼šå¯ä»¥è¯»å–èŠ‚ç‚¹ä¸Šçš„æ•æ„Ÿæ–‡ä»¶ï¼ˆå¦‚/etc/shadowï¼‰
3. æ‹’ç»æœåŠ¡ï¼šå†™å…¥å¤§é‡æ•°æ®å¡«æ»¡èŠ‚ç‚¹ç£ç›˜
4. æƒé™æå‡ï¼šæŒ‚è½½èŠ‚ç‚¹çš„/etcç›®å½•ä¿®æ”¹é…ç½®

ğŸ”’ å®‰å…¨å»ºè®®ï¼š
âœ… ä½¿ç”¨PodSecurityPolicy/PodSecurityStandardé™åˆ¶hostPath
âœ… åªåœ¨ç³»ç»Ÿçº§ç»„ä»¶ï¼ˆç›‘æ§ã€æ—¥å¿—æ”¶é›†ï¼‰ä¸­ä½¿ç”¨
âœ… ä½¿ç”¨readOnly: trueé™åˆ¶ä¸ºåªè¯»
âœ… é™åˆ¶å¯æŒ‚è½½çš„è·¯å¾„ï¼ˆé€šè¿‡admission webhookï¼‰
```

**hostPathæœ€ä½³å®è·µï¼š**

```yaml
# âœ… æ¨èï¼šåªè¯»æŒ‚è½½
volumes:
- name: config
  hostPath:
    path: /etc/config
    type: Directory
volumeMounts:
- name: config
  mountPath: /config
  readOnly: true    # åªè¯»ï¼Œé˜²æ­¢è¯¯ä¿®æ”¹

# âœ… æ¨èï¼šä½¿ç”¨nodeSelectorç¡®ä¿è°ƒåº¦åˆ°ç‰¹å®šèŠ‚ç‚¹
spec:
  nodeSelector:
    kubernetes.io/hostname: worker-node1  # å›ºå®šèŠ‚ç‚¹
  volumes:
  - name: data
    hostPath:
      path: /data/app

# âŒ ä¸æ¨èï¼šç”Ÿäº§ç¯å¢ƒä½¿ç”¨hostPathå­˜å‚¨ä¸šåŠ¡æ•°æ®
# åº”è¯¥ä½¿ç”¨PVC + ç½‘ç»œå­˜å‚¨
```

---

### 5.2.3 ConfigMap - é…ç½®æ–‡ä»¶ç®¡ç†

**æ¦‚å¿µï¼š**

ConfigMapç”¨äºå­˜å‚¨éæ•æ„Ÿçš„é…ç½®æ•°æ®ï¼ˆé”®å€¼å¯¹ã€é…ç½®æ–‡ä»¶ç­‰ï¼‰ã€‚å°†é…ç½®ä¸é•œåƒè§£è€¦ï¼Œå®ç°é…ç½®çš„å¤–éƒ¨åŒ–ç®¡ç†ã€‚

```
ä¼ ç»Ÿæ–¹å¼ï¼š
é…ç½®ç¡¬ç¼–ç åœ¨é•œåƒä¸­ â†’ ä¿®æ”¹é…ç½®éœ€è¦é‡æ–°æ„å»ºé•œåƒ

ConfigMapæ–¹å¼ï¼š
é…ç½®å­˜å‚¨åœ¨ConfigMap â†’ ä¿®æ”¹é…ç½®åªéœ€æ›´æ–°ConfigMap â†’ Podé‡å¯åè‡ªåŠ¨åŠ è½½æ–°é…ç½®
```

**åˆ›å»ºConfigMapçš„4ç§æ–¹å¼ï¼š**

**æ–¹å¼1ï¼šé€šè¿‡å‘½ä»¤è¡Œï¼ˆå­—é¢é‡ï¼‰**

```bash
# åˆ›å»ºåŒ…å«é”®å€¼å¯¹çš„ConfigMap
kubectl create configmap app-config \
  --from-literal=db.host=mysql.default.svc.cluster.local \
  --from-literal=db.port=3306 \
  --from-literal=log.level=INFO

# æŸ¥çœ‹
kubectl get configmap app-config -o yaml
```

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: app-config
data:
  db.host: mysql.default.svc.cluster.local
  db.port: "3306"
  log.level: INFO
```

**æ–¹å¼2ï¼šé€šè¿‡æ–‡ä»¶åˆ›å»º**

```bash
# åˆ›å»ºé…ç½®æ–‡ä»¶
cat > app.properties <<EOF
db.host=mysql.default.svc.cluster.local
db.port=3306
db.name=myapp
cache.enabled=true
cache.ttl=3600
EOF

# ä»æ–‡ä»¶åˆ›å»ºConfigMap
kubectl create configmap app-config --from-file=app.properties

# æŸ¥çœ‹
kubectl describe configmap app-config
# Data
# ====
# app.properties:
# ----
# db.host=mysql.default.svc.cluster.local
# db.port=3306
# ...
```

**æ–¹å¼3ï¼šä»ç›®å½•åˆ›å»ºï¼ˆå¤šä¸ªæ–‡ä»¶ï¼‰**

```bash
# åˆ›å»ºé…ç½®ç›®å½•
mkdir config
cat > config/database.conf <<EOF
host=mysql
port=3306
EOF

cat > config/redis.conf <<EOF
host=redis
port=6379
EOF

# ä»ç›®å½•åˆ›å»ºï¼ˆåŒ…å«æ‰€æœ‰æ–‡ä»¶ï¼‰
kubectl create configmap multi-config --from-file=config/

# æŸ¥çœ‹
kubectl describe configmap multi-config
# Data
# ====
# database.conf:
# ----
# host=mysql
# port=3306
#
# redis.conf:
# ----
# host=redis
# port=6379
```

**æ–¹å¼4ï¼šé€šè¿‡YAMLåˆ›å»ºï¼ˆæ¨èï¼‰**

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: app-config
  namespace: default
data:
  # é”®å€¼å¯¹æ–¹å¼
  DB_HOST: "mysql.default.svc.cluster.local"
  DB_PORT: "3306"
  LOG_LEVEL: "INFO"

  # æ–‡ä»¶æ–¹å¼ï¼ˆå¤šè¡Œæ–‡æœ¬ï¼‰
  app.properties: |
    db.host=mysql.default.svc.cluster.local
    db.port=3306
    db.name=myapp
    cache.enabled=true

  nginx.conf: |
    server {
      listen 80;
      server_name example.com;
      location / {
        proxy_pass http://backend:8080;
      }
    }
```

```bash
kubectl apply -f configmap.yaml
```

**ä½¿ç”¨ConfigMapçš„3ç§æ–¹å¼ï¼š**

**æ–¹å¼1ï¼šä½œä¸ºç¯å¢ƒå˜é‡**

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: env-demo
spec:
  containers:
  - name: app
    image: busybox
    command: ['sh', '-c', 'echo "DB Host: $DB_HOST, Port: $DB_PORT" && sleep 3600']
    env:
    # å•ä¸ªé”®æ³¨å…¥
    - name: DB_HOST
      valueFrom:
        configMapKeyRef:
          name: app-config
          key: DB_HOST
    - name: DB_PORT
      valueFrom:
        configMapKeyRef:
          name: app-config
          key: DB_PORT

    # æˆ–è€…å…¨éƒ¨é”®æ³¨å…¥
    envFrom:
    - configMapRef:
        name: app-config
```

**æµ‹è¯•ï¼š**

```bash
kubectl apply -f env-demo.yaml
kubectl logs env-demo
# DB Host: mysql.default.svc.cluster.local, Port: 3306

# æŸ¥çœ‹æ‰€æœ‰ç¯å¢ƒå˜é‡
kubectl exec env-demo -- env | grep DB
# DB_HOST=mysql.default.svc.cluster.local
# DB_PORT=3306
```

**æ–¹å¼2ï¼šä½œä¸ºVolumeæŒ‚è½½**

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: volume-demo
spec:
  containers:
  - name: app
    image: nginx
    volumeMounts:
    - name: config
      mountPath: /etc/config    # æŒ‚è½½åˆ°/etc/configç›®å½•
  volumes:
  - name: config
    configMap:
      name: app-config
```

**æŸ¥çœ‹æŒ‚è½½çš„æ–‡ä»¶ï¼š**

```bash
kubectl apply -f volume-demo.yaml

# æŸ¥çœ‹æŒ‚è½½çš„æ–‡ä»¶
kubectl exec volume-demo -- ls -la /etc/config
# total 12
# drwxrwxrwx 3 root root 4096 Dec 24 10:30 .
# drwxr-xr-x 1 root root 4096 Dec 24 10:30 ..
# drwxr-xr-x 2 root root 4096 Dec 24 10:30 ..data
# lrwxrwxrwx 1 root root   16 Dec 24 10:30 DB_HOST -> ..data/DB_HOST
# lrwxrwxrwx 1 root root   16 Dec 24 10:30 DB_PORT -> ..data/DB_PORT
# lrwxrwxrwx 1 root root   16 Dec 24 10:30 app.properties -> ..data/app.properties

# æŸ¥çœ‹æ–‡ä»¶å†…å®¹
kubectl exec volume-demo -- cat /etc/config/DB_HOST
# mysql.default.svc.cluster.local

kubectl exec volume-demo -- cat /etc/config/app.properties
# db.host=mysql.default.svc.cluster.local
# db.port=3306
# ...
```

**æ–¹å¼3ï¼šæŒ‚è½½ç‰¹å®šé”®åˆ°ç‰¹å®šè·¯å¾„**

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: selective-mount
spec:
  containers:
  - name: nginx
    image: nginx
    volumeMounts:
    - name: config
      mountPath: /etc/nginx/nginx.conf  # æŒ‚è½½åˆ°ç‰¹å®šæ–‡ä»¶
      subPath: nginx.conf               # åªæŒ‚è½½nginx.confè¿™ä¸ªé”®
  volumes:
  - name: config
    configMap:
      name: app-config
      items:                            # åªé€‰æ‹©ç‰¹å®šçš„é”®
      - key: nginx.conf
        path: nginx.conf
```

**ConfigMapçƒ­æ›´æ–°ï¼ˆè‡ªåŠ¨åŒæ­¥ï¼‰**

```yaml
# ConfigMapä½œä¸ºVolumeæŒ‚è½½æ—¶ï¼Œä¼šè‡ªåŠ¨æ›´æ–°ï¼ˆå»¶è¿Ÿçº¦1åˆ†é’Ÿï¼‰
apiVersion: v1
kind: ConfigMap
metadata:
  name: dynamic-config
data:
  message: "Version 1"
---
apiVersion: v1
kind: Pod
metadata:
  name: hot-reload
spec:
  containers:
  - name: app
    image: busybox
    command:
    - sh
    - -c
    - |
      while true; do
        cat /etc/config/message
        sleep 5
      done
    volumeMounts:
    - name: config
      mountPath: /etc/config
  volumes:
  - name: config
    configMap:
      name: dynamic-config
```

**æµ‹è¯•çƒ­æ›´æ–°ï¼š**

```bash
# åˆ›å»ºPod
kubectl apply -f hot-reload.yaml

# æŸ¥çœ‹æ—¥å¿—
kubectl logs -f hot-reload
# Version 1
# Version 1
# Version 1

# åœ¨å¦ä¸€ä¸ªç»ˆç«¯æ›´æ–°ConfigMap
kubectl patch configmap dynamic-config -p '{"data":{"message":"Version 2"}}'

# ç­‰å¾…çº¦60ç§’åï¼Œæ—¥å¿—è‡ªåŠ¨æ˜¾ç¤ºæ–°å†…å®¹
# Version 1
# Version 1
# Version 2  â† è‡ªåŠ¨æ›´æ–°
# Version 2
```

**æ³¨æ„äº‹é¡¹ï¼š**

```
âœ… çƒ­æ›´æ–°ç”Ÿæ•ˆæ¡ä»¶ï¼š
- ConfigMapä½œä¸ºVolumeæŒ‚è½½ï¼ˆä¸æ˜¯ç¯å¢ƒå˜é‡ï¼‰
- ä½¿ç”¨é»˜è®¤çš„æŒ‚è½½æ–¹å¼ï¼ˆä¸æ˜¯subPathï¼‰
- kubeletåŒæ­¥å‘¨æœŸï¼šé»˜è®¤60ç§’

âŒ ä¸æ”¯æŒçƒ­æ›´æ–°çš„æƒ…å†µï¼š
- ConfigMapä½œä¸ºç¯å¢ƒå˜é‡æ³¨å…¥ï¼ˆéœ€è¦é‡å¯Podï¼‰
- ä½¿ç”¨subPathæŒ‚è½½ï¼ˆKubernetesé™åˆ¶ï¼‰
- immutable: trueçš„ConfigMapï¼ˆä¸å¯å˜ï¼‰

ğŸ”§ åº”ç”¨å¦‚ä½•å“åº”é…ç½®å˜åŒ–ï¼Ÿ
æ–¹æ¡ˆ1ï¼šåº”ç”¨å†…éƒ¨å®šæ—¶è¯»å–é…ç½®æ–‡ä»¶
æ–¹æ¡ˆ2ï¼šä½¿ç”¨inotifyç›‘å¬æ–‡ä»¶å˜åŒ–
æ–¹æ¡ˆ3ï¼šé…åˆReloaderè‡ªåŠ¨é‡å¯Pod
```

**ä¸å¯å˜ConfigMapï¼ˆKubernetes 1.21+ï¼‰**

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: immutable-config
data:
  key: value
immutable: true    # åˆ›å»ºåä¸å¯ä¿®æ”¹
```

**ä¼˜ç‚¹ï¼š**

- é˜²æ­¢æ„å¤–æ›´æ–°å¯¼è‡´çš„æ•…éšœ
- æé«˜æ€§èƒ½ï¼ˆkubeletä¸éœ€è¦watchå˜åŒ–ï¼‰
- é€‚åˆ"ä¸€æ¬¡æ€§é…ç½®"ï¼ˆå¦‚åº”ç”¨å¯åŠ¨å‚æ•°ï¼‰

**ConfigMapå®æˆ˜æ¡ˆä¾‹ï¼šNginxé…ç½®å¤–éƒ¨åŒ–**

```yaml
# 1. åˆ›å»ºNginxé…ç½®ConfigMap
apiVersion: v1
kind: ConfigMap
metadata:
  name: nginx-config
data:
  nginx.conf: |
    events {
      worker_connections 1024;
    }
    http {
      server {
        listen 80;
        server_name example.com;

        location / {
          return 200 "Hello from ConfigMap Nginx!\n";
          add_header Content-Type text/plain;
        }

        location /api {
          proxy_pass http://backend-service:8080;
          proxy_set_header Host $host;
        }
      }
    }
---
# 2. åˆ›å»ºNginx Podä½¿ç”¨ConfigMap
apiVersion: v1
kind: Pod
metadata:
  name: nginx-with-config
spec:
  containers:
  - name: nginx
    image: nginx:1.25
    ports:
    - containerPort: 80
    volumeMounts:
    - name: config
      mountPath: /etc/nginx/nginx.conf
      subPath: nginx.conf    # åªæ›¿æ¢nginx.confæ–‡ä»¶
  volumes:
  - name: config
    configMap:
      name: nginx-config
```

**æµ‹è¯•ï¼š**

```bash
# åˆ›å»ºèµ„æº
kubectl apply -f nginx-config.yaml

# éªŒè¯é…ç½®å·²åŠ è½½
kubectl exec nginx-with-config -- nginx -T | grep "Hello from ConfigMap"
# return 200 "Hello from ConfigMap Nginx!\n";

# ç«¯å£è½¬å‘æµ‹è¯•
kubectl port-forward nginx-with-config 8080:80 &
curl localhost:8080
# Hello from ConfigMap Nginx!

# æ›´æ–°é…ç½®
kubectl patch configmap nginx-config -p '{"data":{"nginx.conf":"events {}\nhttp { server { listen 80; return 200 \"Updated Config\\n\"; } }"}}'

# é‡å¯PodåŠ è½½æ–°é…ç½®ï¼ˆä½¿ç”¨subPathä¸æ”¯æŒçƒ­æ›´æ–°ï¼‰
kubectl delete pod nginx-with-config
kubectl apply -f nginx-config.yaml

curl localhost:8080
# Updated Config
```

**ConfigMapæœ€ä½³å®è·µï¼š**

| å®è·µ | è¯´æ˜ |
|-----|------|
| âœ… **ä½¿ç”¨YAMLç®¡ç†** | æ–¹ä¾¿ç‰ˆæœ¬æ§åˆ¶å’Œå›æ»š |
| âœ… **å‘½åçº¦å®š** | ä½¿ç”¨`<app>-config`æ ¼å¼ |
| âœ… **åˆ†ç¯å¢ƒç®¡ç†** | `app-config-dev`ã€`app-config-prod` |
| âœ… **å¤§å°é™åˆ¶** | å•ä¸ªConfigMap < 1MB |
| âœ… **æ•æ„Ÿä¿¡æ¯ç”¨Secret** | å¯†ç ã€å¯†é’¥ä¸è¦æ”¾åœ¨ConfigMap |
| âŒ **é¿å…é¢‘ç¹æ›´æ–°** | çƒ­æ›´æ–°æœ‰å»¶è¿Ÿï¼Œä¸é€‚åˆå®æ—¶é…ç½® |

---

### 5.2.4 Secret - å¯†é’¥ç®¡ç†

**æ¦‚å¿µï¼š**

Secretç”¨äºå­˜å‚¨æ•æ„Ÿä¿¡æ¯ï¼ˆå¯†ç ã€å¯†é’¥ã€è¯ä¹¦ç­‰ï¼‰ï¼Œä¸ConfigMapç±»ä¼¼ï¼Œä½†æ•°æ®ä¼šè¿›è¡ŒBase64ç¼–ç ï¼ˆæ³¨æ„ï¼šä¸æ˜¯åŠ å¯†ï¼‰ã€‚

**ConfigMap vs Secretå¯¹æ¯”ï¼š**

| ç‰¹æ€§ | ConfigMap | Secret |
|-----|----------|--------|
| **ç”¨é€”** | éæ•æ„Ÿé…ç½® | æ•æ„Ÿä¿¡æ¯ |
| **å­˜å‚¨æ–¹å¼** | æ˜æ–‡ | Base64ç¼–ç  |
| **etcdåŠ å¯†** | å¦ | å¯é€‰ï¼ˆéœ€é…ç½®EncryptionConfigï¼‰ |
| **æŒ‚è½½æƒé™** | é»˜è®¤0644 | é»˜è®¤0400ï¼ˆåªè¯»ï¼‰ |
| **ç±»å‹** | åªæœ‰Opaque | Opaque/TLS/DockerRegistryç­‰ |
| **å¤§å°é™åˆ¶** | 1MB | 1MB |

**Secretç±»å‹ï¼š**

| ç±»å‹ | ç”¨é€” | æ•°æ®é”® |
|-----|------|--------|
| `Opaque` | é€šç”¨å¯†é’¥ï¼ˆé»˜è®¤ï¼‰ | è‡ªå®šä¹‰ |
| `kubernetes.io/tls` | TLSè¯ä¹¦ | `tls.crt`ã€`tls.key` |
| `kubernetes.io/dockerconfigjson` | Dockeré•œåƒä»“åº“è®¤è¯ | `.dockerconfigjson` |
| `kubernetes.io/basic-auth` | åŸºç¡€è®¤è¯ | `username`ã€`password` |
| `kubernetes.io/ssh-auth` | SSHå¯†é’¥ | `ssh-privatekey` |
| `kubernetes.io/service-account-token` | ServiceAccountä»¤ç‰Œ | `token`ã€`ca.crt` |

**åˆ›å»ºSecretçš„æ–¹å¼ï¼š**

**æ–¹å¼1ï¼šé€šè¿‡å‘½ä»¤è¡Œï¼ˆå­—é¢é‡ï¼‰**

```bash
# åˆ›å»ºé€šç”¨Secret
kubectl create secret generic db-secret \
  --from-literal=username=admin \
  --from-literal=password=MyP@ssw0rd

# æŸ¥çœ‹ï¼ˆæ•°æ®è¢«Base64ç¼–ç ï¼‰
kubectl get secret db-secret -o yaml
```

```yaml
apiVersion: v1
kind: Secret
metadata:
  name: db-secret
type: Opaque
data:
  username: YWRtaW4=        # adminçš„Base64ç¼–ç 
  password: TXlQQHNzdzByZA==  # MyP@ssw0rdçš„Base64ç¼–ç 
```

**æ–¹å¼2ï¼šé€šè¿‡æ–‡ä»¶åˆ›å»º**

```bash
# åˆ›å»ºå¯†é’¥æ–‡ä»¶
echo -n 'admin' > username.txt
echo -n 'MyP@ssw0rd' > password.txt

# ä»æ–‡ä»¶åˆ›å»ºSecret
kubectl create secret generic db-secret \
  --from-file=username=username.txt \
  --from-file=password=password.txt

# æ¸…ç†æ˜æ–‡æ–‡ä»¶
rm username.txt password.txt
```

**æ–¹å¼3ï¼šé€šè¿‡YAMLåˆ›å»ºï¼ˆéœ€æ‰‹åŠ¨Base64ç¼–ç ï¼‰**

```yaml
apiVersion: v1
kind: Secret
metadata:
  name: db-secret
type: Opaque
data:
  # å€¼å¿…é¡»æ˜¯Base64ç¼–ç 
  username: YWRtaW4=             # echo -n 'admin' | base64
  password: TXlQQHNzdzByZA==     # echo -n 'MyP@ssw0rd' | base64
```

**æ–¹å¼4ï¼šä½¿ç”¨stringDataï¼ˆæ˜æ–‡ï¼Œè‡ªåŠ¨ç¼–ç ï¼‰**

```yaml
apiVersion: v1
kind: Secret
metadata:
  name: db-secret
type: Opaque
stringData:            # ä½¿ç”¨stringDataå¯ä»¥ç›´æ¥å†™æ˜æ–‡
  username: admin      # è‡ªåŠ¨ç¼–ç ä¸ºBase64
  password: MyP@ssw0rd
```

```bash
# åº”ç”¨åæŸ¥çœ‹
kubectl apply -f secret.yaml
kubectl get secret db-secret -o yaml
# dataå­—æ®µä¼šè‡ªåŠ¨è½¬æ¢ä¸ºBase64ç¼–ç 
```

**è§£ç Secretï¼š**

```bash
# æŸ¥çœ‹ç¼–ç åçš„å€¼
kubectl get secret db-secret -o jsonpath='{.data.password}'
# TXlQQHNzdzByZA==

# è§£ç 
kubectl get secret db-secret -o jsonpath='{.data.password}' | base64 -d
# MyP@ssw0rd

# æˆ–ä½¿ç”¨kubectlå†…ç½®åŠŸèƒ½
kubectl get secret db-secret -o jsonpath='{.data.password}' | base64 --decode
```

**ä½¿ç”¨Secretçš„3ç§æ–¹å¼ï¼š**

**æ–¹å¼1ï¼šä½œä¸ºç¯å¢ƒå˜é‡**

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: secret-env-demo
spec:
  containers:
  - name: app
    image: busybox
    command: ['sh', '-c', 'echo "User: $DB_USER, Pass: $DB_PASS" && sleep 3600']
    env:
    - name: DB_USER
      valueFrom:
        secretKeyRef:
          name: db-secret
          key: username
    - name: DB_PASS
      valueFrom:
        secretKeyRef:
          name: db-secret
          key: password
```

**æµ‹è¯•ï¼š**

```bash
kubectl apply -f secret-env-demo.yaml
kubectl logs secret-env-demo
# User: admin, Pass: MyP@ssw0rd

# âš ï¸ æ³¨æ„ï¼šç¯å¢ƒå˜é‡å¯èƒ½è¢«å…¶ä»–è¿›ç¨‹è¯»å–ï¼Œä¸å¤Ÿå®‰å…¨
kubectl exec secret-env-demo -- env | grep DB
# DB_USER=admin
# DB_PASS=MyP@ssw0rd
```

**æ–¹å¼2ï¼šä½œä¸ºVolumeæŒ‚è½½ï¼ˆæ¨èï¼‰**

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: secret-volume-demo
spec:
  containers:
  - name: app
    image: busybox
    command:
    - sh
    - -c
    - |
      echo "Username: $(cat /etc/secrets/username)"
      echo "Password: $(cat /etc/secrets/password)"
      sleep 3600
    volumeMounts:
    - name: secret
      mountPath: /etc/secrets
      readOnly: true      # åªè¯»æŒ‚è½½
  volumes:
  - name: secret
    secret:
      secretName: db-secret
      defaultMode: 0400   # æ–‡ä»¶æƒé™ï¼šåªæœ‰ownerå¯è¯»
```

**æŸ¥çœ‹æŒ‚è½½çš„Secretï¼š**

```bash
kubectl apply -f secret-volume-demo.yaml

# æŸ¥çœ‹æ–‡ä»¶
kubectl exec secret-volume-demo -- ls -la /etc/secrets
# total 4
# drwxrwxrwt 3 root root  120 Dec 24 11:00 .
# drwxr-xr-x 1 root root 4096 Dec 24 11:00 ..
# drwxr-xr-x 2 root root   80 Dec 24 11:00 ..data
# lrwxrwxrwx 1 root root   15 Dec 24 11:00 password -> ..data/password
# lrwxrwxrwx 1 root root   15 Dec 24 11:00 username -> ..data/username

# æŸ¥çœ‹æƒé™
kubectl exec secret-volume-demo -- stat -c "%a %n" /etc/secrets/password
# 400 /etc/secrets/password  â† åªè¯»æƒé™

# æŸ¥çœ‹å†…å®¹ï¼ˆè‡ªåŠ¨è§£ç ï¼‰
kubectl exec secret-volume-demo -- cat /etc/secrets/username
# admin
kubectl exec secret-volume-demo -- cat /etc/secrets/password
# MyP@ssw0rd
```

**TLS Secretï¼ˆHTTPSè¯ä¹¦ï¼‰**

```bash
# ç”Ÿæˆè‡ªç­¾åè¯ä¹¦
openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
  -keyout tls.key \
  -out tls.crt \
  -subj "/CN=example.com"

# åˆ›å»ºTLS Secret
kubectl create secret tls tls-secret \
  --cert=tls.crt \
  --key=tls.key

# æŸ¥çœ‹
kubectl get secret tls-secret -o yaml
```

```yaml
apiVersion: v1
kind: Secret
metadata:
  name: tls-secret
type: kubernetes.io/tls
data:
  tls.crt: LS0tLS1CRUdJTi...  # è¯ä¹¦Base64
  tls.key: LS0tLS1CRUdJTi...  # ç§é’¥Base64
```

**åœ¨Ingressä¸­ä½¿ç”¨TLS Secretï¼š**

```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: tls-ingress
spec:
  tls:
  - hosts:
    - example.com
    secretName: tls-secret    # å¼•ç”¨TLS Secret
  rules:
  - host: example.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: web-service
            port:
              number: 80
```

**Docker Registry Secretï¼ˆç§æœ‰é•œåƒä»“åº“ï¼‰**

```bash
# åˆ›å»ºDocker Registryè®¤è¯Secret
kubectl create secret docker-registry registry-secret \
  --docker-server=registry.example.com \
  --docker-username=myuser \
  --docker-password=mypassword \
  --docker-email=myuser@example.com

# æŸ¥çœ‹
kubectl get secret registry-secret -o yaml
```

```yaml
apiVersion: v1
kind: Secret
metadata:
  name: registry-secret
type: kubernetes.io/dockerconfigjson
data:
  .dockerconfigjson: eyJhdXRocyI6eyJyZWdpc3RyeS...  # Dockeré…ç½®JSONçš„Base64
```

**åœ¨Podä¸­ä½¿ç”¨ï¼ˆæ‹‰å–ç§æœ‰é•œåƒï¼‰ï¼š**

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: private-image-pod
spec:
  containers:
  - name: app
    image: registry.example.com/myapp:latest  # ç§æœ‰é•œåƒ
  imagePullSecrets:
  - name: registry-secret    # å¼•ç”¨Registry Secret
```

**SecretåŠ å¯†å­˜å‚¨ï¼ˆetcdåŠ å¯†ï¼‰**

```
âš ï¸ é»˜è®¤æƒ…å†µä¸‹ï¼ŒSecretåªæ˜¯Base64ç¼–ç ï¼Œå­˜å‚¨åœ¨etcdä¸­æ˜¯æ˜æ–‡ï¼

å®‰å…¨åŠ å›ºï¼š
1. å¯ç”¨etcdåŠ å¯†ï¼ˆEncryptionConfigurationï¼‰
2. å¯ç”¨RBACé™åˆ¶Secretè®¿é—®
3. ä½¿ç”¨å¤–éƒ¨å¯†é’¥ç®¡ç†ç³»ç»Ÿï¼ˆå¦‚Vaultã€AWS Secrets Managerï¼‰
```

**å¯ç”¨etcdåŠ å¯†ï¼š**

```yaml
# /etc/kubernetes/enc/encryption-config.yaml
apiVersion: apiserver.config.k8s.io/v1
kind: EncryptionConfiguration
resources:
  - resources:
    - secrets
    providers:
    - aescbc:
        keys:
        - name: key1
          secret: <BASE64_ENCODED_32_BYTE_KEY>  # head -c 32 /dev/urandom | base64
    - identity: {}   # å›é€€åˆ°æ˜æ–‡ï¼ˆç”¨äºè¿ç§»ï¼‰
```

```bash
# ä¿®æ”¹kube-apiserverå¯åŠ¨å‚æ•°
--encryption-provider-config=/etc/kubernetes/enc/encryption-config.yaml

# é‡å¯apiserver
systemctl restart kube-apiserver

# éªŒè¯åŠ å¯†ï¼ˆæŸ¥çœ‹etcdä¸­çš„æ•°æ®ï¼‰
ETCDCTL_API=3 etcdctl get /registry/secrets/default/db-secret
# è¾“å‡ºåº”è¯¥æ˜¯åŠ å¯†çš„äºŒè¿›åˆ¶æ•°æ®
```

**Secretæœ€ä½³å®è·µï¼š**

```yaml
# âœ… æ¨èï¼šä½¿ç”¨VolumeæŒ‚è½½ï¼ŒreadOnlyï¼Œé™åˆ¶æƒé™
spec:
  volumes:
  - name: secret
    secret:
      secretName: db-secret
      defaultMode: 0400    # åªè¯»
volumeMounts:
- name: secret
  mountPath: /secrets
  readOnly: true

# âœ… æ¨èï¼šä½¿ç”¨RBACé™åˆ¶è®¿é—®
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: secret-reader
rules:
- apiGroups: [""]
  resources: ["secrets"]
  resourceNames: ["db-secret"]  # åªå…è®¸è®¿é—®ç‰¹å®šSecret
  verbs: ["get"]

# âœ… æ¨èï¼šä½¿ç”¨External Secrets Operatoré›†æˆVault
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: vault-secret
spec:
  secretStoreRef:
    name: vault-backend
  target:
    name: db-secret
  data:
  - secretKey: password
    remoteRef:
      key: secret/data/db
      property: password

# âŒ ä¸æ¨èï¼šSecretå­˜å‚¨åœ¨Gitä»“åº“
# è§£å†³æ–¹æ¡ˆï¼šä½¿ç”¨sealed-secretsæˆ–SOPSåŠ å¯†
```

| å®è·µ | è¯´æ˜ |
|-----|------|
| âœ… **å¯ç”¨etcdåŠ å¯†** | é˜²æ­¢ç›´æ¥è¯»å–etcdæ•°æ® |
| âœ… **ä½¿ç”¨Volumeè€Œéç¯å¢ƒå˜é‡** | ç¯å¢ƒå˜é‡å¯èƒ½æ³„éœ²åˆ°æ—¥å¿— |
| âœ… **è®¾ç½®defaultMode: 0400** | é™åˆ¶æ–‡ä»¶æƒé™ |
| âœ… **ä½¿ç”¨RBACé™åˆ¶è®¿é—®** | æœ€å°æƒé™åŸåˆ™ |
| âœ… **å®šæœŸè½®æ¢å¯†é’¥** | é™ä½æ³„éœ²é£é™© |
| âœ… **ä½¿ç”¨å¤–éƒ¨å¯†é’¥ç®¡ç†** | Vaultã€AWS Secrets Manager |
| âŒ **é¿å…Secretæ˜æ–‡å­˜å‚¨åœ¨Git** | ä½¿ç”¨SealedSecrets |
| âŒ **é¿å…åœ¨æ—¥å¿—ä¸­æ‰“å°Secret** | å®¡æŸ¥åº”ç”¨ä»£ç  |

---

### 5.2.5 downwardAPI - Podå…ƒæ•°æ®æ³¨å…¥

**æ¦‚å¿µï¼š**

downwardAPIå…è®¸Podè®¿é—®è‡ªå·±çš„å…ƒæ•°æ®ï¼ˆPodåç§°ã€å‘½åç©ºé—´ã€æ ‡ç­¾ã€èµ„æºé™åˆ¶ç­‰ï¼‰ï¼Œæ— éœ€è°ƒç”¨Kubernetes APIã€‚

**å¯ç”¨å­—æ®µï¼š**

| å­—æ®µç±»åˆ« | å¯ç”¨å­—æ®µ | ç¤ºä¾‹å€¼ |
|---------|---------|--------|
| **Podä¿¡æ¯** | `metadata.name` | my-pod |
| | `metadata.namespace` | default |
| | `metadata.uid` | abc-123-def |
| | `metadata.labels['<KEY>']` | app=nginx |
| | `metadata.annotations['<KEY>']` | version=1.0 |
| **èµ„æºä¿¡æ¯** | `requests.cpu` | 100m |
| | `requests.memory` | 128Mi |
| | `limits.cpu` | 500m |
| | `limits.memory` | 512Mi |
| **å…¶ä»–** | `spec.serviceAccountName` | default |
| | `spec.nodeName` | worker-node1 |
| | `status.podIP` | 10.244.1.5 |
| | `status.hostIP` | 192.168.1.100 |

**ä½¿ç”¨æ–¹å¼1ï¼šä½œä¸ºç¯å¢ƒå˜é‡**

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: downwardapi-env
  labels:
    app: nginx
    tier: frontend
  annotations:
    version: "1.0"
spec:
  containers:
  - name: app
    image: busybox
    command: ['sh', '-c', 'env && sleep 3600']
    env:
    # Podåç§°
    - name: POD_NAME
      valueFrom:
        fieldRef:
          fieldPath: metadata.name

    # Podå‘½åç©ºé—´
    - name: POD_NAMESPACE
      valueFrom:
        fieldRef:
          fieldPath: metadata.namespace

    # Pod IP
    - name: POD_IP
      valueFrom:
        fieldRef:
          fieldPath: status.podIP

    # Nodeåç§°
    - name: NODE_NAME
      valueFrom:
        fieldRef:
          fieldPath: spec.nodeName

    # æ ‡ç­¾
    - name: APP_LABEL
      valueFrom:
        fieldRef:
          fieldPath: metadata.labels['app']

    # CPUè¯·æ±‚
    - name: CPU_REQUEST
      valueFrom:
        resourceFieldRef:
          containerName: app
          resource: requests.cpu

    # å†…å­˜é™åˆ¶
    - name: MEM_LIMIT
      valueFrom:
        resourceFieldRef:
          containerName: app
          resource: limits.memory

    resources:
      requests:
        cpu: 100m
        memory: 128Mi
      limits:
        cpu: 500m
        memory: 512Mi
```

**æµ‹è¯•ï¼š**

```bash
kubectl apply -f downwardapi-env.yaml

# æŸ¥çœ‹ç¯å¢ƒå˜é‡
kubectl logs downwardapi-env | grep -E "POD_|NODE_|APP_|CPU_|MEM_"
# POD_NAME=downwardapi-env
# POD_NAMESPACE=default
# POD_IP=10.244.1.15
# NODE_NAME=worker-node1
# APP_LABEL=nginx
# CPU_REQUEST=1        # 100m = 0.1æ ¸å¿ƒ
# MEM_LIMIT=536870912  # 512Mi = 512 * 1024 * 1024 bytes
```

**ä½¿ç”¨æ–¹å¼2ï¼šä½œä¸ºVolumeæŒ‚è½½**

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: downwardapi-volume
  labels:
    app: nginx
    env: prod
  annotations:
    build: "2024-12-24"
    version: "v1.2.3"
spec:
  containers:
  - name: app
    image: busybox
    command: ['sh', '-c', 'cat /etc/podinfo/* && sleep 3600']
    volumeMounts:
    - name: podinfo
      mountPath: /etc/podinfo
    resources:
      requests:
        cpu: 100m
        memory: 64Mi
      limits:
        cpu: 200m
        memory: 128Mi

  volumes:
  - name: podinfo
    downwardAPI:
      items:
      # Podåç§°
      - path: "pod-name"
        fieldRef:
          fieldPath: metadata.name

      # Podå‘½åç©ºé—´
      - path: "pod-namespace"
        fieldRef:
          fieldPath: metadata.namespace

      # æ‰€æœ‰æ ‡ç­¾ï¼ˆJSONæ ¼å¼ï¼‰
      - path: "labels"
        fieldRef:
          fieldPath: metadata.labels

      # æ‰€æœ‰æ³¨è§£ï¼ˆJSONæ ¼å¼ï¼‰
      - path: "annotations"
        fieldRef:
          fieldPath: metadata.annotations

      # CPUé™åˆ¶
      - path: "cpu-limit"
        resourceFieldRef:
          containerName: app
          resource: limits.cpu
          divisor: 1m    # ä»¥æ¯«æ ¸ä¸ºå•ä½

      # å†…å­˜è¯·æ±‚
      - path: "memory-request"
        resourceFieldRef:
          containerName: app
          resource: requests.memory
          divisor: 1Mi   # ä»¥MiBä¸ºå•ä½
```

**æµ‹è¯•ï¼š**

```bash
kubectl apply -f downwardapi-volume.yaml

# æŸ¥çœ‹ç”Ÿæˆçš„æ–‡ä»¶
kubectl exec downwardapi-volume -- ls -la /etc/podinfo
# total 28
# drwxrwxrwt 3 root root  180 Dec 24 11:30 .
# drwxr-xr-x 1 root root 4096 Dec 24 11:30 ..
# drwxr-xr-x 2 root root  160 Dec 24 11:30 ..data
# lrwxrwxrwx 1 root root   18 Dec 24 11:30 annotations -> ..data/annotations
# lrwxrwxrwx 1 root root   18 Dec 24 11:30 cpu-limit -> ..data/cpu-limit
# lrwxrwxrwx 1 root root   14 Dec 24 11:30 labels -> ..data/labels
# lrwxrwxrwx 1 root root   22 Dec 24 11:30 memory-request -> ..data/memory-request
# lrwxrwxrwx 1 root root   16 Dec 24 11:30 pod-name -> ..data/pod-name
# lrwxrwxrwx 1 root root   21 Dec 24 11:30 pod-namespace -> ..data/pod-namespace

# æŸ¥çœ‹å†…å®¹
kubectl exec downwardapi-volume -- cat /etc/podinfo/pod-name
# downwardapi-volume

kubectl exec downwardapi-volume -- cat /etc/podinfo/labels
# app="nginx"
# env="prod"

kubectl exec downwardapi-volume -- cat /etc/podinfo/annotations
# build="2024-12-24"
# version="v1.2.3"
# kubernetes.io/config.seen="..."

kubectl exec downwardapi-volume -- cat /etc/podinfo/cpu-limit
# 200  # 200m

kubectl exec downwardapi-volume -- cat /etc/podinfo/memory-request
# 64  # 64Mi
```

**å®æˆ˜æ¡ˆä¾‹ï¼šåº”ç”¨è‡ªåŠ¨å‘ç°é…ç½®**

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: app-with-metadata
  labels:
    app: myapp
    version: v1
    env: production
spec:
  containers:
  - name: app
    image: busybox
    command:
    - sh
    - -c
    - |
      # è¯»å–Podå…ƒæ•°æ®
      POD_NAME=$(cat /etc/podinfo/name)
      POD_NAMESPACE=$(cat /etc/podinfo/namespace)
      POD_IP=$(cat /etc/podinfo/ip)
      APP_VERSION=$(cat /etc/podinfo/version)

      # æ„é€ æ—¥å¿—å‰ç¼€
      LOG_PREFIX="[$POD_NAMESPACE/$POD_NAME@$POD_IP v$APP_VERSION]"

      # åº”ç”¨æ—¥å¿—
      while true; do
        echo "$LOG_PREFIX Application is running..."
        sleep 5
      done

    volumeMounts:
    - name: podinfo
      mountPath: /etc/podinfo

    env:
    - name: POD_IP
      valueFrom:
        fieldRef:
          fieldPath: status.podIP

  volumes:
  - name: podinfo
    downwardAPI:
      items:
      - path: "name"
        fieldRef:
          fieldPath: metadata.name
      - path: "namespace"
        fieldRef:
          fieldPath: metadata.namespace
      - path: "ip"
        fieldRef:
          fieldPath: status.podIP
      - path: "version"
        fieldRef:
          fieldPath: metadata.labels['version']
```

**æŸ¥çœ‹æ—¥å¿—ï¼š**

```bash
kubectl logs app-with-metadata
# [default/app-with-metadata@10.244.1.20 vv1] Application is running...
# [default/app-with-metadata@10.244.1.20 vv1] Application is running...
```

**downwardAPIä½¿ç”¨åœºæ™¯ï¼š**

| åœºæ™¯ | ä½¿ç”¨çš„å­—æ®µ | ç¤ºä¾‹ |
|-----|----------|------|
| **æ—¥å¿—æ ‡è¯†** | Podåç§°ã€å‘½åç©ºé—´ | æ—¥å¿—å‰ç¼€ |
| **æœåŠ¡å‘ç°** | Pod IPã€æ ‡ç­¾ | æ³¨å†Œåˆ°æœåŠ¡æ³¨å†Œä¸­å¿ƒ |
| **èµ„æºè‡ªé€‚åº”** | CPU/å†…å­˜é™åˆ¶ | æ ¹æ®é™åˆ¶è°ƒæ•´çº¿ç¨‹æ± å¤§å° |
| **è“ç»¿éƒ¨ç½²** | æ ‡ç­¾ï¼ˆversionï¼‰ | åº”ç”¨å†…åˆ¤æ–­ç‰ˆæœ¬ |
| **ç›‘æ§ä¸ŠæŠ¥** | æ‰€æœ‰å…ƒæ•°æ® | ä¸ŠæŠ¥åˆ°Prometheus |

---

### 5.2.6 projected - ç»„åˆå·

**æ¦‚å¿µï¼š**

projectedå·å¯ä»¥å°†å¤šä¸ªVolumeæºï¼ˆSecretã€ConfigMapã€downwardAPIã€ServiceAccountTokenï¼‰ç»„åˆåˆ°åŒä¸€ä¸ªç›®å½•ä¸­ã€‚

**ä½¿ç”¨åœºæ™¯ï¼š**

- åº”ç”¨åŒæ—¶éœ€è¦é…ç½®æ–‡ä»¶ï¼ˆConfigMapï¼‰å’Œå¯†ç ï¼ˆSecretï¼‰
- éœ€è¦å°†ServiceAccount Tokenã€CAè¯ä¹¦ã€å‘½åç©ºé—´ä¿¡æ¯ç»„åˆåœ¨ä¸€èµ·

**ç¤ºä¾‹1ï¼šç»„åˆSecretå’ŒConfigMap**

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: projected-demo
spec:
  containers:
  - name: app
    image: busybox
    command: ['sh', '-c', 'ls -la /projected && cat /projected/* && sleep 3600']
    volumeMounts:
    - name: all-in-one
      mountPath: /projected

  volumes:
  - name: all-in-one
    projected:
      sources:
      # æ¥æº1ï¼šConfigMap
      - configMap:
          name: app-config
          items:
          - key: DB_HOST
            path: config/db-host

      # æ¥æº2ï¼šSecret
      - secret:
          name: db-secret
          items:
          - key: password
            path: secrets/db-password

      # æ¥æº3ï¼šdownwardAPI
      - downwardAPI:
          items:
          - path: "metadata/pod-name"
            fieldRef:
              fieldPath: metadata.name
          - path: "metadata/namespace"
            fieldRef:
              fieldPath: metadata.namespace
```

**åˆ›å»ºä¾èµ–èµ„æºï¼š**

```bash
# åˆ›å»ºConfigMap
kubectl create configmap app-config --from-literal=DB_HOST=mysql.default

# åˆ›å»ºSecret
kubectl create secret generic db-secret --from-literal=password=MyP@ss

# åˆ›å»ºPod
kubectl apply -f projected-demo.yaml
```

**æŸ¥çœ‹ç»„åˆç»“æœï¼š**

```bash
# æŸ¥çœ‹ç›®å½•ç»“æ„
kubectl exec projected-demo -- ls -R /projected
# /projected:
# config
# metadata
# secrets
#
# /projected/config:
# db-host
#
# /projected/metadata:
# namespace
# pod-name
#
# /projected/secrets:
# db-password

# æŸ¥çœ‹æ‰€æœ‰å†…å®¹
kubectl exec projected-demo -- sh -c 'find /projected -type f -exec echo "=== {} ===" \; -exec cat {} \;'
# === /projected/config/db-host ===
# mysql.default
# === /projected/secrets/db-password ===
# MyP@ss
# === /projected/metadata/pod-name ===
# projected-demo
# === /projected/metadata/namespace ===
# default
```

**ç¤ºä¾‹2ï¼šServiceAccountTokenæŠ•å°„ï¼ˆKubernetes 1.20+ï¼‰**

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: sa-token-demo
spec:
  serviceAccountName: default
  containers:
  - name: app
    image: busybox
    command: ['sh', '-c', 'cat /var/run/secrets/tokens/api-token && sleep 3600']
    volumeMounts:
    - name: token
      mountPath: /var/run/secrets/tokens

  volumes:
  - name: token
    projected:
      sources:
      - serviceAccountToken:
          path: api-token
          expirationSeconds: 3600      # Tokenæœ‰æ•ˆæœŸ1å°æ—¶
          audience: api-server          # Tokençš„å—ä¼—
```

**éªŒè¯Tokenï¼š**

```bash
kubectl apply -f sa-token-demo.yaml

# æŸ¥çœ‹Token
kubectl exec sa-token-demo -- cat /var/run/secrets/tokens/api-token
# eyJhbGciOiJSUzI1NiIsImtpZCI6Ii...

# è§£ç Tokenï¼ˆJWTæ ¼å¼ï¼‰
TOKEN=$(kubectl exec sa-token-demo -- cat /var/run/secrets/tokens/api-token)
echo $TOKEN | cut -d'.' -f2 | base64 -d 2>/dev/null | jq .
# {
#   "aud": ["api-server"],
#   "exp": 1703422800,
#   "iat": 1703419200,
#   "iss": "kubernetes/serviceaccount",
#   "kubernetes.io": {
#     "namespace": "default",
#     "pod": {
#       "name": "sa-token-demo",
#       "uid": "abc-123-def"
#     },
#     "serviceaccount": {
#       "name": "default",
#       "uid": "def-456-ghi"
#     }
#   },
#   "sub": "system:serviceaccount:default:default"
# }
```

**projectedå·çš„ä¼˜åŠ¿ï¼š**

```
âœ… ä¼˜åŠ¿ï¼š
1. ç»Ÿä¸€æŒ‚è½½ç‚¹ï¼šå¤šä¸ªæºæŒ‚è½½åˆ°åŒä¸€ç›®å½•
2. é¿å…è·¯å¾„å†²çªï¼šé€šè¿‡pathå‚æ•°æ§åˆ¶æ–‡ä»¶è·¯å¾„
3. ç®€åŒ–é…ç½®ï¼šä¸éœ€è¦å¤šä¸ªvolumeMounts
4. æ”¯æŒTokenè½®æ¢ï¼šServiceAccountTokenè‡ªåŠ¨æ›´æ–°

âŒ é™åˆ¶ï¼š
- ä¸æ”¯æŒsubPath
- æ‰€æœ‰æºå¿…é¡»æ¥è‡ªåŒä¸€å‘½åç©ºé—´
- æœ€å¤šæ”¯æŒ20ä¸ªæº
```

**projectedå·æœ€ä½³å®è·µï¼š**

```yaml
# âœ… æ¨èï¼šåº”ç”¨è¿è¡Œæ—¶æ‰€éœ€çš„æ‰€æœ‰é…ç½®ç»„åˆåœ¨ä¸€èµ·
volumes:
- name: app-context
  projected:
    defaultMode: 0440  # åªè¯»æƒé™
    sources:
    - configMap:
        name: app-config
    - secret:
        name: app-secret
    - downwardAPI:
        items:
        - path: metadata
          fieldRef:
            fieldPath: metadata.labels

# âœ… æ¨èï¼šå®‰å…¨APIè®¿é—®
volumes:
- name: kube-api-access
  projected:
    sources:
    - serviceAccountToken:
        path: token
        expirationSeconds: 3600
    - configMap:
        name: kube-root-ca.crt
        items:
        - key: ca.crt
          path: ca.crt
    - downwardAPI:
        items:
        - path: namespace
          fieldRef:
            fieldPath: metadata.namespace
```

**æœ¬èŠ‚å°ç»“ï¼š**

æˆ‘ä»¬è¯¦ç»†å­¦ä¹ äº†6ç§å¸¸ç”¨çš„Volumeç±»å‹ï¼š

| Volumeç±»å‹ | ç”Ÿå‘½å‘¨æœŸ | é€‚ç”¨åœºæ™¯ | å…¸å‹ç”¨é€” |
|-----------|---------|---------|---------|
| **emptyDir** | ä¸Podç»‘å®š | ä¸´æ—¶å­˜å‚¨ | ç¼“å­˜ã€å®¹å™¨é—´å…±äº« |
| **hostPath** | ä¸Nodeç»‘å®š | èŠ‚ç‚¹æ•°æ® | æ—¥å¿—æ”¶é›†ã€ç³»ç»Ÿç›‘æ§ |
| **ConfigMap** | ç‹¬ç«‹äºPod | é…ç½®ç®¡ç† | åº”ç”¨é…ç½®æ–‡ä»¶ |
| **Secret** | ç‹¬ç«‹äºPod | å¯†é’¥ç®¡ç† | å¯†ç ã€è¯ä¹¦ |
| **downwardAPI** | åŠ¨æ€ç”Ÿæˆ | å…ƒæ•°æ®æ³¨å…¥ | Podä¿¡æ¯ã€æ ‡ç­¾ |
| **projected** | ç»„åˆå¤šæº | ç»Ÿä¸€æŒ‚è½½ | é…ç½®+å¯†é’¥+å…ƒæ•°æ® |

æ¥ä¸‹æ¥æˆ‘ä»¬å°†å­¦ä¹ æ›´å¼ºå¤§çš„æŒä¹…åŒ–å­˜å‚¨æœºåˆ¶ï¼šPersistentVolumeå’ŒPersistentVolumeClaimã€‚

---


## 5.3 PersistentVolumeå’ŒPersistentVolumeClaim

åœ¨ä¸Šä¸€èŠ‚ä¸­ï¼Œæˆ‘ä»¬å­¦ä¹ äº†emptyDirã€hostPathç­‰Volumeç±»å‹ï¼Œå®ƒä»¬çš„å…±åŒé—®é¢˜æ˜¯ï¼š**æ•°æ®çš„ç”Ÿå‘½å‘¨æœŸä¸Podæˆ–Nodeç»‘å®šï¼Œæ— æ³•å®ç°çœŸæ­£çš„æŒä¹…åŒ–**ã€‚PersistentVolume (PV) å’ŒPersistentVolumeClaim (PVC) è§£å†³äº†è¿™ä¸ªé—®é¢˜ã€‚

### 5.3.1 ä¸ºä»€ä¹ˆéœ€è¦PVå’ŒPVC

**ä¼ ç»ŸVolumeçš„é—®é¢˜ï¼š**

```
åœºæ™¯1ï¼šMySQL Podä½¿ç”¨hostPath
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Node1                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚  â”‚ MySQL Pod  â”‚                     â”‚
â”‚  â”‚ hostPath:  â”‚                     â”‚
â”‚  â”‚ /data/mysqlâ”‚ â”€> [æœ¬åœ°ç£ç›˜]       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

é—®é¢˜ï¼šPodè¿ç§»åˆ°Node2åï¼Œæ— æ³•è®¿é—®Node1çš„æ•°æ®
      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Node2                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚  â”‚ MySQL Pod  â”‚  âŒ æ•°æ®ä¸¢å¤±ï¼      â”‚
â”‚  â”‚ hostPath:  â”‚                     â”‚
â”‚  â”‚ /data/mysqlâ”‚ â”€> [ç©ºç›®å½•]         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


åœºæ™¯2ï¼šå¼€å‘äººå‘˜ç›´æ¥ä½¿ç”¨NFS
apiVersion: v1
kind: Pod
spec:
  volumes:
  - name: data
    nfs:
      server: 192.168.1.100    # âŒ ç¡¬ç¼–ç NFSæœåŠ¡å™¨åœ°å€
      path: /exports/data      # âŒ éœ€è¦çŸ¥é“å­˜å‚¨ç»†èŠ‚

é—®é¢˜ï¼š
1. å¼€å‘äººå‘˜éœ€è¦çŸ¥é“å­˜å‚¨ç³»ç»Ÿçš„å®ç°ç»†èŠ‚
2. å­˜å‚¨åœ°å€ç¡¬ç¼–ç åœ¨YAMLä¸­
3. æ— æ³•ç»Ÿä¸€ç®¡ç†å’Œåˆ†é…å­˜å‚¨èµ„æº
```

**PV/PVCè§£å†³æ–¹æ¡ˆï¼š**

```
PV/PVCæ¶æ„ï¼šå­˜å‚¨ä¸ä½¿ç”¨è§£è€¦

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å­˜å‚¨ç®¡ç†å‘˜                              â”‚
â”‚  - æå‰åˆ›å»ºPVï¼ˆæˆ–é…ç½®StorageClassè‡ªåŠ¨åˆ›å»ºï¼‰                â”‚
â”‚  - ç®¡ç†åº•å±‚å­˜å‚¨ï¼ˆNFS/Ceph/äº‘å­˜å‚¨ï¼‰                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼ åˆ›å»ºPV
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               PersistentVolume (PV)                       â”‚
â”‚  - é›†ç¾¤çº§èµ„æºï¼ˆä¸å±äºä»»ä½•å‘½åç©ºé—´ï¼‰                         â”‚
â”‚  - æŠ½è±¡åº•å±‚å­˜å‚¨å®ç°ï¼ˆNFS/iSCSI/äº‘å­˜å‚¨ç­‰ï¼‰                  â”‚
â”‚  - å®šä¹‰å­˜å‚¨å®¹é‡ã€è®¿é—®æ¨¡å¼ã€å›æ”¶ç­–ç•¥                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼ ç»‘å®š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          PersistentVolumeClaim (PVC)                      â”‚
â”‚  - å‘½åç©ºé—´çº§èµ„æº                                          â”‚
â”‚  - ç”¨æˆ·çš„å­˜å‚¨ç”³è¯·ï¼ˆ"æˆ‘éœ€è¦10GBçš„RWOå­˜å‚¨"ï¼‰                 â”‚
â”‚  - ä¸éœ€è¦çŸ¥é“å­˜å‚¨çš„å…·ä½“å®ç°                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼ ä½¿ç”¨
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       Pod                                 â”‚
â”‚  volumes:                                                 â”‚
â”‚  - name: data                                             â”‚
â”‚    persistentVolumeClaim:                                 â”‚
â”‚      claimName: mysql-pvc  # åªéœ€è¦æŒ‡å®šPVCåç§°            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**PV/PVCçš„ä¼˜åŠ¿ï¼š**

| ä¼˜åŠ¿ | è¯´æ˜ |
|-----|------|
| âœ… **èŒè´£åˆ†ç¦»** | ç®¡ç†å‘˜ç®¡ç†å­˜å‚¨ï¼Œå¼€å‘è€…ä½¿ç”¨å­˜å‚¨ |
| âœ… **å­˜å‚¨æŠ½è±¡** | ç”¨æˆ·ä¸éœ€è¦çŸ¥é“åº•å±‚å­˜å‚¨å®ç° |
| âœ… **èµ„æºå¤ç”¨** | PVå¯ä»¥è¢«ä¸åŒçš„Podä¾æ¬¡ä½¿ç”¨ |
| âœ… **ç‹¬ç«‹ç”Ÿå‘½å‘¨æœŸ** | æ•°æ®ç‹¬ç«‹äºPodå’ŒNode |
| âœ… **ç»Ÿä¸€ç®¡ç†** | é›†ä¸­ç®¡ç†å­˜å‚¨èµ„æºçš„åˆ†é…å’Œå›æ”¶ |

---

### 5.3.2 PersistentVolume (PV) è¯¦è§£

**PVæ˜¯ä»€ä¹ˆï¼Ÿ**

PVæ˜¯é›†ç¾¤çº§çš„å­˜å‚¨èµ„æºï¼Œç”±ç®¡ç†å‘˜åˆ›å»ºæˆ–é€šè¿‡StorageClassåŠ¨æ€åˆ›å»ºã€‚å®ƒä»£è¡¨äº†å®é™…çš„å­˜å‚¨å·ï¼ˆNFSå…±äº«ã€iSCSI LUNã€äº‘ç›˜ç­‰ï¼‰ã€‚

**PVçš„æ ¸å¿ƒå±æ€§ï¼š**

```yaml
apiVersion: v1
kind: PersistentVolume
metadata:
  name: pv-nfs-001
spec:
  # 1. å®¹é‡
  capacity:
    storage: 10Gi

  # 2. è®¿é—®æ¨¡å¼
  accessModes:
  - ReadWriteOnce   # RWO: å•èŠ‚ç‚¹è¯»å†™
  # - ReadOnlyMany  # ROX: å¤šèŠ‚ç‚¹åªè¯»
  # - ReadWriteMany # RWX: å¤šèŠ‚ç‚¹è¯»å†™

  # 3. å›æ”¶ç­–ç•¥
  persistentVolumeReclaimPolicy: Retain  # Retain/Delete/Recycle

  # 4. å­˜å‚¨ç±»
  storageClassName: nfs-storage

  # 5. æŒ‚è½½é€‰é¡¹
  mountOptions:
  - hard
  - nfsvers=4.1

  # 6. åº•å±‚å­˜å‚¨å®ç°ï¼ˆé€‰æ‹©ä¸€ç§ï¼‰
  nfs:
    server: 192.168.1.100
    path: /exports/data001
```

**è®¿é—®æ¨¡å¼è¯¦è§£ï¼š**

| è®¿é—®æ¨¡å¼ | ç®€å†™ | è¯´æ˜ | æ”¯æŒçš„å­˜å‚¨ | å…¸å‹ä½¿ç”¨åœºæ™¯ |
|---------|------|------|----------|-------------|
| **ReadWriteOnce** | RWO | å•ä¸ªèŠ‚ç‚¹è¯»å†™ | æ‰€æœ‰å­˜å‚¨ | MySQLã€PostgreSQL |
| **ReadOnlyMany** | ROX | å¤šä¸ªèŠ‚ç‚¹åªè¯» | NFSã€CephFS | é™æ€ç½‘ç«™ã€é…ç½®æ–‡ä»¶ |
| **ReadWriteMany** | RWX | å¤šä¸ªèŠ‚ç‚¹è¯»å†™ | NFSã€CephFSã€GlusterFS | å…±äº«æ–‡ä»¶ç³»ç»Ÿã€æ—¥å¿—èšåˆ |
| **ReadWriteOncePod** | RWOP | å•ä¸ªPodè¯»å†™ï¼ˆK8s 1.22+ï¼‰ | CSIé©±åŠ¨æ”¯æŒ | ä¸¥æ ¼å•å®ä¾‹åº”ç”¨ |

**æ³¨æ„ï¼š**
- RWOé™åˆ¶çš„æ˜¯èŠ‚ç‚¹ï¼Œä¸æ˜¯Podã€‚åŒä¸€èŠ‚ç‚¹ä¸Šçš„å¤šä¸ªPodå¯ä»¥åŒæ—¶ä½¿ç”¨RWOçš„PV
- äº‘ç›˜ï¼ˆAWS EBSã€Azure Diskï¼‰é€šå¸¸åªæ”¯æŒRWO
- NFS/CephFSæ”¯æŒRWX

**å›æ”¶ç­–ç•¥è¯¦è§£ï¼š**

| ç­–ç•¥ | è¡Œä¸º | é€‚ç”¨åœºæ™¯ |
|-----|------|---------|
| **Retain** | PVCåˆ é™¤åï¼ŒPVä¿ç•™ï¼Œæ•°æ®ä¸åˆ é™¤ï¼Œéœ€æ‰‹åŠ¨æ¸…ç† | ç”Ÿäº§ç¯å¢ƒï¼ˆé˜²æ­¢è¯¯åˆ ï¼‰ |
| **Delete** | PVCåˆ é™¤åï¼ŒPVå’Œåº•å±‚å­˜å‚¨ä¸€èµ·åˆ é™¤ | åŠ¨æ€ä¾›ç»™ï¼ˆStorageClassï¼‰ |
| **Recycle** | åˆ é™¤æ•°æ®ï¼ˆrm -rfï¼‰ä½†ä¿ç•™PVï¼ˆå·²åºŸå¼ƒï¼‰ | ä¸æ¨è |

**åˆ›å»ºNFS PVç¤ºä¾‹ï¼š**

```yaml
apiVersion: v1
kind: PersistentVolume
metadata:
  name: pv-nfs-001
spec:
  capacity:
    storage: 10Gi
  accessModes:
  - ReadWriteMany          # NFSæ”¯æŒå¤šèŠ‚ç‚¹è¯»å†™
  persistentVolumeReclaimPolicy: Retain
  storageClassName: nfs-storage
  nfs:
    server: 192.168.1.100  # NFSæœåŠ¡å™¨åœ°å€
    path: /exports/pv001   # NFSå¯¼å‡ºè·¯å¾„
```

**åˆ›å»ºHostPath PVç¤ºä¾‹ï¼ˆä»…ç”¨äºæµ‹è¯•ï¼‰ï¼š**

```yaml
apiVersion: v1
kind: PersistentVolume
metadata:
  name: pv-hostpath-001
spec:
  capacity:
    storage: 5Gi
  accessModes:
  - ReadWriteOnce          # hostPathåªæ”¯æŒå•èŠ‚ç‚¹
  persistentVolumeReclaimPolicy: Retain
  storageClassName: hostpath
  hostPath:
    path: /mnt/data        # èŠ‚ç‚¹ä¸Šçš„è·¯å¾„
    type: DirectoryOrCreate
```

**åˆ›å»ºiSCSI PVç¤ºä¾‹ï¼š**

```yaml
apiVersion: v1
kind: PersistentVolume
metadata:
  name: pv-iscsi-001
spec:
  capacity:
    storage: 20Gi
  accessModes:
  - ReadWriteOnce
  persistentVolumeReclaimPolicy: Retain
  iscsi:
    targetPortal: 10.0.0.10:3260
    iqn: iqn.2024-01.com.example:storage.target01
    lun: 0
    fsType: ext4
    readOnly: false
```

**æŸ¥çœ‹PVï¼š**

```bash
# åˆ›å»ºPV
kubectl apply -f pv-nfs.yaml

# æŸ¥çœ‹PV
kubectl get pv
# NAME          CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS      CLAIM   STORAGECLASS
# pv-nfs-001    10Gi       RWX            Retain           Available           nfs-storage
#                                                          â†‘ Available: æœªç»‘å®šçŠ¶æ€

# æŸ¥çœ‹PVè¯¦æƒ…
kubectl describe pv pv-nfs-001
# Name:            pv-nfs-001
# Labels:          <none>
# Annotations:     <none>
# Finalizers:      [kubernetes.io/pv-protection]
# StorageClass:    nfs-storage
# Status:          Available
# Claim:
# Reclaim Policy:  Retain
# Access Modes:    RWX
# Capacity:        10Gi
# Node Affinity:   <none>
# Message:
# Source:
#     Type:      NFS (an NFS mount that lasts the lifetime of a pod)
#     Server:    192.168.1.100
#     Path:      /exports/pv001
#     ReadOnly:  false
```

---

### 5.3.3 PersistentVolumeClaim (PVC) è¯¦è§£

**PVCæ˜¯ä»€ä¹ˆï¼Ÿ**

PVCæ˜¯ç”¨æˆ·å¯¹å­˜å‚¨çš„ç”³è¯·ï¼Œç±»ä¼¼äºPodå¯¹è®¡ç®—èµ„æºçš„ç”³è¯·ã€‚ç”¨æˆ·é€šè¿‡PVCæè¿°éœ€æ±‚ï¼ˆå®¹é‡ã€è®¿é—®æ¨¡å¼ï¼‰ï¼ŒKubernetesä¼šè‡ªåŠ¨åŒ¹é…åˆé€‚çš„PVå¹¶ç»‘å®šã€‚

**PVCçš„æ ¸å¿ƒå±æ€§ï¼š**

```yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: mysql-pvc
  namespace: default
spec:
  # 1. è®¿é—®æ¨¡å¼ï¼ˆå¿…é¡»ä¸PVçš„è®¿é—®æ¨¡å¼åŒ¹é…ï¼‰
  accessModes:
  - ReadWriteOnce

  # 2. èµ„æºè¯·æ±‚
  resources:
    requests:
      storage: 8Gi    # è¯·æ±‚8GBå­˜å‚¨

  # 3. å­˜å‚¨ç±»ï¼ˆå¯é€‰ï¼‰
  storageClassName: nfs-storage

  # 4. é€‰æ‹©å™¨ï¼ˆå¯é€‰ï¼Œç”¨äºç²¾ç¡®åŒ¹é…PVï¼‰
  selector:
    matchLabels:
      environment: production
    matchExpressions:
    - key: tier
      operator: In
      values: [database]
```

**åˆ›å»ºPVCç¤ºä¾‹ï¼š**

```yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: mysql-pvc
  namespace: default
spec:
  accessModes:
  - ReadWriteOnce
  resources:
    requests:
      storage: 5Gi
  storageClassName: nfs-storage
```

**æŸ¥çœ‹PVCï¼š**

```bash
# åˆ›å»ºPVC
kubectl apply -f pvc-mysql.yaml

# æŸ¥çœ‹PVC
kubectl get pvc
# NAME        STATUS   VOLUME        CAPACITY   ACCESS MODES   STORAGECLASS
# mysql-pvc   Bound    pv-nfs-001    10Gi       RWX            nfs-storage
#             â†‘ Bound: å·²ç»‘å®šåˆ°PV

# æŸ¥çœ‹PVCè¯¦æƒ…
kubectl describe pvc mysql-pvc
# Name:          mysql-pvc
# Namespace:     default
# StorageClass:  nfs-storage
# Status:        Bound
# Volume:        pv-nfs-001
# Labels:        <none>
# Annotations:   pv.kubernetes.io/bind-completed: yes
# Finalizers:    [kubernetes.io/pvc-protection]
# Capacity:      10Gi
# Access Modes:  RWX
```

---

### 5.3.4 PVå’ŒPVCçš„ç»‘å®šæœºåˆ¶

**ç»‘å®šè§„åˆ™ï¼š**

Kubernetesä¼šæ ¹æ®ä»¥ä¸‹æ¡ä»¶è‡ªåŠ¨åŒ¹é…PVå’ŒPVCï¼š

1. **StorageClassåŒ¹é…**ï¼šPVCå’ŒPVçš„storageClassNameå¿…é¡»ç›¸åŒï¼ˆæˆ–éƒ½ä¸ºç©ºï¼‰
2. **è®¿é—®æ¨¡å¼åŒ¹é…**ï¼šPVçš„accessModeså¿…é¡»åŒ…å«PVCè¯·æ±‚çš„æ¨¡å¼
3. **å®¹é‡æ»¡è¶³**ï¼šPVçš„å®¹é‡ â‰¥ PVCè¯·æ±‚çš„å®¹é‡
4. **é€‰æ‹©å™¨åŒ¹é…**ï¼ˆå¦‚æœPVCå®šä¹‰äº†selectorï¼‰

**ç»‘å®šè¿‡ç¨‹ï¼š**

```
1. åˆ›å»ºPV
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PV: pv-nfs-001      â”‚
â”‚  Capacity: 10Gi      â”‚
â”‚  AccessModes: RWX    â”‚
â”‚  Status: Available   â”‚  â† ç­‰å¾…ç»‘å®š
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

2. åˆ›å»ºPVC
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PVC: mysql-pvc      â”‚
â”‚  Request: 5Gi        â”‚
â”‚  AccessModes: RWX    â”‚
â”‚  Status: Pending     â”‚  â† å¯»æ‰¾åˆé€‚çš„PV
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

3. è‡ªåŠ¨ç»‘å®š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PV: pv-nfs-001      â”‚
â”‚  Capacity: 10Gi      â”‚
â”‚  Status: Bound       â”‚ â†â”
â”‚  Claim: default/     â”‚  â”‚ åŒå‘ç»‘å®š
â”‚         mysql-pvc    â”‚  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
                          â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  PVC: mysql-pvc      â”‚  â”‚
â”‚  Request: 5Gi        â”‚  â”‚
â”‚  Status: Bound       â”‚ â”€â”˜
â”‚  Volume: pv-nfs-001  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

4. Podä½¿ç”¨PVC
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Pod: mysql          â”‚
â”‚  volumes:            â”‚
â”‚  - persistentVolume  â”‚
â”‚    Claim:            â”‚
â”‚      claimName:      â”‚
â”‚        mysql-pvc     â”‚ â”€> ä½¿ç”¨ç»‘å®šçš„PV
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ç»‘å®šç¤ºä¾‹æ¼”ç¤ºï¼š**

```bash
# 1. åˆ›å»ºPV
cat <<EOF | kubectl apply -f -
apiVersion: v1
kind: PersistentVolume
metadata:
  name: pv-demo
spec:
  capacity:
    storage: 10Gi
  accessModes:
  - ReadWriteOnce
  persistentVolumeReclaimPolicy: Retain
  storageClassName: manual
  hostPath:
    path: /mnt/data
EOF

# æŸ¥çœ‹PVçŠ¶æ€
kubectl get pv pv-demo
# NAME      CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS      CLAIM
# pv-demo   10Gi       RWO            Retain           Available
#                                                       â†‘ æœªç»‘å®š

# 2. åˆ›å»ºPVC
cat <<EOF | kubectl apply -f -
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: pvc-demo
spec:
  accessModes:
  - ReadWriteOnce
  resources:
    requests:
      storage: 5Gi
  storageClassName: manual
EOF

# æŸ¥çœ‹ç»‘å®šç»“æœ
kubectl get pv pv-demo
# NAME      CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM
# pv-demo   10Gi       RWO            Retain           Bound    default/pvc-demo
#                                                       â†‘ å·²ç»‘å®š

kubectl get pvc pvc-demo
# NAME       STATUS   VOLUME    CAPACITY   ACCESS MODES
# pvc-demo   Bound    pv-demo   10Gi       RWO
#            â†‘ å·²ç»‘å®š
```

**ç»‘å®šå¤±è´¥çš„å¸¸è§åŸå› ï¼š**

```bash
# åœºæ™¯1ï¼šæ²¡æœ‰åˆé€‚çš„PV
kubectl get pvc
# NAME       STATUS    VOLUME   CAPACITY   ACCESS MODES
# my-pvc     Pending                        # â† é•¿æ—¶é—´Pending
#            â†‘ æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„PV

kubectl describe pvc my-pvc
# Events:
#   Type     Reason              Message
#   ----     ------              -------
#   Warning  ProvisioningFailed  no persistent volumes available for this claim

# è§£å†³æ–¹æ¡ˆï¼šåˆ›å»ºåŒ¹é…çš„PVæˆ–é…ç½®StorageClass

# åœºæ™¯2ï¼šè®¿é—®æ¨¡å¼ä¸åŒ¹é…
# PVæ”¯æŒRWOï¼ŒPVCè¯·æ±‚RWX â†’ æ— æ³•ç»‘å®š

# åœºæ™¯3ï¼šå®¹é‡ä¸è¶³
# PVå®¹é‡5Giï¼ŒPVCè¯·æ±‚10Gi â†’ æ— æ³•ç»‘å®š

# åœºæ™¯4ï¼šStorageClassä¸åŒ¹é…
# PV: storageClassName: nfs
# PVC: storageClassName: ceph
# â†’ æ— æ³•ç»‘å®š
```

---

### 5.3.5 Podä½¿ç”¨PVC

**åœ¨Podä¸­ä½¿ç”¨PVCï¼š**

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: mysql-pod
spec:
  containers:
  - name: mysql
    image: mysql:8.0
    env:
    - name: MYSQL_ROOT_PASSWORD
      value: "password"
    volumeMounts:
    - name: mysql-data
      mountPath: /var/lib/mysql    # MySQLæ•°æ®ç›®å½•

  volumes:
  - name: mysql-data
    persistentVolumeClaim:
      claimName: mysql-pvc          # å¼•ç”¨PVCåç§°
```

**å®Œæ•´ç¤ºä¾‹ï¼šé™æ€ä¾›ç»™MySQL**

```bash
# 1. åˆ›å»ºPV
cat <<EOF | kubectl apply -f -
apiVersion: v1
kind: PersistentVolume
metadata:
  name: mysql-pv
spec:
  capacity:
    storage: 10Gi
  accessModes:
  - ReadWriteOnce
  persistentVolumeReclaimPolicy: Retain
  storageClassName: manual
  hostPath:
    path: /mnt/mysql-data
    type: DirectoryOrCreate
EOF

# 2. åˆ›å»ºPVC
cat <<EOF | kubectl apply -f -
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: mysql-pvc
spec:
  accessModes:
  - ReadWriteOnce
  resources:
    requests:
      storage: 5Gi
  storageClassName: manual
EOF

# 3. åˆ›å»ºMySQL Pod
cat <<EOF | kubectl apply -f -
apiVersion: v1
kind: Pod
metadata:
  name: mysql
spec:
  containers:
  - name: mysql
    image: mysql:8.0
    env:
    - name: MYSQL_ROOT_PASSWORD
      value: "MyPassword123"
    ports:
    - containerPort: 3306
    volumeMounts:
    - name: mysql-data
      mountPath: /var/lib/mysql
  volumes:
  - name: mysql-data
    persistentVolumeClaim:
      claimName: mysql-pvc
EOF

# 4. éªŒè¯
kubectl get pv,pvc,pod
# NAME                        CAPACITY   ACCESS MODES   STATUS   CLAIM
# persistentvolume/mysql-pv   10Gi       RWO            Bound    default/mysql-pvc
#
# NAME                              STATUS   VOLUME     CAPACITY
# persistentvolumeclaim/mysql-pvc   Bound    mysql-pv   10Gi
#
# NAME        READY   STATUS    RESTARTS
# pod/mysql   1/1     Running   0

# 5. å†™å…¥æ•°æ®æµ‹è¯•
kubectl exec -it mysql -- mysql -uroot -pMyPassword123 -e "
CREATE DATABASE testdb;
USE testdb;
CREATE TABLE users (id INT, name VARCHAR(50));
INSERT INTO users VALUES (1, 'Alice'), (2, 'Bob');
SELECT * FROM users;
"
# +------+-------+
# | id   | name  |
# +------+-------+
# |    1 | Alice |
# |    2 | Bob   |
# +------+-------+

# 6. åˆ é™¤Podæµ‹è¯•æ•°æ®æŒä¹…æ€§
kubectl delete pod mysql

# 7. é‡æ–°åˆ›å»ºPod
kubectl apply -f mysql-pod.yaml

# 8. éªŒè¯æ•°æ®ä¾ç„¶å­˜åœ¨
kubectl exec -it mysql -- mysql -uroot -pMyPassword123 -e "
USE testdb;
SELECT * FROM users;
"
# +------+-------+
# | id   | name  |
# +------+-------+
# |    1 | Alice |  â† æ•°æ®ä¾ç„¶å­˜åœ¨ï¼
# |    2 | Bob   |
# +------+-------+
```

---

### 5.3.6 PVçš„ç”Ÿå‘½å‘¨æœŸçŠ¶æ€

**çŠ¶æ€è½¬æ¢å›¾ï¼š**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Available   â”‚  â† PVå·²åˆ›å»ºï¼Œæœªç»‘å®šPVC
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼ (PVCåˆ›å»ºå¹¶åŒ¹é…)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Bound     â”‚  â† PVå·²ç»‘å®šåˆ°PVC
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼ (PVCåˆ é™¤)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Released   â”‚  â† PVå·²é‡Šæ”¾ï¼Œä½†æ•°æ®æœªæ¸…ç†
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”œâ”€> (Reclaim Policy: Retain)
       â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚   â”‚   Released  â”‚  â† éœ€è¦æ‰‹åŠ¨æ¸…ç†åæ‰èƒ½é‡æ–°ä½¿ç”¨
       â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”œâ”€> (Reclaim Policy: Delete)
       â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚   â”‚   Deleted   â”‚  â† PVå’Œå­˜å‚¨è¢«åˆ é™¤
       â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â””â”€> (å›æ”¶å¤±è´¥)
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚   Failed    â”‚  â† è‡ªåŠ¨å›æ”¶å¤±è´¥ï¼Œéœ€è¦æ‰‹åŠ¨å¹²é¢„
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**çŠ¶æ€è¯¦è§£ï¼š**

| çŠ¶æ€ | è¯´æ˜ | æ“ä½œ |
|-----|------|------|
| **Available** | PVå¯ç”¨ï¼Œç­‰å¾…ç»‘å®š | å¯ä»¥è¢«PVCç»‘å®š |
| **Bound** | å·²ç»‘å®šåˆ°PVC | æ­£åœ¨è¢«Podä½¿ç”¨ |
| **Released** | PVCå·²åˆ é™¤ï¼Œä½†æ•°æ®æœªæ¸…ç† | éœ€è¦æ‰‹åŠ¨æ¸…ç†æˆ–è‡ªåŠ¨å›æ”¶ |
| **Failed** | è‡ªåŠ¨å›æ”¶å¤±è´¥ | éœ€è¦æ‰‹åŠ¨å¹²é¢„ |

**ReleasedçŠ¶æ€çš„å¤„ç†ï¼š**

```bash
# 1. åˆ›å»ºå¹¶ä½¿ç”¨PV/PVC
kubectl apply -f pv.yaml
kubectl apply -f pvc.yaml

# æŸ¥çœ‹çŠ¶æ€
kubectl get pv
# NAME     STATUS   CLAIM
# my-pv    Bound    default/my-pvc

# 2. åˆ é™¤PVC
kubectl delete pvc my-pvc

# æŸ¥çœ‹PVçŠ¶æ€å˜åŒ–
kubectl get pv
# NAME     STATUS     CLAIM
# my-pv    Released   default/my-pvc  â† çŠ¶æ€å˜ä¸ºReleased
#          â†‘ æ— æ³•è¢«æ–°çš„PVCç»‘å®š

# 3. æ‰‹åŠ¨æ¸…ç†Releasedçš„PVï¼ˆRetainç­–ç•¥ï¼‰
# æ–¹æ³•1ï¼šåˆ é™¤PVï¼Œæ¸…ç†æ•°æ®ï¼Œé‡æ–°åˆ›å»º
kubectl delete pv my-pv
# æ‰‹åŠ¨æ¸…ç†åº•å±‚å­˜å‚¨çš„æ•°æ®
# rm -rf /mnt/data/*  (hostPathåœºæ™¯)
# kubectl apply -f pv.yaml  (é‡æ–°åˆ›å»ºPV)

# æ–¹æ³•2ï¼šç§»é™¤claimRefï¼ˆå…è®¸é‡æ–°ç»‘å®šï¼‰
kubectl patch pv my-pv --type json -p '[{"op": "remove", "path": "/spec/claimRef"}]'

# æŸ¥çœ‹çŠ¶æ€
kubectl get pv
# NAME     STATUS      CLAIM
# my-pv    Available   <none>  â† å¯ä»¥é‡æ–°ç»‘å®šäº†
```

---

### 5.3.7 PVå®¹é‡æ‰©å±•

**æ”¯æŒæ‰©å®¹çš„å‰ææ¡ä»¶ï¼š**

1. StorageClassçš„`allowVolumeExpansion: true`
2. åº•å±‚å­˜å‚¨æ”¯æŒæ‰©å®¹ï¼ˆå¦‚NFSã€äº‘ç›˜ï¼‰
3. CSIé©±åŠ¨æ”¯æŒåœ¨çº¿æˆ–ç¦»çº¿æ‰©å®¹

**æ‰©å®¹ç¤ºä¾‹ï¼š**

```bash
# 1. åˆ›å»ºæ”¯æŒæ‰©å®¹çš„StorageClass
cat <<EOF | kubectl apply -f -
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: expandable-storage
provisioner: kubernetes.io/no-provisioner
allowVolumeExpansion: true    # å…è®¸æ‰©å®¹
volumeBindingMode: WaitForFirstConsumer
EOF

# 2. åˆ›å»ºPVCï¼ˆåˆå§‹10Giï¼‰
cat <<EOF | kubectl apply -f -
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: expandable-pvc
spec:
  accessModes:
  - ReadWriteOnce
  resources:
    requests:
      storage: 10Gi
  storageClassName: expandable-storage
EOF

# 3. æ‰©å®¹åˆ°20Gi
kubectl patch pvc expandable-pvc -p '{"spec":{"resources":{"requests":{"storage":"20Gi"}}}}'

# 4. æŸ¥çœ‹æ‰©å®¹çŠ¶æ€
kubectl get pvc expandable-pvc -w
# NAME             STATUS   VOLUME   CAPACITY   ACCESS MODES
# expandable-pvc   Bound    pv-001   10Gi       RWO
# expandable-pvc   Bound    pv-001   20Gi       RWO  â† æ‰©å®¹å®Œæˆ

# 5. æŸ¥çœ‹PVC Events
kubectl describe pvc expandable-pvc
# Events:
#   Type     Reason                   Message
#   ----     ------                   -------
#   Normal   VolumeResizeSuccessful   Resize volume succeeded
```

**æ‰©å®¹ç±»å‹ï¼š**

| ç±»å‹ | è¯´æ˜ | å½±å“ |
|-----|------|------|
| **åœ¨çº¿æ‰©å®¹** | Podè¿è¡Œæ—¶æ‰©å®¹ | æ— éœ€é‡å¯Pod |
| **ç¦»çº¿æ‰©å®¹** | éœ€è¦åœæ­¢Podæ‰èƒ½æ‰©å®¹ | éœ€è¦é‡å¯Pod |

**æ³¨æ„äº‹é¡¹ï¼š**

- âš ï¸ **åªèƒ½æ‰©å®¹ï¼Œä¸èƒ½ç¼©å®¹**ï¼šKubernetesä¸æ”¯æŒç¼©å°PVCå®¹é‡
- âš ï¸ **æ–‡ä»¶ç³»ç»Ÿæ‰©å®¹**ï¼šæŸäº›æ–‡ä»¶ç³»ç»Ÿéœ€è¦æ‰‹åŠ¨è¿è¡Œresizeå‘½ä»¤

---

### 5.3.8 PVå›æ”¶ç­–ç•¥å®æˆ˜

**Retainç­–ç•¥ï¼ˆä¿ç•™æ•°æ®ï¼‰ï¼š**

```bash
# 1. åˆ›å»ºRetainç­–ç•¥çš„PV
cat <<EOF | kubectl apply -f -
apiVersion: v1
kind: PersistentVolume
metadata:
  name: pv-retain
spec:
  capacity:
    storage: 5Gi
  accessModes:
  - ReadWriteOnce
  persistentVolumeReclaimPolicy: Retain  # ä¿ç•™ç­–ç•¥
  storageClassName: manual
  hostPath:
    path: /mnt/retain-data
EOF

# 2. åˆ›å»ºPVCå¹¶å†™å…¥æ•°æ®
kubectl apply -f pvc-retain.yaml
kubectl apply -f pod-writer.yaml
kubectl exec pod-writer -- sh -c 'echo "Important Data" > /data/important.txt'

# 3. åˆ é™¤PVC
kubectl delete pvc pvc-retain

# 4. æŸ¥çœ‹PVçŠ¶æ€
kubectl get pv pv-retain
# NAME        STATUS     CLAIM
# pv-retain   Released   default/pvc-retain  â† ReleasedçŠ¶æ€

# 5. éªŒè¯æ•°æ®ä¾ç„¶å­˜åœ¨ï¼ˆSSHåˆ°èŠ‚ç‚¹ï¼‰
cat /mnt/retain-data/important.txt
# Important Data  â† æ•°æ®æœªè¢«åˆ é™¤
```

**Deleteç­–ç•¥ï¼ˆè‡ªåŠ¨åˆ é™¤ï¼‰ï¼š**

```bash
# 1. åˆ›å»ºDeleteç­–ç•¥çš„PVï¼ˆé€šå¸¸ç”±StorageClassåŠ¨æ€åˆ›å»ºï¼‰
cat <<EOF | kubectl apply -f -
apiVersion: v1
kind: PersistentVolume
metadata:
  name: pv-delete
spec:
  capacity:
    storage: 5Gi
  accessModes:
  - ReadWriteOnce
  persistentVolumeReclaimPolicy: Delete  # åˆ é™¤ç­–ç•¥
  storageClassName: auto-delete
  hostPath:
    path: /mnt/delete-data
EOF

# 2. åˆ›å»ºPVCå¹¶ä½¿ç”¨
kubectl apply -f pvc-delete.yaml

# 3. åˆ é™¤PVC
kubectl delete pvc pvc-delete

# 4. æŸ¥çœ‹PVçŠ¶æ€ï¼ˆPVè¢«è‡ªåŠ¨åˆ é™¤ï¼‰
kubectl get pv pv-delete
# Error from server (NotFound): persistentvolumes "pv-delete" not found
#                                â†‘ PVå·²è¢«åˆ é™¤

# 5. éªŒè¯åº•å±‚å­˜å‚¨ä¹Ÿè¢«åˆ é™¤
ls /mnt/delete-data
# ls: cannot access '/mnt/delete-data': No such file or directory
```

---

### 5.3.9 é™æ€ä¾›ç»™ vs åŠ¨æ€ä¾›ç»™

**é™æ€ä¾›ç»™ï¼ˆStatic Provisioningï¼‰ï¼š**

```
æ‰‹åŠ¨æµç¨‹ï¼š
1. ç®¡ç†å‘˜æ‰‹åŠ¨åˆ›å»ºPV
2. ç”¨æˆ·åˆ›å»ºPVC
3. Kubernetesè‡ªåŠ¨ç»‘å®šPVå’ŒPVC
4. Podä½¿ç”¨PVC

ä¼˜ç‚¹ï¼š
âœ… ç®¡ç†å‘˜å®Œå…¨æ§åˆ¶å­˜å‚¨èµ„æº
âœ… é€‚åˆå¤ç”¨å·²æœ‰å­˜å‚¨

ç¼ºç‚¹ï¼š
âŒ éœ€è¦æ‰‹åŠ¨åˆ›å»ºPV
âŒ æ‰©å±•æ€§å·®
âŒ PVæ•°é‡æœ‰é™
```

**åŠ¨æ€ä¾›ç»™ï¼ˆDynamic Provisioningï¼‰ï¼š**

```
è‡ªåŠ¨æµç¨‹ï¼š
1. ç”¨æˆ·åˆ›å»ºPVCï¼ˆæŒ‡å®šStorageClassï¼‰
2. StorageClassçš„Provisionerè‡ªåŠ¨åˆ›å»ºPV
3. è‡ªåŠ¨ç»‘å®šPVå’ŒPVC
4. Podä½¿ç”¨PVC

ä¼˜ç‚¹ï¼š
âœ… æ— éœ€æ‰‹åŠ¨åˆ›å»ºPV
âœ… æŒ‰éœ€åˆ›å»ºï¼Œæ— é™æ‰©å±•
âœ… è‡ªåŠ¨å›æ”¶

ç¼ºç‚¹ï¼š
âŒ éœ€è¦é…ç½®StorageClass
âŒ ä¾èµ–å¤–éƒ¨Provisioner
```

**å¯¹æ¯”è¡¨ï¼š**

| ç‰¹æ€§ | é™æ€ä¾›ç»™ | åŠ¨æ€ä¾›ç»™ |
|-----|---------|---------|
| **åˆ›å»ºæ–¹å¼** | ç®¡ç†å‘˜æ‰‹åŠ¨åˆ›å»ºPV | StorageClassè‡ªåŠ¨åˆ›å»ºPV |
| **é€‚ç”¨åœºæ™¯** | å°è§„æ¨¡ã€å·²æœ‰å­˜å‚¨ | å¤§è§„æ¨¡ã€äº‘ç¯å¢ƒ |
| **æ‰©å±•æ€§** | æœ‰é™ï¼ˆå–å†³äºé¢„åˆ›å»ºçš„PVæ•°é‡ï¼‰ | æ— é™ï¼ˆæŒ‰éœ€åˆ›å»ºï¼‰ |
| **å›æ”¶ç­–ç•¥** | é€šå¸¸Retain | é€šå¸¸Delete |
| **ç®¡ç†å¤æ‚åº¦** | é«˜ï¼ˆéœ€è¦æ‰‹åŠ¨ç®¡ç†ï¼‰ | ä½ï¼ˆè‡ªåŠ¨åŒ–ï¼‰ |

---

### 5.3.10 å®æˆ˜æ¡ˆä¾‹ï¼šWordPress + MySQLæŒä¹…åŒ–

**æ¶æ„ï¼š**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      WordPress Pod                       â”‚
â”‚  - æŒ‚è½½PVC: wordpress-pvc (/var/www/html)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼ è¿æ¥
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       MySQL Pod                          â”‚
â”‚  - æŒ‚è½½PVC: mysql-pvc (/var/lib/mysql)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å­˜å‚¨ï¼š
PV1 (10Gi, RWO) â†’ PVC: mysql-pvc     â†’ MySQLæ•°æ®
PV2 (10Gi, RWO) â†’ PVC: wordpress-pvc â†’ WordPressæ–‡ä»¶
```

**å®Œæ•´YAMLï¼š**

```yaml
# 1. MySQL PV
---
apiVersion: v1
kind: PersistentVolume
metadata:
  name: mysql-pv
spec:
  capacity:
    storage: 10Gi
  accessModes:
  - ReadWriteOnce
  persistentVolumeReclaimPolicy: Retain
  storageClassName: manual
  hostPath:
    path: /mnt/data/mysql
    type: DirectoryOrCreate

# 2. WordPress PV
---
apiVersion: v1
kind: PersistentVolume
metadata:
  name: wordpress-pv
spec:
  capacity:
    storage: 10Gi
  accessModes:
  - ReadWriteOnce
  persistentVolumeReclaimPolicy: Retain
  storageClassName: manual
  hostPath:
    path: /mnt/data/wordpress
    type: DirectoryOrCreate

# 3. MySQL PVC
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: mysql-pvc
spec:
  accessModes:
  - ReadWriteOnce
  resources:
    requests:
      storage: 10Gi
  storageClassName: manual

# 4. WordPress PVC
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: wordpress-pvc
spec:
  accessModes:
  - ReadWriteOnce
  resources:
    requests:
      storage: 10Gi
  storageClassName: manual

# 5. MySQL Deployment
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mysql
spec:
  replicas: 1
  selector:
    matchLabels:
      app: mysql
  template:
    metadata:
      labels:
        app: mysql
    spec:
      containers:
      - name: mysql
        image: mysql:8.0
        env:
        - name: MYSQL_ROOT_PASSWORD
          value: "rootpassword"
        - name: MYSQL_DATABASE
          value: "wordpress"
        - name: MYSQL_USER
          value: "wpuser"
        - name: MYSQL_PASSWORD
          value: "wppassword"
        ports:
        - containerPort: 3306
        volumeMounts:
        - name: mysql-data
          mountPath: /var/lib/mysql
      volumes:
      - name: mysql-data
        persistentVolumeClaim:
          claimName: mysql-pvc

# 6. MySQL Service
---
apiVersion: v1
kind: Service
metadata:
  name: mysql
spec:
  selector:
    app: mysql
  ports:
  - port: 3306
  clusterIP: None  # Headless Service

# 7. WordPress Deployment
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: wordpress
spec:
  replicas: 1
  selector:
    matchLabels:
      app: wordpress
  template:
    metadata:
      labels:
        app: wordpress
    spec:
      containers:
      - name: wordpress
        image: wordpress:6.4
        env:
        - name: WORDPRESS_DB_HOST
          value: "mysql:3306"
        - name: WORDPRESS_DB_NAME
          value: "wordpress"
        - name: WORDPRESS_DB_USER
          value: "wpuser"
        - name: WORDPRESS_DB_PASSWORD
          value: "wppassword"
        ports:
        - containerPort: 80
        volumeMounts:
        - name: wordpress-data
          mountPath: /var/www/html
      volumes:
      - name: wordpress-data
        persistentVolumeClaim:
          claimName: wordpress-pvc

# 8. WordPress Service
---
apiVersion: v1
kind: Service
metadata:
  name: wordpress
spec:
  selector:
    app: wordpress
  ports:
  - port: 80
    targetPort: 80
    nodePort: 30080
  type: NodePort
```

**éƒ¨ç½²å’Œæµ‹è¯•ï¼š**

```bash
# 1. éƒ¨ç½²æ‰€æœ‰èµ„æº
kubectl apply -f wordpress-mysql.yaml

# 2. æŸ¥çœ‹èµ„æºçŠ¶æ€
kubectl get pv,pvc,pod,svc
# NAME                           CAPACITY   STATUS   CLAIM
# persistentvolume/mysql-pv      10Gi       Bound    default/mysql-pvc
# persistentvolume/wordpress-pv  10Gi       Bound    default/wordpress-pvc
#
# NAME                                  STATUS   VOLUME         CAPACITY
# persistentvolumeclaim/mysql-pvc       Bound    mysql-pv       10Gi
# persistentvolumeclaim/wordpress-pvc   Bound    wordpress-pv   10Gi
#
# NAME                             READY   STATUS    RESTARTS
# pod/mysql-xxx                    1/1     Running   0
# pod/wordpress-xxx                1/1     Running   0
#
# NAME                 TYPE        CLUSTER-IP     PORT(S)
# service/mysql        ClusterIP   None           3306/TCP
# service/wordpress    NodePort    10.96.100.50   80:30080/TCP

# 3. è®¿é—®WordPressï¼ˆæµè§ˆå™¨æ‰“å¼€ï¼‰
# http://<NodeIP>:30080

# 4. å®ŒæˆWordPresså®‰è£…
# - é€‰æ‹©è¯­è¨€
# - è®¾ç½®ç«™ç‚¹æ ‡é¢˜ã€ç®¡ç†å‘˜è´¦å·
# - å®‰è£…æˆåŠŸ

# 5. åˆ›å»ºæ–‡ç« æµ‹è¯•æ•°æ®æŒä¹…æ€§
# - ç™»å½•WordPressç®¡ç†åå°
# - åˆ›å»ºä¸€ç¯‡æµ‹è¯•æ–‡ç« 
# - å‘å¸ƒæ–‡ç« 

# 6. åˆ é™¤Podæµ‹è¯•æ•°æ®æŒä¹…æ€§
kubectl delete pod -l app=wordpress
kubectl delete pod -l app=mysql

# 7. ç­‰å¾…Podé‡æ–°åˆ›å»º
kubectl get pod -w

# 8. å†æ¬¡è®¿é—®WordPress
# http://<NodeIP>:30080
# âœ… æ–‡ç« ä¾ç„¶å­˜åœ¨ï¼æ•°æ®æŒä¹…åŒ–æˆåŠŸï¼

# 9. éªŒè¯åº•å±‚å­˜å‚¨
ls -la /mnt/data/mysql/
# -rw-r----- 1 systemd-coredump systemd-coredump ... ibdata1
# drwxr-x--- 2 systemd-coredump systemd-coredump ... wordpress
# ...

ls -la /mnt/data/wordpress/
# drwxr-xr-x 5 www-data www-data ... wp-content
# -rw-r--r-- 1 www-data www-data ... wp-config.php
# ...
```

---

### 5.3.11 PV/PVCæœ€ä½³å®è·µ

**å‘½åè§„èŒƒï¼š**

```yaml
# âœ… æ¨èï¼šè¯­ä¹‰åŒ–å‘½å
PVåç§°: <åº”ç”¨>-<ç”¨é€”>-pv-<ç¼–å·>
  ç¤ºä¾‹: mysql-data-pv-001, wordpress-uploads-pv-002

PVCåç§°: <åº”ç”¨>-<ç”¨é€”>-pvc
  ç¤ºä¾‹: mysql-data-pvc, wordpress-uploads-pvc

# âŒ ä¸æ¨èï¼šæ— æ„ä¹‰å‘½å
pv-001, pvc-test, my-volume
```

**å®¹é‡è§„åˆ’ï¼š**

```yaml
# âœ… æ¨èï¼šé¢„ç•™ç©ºé—´
PVCè¯·æ±‚: 8Gi
PVå®¹é‡:  10Gi  # é¢„ç•™20%ç©ºé—´

# âœ… æ¨èï¼šç›‘æ§ä½¿ç”¨ç‡
- è®¾ç½®å‘Šè­¦ï¼šä½¿ç”¨ç‡è¶…è¿‡80%
- å®šæœŸæ£€æŸ¥ï¼škubectl top pvï¼ˆéœ€è¦metrics-serverï¼‰
```

**è®¿é—®æ¨¡å¼é€‰æ‹©ï¼š**

| åº”ç”¨ç±»å‹ | æ¨èè®¿é—®æ¨¡å¼ | ç†ç”± |
|---------|-------------|------|
| **æ•°æ®åº“** | RWO | å•å®ä¾‹å†™å…¥ï¼Œé¿å…æ•°æ®å†²çª |
| **Webåº”ç”¨** | RWOï¼ˆå•å‰¯æœ¬ï¼‰/ RWXï¼ˆå¤šå‰¯æœ¬ï¼‰ | å¤šå‰¯æœ¬éœ€è¦å…±äº«å­˜å‚¨ |
| **æ—¥å¿—æ”¶é›†** | RWX | å¤šä¸ªPodåŒæ—¶å†™å…¥æ—¥å¿— |
| **é™æ€æ–‡ä»¶** | ROX | åªè¯»ï¼Œå¤šPodå…±äº« |

**å›æ”¶ç­–ç•¥é€‰æ‹©ï¼š**

| ç¯å¢ƒ | æ¨èç­–ç•¥ | ç†ç”± |
|-----|---------|------|
| **ç”Ÿäº§ç¯å¢ƒ** | Retain | é˜²æ­¢è¯¯åˆ ï¼Œæ‰‹åŠ¨æ¸…ç†æ›´å®‰å…¨ |
| **å¼€å‘/æµ‹è¯•** | Delete | è‡ªåŠ¨æ¸…ç†ï¼ŒèŠ‚çœç©ºé—´ |
| **äº‘ç¯å¢ƒ** | Delete | äº‘ç›˜è‡ªåŠ¨ç®¡ç†ï¼ŒæŒ‰éœ€åˆ›å»ºåˆ é™¤ |

**æ ‡ç­¾å’Œæ³¨è§£ï¼š**

```yaml
apiVersion: v1
kind: PersistentVolume
metadata:
  name: mysql-pv
  labels:
    app: mysql
    environment: production
    tier: database
  annotations:
    description: "MySQL production database storage"
    created-by: "admin@example.com"
    backup-policy: "daily"
spec:
  # ...
```

**å®‰å…¨å»ºè®®ï¼š**

```yaml
# âœ… æ¨èï¼šä½¿ç”¨RBACé™åˆ¶PVCåˆ›å»º
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: pvc-creator
rules:
- apiGroups: [""]
  resources: ["persistentvolumeclaims"]
  verbs: ["create", "get", "list"]
  # ä¸å…è®¸deleteï¼Œé˜²æ­¢è¯¯åˆ 

# âœ… æ¨èï¼šä½¿ç”¨ResourceQuotaé™åˆ¶å­˜å‚¨æ€»é‡
apiVersion: v1
kind: ResourceQuota
metadata:
  name: storage-quota
spec:
  hard:
    requests.storage: "100Gi"  # é™åˆ¶æ€»å­˜å‚¨é‡
    persistentvolumeclaims: "10"  # é™åˆ¶PVCæ•°é‡
```

**æ•…éšœæ’æŸ¥æ¸…å•ï¼š**

| é—®é¢˜ | æ’æŸ¥æ­¥éª¤ | è§£å†³æ–¹æ¡ˆ |
|-----|---------|---------|
| **PVCä¸€ç›´Pending** | `kubectl describe pvc <name>` | æ£€æŸ¥æ˜¯å¦æœ‰åŒ¹é…çš„PVï¼Œæˆ–é…ç½®StorageClass |
| **Podæ— æ³•æŒ‚è½½PVC** | `kubectl describe pod <name>` | æ£€æŸ¥PVCæ˜¯å¦Boundï¼ŒèŠ‚ç‚¹æ˜¯å¦èƒ½è®¿é—®å­˜å‚¨ |
| **PVæ— æ³•ç»‘å®š** | æ£€æŸ¥accessModesã€capacityã€storageClassName | è°ƒæ•´PVé…ç½®ä½¿å…¶åŒ¹é…PVC |
| **æ•°æ®ä¸¢å¤±** | æ£€æŸ¥å›æ”¶ç­–ç•¥ã€PVçŠ¶æ€ | ä½¿ç”¨Retainç­–ç•¥ï¼Œå®šæœŸå¤‡ä»½ |
| **æ€§èƒ½é—®é¢˜** | æ£€æŸ¥å­˜å‚¨ç±»å‹ã€ç½‘ç»œå»¶è¿Ÿ | ä½¿ç”¨æœ¬åœ°å­˜å‚¨æˆ–é«˜æ€§èƒ½äº‘ç›˜ |

**æœ¬èŠ‚å°ç»“ï¼š**

æˆ‘ä»¬è¯¦ç»†å­¦ä¹ äº†PVå’ŒPVCçš„å®Œæ•´æœºåˆ¶ï¼š

| æ¦‚å¿µ | æ ¸å¿ƒè¦ç‚¹ |
|-----|---------|
| **PV** | é›†ç¾¤çº§å­˜å‚¨èµ„æºï¼Œç®¡ç†å‘˜åˆ›å»º |
| **PVC** | ç”¨æˆ·çš„å­˜å‚¨ç”³è¯·ï¼Œè‡ªåŠ¨åŒ¹é…PV |
| **ç»‘å®š** | åŸºäºå®¹é‡ã€è®¿é—®æ¨¡å¼ã€StorageClassåŒ¹é… |
| **ç”Ÿå‘½å‘¨æœŸ** | Available â†’ Bound â†’ Released â†’ Failed |
| **å›æ”¶ç­–ç•¥** | Retainï¼ˆä¿ç•™ï¼‰/Deleteï¼ˆåˆ é™¤ï¼‰/Recycleï¼ˆå·²åºŸå¼ƒï¼‰ |
| **è®¿é—®æ¨¡å¼** | RWOï¼ˆå•èŠ‚ç‚¹ï¼‰/ROXï¼ˆå¤šèŠ‚ç‚¹åªè¯»ï¼‰/RWXï¼ˆå¤šèŠ‚ç‚¹è¯»å†™ï¼‰ |

æ¥ä¸‹æ¥æˆ‘ä»¬å°†å­¦ä¹ æ›´å…ˆè¿›çš„åŠ¨æ€ä¾›ç»™æœºåˆ¶ï¼šStorageClassã€‚

---


## 5.4 StorageClassåŠ¨æ€ä¾›ç»™

åœ¨ä¸Šä¸€èŠ‚ä¸­ï¼Œæˆ‘ä»¬å­¦ä¹ äº†é™æ€ä¾›ç»™ï¼šç®¡ç†å‘˜æ‰‹åŠ¨åˆ›å»ºPVï¼Œç”¨æˆ·åˆ›å»ºPVCç»‘å®šã€‚ä½†è¿™ç§æ–¹å¼å­˜åœ¨é—®é¢˜ï¼š**æ¯æ¬¡éƒ½éœ€è¦æ‰‹åŠ¨åˆ›å»ºPVï¼Œæ— æ³•è‡ªåŠ¨åŒ–å’Œè§„æ¨¡åŒ–**ã€‚StorageClassé€šè¿‡åŠ¨æ€ä¾›ç»™æœºåˆ¶è§£å†³äº†è¿™ä¸ªé—®é¢˜ã€‚

### 5.4.1 ä¸ºä»€ä¹ˆéœ€è¦StorageClass

**é™æ€ä¾›ç»™çš„ç—›ç‚¹ï¼š**

```
åœºæ™¯ï¼š100ä¸ªå¼€å‘è€…éœ€è¦å­˜å‚¨

é™æ€ä¾›ç»™æ–¹å¼ï¼š
1. ç®¡ç†å‘˜é¢„å…ˆåˆ›å»º100ä¸ªPV  â† å·¥ä½œé‡å¤§
2. å¼€å‘è€…åˆ›å»ºPVCç”³è¯·å­˜å‚¨
3. æœ‰äººå¤šç”³è¯·äº†ï¼ŒPVä¸å¤Ÿç”¨  â† èµ„æºæµªè´¹
4. æœ‰äººå°‘ç”³è¯·äº†ï¼ŒPVæµªè´¹    â† ç®¡ç†å¤æ‚

é—®é¢˜ï¼š
âŒ éœ€è¦æå‰é¢„ä¼°å­˜å‚¨éœ€æ±‚
âŒ æ‰‹åŠ¨åˆ›å»ºå¤§é‡PV
âŒ èµ„æºåˆ©ç”¨ç‡ä½
âŒ æ‰©å±•æ€§å·®
```

**StorageClassåŠ¨æ€ä¾›ç»™è§£å†³æ–¹æ¡ˆï¼š**

```
åŠ¨æ€ä¾›ç»™æµç¨‹ï¼š

1. ç®¡ç†å‘˜åˆ›å»ºStorageClassï¼ˆä¸€æ¬¡é…ç½®ï¼‰
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚    StorageClass            â”‚
   â”‚  - Provisioner: nfs        â”‚
   â”‚  - Parameters: serveråœ°å€  â”‚
   â”‚  - ReclaimPolicy: Delete   â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

2. ç”¨æˆ·åˆ›å»ºPVCï¼ˆæŒ‡å®šStorageClassï¼‰
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚    PVC                     â”‚
   â”‚  storageClassName: nfs     â”‚
   â”‚  storage: 10Gi             â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼ è‡ªåŠ¨è§¦å‘
3. Provisionerè‡ªåŠ¨åˆ›å»ºPV
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚    PV (è‡ªåŠ¨åˆ›å»º)            â”‚
   â”‚  capacity: 10Gi            â”‚
   â”‚  nfs: server/path          â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼ è‡ªåŠ¨ç»‘å®š
4. PVCå’ŒPVè‡ªåŠ¨ç»‘å®š
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  PVC â†â†’ PV                 â”‚
   â”‚  Status: Bound             â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ä¼˜åŠ¿ï¼š
âœ… æŒ‰éœ€åˆ›å»ºï¼Œæ— é™æ‰©å±•
âœ… è‡ªåŠ¨åŒ–ç®¡ç†
âœ… èµ„æºåˆ©ç”¨ç‡é«˜
âœ… æ”¯æŒå¤šç§å­˜å‚¨åç«¯
```

---

### 5.4.2 StorageClassæ ¸å¿ƒæ¦‚å¿µ

**StorageClassæ˜¯ä»€ä¹ˆï¼Ÿ**

StorageClassæ˜¯Kubernetesä¸­çš„å­˜å‚¨ç±»åˆ«ï¼Œå®šä¹‰äº†å¦‚ä½•åŠ¨æ€åˆ›å»ºPVã€‚å®ƒåŒ…å«Provisionerï¼ˆå­˜å‚¨ä¾›åº”å•†ï¼‰å’ŒParametersï¼ˆå­˜å‚¨å‚æ•°ï¼‰ã€‚

**StorageClassçš„æ ¸å¿ƒå±æ€§ï¼š**

```yaml
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: fast-storage
  annotations:
    storageclass.kubernetes.io/is-default-class: "true"  # é»˜è®¤StorageClass

# 1. ä¾›åº”å•†ï¼ˆå¿…éœ€ï¼‰
provisioner: kubernetes.io/aws-ebs

# 2. å‚æ•°ï¼ˆä¾›åº”å•†ç‰¹å®šï¼‰
parameters:
  type: gp3            # AWS EBSç±»å‹
  iopsPerGB: "10"      # æ¯GBçš„IOPS
  encrypted: "true"    # åŠ å¯†

# 3. å›æ”¶ç­–ç•¥
reclaimPolicy: Delete  # Delete/Retain

# 4. ç»‘å®šæ¨¡å¼
volumeBindingMode: WaitForFirstConsumer  # Immediate/WaitForFirstConsumer

# 5. æ˜¯å¦å…è®¸æ‰©å®¹
allowVolumeExpansion: true

# 6. æŒ‚è½½é€‰é¡¹
mountOptions:
- debug
- hard
```

**æ ¸å¿ƒå±æ€§è¯¦è§£ï¼š**

| å±æ€§ | è¯´æ˜ | å¯é€‰å€¼ |
|-----|------|--------|
| **provisioner** | å­˜å‚¨ä¾›åº”å•†ï¼Œå†³å®šä½¿ç”¨å“ªä¸ªæ’ä»¶åˆ›å»ºPV | `kubernetes.io/aws-ebs`ã€`kubernetes.io/gce-pd`ã€`nfs-client` ç­‰ |
| **parameters** | ä¾›åº”å•†ç‰¹å®šå‚æ•° | å–å†³äºprovisioner |
| **reclaimPolicy** | PVCåˆ é™¤åPVçš„å¤„ç†ç­–ç•¥ | `Delete`ï¼ˆé»˜è®¤ï¼‰ã€`Retain` |
| **volumeBindingMode** | PVç»‘å®šæ—¶æœº | `Immediate`ï¼ˆç«‹å³ç»‘å®šï¼‰ã€`WaitForFirstConsumer`ï¼ˆå»¶è¿Ÿç»‘å®šï¼‰ |
| **allowVolumeExpansion** | æ˜¯å¦å…è®¸æ‰©å®¹ | `true`ã€`false` |
| **mountOptions** | æŒ‚è½½é€‰é¡¹ | å–å†³äºæ–‡ä»¶ç³»ç»Ÿç±»å‹ |

---

### 5.4.3 Provisionerç±»å‹

**å†…ç½®Provisioner (In-Tree)ï¼š**

| Provisioner | äº‘å‚å•† | å­˜å‚¨ç±»å‹ |
|------------|--------|---------|
| `kubernetes.io/aws-ebs` | AWS | Elastic Block Store |
| `kubernetes.io/gce-pd` | GCP | Persistent Disk |
| `kubernetes.io/azure-disk` | Azure | Managed Disk |
| `kubernetes.io/azure-file` | Azure | File Storage |
| `kubernetes.io/cinder` | OpenStack | Cinder |
| `kubernetes.io/vsphere-volume` | vSphere | VMDK |

**å¤–éƒ¨Provisioner (Out-of-Tree / CSI)ï¼š**

| Provisioner | å­˜å‚¨ç³»ç»Ÿ | é¡¹ç›®åœ°å€ |
|------------|---------|---------|
| `nfs.csi.k8s.io` | NFS | NFS CSI Driver |
| `rook-ceph.rbd.csi.ceph.com` | Ceph | Rook |
| `pd.csi.storage.gke.io` | GCP | GCP CSI Driver |
| `ebs.csi.aws.com` | AWS EBS | AWS EBS CSI Driver |
| `disk.csi.azure.com` | Azure Disk | Azure Disk CSI Driver |

**æ¨èä½¿ç”¨CSIé©±åŠ¨ï¼š**

```
In-Treeæ’ä»¶ (å·²åºŸå¼ƒ) â†’ CSIé©±åŠ¨ (æ¨è)

åŸå› ï¼š
âœ… CSIé©±åŠ¨ç‹¬ç«‹äºKubernetesç‰ˆæœ¬
âœ… æ”¯æŒæ›´å¤šé«˜çº§åŠŸèƒ½ï¼ˆå¿«ç…§ã€å…‹éš†ã€æ‰©å®¹ï¼‰
âœ… ç”±å­˜å‚¨å‚å•†ç‹¬ç«‹ç»´æŠ¤å’Œæ›´æ–°
âœ… ç¬¦åˆè¡Œä¸šæ ‡å‡†
```

---

### 5.4.4 volumeBindingModeè¯¦è§£

**Immediateï¼ˆç«‹å³ç»‘å®šï¼‰ï¼š**

```
æµç¨‹ï¼š
1. ç”¨æˆ·åˆ›å»ºPVC
2. Provisionerç«‹å³åˆ›å»ºPV
3. PVCç«‹å³ç»‘å®šåˆ°PV
4. Podåˆ›å»ºæ—¶ä½¿ç”¨å·²ç»‘å®šçš„PVC

é—®é¢˜ï¼š
âŒ PVå¯èƒ½åˆ›å»ºåœ¨é”™è¯¯çš„å¯ç”¨åŒº
âŒ Podè°ƒåº¦å¯èƒ½å¤±è´¥ï¼ˆæ— æ³•è®¿é—®è¯¥å¯ç”¨åŒºçš„å­˜å‚¨ï¼‰

ç¤ºä¾‹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åˆ›å»ºPVC      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼ ç«‹å³åˆ›å»ºPVï¼ˆåœ¨us-east-1aï¼‰
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PVåˆ›å»ºå®Œæˆ   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼ PVCç»‘å®š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PVC: Bound   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼ åˆ›å»ºPod
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Podè°ƒåº¦åˆ°    â”‚
â”‚ us-east-1b   â”‚  â† âŒ æ— æ³•è®¿é—®1açš„å­˜å‚¨ï¼
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**WaitForFirstConsumerï¼ˆå»¶è¿Ÿç»‘å®šï¼Œæ¨èï¼‰ï¼š**

```
æµç¨‹ï¼š
1. ç”¨æˆ·åˆ›å»ºPVCï¼ˆçŠ¶æ€Pendingï¼‰
2. ç­‰å¾…Podåˆ›å»º
3. è°ƒåº¦å™¨é€‰æ‹©åˆé€‚çš„Node
4. Provisioneråœ¨è¯¥Nodeå¯è®¿é—®çš„ä½ç½®åˆ›å»ºPV
5. PVCç»‘å®šåˆ°PV
6. Podå¯åŠ¨æˆåŠŸ

ä¼˜åŠ¿ï¼š
âœ… ç¡®ä¿PVåˆ›å»ºåœ¨æ­£ç¡®çš„å¯ç”¨åŒº
âœ… é¿å…è°ƒåº¦å¤±è´¥
âœ… é€‚åˆè·¨å¯ç”¨åŒºçš„é›†ç¾¤

ç¤ºä¾‹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åˆ›å»ºPVC      â”‚
â”‚ Status:      â”‚
â”‚ Pending      â”‚  â† ç­‰å¾…Podåˆ›å»º
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼ åˆ›å»ºPod
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Podè¢«è°ƒåº¦åˆ°  â”‚
â”‚ Node-1       â”‚
â”‚ (us-east-1b) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼ è§¦å‘PVåˆ›å»º
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PVåˆ›å»ºåœ¨     â”‚
â”‚ us-east-1b   â”‚  â† âœ… ä¸Podåœ¨åŒä¸€å¯ç”¨åŒº
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼ ç»‘å®š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PVC: Bound   â”‚
â”‚ Pod: Running â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å¯¹æ¯”ï¼š**

| ç‰¹æ€§ | Immediate | WaitForFirstConsumer |
|-----|----------|---------------------|
| **ç»‘å®šæ—¶æœº** | PVCåˆ›å»ºæ—¶ç«‹å³ç»‘å®š | Podåˆ›å»ºæ—¶ç»‘å®š |
| **é€‚ç”¨åœºæ™¯** | å•å¯ç”¨åŒºã€æœ¬åœ°æµ‹è¯• | è·¨å¯ç”¨åŒºã€ç”Ÿäº§ç¯å¢ƒ |
| **ä¼˜ç‚¹** | ç®€å•å¿«é€Ÿ | ç¡®ä¿æ‹“æ‰‘æ­£ç¡®æ€§ |
| **ç¼ºç‚¹** | å¯èƒ½å¯¼è‡´è°ƒåº¦å¤±è´¥ | å»¶è¿Ÿç¨é«˜ |

---

### 5.4.5 NFSåŠ¨æ€ä¾›ç»™å®æˆ˜

**æ¶æ„ï¼š**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   NFS Server                             â”‚
â”‚  - æä¾›ç½‘ç»œå­˜å‚¨                                           â”‚
â”‚  - IP: 192.168.1.100                                    â”‚
â”‚  - å¯¼å‡ºè·¯å¾„: /nfs/data                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              NFS Client Provisioner                      â”‚
â”‚  - ç›‘å¬PVCåˆ›å»ºäº‹ä»¶                                        â”‚
â”‚  - åœ¨NFSæœåŠ¡å™¨ä¸Šåˆ›å»ºå­ç›®å½•                                 â”‚
â”‚  - è‡ªåŠ¨åˆ›å»ºPV                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  StorageClass                            â”‚
â”‚  provisioner: nfs-client                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
                    [PVC] â†’ [PV] â†’ [Pod]
```

**æ­¥éª¤1ï¼šéƒ¨ç½²NFS Serverï¼ˆå¯é€‰ï¼Œå¦‚æœæ²¡æœ‰ç°æˆçš„ï¼‰**

```bash
# åœ¨ä¸€å°Linuxæœºå™¨ä¸Šå®‰è£…NFS Server
sudo apt-get update
sudo apt-get install -y nfs-kernel-server

# åˆ›å»ºå…±äº«ç›®å½•
sudo mkdir -p /nfs/data
sudo chmod 777 /nfs/data

# é…ç½®NFSå¯¼å‡º
sudo tee /etc/exports <<EOF
/nfs/data *(rw,sync,no_subtree_check,no_root_squash)
EOF

# é‡å¯NFSæœåŠ¡
sudo exportfs -ra
sudo systemctl restart nfs-kernel-server

# æŸ¥çœ‹å¯¼å‡º
sudo exportfs -v
# /nfs/data     <world>(sync,wdelay,hide,no_subtree_check,sec=sys,rw,secure,no_root_squash,no_all_squash)
```

**æ­¥éª¤2ï¼šéƒ¨ç½²NFS Client Provisioner**

```bash
# æ·»åŠ Helmä»“åº“
helm repo add nfs-subdir-external-provisioner https://kubernetes-sigs.github.io/nfs-subdir-external-provisioner/

# å®‰è£…NFS Provisioner
helm install nfs-client nfs-subdir-external-provisioner/nfs-subdir-external-provisioner \
  --set nfs.server=192.168.1.100 \
  --set nfs.path=/nfs/data \
  --set storageClass.name=nfs-client \
  --set storageClass.defaultClass=true

# æˆ–è€…æ‰‹åŠ¨éƒ¨ç½²YAML
kubectl apply -f - <<EOF
apiVersion: v1
kind: ServiceAccount
metadata:
  name: nfs-client-provisioner
  namespace: default
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: nfs-client-provisioner-runner
rules:
- apiGroups: [""]
  resources: ["persistentvolumes"]
  verbs: ["get", "list", "watch", "create", "delete"]
- apiGroups: [""]
  resources: ["persistentvolumeclaims"]
  verbs: ["get", "list", "watch", "update"]
- apiGroups: ["storage.k8s.io"]
  resources: ["storageclasses"]
  verbs: ["get", "list", "watch"]
- apiGroups: [""]
  resources: ["events"]
  verbs: ["create", "update", "patch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: run-nfs-client-provisioner
subjects:
- kind: ServiceAccount
  name: nfs-client-provisioner
  namespace: default
roleRef:
  kind: ClusterRole
  name: nfs-client-provisioner-runner
  apiGroup: rbac.authorization.k8s.io
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nfs-client-provisioner
  namespace: default
spec:
  replicas: 1
  selector:
    matchLabels:
      app: nfs-client-provisioner
  strategy:
    type: Recreate
  template:
    metadata:
      labels:
        app: nfs-client-provisioner
    spec:
      serviceAccountName: nfs-client-provisioner
      containers:
      - name: nfs-client-provisioner
        image: registry.k8s.io/sig-storage/nfs-subdir-external-provisioner:v4.0.2
        volumeMounts:
        - name: nfs-client-root
          mountPath: /persistentvolumes
        env:
        - name: PROVISIONER_NAME
          value: nfs-client
        - name: NFS_SERVER
          value: 192.168.1.100        # NFSæœåŠ¡å™¨IP
        - name: NFS_PATH
          value: /nfs/data            # NFSå¯¼å‡ºè·¯å¾„
      volumes:
      - name: nfs-client-root
        nfs:
          server: 192.168.1.100
          path: /nfs/data
EOF
```

**æ­¥éª¤3ï¼šåˆ›å»ºStorageClass**

```yaml
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: nfs-client
  annotations:
    storageclass.kubernetes.io/is-default-class: "true"  # è®¾ä¸ºé»˜è®¤
provisioner: nfs-client                # ä¸Provisionerçš„PROVISIONER_NAMEä¸€è‡´
parameters:
  archiveOnDelete: "false"             # åˆ é™¤PVCæ—¶æ˜¯å¦å½’æ¡£æ•°æ®
reclaimPolicy: Delete                  # å›æ”¶ç­–ç•¥
volumeBindingMode: Immediate           # ç«‹å³ç»‘å®š
allowVolumeExpansion: true             # å…è®¸æ‰©å®¹
```

```bash
kubectl apply -f nfs-storageclass.yaml

# æŸ¥çœ‹StorageClass
kubectl get storageclass
# NAME                  PROVISIONER   RECLAIMPOLICY   VOLUMEBINDINGMODE
# nfs-client (default)  nfs-client    Delete          Immediate
```

**æ­¥éª¤4ï¼šæµ‹è¯•åŠ¨æ€ä¾›ç»™**

```yaml
# 1. åˆ›å»ºPVC
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: test-pvc
spec:
  storageClassName: nfs-client
  accessModes:
  - ReadWriteMany
  resources:
    requests:
      storage: 1Gi
```

```bash
# åˆ›å»ºPVC
kubectl apply -f test-pvc.yaml

# æŸ¥çœ‹PVCï¼ˆè‡ªåŠ¨ç»‘å®šï¼‰
kubectl get pvc test-pvc
# NAME       STATUS   VOLUME                                     CAPACITY
# test-pvc   Bound    pvc-abc123-def456-ghi789                   1Gi

# æŸ¥çœ‹è‡ªåŠ¨åˆ›å»ºçš„PV
kubectl get pv
# NAME                       CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM
# pvc-abc123-def456-ghi789   1Gi        RWX            Delete           Bound    default/test-pvc

# æŸ¥çœ‹NFSæœåŠ¡å™¨ä¸Šçš„ç›®å½•ï¼ˆè‡ªåŠ¨åˆ›å»ºï¼‰
ssh nfs-server
ls -la /nfs/data/
# drwxrwxrwx 2 root root 4096 Dec 26 10:00 default-test-pvc-pvc-abc123
#                                           â†‘ è‡ªåŠ¨åˆ›å»ºçš„ç›®å½•
```

**æ­¥éª¤5ï¼šåœ¨Podä¸­ä½¿ç”¨**

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: test-pod
spec:
  containers:
  - name: app
    image: nginx
    volumeMounts:
    - name: data
      mountPath: /usr/share/nginx/html
  volumes:
  - name: data
    persistentVolumeClaim:
      claimName: test-pvc
```

```bash
# åˆ›å»ºPod
kubectl apply -f test-pod.yaml

# å†™å…¥æ•°æ®
kubectl exec test-pod -- sh -c 'echo "Hello NFS Dynamic Provisioning" > /usr/share/nginx/html/index.html'

# éªŒè¯æ•°æ®ï¼ˆåœ¨NFSæœåŠ¡å™¨ä¸Šï¼‰
ssh nfs-server
cat /nfs/data/default-test-pvc-pvc-abc123/index.html
# Hello NFS Dynamic Provisioning

# åˆ é™¤Podå’ŒPVC
kubectl delete pod test-pod
kubectl delete pvc test-pvc

# éªŒè¯PVå’Œæ•°æ®ä¹Ÿè¢«åˆ é™¤ï¼ˆDeleteç­–ç•¥ï¼‰
kubectl get pv
# No resources found

ssh nfs-server
ls /nfs/data/
# archived-default-test-pvc-pvc-abc123  â† å¦‚æœarchiveOnDelete: "true"åˆ™å½’æ¡£
# (å¦‚æœarchiveOnDelete: "false"åˆ™å®Œå…¨åˆ é™¤)
```

---

### 5.4.6 äº‘å­˜å‚¨åŠ¨æ€ä¾›ç»™ï¼ˆAWS EBSç¤ºä¾‹ï¼‰

**AWS EBS StorageClassç¤ºä¾‹ï¼š**

```yaml
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: aws-ebs-gp3
provisioner: ebs.csi.aws.com        # AWS EBS CSI Driver
parameters:
  type: gp3                         # EBSç±»å‹ï¼šgp3/gp2/io1/io2/st1/sc1
  iops: "3000"                      # IOPSï¼ˆä»…gp3/io1/io2ï¼‰
  throughput: "125"                 # ååé‡MB/sï¼ˆä»…gp3ï¼‰
  encrypted: "true"                 # åŠ å¯†
  kmsKeyId: "arn:aws:kms:..."       # KMSå¯†é’¥ARNï¼ˆå¯é€‰ï¼‰
volumeBindingMode: WaitForFirstConsumer  # å»¶è¿Ÿç»‘å®šï¼ˆç¡®ä¿åœ¨æ­£ç¡®çš„AZï¼‰
allowVolumeExpansion: true          # æ”¯æŒæ‰©å®¹
reclaimPolicy: Delete
```

**Azure Disk StorageClassç¤ºä¾‹ï¼š**

```yaml
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: azure-disk-premium
provisioner: disk.csi.azure.com
parameters:
  skuName: Premium_LRS              # Standard_LRS/Premium_LRS/StandardSSD_LRS
  kind: Managed                     # Managed/Shared
  cachingMode: ReadOnly             # None/ReadOnly/ReadWrite
reclaimPolicy: Delete
volumeBindingMode: WaitForFirstConsumer
allowVolumeExpansion: true
```

**GCP Persistent Disk StorageClassç¤ºä¾‹ï¼š**

```yaml
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: gcp-pd-ssd
provisioner: pd.csi.storage.gke.io
parameters:
  type: pd-ssd                      # pd-standard/pd-ssd/pd-balanced
  replication-type: regional-pd     # none/regional-pd
volumeBindingMode: WaitForFirstConsumer
allowVolumeExpansion: true
reclaimPolicy: Delete
```

**å¯¹æ¯”è¡¨ï¼š**

| äº‘å‚å•† | Provisioner | å­˜å‚¨ç±»å‹ | æ€§èƒ½ | ä»·æ ¼ |
|-------|------------|---------|------|------|
| **AWS** | `ebs.csi.aws.com` | gp3/gp2/io1/io2 | é«˜ | ä¸­ |
| **Azure** | `disk.csi.azure.com` | Premium_LRS/Standard_LRS | é«˜ | ä¸­ |
| **GCP** | `pd.csi.storage.gke.io` | pd-ssd/pd-standard | é«˜ | ä¸­ |

---

### 5.4.7 é»˜è®¤StorageClass

**è®¾ç½®é»˜è®¤StorageClassï¼š**

```yaml
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: standard
  annotations:
    storageclass.kubernetes.io/is-default-class: "true"  # è®¾ä¸ºé»˜è®¤
provisioner: kubernetes.io/gce-pd
parameters:
  type: pd-standard
```

**PVCä¸æŒ‡å®šstorageClassNameæ—¶ä½¿ç”¨é»˜è®¤ï¼š**

```yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: my-pvc
spec:
  # storageClassNameæœªæŒ‡å®šï¼Œä½¿ç”¨é»˜è®¤StorageClass
  accessModes:
  - ReadWriteOnce
  resources:
    requests:
      storage: 10Gi
```

**ç®¡ç†é»˜è®¤StorageClassï¼š**

```bash
# æŸ¥çœ‹é»˜è®¤StorageClass
kubectl get storageclass
# NAME                 PROVISIONER           RECLAIMPOLICY   VOLUMEBINDINGMODE
# standard (default)   kubernetes.io/gce-pd  Delete          Immediate

# å–æ¶ˆé»˜è®¤
kubectl patch storageclass standard -p '{"metadata": {"annotations":{"storageclass.kubernetes.io/is-default-class":"false"}}}'

# è®¾ç½®æ–°çš„é»˜è®¤
kubectl patch storageclass fast-ssd -p '{"metadata": {"annotations":{"storageclass.kubernetes.io/is-default-class":"true"}}}'

# ç¦ç”¨é»˜è®¤StorageClassï¼ˆPVCå¿…é¡»æ˜ç¡®æŒ‡å®šï¼‰
kubectl patch storageclass standard -p '{"metadata": {"annotations":{"storageclass.kubernetes.io/is-default-class":"false"}}}'
```

**æ³¨æ„äº‹é¡¹ï¼š**

- âš ï¸ é›†ç¾¤ä¸­åªèƒ½æœ‰ä¸€ä¸ªé»˜è®¤StorageClass
- âš ï¸ å¦‚æœæœ‰å¤šä¸ªStorageClassæ ‡è®°ä¸ºdefaultï¼Œè¡Œä¸ºæœªå®šä¹‰
- âš ï¸ PVCå¯ä»¥é€šè¿‡`storageClassName: ""`æ˜ç¡®ä¸ä½¿ç”¨StorageClassï¼ˆé™æ€ä¾›ç»™ï¼‰

---

### 5.4.8 Volumeæ‰©å®¹

**å‰ææ¡ä»¶ï¼š**

1. StorageClassçš„`allowVolumeExpansion: true`
2. åº•å±‚å­˜å‚¨æ”¯æŒæ‰©å®¹
3. CSIé©±åŠ¨æ”¯æŒæ‰©å®¹

**åœ¨çº¿æ‰©å®¹ï¼ˆæ¨èï¼‰ï¼š**

```bash
# 1. åˆ›å»ºæ”¯æŒæ‰©å®¹çš„StorageClass
cat <<EOF | kubectl apply -f -
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: expandable-sc
provisioner: ebs.csi.aws.com
allowVolumeExpansion: true        # å…è®¸æ‰©å®¹
volumeBindingMode: WaitForFirstConsumer
reclaimPolicy: Delete
EOF

# 2. åˆ›å»ºPVCï¼ˆåˆå§‹10Giï¼‰
cat <<EOF | kubectl apply -f -
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: expandable-pvc
spec:
  storageClassName: expandable-sc
  accessModes:
  - ReadWriteOnce
  resources:
    requests:
      storage: 10Gi
EOF

# 3. åˆ›å»ºPodä½¿ç”¨PVC
cat <<EOF | kubectl apply -f -
apiVersion: v1
kind: Pod
metadata:
  name: app
spec:
  containers:
  - name: app
    image: nginx
    volumeMounts:
    - name: data
      mountPath: /data
  volumes:
  - name: data
    persistentVolumeClaim:
      claimName: expandable-pvc
EOF

# 4. æŸ¥çœ‹å½“å‰å®¹é‡
kubectl exec app -- df -h /data
# Filesystem      Size  Used Avail Use% Mounted on
# /dev/xvdba      9.8G   24M  9.7G   1% /data

# 5. æ‰©å®¹åˆ°20Gi
kubectl patch pvc expandable-pvc -p '{"spec":{"resources":{"requests":{"storage":"20Gi"}}}}'

# 6. æŸ¥çœ‹æ‰©å®¹çŠ¶æ€
kubectl get pvc expandable-pvc -w
# NAME             STATUS   VOLUME                                     CAPACITY   ACCESS MODES
# expandable-pvc   Bound    pvc-abc123                                 10Gi       RWO
# expandable-pvc   Bound    pvc-abc123                                 20Gi       RWO  â† æ‰©å®¹å®Œæˆ

# 7. éªŒè¯æ–‡ä»¶ç³»ç»Ÿå·²æ‰©å®¹ï¼ˆåœ¨çº¿æ‰©å®¹ï¼Œæ— éœ€é‡å¯Podï¼‰
kubectl exec app -- df -h /data
# Filesystem      Size  Used Avail Use% Mounted on
# /dev/xvdba       20G   24M   20G   1% /data  â† å·²æ‰©å®¹åˆ°20G

# 8. æŸ¥çœ‹PVC Events
kubectl describe pvc expandable-pvc
# Events:
#   Type     Reason                      Message
#   ----     ------                      -------
#   Normal   VolumeResizeFailed          External resizer is resizing volume
#   Normal   FileSystemResizeSuccessful  MountVolume.NodeExpandVolume succeeded
```

**ç¦»çº¿æ‰©å®¹ï¼ˆéœ€è¦é‡å¯Podï¼‰ï¼š**

```bash
# æŸäº›å­˜å‚¨ç±»å‹éœ€è¦é‡å¯Podæ‰èƒ½ç”Ÿæ•ˆ

# 1. æ‰©å®¹PVC
kubectl patch pvc my-pvc -p '{"spec":{"resources":{"requests":{"storage":"20Gi"}}}}'

# 2. åˆ é™¤Podï¼ˆè§¦å‘æ–‡ä»¶ç³»ç»Ÿæ‰©å®¹ï¼‰
kubectl delete pod my-app

# 3. é‡æ–°åˆ›å»ºPod
kubectl apply -f my-app.yaml

# 4. éªŒè¯æ‰©å®¹
kubectl exec my-app -- df -h /data
```

**æ‰©å®¹é™åˆ¶ï¼š**

```
âš ï¸ æ³¨æ„äº‹é¡¹ï¼š
1. åªèƒ½æ‰©å®¹ï¼Œä¸èƒ½ç¼©å®¹
2. æŸäº›æ–‡ä»¶ç³»ç»Ÿéœ€è¦æ‰‹åŠ¨æ‰§è¡Œresize2fs/xfs_growfs
3. æ‰©å®¹åPVå®¹é‡å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿæ‰èƒ½ç”Ÿæ•ˆ
4. æ—§ç‰ˆæœ¬Kuberneteså¯èƒ½ä¸æ”¯æŒåœ¨çº¿æ‰©å®¹

âœ… æ”¯æŒåœ¨çº¿æ‰©å®¹çš„å­˜å‚¨ï¼š
- AWS EBS (gp2/gp3/io1/io2)
- GCP Persistent Disk
- Azure Disk
- Ceph RBD

âŒ ä¸æ”¯æŒæ‰©å®¹çš„å­˜å‚¨ï¼š
- NFSï¼ˆå–å†³äºNFSæœåŠ¡å™¨ï¼‰
- HostPath
```

---

### 5.4.9 StorageClasså‚æ•°è¯¦è§£

**NFS Client Provisionerå‚æ•°ï¼š**

```yaml
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: nfs-storage
provisioner: nfs-client
parameters:
  archiveOnDelete: "true"    # PVCåˆ é™¤æ—¶å½’æ¡£è€Œéåˆ é™¤
  pathPattern: "${.PVC.namespace}/${.PVC.name}"  # è‡ªå®šä¹‰è·¯å¾„æ¨¡å¼
```

**AWS EBSå‚æ•°ï¼š**

```yaml
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: aws-ebs
provisioner: ebs.csi.aws.com
parameters:
  type: gp3                  # gp2/gp3/io1/io2/st1/sc1
  iops: "3000"               # IOPSï¼ˆgp3: 3000-16000, io1/io2: 100-64000ï¼‰
  throughput: "125"          # ååé‡MB/sï¼ˆgp3: 125-1000ï¼‰
  encrypted: "true"          # åŠ å¯†
  kmsKeyId: "arn:aws:kms:..." # KMSå¯†é’¥
  fsType: ext4               # æ–‡ä»¶ç³»ç»Ÿï¼šext4/xfs
```

**Ceph RBDå‚æ•°ï¼š**

```yaml
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: ceph-rbd
provisioner: rook-ceph.rbd.csi.ceph.com
parameters:
  clusterID: rook-ceph
  pool: replicapool          # Cephå­˜å‚¨æ± 
  imageFormat: "2"           # RBDé•œåƒæ ¼å¼
  imageFeatures: layering    # RBDç‰¹æ€§
  csi.storage.k8s.io/provisioner-secret-name: rook-csi-rbd-provisioner
  csi.storage.k8s.io/provisioner-secret-namespace: rook-ceph
  csi.storage.k8s.io/node-stage-secret-name: rook-csi-rbd-node
  csi.storage.k8s.io/node-stage-secret-namespace: rook-ceph
  csi.storage.k8s.io/fstype: ext4
```

---

### 5.4.10 å®æˆ˜æ¡ˆä¾‹ï¼šå¤šå±‚å­˜å‚¨æ¶æ„

**åœºæ™¯ï¼šæ ¹æ®æ€§èƒ½éœ€æ±‚é€‰æ‹©ä¸åŒçš„StorageClass**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              åº”ç”¨åˆ†å±‚å­˜å‚¨ç­–ç•¥                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  é«˜æ€§èƒ½å±‚ï¼šæ•°æ®åº“ã€ç¼“å­˜                                    â”‚
â”‚  â”œâ”€ StorageClass: fast-ssd (AWS io2)                   â”‚
â”‚  â””â”€ ç‰¹ç‚¹ï¼šé«˜IOPSã€ä½å»¶è¿Ÿã€é«˜ä»·æ ¼                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  æ ‡å‡†å±‚ï¼šåº”ç”¨æ•°æ®ã€æ—¥å¿—                                    â”‚
â”‚  â”œâ”€ StorageClass: standard (AWS gp3)                   â”‚
â”‚  â””â”€ ç‰¹ç‚¹ï¼šå¹³è¡¡æ€§èƒ½ã€ä¸­ç­‰ä»·æ ¼                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  å½’æ¡£å±‚ï¼šå¤‡ä»½ã€å†å²æ•°æ®                                    â”‚
â”‚  â”œâ”€ StorageClass: archive (AWS st1)                   â”‚
â”‚  â””â”€ ç‰¹ç‚¹ï¼šå¤§å®¹é‡ã€ä½ä»·æ ¼ã€ä½æ€§èƒ½                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**åˆ›å»ºå¤šä¸ªStorageClassï¼š**

```yaml
# 1. é«˜æ€§èƒ½å­˜å‚¨ï¼ˆæ•°æ®åº“ï¼‰
---
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: fast-ssd
  labels:
    performance: high
provisioner: ebs.csi.aws.com
parameters:
  type: io2
  iops: "10000"
  throughput: "500"
  encrypted: "true"
volumeBindingMode: WaitForFirstConsumer
allowVolumeExpansion: true
reclaimPolicy: Retain        # ç”Ÿäº§æ•°æ®åº“ï¼Œé˜²æ­¢è¯¯åˆ 

# 2. æ ‡å‡†å­˜å‚¨ï¼ˆåº”ç”¨ï¼‰
---
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: standard
  labels:
    performance: medium
  annotations:
    storageclass.kubernetes.io/is-default-class: "true"
provisioner: ebs.csi.aws.com
parameters:
  type: gp3
  iops: "3000"
  throughput: "125"
  encrypted: "true"
volumeBindingMode: WaitForFirstConsumer
allowVolumeExpansion: true
reclaimPolicy: Delete

# 3. å½’æ¡£å­˜å‚¨ï¼ˆå¤‡ä»½ï¼‰
---
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: archive
  labels:
    performance: low
provisioner: ebs.csi.aws.com
parameters:
  type: st1              # ååä¼˜åŒ–å‹HDD
  encrypted: "true"
volumeBindingMode: WaitForFirstConsumer
allowVolumeExpansion: true
reclaimPolicy: Retain    # å¤‡ä»½æ•°æ®ä¿ç•™
```

**åº”ç”¨ä½¿ç”¨ç¤ºä¾‹ï¼š**

```yaml
# MySQLä½¿ç”¨é«˜æ€§èƒ½å­˜å‚¨
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: mysql-pvc
spec:
  storageClassName: fast-ssd    # ä½¿ç”¨é«˜æ€§èƒ½SSD
  accessModes:
  - ReadWriteOnce
  resources:
    requests:
      storage: 100Gi

# Webåº”ç”¨ä½¿ç”¨æ ‡å‡†å­˜å‚¨
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: webapp-pvc
spec:
  storageClassName: standard    # ä½¿ç”¨æ ‡å‡†å­˜å‚¨
  accessModes:
  - ReadWriteOnce
  resources:
    requests:
      storage: 50Gi

# å¤‡ä»½ä½¿ç”¨å½’æ¡£å­˜å‚¨
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: backup-pvc
spec:
  storageClassName: archive     # ä½¿ç”¨å½’æ¡£å­˜å‚¨
  accessModes:
  - ReadWriteOnce
  resources:
    requests:
      storage: 500Gi
```

---

### 5.4.11 StorageClassæœ€ä½³å®è·µ

**å‘½åè§„èŒƒï¼š**

```yaml
# âœ… æ¨èï¼šè¯­ä¹‰åŒ–å‘½å
StorageClassåç§°: <æ€§èƒ½>-<ç±»å‹>
  ç¤ºä¾‹: fast-ssd, standard-hdd, archive-tape

# æ ‡ç­¾åˆ†ç±»
labels:
  performance: high/medium/low
  cost: high/medium/low
  availability: high/medium/low
```

**æ€§èƒ½åˆ†çº§ï¼š**

| çº§åˆ« | é€‚ç”¨åœºæ™¯ | AWSç¤ºä¾‹ | ä»·æ ¼ |
|-----|---------|---------|------|
| **é«˜æ€§èƒ½** | æ•°æ®åº“ã€ç¼“å­˜ | io2 (10000+ IOPS) | é«˜ |
| **æ ‡å‡†** | åº”ç”¨ã€æ—¥å¿— | gp3 (3000 IOPS) | ä¸­ |
| **ä½æ€§èƒ½** | å¤‡ä»½ã€å½’æ¡£ | st1 (ååä¼˜åŒ–) | ä½ |

**å›æ”¶ç­–ç•¥é€‰æ‹©ï¼š**

```yaml
# âœ… æ¨èï¼šç”Ÿäº§ç¯å¢ƒä½¿ç”¨Retain
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: production-storage
reclaimPolicy: Retain    # é˜²æ­¢è¯¯åˆ 

# âœ… æ¨èï¼šå¼€å‘/æµ‹è¯•ç¯å¢ƒä½¿ç”¨Delete
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: dev-storage
reclaimPolicy: Delete    # è‡ªåŠ¨æ¸…ç†
```

**ç»‘å®šæ¨¡å¼é€‰æ‹©ï¼š**

```yaml
# âœ… æ¨èï¼šè·¨å¯ç”¨åŒºé›†ç¾¤ä½¿ç”¨WaitForFirstConsumer
volumeBindingMode: WaitForFirstConsumer

# âœ… å¯é€‰ï¼šå•å¯ç”¨åŒºé›†ç¾¤ä½¿ç”¨Immediate
volumeBindingMode: Immediate
```

**å®‰å…¨å»ºè®®ï¼š**

```yaml
# âœ… æ¨èï¼šå¯ç”¨åŠ å¯†
parameters:
  encrypted: "true"
  kmsKeyId: "arn:aws:kms:..."

# âœ… æ¨èï¼šä½¿ç”¨RBACé™åˆ¶StorageClassè®¿é—®
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: storage-user
rules:
- apiGroups: ["storage.k8s.io"]
  resources: ["storageclasses"]
  resourceNames: ["standard", "archive"]  # åªå…è®¸ä½¿ç”¨ç‰¹å®šStorageClass
  verbs: ["get", "list"]
- apiGroups: [""]
  resources: ["persistentvolumeclaims"]
  verbs: ["create", "get", "list"]
```

**æˆæœ¬ä¼˜åŒ–ï¼š**

```yaml
# âœ… æ¨èï¼šæ ¹æ®workloadé€‰æ‹©åˆé€‚çš„å­˜å‚¨ç±»å‹
# æ•°æ®åº“ â†’ io2 (é«˜IOPS)
# Webåº”ç”¨ â†’ gp3 (å¹³è¡¡)
# æ—¥å¿—/å¤‡ä»½ â†’ st1 (ä½æˆæœ¬)

# âœ… æ¨èï¼šå¯ç”¨è‡ªåŠ¨æ‰©å®¹ï¼Œé¿å…é¢„ç•™è¿‡å¤šç©ºé—´
allowVolumeExpansion: true

# âœ… æ¨èï¼šè®¾ç½®ResourceQuotaé™åˆ¶å­˜å‚¨æ€»é‡
apiVersion: v1
kind: ResourceQuota
metadata:
  name: storage-quota
spec:
  hard:
    requests.storage: "1Ti"  # é™åˆ¶æ€»å­˜å‚¨é‡
    persistentvolumeclaims: "50"  # é™åˆ¶PVCæ•°é‡
```

**æ•…éšœæ’æŸ¥ï¼š**

| é—®é¢˜ | æ’æŸ¥æ­¥éª¤ | è§£å†³æ–¹æ¡ˆ |
|-----|---------|---------|
| **PVCä¸€ç›´Pending** | `kubectl describe pvc <name>` | æ£€æŸ¥Provisioneræ˜¯å¦è¿è¡Œã€StorageClassæ˜¯å¦å­˜åœ¨ |
| **ProvisioneræŠ¥é”™** | `kubectl logs <provisioner-pod>` | æ£€æŸ¥å‚æ•°é…ç½®ã€å­˜å‚¨åç«¯è¿æ¥ |
| **æ‰©å®¹å¤±è´¥** | æ£€æŸ¥`allowVolumeExpansion` | è®¾ç½®ä¸ºtrueï¼Œæ£€æŸ¥CSIé©±åŠ¨æ”¯æŒ |
| **æ€§èƒ½é—®é¢˜** | æ£€æŸ¥IOPS/ååé‡å‚æ•° | å‡çº§åˆ°æ›´é«˜æ€§èƒ½çš„StorageClass |
| **æˆæœ¬è¿‡é«˜** | æŸ¥çœ‹å®é™…ä½¿ç”¨ç‡ | è°ƒæ•´å­˜å‚¨ç±»å‹æˆ–å¯ç”¨è‡ªåŠ¨æ‰©å®¹ |

**æœ¬èŠ‚å°ç»“ï¼š**

æˆ‘ä»¬è¯¦ç»†å­¦ä¹ äº†StorageClassåŠ¨æ€ä¾›ç»™æœºåˆ¶ï¼š

| æ¦‚å¿µ | æ ¸å¿ƒè¦ç‚¹ |
|-----|---------|
| **StorageClass** | å®šä¹‰å¦‚ä½•åŠ¨æ€åˆ›å»ºPV |
| **Provisioner** | å­˜å‚¨ä¾›åº”å•†ï¼Œæ‰§è¡Œå®é™…åˆ›å»ºå·¥ä½œ |
| **åŠ¨æ€ä¾›ç»™** | è‡ªåŠ¨åˆ›å»ºPVï¼Œæ— éœ€æ‰‹åŠ¨ç®¡ç† |
| **ç»‘å®šæ¨¡å¼** | Immediateï¼ˆç«‹å³ï¼‰vs WaitForFirstConsumerï¼ˆå»¶è¿Ÿï¼‰ |
| **æ‰©å®¹** | æ”¯æŒåœ¨çº¿/ç¦»çº¿æ‰©å®¹ |
| **å¤šå±‚å­˜å‚¨** | æ ¹æ®æ€§èƒ½éœ€æ±‚é€‰æ‹©ä¸åŒStorageClass |

æ¥ä¸‹æ¥æˆ‘ä»¬å°†æ·±å…¥å­¦ä¹ ConfigMapå’ŒSecretçš„é«˜çº§ç”¨æ³•ã€‚

---

## 5.5 ConfigMapå’ŒSecretæ·±åº¦è§£æ

åœ¨ç¬¬5.2èŠ‚ä¸­ï¼Œæˆ‘ä»¬åˆæ­¥æ¥è§¦äº†ConfigMapå’ŒSecretä½œä¸ºç‰¹æ®Šçš„Volumeç±»å‹ã€‚åœ¨å®é™…ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œåº”ç”¨é…ç½®ç®¡ç†å’Œæ•æ„Ÿæ•°æ®å¤„ç†æ˜¯éå¸¸é‡è¦çš„è¯é¢˜ã€‚æœ¬èŠ‚å°†æ·±å…¥æ¢è®¨ConfigMapå’ŒSecretçš„é«˜çº§ç”¨æ³•ã€æœ€ä½³å®è·µå’Œå®‰å…¨æœºåˆ¶ã€‚

### 5.5.1 ä¸ºä»€ä¹ˆéœ€è¦ConfigMapå’ŒSecret

**ä¼ ç»Ÿé…ç½®ç®¡ç†çš„ç—›ç‚¹ï¼š**

åœ¨å®¹å™¨åŒ–ä¹‹å‰ï¼Œåº”ç”¨é…ç½®é€šå¸¸æœ‰ä»¥ä¸‹å‡ ç§æ–¹å¼ï¼š

| æ–¹å¼ | ä¼˜ç‚¹ | ç¼ºç‚¹ |
|-----|------|------|
| **ç¡¬ç¼–ç ** | ç®€å•ç›´æ¥ | ä¿®æ”¹éœ€è¦é‡æ–°ç¼–è¯‘ã€æ— æ³•åŒºåˆ†ç¯å¢ƒ |
| **é…ç½®æ–‡ä»¶** | çµæ´»å¯è¯» | éœ€è¦æ‰“åŒ…åˆ°é•œåƒã€ä¿®æ”¹éœ€è¦é‡æ–°æ„å»º |
| **ç¯å¢ƒå˜é‡** | å®¹å™¨å‹å¥½ | éš¾ä»¥ç®¡ç†å¤æ‚é…ç½®ã€ç¼ºä¹ç‰ˆæœ¬æ§åˆ¶ |
| **å¤–éƒ¨é…ç½®ä¸­å¿ƒ** | é›†ä¸­ç®¡ç†ã€åŠ¨æ€æ›´æ–° | å¢åŠ ä¾èµ–ã€éœ€è¦é¢å¤–ç»„ä»¶ |

**å®¹å™¨åŒ–åçš„æ–°æŒ‘æˆ˜ï¼š**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        å®¹å™¨ä¸å¯å˜åŸºç¡€è®¾æ–½ç†å¿µ            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  é•œåƒ = ä»£ç  + ä¾èµ–ï¼ˆä¸åŒ…å«é…ç½®ï¼‰        â”‚
â”‚  é…ç½®åº”è¯¥å¤–éƒ¨åŒ–ã€å¯åŠ¨æ€æ³¨å…¥              â”‚
â”‚  æ•æ„Ÿä¿¡æ¯ä¸èƒ½ç¡¬ç¼–ç åˆ°é•œåƒä¸­              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ConfigMapå’ŒSecretçš„è®¾è®¡å“²å­¦ï¼š**

1. **é…ç½®ä¸ä»£ç åˆ†ç¦»**ï¼šé•œåƒåªåŒ…å«åº”ç”¨é€»è¾‘ï¼Œé…ç½®å¤–éƒ¨åŒ–
2. **ç¯å¢ƒæ— å…³æ€§**ï¼šåŒä¸€é•œåƒåœ¨dev/test/prodä½¿ç”¨ä¸åŒé…ç½®
3. **å®‰å…¨æ€§**ï¼šæ•æ„Ÿä¿¡æ¯é€šè¿‡SecretåŠ å¯†å­˜å‚¨å’Œä¼ è¾“
4. **å£°æ˜å¼ç®¡ç†**ï¼šé…ç½®ä¹Ÿæ˜¯èµ„æºï¼Œé€šè¿‡YAMLå£°æ˜å¼ç®¡ç†
5. **ç‰ˆæœ¬æ§åˆ¶**ï¼šé…ç½®å˜æ›´å¯è¿½æº¯ã€å¯å›æ»š

**ConfigMap vs Secretï¼š**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ç‰¹æ€§       â”‚    ConfigMap       â”‚      Secret        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ç”¨é€”         â”‚ éæ•æ„Ÿé…ç½®æ•°æ®     â”‚ æ•æ„Ÿæ•°æ®ï¼ˆå¯†ç ç­‰ï¼‰ â”‚
â”‚ å­˜å‚¨æ ¼å¼     â”‚ æ˜æ–‡å­˜å‚¨           â”‚ Base64ç¼–ç ï¼ˆetcdå¯åŠ å¯†ï¼‰â”‚
â”‚ ä¼ è¾“æ–¹å¼     â”‚ APIæ˜æ–‡ä¼ è¾“        â”‚ å†…å­˜tmpfsæŒ‚è½½      â”‚
â”‚ å…¸å‹åœºæ™¯     â”‚ åº”ç”¨é…ç½®æ–‡ä»¶       â”‚ å¯†ç ã€è¯ä¹¦ã€Token  â”‚
â”‚ å¤§å°é™åˆ¶     â”‚ 1MB                â”‚ 1MB                â”‚
â”‚ æŒ‚è½½æƒé™     â”‚ é»˜è®¤0644           â”‚ é»˜è®¤0400ï¼ˆåªè¯»ï¼‰   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.5.2 ConfigMapè¯¦è§£

#### 5.5.2.1 ConfigMapåˆ›å»ºæ–¹å¼

**æ–¹å¼1ï¼šé€šè¿‡kubectlå‘½ä»¤è¡Œåˆ›å»º**

```bash
# ä»å­—é¢å€¼åˆ›å»º
kubectl create configmap app-config \
  --from-literal=log_level=debug \
  --from-literal=max_connections=100

# ä»æ–‡ä»¶åˆ›å»º
echo "server.port=8080" > application.properties
kubectl create configmap app-config --from-file=application.properties

# ä»ç›®å½•åˆ›å»º
mkdir config-dir
echo "option1=value1" > config-dir/config1.txt
echo "option2=value2" > config-dir/config2.txt
kubectl create configmap app-config --from-file=config-dir/

# ä»envæ–‡ä»¶åˆ›å»º
cat > app.env <<EOF
DATABASE_HOST=mysql.default.svc.cluster.local
DATABASE_PORT=3306
EOF
kubectl create configmap app-config --from-env-file=app.env
```

**æ–¹å¼2ï¼šé€šè¿‡YAMLæ¸…å•åˆ›å»º**

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: app-config
  namespace: default
  labels:
    app: myapp
    env: production
data:
  # ç®€å•é”®å€¼å¯¹
  log_level: "info"
  max_connections: "100"

  # å®Œæ•´é…ç½®æ–‡ä»¶
  application.properties: |
    server.port=8080
    server.context-path=/api
    spring.datasource.url=jdbc:mysql://mysql:3306/mydb
    spring.datasource.username=root

  # JSONé…ç½®
  config.json: |
    {
      "database": {
        "host": "mysql.default.svc.cluster.local",
        "port": 3306
      },
      "cache": {
        "enabled": true,
        "ttl": 3600
      }
    }

  # Nginxé…ç½®ç¤ºä¾‹
  nginx.conf: |
    user nginx;
    worker_processes auto;
    events {
      worker_connections 1024;
    }
    http {
      include /etc/nginx/mime.types;
      server {
        listen 80;
        location / {
          proxy_pass http://backend:8080;
        }
      }
    }
```

**æ–¹å¼3ï¼šä»ç°æœ‰ConfigMapå¤åˆ¶**

```bash
# å¯¼å‡ºç°æœ‰ConfigMap
kubectl get configmap app-config -o yaml > app-config.yaml

# ä¿®æ”¹å¹¶åˆ›å»ºæ–°çš„
sed 's/app-config/app-config-v2/' app-config.yaml | kubectl apply -f -
```

#### 5.5.2.2 ConfigMapä½¿ç”¨æ–¹å¼

**ä½¿ç”¨æ–¹å¼1ï¼šç¯å¢ƒå˜é‡æ³¨å…¥**

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: env-demo
spec:
  containers:
  - name: app
    image: nginx:1.21

    # æ–¹å¼1ï¼šå¼•ç”¨æ•´ä¸ªConfigMapçš„æ‰€æœ‰é”®
    envFrom:
    - configMapRef:
        name: app-config

    # æ–¹å¼2ï¼šé€‰æ‹©æ€§å¼•ç”¨ç‰¹å®šé”®
    env:
    - name: LOG_LEVEL              # Podä¸­çš„ç¯å¢ƒå˜é‡å
      valueFrom:
        configMapKeyRef:
          name: app-config          # ConfigMapåç§°
          key: log_level            # ConfigMapä¸­çš„é”®
    - name: MAX_CONN
      valueFrom:
        configMapKeyRef:
          name: app-config
          key: max_connections
```

**éªŒè¯ç¯å¢ƒå˜é‡ï¼š**

```bash
kubectl exec env-demo -- env | grep -E 'LOG_LEVEL|MAX_CONN'
# è¾“å‡ºï¼š
# LOG_LEVEL=info
# MAX_CONN=100
```

**ä½¿ç”¨æ–¹å¼2ï¼šVolumeæŒ‚è½½**

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: volume-demo
spec:
  containers:
  - name: app
    image: nginx:1.21
    volumeMounts:
    # æŒ‚è½½æ•´ä¸ªConfigMap
    - name: config-volume
      mountPath: /etc/config          # æŒ‚è½½åˆ°å®¹å™¨çš„è·¯å¾„
      readOnly: true

    # æŒ‚è½½ç‰¹å®šé”®åˆ°ç‰¹å®šæ–‡ä»¶
    - name: nginx-config
      mountPath: /etc/nginx/nginx.conf
      subPath: nginx.conf             # åªæŒ‚è½½è¿™ä¸ªæ–‡ä»¶
      readOnly: true

  volumes:
  # æŒ‚è½½æ•´ä¸ªConfigMap
  - name: config-volume
    configMap:
      name: app-config

  # æŒ‚è½½ç‰¹å®šé”®
  - name: nginx-config
    configMap:
      name: app-config
      items:
      - key: nginx.conf               # ConfigMapä¸­çš„é”®
        path: nginx.conf              # å®¹å™¨ä¸­çš„æ–‡ä»¶å
        mode: 0644                    # æ–‡ä»¶æƒé™
```

**éªŒè¯æŒ‚è½½ï¼š**

```bash
# æŸ¥çœ‹æŒ‚è½½çš„æ–‡ä»¶
kubectl exec volume-demo -- ls -la /etc/config
# è¾“å‡ºï¼š
# total 0
# drwxrwxrwx 3 root root  140 Dec 27 10:00 .
# drwxr-xr-x 1 root root 4096 Dec 27 10:00 ..
# drwxr-xr-x 2 root root  100 Dec 27 10:00 ..2025_12_27_10_00_00.123456789
# lrwxrwxrwx 1 root root   31 Dec 27 10:00 ..data -> ..2025_12_27_10_00_00.123456789
# lrwxrwxrwx 1 root root   20 Dec 27 10:00 application.properties -> ..data/application.properties
# lrwxrwxrwx 1 root root   18 Dec 27 10:00 config.json -> ..data/config.json

kubectl exec volume-demo -- cat /etc/config/application.properties
```

**ä½¿ç”¨æ–¹å¼3ï¼šå‘½ä»¤è¡Œå‚æ•°**

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: command-demo
spec:
  containers:
  - name: app
    image: busybox
    command: ["/bin/sh", "-c"]
    args:
    - |
      echo "Log Level: $(LOG_LEVEL)"
      echo "Max Connections: $(MAX_CONN)"
      sleep 3600
    env:
    - name: LOG_LEVEL
      valueFrom:
        configMapKeyRef:
          name: app-config
          key: log_level
    - name: MAX_CONN
      valueFrom:
        configMapKeyRef:
          name: app-config
          key: max_connections
```

#### 5.5.2.3 ConfigMapçƒ­æ›´æ–°æœºåˆ¶

**VolumeæŒ‚è½½çš„ConfigMapæ”¯æŒè‡ªåŠ¨æ›´æ–°ï¼š**

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: dynamic-config
data:
  refresh_interval: "30"
---
apiVersion: v1
kind: Pod
metadata:
  name: hot-reload-demo
spec:
  containers:
  - name: app
    image: busybox
    command: ["/bin/sh", "-c"]
    args:
    - |
      while true; do
        echo "Current config: $(cat /etc/config/refresh_interval)"
        sleep 5
      done
    volumeMounts:
    - name: config
      mountPath: /etc/config
  volumes:
  - name: config
    configMap:
      name: dynamic-config
```

**æµ‹è¯•çƒ­æ›´æ–°ï¼š**

```bash
# å¯åŠ¨Pod
kubectl apply -f hot-reload-demo.yaml

# è§‚å¯Ÿæ—¥å¿—
kubectl logs -f hot-reload-demo
# è¾“å‡ºï¼šCurrent config: 30

# æ›´æ–°ConfigMap
kubectl patch configmap dynamic-config -p '{"data":{"refresh_interval":"60"}}'

# ç­‰å¾…çº¦1åˆ†é’Ÿï¼ˆkubeletåŒæ­¥å‘¨æœŸï¼‰ï¼Œæ—¥å¿—ä¼šæ˜¾ç¤ºï¼š
# Current config: 60
```

**çƒ­æ›´æ–°æ³¨æ„äº‹é¡¹ï¼š**

| æ³¨å…¥æ–¹å¼ | æ˜¯å¦æ”¯æŒçƒ­æ›´æ–° | æ›´æ–°å»¶è¿Ÿ | å¤‡æ³¨ |
|---------|--------------|---------|------|
| **ç¯å¢ƒå˜é‡** | âŒ ä¸æ”¯æŒ | N/A | éœ€è¦é‡å¯Pod |
| **VolumeæŒ‚è½½** | âœ… æ”¯æŒ | ~1åˆ†é’Ÿ | kubeletåŒæ­¥å‘¨æœŸå†³å®š |
| **subPathæŒ‚è½½** | âŒ ä¸æ”¯æŒ | N/A | subPathæ˜¯é™æ€ç»‘å®š |

**åº”ç”¨çº§çƒ­é‡è½½å®ç°ï¼š**

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: app-with-reload
spec:
  containers:
  # ä¸»åº”ç”¨å®¹å™¨
  - name: app
    image: myapp:1.0
    volumeMounts:
    - name: config
      mountPath: /etc/app/config

  # Sidecarå®¹å™¨ï¼šç›‘æ§é…ç½®å˜åŒ–å¹¶è§¦å‘é‡è½½
  - name: config-reloader
    image: jimmidyson/configmap-reload:v0.5.0
    args:
    - --volume-dir=/etc/config
    - --webhook-url=http://localhost:8080/reload
    volumeMounts:
    - name: config
      mountPath: /etc/config

  volumes:
  - name: config
    configMap:
      name: app-config
```

#### 5.5.2.4 ConfigMapä¸å¯å˜æ€§ï¼ˆImmutableï¼‰

**Kubernetes 1.21+æ”¯æŒä¸å¯å˜ConfigMapï¼š**

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: immutable-config
immutable: true              # æ ‡è®°ä¸ºä¸å¯å˜
data:
  database_host: "mysql.prod.svc.cluster.local"
  database_port: "3306"
```

**ä¸å¯å˜ConfigMapçš„å¥½å¤„ï¼š**

1. **é˜²æ­¢æ„å¤–ä¿®æ”¹**ï¼šç”Ÿäº§ç¯å¢ƒé…ç½®ä¸ä¼šè¢«è¯¯æ”¹
2. **æ€§èƒ½æå‡**ï¼škube-apiserverä¸éœ€è¦ç›‘æ§ConfigMapå˜åŒ–
3. **å‡å°‘etcdè´Ÿè½½**ï¼šå‡å°‘watchè¯·æ±‚
4. **å¼ºåˆ¶ç‰ˆæœ¬åŒ–**ï¼šé…ç½®æ›´æ–°å¿…é¡»åˆ›å»ºæ–°ConfigMap

**ç‰ˆæœ¬åŒ–é…ç½®ç®¡ç†æ¨¡å¼ï¼š**

```yaml
# ç‰ˆæœ¬1
apiVersion: v1
kind: ConfigMap
metadata:
  name: app-config-v1
  labels:
    version: "1.0"
immutable: true
data:
  setting: "value1"
---
# ç‰ˆæœ¬2
apiVersion: v1
kind: ConfigMap
metadata:
  name: app-config-v2
  labels:
    version: "2.0"
immutable: true
data:
  setting: "value2"
---
# Deploymentå¼•ç”¨ç‰¹å®šç‰ˆæœ¬
apiVersion: apps/v1
kind: Deployment
metadata:
  name: myapp
spec:
  replicas: 3
  selector:
    matchLabels:
      app: myapp
  template:
    metadata:
      labels:
        app: myapp
    spec:
      containers:
      - name: app
        image: myapp:1.0
        envFrom:
        - configMapRef:
            name: app-config-v2    # å¼•ç”¨ç‰¹å®šç‰ˆæœ¬
```

**é…ç½®æ›´æ–°æ»šåŠ¨å‡çº§ï¼š**

```bash
# åˆ›å»ºæ–°ç‰ˆæœ¬ConfigMap
kubectl apply -f app-config-v3.yaml

# æ›´æ–°Deploymentå¼•ç”¨æ–°ç‰ˆæœ¬
kubectl set env deployment/myapp --from=configmap/app-config-v3

# æˆ–è€…ç›´æ¥ä¿®æ”¹Deployment
kubectl patch deployment myapp -p \
  '{"spec":{"template":{"spec":{"containers":[{"name":"app","envFrom":[{"configMapRef":{"name":"app-config-v3"}}]}]}}}}'

# è§¦å‘æ»šåŠ¨æ›´æ–°
kubectl rollout status deployment/myapp
```

### 5.5.3 Secretè¯¦è§£

#### 5.5.3.1 Secretç±»å‹

Kuberneteså†…ç½®äº†å¤šç§Secretç±»å‹ï¼š

| ç±»å‹ | ç”¨é€” | æ•°æ®é”® |
|-----|------|--------|
| **Opaque** | é€šç”¨Secretï¼ˆé»˜è®¤ï¼‰ | è‡ªå®šä¹‰ |
| **kubernetes.io/service-account-token** | ServiceAccountä»¤ç‰Œ | token, ca.crt, namespace |
| **kubernetes.io/dockerconfigjson** | Dockeré•œåƒä»“åº“è®¤è¯ | .dockerconfigjson |
| **kubernetes.io/basic-auth** | åŸºæœ¬è®¤è¯ | username, password |
| **kubernetes.io/ssh-auth** | SSHè®¤è¯ | ssh-privatekey |
| **kubernetes.io/tls** | TLSè¯ä¹¦ | tls.crt, tls.key |
| **bootstrap.kubernetes.io/token** | Bootstrapä»¤ç‰Œ | token-id, token-secret |

#### 5.5.3.2 Secretåˆ›å»ºæ–¹å¼

**ç±»å‹1ï¼šOpaqueï¼ˆé€šç”¨Secretï¼‰**

```bash
# ä»å­—é¢å€¼åˆ›å»º
kubectl create secret generic db-secret \
  --from-literal=username=admin \
  --from-literal=password='MyP@ssw0rd!'

# ä»æ–‡ä»¶åˆ›å»º
echo -n 'admin' > username.txt
echo -n 'MyP@ssw0rd!' > password.txt
kubectl create secret generic db-secret \
  --from-file=username=username.txt \
  --from-file=password=password.txt
```

**YAMLæ–¹å¼ï¼ˆéœ€è¦æ‰‹åŠ¨Base64ç¼–ç ï¼‰ï¼š**

```bash
# ç”ŸæˆBase64ç¼–ç 
echo -n 'admin' | base64
# è¾“å‡ºï¼šYWRtaW4=
echo -n 'MyP@ssw0rd!' | base64
# è¾“å‡ºï¼šTXlQQHNzdzByZCE=
```

```yaml
apiVersion: v1
kind: Secret
metadata:
  name: db-secret
type: Opaque
data:
  username: YWRtaW4=           # admin
  password: TXlQQHNzdzByZCE=   # MyP@ssw0rd!
```

**ä½¿ç”¨stringDataï¼ˆè‡ªåŠ¨ç¼–ç ï¼‰ï¼š**

```yaml
apiVersion: v1
kind: Secret
metadata:
  name: db-secret
type: Opaque
stringData:                    # ä½¿ç”¨stringDataæ— éœ€æ‰‹åŠ¨ç¼–ç 
  username: admin
  password: MyP@ssw0rd!
```

**ç±»å‹2ï¼šDockeré•œåƒä»“åº“è®¤è¯**

```bash
# æ–¹å¼1ï¼šå‘½ä»¤è¡Œåˆ›å»º
kubectl create secret docker-registry my-registry-secret \
  --docker-server=registry.example.com \
  --docker-username=myuser \
  --docker-password=mypassword \
  --docker-email=user@example.com
```

```yaml
# æ–¹å¼2ï¼šYAMLåˆ›å»º
apiVersion: v1
kind: Secret
metadata:
  name: my-registry-secret
type: kubernetes.io/dockerconfigjson
data:
  .dockerconfigjson: eyJhdXRocyI6eyJyZWdpc3RyeS5leGFtcGxlLmNvbSI6eyJ1c2VybmFtZSI6Im15dXNlciIsInBhc3N3b3JkIjoibXlwYXNzd29yZCIsImVtYWlsIjoidXNlckBleGFtcGxlLmNvbSIsImF1dGgiOiJiWGwxYzJWeU9tMTVjR0Z6YzNkdmNtUT0ifX19
```

**åœ¨Podä¸­ä½¿ç”¨é•œåƒæ‹‰å–Secretï¼š**

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: private-image-demo
spec:
  imagePullSecrets:
  - name: my-registry-secret
  containers:
  - name: app
    image: registry.example.com/myapp:1.0
```

**ç±»å‹3ï¼šTLSè¯ä¹¦**

```bash
# ç”Ÿæˆè‡ªç­¾åè¯ä¹¦
openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
  -keyout tls.key -out tls.crt \
  -subj "/CN=myapp.example.com/O=myapp"

# åˆ›å»ºTLS Secret
kubectl create secret tls tls-secret \
  --cert=tls.crt \
  --key=tls.key
```

```yaml
# YAMLæ–¹å¼
apiVersion: v1
kind: Secret
metadata:
  name: tls-secret
type: kubernetes.io/tls
data:
  tls.crt: LS0tLS1CRUdJTi... # Base64ç¼–ç çš„è¯ä¹¦
  tls.key: LS0tLS1CRUdJTi... # Base64ç¼–ç çš„ç§é’¥
```

**åœ¨Ingressä¸­ä½¿ç”¨TLS Secretï¼š**

```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: tls-ingress
spec:
  tls:
  - hosts:
    - myapp.example.com
    secretName: tls-secret        # å¼•ç”¨TLS Secret
  rules:
  - host: myapp.example.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: myapp
            port:
              number: 80
```

**ç±»å‹4ï¼šåŸºæœ¬è®¤è¯**

```bash
kubectl create secret generic basic-auth-secret \
  --type=kubernetes.io/basic-auth \
  --from-literal=username=admin \
  --from-literal=password=secret123
```

```yaml
apiVersion: v1
kind: Secret
metadata:
  name: basic-auth-secret
type: kubernetes.io/basic-auth
stringData:
  username: admin
  password: secret123
```

**ç±»å‹5ï¼šSSHè®¤è¯**

```bash
# ç”ŸæˆSSHå¯†é’¥
ssh-keygen -t rsa -b 4096 -f id_rsa -N ""

# åˆ›å»ºSSH Secret
kubectl create secret generic ssh-secret \
  --type=kubernetes.io/ssh-auth \
  --from-file=ssh-privatekey=id_rsa
```

#### 5.5.3.3 Secretä½¿ç”¨æ–¹å¼

**ä½¿ç”¨æ–¹å¼1ï¼šç¯å¢ƒå˜é‡æ³¨å…¥**

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: secret-env-demo
spec:
  containers:
  - name: app
    image: mysql:8.0
    env:
    # å•ä¸ªSecreté”®
    - name: MYSQL_ROOT_PASSWORD
      valueFrom:
        secretKeyRef:
          name: db-secret
          key: password

    # æ•´ä¸ªSecret
    envFrom:
    - secretRef:
        name: db-secret
        prefix: DB_              # å¯é€‰å‰ç¼€
```

**ä½¿ç”¨æ–¹å¼2ï¼šVolumeæŒ‚è½½**

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: secret-volume-demo
spec:
  containers:
  - name: app
    image: nginx:1.21
    volumeMounts:
    - name: secret-volume
      mountPath: /etc/secrets
      readOnly: true            # Secretåº”è¯¥åªè¯»æŒ‚è½½

  volumes:
  - name: secret-volume
    secret:
      secretName: db-secret
      defaultMode: 0400         # åªæœ‰å±ä¸»å¯è¯»
      items:
      - key: username
        path: db-username
        mode: 0400
      - key: password
        path: db-password
        mode: 0400
```

**éªŒè¯SecretæŒ‚è½½ï¼š**

```bash
kubectl exec secret-volume-demo -- ls -la /etc/secrets
# è¾“å‡ºï¼š
# total 0
# drwxrwxrwt 3 root root  120 Dec 27 10:00 .
# drwxr-xr-x 1 root root 4096 Dec 27 10:00 ..
# drwxr-xr-x 2 root root   80 Dec 27 10:00 ..2025_12_27_10_00_00.123456789
# lrwxrwxrwx 1 root root   31 Dec 27 10:00 ..data -> ..2025_12_27_10_00_00.123456789
# lrwxrwxrwx 1 root root   22 Dec 27 10:00 db-username -> ..data/db-username
# lrwxrwxrwx 1 root root   22 Dec 27 10:00 db-password -> ..data/db-password

kubectl exec secret-volume-demo -- cat /etc/secrets/db-username
# è¾“å‡ºï¼šadmin
```

**ä½¿ç”¨æ–¹å¼3ï¼šæŠ•å°„å·ï¼ˆProjected Volumeï¼‰**

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: projected-demo
spec:
  containers:
  - name: app
    image: nginx:1.21
    volumeMounts:
    - name: all-in-one
      mountPath: /projected
      readOnly: true

  volumes:
  - name: all-in-one
    projected:
      sources:
      # Secretæº
      - secret:
          name: db-secret
          items:
          - key: username
            path: db/username

      # ConfigMapæº
      - configMap:
          name: app-config
          items:
          - key: log_level
            path: config/log_level

      # ServiceAccount Token
      - serviceAccountToken:
          path: token
          expirationSeconds: 3600
```

#### 5.5.3.4 Secretå®‰å…¨æœºåˆ¶

**1. etcdåŠ å¯†å­˜å‚¨**

é»˜è®¤æƒ…å†µä¸‹ï¼ŒSecretåœ¨etcdä¸­æ˜¯Base64ç¼–ç å­˜å‚¨ï¼ˆä¸æ˜¯åŠ å¯†ï¼‰ã€‚å¯ç”¨åŠ å¯†ï¼š

```yaml
# /etc/kubernetes/encryption-config.yaml
apiVersion: apiserver.config.k8s.io/v1
kind: EncryptionConfiguration
resources:
- resources:
  - secrets
  providers:
  - aescbc:
      keys:
      - name: key1
        secret: <BASE64-ENCODED-SECRET>  # 32å­—èŠ‚éšæœºå¯†é’¥çš„Base64ç¼–ç 
  - identity: {}                         # å›é€€åˆ°ä¸åŠ å¯†
```

**ç”ŸæˆåŠ å¯†å¯†é’¥ï¼š**

```bash
# ç”Ÿæˆ32å­—èŠ‚éšæœºå¯†é’¥
head -c 32 /dev/urandom | base64
```

**é…ç½®kube-apiserverï¼š**

```bash
# ä¿®æ”¹kube-apiserverå¯åŠ¨å‚æ•°
--encryption-provider-config=/etc/kubernetes/encryption-config.yaml
```

**éªŒè¯åŠ å¯†ï¼š**

```bash
# åˆ›å»ºæµ‹è¯•Secret
kubectl create secret generic test-secret --from-literal=key=value

# ç›´æ¥ä»etcdè¯»å–ï¼ˆæœªåŠ å¯†çš„æƒ…å†µä¸‹å¯ä»¥çœ‹åˆ°æ˜æ–‡ï¼‰
ETCDCTL_API=3 etcdctl get /registry/secrets/default/test-secret \
  --endpoints=https://127.0.0.1:2379 \
  --cacert=/etc/kubernetes/pki/etcd/ca.crt \
  --cert=/etc/kubernetes/pki/etcd/server.crt \
  --key=/etc/kubernetes/pki/etcd/server.key

# åŠ å¯†åè¾“å‡ºä¸ºä¹±ç 
```

**2. RBACæƒé™æ§åˆ¶**

```yaml
# é™åˆ¶Secretè®¿é—®æƒé™
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: secret-reader
  namespace: default
rules:
- apiGroups: [""]
  resources: ["secrets"]
  verbs: ["get", "list"]
  resourceNames: ["db-secret"]    # åªèƒ½è®¿é—®ç‰¹å®šSecret
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: read-secrets
  namespace: default
subjects:
- kind: ServiceAccount
  name: myapp
  namespace: default
roleRef:
  kind: Role
  name: secret-reader
  apiGroup: rbac.authorization.k8s.io
```

**3. Podå®‰å…¨ä¸Šä¸‹æ–‡**

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: secure-pod
spec:
  securityContext:
    runAsNonRoot: true
    runAsUser: 1000
    fsGroup: 2000
  containers:
  - name: app
    image: myapp:1.0
    securityContext:
      allowPrivilegeEscalation: false
      readOnlyRootFilesystem: true
      capabilities:
        drop:
        - ALL
    volumeMounts:
    - name: secrets
      mountPath: /etc/secrets
      readOnly: true
  volumes:
  - name: secrets
    secret:
      secretName: db-secret
      defaultMode: 0400          # ä¸¥æ ¼æƒé™
```

**4. Secretçš„å†…å­˜å­˜å‚¨ï¼ˆtmpfsï¼‰**

Secreté€šè¿‡VolumeæŒ‚è½½æ—¶ï¼Œå­˜å‚¨åœ¨tmpfsï¼ˆå†…å­˜æ–‡ä»¶ç³»ç»Ÿï¼‰ä¸­ï¼š

```bash
# è¿›å…¥å®¹å™¨æŸ¥çœ‹
kubectl exec -it secure-pod -- sh

# æ£€æŸ¥æŒ‚è½½ç±»å‹
mount | grep secrets
# è¾“å‡ºï¼štmpfs on /etc/secrets type tmpfs (ro,relatime)

# å¥½å¤„ï¼š
# 1. Secretä¸ä¼šå†™å…¥ç£ç›˜
# 2. Podåˆ é™¤åSecretè‡ªåŠ¨æ¸…é™¤
# 3. å‡å°‘æ³„éœ²é£é™©
```

#### 5.5.3.5 Secret vs External Secrets

**External Secrets Operatorï¼ˆESOï¼‰é›†æˆå¤–éƒ¨å¯†é’¥ç®¡ç†ç³»ç»Ÿï¼š**

```yaml
# å®‰è£…External Secrets Operator
kubectl apply -f https://raw.githubusercontent.com/external-secrets/external-secrets/main/deploy/crds/bundle.yaml
kubectl apply -f https://raw.githubusercontent.com/external-secrets/external-secrets/main/deploy/external-secrets.yaml
```

**é…ç½®SecretStoreï¼ˆä»¥AWS Secrets Managerä¸ºä¾‹ï¼‰ï¼š**

```yaml
apiVersion: external-secrets.io/v1beta1
kind: SecretStore
metadata:
  name: aws-secrets-manager
  namespace: default
spec:
  provider:
    aws:
      service: SecretsManager
      region: us-east-1
      auth:
        jwt:
          serviceAccountRef:
            name: external-secrets-sa
```

**åˆ›å»ºExternalSecretï¼š**

```yaml
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: db-credentials
  namespace: default
spec:
  refreshInterval: 1h           # æ¯å°æ—¶åŒæ­¥ä¸€æ¬¡
  secretStoreRef:
    name: aws-secrets-manager
    kind: SecretStore
  target:
    name: db-secret             # åˆ›å»ºçš„K8s Secretåç§°
    creationPolicy: Owner
  data:
  - secretKey: username         # K8s Secretä¸­çš„é”®
    remoteRef:
      key: prod/db/credentials  # AWSä¸­çš„Secretè·¯å¾„
      property: username        # AWS Secretä¸­çš„å±æ€§
  - secretKey: password
    remoteRef:
      key: prod/db/credentials
      property: password
```

**æ”¯æŒçš„å¤–éƒ¨å¯†é’¥ç®¡ç†ç³»ç»Ÿï¼š**

| æä¾›å•† | æœåŠ¡ | ä¼˜åŠ¿ |
|-------|------|------|
| **AWS** | Secrets Manager, Parameter Store | ä¸AWSæœåŠ¡æ·±åº¦é›†æˆ |
| **Google Cloud** | Secret Manager | GCPåŸç”Ÿæ”¯æŒ |
| **Azure** | Key Vault | Azureç”Ÿæ€ |
| **HashiCorp** | Vault | è·¨å¹³å°ã€åŠŸèƒ½å¼ºå¤§ |
| **Doppler** | Doppler Secrets | å¼€å‘è€…å‹å¥½ |

### 5.5.4 ConfigMapå’ŒSecretæœ€ä½³å®è·µ

#### 5.5.4.1 é…ç½®ç®¡ç†ç­–ç•¥

**1. åˆ†å±‚é…ç½®æ¶æ„**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         é…ç½®åˆ†å±‚æ¨¡å‹                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ç¬¬1å±‚ï¼šé»˜è®¤é…ç½®ï¼ˆæ‰“åŒ…åœ¨é•œåƒä¸­ï¼‰        â”‚
â”‚  ç¬¬2å±‚ï¼šç¯å¢ƒé€šç”¨é…ç½®ï¼ˆConfigMapï¼‰       â”‚
â”‚  ç¬¬3å±‚ï¼šåº”ç”¨ç‰¹å®šé…ç½®ï¼ˆConfigMapï¼‰       â”‚
â”‚  ç¬¬4å±‚ï¼šæ•æ„Ÿé…ç½®ï¼ˆSecretï¼‰              â”‚
â”‚  ç¬¬5å±‚ï¼šè¿è¡Œæ—¶åŠ¨æ€é…ç½®ï¼ˆé…ç½®ä¸­å¿ƒï¼‰      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å®è·µç¤ºä¾‹ï¼š**

```yaml
# ç¬¬2å±‚ï¼šç¯å¢ƒé€šç”¨é…ç½®
apiVersion: v1
kind: ConfigMap
metadata:
  name: env-common-config
  namespace: production
data:
  environment: "production"
  region: "us-east-1"
  log_format: "json"
---
# ç¬¬3å±‚ï¼šåº”ç”¨ç‰¹å®šé…ç½®
apiVersion: v1
kind: ConfigMap
metadata:
  name: myapp-config
  namespace: production
data:
  server_port: "8080"
  max_connections: "1000"
  cache_ttl: "3600"
---
# ç¬¬4å±‚ï¼šæ•æ„Ÿé…ç½®
apiVersion: v1
kind: Secret
metadata:
  name: myapp-secret
  namespace: production
type: Opaque
stringData:
  database_password: "SecureP@ss"
  api_key: "sk-abc123"
---
# Podä½¿ç”¨å¤šå±‚é…ç½®
apiVersion: v1
kind: Pod
metadata:
  name: myapp
spec:
  containers:
  - name: app
    image: myapp:1.0
    envFrom:
    - configMapRef:
        name: env-common-config     # å±‚2
    - configMapRef:
        name: myapp-config          # å±‚3
    - secretRef:
        name: myapp-secret          # å±‚4
```

**2. ç¯å¢ƒéš”ç¦»ç­–ç•¥**

```bash
# ä½¿ç”¨Namespaceéš”ç¦»ç¯å¢ƒ
kubectl create namespace dev
kubectl create namespace test
kubectl create namespace prod

# æ¯ä¸ªç¯å¢ƒç‹¬ç«‹çš„ConfigMap
kubectl create configmap app-config -n dev \
  --from-literal=env=development \
  --from-literal=debug=true

kubectl create configmap app-config -n prod \
  --from-literal=env=production \
  --from-literal=debug=false
```

**3. é…ç½®ç‰ˆæœ¬åŒ–ç®¡ç†**

```yaml
# ä½¿ç”¨Gitç®¡ç†é…ç½®
# config-repo/base/configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: app-config
data:
  common_setting: "value"
---
# config-repo/overlays/dev/configmap-patch.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: app-config
data:
  environment: "dev"
  debug: "true"
---
# config-repo/overlays/prod/configmap-patch.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: app-config
data:
  environment: "prod"
  debug: "false"
```

**ä½¿ç”¨Kustomizeç®¡ç†ï¼š**

```yaml
# config-repo/overlays/prod/kustomization.yaml
bases:
- ../../base
patchesStrategicMerge:
- configmap-patch.yaml
namespace: production
```

```bash
# åº”ç”¨é…ç½®
kubectl apply -k config-repo/overlays/prod/
```

#### 5.5.4.2 å®‰å…¨æœ€ä½³å®è·µ

**1. Secretæœ€å°æƒé™åŸåˆ™**

```yaml
# âŒ ä¸å¥½ï¼šè¿‡åº¦æˆæƒ
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: bad-role
rules:
- apiGroups: [""]
  resources: ["secrets"]
  verbs: ["*"]                  # æ‰€æœ‰æ“ä½œ
  resourceNames: ["*"]          # æ‰€æœ‰Secret
```

```yaml
# âœ… å¥½ï¼šæœ€å°æƒé™
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: good-role
rules:
- apiGroups: [""]
  resources: ["secrets"]
  verbs: ["get"]                # åªè¯»
  resourceNames: ["myapp-secret"]  # ç‰¹å®šSecret
```

**2. é¿å…åœ¨æ—¥å¿—ä¸­æ³„éœ²Secret**

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: secure-logging
spec:
  containers:
  - name: app
    image: myapp:1.0
    env:
    - name: DB_PASSWORD
      valueFrom:
        secretKeyRef:
          name: db-secret
          key: password

    # âŒ é”™è¯¯ï¼šå¯èƒ½æ³„éœ²åˆ°æ—¥å¿—
    # command: ["sh", "-c", "echo $DB_PASSWORD && ./app"]

    # âœ… æ­£ç¡®ï¼šä¸è¾“å‡ºæ•æ„Ÿä¿¡æ¯
    command: ["./app"]

    # åº”ç”¨å†…éƒ¨ä¹Ÿè¦æ³¨æ„
    # âŒ logger.info(f"Connecting with password: {password}")
    # âœ… logger.info("Connecting to database...")
```

**3. Secretè½®æ¢ç­–ç•¥**

```yaml
# ä½¿ç”¨External Secretså®ç°è‡ªåŠ¨è½®æ¢
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: db-credentials
spec:
  refreshInterval: 24h          # æ¯24å°æ—¶æ£€æŸ¥å¹¶æ›´æ–°
  secretStoreRef:
    name: vault-backend
  target:
    name: db-secret
    creationPolicy: Owner
  data:
  - secretKey: password
    remoteRef:
      key: database/creds/myapp
      property: password
```

**æ‰‹åŠ¨è½®æ¢æµç¨‹ï¼š**

```bash
# 1. åˆ›å»ºæ–°ç‰ˆæœ¬Secret
kubectl create secret generic db-secret-v2 \
  --from-literal=password=NewPassword123

# 2. æ›´æ–°Deploymentå¼•ç”¨
kubectl set env deployment/myapp --from=secret/db-secret-v2

# 3. éªŒè¯åº”ç”¨æ­£å¸¸è¿è¡Œ
kubectl rollout status deployment/myapp

# 4. åˆ é™¤æ—§Secret
kubectl delete secret db-secret-v1
```

**4. å®¡è®¡å’Œç›‘æ§**

```yaml
# å¯ç”¨å®¡è®¡æ—¥å¿—
apiVersion: audit.k8s.io/v1
kind: Policy
rules:
# è®°å½•Secretçš„æ‰€æœ‰è®¿é—®
- level: Metadata
  resources:
  - group: ""
    resources: ["secrets"]
  verbs: ["get", "list", "watch"]

# è®°å½•Secretçš„ä¿®æ”¹æ“ä½œ
- level: RequestResponse
  resources:
  - group: ""
    resources: ["secrets"]
  verbs: ["create", "update", "patch", "delete"]
```

#### 5.5.4.3 æ€§èƒ½ä¼˜åŒ–

**1. é¿å…è¿‡å¤§çš„ConfigMap/Secret**

```yaml
# âŒ ä¸å¥½ï¼šå•ä¸ªConfigMapåŒ…å«æ‰€æœ‰é…ç½®
apiVersion: v1
kind: ConfigMap
metadata:
  name: huge-config
data:
  config1: "..."    # 100KB
  config2: "..."    # 200KB
  config3: "..."    # 300KB
  # ... æ€»è®¡æ¥è¿‘1MBé™åˆ¶
```

```yaml
# âœ… å¥½ï¼šæ‹†åˆ†ä¸ºå¤šä¸ªConfigMap
apiVersion: v1
kind: ConfigMap
metadata:
  name: app-config
data:
  application.yaml: "..."    # 50KB
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: nginx-config
data:
  nginx.conf: "..."          # 30KB
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: logging-config
data:
  logback.xml: "..."         # 20KB
```

**2. ä½¿ç”¨Immutableå‡å°‘APIè´Ÿè½½**

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: static-config
immutable: true              # ä¸å¯å˜
data:
  readonly_setting: "value"

# å¥½å¤„ï¼š
# - kube-apiserverä¸éœ€è¦watchè¿™ä¸ªConfigMap
# - å‡å°‘etcdè´Ÿè½½
# - æå‡é›†ç¾¤æ€§èƒ½
```

**3. åˆç†ä½¿ç”¨æŠ•å°„å·**

```yaml
# âœ… å•ä¸ªVolumeæŒ‚è½½å¤šä¸ªæºï¼Œå‡å°‘æŒ‚è½½ç‚¹
apiVersion: v1
kind: Pod
metadata:
  name: optimized-pod
spec:
  containers:
  - name: app
    image: myapp:1.0
    volumeMounts:
    - name: combined
      mountPath: /config

  volumes:
  - name: combined
    projected:
      sources:
      - configMap:
          name: app-config
      - secret:
          name: app-secret
      - serviceAccountToken:
          path: token

# vs

# âŒ å¤šä¸ªç‹¬ç«‹VolumeæŒ‚è½½
  volumes:
  - name: config
    configMap:
      name: app-config
  - name: secret
    secret:
      secretName: app-secret
  - name: token
    serviceAccountToken:
      path: token
```

#### 5.5.4.4 å¸¸è§é—®é¢˜æ’æŸ¥

**é—®é¢˜1ï¼šConfigMap/Secretæœªç”Ÿæ•ˆ**

```bash
# æ£€æŸ¥ConfigMapæ˜¯å¦å­˜åœ¨
kubectl get configmap app-config -o yaml

# æ£€æŸ¥Podç¯å¢ƒå˜é‡
kubectl exec mypod -- env | grep -i config

# æ£€æŸ¥VolumeæŒ‚è½½
kubectl exec mypod -- ls -la /etc/config
kubectl exec mypod -- cat /etc/config/app.yaml

# æ£€æŸ¥Podäº‹ä»¶
kubectl describe pod mypod
```

**é—®é¢˜2ï¼šSecret Base64ç¼–ç é”™è¯¯**

```bash
# é”™è¯¯ç¤ºä¾‹
echo "password" | base64
# è¾“å‡ºï¼šcGFzc3dvcmQK  ï¼ˆåŒ…å«æ¢è¡Œç¬¦ï¼Œé”™è¯¯ï¼ï¼‰

# æ­£ç¡®æ–¹å¼
echo -n "password" | base64
# è¾“å‡ºï¼šcGFzc3dvcmQ=  ï¼ˆä½¿ç”¨-nå»é™¤æ¢è¡Œç¬¦ï¼‰

# éªŒè¯è§£ç 
echo "cGFzc3dvcmQ=" | base64 -d
# è¾“å‡ºï¼špassword
```

**é—®é¢˜3ï¼šçƒ­æ›´æ–°ä¸ç”Ÿæ•ˆ**

```bash
# åŸå› 1ï¼šä½¿ç”¨äº†subPathï¼ˆä¸æ”¯æŒçƒ­æ›´æ–°ï¼‰
# è§£å†³ï¼šç§»é™¤subPathï¼ŒæŒ‚è½½æ•´ä¸ªConfigMap

# åŸå› 2ï¼škubeletåŒæ­¥å»¶è¿Ÿ
# æŸ¥çœ‹kubeleté…ç½®
ps aux | grep kubelet | grep sync-frequency
# é»˜è®¤1åˆ†é’Ÿï¼Œå¯è°ƒæ•´ï¼š--sync-frequency=30s

# å¼ºåˆ¶åˆ·æ–°ï¼šé‡å¯Pod
kubectl rollout restart deployment/myapp
```

**é—®é¢˜4ï¼šSecretæƒé™é—®é¢˜**

```bash
# æ£€æŸ¥Secretæ–‡ä»¶æƒé™
kubectl exec mypod -- ls -la /etc/secrets

# å¦‚æœæƒé™ä¸å¯¹ï¼Œæ£€æŸ¥SecurityContext
kubectl get pod mypod -o yaml | grep -A 10 securityContext

# è°ƒæ•´Secret defaultMode
kubectl patch secret mysecret -p '{"defaultMode":0400}'
```

### 5.5.5 å®æˆ˜æ¡ˆä¾‹ï¼šå¤šç¯å¢ƒé…ç½®ç®¡ç†

#### 5.5.5.1 åœºæ™¯è®¾è®¡

**éœ€æ±‚ï¼š**
- éƒ¨ç½²ä¸€ä¸ªWebåº”ç”¨åˆ°Devã€Testã€Prodä¸‰ä¸ªç¯å¢ƒ
- æ¯ä¸ªç¯å¢ƒæ•°æ®åº“è¿æ¥ä¸åŒ
- Prodç¯å¢ƒéœ€è¦å¯ç”¨TLS
- é…ç½®éœ€è¦ç‰ˆæœ¬åŒ–ç®¡ç†

**æ¶æ„è®¾è®¡ï¼š**

```
config-repo/
â”œâ”€â”€ base/
â”‚   â”œâ”€â”€ kustomization.yaml
â”‚   â”œâ”€â”€ deployment.yaml
â”‚   â””â”€â”€ service.yaml
â”œâ”€â”€ overlays/
â”‚   â”œâ”€â”€ dev/
â”‚   â”‚   â”œâ”€â”€ kustomization.yaml
â”‚   â”‚   â”œâ”€â”€ configmap.yaml
â”‚   â”‚   â””â”€â”€ secret.yaml
â”‚   â”œâ”€â”€ test/
â”‚   â”‚   â”œâ”€â”€ kustomization.yaml
â”‚   â”‚   â”œâ”€â”€ configmap.yaml
â”‚   â”‚   â””â”€â”€ secret.yaml
â”‚   â””â”€â”€ prod/
â”‚       â”œâ”€â”€ kustomization.yaml
â”‚       â”œâ”€â”€ configmap.yaml
â”‚       â”œâ”€â”€ secret.yaml
â”‚       â””â”€â”€ tls-secret.yaml
```

#### 5.5.5.2 åŸºç¡€èµ„æºå®šä¹‰

**base/deployment.yamlï¼š**

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: webapp
spec:
  replicas: 1                    # overlayä¸­è¦†ç›–
  selector:
    matchLabels:
      app: webapp
  template:
    metadata:
      labels:
        app: webapp
    spec:
      containers:
      - name: app
        image: mywebapp:1.0
        ports:
        - containerPort: 8080
        envFrom:
        - configMapRef:
            name: app-config
        - secretRef:
            name: app-secret
        volumeMounts:
        - name: config-files
          mountPath: /etc/app
          readOnly: true
      volumes:
      - name: config-files
        projected:
          sources:
          - configMap:
              name: app-config
              items:
              - key: application.yaml
                path: application.yaml
```

**base/service.yamlï¼š**

```yaml
apiVersion: v1
kind: Service
metadata:
  name: webapp
spec:
  selector:
    app: webapp
  ports:
  - port: 80
    targetPort: 8080
```

**base/kustomization.yamlï¼š**

```yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

resources:
- deployment.yaml
- service.yaml
```

#### 5.5.5.3 Devç¯å¢ƒé…ç½®

**overlays/dev/configmap.yamlï¼š**

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: app-config
data:
  environment: "development"
  debug: "true"
  log_level: "debug"

  application.yaml: |
    server:
      port: 8080
    database:
      host: mysql.dev.svc.cluster.local
      port: 3306
      name: webapp_dev
    cache:
      enabled: false
    features:
      new_ui: true
      experimental: true
```

**overlays/dev/secret.yamlï¼š**

```yaml
apiVersion: v1
kind: Secret
metadata:
  name: app-secret
type: Opaque
stringData:
  database_username: "dev_user"
  database_password: "dev_password_123"
  api_key: "dev-api-key-xyz"
```

**overlays/dev/kustomization.yamlï¼š**

```yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: dev

bases:
- ../../base

resources:
- configmap.yaml
- secret.yaml

replicas:
- name: webapp
  count: 2                       # Devç¯å¢ƒ2ä¸ªå‰¯æœ¬

commonLabels:
  environment: dev
```

#### 5.5.5.4 Prodç¯å¢ƒé…ç½®

**overlays/prod/configmap.yamlï¼š**

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: app-config
immutable: true                  # ç”Ÿäº§ç¯å¢ƒä¸å¯å˜
data:
  environment: "production"
  debug: "false"
  log_level: "info"

  application.yaml: |
    server:
      port: 8080
      ssl:
        enabled: true
        cert: /etc/tls/tls.crt
        key: /etc/tls/tls.key
    database:
      host: mysql-primary.prod.svc.cluster.local
      port: 3306
      name: webapp_prod
      pool:
        min: 10
        max: 100
    cache:
      enabled: true
      ttl: 3600
      redis:
        host: redis.prod.svc.cluster.local
        port: 6379
    features:
      new_ui: false
      experimental: false
```

**overlays/prod/secret.yamlï¼š**

```yaml
apiVersion: v1
kind: Secret
metadata:
  name: app-secret
type: Opaque
stringData:
  database_username: "prod_user"
  # ç”Ÿäº§ç¯å¢ƒå¯†ç åº”è¯¥ä»å¯†é’¥ç®¡ç†ç³»ç»Ÿè·å–
  database_password: "PLACEHOLDER"  # å®é™…éƒ¨ç½²å‰æ›¿æ¢
  api_key: "PLACEHOLDER"
```

**overlays/prod/tls-secret.yamlï¼š**

```yaml
apiVersion: v1
kind: Secret
metadata:
  name: tls-cert
type: kubernetes.io/tls
data:
  tls.crt: LS0tLS1CRUdJTi...  # å®é™…è¯ä¹¦
  tls.key: LS0tLS1CRUdJTi...  # å®é™…ç§é’¥
```

**overlays/prod/kustomization.yamlï¼š**

```yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: production

bases:
- ../../base

resources:
- configmap.yaml
- secret.yaml
- tls-secret.yaml

replicas:
- name: webapp
  count: 5                       # ç”Ÿäº§ç¯å¢ƒ5ä¸ªå‰¯æœ¬

commonLabels:
  environment: production

# æ·»åŠ èµ„æºé™åˆ¶
patchesStrategicMerge:
- |-
  apiVersion: apps/v1
  kind: Deployment
  metadata:
    name: webapp
  spec:
    template:
      spec:
        containers:
        - name: app
          resources:
            requests:
              memory: "256Mi"
              cpu: "250m"
            limits:
              memory: "512Mi"
              cpu: "500m"
          volumeMounts:
          - name: tls
            mountPath: /etc/tls
            readOnly: true
        volumes:
        - name: tls
          secret:
            secretName: tls-cert
```

#### 5.5.5.5 éƒ¨ç½²æµç¨‹

**1. éªŒè¯é…ç½®ï¼š**

```bash
# é¢„è§ˆDevç¯å¢ƒé…ç½®
kubectl kustomize overlays/dev/

# é¢„è§ˆProdç¯å¢ƒé…ç½®
kubectl kustomize overlays/prod/
```

**2. éƒ¨ç½²åˆ°å„ç¯å¢ƒï¼š**

```bash
# éƒ¨ç½²åˆ°Dev
kubectl apply -k overlays/dev/

# éƒ¨ç½²åˆ°Test
kubectl apply -k overlays/test/

# éƒ¨ç½²åˆ°Prodï¼ˆéœ€è¦å…ˆæ›¿æ¢PLACEHOLDERï¼‰
# æ–¹å¼1ï¼šä½¿ç”¨sedæ›¿æ¢
cat overlays/prod/secret.yaml | \
  sed "s/PLACEHOLDER_PASSWORD/$(vault kv get -field=password secret/prod/db)/" | \
  kubectl apply -f -

# æ–¹å¼2ï¼šä½¿ç”¨External Secrets Operator
kubectl apply -f prod-external-secret.yaml
kubectl apply -k overlays/prod/
```

**3. éªŒè¯éƒ¨ç½²ï¼š**

```bash
# æ£€æŸ¥Devç¯å¢ƒ
kubectl get all -n dev
kubectl exec -n dev deployment/webapp -- env | grep -i database

# æ£€æŸ¥Prodç¯å¢ƒ
kubectl get all -n production
kubectl exec -n production deployment/webapp -- cat /etc/app/application.yaml
kubectl exec -n production deployment/webapp -- ls -la /etc/tls
```

**4. é…ç½®æ›´æ–°ï¼ˆProdç¯å¢ƒï¼‰ï¼š**

```bash
# å› ä¸ºä½¿ç”¨äº†immutable ConfigMapï¼Œéœ€è¦åˆ›å»ºæ–°ç‰ˆæœ¬
cp overlays/prod/configmap.yaml overlays/prod/configmap-v2.yaml
sed -i 's/name: app-config/name: app-config-v2/' overlays/prod/configmap-v2.yaml

# ä¿®æ”¹é…ç½®å†…å®¹
vim overlays/prod/configmap-v2.yaml

# åº”ç”¨æ–°é…ç½®
kubectl apply -f overlays/prod/configmap-v2.yaml

# æ›´æ–°Deploymentå¼•ç”¨
kubectl set env deployment/webapp -n production \
  --from=configmap/app-config-v2

# è§¦å‘æ»šåŠ¨æ›´æ–°
kubectl rollout status deployment/webapp -n production
```

### 5.5.6 æœ¬èŠ‚å°ç»“

æœ¬èŠ‚æ·±å…¥å­¦ä¹ äº†ConfigMapå’ŒSecretçš„é«˜çº§ç”¨æ³•ï¼š

| èµ„æºç±»å‹ | ç”¨é€” | æ ¸å¿ƒç‰¹æ€§ |
|---------|------|---------|
| **ConfigMap** | éæ•æ„Ÿé…ç½® | æ˜æ–‡å­˜å‚¨ã€æ”¯æŒçƒ­æ›´æ–°ã€å¯ä¸å¯å˜ |
| **Secret** | æ•æ„Ÿæ•°æ® | Base64ç¼–ç ã€tmpfsæŒ‚è½½ã€åŠ å¯†å­˜å‚¨ |

**æ ¸å¿ƒæ¦‚å¿µå›é¡¾ï¼š**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        ConfigMap/Secret æ ¸å¿ƒç‰¹æ€§        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  1. é…ç½®å¤–éƒ¨åŒ–ï¼ˆä¸é•œåƒåˆ†ç¦»ï¼‰            â”‚
â”‚  2. å¤šç§æ³¨å…¥æ–¹å¼ï¼ˆç¯å¢ƒå˜é‡/Volumeï¼‰     â”‚
â”‚  3. çƒ­æ›´æ–°æ”¯æŒï¼ˆVolumeæŒ‚è½½æ–¹å¼ï¼‰        â”‚
â”‚  4. ä¸å¯å˜æ€§ï¼ˆç”Ÿäº§ç¯å¢ƒæ¨èï¼‰            â”‚
â”‚  5. ç‰ˆæœ¬åŒ–ç®¡ç†ï¼ˆé…åˆKustomize/Helmï¼‰    â”‚
â”‚  6. å®‰å…¨æœºåˆ¶ï¼ˆRBAC/åŠ å¯†/å®¡è®¡ï¼‰          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æœ€ä½³å®è·µæ€»ç»“ï¼š**

1. **åˆ†å±‚é…ç½®**ï¼šé»˜è®¤é…ç½® < ç¯å¢ƒé…ç½® < åº”ç”¨é…ç½® < æ•æ„Ÿé…ç½®
2. **ç¯å¢ƒéš”ç¦»**ï¼šä½¿ç”¨Namespaceå’ŒKustomizeç®¡ç†å¤šç¯å¢ƒ
3. **å®‰å…¨ç¬¬ä¸€**ï¼šå¯ç”¨etcdåŠ å¯†ã€æœ€å°æƒé™ã€å®šæœŸè½®æ¢
4. **ç‰ˆæœ¬ç®¡ç†**ï¼šé…ç½®å³ä»£ç ï¼Œä½¿ç”¨Gitè¿½è¸ªå˜æ›´
5. **æ€§èƒ½ä¼˜åŒ–**ï¼šæ‹†åˆ†å¤§é…ç½®ã€ä½¿ç”¨immutableã€åˆç†ä½¿ç”¨æŠ•å°„å·

æ¥ä¸‹æ¥æˆ‘ä»¬å°†é€šè¿‡å®Œæ•´çš„å®æˆ˜é¡¹ç›®ï¼Œç»¼åˆè¿ç”¨æœ¬ç« æ‰€å­¦çš„å­˜å‚¨ç®¡ç†çŸ¥è¯†ã€‚

---

