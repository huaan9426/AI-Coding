# Python è„šæœ¬ç¼–ç¨‹åº•å±‚åŸç†ä¸å·¥ç¨‹å®è·µ

> **ä» Java è½¬ Python çš„ç¡¬æ ¸æŒ‡å—** - æ·±å…¥åº•å±‚ã€å·¥ç¨‹åŒ–å®è·µã€DevOps å¿…å¤‡

---

## ğŸ“‹ ç›®å½•

### ç¬¬ä¸€éƒ¨åˆ†ï¼šåº•å±‚åŸç†ä¸æ‰§è¡Œæœºåˆ¶
1. [Python è§£é‡Šå™¨ä¸å­—èŠ‚ç ](#1-python-è§£é‡Šå™¨ä¸å­—èŠ‚ç )
2. [å†…å­˜ç®¡ç†ä¸åƒåœ¾å›æ”¶](#2-å†…å­˜ç®¡ç†ä¸åƒåœ¾å›æ”¶)
3. [å˜é‡ä¸å¯¹è±¡æ¨¡å‹](#3-å˜é‡ä¸å¯¹è±¡æ¨¡å‹)
4. [å¯å˜å¯¹è±¡ vs ä¸å¯å˜å¯¹è±¡](#4-å¯å˜å¯¹è±¡-vs-ä¸å¯å˜å¯¹è±¡)

### ç¬¬äºŒéƒ¨åˆ†ï¼šé«˜çº§è¯­è¨€ç‰¹æ€§
5. [è£…é¥°å™¨æ·±åº¦è§£æ](#5-è£…é¥°å™¨æ·±åº¦è§£æ)
6. [ä¸Šä¸‹æ–‡ç®¡ç†å™¨](#6-ä¸Šä¸‹æ–‡ç®¡ç†å™¨)
7. [ç”Ÿæˆå™¨ä¸è¿­ä»£å™¨](#7-ç”Ÿæˆå™¨ä¸è¿­ä»£å™¨)
8. [åç¨‹ä¸å¼‚æ­¥ç¼–ç¨‹](#8-åç¨‹ä¸å¼‚æ­¥ç¼–ç¨‹)

### ç¬¬ä¸‰éƒ¨åˆ†ï¼šå·¥ç¨‹åŒ–å®è·µ
9. [å¼‚å¸¸å¤„ç†æœ€ä½³å®è·µ](#9-å¼‚å¸¸å¤„ç†æœ€ä½³å®è·µ)
10. [æ—¥å¿—ç³»ç»Ÿè®¾è®¡](#10-æ—¥å¿—ç³»ç»Ÿè®¾è®¡)
11. [é…ç½®ç®¡ç†ä¸ç¯å¢ƒå˜é‡](#11-é…ç½®ç®¡ç†ä¸ç¯å¢ƒå˜é‡)
12. [å•å…ƒæµ‹è¯•ä¸ä»£ç è´¨é‡](#12-å•å…ƒæµ‹è¯•ä¸ä»£ç è´¨é‡)

### ç¬¬å››éƒ¨åˆ†ï¼šDevOps è„šæœ¬ç¼–ç¨‹
13. [ç³»ç»Ÿè°ƒç”¨ä¸å­è¿›ç¨‹ç®¡ç†](#13-ç³»ç»Ÿè°ƒç”¨ä¸å­è¿›ç¨‹ç®¡ç†)
14. [æ–‡ä»¶ç³»ç»Ÿæ“ä½œ](#14-æ–‡ä»¶ç³»ç»Ÿæ“ä½œ)
15. [ç½‘ç»œç¼–ç¨‹åŸºç¡€](#15-ç½‘ç»œç¼–ç¨‹åŸºç¡€)
16. [å¤šçº¿ç¨‹ä¸å¤šè¿›ç¨‹](#16-å¤šçº¿ç¨‹ä¸å¤šè¿›ç¨‹)

### ç¬¬äº”éƒ¨åˆ†ï¼šæ€§èƒ½ä¼˜åŒ–ä¸è°ƒè¯•
17. [æ€§èƒ½åˆ†æä¸ä¼˜åŒ–](#17-æ€§èƒ½åˆ†æä¸ä¼˜åŒ–)
18. [è°ƒè¯•æŠ€å·§](#18-è°ƒè¯•æŠ€å·§)
19. [å¸¸è§é™·é˜±ä¸æœ€ä½³å®è·µ](#19-å¸¸è§é™·é˜±ä¸æœ€ä½³å®è·µ)

---

## ç¬¬ä¸€éƒ¨åˆ†ï¼šåº•å±‚åŸç†ä¸æ‰§è¡Œæœºåˆ¶

---

## 1. Python è§£é‡Šå™¨ä¸å­—èŠ‚ç 

### 1.1 æ‰§è¡Œæµç¨‹ï¼ˆvs Javaï¼‰

#### Java æ‰§è¡Œæµç¨‹
```
.java æºæ–‡ä»¶ â†’ javac ç¼–è¯‘ â†’ .class å­—èŠ‚ç  â†’ JVM æ‰§è¡Œ
```

#### Python æ‰§è¡Œæµç¨‹
```
.py æºæ–‡ä»¶ â†’ CPython ç¼–è¯‘ â†’ .pyc å­—èŠ‚ç  â†’ è§£é‡Šå™¨æ‰§è¡Œ
```

**å…³é”®åŒºåˆ«**ï¼š
- Java æ˜¯**ç¼–è¯‘å‹**ï¼ˆæå‰ç¼–è¯‘æˆå­—èŠ‚ç ï¼‰
- Python æ˜¯**è§£é‡Šå‹**ï¼ˆè¿è¡Œæ—¶ç¼–è¯‘ + è§£é‡Šæ‰§è¡Œï¼‰

### 1.2 æŸ¥çœ‹ Python å­—èŠ‚ç 

```python
import dis

def add(a, b):
    return a + b

# æŸ¥çœ‹å­—èŠ‚ç 
dis.dis(add)
```

**è¾“å‡ºç¤ºä¾‹**ï¼š
```
  2           0 LOAD_FAST                0 (a)
              2 LOAD_FAST                1 (b)
              4 BINARY_ADD
              6 RETURN_VALUE
```

**è§£è¯»**ï¼š
1. `LOAD_FAST 0` - åŠ è½½å±€éƒ¨å˜é‡ a åˆ°æ ˆé¡¶
2. `LOAD_FAST 1` - åŠ è½½å±€éƒ¨å˜é‡ b åˆ°æ ˆé¡¶
3. `BINARY_ADD` - å¼¹å‡ºä¸¤ä¸ªå€¼ç›¸åŠ ï¼Œç»“æœå‹æ ˆ
4. `RETURN_VALUE` - è¿”å›æ ˆé¡¶å€¼

### 1.3 .pyc æ–‡ä»¶ï¼ˆå­—èŠ‚ç ç¼“å­˜ï¼‰

```python
# è¿è¡Œæ—¶è‡ªåŠ¨ç”Ÿæˆ __pycache__/*.pyc
# åŠ å¿«ä¸‹æ¬¡å¯åŠ¨é€Ÿåº¦ï¼ˆæ— éœ€é‡æ–°ç¼–è¯‘ï¼‰

# ä¸»åŠ¨ç¼–è¯‘
import py_compile
py_compile.compile('script.py')

# ç¼–è¯‘æ•´ä¸ªç›®å½•
import compileall
compileall.compile_dir('.', force=True)
```

**ç”Ÿäº§ç¯å¢ƒæŠ€å·§**ï¼š
- âœ… Docker é•œåƒæ„å»ºæ—¶é¢„ç¼–è¯‘ â†’ å‡å°‘å¯åŠ¨æ—¶é—´
- âœ… éƒ¨ç½²æ—¶åˆ é™¤ .py æ–‡ä»¶ï¼Œä»…ä¿ç•™ .pyc â†’ ä»£ç ä¿æŠ¤

### 1.4 CPython vs PyPy vs Jython

| è§£é‡Šå™¨ | è¯­è¨€å®ç° | ä¼˜åŠ¿ | åŠ£åŠ¿ |
|--------|---------|------|------|
| **CPython** | C è¯­è¨€ | é»˜è®¤ã€å…¼å®¹æ€§å¼º | è¾ƒæ…¢ã€GIL é” |
| **PyPy** | Python + JIT | **å¿« 5-10 å€** | éƒ¨åˆ†åº“ä¸å…¼å®¹ |
| **Jython** | Java | è°ƒç”¨ Java åº“ | æ…¢ã€Python 3 æ”¯æŒå·® |

**ç‰¹æ–¯æ‹‰é¡¹ç›®é€‰æ‹©**ï¼š
- æ•°æ®å¤„ç†è„šæœ¬ â†’ **PyPy**ï¼ˆå¿«ï¼‰
- æ·±åº¦å­¦ä¹  â†’ **CPython**ï¼ˆåº“å…¼å®¹æ€§ï¼‰
- é›†æˆ Java ç³»ç»Ÿ â†’ **Jython**

---

## 2. å†…å­˜ç®¡ç†ä¸åƒåœ¾å›æ”¶

### 2.1 Python å†…å­˜ç®¡ç†æœºåˆ¶

#### å¯¹è±¡çš„å†…å­˜ç»“æ„
```python
# æ¯ä¸ª Python å¯¹è±¡éƒ½åŒ…å«ï¼š
# 1. å¼•ç”¨è®¡æ•°ï¼ˆref_countï¼‰
# 2. ç±»å‹æŒ‡é’ˆï¼ˆtype_ptrï¼‰
# 3. å®é™…æ•°æ®ï¼ˆvalueï¼‰

import sys

x = 42
print(sys.getsizeof(x))  # 28 å­—èŠ‚ï¼ˆint å¯¹è±¡ï¼‰

y = "hello"
print(sys.getsizeof(y))  # 54 å­—èŠ‚ï¼ˆstr å¯¹è±¡ + å…ƒæ•°æ®ï¼‰
```

### 2.2 å¼•ç”¨è®¡æ•°ï¼ˆReference Countingï¼‰

```python
import sys

x = [1, 2, 3]
print(sys.getrefcount(x))  # 2ï¼ˆ1 ä¸ªå˜é‡ + 1 ä¸ªä¸´æ—¶å¼•ç”¨ï¼‰

y = x  # å¼•ç”¨è®¡æ•° +1
print(sys.getrefcount(x))  # 3

del y  # å¼•ç”¨è®¡æ•° -1
print(sys.getrefcount(x))  # 2
```

**ä¼˜ç‚¹**ï¼š
- âœ… å³æ—¶å›æ”¶ï¼ˆå¼•ç”¨è®¡æ•°ä¸º 0 ç«‹å³é‡Šæ”¾ï¼‰

**ç¼ºç‚¹**ï¼š
- âŒ å¾ªç¯å¼•ç”¨æ— æ³•å›æ”¶

### 2.3 å¾ªç¯å¼•ç”¨ä¸åƒåœ¾å›æ”¶

```python
# å¾ªç¯å¼•ç”¨ç¤ºä¾‹
class Node:
    def __init__(self, value):
        self.value = value
        self.next = None

a = Node(1)
b = Node(2)
a.next = b
b.next = a  # å¾ªç¯å¼•ç”¨ï¼ša â†’ b â†’ a

# å³ä½¿åˆ é™¤å˜é‡ï¼Œå†…å­˜ä¹Ÿä¸ä¼šç«‹å³é‡Šæ”¾
del a
del b
```

**è§£å†³æ–¹æ¡ˆï¼šåˆ†ä»£åƒåœ¾å›æ”¶**
```python
import gc

# æ‰‹åŠ¨è§¦å‘åƒåœ¾å›æ”¶
gc.collect()

# æŸ¥çœ‹åƒåœ¾å›æ”¶ç»Ÿè®¡
print(gc.get_stats())

# ç¦ç”¨åƒåœ¾å›æ”¶ï¼ˆæ€§èƒ½ä¼˜åŒ–ï¼‰
gc.disable()
# ... æ‰§è¡Œå¯†é›†è®¡ç®— ...
gc.enable()
```

### 2.4 å†…å­˜æ³„æ¼æ’æŸ¥

```python
import tracemalloc

# å¼€å§‹è¿½è¸ªå†…å­˜åˆ†é…
tracemalloc.start()

# æ‰§è¡Œå¯èƒ½æ³„æ¼çš„ä»£ç 
data = []
for i in range(1000000):
    data.append([i] * 100)

# æŸ¥çœ‹å†…å­˜å¿«ç…§
snapshot = tracemalloc.take_snapshot()
top_stats = snapshot.statistics('lineno')

for stat in top_stats[:3]:
    print(stat)
```

**ç”Ÿäº§ç¯å¢ƒæŠ€å·§**ï¼š
```python
# è£…é¥°å™¨è‡ªåŠ¨è¿½è¸ªå†…å­˜
import functools
import tracemalloc

def track_memory(func):
    @functools.wraps(func)
    def wrapper(*args, **kwargs):
        tracemalloc.start()
        result = func(*args, **kwargs)
        current, peak = tracemalloc.get_traced_memory()
        tracemalloc.stop()
        print(f"{func.__name__}: å½“å‰ {current/1024/1024:.2f}MB, å³°å€¼ {peak/1024/1024:.2f}MB")
        return result
    return wrapper

@track_memory
def process_data():
    data = [i for i in range(1000000)]
    return len(data)
```

---

## 3. å˜é‡ä¸å¯¹è±¡æ¨¡å‹

### 3.1 Python å˜é‡çš„æœ¬è´¨ï¼ˆvs Javaï¼‰

#### Java å˜é‡
```java
// Java: å˜é‡æ˜¯"å®¹å™¨"ï¼ˆå­˜å‚¨å€¼ï¼‰
int x = 5;      // x ç›´æ¥å­˜å‚¨ 5
String s = "hello";  // s å­˜å‚¨å¯¹è±¡å¼•ç”¨
```

#### Python å˜é‡
```python
# Python: å˜é‡æ˜¯"æ ‡ç­¾"ï¼ˆæŒ‡å‘å¯¹è±¡ï¼‰
x = 5       # x æ˜¯æŒ‡å‘æ•´æ•°å¯¹è±¡ 5 çš„æ ‡ç­¾
y = x       # y ä¹ŸæŒ‡å‘åŒä¸€ä¸ªå¯¹è±¡
z = 5       # z ä¹ŸæŒ‡å‘åŒä¸€ä¸ªå¯¹è±¡ï¼ˆæ•´æ•°ç¼“å­˜ï¼‰

print(id(x), id(y), id(z))  # ä¸‰ä¸ª ID ç›¸åŒï¼
```

### 3.2 å¯¹è±¡èº«ä»½ã€ç±»å‹ã€å€¼

```python
x = [1, 2, 3]
y = [1, 2, 3]

# 1. èº«ä»½ï¼ˆidentityï¼‰- å†…å­˜åœ°å€
print(id(x))        # 4312345678
print(id(y))        # 4312345789ï¼ˆä¸åŒå¯¹è±¡ï¼‰
print(x is y)       # False

# 2. ç±»å‹ï¼ˆtypeï¼‰
print(type(x))      # <class 'list'>

# 3. å€¼ï¼ˆvalueï¼‰
print(x == y)       # Trueï¼ˆå€¼ç›¸åŒï¼‰
```

**åˆ¤ç­‰è§„åˆ™**ï¼š
```python
# is: åˆ¤æ–­èº«ä»½ï¼ˆåŒä¸€å¯¹è±¡ï¼‰
# ==: åˆ¤æ–­å€¼ï¼ˆå†…å®¹ç›¸åŒï¼‰

a = [1, 2]
b = [1, 2]
c = a

print(a == b)  # Trueï¼ˆå€¼ç›¸åŒï¼‰
print(a is b)  # Falseï¼ˆä¸åŒå¯¹è±¡ï¼‰
print(a is c)  # Trueï¼ˆåŒä¸€å¯¹è±¡ï¼‰
```

### 3.3 æ•´æ•°ç¼“å­˜æœºåˆ¶

```python
# Python ç¼“å­˜å°æ•´æ•° [-5, 256]
a = 100
b = 100
print(a is b)  # Trueï¼ˆåŒä¸€å¯¹è±¡ï¼‰

c = 1000
d = 1000
print(c is d)  # Falseï¼ˆä¸åŒå¯¹è±¡ï¼‰
```

**åŸå› **ï¼šå°æ•´æ•°ä½¿ç”¨é¢‘ç¹ï¼Œé¢„å…ˆåˆ›å»ºé¿å…é‡å¤åˆ†é…ã€‚

### 3.4 å­—ç¬¦ä¸²é©»ç•™ï¼ˆString Interningï¼‰

```python
# å­—ç¬¦ä¸²é©»ç•™ï¼šç›¸åŒå­—ç¬¦ä¸²å…±äº«å†…å­˜
s1 = "hello"
s2 = "hello"
print(s1 is s2)  # True

# ä½†åŠ¨æ€åˆ›å»ºçš„å­—ç¬¦ä¸²ä¸é©»ç•™
s3 = "hel" + "lo"
print(s1 is s3)  # Falseï¼ˆCPython å®ç°ç»†èŠ‚ï¼‰

# å¼ºåˆ¶é©»ç•™
import sys
s4 = sys.intern("hello")
print(s1 is s4)  # True
```

---

## 4. å¯å˜å¯¹è±¡ vs ä¸å¯å˜å¯¹è±¡

### 4.1 æ ¸å¿ƒæ¦‚å¿µ

| ä¸å¯å˜å¯¹è±¡ | å¯å˜å¯¹è±¡ |
|-----------|---------|
| int, float, str | list, dict, set |
| tuple | è‡ªå®šä¹‰ç±»ï¼ˆé»˜è®¤ï¼‰ |
| frozenset | bytearray |

### 4.2 ä¸å¯å˜å¯¹è±¡çš„é™·é˜±

```python
# å­—ç¬¦ä¸²æ‹¼æ¥çš„æ€§èƒ½é™·é˜±
# âŒ ä½æ•ˆï¼šæ¯æ¬¡æ‹¼æ¥åˆ›å»ºæ–°å¯¹è±¡
result = ""
for i in range(10000):
    result += str(i)  # åˆ›å»º 10000 ä¸ªä¸´æ—¶å­—ç¬¦ä¸²å¯¹è±¡

# âœ… é«˜æ•ˆï¼šå…ˆå­˜åˆ—è¡¨ï¼Œæœ€åä¸€æ¬¡æ‹¼æ¥
parts = []
for i in range(10000):
    parts.append(str(i))
result = "".join(parts)  # ä»…åˆ›å»º 1 ä¸ªæœ€ç»ˆå­—ç¬¦ä¸²

# æ€§èƒ½å¯¹æ¯”
import timeit
print(timeit.timeit('s = ""; [s := s + str(i) for i in range(1000)]', number=100))  # ~0.5s
print(timeit.timeit('s = []; [s.append(str(i)) for i in range(1000)]; "".join(s)', number=100))  # ~0.02s
```

### 4.3 å¯å˜å¯¹è±¡çš„é™·é˜±

#### é™·é˜± 1ï¼šé»˜è®¤å‚æ•°
```python
# âŒ é”™è¯¯ï¼šé»˜è®¤å‚æ•°æ˜¯å¯å˜å¯¹è±¡
def add_item(item, items=[]):  # å±é™©ï¼
    items.append(item)
    return items

print(add_item(1))  # [1]
print(add_item(2))  # [1, 2]ï¼ˆé¢„æœŸæ˜¯ [2]ï¼‰
print(add_item(3))  # [1, 2, 3]ï¼ˆé¢„æœŸæ˜¯ [3]ï¼‰

# âœ… æ­£ç¡®
def add_item(item, items=None):
    if items is None:
        items = []
    items.append(item)
    return items
```

#### é™·é˜± 2ï¼šæµ…æ‹·è´ vs æ·±æ‹·è´
```python
import copy

# åŸå§‹åˆ—è¡¨
original = [[1, 2], [3, 4]]

# æµ…æ‹·è´ï¼ˆä»…å¤åˆ¶å¤–å±‚ï¼‰
shallow = copy.copy(original)
shallow[0][0] = 999
print(original)  # [[999, 2], [3, 4]]ï¼ˆè¢«ä¿®æ”¹ï¼ï¼‰

# æ·±æ‹·è´ï¼ˆé€’å½’å¤åˆ¶æ‰€æœ‰å±‚ï¼‰
deep = copy.deepcopy(original)
deep[0][0] = 777
print(original)  # [[999, 2], [3, 4]]ï¼ˆæœªæ”¹å˜ï¼‰
```

### 4.4 ç”Ÿäº§ç¯å¢ƒæœ€ä½³å®è·µ

```python
# è§„åˆ™ 1ï¼šå‡½æ•°å‚æ•°ä¸ä½¿ç”¨å¯å˜é»˜è®¤å€¼
def process_data(data, config=None):
    if config is None:
        config = {"timeout": 30}
    # ...

# è§„åˆ™ 2ï¼šè¿”å›å‰¯æœ¬è€ŒéåŸå¯¹è±¡
class DataProcessor:
    def __init__(self):
        self._data = []

    def get_data(self):
        # âœ… è¿”å›å‰¯æœ¬ï¼Œé˜²æ­¢å¤–éƒ¨ä¿®æ”¹
        return self._data.copy()

# è§„åˆ™ 3ï¼šä½¿ç”¨ä¸å¯å˜æ•°æ®ç»“æ„
from typing import Tuple

def get_config() -> Tuple[str, int]:
    # è¿”å› tuple è€Œé list
    return ("localhost", 8080)
```

---

## ç¬¬äºŒéƒ¨åˆ†ï¼šé«˜çº§è¯­è¨€ç‰¹æ€§

---

## 5. è£…é¥°å™¨æ·±åº¦è§£æ

### 5.1 è£…é¥°å™¨æœ¬è´¨

**è£…é¥°å™¨ = é«˜é˜¶å‡½æ•°ï¼ˆæ¥æ”¶å‡½æ•°ï¼Œè¿”å›å‡½æ•°ï¼‰**

```python
# åŸºç¡€è£…é¥°å™¨
def my_decorator(func):
    def wrapper(*args, **kwargs):
        print("Before function")
        result = func(*args, **kwargs)
        print("After function")
        return result
    return wrapper

@my_decorator
def greet(name):
    print(f"Hello, {name}")

# ç­‰ä»·äºï¼šgreet = my_decorator(greet)
```

### 5.2 ä¿ç•™åŸå‡½æ•°å…ƒæ•°æ®

```python
import functools

def my_decorator(func):
    @functools.wraps(func)  # â† ä¿ç•™åŸå‡½æ•°çš„ __name__, __doc__ ç­‰
    def wrapper(*args, **kwargs):
        return func(*args, **kwargs)
    return wrapper

@my_decorator
def greet(name):
    """Say hello"""
    print(f"Hello, {name}")

print(greet.__name__)  # "greet"ï¼ˆä¸åŠ  @wraps ä¼šæ˜¯ "wrapper"ï¼‰
print(greet.__doc__)   # "Say hello"
```

### 5.3 å¸¦å‚æ•°çš„è£…é¥°å™¨

```python
def repeat(times):
    """é‡å¤æ‰§è¡Œè£…é¥°å™¨"""
    def decorator(func):
        @functools.wraps(func)
        def wrapper(*args, **kwargs):
            for _ in range(times):
                result = func(*args, **kwargs)
            return result
        return wrapper
    return decorator

@repeat(times=3)
def say_hello():
    print("Hello!")

# say_hello()  # æ‰“å° 3 æ¬¡ "Hello!"
```

### 5.4 DevOps å¸¸ç”¨è£…é¥°å™¨

#### 5.4.1 é‡è¯•è£…é¥°å™¨
```python
import time
import functools

def retry(max_attempts=3, delay=1, exceptions=(Exception,)):
    """è‡ªåŠ¨é‡è¯•è£…é¥°å™¨"""
    def decorator(func):
        @functools.wraps(func)
        def wrapper(*args, **kwargs):
            for attempt in range(1, max_attempts + 1):
                try:
                    return func(*args, **kwargs)
                except exceptions as e:
                    if attempt == max_attempts:
                        raise
                    print(f"âŒ å¤±è´¥ï¼ˆç¬¬ {attempt} æ¬¡ï¼‰ï¼Œ{delay}s åé‡è¯•...")
                    time.sleep(delay)
        return wrapper
    return decorator

@retry(max_attempts=3, delay=2, exceptions=(ConnectionError,))
def fetch_data(url):
    import requests
    response = requests.get(url, timeout=5)
    return response.json()
```

#### 5.4.2 æ€§èƒ½è®¡æ—¶è£…é¥°å™¨
```python
import time
import functools

def timer(func):
    """å‡½æ•°æ‰§è¡Œæ—¶é—´ç»Ÿè®¡"""
    @functools.wraps(func)
    def wrapper(*args, **kwargs):
        start = time.time()
        result = func(*args, **kwargs)
        elapsed = time.time() - start
        print(f"â±ï¸  {func.__name__} è€—æ—¶: {elapsed:.3f}s")
        return result
    return wrapper

@timer
def process_data():
    time.sleep(2)
    return "done"
```

#### 5.4.3 æ—¥å¿—è£…é¥°å™¨
```python
import logging
import functools

def log_call(logger=None):
    """è®°å½•å‡½æ•°è°ƒç”¨æ—¥å¿—"""
    if logger is None:
        logger = logging.getLogger(__name__)

    def decorator(func):
        @functools.wraps(func)
        def wrapper(*args, **kwargs):
            logger.info(f"è°ƒç”¨ {func.__name__}ï¼Œå‚æ•°: args={args}, kwargs={kwargs}")
            try:
                result = func(*args, **kwargs)
                logger.info(f"{func.__name__} è¿”å›: {result}")
                return result
            except Exception as e:
                logger.error(f"{func.__name__} å¼‚å¸¸: {e}")
                raise
        return wrapper
    return decorator

@log_call()
def divide(a, b):
    return a / b
```

#### 5.4.4 ç±»è£…é¥°å™¨ï¼ˆå•ä¾‹æ¨¡å¼ï¼‰
```python
def singleton(cls):
    """å•ä¾‹æ¨¡å¼è£…é¥°å™¨"""
    instances = {}
    @functools.wraps(cls)
    def get_instance(*args, **kwargs):
        if cls not in instances:
            instances[cls] = cls(*args, **kwargs)
        return instances[cls]
    return get_instance

@singleton
class Config:
    def __init__(self):
        self.settings = {"timeout": 30}

config1 = Config()
config2 = Config()
print(config1 is config2)  # Trueï¼ˆåŒä¸€å®ä¾‹ï¼‰
```

---

## 6. ä¸Šä¸‹æ–‡ç®¡ç†å™¨

### 6.1 with è¯­å¥çš„åŸç†

```python
# ä¼ ç»Ÿæ–¹å¼ï¼ˆæ˜“å‡ºé”™ï¼‰
file = open("data.txt", "r")
try:
    content = file.read()
finally:
    file.close()  # ç¡®ä¿å…³é—­

# with è¯­å¥ï¼ˆè‡ªåŠ¨ç®¡ç†ï¼‰
with open("data.txt", "r") as file:
    content = file.read()
# è‡ªåŠ¨è°ƒç”¨ file.close()
```

### 6.2 è‡ªå®šä¹‰ä¸Šä¸‹æ–‡ç®¡ç†å™¨

#### æ–¹æ³• 1ï¼šç±»å®ç°
```python
class Timer:
    def __enter__(self):
        self.start = time.time()
        print("â±ï¸  å¼€å§‹è®¡æ—¶")
        return self

    def __exit__(self, exc_type, exc_val, exc_tb):
        elapsed = time.time() - self.start
        print(f"â±ï¸  ç»“æŸè®¡æ—¶: {elapsed:.3f}s")
        # è¿”å› False è¡¨ç¤ºå¼‚å¸¸ç»§ç»­ä¼ æ’­
        # è¿”å› True è¡¨ç¤ºå‹åˆ¶å¼‚å¸¸
        return False

with Timer():
    time.sleep(2)
    print("æ‰§è¡Œä»»åŠ¡")
```

#### æ–¹æ³• 2ï¼š@contextmanager è£…é¥°å™¨
```python
from contextlib import contextmanager

@contextmanager
def timer():
    start = time.time()
    print("â±ï¸  å¼€å§‹è®¡æ—¶")
    try:
        yield  # è®©å‡ºæ§åˆ¶æƒç»™ with å—
    finally:
        elapsed = time.time() - start
        print(f"â±ï¸  ç»“æŸè®¡æ—¶: {elapsed:.3f}s")

with timer():
    time.sleep(2)
```

### 6.3 DevOps å¸¸ç”¨ä¸Šä¸‹æ–‡ç®¡ç†å™¨

#### 6.3.1 ä¸´æ—¶åˆ‡æ¢ç›®å½•
```python
import os
from contextlib import contextmanager

@contextmanager
def cd(path):
    """ä¸´æ—¶åˆ‡æ¢å·¥ä½œç›®å½•"""
    old_path = os.getcwd()
    os.chdir(path)
    try:
        yield
    finally:
        os.chdir(old_path)

# ä½¿ç”¨
with cd("/tmp"):
    print(os.getcwd())  # /tmp
    # æ‰§è¡Œæ“ä½œ
print(os.getcwd())  # æ¢å¤åŸç›®å½•
```

#### 6.3.2 ä¸´æ—¶ä¿®æ”¹ç¯å¢ƒå˜é‡
```python
@contextmanager
def set_env(**kwargs):
    """ä¸´æ—¶è®¾ç½®ç¯å¢ƒå˜é‡"""
    old_env = {}
    for key, value in kwargs.items():
        old_env[key] = os.environ.get(key)
        os.environ[key] = value

    try:
        yield
    finally:
        for key, value in old_env.items():
            if value is None:
                os.environ.pop(key, None)
            else:
                os.environ[key] = value

with set_env(DEBUG="1", LOG_LEVEL="DEBUG"):
    print(os.environ["DEBUG"])  # "1"
print(os.environ.get("DEBUG"))  # Noneï¼ˆå·²æ¢å¤ï¼‰
```

#### 6.3.3 æ•°æ®åº“äº‹åŠ¡ç®¡ç†
```python
class DatabaseConnection:
    def __enter__(self):
        self.conn = self.connect()
        self.conn.begin_transaction()
        return self.conn

    def __exit__(self, exc_type, exc_val, exc_tb):
        if exc_type is None:
            self.conn.commit()  # æˆåŠŸåˆ™æäº¤
        else:
            self.conn.rollback()  # å¼‚å¸¸åˆ™å›æ»š
        self.conn.close()
        return False

with DatabaseConnection() as conn:
    conn.execute("INSERT ...")
    conn.execute("UPDATE ...")
# è‡ªåŠ¨æäº¤æˆ–å›æ»š
```

---

## 7. ç”Ÿæˆå™¨ä¸è¿­ä»£å™¨

### 7.1 è¿­ä»£å™¨åè®®

```python
# æ‰‹åŠ¨å®ç°è¿­ä»£å™¨
class CountDown:
    def __init__(self, start):
        self.current = start

    def __iter__(self):
        return self  # è¿”å›è‡ªèº«

    def __next__(self):
        if self.current <= 0:
            raise StopIteration
        self.current -= 1
        return self.current + 1

for num in CountDown(5):
    print(num)  # 5, 4, 3, 2, 1
```

### 7.2 ç”Ÿæˆå™¨ï¼ˆç®€åŒ–ç‰ˆè¿­ä»£å™¨ï¼‰

```python
# ä½¿ç”¨ yield å…³é”®å­—
def countdown(start):
    while start > 0:
        yield start  # æš‚åœå¹¶è¿”å›å€¼
        start -= 1

for num in countdown(5):
    print(num)
```

### 7.3 ç”Ÿæˆå™¨çš„å†…å­˜ä¼˜åŠ¿

```python
# âŒ ä½æ•ˆï¼šä¸€æ¬¡æ€§åŠ è½½åˆ°å†…å­˜
def read_large_file_bad(file_path):
    with open(file_path, "r") as f:
        lines = f.readlines()  # ä¸€æ¬¡æ€§è¯»å–å…¨éƒ¨
    return lines

# âœ… é«˜æ•ˆï¼šæŒ‰éœ€ç”Ÿæˆï¼ˆæƒ°æ€§æ±‚å€¼ï¼‰
def read_large_file_good(file_path):
    with open(file_path, "r") as f:
        for line in f:  # é€è¡Œè¯»å–
            yield line.strip()

# å¤„ç† 10GB æ–‡ä»¶ä¹Ÿä¸ä¼šå ç”¨å¤§é‡å†…å­˜
for line in read_large_file_good("huge.log"):
    if "ERROR" in line:
        print(line)
```

### 7.4 ç”Ÿæˆå™¨è¡¨è¾¾å¼

```python
# åˆ—è¡¨æ¨å¯¼å¼ï¼ˆä¸€æ¬¡æ€§åˆ›å»ºï¼‰
squares_list = [x**2 for x in range(1000000)]  # å ç”¨å¤§é‡å†…å­˜

# ç”Ÿæˆå™¨è¡¨è¾¾å¼ï¼ˆæŒ‰éœ€ç”Ÿæˆï¼‰
squares_gen = (x**2 for x in range(1000000))   # å‡ ä¹ä¸å å†…å­˜

# å†…å­˜å¯¹æ¯”
import sys
print(sys.getsizeof(squares_list))  # 8448728 å­—èŠ‚
print(sys.getsizeof(squares_gen))   # 120 å­—èŠ‚
```

### 7.5 DevOps åº”ç”¨ï¼šæ—¥å¿—æ–‡ä»¶å¤„ç†

```python
def parse_nginx_log(file_path):
    """è§£æ nginx æ—¥å¿—ï¼ˆç”Ÿæˆå™¨ï¼‰"""
    with open(file_path, "r") as f:
        for line in f:
            parts = line.split()
            if len(parts) >= 9:
                yield {
                    "ip": parts[0],
                    "method": parts[5].strip('"'),
                    "path": parts[6],
                    "status": parts[8],
                }

def filter_errors(logs):
    """ç­›é€‰é”™è¯¯æ—¥å¿—ï¼ˆç”Ÿæˆå™¨é“¾ï¼‰"""
    for log in logs:
        if log["status"].startswith("5"):
            yield log

def group_by_ip(logs):
    """æŒ‰ IP åˆ†ç»„ç»Ÿè®¡ï¼ˆç”Ÿæˆå™¨æ¶ˆè´¹ï¼‰"""
    from collections import Counter
    ips = (log["ip"] for log in logs)
    return Counter(ips).most_common(10)

# æµå¼å¤„ç†ï¼šæ–‡ä»¶ â†’ è§£æ â†’ ç­›é€‰ â†’ ç»Ÿè®¡
logs = parse_nginx_log("/var/log/nginx/access.log")
errors = filter_errors(logs)
top_ips = group_by_ip(errors)
print(top_ips)
```

---

## 8. åç¨‹ä¸å¼‚æ­¥ç¼–ç¨‹

### 8.1 åŒæ­¥ vs å¼‚æ­¥

```python
import time

# åŒæ­¥ï¼ˆé˜»å¡ï¼‰
def download_sync(url):
    print(f"å¼€å§‹ä¸‹è½½ {url}")
    time.sleep(2)  # æ¨¡æ‹Ÿç½‘ç»œè¯·æ±‚
    print(f"å®Œæˆä¸‹è½½ {url}")
    return f"Data from {url}"

start = time.time()
download_sync("url1")
download_sync("url2")
download_sync("url3")
print(f"æ€»è€—æ—¶: {time.time() - start:.1f}s")  # ~6s

# å¼‚æ­¥ï¼ˆéé˜»å¡ï¼‰
import asyncio

async def download_async(url):
    print(f"å¼€å§‹ä¸‹è½½ {url}")
    await asyncio.sleep(2)  # æ¨¡æ‹Ÿå¼‚æ­¥ç½‘ç»œè¯·æ±‚
    print(f"å®Œæˆä¸‹è½½ {url}")
    return f"Data from {url}"

async def main():
    start = time.time()
    tasks = [
        download_async("url1"),
        download_async("url2"),
        download_async("url3"),
    ]
    await asyncio.gather(*tasks)  # å¹¶å‘æ‰§è¡Œ
    print(f"æ€»è€—æ—¶: {time.time() - start:.1f}s")  # ~2s

asyncio.run(main())
```

### 8.2 async/await å…³é”®å­—

```python
import asyncio
import aiohttp  # å¼‚æ­¥ HTTP åº“

async def fetch_url(session, url):
    """å¼‚æ­¥è·å– URL å†…å®¹"""
    async with session.get(url) as response:
        return await response.text()

async def fetch_multiple_urls(urls):
    """å¹¶å‘è·å–å¤šä¸ª URL"""
    async with aiohttp.ClientSession() as session:
        tasks = [fetch_url(session, url) for url in urls]
        results = await asyncio.gather(*tasks)
        return results

# è¿è¡Œ
urls = ["https://example.com", "https://github.com", "https://python.org"]
results = asyncio.run(fetch_multiple_urls(urls))
```

### 8.3 å¼‚æ­¥æ–‡ä»¶ I/O

```python
import aiofiles

async def read_file_async(file_path):
    """å¼‚æ­¥è¯»å–æ–‡ä»¶"""
    async with aiofiles.open(file_path, "r") as f:
        content = await f.read()
    return content

async def write_file_async(file_path, content):
    """å¼‚æ­¥å†™å…¥æ–‡ä»¶"""
    async with aiofiles.open(file_path, "w") as f:
        await f.write(content)

async def process_files():
    """å¹¶å‘å¤„ç†å¤šä¸ªæ–‡ä»¶"""
    tasks = [
        read_file_async("file1.txt"),
        read_file_async("file2.txt"),
        read_file_async("file3.txt"),
    ]
    contents = await asyncio.gather(*tasks)
    return contents

asyncio.run(process_files())
```

### 8.4 å¼‚æ­¥ä»»åŠ¡è°ƒåº¦

```python
import asyncio

async def task1():
    await asyncio.sleep(1)
    return "Task 1 done"

async def task2():
    await asyncio.sleep(2)
    return "Task 2 done"

async def main():
    # æ–¹æ³• 1: gatherï¼ˆå…¨éƒ¨å®Œæˆåè¿”å›ï¼‰
    results = await asyncio.gather(task1(), task2())
    print(results)  # ['Task 1 done', 'Task 2 done']

    # æ–¹æ³• 2: as_completedï¼ˆæŒ‰å®Œæˆé¡ºåºå¤„ç†ï¼‰
    for coro in asyncio.as_completed([task1(), task2()]):
        result = await coro
        print(result)  # Task 1 done (1s å), Task 2 done (2s å)

    # æ–¹æ³• 3: è¶…æ—¶æ§åˆ¶
    try:
        result = await asyncio.wait_for(task2(), timeout=1.0)
    except asyncio.TimeoutError:
        print("è¶…æ—¶ï¼")

asyncio.run(main())
```

### 8.5 DevOps åº”ç”¨ï¼šæ‰¹é‡ SSH æ“ä½œ

```python
import asyncio
import asyncssh

async def run_command_on_host(host, command):
    """å¼‚æ­¥æ‰§è¡Œ SSH å‘½ä»¤"""
    async with asyncssh.connect(host) as conn:
        result = await conn.run(command)
        return {
            "host": host,
            "stdout": result.stdout,
            "exit_status": result.exit_status,
        }

async def batch_ssh_commands(hosts, command):
    """æ‰¹é‡æ‰§è¡Œ SSH å‘½ä»¤"""
    tasks = [run_command_on_host(host, command) for host in hosts]
    results = await asyncio.gather(*tasks)
    return results

# å¹¶å‘æ“ä½œ 100 å°æœåŠ¡å™¨
hosts = [f"server{i}.example.com" for i in range(100)]
results = asyncio.run(batch_ssh_commands(hosts, "df -h"))
```

---

## ç¬¬ä¸‰éƒ¨åˆ†ï¼šå·¥ç¨‹åŒ–å®è·µ

---

## 9. å¼‚å¸¸å¤„ç†æœ€ä½³å®è·µ

### 9.1 å¼‚å¸¸å±‚æ¬¡ç»“æ„

```python
BaseException
 â”œâ”€â”€ SystemExit
 â”œâ”€â”€ KeyboardInterrupt
 â””â”€â”€ Exception
      â”œâ”€â”€ ValueError
      â”œâ”€â”€ TypeError
      â”œâ”€â”€ FileNotFoundError
      â”œâ”€â”€ ConnectionError
      â””â”€â”€ ...
```

### 9.2 ç²¾ç¡®æ•è·å¼‚å¸¸

```python
# âŒ é”™è¯¯ï¼šæ•è·æ‰€æœ‰å¼‚å¸¸
try:
    result = 10 / 0
except:  # å±é™©ï¼è¿ KeyboardInterrupt éƒ½æ•è·
    pass

# âŒ é”™è¯¯ï¼šæ•è·è¿‡äºå®½æ³›
try:
    result = 10 / 0
except Exception:  # æ•è·æ‰€æœ‰ä¸šåŠ¡å¼‚å¸¸
    pass

# âœ… æ­£ç¡®ï¼šæ•è·å…·ä½“å¼‚å¸¸
try:
    result = 10 / 0
except ZeroDivisionError:
    print("é™¤æ•°ä¸èƒ½ä¸º 0")

# âœ… æ­£ç¡®ï¼šæ•è·å¤šä¸ªå…·ä½“å¼‚å¸¸
try:
    with open("data.json", "r") as f:
        data = json.load(f)
except FileNotFoundError:
    print("æ–‡ä»¶ä¸å­˜åœ¨")
except json.JSONDecodeError:
    print("JSON æ ¼å¼é”™è¯¯")
```

### 9.3 å¼‚å¸¸é“¾ä¸ä¸Šä¸‹æ–‡

```python
# âŒ é”™è¯¯ï¼šä¸¢å¤±åŸå§‹å¼‚å¸¸ä¿¡æ¯
try:
    data = json.load(open("config.json"))
except Exception:
    raise ValueError("é…ç½®æ–‡ä»¶åŠ è½½å¤±è´¥")  # åŸå§‹å¼‚å¸¸ä¿¡æ¯ä¸¢å¤±

# âœ… æ­£ç¡®ï¼šä¿ç•™å¼‚å¸¸é“¾
try:
    data = json.load(open("config.json"))
except Exception as e:
    raise ValueError("é…ç½®æ–‡ä»¶åŠ è½½å¤±è´¥") from e  # ä½¿ç”¨ from ä¿ç•™åŸå› 
```

### 9.4 è‡ªå®šä¹‰å¼‚å¸¸

```python
# åŸºç¡€å¼‚å¸¸ç±»
class APIError(Exception):
    """API åŸºç¡€å¼‚å¸¸"""
    pass

# å…·ä½“å¼‚å¸¸
class AuthenticationError(APIError):
    """è®¤è¯å¤±è´¥"""
    def __init__(self, message, status_code=401):
        self.message = message
        self.status_code = status_code
        super().__init__(self.message)

class RateLimitError(APIError):
    """é€Ÿç‡é™åˆ¶"""
    def __init__(self, retry_after):
        self.retry_after = retry_after
        super().__init__(f"è¯· {retry_after} ç§’åé‡è¯•")

# ä½¿ç”¨
def call_api(token):
    if not token:
        raise AuthenticationError("Token ç¼ºå¤±")
    # ...

try:
    call_api(None)
except AuthenticationError as e:
    print(f"é”™è¯¯ç : {e.status_code}, æ¶ˆæ¯: {e.message}")
```

### 9.5 ä¸Šä¸‹æ–‡ç®¡ç†å™¨ + å¼‚å¸¸å¤„ç†

```python
from contextlib import contextmanager

@contextmanager
def safe_transaction(conn):
    """å®‰å…¨äº‹åŠ¡ä¸Šä¸‹æ–‡"""
    try:
        conn.begin()
        yield conn
        conn.commit()
    except Exception as e:
        conn.rollback()
        print(f"äº‹åŠ¡å›æ»š: {e}")
        raise
    finally:
        conn.close()

# ä½¿ç”¨
with safe_transaction(db_connection) as conn:
    conn.execute("INSERT ...")
    conn.execute("UPDATE ...")
```

### 9.6 ç”Ÿäº§ç¯å¢ƒå¼‚å¸¸å¤„ç†æ¨¡å¼

```python
import logging
import traceback

logger = logging.getLogger(__name__)

def robust_api_call(url, max_retries=3):
    """å¥å£®çš„ API è°ƒç”¨"""
    for attempt in range(1, max_retries + 1):
        try:
            response = requests.get(url, timeout=5)
            response.raise_for_status()
            return response.json()

        except requests.Timeout:
            logger.warning(f"è¯·æ±‚è¶…æ—¶ï¼ˆç¬¬ {attempt} æ¬¡ï¼‰")
            if attempt == max_retries:
                raise

        except requests.ConnectionError as e:
            logger.error(f"è¿æ¥å¤±è´¥: {e}")
            if attempt == max_retries:
                raise

        except requests.HTTPError as e:
            if e.response.status_code >= 500:
                # æœåŠ¡å™¨é”™è¯¯ â†’ é‡è¯•
                logger.warning(f"æœåŠ¡å™¨é”™è¯¯ {e.response.status_code}ï¼Œé‡è¯•ä¸­...")
                if attempt == max_retries:
                    raise
            else:
                # å®¢æˆ·ç«¯é”™è¯¯ â†’ ä¸é‡è¯•
                logger.error(f"å®¢æˆ·ç«¯é”™è¯¯: {e}")
                raise

        except Exception as e:
            # æœªçŸ¥å¼‚å¸¸ â†’ è®°å½•è¯¦ç»†å †æ ˆ
            logger.error(f"æœªçŸ¥å¼‚å¸¸:\n{traceback.format_exc()}")
            raise

# å…¨å±€å¼‚å¸¸æ•è·ï¼ˆå®ˆæŠ¤è¿›ç¨‹ï¼‰
def main():
    try:
        # ä¸»é€»è¾‘
        run_application()
    except KeyboardInterrupt:
        logger.info("æ”¶åˆ°ä¸­æ–­ä¿¡å·ï¼Œæ­£åœ¨é€€å‡º...")
    except Exception:
        logger.critical(f"è‡´å‘½é”™è¯¯:\n{traceback.format_exc()}")
        sys.exit(1)
```

---

## 10. æ—¥å¿—ç³»ç»Ÿè®¾è®¡

### 10.1 æ—¥å¿—çº§åˆ«

```python
import logging

# æ—¥å¿—çº§åˆ«ï¼ˆç”±ä½åˆ°é«˜ï¼‰
# DEBUG < INFO < WARNING < ERROR < CRITICAL

logger = logging.getLogger(__name__)
logger.setLevel(logging.DEBUG)

logger.debug("è°ƒè¯•ä¿¡æ¯")      # å¼€å‘ç¯å¢ƒ
logger.info("æ­£å¸¸ä¿¡æ¯")       # ç”Ÿäº§ç¯å¢ƒ
logger.warning("è­¦å‘Šä¿¡æ¯")    # éœ€è¦æ³¨æ„
logger.error("é”™è¯¯ä¿¡æ¯")      # éœ€è¦å¤„ç†
logger.critical("ä¸¥é‡é”™è¯¯")   # ç³»ç»Ÿå´©æºƒ
```

### 10.2 ç»“æ„åŒ–æ—¥å¿—é…ç½®

```python
import logging.config

LOGGING_CONFIG = {
    "version": 1,
    "disable_existing_loggers": False,
    "formatters": {
        "standard": {
            "format": "%(asctime)s [%(levelname)s] %(name)s: %(message)s"
        },
        "detailed": {
            "format": "%(asctime)s [%(levelname)s] %(name)s.%(funcName)s:%(lineno)d - %(message)s"
        },
    },
    "handlers": {
        "console": {
            "class": "logging.StreamHandler",
            "level": "INFO",
            "formatter": "standard",
            "stream": "ext://sys.stdout",
        },
        "file": {
            "class": "logging.handlers.RotatingFileHandler",
            "level": "DEBUG",
            "formatter": "detailed",
            "filename": "app.log",
            "maxBytes": 10485760,  # 10MB
            "backupCount": 5,
        },
    },
    "loggers": {
        "": {  # root logger
            "handlers": ["console", "file"],
            "level": "DEBUG",
        },
    },
}

logging.config.dictConfig(LOGGING_CONFIG)
logger = logging.getLogger(__name__)
```

### 10.3 JSON æ ¼å¼æ—¥å¿—ï¼ˆç”Ÿäº§æ¨èï¼‰

```python
import logging
import json
from datetime import datetime

class JSONFormatter(logging.Formatter):
    """JSON æ ¼å¼æ—¥å¿—ï¼ˆä¾¿äº ELK é‡‡é›†ï¼‰"""
    def format(self, record):
        log_data = {
            "timestamp": datetime.utcnow().isoformat(),
            "level": record.levelname,
            "logger": record.name,
            "message": record.getMessage(),
            "module": record.module,
            "function": record.funcName,
            "line": record.lineno,
        }

        # æ·»åŠ å¼‚å¸¸å †æ ˆ
        if record.exc_info:
            log_data["exception"] = self.formatException(record.exc_info)

        # æ·»åŠ è‡ªå®šä¹‰å­—æ®µ
        if hasattr(record, "request_id"):
            log_data["request_id"] = record.request_id

        return json.dumps(log_data, ensure_ascii=False)

# é…ç½®
handler = logging.StreamHandler()
handler.setFormatter(JSONFormatter())
logger = logging.getLogger(__name__)
logger.addHandler(handler)
logger.setLevel(logging.INFO)

# ä½¿ç”¨ï¼ˆå¸¦ä¸Šä¸‹æ–‡ï¼‰
logger.info("ç”¨æˆ·ç™»å½•", extra={"request_id": "abc123"})
```

### 10.4 åˆ†å¸ƒå¼è¿½è¸ªï¼ˆRequest IDï¼‰

```python
import uuid
import contextvars

# çº¿ç¨‹å®‰å…¨çš„ä¸Šä¸‹æ–‡å˜é‡
request_id_var = contextvars.ContextVar("request_id", default=None)

class RequestIDFilter(logging.Filter):
    """è‡ªåŠ¨æ·»åŠ  Request ID"""
    def filter(self, record):
        record.request_id = request_id_var.get() or "N/A"
        return True

# é…ç½®
logger = logging.getLogger(__name__)
logger.addFilter(RequestIDFilter())

# ä½¿ç”¨
def handle_request():
    request_id = str(uuid.uuid4())
    request_id_var.set(request_id)

    logger.info("å¼€å§‹å¤„ç†è¯·æ±‚")  # è‡ªåŠ¨åŒ…å« request_id
    # ... ä¸šåŠ¡é€»è¾‘ ...
    logger.info("è¯·æ±‚å¤„ç†å®Œæˆ")
```

### 10.5 DevOps æ—¥å¿—å®è·µ

```python
import logging
from logging.handlers import RotatingFileHandler, SysLogHandler

def setup_production_logging(app_name):
    """ç”Ÿäº§ç¯å¢ƒæ—¥å¿—é…ç½®"""
    logger = logging.getLogger(app_name)
    logger.setLevel(logging.INFO)

    # 1. æ§åˆ¶å°è¾“å‡ºï¼ˆDocker/K8s æ”¶é›†ï¼‰
    console_handler = logging.StreamHandler()
    console_handler.setFormatter(JSONFormatter())
    logger.addHandler(console_handler)

    # 2. æ–‡ä»¶æ»šåŠ¨ï¼ˆæœ¬åœ°å¤‡ä»½ï¼‰
    file_handler = RotatingFileHandler(
        f"/var/log/{app_name}/app.log",
        maxBytes=50*1024*1024,  # 50MB
        backupCount=10,
    )
    file_handler.setFormatter(JSONFormatter())
    logger.addHandler(file_handler)

    # 3. é”™è¯¯å•ç‹¬æ–‡ä»¶
    error_handler = RotatingFileHandler(
        f"/var/log/{app_name}/error.log",
        maxBytes=50*1024*1024,
        backupCount=10,
    )
    error_handler.setLevel(logging.ERROR)
    error_handler.setFormatter(JSONFormatter())
    logger.addHandler(error_handler)

    # 4. Syslogï¼ˆå‘é€åˆ°æ—¥å¿—æœåŠ¡å™¨ï¼‰
    syslog_handler = SysLogHandler(address=("logserver", 514))
    syslog_handler.setFormatter(JSONFormatter())
    logger.addHandler(syslog_handler)

    return logger
```

---

*ï¼ˆç”±äºå†…å®¹å¤ªé•¿ï¼Œè¿™é‡Œå…ˆæä¾›å‰åŠéƒ¨åˆ†ã€‚æ˜¯å¦ç»§ç»­ç”Ÿæˆåç»­ç« èŠ‚ï¼Ÿï¼‰*

**å·²å®Œæˆç« èŠ‚**ï¼š
- âœ… ç¬¬ä¸€éƒ¨åˆ†ï¼šåº•å±‚åŸç†ä¸æ‰§è¡Œæœºåˆ¶ï¼ˆ1-4 ç« ï¼‰
- âœ… ç¬¬äºŒéƒ¨åˆ†ï¼šé«˜çº§è¯­è¨€ç‰¹æ€§ï¼ˆ5-8 ç« ï¼‰
- âœ… ç¬¬ä¸‰éƒ¨åˆ†ï¼šå·¥ç¨‹åŒ–å®è·µï¼ˆ9-10 ç« ï¼‰

**å¾…ç”Ÿæˆç« èŠ‚**ï¼š
- â³ ç¬¬ä¸‰éƒ¨åˆ†ç»­ï¼šé…ç½®ç®¡ç†ã€å•å…ƒæµ‹è¯•ï¼ˆ11-12 ç« ï¼‰
- â³ ç¬¬å››éƒ¨åˆ†ï¼šDevOps è„šæœ¬ç¼–ç¨‹ï¼ˆ13-16 ç« ï¼‰
- â³ ç¬¬äº”éƒ¨åˆ†ï¼šæ€§èƒ½ä¼˜åŒ–ä¸è°ƒè¯•ï¼ˆ17-19 ç« ï¼‰

**è¯·å‘Šè¯‰æˆ‘æ˜¯å¦ç»§ç»­ç”Ÿæˆå‰©ä½™å†…å®¹ï¼Ÿ** ğŸš€
