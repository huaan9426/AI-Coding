# Kubernetes ç”Ÿäº§å®æˆ˜æŒ‡å— - ä¸Šå·: æ ¸å¿ƒåŸç†ä¸åŸºç¡€å®æˆ˜

**å‰¯æ ‡é¢˜**: ä»é›¶æ„å»º Kubernetes çŸ¥è¯†ä½“ç³»
**ç›®æ ‡è¯»è€…**: Kubernetes åˆå­¦è€…ã€åº”ç”¨å¼€å‘è€…ã€è¿ç»´å·¥ç¨‹å¸ˆ
**å­¦ä¹ ç›®æ ‡**: æŒæ¡ K8s æ ¸å¿ƒæ¦‚å¿µ,èƒ½å¤Ÿç‹¬ç«‹éƒ¨ç½²å’Œç®¡ç†åº”ç”¨

---

## ğŸ“š å…¨ä¹¦å¯¼èˆª

- **ä¸Šå· (æœ¬å·)**: æ ¸å¿ƒåŸç†ä¸åŸºç¡€å®æˆ˜ (ç¬¬1-12ç« )
- **ä¸­å·**: é«˜çº§ç‰¹æ€§ä¸ç”Ÿæ€é›†æˆ (ç¬¬13-24ç« )
- **ä¸‹å·**: ç”Ÿäº§è¿ç»´ä¸äº‘åŸç”Ÿæ¶æ„ (ç¬¬25-36ç« )

---

# ç¬¬1ç« : Kubernetes æ¶æ„ä¸æ ¸å¿ƒæ¦‚å¿µ

æœ¬ç« å°†å¸¦æ‚¨æ·±å…¥ç†è§£ Kubernetes çš„è®¾è®¡ç†å¿µã€æ¶æ„æ¨¡å‹å’Œæ ¸å¿ƒæ¦‚å¿µ,ä¸ºåç»­å­¦ä¹ æ‰“ä¸‹åšå®åŸºç¡€ã€‚

---

## 1.1 Kubernetes æ˜¯ä»€ä¹ˆ

### 1.1.1 å®¹å™¨ç¼–æ’çš„æ¼”è¿›å†å²

**å®¹å™¨æŠ€æœ¯çš„å…´èµ·**

2013å¹´,Docker çš„å‡ºç°å½»åº•æ”¹å˜äº†åº”ç”¨éƒ¨ç½²æ–¹å¼:

```
ä¼ ç»Ÿè™šæ‹Ÿæœºæ—¶ä»£:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Application             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚  App1  â”‚  â”‚  App2  â”‚        â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¤        â”‚
â”‚  â”‚ Bins   â”‚  â”‚ Bins   â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚      Guest OS    Guest OS       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚         Hypervisor              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚         Host OS                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚       Infrastructure            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
å¯åŠ¨æ—¶é—´: åˆ†é’Ÿçº§
èµ„æºå¼€é”€: å¤§ (æ¯ä¸ªOSå‡ GB)

Dockerå®¹å™¨æ—¶ä»£:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚  App1  â”‚  â”‚  App2  â”‚        â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¤        â”‚
â”‚  â”‚ Bins   â”‚  â”‚ Bins   â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚      Docker Engine              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚         Host OS                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚       Infrastructure            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
å¯åŠ¨æ—¶é—´: ç§’çº§
èµ„æºå¼€é”€: å° (å…±äº«OSå†…æ ¸)
```

**å®¹å™¨ç¼–æ’çš„å¿…è¦æ€§**

å½“å®¹å™¨æ•°é‡ä»å‡ ä¸ªå¢é•¿åˆ°æˆç™¾ä¸Šåƒæ—¶,é¢ä¸´çš„æŒ‘æˆ˜:

1. **æœåŠ¡å‘ç°**: å®¹å™¨IPåŠ¨æ€å˜åŒ–,å¦‚ä½•æ‰¾åˆ°æœåŠ¡?
2. **è´Ÿè½½å‡è¡¡**: å¦‚ä½•åœ¨å¤šä¸ªå®¹å™¨å®ä¾‹é—´åˆ†é…æµé‡?
3. **æ•…éšœæ¢å¤**: å®¹å™¨æŒ‚äº†å¦‚ä½•è‡ªåŠ¨é‡å¯?
4. **æ»šåŠ¨æ›´æ–°**: å¦‚ä½•å®ç°é›¶åœæœºæ›´æ–°?
5. **èµ„æºè°ƒåº¦**: å¦‚ä½•åœ¨é›†ç¾¤ä¸­é«˜æ•ˆåˆ†é…èµ„æº?
6. **é…ç½®ç®¡ç†**: å¦‚ä½•ç»Ÿä¸€ç®¡ç†æˆç™¾ä¸Šåƒå®¹å™¨çš„é…ç½®?

**ä¸‰å¤§ç¼–æ’ç³»ç»Ÿå¯¹æ¯”**

| ç‰¹æ€§ | Docker Swarm | Apache Mesos | Kubernetes |
|------|--------------|--------------|------------|
| **è¯ç”Ÿæ—¶é—´** | 2015å¹´ | 2009å¹´ | 2014å¹´ |
| **å‘èµ·æ–¹** | Dockerå…¬å¸ | UC Berkeley | Google |
| **å­¦ä¹ æ›²çº¿** | â­â­ ç®€å• | â­â­â­â­â­ å¤æ‚ | â­â­â­â­ ä¸­ç­‰ |
| **åŠŸèƒ½ä¸°å¯Œåº¦** | â­â­â­ åŸºç¡€åŠŸèƒ½ | â­â­â­â­ çµæ´»ä½†éœ€å®šåˆ¶ | â­â­â­â­â­ åŠŸèƒ½å…¨é¢ |
| **ç”Ÿæ€ç³»ç»Ÿ** | è¾ƒå° | ä¸­ç­‰ | æœ€ä¸°å¯Œ |
| **ç¤¾åŒºæ´»è·ƒåº¦** | ä¸‹é™ä¸­ | ä¸­ç­‰ | æœ€æ´»è·ƒ |
| **é€‚ç”¨è§„æ¨¡** | å°å‹é›†ç¾¤ | å¤§è§„æ¨¡æ•°æ®ä¸­å¿ƒ | ä¸­å¤§å‹é›†ç¾¤ |
| **å¸‚åœºä»½é¢** | <5% | <10% | >85% |

**Kubernetes çš„èƒœå‡º**

åˆ° 2020 å¹´,Kubernetes å·²æˆä¸ºå®¹å™¨ç¼–æ’çš„äº‹å®æ ‡å‡†:

- **Google 15å¹´å®¹å™¨ç»éªŒ**: èµ·æºäº Borg/Omega ç³»ç»Ÿ
- **CNCF èƒŒä¹¦**: 2015å¹´æˆä¸ºCNCFé¦–ä¸ªé¡¹ç›®
- **äº‘å‚å•†æ”¯æŒ**: AWS EKS/Azure AKS/Google GKE å…¨é¢æ”¯æŒ
- **ç”Ÿæ€ç¹è£**: æ•°åƒä¸ªäº‘åŸç”Ÿé¡¹ç›®å›´ç»•K8sæ„å»º

```bash
# 2024å¹´ CNCF è°ƒæŸ¥æŠ¥å‘Š
- ç”Ÿäº§ç¯å¢ƒä½¿ç”¨K8s: 96%
- é›†ç¾¤æ•°é‡ >10ä¸ª: 47%
- å®¹å™¨æ•°é‡ >1000: 53%
```

### 1.1.2 Kubernetes æ ¸å¿ƒä»·å€¼

**1. è‡ªåŠ¨åŒ–è¿ç»´**

```yaml
# å£°æ˜å¼é…ç½®: å‘Šè¯‰K8s"æƒ³è¦ä»€ä¹ˆ",è€Œé"æ€ä¹ˆåš"
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx
spec:
  replicas: 3  # æœŸæœ›çŠ¶æ€: 3ä¸ªå‰¯æœ¬
  template:
    spec:
      containers:
      - name: nginx
        image: nginx:1.25
        resources:
          requests:
            memory: "128Mi"
            cpu: "100m"
          limits:
            memory: "256Mi"
            cpu: "200m"
```

K8s ä¼šæŒç»­å·¥ä½œç¡®ä¿å®é™…çŠ¶æ€ = æœŸæœ›çŠ¶æ€:
- å®¹å™¨å´©æºƒ? â†’ è‡ªåŠ¨é‡å¯
- èŠ‚ç‚¹å®•æœº? â†’ è‡ªåŠ¨è¿ç§»Podåˆ°å¥åº·èŠ‚ç‚¹
- è´Ÿè½½å¢åŠ ? â†’ è‡ªåŠ¨æ‰©å®¹(HPA)
- èµ„æºä¸è¶³? â†’ è‡ªåŠ¨æ‰©å±•èŠ‚ç‚¹(Cluster Autoscaler)

**2. å¼¹æ€§ä¼¸ç¼©**

```yaml
# æ°´å¹³è‡ªåŠ¨æ‰©ç¼©å®¹ (HPA)
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: nginx-hpa
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: nginx
  minReplicas: 2
  maxReplicas: 10
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70  # CPU >70% æ—¶æ‰©å®¹
```

å®é™…æ•ˆæœ:
```
æ—¶é—´    è´Ÿè½½    å‰¯æœ¬æ•°    è¯´æ˜
08:00   20%     2        ä½å³°æœŸ,ä¿æŒæœ€å°å‰¯æœ¬
12:00   75%     5        åˆé«˜å³°,è‡ªåŠ¨æ‰©å®¹åˆ°5ä¸ª
14:00   90%     8        æŒç»­é«˜è´Ÿè½½,ç»§ç»­æ‰©å®¹
18:00   40%     3        è´Ÿè½½ä¸‹é™,è‡ªåŠ¨ç¼©å®¹
```

**3. æœåŠ¡å‘ç°ä¸è´Ÿè½½å‡è¡¡**

```yaml
# Service: ä¸ºåŠ¨æ€Podæä¾›ç¨³å®šè®¿é—®å…¥å£
apiVersion: v1
kind: Service
metadata:
  name: nginx-service
spec:
  selector:
    app: nginx
  ports:
  - protocol: TCP
    port: 80
    targetPort: 80
  type: LoadBalancer  # äº‘å‚å•†è‡ªåŠ¨åˆ›å»ºLB
```

å·¥ä½œåŸç†:
```
ç”¨æˆ·è¯·æ±‚
   â†“
LoadBalancer (äº‘LB)
   â†“
Service (è™šæ‹ŸIP: 10.96.0.10)
   â†“
kube-proxy (iptables/ipvsè§„åˆ™)
   â†“
è´Ÿè½½å‡è¡¡åˆ°åç«¯Pod
   â”œâ†’ Pod1 (IP: 10.244.1.5)
   â”œâ†’ Pod2 (IP: 10.244.2.8)
   â””â†’ Pod3 (IP: 10.244.3.12)
```

Pod IPä¼šå˜åŒ–,ä½†Service IPæ°¸è¿œä¸å˜!

**4. å­˜å‚¨ç¼–æ’**

```yaml
# æŒä¹…åŒ–å·å£°æ˜: åº”ç”¨æ— éœ€å…³å¿ƒåº•å±‚å­˜å‚¨å®ç°
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: mysql-pvc
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 10Gi
  storageClassName: fast-ssd  # è‡ªåŠ¨ä¾›ç»™SSDå­˜å‚¨
---
apiVersion: v1
kind: Pod
metadata:
  name: mysql
spec:
  containers:
  - name: mysql
    image: mysql:8.0
    volumeMounts:
    - name: mysql-data
      mountPath: /var/lib/mysql
  volumes:
  - name: mysql-data
    persistentVolumeClaim:
      claimName: mysql-pvc
```

åº•å±‚å¯ä»¥æ˜¯:
- NFS ç½‘ç»œå­˜å‚¨
- Ceph åˆ†å¸ƒå¼å­˜å‚¨
- AWS EBS / Azure Disk / GCP PD
- æœ¬åœ°SSD

åº”ç”¨å±‚å®Œå…¨é€æ˜!

**5. é…ç½®ä¸å¯†é’¥ç®¡ç†**

```yaml
# ConfigMap: é…ç½®ä¸ä»£ç åˆ†ç¦»
apiVersion: v1
kind: ConfigMap
metadata:
  name: app-config
data:
  database.host: "mysql.prod.svc.cluster.local"
  database.port: "3306"
  log.level: "info"
---
# Secret: æ•æ„Ÿä¿¡æ¯åŠ å¯†å­˜å‚¨
apiVersion: v1
kind: Secret
metadata:
  name: mysql-secret
type: Opaque
data:
  password: bXlwYXNzd29yZA==  # base64ç¼–ç 
---
# Podä½¿ç”¨é…ç½®
apiVersion: v1
kind: Pod
metadata:
  name: app
spec:
  containers:
  - name: app
    image: myapp:1.0
    env:
    - name: DB_HOST
      valueFrom:
        configMapKeyRef:
          name: app-config
          key: database.host
    - name: DB_PASSWORD
      valueFrom:
        secretKeyRef:
          name: mysql-secret
          key: password
```

### 1.1.3 K8s vs Docker Swarm è¯¦ç»†å¯¹æ¯”

**æ¶æ„å¯¹æ¯”**

```
Docker Swarm æ¶æ„:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Manager Nodes               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   Swarm Manager (Raft)       â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚  â”‚
â”‚  â”‚  â”‚ Leader â”‚  â”‚Followerâ”‚     â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Worker Nodes                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚Docker  â”‚  â”‚Docker  â”‚  â”‚Docker â”‚ â”‚
â”‚  â”‚Engine  â”‚  â”‚Engine  â”‚  â”‚Engine â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Kubernetes æ¶æ„:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Master Nodes                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚API Server  â”‚  â”‚ Scheduler  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚Controller  â”‚  â”‚   etcd     â”‚   â”‚
â”‚  â”‚  Manager   â”‚  â”‚  (Raft)    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Worker Nodes                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ kubelet + kube-proxy          â”‚ â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”         â”‚ â”‚
â”‚  â”‚ â”‚Pod â”‚ â”‚Pod â”‚ â”‚Pod â”‚         â”‚ â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”˜         â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**åŠŸèƒ½å¯¹æ¯”**

| åŠŸèƒ½ | Docker Swarm | Kubernetes |
|------|--------------|------------|
| **éƒ¨ç½²å•ä½** | Container | Pod (å¤šå®¹å™¨ç»„) |
| **é…ç½®æ–¹å¼** | docker-compose.yml | YAML (å¤šç§èµ„æº) |
| **æœåŠ¡å‘ç°** | DNS + VIP | DNS + Service + CoreDNS |
| **è´Ÿè½½å‡è¡¡** | Routing Mesh (ç®€å•) | Service + Ingress (çµæ´») |
| **æ»šåŠ¨æ›´æ–°** | æ”¯æŒ | æ”¯æŒ + æ›´ç²¾ç»†æ§åˆ¶ |
| **å¥åº·æ£€æŸ¥** | HEALTHCHECKæŒ‡ä»¤ | Liveness/Readiness/Startup Probe |
| **è‡ªåŠ¨æ‰©ç¼©å®¹** | æ‰‹åŠ¨è°ƒæ•´replicas | HPA/VPA/Cluster Autoscaler |
| **å­˜å‚¨ç¼–æ’** | Volume (æœ‰é™) | PV/PVC/StorageClass (ä¸°å¯Œ) |
| **é…ç½®ç®¡ç†** | Config/Secret (åŸºç¡€) | ConfigMap/Secret (å®Œå–„) |
| **ç½‘ç»œæ’ä»¶** | Overlay Network | CNI (Calico/Cilium/Flannelç­‰) |
| **RBACæƒé™** | åŸºç¡€ | ç»†ç²’åº¦RBAC |
| **ç›‘æ§é›†æˆ** | éœ€è‡ªå»º | Prometheus/Grafana (æˆç†Ÿç”Ÿæ€) |
| **æ—¥å¿—æ”¶é›†** | éœ€è‡ªå»º | EFK/PLG Stack (æˆç†Ÿæ–¹æ¡ˆ) |
| **åŒ…ç®¡ç†** | æ—  | Helm/Kustomize |
| **Operator** | æ—  | ä¸°å¯Œçš„Operatorç”Ÿæ€ |

**å­¦ä¹ æ›²çº¿å¯¹æ¯”**

```
å¤æ‚åº¦
  â†‘
  â”‚                           â•±
  â”‚                       â•±
  â”‚                   â•±  K8s
  â”‚               â•±
  â”‚           â•±
  â”‚   Swarmâ•±
  â”‚   â•±
  â”‚â•±
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ æ—¶é—´
  å…¥é—¨    è¿›é˜¶    é«˜çº§    ä¸“å®¶

Swarm: 2å‘¨å…¥é—¨ â†’ 1ä¸ªæœˆç†Ÿç»ƒ
K8s:   1ä¸ªæœˆå…¥é—¨ â†’ 3ä¸ªæœˆç†Ÿç»ƒ â†’ æŒç»­å­¦ä¹ 
```

**é€‚ç”¨åœºæ™¯**

**Docker Swarm é€‚åˆ:**
- âœ… å°å‹å›¢é˜Ÿ (<20äºº)
- âœ… ä¸­å°è§„æ¨¡åº”ç”¨ (<100ä¸ªæœåŠ¡)
- âœ… ç®€å•çš„å¾®æœåŠ¡æ¶æ„
- âœ… å¿«é€ŸåŸå‹éªŒè¯
- âœ… å·²æœ‰Dockerç»éªŒ,æƒ³å¿«é€Ÿä¸Šå®¹å™¨ç¼–æ’

**Kubernetes é€‚åˆ:**
- âœ… ä¸­å¤§å‹å›¢é˜Ÿ
- âœ… å¤§è§„æ¨¡åº”ç”¨ (100+æœåŠ¡)
- âœ… å¤æ‚çš„å¾®æœåŠ¡æ¶æ„
- âœ… éœ€è¦è‡ªåŠ¨æ‰©ç¼©å®¹
- âœ… å¤šäº‘/æ··åˆäº‘éƒ¨ç½²
- âœ… éœ€è¦ä¸°å¯Œçš„ç”Ÿæ€å·¥å…·é“¾
- âœ… ä¼ä¸šçº§ç”Ÿäº§ç¯å¢ƒ

**å®é™…æ¡ˆä¾‹å¯¹æ¯”**

```yaml
# Docker Swarm éƒ¨ç½²ç¤ºä¾‹
version: '3.8'
services:
  web:
    image: nginx:1.25
    deploy:
      replicas: 3
    ports:
      - "80:80"

# Kubernetes ç­‰ä»·é…ç½®
apiVersion: apps/v1
kind: Deployment
metadata:
  name: web
spec:
  replicas: 3
  selector:
    matchLabels:
      app: web
  template:
    metadata:
      labels:
        app: web
    spec:
      containers:
      - name: nginx
        image: nginx:1.25
---
apiVersion: v1
kind: Service
metadata:
  name: web
spec:
  selector:
    app: web
  ports:
  - port: 80
  type: LoadBalancer
```

Swarm æ›´ç®€æ´,ä½† K8s æä¾›æ›´å¤šæ§åˆ¶å’ŒåŠŸèƒ½!

### 1.1.4 Kubernetes é€‚ç”¨åœºæ™¯

**âœ… æœ€é€‚åˆçš„åœºæ™¯**

**1. å¾®æœåŠ¡æ¶æ„**

```
ä¼ ç»Ÿå•ä½“åº”ç”¨:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     Monolithic App          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  UI + Logic + DB     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
é—®é¢˜: æ‰©å±•å›°éš¾,éƒ¨ç½²é£é™©é«˜

å¾®æœåŠ¡æ¶æ„ (K8sç®¡ç†):
â”Œâ”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”
â”‚ UI   â”‚  â”‚ API  â”‚  â”‚Auth  â”‚
â”‚Serviceâ”‚  â”‚Gatewayâ”‚ â”‚Serviceâ”‚
â””â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”˜
   â”‚         â”‚         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”
â”‚Order â”‚  â”‚User  â”‚  â”‚Pay   â”‚
â”‚Serviceâ”‚  â”‚Serviceâ”‚ â”‚Serviceâ”‚
â””â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”˜
   â”‚         â”‚         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”
â”‚MySQL â”‚  â”‚Redis â”‚  â”‚Kafka â”‚
â””â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”˜

K8s ä¼˜åŠ¿:
- æ¯ä¸ªæœåŠ¡ç‹¬ç«‹éƒ¨ç½²/æ‰©å±•
- æœåŠ¡å‘ç°è‡ªåŠ¨åŒ–
- æ»šåŠ¨æ›´æ–°é›¶åœæœº
- æ•…éšœéš”ç¦»
```

**2. äº‘åŸç”Ÿåº”ç”¨**

```yaml
# 12-Factor App ç¤ºä¾‹
apiVersion: apps/v1
kind: Deployment
metadata:
  name: cloud-native-app
spec:
  replicas: 3
  template:
    spec:
      containers:
      - name: app
        image: myapp:v2.1.0  # I. åŸºå‡†ä»£ç 
        env:
        - name: CONFIG_URL   # III. é…ç½® (ç¯å¢ƒå˜é‡)
          value: "https://config.example.com"
        ports:
        - containerPort: 8080  # VII. ç«¯å£ç»‘å®š
        livenessProbe:          # IX. æ˜“å¤„ç†æ€§
          httpGet:
            path: /health
        resources:
          limits:
            memory: "512Mi"
            cpu: "500m"
---
apiVersion: v1
kind: Service
metadata:
  name: app-service
spec:
  type: LoadBalancer  # IV. åç«¯æœåŠ¡
  selector:
    app: cloud-native-app
```

**3. éœ€è¦é«˜å¯ç”¨çš„ä¸šåŠ¡ç³»ç»Ÿ**

```yaml
# ç”µå•†ç³»ç»Ÿé«˜å¯ç”¨é…ç½®
apiVersion: apps/v1
kind: Deployment
metadata:
  name: order-service
spec:
  replicas: 5  # å¤šå‰¯æœ¬
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0  # é›¶åœæœºæ›´æ–°
  template:
    spec:
      affinity:
        podAntiAffinity:  # åˆ†æ•£åˆ°ä¸åŒèŠ‚ç‚¹
          requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchExpressions:
              - key: app
                operator: In
                values:
                - order-service
            topologyKey: kubernetes.io/hostname
      containers:
      - name: order-service
        image: order:v1.2.3
        readinessProbe:  # å°±ç»ªæ£€æŸ¥
          httpGet:
            path: /ready
          initialDelaySeconds: 10
          periodSeconds: 5
        livenessProbe:   # å­˜æ´»æ£€æŸ¥
          httpGet:
            path: /health
          initialDelaySeconds: 30
          periodSeconds: 10
```

ç»“æœ:
- SLA > 99.95% (å¹´åœæœº < 4.4å°æ—¶)
- å•èŠ‚ç‚¹æ•…éšœä¸å½±å“æœåŠ¡
- æ»šåŠ¨æ›´æ–°é›¶åœæœº

**4. éœ€è¦å¼¹æ€§ä¼¸ç¼©çš„åº”ç”¨**

```yaml
# è§†é¢‘è½¬ç æœåŠ¡ - æ ¹æ®é˜Ÿåˆ—é•¿åº¦è‡ªåŠ¨æ‰©ç¼©å®¹
apiVersion: apps/v1
kind: Deployment
metadata:
  name: video-transcoder
spec:
  replicas: 2  # æœ€å°å‰¯æœ¬
  template:
    spec:
      containers:
      - name: transcoder
        image: ffmpeg-worker:latest
        resources:
          requests:
            cpu: "2"
            memory: "4Gi"
---
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: transcoder-hpa
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: video-transcoder
  minReplicas: 2
  maxReplicas: 50  # é«˜å³°æœŸè‡ªåŠ¨æ‰©å±•åˆ°50ä¸ª
  metrics:
  - type: External
    external:
      metric:
        name: rabbitmq_queue_messages
        selector:
          matchLabels:
            queue: transcode_queue
      target:
        type: AverageValue
        averageValue: "10"  # æ¯ä¸ªPodå¤„ç†10ä¸ªä»»åŠ¡
```

å®é™…æ•ˆæœ:
```
é˜Ÿåˆ—é•¿åº¦  å‰¯æœ¬æ•°  å¤„ç†èƒ½åŠ›
10        2       20 ä»»åŠ¡/åˆ†é’Ÿ
100       10      200 ä»»åŠ¡/åˆ†é’Ÿ
500       50      1000 ä»»åŠ¡/åˆ†é’Ÿ
20        2       è‡ªåŠ¨ç¼©å®¹
```

**âŒ ä¸é€‚åˆçš„åœºæ™¯**

**1. ç®€å•çš„å•ä½“åº”ç”¨**

```
åœºæ™¯: ä¸ªäººåšå®¢ (WordPress)
- 1ä¸ªWebå®¹å™¨
- 1ä¸ªMySQLå®¹å™¨
- è®¿é—®é‡ <1000 PV/å¤©

é—®é¢˜:
- K8så¤ªé‡äº†,è¿è¡Œ3ä¸ªMaster + 2ä¸ªWorker = 5å°æœåŠ¡å™¨
- å­¦ä¹ æˆæœ¬é«˜
- ç»´æŠ¤å¤æ‚

æ›´å¥½çš„é€‰æ‹©:
- Docker Compose
- æ‰˜ç®¡WordPress (å¦‚Hostinger)
- Serverless (å¦‚Vercel/Netlify)
```

**2. é—ç•™ç³»ç»Ÿ (Legacy Applications)**

```
åœºæ™¯: 15å¹´å†å²çš„Java Swingæ¡Œé¢åº”ç”¨
- ä¾èµ–Windowsç‰¹å®šåº“
- éœ€è¦GUIç•Œé¢
- çŠ¶æ€ç»‘å®šæœ¬åœ°æ–‡ä»¶

é—®é¢˜:
- æ— æ³•å®¹å™¨åŒ–
- ä¸ç¬¦åˆ12-Factor
- æ— æ³•æ°´å¹³æ‰©å±•

æ›´å¥½çš„é€‰æ‹©:
- ä¼ ç»Ÿè™šæ‹Ÿæœºéƒ¨ç½²
- é€æ­¥é‡æ„ä¸ºWebåº”ç”¨
```

**3. ç¡¬ä»¶ç»‘å®šåº”ç”¨**

```
åœºæ™¯: GPUæ·±åº¦å­¦ä¹ è®­ç»ƒ
- éœ€è¦8å¡A100 GPU
- å•ä»»åŠ¡è¿è¡Œæ•°å¤©
- CUDAç‰ˆæœ¬ä¸¥æ ¼ç»‘å®š

é—®é¢˜:
- K8sè°ƒåº¦å¼€é”€å¤§
- GPUèµ„æºç¢ç‰‡åŒ–
- æ•…éšœæ¢å¤ä»£ä»·é«˜

æ›´å¥½çš„é€‰æ‹©:
- è£¸é‡‘å±æœåŠ¡å™¨
- Slurm/PBSä½œä¸šè°ƒåº¦
- å¦‚æœä¸€å®šè¦ç”¨K8s,è€ƒè™‘Kubeflow
```

**4. è¶…å°è§„æ¨¡éƒ¨ç½²**

```
åœºæ™¯: åˆ›ä¸šå…¬å¸MVP
- 1-2ä¸ªå¼€å‘è€…
- 2-3ä¸ªå¾®æœåŠ¡
- é¢„ç®—æœ‰é™

é—®é¢˜:
- K8så­¦ä¹ æˆæœ¬ > å¼€å‘æˆæœ¬
- è¿‡åº¦è®¾è®¡
- äº‘èµ„æºæµªè´¹

æ›´å¥½çš„é€‰æ‹©:
- Docker Compose
- PaaSå¹³å° (Heroku/Railway)
- Serverless
- ç­‰è§„æ¨¡å¤§äº†å†è¿ç§»K8s
```

**å†³ç­–æ ‘**

```
æ˜¯å¦éœ€è¦å®¹å™¨ç¼–æ’?
â”œâ”€ å¦ â†’ Docker/è™šæ‹Ÿæœº
â””â”€ æ˜¯ â†’ åº”ç”¨æ•°é‡?
     â”œâ”€ <10ä¸ª â†’ Docker Swarm/Compose
     â””â”€ â‰¥10ä¸ª â†’ æ˜¯å¦éœ€è¦è‡ªåŠ¨æ‰©ç¼©å®¹?
          â”œâ”€ å¦ â†’ Docker Swarm
          â””â”€ æ˜¯ â†’ å›¢é˜Ÿæ˜¯å¦æœ‰K8sç»éªŒ?
               â”œâ”€ å¦ â†’ å…ˆå­¦ä¹ /å°è§„æ¨¡è¯•ç‚¹
               â””â”€ æ˜¯ â†’ Kubernetes âœ…
```

---

## 1.2 Kubernetes æ¶æ„è®¾è®¡

### 1.2.1 Master-Node æ¶æ„æ¨¡å‹

**æ•´ä½“æ¶æ„å›¾**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Master Nodes                            â”‚
â”‚                      (Control Plane)                            â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚              â”‚   â”‚              â”‚   â”‚              â”‚       â”‚
â”‚  â”‚ kube-        â”‚â—„â”€â”€â”¤   etcd       â”‚â”€â”€â–ºâ”‚              â”‚       â”‚
â”‚  â”‚ apiserver    â”‚   â”‚   Cluster    â”‚   â”‚              â”‚       â”‚
â”‚  â”‚              â”‚   â”‚ (Key-Value)  â”‚   â”‚              â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚         â”‚                                                       â”‚
â”‚         â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚ kube-        â”‚   â”‚ cloud-       â”‚       â”‚
â”‚         â”‚           â”‚ scheduler    â”‚   â”‚ controller-  â”‚       â”‚
â”‚         â”‚           â”‚              â”‚   â”‚ manager      â”‚       â”‚
â”‚         â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚         â”‚                                                       â”‚
â”‚         â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                           â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚ kube-        â”‚                           â”‚
â”‚                     â”‚ controller-  â”‚                           â”‚
â”‚                     â”‚ manager      â”‚                           â”‚
â”‚                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   Kubernetes API   â”‚
                    â”‚   (REST/gRPC)      â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                     â”‚                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
â”‚  Worker Node 1â”‚     â”‚  Worker Node 2â”‚     â”‚ Worker Node 3â”‚
â”‚               â”‚     â”‚               â”‚     â”‚              â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚     â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚     â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚ â”‚  kubelet  â”‚ â”‚     â”‚ â”‚  kubelet  â”‚ â”‚     â”‚ â”‚ kubelet  â”‚â”‚
â”‚ â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â”‚     â”‚ â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â”‚     â”‚ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜â”‚
â”‚       â”‚       â”‚     â”‚       â”‚       â”‚     â”‚      â”‚      â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â” â”‚     â”‚ â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â” â”‚     â”‚ â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”â”‚
â”‚ â”‚Container  â”‚ â”‚     â”‚ â”‚Container  â”‚ â”‚     â”‚ â”‚Container â”‚â”‚
â”‚ â”‚Runtime    â”‚ â”‚     â”‚ â”‚Runtime    â”‚ â”‚     â”‚ â”‚Runtime   â”‚â”‚
â”‚ â”‚(containerdâ”‚ â”‚     â”‚ â”‚(containerdâ”‚ â”‚     â”‚ â”‚containerdâ”‚â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚     â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚     â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚               â”‚     â”‚               â”‚     â”‚              â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚     â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚     â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚ â”‚kube-proxy â”‚ â”‚     â”‚ â”‚kube-proxy â”‚ â”‚     â”‚ â”‚kube-proxyâ”‚â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚     â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚     â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚               â”‚     â”‚               â”‚     â”‚              â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”â”Œâ”€â”€â”€â”€â”€â”â”‚     â”‚ â”Œâ”€â”€â”€â”€â”€â”â”Œâ”€â”€â”€â”€â”€â”â”‚     â”‚ â”Œâ”€â”€â”€â”€â”€â”    â”‚
â”‚ â”‚ Pod â”‚â”‚ Pod â”‚â”‚     â”‚ â”‚ Pod â”‚â”‚ Pod â”‚â”‚     â”‚ â”‚ Pod â”‚    â”‚
â”‚ â””â”€â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€â”€â”˜â”‚     â”‚ â””â”€â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€â”€â”˜â”‚     â”‚ â””â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Master Node (æ§åˆ¶å¹³é¢) èŒè´£**

Master èŠ‚ç‚¹è´Ÿè´£é›†ç¾¤çš„"å¤§è„‘"åŠŸèƒ½:

1. **æ¥æ”¶è¯·æ±‚**: é€šè¿‡ API Server æ¥æ”¶ kubectl/å®¢æˆ·ç«¯è¯·æ±‚
2. **çŠ¶æ€å­˜å‚¨**: é€šè¿‡ etcd å­˜å‚¨é›†ç¾¤æ‰€æœ‰çŠ¶æ€
3. **è°ƒåº¦å†³ç­–**: é€šè¿‡ Scheduler å†³å®š Pod è¿è¡Œåœ¨å“ªä¸ª Node
4. **æ§åˆ¶å¾ªç¯**: é€šè¿‡ Controller Manager ç¡®ä¿å®é™…çŠ¶æ€=æœŸæœ›çŠ¶æ€
5. **äº‘é›†æˆ**: é€šè¿‡ Cloud Controller Manager ä¸äº‘å¹³å°äº¤äº’

**Worker Node (æ•°æ®å¹³é¢) èŒè´£**

Worker èŠ‚ç‚¹è´Ÿè´£å®é™…è¿è¡Œå·¥ä½œè´Ÿè½½:

1. **Podç®¡ç†**: kubelet ç®¡ç† Pod ç”Ÿå‘½å‘¨æœŸ
2. **å®¹å™¨è¿è¡Œ**: containerd/CRI-O è¿è¡Œå®¹å™¨
3. **ç½‘ç»œä»£ç†**: kube-proxy ç»´æŠ¤ç½‘ç»œè§„åˆ™
4. **èµ„æºç›‘æ§**: ä¸ŠæŠ¥èŠ‚ç‚¹å’ŒPodèµ„æºä½¿ç”¨æƒ…å†µ

**é«˜å¯ç”¨æ¶æ„**

ç”Ÿäº§ç¯å¢ƒé€šå¸¸é‡‡ç”¨å¤šMasteræ¶æ„:

```
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚  LoadBalancer  â”‚
                  â”‚  (HAProxy/Nginx) â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                 â”‚                 â”‚
   â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
   â”‚  Master1  â”‚     â”‚  Master2  â”‚     â”‚  Master3  â”‚
   â”‚           â”‚     â”‚           â”‚     â”‚           â”‚
   â”‚ API Serverâ”‚     â”‚ API Serverâ”‚     â”‚ API Serverâ”‚
   â”‚ Scheduler â”‚     â”‚ Scheduler â”‚     â”‚ Scheduler â”‚
   â”‚Controller â”‚     â”‚Controller â”‚     â”‚Controller â”‚
   â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
         â”‚                 â”‚                 â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚  etcd Cluster  â”‚
                  â”‚  (Raftå…±è¯†)    â”‚
                  â”‚  â”Œâ”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â” â”‚
                  â”‚  â”‚ 1 â”‚ 2 â”‚ 3 â”‚ â”‚
                  â”‚  â””â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”˜ â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

å…³é”®ç‚¹:
- **3æˆ–5ä¸ªMaster**: å¥‡æ•°ä¸ªèŠ‚ç‚¹,é˜²æ­¢è„‘è£‚
- **etcdé›†ç¾¤**: ä½¿ç”¨Raftåè®®ä¿è¯æ•°æ®ä¸€è‡´æ€§
- **è´Ÿè½½å‡è¡¡**: API Serverå‰ç«¯è´Ÿè½½å‡è¡¡
- **Leaderé€‰ä¸¾**: Schedulerå’ŒController ManageråŒæ—¶åªæœ‰ä¸€ä¸ªLeaderå·¥ä½œ

### 1.2.2 æ§åˆ¶å¹³é¢ç»„ä»¶è¯¦è§£

**1. kube-apiserver: RESTful API ç½‘å…³**

**æ ¸å¿ƒèŒè´£**:
- æä¾› RESTful API æ¥å£
- è®¤è¯å’Œæˆæƒ (Authentication & Authorization)
- å‡†å…¥æ§åˆ¶ (Admission Control)
- èµ„æºéªŒè¯å’Œç‰ˆæœ¬è½¬æ¢
- ä¸ etcd äº¤äº’ (å”¯ä¸€ç›´æ¥è®¿é—®etcdçš„ç»„ä»¶)

**å·¥ä½œæµç¨‹**:

```
kubectl create -f deployment.yaml
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   1. Authentication (è®¤è¯)         â”‚
â”‚   - X.509 è¯ä¹¦                     â”‚
â”‚   - Bearer Token                   â”‚
â”‚   - Service Account                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   2. Authorization (æˆæƒ)          â”‚
â”‚   - RBACæ£€æŸ¥                       â”‚
â”‚   - æ˜¯å¦æœ‰æƒé™åˆ›å»ºDeployment?      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   3. Admission Control (å‡†å…¥æ§åˆ¶)  â”‚
â”‚   - Mutating Webhook (ä¿®æ”¹èµ„æº)    â”‚
â”‚   - Validating Webhook (éªŒè¯èµ„æº)  â”‚
â”‚   - ResourceQuota æ£€æŸ¥             â”‚
â”‚   - LimitRanger æ£€æŸ¥               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   4. Validation (èµ„æºéªŒè¯)         â”‚
â”‚   - SchemaéªŒè¯                     â”‚
â”‚   - å­—æ®µåˆæ³•æ€§æ£€æŸ¥                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   5. Persistence (æŒä¹…åŒ–åˆ°etcd)    â”‚
â”‚   - å†™å…¥ etcd                      â”‚
â”‚   - è¿”å›æˆåŠŸå“åº”                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**API åˆ†ç»„**:

```bash
# æ ¸å¿ƒAPIç»„ (æ— ç»„å)
/api/v1/pods
/api/v1/services
/api/v1/nodes

# åº”ç”¨APIç»„
/apis/apps/v1/deployments
/apis/apps/v1/statefulsets

# æ‰¹å¤„ç†APIç»„
/apis/batch/v1/jobs
/apis/batch/v1/cronjobs

# ç½‘ç»œAPIç»„
/apis/networking.k8s.io/v1/ingresses
/apis/networking.k8s.io/v1/networkpolicies

# è‡ªå®šä¹‰APIç»„
/apis/stable.example.com/v1/crontabs
```

**æŸ¥çœ‹APIèµ„æº**:

```bash
# åˆ—å‡ºæ‰€æœ‰APIèµ„æº
kubectl api-resources

# æŸ¥çœ‹ç‰¹å®šèµ„æºçš„APIç‰ˆæœ¬
kubectl explain deployment

# æŸ¥çœ‹APIç‰ˆæœ¬åˆ—è¡¨
kubectl api-versions
```

**API Server é…ç½®ç¤ºä¾‹**:

```yaml
# /etc/kubernetes/manifests/kube-apiserver.yaml
apiVersion: v1
kind: Pod
metadata:
  name: kube-apiserver
  namespace: kube-system
spec:
  containers:
  - name: kube-apiserver
    image: k8s.gcr.io/kube-apiserver:v1.28.0
    command:
    - kube-apiserver
    # etcdé…ç½®
    - --etcd-servers=https://127.0.0.1:2379
    - --etcd-cafile=/etc/kubernetes/pki/etcd/ca.crt
    - --etcd-certfile=/etc/kubernetes/pki/apiserver-etcd-client.crt
    - --etcd-keyfile=/etc/kubernetes/pki/apiserver-etcd-client.key
    # è®¤è¯é…ç½®
    - --client-ca-file=/etc/kubernetes/pki/ca.crt
    - --tls-cert-file=/etc/kubernetes/pki/apiserver.crt
    - --tls-private-key-file=/etc/kubernetes/pki/apiserver.key
    # æˆæƒé…ç½®
    - --authorization-mode=Node,RBAC
    # å‡†å…¥æ§åˆ¶
    - --enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,ResourceQuota
    # æœåŠ¡è´¦æˆ·é…ç½®
    - --service-account-key-file=/etc/kubernetes/pki/sa.pub
    - --service-account-signing-key-file=/etc/kubernetes/pki/sa.key
    - --service-account-issuer=https://kubernetes.default.svc.cluster.local
    # å®¡è®¡æ—¥å¿—
    - --audit-log-path=/var/log/kubernetes/audit.log
    - --audit-log-maxage=30
    - --audit-log-maxbackup=10
    - --audit-log-maxsize=100
    # é«˜å¯ç”¨é…ç½®
    - --apiserver-count=3
    # æ€§èƒ½è°ƒä¼˜
    - --max-requests-inflight=400
    - --max-mutating-requests-inflight=200
```


#### 1.2.2.2 etcd: åˆ†å¸ƒå¼é”®å€¼å­˜å‚¨

**æ ¸å¿ƒèŒè´£**:

etcd æ˜¯ Kubernetes çš„"å”¯ä¸€æ•°æ®æº(Single Source of Truth)",å­˜å‚¨é›†ç¾¤æ‰€æœ‰çŠ¶æ€æ•°æ®:

```
etcd æ•°æ®ç»“æ„:
/registry/
  â”œâ”€â”€ pods/
  â”‚   â”œâ”€â”€ default/
  â”‚   â”‚   â”œâ”€â”€ nginx-7c5ddbdf54-8xk9p
  â”‚   â”‚   â””â”€â”€ redis-master-0
  â”‚   â””â”€â”€ kube-system/
  â”‚       â”œâ”€â”€ coredns-787d4945fb-2xhjk
  â”‚       â””â”€â”€ kube-proxy-4k9zx
  â”œâ”€â”€ services/
  â”‚   â”œâ”€â”€ default/kubernetes
  â”‚   â””â”€â”€ kube-system/kube-dns
  â”œâ”€â”€ deployments/
  â”œâ”€â”€ replicasets/
  â”œâ”€â”€ configmaps/
  â””â”€â”€ secrets/
```

**Raft ä¸€è‡´æ€§ç®—æ³•**:

etcd ä½¿ç”¨ Raft ç®—æ³•ä¿è¯æ•°æ®ä¸€è‡´æ€§:

```
Raft è§’è‰²è½¬æ¢:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Follower   â”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
      â”‚                 â”‚
      â”‚ é€‰ä¸¾è¶…æ—¶         â”‚ æ”¶åˆ°åˆæ³•Leaderå¿ƒè·³
      â†“                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  Candidate  â”‚         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
      â”‚                 â”‚
      â”‚ è·å¾—å¤šæ•°ç¥¨        â”‚
      â†“                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚   Leader    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**etcd é›†ç¾¤éƒ¨ç½²(3èŠ‚ç‚¹)**:

```yaml
# etcd-1 é…ç½® (/etc/etcd/etcd.conf.yml)
name: etcd-1
data-dir: /var/lib/etcd
initial-advertise-peer-urls: https://10.0.1.10:2380
listen-peer-urls: https://10.0.1.10:2380
listen-client-urls: https://10.0.1.10:2379,https://127.0.0.1:2379
advertise-client-urls: https://10.0.1.10:2379
initial-cluster-token: etcd-cluster-prod
initial-cluster: etcd-1=https://10.0.1.10:2380,etcd-2=https://10.0.1.11:2380,etcd-3=https://10.0.1.12:2380
initial-cluster-state: new

# TLSé…ç½®
client-transport-security:
  cert-file: /etc/kubernetes/pki/etcd/server.crt
  key-file: /etc/kubernetes/pki/etcd/server.key
  trusted-ca-file: /etc/kubernetes/pki/etcd/ca.crt
peer-transport-security:
  cert-file: /etc/kubernetes/pki/etcd/peer.crt
  key-file: /etc/kubernetes/pki/etcd/peer.key
  trusted-ca-file: /etc/kubernetes/pki/etcd/ca.crt

# æ€§èƒ½ä¼˜åŒ–
quota-backend-bytes: 8589934592  # 8GB
auto-compaction-mode: periodic
auto-compaction-retention: "1h"
snapshot-count: 10000
```

**etcd è¿ç»´å‘½ä»¤**:

```bash
# æŸ¥çœ‹é›†ç¾¤æˆå‘˜
ETCDCTL_API=3 etcdctl --endpoints=https://127.0.0.1:2379 \
  --cacert=/etc/kubernetes/pki/etcd/ca.crt \
  --cert=/etc/kubernetes/pki/etcd/server.crt \
  --key=/etc/kubernetes/pki/etcd/server.key \
  member list

# è¾“å‡ºç¤ºä¾‹
a8266ecf031671f3, started, etcd-1, https://10.0.1.10:2380, https://10.0.1.10:2379, false
b57481f970c2d519, started, etcd-2, https://10.0.1.11:2380, https://10.0.1.11:2379, false
c342a5e9e5da84d1, started, etcd-3, https://10.0.1.12:2380, https://10.0.1.12:2379, false

# æŸ¥çœ‹é›†ç¾¤å¥åº·çŠ¶æ€
ETCDCTL_API=3 etcdctl endpoint health --cluster

# æŸ¥çœ‹Leader
ETCDCTL_API=3 etcdctl endpoint status --cluster \
  --write-out=table

# å¤‡ä»½etcdæ•°æ®
ETCDCTL_API=3 etcdctl snapshot save /backup/etcd-snapshot-$(date +%Y%m%d-%H%M%S).db

# æ¢å¤etcdæ•°æ®
ETCDCTL_API=3 etcdctl snapshot restore /backup/etcd-snapshot.db \
  --data-dir=/var/lib/etcd-restore

# æŸ¥çœ‹K8så­˜å‚¨çš„æ•°æ®
ETCDCTL_API=3 etcdctl get /registry/pods/default/nginx --prefix --keys-only

# æŸ¥çœ‹etcdæ€§èƒ½æŒ‡æ ‡
ETCDCTL_API=3 etcdctl endpoint status --write-out=table
```


**etcd æ€§èƒ½ä¼˜åŒ–**:

```bash
# 1. ç£ç›˜ä¼˜åŒ– (ä½¿ç”¨SSD)
# æ£€æŸ¥ç£ç›˜å»¶è¿Ÿ
sudo fio --filename=/var/lib/etcd/testfile --direct=1 --rw=write --bs=2300 --size=10G --numjobs=1 --name=etcd-fsync

# 2. ç½‘ç»œä¼˜åŒ–
# etcdå¯¹ç½‘ç»œå»¶è¿Ÿæ•æ„Ÿ,å»ºè®®RTT < 10ms
ping -c 10 10.0.1.11

# 3. å†…å­˜ä¼˜åŒ–
# etcdè¿›ç¨‹å»ºè®®åˆ†é…8GBå†…å­˜
# åœ¨systemdä¸­é…ç½®å†…å­˜é™åˆ¶
[Service]
MemoryLimit=8G

# 4. ç›‘æ§å…³é”®æŒ‡æ ‡
# - Raft proposals committed: å·²æäº¤çš„ææ¡ˆæ•°
# - Backend commit duration: åç«¯æäº¤å»¶è¿Ÿ
# - Leader changes: Leaderåˆ‡æ¢æ¬¡æ•° (åº”æ¥è¿‘0)
# - Snapshot save time: å¿«ç…§ä¿å­˜æ—¶é—´
```


#### 1.2.2.3 kube-scheduler: æ™ºèƒ½è°ƒåº¦å™¨

**æ ¸å¿ƒèŒè´£**:

Scheduler è´Ÿè´£ä¸ºæ–°åˆ›å»ºçš„ Pod é€‰æ‹©æœ€ä¼˜ Node,è¿™æ˜¯ Kubernetes è‡ªåŠ¨åŒ–è¿ç»´çš„æ ¸å¿ƒèƒ½åŠ›ä¹‹ä¸€ã€‚

```
è°ƒåº¦æµç¨‹:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. ç›‘å¬ API Server                          â”‚
â”‚     æ–°Pod (NodeNameä¸ºç©º) â†’ åŠ å…¥è°ƒåº¦é˜Ÿåˆ—      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. Predicates (é¢„é€‰é˜¶æ®µ)                    â”‚
â”‚     è¿‡æ»¤ä¸æ»¡è¶³æ¡ä»¶çš„èŠ‚ç‚¹                      â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚     â”‚ âœ“ èµ„æºæ˜¯å¦å……è¶³ (CPU/å†…å­˜/GPU)    â”‚    â”‚
â”‚     â”‚ âœ“ ç«¯å£æ˜¯å¦å†²çª                    â”‚    â”‚
â”‚     â”‚ âœ“ èŠ‚ç‚¹é€‰æ‹©å™¨åŒ¹é…                  â”‚    â”‚
â”‚     â”‚ âœ“ äº²å’Œæ€§/åäº²å’Œæ€§è§„åˆ™             â”‚    â”‚
â”‚     â”‚ âœ“ æ±¡ç‚¹/å®¹å¿åº¦                     â”‚    â”‚
â”‚     â”‚ âœ“ PVç»‘å®šæ¡ä»¶                      â”‚    â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚     100 Nodes â†’ 20 Nodes                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. Priorities (ä¼˜é€‰é˜¶æ®µ)                    â”‚
â”‚     å¯¹å€™é€‰èŠ‚ç‚¹æ‰“åˆ† (0-100åˆ†)                 â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚     â”‚ â€¢ èµ„æºå‡è¡¡åº¦ (30åˆ†)              â”‚    â”‚
â”‚     â”‚ â€¢ Podäº²å’Œæ€§ (20åˆ†)               â”‚    â”‚
â”‚     â”‚ â€¢ é•œåƒæœ¬åœ°æ€§ (10åˆ†)              â”‚    â”‚
â”‚     â”‚ â€¢ è´Ÿè½½å‡è¡¡ (15åˆ†)                â”‚    â”‚
â”‚     â”‚ â€¢ è‡ªå®šä¹‰è°ƒåº¦ç­–ç•¥ (25åˆ†)          â”‚    â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚     20 Nodes â†’ Node-7 (å¾—åˆ†æœ€é«˜: 87åˆ†)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  4. Bind (ç»‘å®š)                              â”‚
â”‚     æ›´æ–°Pod.spec.nodeName = "Node-7"         â”‚
â”‚     â†’ API Server â†’ etcd                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**é¢„é€‰ç­–ç•¥(Predicates)ç¤ºä¾‹**:

```yaml
# æ¡ˆä¾‹1: èŠ‚ç‚¹é€‰æ‹©å™¨ (nodeSelector)
apiVersion: v1
kind: Pod
metadata:
  name: nginx
spec:
  nodeSelector:
    disktype: ssd      # ä»…è°ƒåº¦åˆ°æœ‰ disktype=ssd æ ‡ç­¾çš„èŠ‚ç‚¹
    zone: us-west-1a
  containers:
  - name: nginx
    image: nginx:1.25

---
# æ¡ˆä¾‹2: èŠ‚ç‚¹äº²å’Œæ€§ (Node Affinity)
apiVersion: apps/v1
kind: Deployment
metadata:
  name: redis
spec:
  replicas: 3
  selector:
    matchLabels:
      app: redis
  template:
    metadata:
      labels:
        app: redis
    spec:
      affinity:
        nodeAffinity:
          # ç¡¬æ€§è¦æ±‚: å¿…é¡»æ»¡è¶³
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
            - matchExpressions:
              - key: node-role.kubernetes.io/worker
                operator: In
                values:
                - "true"
          # è½¯æ€§åå¥½: å°½é‡æ»¡è¶³
          preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 80
            preference:
              matchExpressions:
              - key: instance-type
                operator: In
                values:
                - m5.xlarge
                - m5.2xlarge
      containers:
      - name: redis
        image: redis:7.0

---
# æ¡ˆä¾‹3: Podäº²å’Œæ€§/åäº²å’Œæ€§
apiVersion: apps/v1
kind: Deployment
metadata:
  name: web-cache
spec:
  replicas: 3
  selector:
    matchLabels:
      app: cache
  template:
    metadata:
      labels:
        app: cache
    spec:
      affinity:
        # Podäº²å’Œæ€§: ä¸æŒ‡å®šPodéƒ¨ç½²åœ¨ä¸€èµ·
        podAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchExpressions:
              - key: app
                operator: In
                values:
                - web-server
            topologyKey: kubernetes.io/hostname
        # Podåäº²å’Œæ€§: é¿å…ä¸æŒ‡å®šPodéƒ¨ç½²åœ¨åŒä¸€èŠ‚ç‚¹
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            podAffinityTerm:
              labelSelector:
                matchExpressions:
                - key: app
                  operator: In
                  values:
                  - cache
              topologyKey: kubernetes.io/hostname
      containers:
      - name: cache
        image: memcached:1.6

---
# æ¡ˆä¾‹4: æ±¡ç‚¹(Taints)å’Œå®¹å¿åº¦(Tolerations)
# ä¸ºèŠ‚ç‚¹æ·»åŠ æ±¡ç‚¹ (åœ¨èŠ‚ç‚¹ä¸Šæ‰§è¡Œ):
# kubectl taint nodes node-1 gpu=true:NoSchedule

apiVersion: v1
kind: Pod
metadata:
  name: gpu-pod
spec:
  tolerations:
  - key: "gpu"
    operator: "Equal"
    value: "true"
    effect: "NoSchedule"  # å®¹å¿NoScheduleæ±¡ç‚¹
  nodeSelector:
    accelerator: nvidia-tesla-v100
  containers:
  - name: cuda-app
    image: nvidia/cuda:11.0-base
    resources:
      limits:
        nvidia.com/gpu: 1
```

**æ±¡ç‚¹æ•ˆæœç±»å‹**:

| Effect | è¡Œä¸º | åº”ç”¨åœºæ™¯ |
|--------|------|---------|
| **NoSchedule** | ä¸å…è®¸è°ƒåº¦æ–°Pod | èŠ‚ç‚¹ç»´æŠ¤ã€ä¸“ç”¨èŠ‚ç‚¹ |
| **PreferNoSchedule** | å°½é‡ä¸è°ƒåº¦ | è½¯æ€§é™åˆ¶ |
| **NoExecute** | é©±é€ç°æœ‰Pod | èŠ‚ç‚¹æ•…éšœã€èµ„æºä¸è¶³ |

```bash
# æ±¡ç‚¹ç®¡ç†å‘½ä»¤
# æ·»åŠ æ±¡ç‚¹
kubectl taint nodes node-1 key1=value1:NoSchedule

# åˆ é™¤æ±¡ç‚¹ (åœ¨keyååŠ -)
kubectl taint nodes node-1 key1=value1:NoSchedule-

# æŸ¥çœ‹èŠ‚ç‚¹æ±¡ç‚¹
kubectl describe node node-1 | grep Taints
```

**ä¼˜é€‰ç­–ç•¥(Priorities)é…ç½®**:

```yaml
# Scheduler é…ç½®æ–‡ä»¶ (/etc/kubernetes/scheduler-config.yaml)
apiVersion: kubescheduler.config.k8s.io/v1
kind: KubeSchedulerConfiguration
profiles:
- schedulerName: default-scheduler
  plugins:
    # é¢„é€‰æ’ä»¶
    filter:
      enabled:
      - name: NodeResourcesFit      # èµ„æºæ˜¯å¦å……è¶³
      - name: NodePorts             # ç«¯å£æ˜¯å¦å†²çª
      - name: PodTopologySpread     # Podæ‹“æ‰‘åˆ†å¸ƒ
      - name: TaintToleration       # æ±¡ç‚¹å®¹å¿åº¦
      - name: NodeAffinity          # èŠ‚ç‚¹äº²å’Œæ€§
      - name: VolumeBinding         # å­˜å‚¨å·ç»‘å®š
    # æ‰“åˆ†æ’ä»¶
    score:
      enabled:
      - name: NodeResourcesBalancedAllocation  # èµ„æºå‡è¡¡åˆ†é…
        weight: 1
      - name: ImageLocality         # é•œåƒæœ¬åœ°æ€§
        weight: 1
      - name: InterPodAffinity      # Podäº²å’Œæ€§
        weight: 2
      - name: NodeAffinity          # èŠ‚ç‚¹äº²å’Œæ€§
        weight: 2
      - name: PodTopologySpread     # Podæ‹“æ‰‘åˆ†å¸ƒ
        weight: 2
  pluginConfig:
  - name: NodeResourcesFit
    args:
      scoringStrategy:
        type: LeastAllocated        # ä¼˜å…ˆé€‰æ‹©èµ„æºä½¿ç”¨ç‡ä½çš„èŠ‚ç‚¹
        resources:
        - name: cpu
          weight: 1
        - name: memory
          weight: 1
  - name: PodTopologySpread
    args:
      defaultConstraints:
      - maxSkew: 1
        topologyKey: kubernetes.io/hostname
        whenUnsatisfiable: ScheduleAnyway
```

**è‡ªå®šä¹‰è°ƒåº¦å™¨**:

```yaml
# 1. éƒ¨ç½²è‡ªå®šä¹‰è°ƒåº¦å™¨
apiVersion: v1
kind: ServiceAccount
metadata:
  name: my-scheduler
  namespace: kube-system
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: my-scheduler-as-kube-scheduler
subjects:
- kind: ServiceAccount
  name: my-scheduler
  namespace: kube-system
roleRef:
  kind: ClusterRole
  name: system:kube-scheduler
  apiGroup: rbac.authorization.k8s.io
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: my-scheduler
  namespace: kube-system
spec:
  replicas: 1
  selector:
    matchLabels:
      component: my-scheduler
  template:
    metadata:
      labels:
        component: my-scheduler
    spec:
      serviceAccountName: my-scheduler
      containers:
      - name: scheduler
        image: k8s.gcr.io/kube-scheduler:v1.28.0
        command:
        - kube-scheduler
        - --config=/etc/kubernetes/my-scheduler-config.yaml
        - --scheduler-name=my-scheduler
        - --leader-elect=false
        volumeMounts:
        - name: config
          mountPath: /etc/kubernetes
      volumes:
      - name: config
        configMap:
          name: my-scheduler-config

---
# 2. ä½¿ç”¨è‡ªå®šä¹‰è°ƒåº¦å™¨
apiVersion: v1
kind: Pod
metadata:
  name: nginx-custom-scheduler
spec:
  schedulerName: my-scheduler  # æŒ‡å®šè°ƒåº¦å™¨åç§°
  containers:
  - name: nginx
    image: nginx:1.25
```

**è°ƒåº¦å™¨ç›‘æ§ä¸è°ƒè¯•**:

```bash
# æŸ¥çœ‹è°ƒåº¦å™¨æ—¥å¿—
kubectl logs -n kube-system kube-scheduler-master-1

# æŸ¥çœ‹è°ƒåº¦å¤±è´¥çš„Pod
kubectl get events --field-selector reason=FailedScheduling

# æŸ¥çœ‹Podè°ƒåº¦è¯¦æƒ…
kubectl describe pod nginx-pod | grep -A 10 Events

# è°ƒåº¦å™¨æ€§èƒ½æŒ‡æ ‡ (é€šè¿‡Prometheusé‡‡é›†)
# - scheduler_schedule_attempts_total: è°ƒåº¦å°è¯•æ¬¡æ•°
# - scheduler_scheduling_algorithm_duration_seconds: è°ƒåº¦ç®—æ³•è€—æ—¶
# - scheduler_pending_pods: å¾…è°ƒåº¦Podæ•°é‡
# - scheduler_e2e_scheduling_duration_seconds: ç«¯åˆ°ç«¯è°ƒåº¦å»¶è¿Ÿ
# - scheduler_framework_extension_point_duration_seconds: å„æ‰©å±•ç‚¹è€—æ—¶

# æŸ¥çœ‹æ‰€æœ‰è°ƒåº¦å™¨
kubectl get pods -n kube-system | grep scheduler
```


#### 1.2.2.4 kube-controller-manager: æ§åˆ¶å¾ªç¯ç®¡ç†å™¨

**æ ¸å¿ƒèŒè´£**:

Controller Manager è¿è¡Œä¸€ç»„æ§åˆ¶å™¨,æ¯ä¸ªæ§åˆ¶å™¨æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„æ§åˆ¶å¾ªç¯,é€šè¿‡"æœŸæœ›çŠ¶æ€ vs å®é™…çŠ¶æ€"çš„å¯¹æ¯”å®ç°è‡ªåŠ¨åŒ–ç®¡ç†ã€‚

```
æ§åˆ¶å¾ªç¯æ¨¡å‹ (Reconciliation Loop):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  while true:                         â”‚
â”‚    æœŸæœ›çŠ¶æ€ = etcd.get("/spec")      â”‚
â”‚    å®é™…çŠ¶æ€ = è§‚å¯Ÿé›†ç¾¤                â”‚
â”‚                                      â”‚
â”‚    if æœŸæœ›çŠ¶æ€ != å®é™…çŠ¶æ€:           â”‚
â”‚      æ‰§è¡Œè°ƒè°æ“ä½œ                     â”‚
â”‚      (åˆ›å»º/æ›´æ–°/åˆ é™¤èµ„æº)             â”‚
â”‚                                      â”‚
â”‚    sleep(reconcile_interval)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å†…ç½®æ§åˆ¶å™¨åˆ—è¡¨**(éƒ¨åˆ†,å…±37ä¸ª):

| æ§åˆ¶å™¨ | èŒè´£ | è°ƒè°å‘¨æœŸ |
|--------|------|---------|
| **Node Controller** | ç›‘æ§èŠ‚ç‚¹å¥åº·çŠ¶æ€,æ ‡è®°ä¸å¥åº·èŠ‚ç‚¹ | 5s |
| **Deployment Controller** | ç®¡ç†Deploymentçš„æ»šåŠ¨æ›´æ–°å’Œå›æ»š | - |
| **ReplicaSet Controller** | ç¡®ä¿Podå‰¯æœ¬æ•°ç¬¦åˆæœŸæœ›å€¼ | - |
| **StatefulSet Controller** | ç®¡ç†æœ‰çŠ¶æ€åº”ç”¨çš„éƒ¨ç½²å’Œæ‰©ç¼©å®¹ | - |
| **DaemonSet Controller** | ç¡®ä¿æ¯ä¸ªèŠ‚ç‚¹è¿è¡Œä¸€ä¸ªPodå‰¯æœ¬ | - |
| **Job Controller** | ç®¡ç†æ‰¹å¤„ç†ä»»åŠ¡çš„æ‰§è¡Œ | - |
| **CronJob Controller** | ç®¡ç†å®šæ—¶ä»»åŠ¡ | 10s |
| **Service Controller** | ä¸ºServiceåˆ†é…ClusterIP,åˆ›å»ºEndpoints | - |
| **Endpoint Controller** | ç»´æŠ¤Serviceä¸Podçš„æ˜ å°„å…³ç³» | - |
| **Namespace Controller** | åˆ é™¤Namespaceæ—¶æ¸…ç†æ‰€æœ‰èµ„æº | - |
| **PersistentVolume Controller** | ç®¡ç†PV/PVCçš„ç»‘å®šå’Œå›æ”¶ | - |
| **ServiceAccount Controller** | ä¸ºæ¯ä¸ªNamespaceåˆ›å»ºé»˜è®¤ServiceAccount | - |
| **Token Controller** | ä¸ºServiceAccountåˆ›å»ºSecret Token | - |
| **ResourceQuota Controller** | å¼ºåˆ¶æ‰§è¡Œå‘½åç©ºé—´èµ„æºé…é¢ | 5s |
| **Garbage Collector** | æ¸…ç†å­¤å„¿å¯¹è±¡ (OwnerReferences) | - |

**Deployment Controller å·¥ä½œåŸç†**:

```yaml
# ç”¨æˆ·æäº¤Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx
spec:
  replicas: 3  # æœŸæœ›çŠ¶æ€: 3ä¸ªPod
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
      - name: nginx
        image: nginx:1.25
```

```
Deployment Controller è°ƒè°æµç¨‹:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. ç›‘å¬ Deployment å¯¹è±¡å˜åŒ–                 â”‚
â”‚     æœŸæœ›å‰¯æœ¬æ•°: 3                             â”‚
â”‚     å½“å‰å‰¯æœ¬æ•°: 0                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. åˆ›å»º/æ›´æ–° ReplicaSet                     â”‚
â”‚     Deployment Controller åˆ›å»º ReplicaSet    â”‚
â”‚     ç»§æ‰¿ Deployment çš„ template              â”‚
â”‚     ReplicaSetåç§°: nginx-7c5ddbdf54         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. ReplicaSet Controller æ¥ç®¡               â”‚
â”‚     å¯¹æ¯”æœŸæœ›å‰¯æœ¬æ•°(3) vs å®é™…å‰¯æœ¬æ•°(0)       â”‚
â”‚     â†’ åˆ›å»º3ä¸ªPod                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  4. æŒç»­ç›‘æ§                                 â”‚
â”‚     â€¢ Podå¤±è´¥ â†’ é‡æ–°åˆ›å»º                     â”‚
â”‚     â€¢ replicasæ”¹ä¸º5 â†’ æ‰©å®¹2ä¸ªPod             â”‚
â”‚     â€¢ é•œåƒæ›´æ–° â†’ æ»šåŠ¨æ›´æ–°                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ»šåŠ¨æ›´æ–°æµç¨‹**:

```bash
# 1. æ›´æ–°é•œåƒ (è§¦å‘æ»šåŠ¨æ›´æ–°)
kubectl set image deployment/nginx nginx=nginx:1.26

# Deployment Controller æ‰§è¡Œæ»šåŠ¨æ›´æ–°:
# æ­¥éª¤1: åˆ›å»ºæ–°ReplicaSet (replicas=1, é•œåƒnginx:1.26)
# æ­¥éª¤2: ç­‰å¾…æ–°Podå°±ç»ª (ReadinessProbeé€šè¿‡)
# æ­¥éª¤3: ç¼©å‡æ—§ReplicaSet (replicas=2)
# æ­¥éª¤4: æ‰©å±•æ–°ReplicaSet (replicas=2)
# æ­¥éª¤5: ç­‰å¾…æ–°Podå°±ç»ª
# æ­¥éª¤6: ç¼©å‡æ—§ReplicaSet (replicas=1)
# ...
# æ­¥éª¤N: æ—§ReplicaSet (replicas=0), æ–°ReplicaSet (replicas=3)

# æŸ¥çœ‹æ»šåŠ¨æ›´æ–°çŠ¶æ€
kubectl rollout status deployment/nginx
# Waiting for deployment "nginx" rollout to finish: 1 out of 3 new replicas have been updated...

# æŸ¥çœ‹å†å²ç‰ˆæœ¬
kubectl rollout history deployment/nginx
# REVISION  CHANGE-CAUSE
# 1         <none>
# 2         <none>

# å›æ»šåˆ°ä¸Šä¸€ç‰ˆæœ¬
kubectl rollout undo deployment/nginx

# å›æ»šåˆ°æŒ‡å®šç‰ˆæœ¬
kubectl rollout undo deployment/nginx --to-revision=1

# æš‚åœæ»šåŠ¨æ›´æ–° (ç”¨äºé‡‘ä¸é›€å‘å¸ƒ)
kubectl rollout pause deployment/nginx

# æ¢å¤æ»šåŠ¨æ›´æ–°
kubectl rollout resume deployment/nginx
```

**æ»šåŠ¨æ›´æ–°ç­–ç•¥é…ç½®**:

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx
spec:
  replicas: 10
  strategy:
    type: RollingUpdate     # æ»šåŠ¨æ›´æ–° (é»˜è®¤) / Recreate (é‡å»º)
    rollingUpdate:
      maxSurge: 3           # æ›´æ–°è¿‡ç¨‹ä¸­æœ€å¤šè¶…å‡ºæœŸæœ›å‰¯æœ¬æ•°3ä¸ª (å¯ä»¥æ˜¯æ•°å­—æˆ–ç™¾åˆ†æ¯”)
      maxUnavailable: 2     # æ›´æ–°è¿‡ç¨‹ä¸­æœ€å¤šä¸å¯ç”¨2ä¸ªPod
  minReadySeconds: 10       # Podå°±ç»ªåç­‰å¾…10ç§’æ‰è§†ä¸ºå¯ç”¨
  revisionHistoryLimit: 10  # ä¿ç•™10ä¸ªå†å²ReplicaSet
  progressDeadlineSeconds: 600  # æ›´æ–°è¶…æ—¶æ—¶é—´600ç§’
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
      - name: nginx
        image: nginx:1.25
        readinessProbe:      # å°±ç»ªæ¢é’ˆ (å¿…é¡»é…ç½®,å¦åˆ™å¯èƒ½å¯¼è‡´æµé‡ä¸¢å¤±)
          httpGet:
            path: /
            port: 80
          initialDelaySeconds: 5
          periodSeconds: 5
```

**Node Controller å·¥ä½œåŸç†**:

```
èŠ‚ç‚¹å¥åº·æ£€æŸ¥æµç¨‹:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ¯éš” node-monitor-period (é»˜è®¤5ç§’)          â”‚
â”‚  å‘æ‰€æœ‰èŠ‚ç‚¹å‘é€å¥åº·æ£€æŸ¥è¯·æ±‚                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  èŠ‚ç‚¹çŠ¶æ€åˆ¤æ–­:                                â”‚
â”‚  â€¢ Ready: èŠ‚ç‚¹å¥åº· (kubeletæ­£å¸¸å“åº”)         â”‚
â”‚  â€¢ NotReady: èŠ‚ç‚¹å¤±è” (kubeletæ— å“åº”)        â”‚
â”‚  â€¢ Unknown: è¶…æ—¶æœªå“åº”                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è¶…è¿‡ node-monitor-grace-period (é»˜è®¤40ç§’)   â”‚
â”‚  æ ‡è®°èŠ‚ç‚¹ä¸º NotReady                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è¶…è¿‡ pod-eviction-timeout (é»˜è®¤5åˆ†é’Ÿ)       â”‚
â”‚  ä»æœªæ¢å¤ â†’ é©±é€èŠ‚ç‚¹ä¸Šçš„æ‰€æœ‰Pod               â”‚
â”‚  (å¦‚æœèŠ‚ç‚¹æœ‰NoExecuteæ±¡ç‚¹)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**èŠ‚ç‚¹çŠ¶æ€ç¤ºä¾‹**:

```bash
# æŸ¥çœ‹èŠ‚ç‚¹çŠ¶æ€
kubectl get nodes
# NAME          STATUS     ROLES           AGE   VERSION
# k8s-master    Ready      control-plane   10d   v1.28.0
# k8s-worker1   NotReady   <none>          10d   v1.28.0  â† èŠ‚ç‚¹å¤±è”
# k8s-worker2   Ready      <none>          10d   v1.28.0

# æŸ¥çœ‹èŠ‚ç‚¹è¯¦ç»†ä¿¡æ¯
kubectl describe node k8s-worker1
# ...
# Conditions:
#   Type             Status    LastHeartbeatTime                 Reason
#   ----             ------    -----------------                 ------
#   Ready            False     Wed, 13 Dec 2025 10:30:00 +0800   NodeStatusUnknown

# æŸ¥çœ‹èŠ‚ç‚¹ä¸Šçš„Pod (NotReadyèŠ‚ç‚¹çš„Podä¼šè¢«é©±é€)
kubectl get pods --field-selector spec.nodeName=k8s-worker1
```

**Controller Manager é…ç½®**:

```yaml
# /etc/kubernetes/manifests/kube-controller-manager.yaml
apiVersion: v1
kind: Pod
metadata:
  name: kube-controller-manager
  namespace: kube-system
spec:
  containers:
  - name: kube-controller-manager
    image: k8s.gcr.io/kube-controller-manager:v1.28.0
    command:
    - kube-controller-manager
    # é›†ç¾¤é…ç½®
    - --cluster-name=kubernetes
    - --cluster-cidr=10.244.0.0/16  # Podç½‘ç»œCIDR
    - --service-cluster-ip-range=10.96.0.0/12  # Serviceç½‘ç»œCIDR
    - --allocate-node-cidrs=true    # ä¸ºæ¯ä¸ªèŠ‚ç‚¹åˆ†é…Pod CIDR
    # è¯ä¹¦é…ç½®
    - --cluster-signing-cert-file=/etc/kubernetes/pki/ca.crt
    - --cluster-signing-key-file=/etc/kubernetes/pki/ca.key
    - --root-ca-file=/etc/kubernetes/pki/ca.crt
    - --service-account-private-key-file=/etc/kubernetes/pki/sa.key
    # é«˜å¯ç”¨é…ç½®
    - --leader-elect=true
    - --leader-elect-lease-duration=15s
    - --leader-elect-renew-deadline=10s
    - --leader-elect-retry-period=2s
    # èŠ‚ç‚¹ç›‘æ§é…ç½®
    - --node-monitor-period=5s              # èŠ‚ç‚¹å¥åº·æ£€æŸ¥å‘¨æœŸ
    - --node-monitor-grace-period=40s       # èŠ‚ç‚¹æ ‡è®°ä¸ºNotReadyçš„å®½é™æœŸ
    - --pod-eviction-timeout=5m0s           # Podé©±é€è¶…æ—¶æ—¶é—´
    # æ§åˆ¶å™¨é…ç½®
    - --concurrent-deployment-syncs=5       # Deploymentå¹¶å‘åŒæ­¥æ•°
    - --concurrent-replicaset-syncs=5       # ReplicaSetå¹¶å‘åŒæ­¥æ•°
    - --concurrent-service-syncs=1          # Serviceå¹¶å‘åŒæ­¥æ•°
    - --concurrent-namespace-syncs=10       # Namespaceå¹¶å‘åŒæ­¥æ•°
    # èµ„æºé…é¢
    - --kube-api-qps=100
    - --kube-api-burst=100
    # åŠŸèƒ½å¼€å…³ (ç¦ç”¨ä¸éœ€è¦çš„æ§åˆ¶å™¨)
    - --controllers=*,bootstrapsigner,tokencleaner  # å¯ç”¨æ‰€æœ‰æ§åˆ¶å™¨
```

**æŸ¥çœ‹æ§åˆ¶å™¨è¿è¡ŒçŠ¶æ€**:

```bash
# æŸ¥çœ‹controller-manageræ—¥å¿—
kubectl logs -n kube-system kube-controller-manager-master-1

# æŸ¥çœ‹Leaderé€‰ä¸¾çŠ¶æ€ (é«˜å¯ç”¨é›†ç¾¤)
kubectl get endpoints -n kube-system kube-controller-manager -o yaml

# æŸ¥çœ‹æ§åˆ¶å™¨æ€§èƒ½æŒ‡æ ‡
# è®¿é—® http://<master-ip>:10257/metrics (éœ€è¦è®¤è¯)
curl --cacert /etc/kubernetes/pki/ca.crt \
     --cert /etc/kubernetes/pki/admin.crt \
     --key /etc/kubernetes/pki/admin.key \
     https://127.0.0.1:10257/metrics | grep controller

# å…³é”®æŒ‡æ ‡:
# - workqueue_depth: å·¥ä½œé˜Ÿåˆ—æ·±åº¦
# - workqueue_adds_total: å…¥é˜Ÿæ€»æ•°
# - workqueue_retries_total: é‡è¯•æ€»æ•°
# - rest_client_requests_total: APIè¯·æ±‚æ€»æ•°
```

**è‡ªå®šä¹‰æ§åˆ¶å™¨å¼€å‘**(ä½¿ç”¨ Kubebuilder):

```go
// ç¤ºä¾‹: è‡ªå®šä¹‰æ§åˆ¶å™¨ç›‘å¬ CronTab èµ„æº
package controllers

import (
    "context"
    "k8s.io/apimachinery/pkg/runtime"
    ctrl "sigs.k8s.io/controller-runtime"
    "sigs.k8s.io/controller-runtime/pkg/client"
    "sigs.k8s.io/controller-runtime/pkg/log"

    myappv1 "example.com/crontab/api/v1"
)

type CronTabReconciler struct {
    client.Client
    Scheme *runtime.Scheme
}

// è°ƒè°å¾ªç¯ä¸»å‡½æ•°
func (r *CronTabReconciler) Reconcile(ctx context.Context, req ctrl.Request) (ctrl.Result, error) {
    logger := log.FromContext(ctx)

    // 1. è·å–CronTabå¯¹è±¡
    var cronTab myappv1.CronTab
    if err := r.Get(ctx, req.NamespacedName, &cronTab); err != nil {
        logger.Error(err, "unable to fetch CronTab")
        return ctrl.Result{}, client.IgnoreNotFound(err)
    }

    // 2. æ£€æŸ¥æœŸæœ›çŠ¶æ€ vs å®é™…çŠ¶æ€
    logger.Info("Reconciling CronTab", "name", cronTab.Name)

    // 3. æ‰§è¡Œè°ƒè°æ“ä½œ (åˆ›å»º/æ›´æ–°/åˆ é™¤å­èµ„æº)
    // ä¾‹å¦‚: åˆ›å»ºCronJob
    // cronJob := &batchv1.CronJob{...}
    // if err := r.Create(ctx, cronJob); err != nil { ... }

    // 4. æ›´æ–°CronTabçŠ¶æ€
    // cronTab.Status.Active = ...
    // if err := r.Status().Update(ctx, &cronTab); err != nil { ... }

    return ctrl.Result{}, nil
}

// è®¾ç½®ç›‘å¬å™¨
func (r *CronTabReconciler) SetupWithManager(mgr ctrl.Manager) error {
    return ctrl.NewControllerManagedBy(mgr).
        For(&myappv1.CronTab{}).  // ç›‘å¬CronTabèµ„æº
        Owns(&batchv1.CronJob{}). // ç›‘å¬CronTabæ‹¥æœ‰çš„CronJob
        Complete(r)
}
```

#### 1.2.2.5 cloud-controller-manager: äº‘å¹³å°é›†æˆ

**æ ¸å¿ƒèŒè´£**:

Cloud Controller Manager å°† Kubernetes ä¸äº‘å¹³å° API é›†æˆ,ç®¡ç†äº‘ç‰¹å®šèµ„æº (è´Ÿè½½å‡è¡¡å™¨ã€å­˜å‚¨å·ã€è·¯ç”±ç­‰)ã€‚

```
äº‘å¹³å°æ§åˆ¶å™¨:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Node Controller (äº‘ç‰ˆæœ¬)                  â”‚
â”‚  â€¢ ä»äº‘å¹³å°APIè·å–èŠ‚ç‚¹ä¿¡æ¯                  â”‚
â”‚  â€¢ æ ‡è®°å·²åˆ é™¤çš„äº‘ä¸»æœºèŠ‚ç‚¹ä¸ºNotReady        â”‚
â”‚  â€¢ æ›´æ–°èŠ‚ç‚¹Label (region/zone/instance-type)â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Route Controller                          â”‚
â”‚  â€¢ ä¸ºæ¯ä¸ªèŠ‚ç‚¹åœ¨äº‘å¹³å°åˆ›å»ºè·¯ç”±è§„åˆ™          â”‚
â”‚  â€¢ ç¡®ä¿Podé—´è·¨èŠ‚ç‚¹é€šä¿¡                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Service Controller                        â”‚
â”‚  â€¢ LoadBalancerç±»å‹Service â†’ åˆ›å»ºäº‘LB     â”‚
â”‚  â€¢ é…ç½®LBåç«¯ä¸ºServiceå¯¹åº”çš„Pods           â”‚
â”‚  â€¢ æ›´æ–°Service.Status.LoadBalancer.Ingress â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**äº‘å¹³å°é›†æˆç¤ºä¾‹ (AWS)**:

```yaml
# LoadBalancer Service (è‡ªåŠ¨åˆ›å»ºAWS ELB/NLB)
apiVersion: v1
kind: Service
metadata:
  name: nginx-lb
  annotations:
    # AWSç‰¹å®šé…ç½®
    service.beta.kubernetes.io/aws-load-balancer-type: "nlb"  # ä½¿ç”¨NLB (ç½‘ç»œè´Ÿè½½å‡è¡¡å™¨)
    service.beta.kubernetes.io/aws-load-balancer-cross-zone-load-balancing-enabled: "true"
    service.beta.kubernetes.io/aws-load-balancer-ssl-cert: "arn:aws:acm:us-east-1:123456789012:certificate/12345678"
    service.beta.kubernetes.io/aws-load-balancer-ssl-ports: "443"
    service.beta.kubernetes.io/aws-load-balancer-backend-protocol: "http"
spec:
  type: LoadBalancer
  selector:
    app: nginx
  ports:
  - port: 443
    targetPort: 80
    protocol: TCP

---
# PersistentVolumeClaim (è‡ªåŠ¨åˆ›å»ºAWS EBSå·)
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: mysql-pvc
spec:
  accessModes:
  - ReadWriteOnce
  resources:
    requests:
      storage: 100Gi
  storageClassName: gp3  # AWS gp3ç±»å‹SSD

---
# StorageClass (AWS EBS CSI Driveré…ç½®)
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: gp3
provisioner: ebs.csi.aws.com
parameters:
  type: gp3
  iops: "3000"
  throughput: "125"
  encrypted: "true"
  kmsKeyId: "arn:aws:kms:us-east-1:123456789012:key/12345678"
volumeBindingMode: WaitForFirstConsumer
allowVolumeExpansion: true
```

**Cloud Controller Manager éƒ¨ç½²** (AWSç¤ºä¾‹):

```yaml
# cloud-controller-manager.yaml
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: aws-cloud-controller-manager
  namespace: kube-system
spec:
  selector:
    matchLabels:
      k8s-app: aws-cloud-controller-manager
  template:
    metadata:
      labels:
        k8s-app: aws-cloud-controller-manager
    spec:
      nodeSelector:
        node-role.kubernetes.io/control-plane: ""
      tolerations:
      - key: node-role.kubernetes.io/control-plane
        effect: NoSchedule
      - key: node.cloudprovider.kubernetes.io/uninitialized
        value: "true"
        effect: NoSchedule
      serviceAccountName: cloud-controller-manager
      containers:
      - name: aws-cloud-controller-manager
        image: k8s.gcr.io/provider-aws/cloud-controller-manager:v1.28.0
        args:
        - --v=2
        - --cloud-provider=aws
        - --use-service-account-credentials=true
        - --configure-cloud-routes=true
        - --cluster-name=my-k8s-cluster
        env:
        - name: AWS_REGION
          value: us-east-1
```


---

### 1.2.3 Node èŠ‚ç‚¹ç»„ä»¶

Worker Node è¿è¡Œå®é™…å·¥ä½œè´Ÿè½½,åŒ…å«ä»¥ä¸‹æ ¸å¿ƒç»„ä»¶:

```
Worker Node æ¶æ„:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Worker Node                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  kubelet (èŠ‚ç‚¹ä»£ç†)                       â”‚ â”‚
â”‚  â”‚  â€¢ ç®¡ç†Podç”Ÿå‘½å‘¨æœŸ                        â”‚ â”‚
â”‚  â”‚  â€¢ å‘API ServeræŠ¥å‘ŠèŠ‚ç‚¹/PodçŠ¶æ€           â”‚ â”‚
â”‚  â”‚  â€¢ æ‰§è¡Œå¥åº·æ£€æŸ¥                           â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  kube-proxy (ç½‘ç»œä»£ç†)                    â”‚ â”‚
â”‚  â”‚  â€¢ ç»´æŠ¤ç½‘ç»œè§„åˆ™ (iptables/ipvs)          â”‚ â”‚
â”‚  â”‚  â€¢ å®ç°Serviceè´Ÿè½½å‡è¡¡                    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Container Runtime (å®¹å™¨è¿è¡Œæ—¶)           â”‚ â”‚
â”‚  â”‚  â€¢ containerd / CRI-O / Docker            â”‚ â”‚
â”‚  â”‚  â€¢ æ‹‰å–é•œåƒå¹¶è¿è¡Œå®¹å™¨                     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Pods (å·¥ä½œè´Ÿè½½)                          â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”                  â”‚ â”‚
â”‚  â”‚  â”‚Pod1â”‚  â”‚Pod2â”‚  â”‚Pod3â”‚                  â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”˜                  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 1.2.3.1 kubelet: èŠ‚ç‚¹ä»£ç†

**æ ¸å¿ƒèŒè´£**:

kubelet æ˜¯è¿è¡Œåœ¨æ¯ä¸ª Node ä¸Šçš„ä¸»è¦"èŠ‚ç‚¹ä»£ç†",è´Ÿè´£ Pod ç”Ÿå‘½å‘¨æœŸç®¡ç†ã€‚

```
kubelet å·¥ä½œæµç¨‹:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. ç›‘å¬ API Server                          â”‚
â”‚     è·å–åˆ†é…åˆ°æœ¬èŠ‚ç‚¹çš„Podåˆ—è¡¨ (PodSpec)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. Podç”Ÿå‘½å‘¨æœŸç®¡ç†                          â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚     â”‚ â€¢ åˆ›å»ºPodæ²™ç®± (Pauseå®¹å™¨)        â”‚    â”‚
â”‚     â”‚ â€¢ æ‹‰å–é•œåƒ                        â”‚    â”‚
â”‚     â”‚ â€¢ åˆ›å»ºå¹¶å¯åŠ¨å®¹å™¨                  â”‚    â”‚
â”‚     â”‚ â€¢ æŒ‚è½½Volume                      â”‚    â”‚
â”‚     â”‚ â€¢ é…ç½®ç½‘ç»œ (è°ƒç”¨CNIæ’ä»¶)         â”‚    â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. å¥åº·æ£€æŸ¥                                 â”‚
â”‚     â€¢ Liveness Probe (å­˜æ´»æ¢é’ˆ)              â”‚
â”‚     â€¢ Readiness Probe (å°±ç»ªæ¢é’ˆ)             â”‚
â”‚     â€¢ Startup Probe (å¯åŠ¨æ¢é’ˆ)               â”‚
â”‚     æ¢æµ‹å¤±è´¥ â†’ é‡å¯å®¹å™¨æˆ–ä»Serviceç§»é™¤       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  4. çŠ¶æ€ä¸ŠæŠ¥                                 â”‚
â”‚     æ¯éš”10ç§’å‘API ServeræŠ¥å‘Š:                â”‚
â”‚     â€¢ èŠ‚ç‚¹çŠ¶æ€ (CPU/å†…å­˜/ç£ç›˜/PID)           â”‚
â”‚     â€¢ PodçŠ¶æ€ (Running/Failed/Succeeded)     â”‚
â”‚     â€¢ å®¹å™¨çŠ¶æ€ (Waiting/Running/Terminated)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**kubelet é…ç½®**:

```yaml
# /var/lib/kubelet/config.yaml
apiVersion: kubelet.config.k8s.io/v1beta1
kind: KubeletConfiguration
# è®¤è¯é…ç½®
authentication:
  x509:
    clientCAFile: /etc/kubernetes/pki/ca.crt
  webhook:
    enabled: true
    cacheTTL: 2m0s
  anonymous:
    enabled: false
# æˆæƒé…ç½®
authorization:
  mode: Webhook
  webhook:
    cacheAuthorizedTTL: 5m0s
    cacheUnauthorizedTTL: 30s
# é›†ç¾¤DNSé…ç½®
clusterDNS:
- 10.96.0.10
clusterDomain: cluster.local
# èµ„æºé¢„ç•™ (ä¸ºç³»ç»Ÿå’Œk8sç»„ä»¶é¢„ç•™èµ„æº)
systemReserved:
  cpu: "1"
  memory: "2Gi"
  ephemeral-storage: "10Gi"
kubeReserved:
  cpu: "1"
  memory: "2Gi"
  ephemeral-storage: "10Gi"
# é©±é€é˜ˆå€¼ (èµ„æºä¸è¶³æ—¶é©±é€Pod)
evictionHard:
  memory.available: "500Mi"
  nodefs.available: "10%"
  nodefs.inodesFree: "5%"
  imagefs.available: "15%"
evictionSoft:
  memory.available: "1Gi"
  nodefs.available: "15%"
evictionSoftGracePeriod:
  memory.available: "1m30s"
  nodefs.available: "2m"
# é•œåƒåƒåœ¾å›æ”¶
imageGCHighThresholdPercent: 85  # ç£ç›˜ä½¿ç”¨ç‡è¶…è¿‡85%æ—¶è§¦å‘GC
imageGCLowThresholdPercent: 80   # GCç›´åˆ°é™è‡³80%
imageMinimumGCAge: 2m0s          # é•œåƒè‡³å°‘å­˜åœ¨2åˆ†é’Ÿæ‰èƒ½è¢«GC
# å®¹å™¨è¿è¡Œæ—¶
containerRuntimeEndpoint: unix:///var/run/containerd/containerd.sock
# æ—¥å¿—è½®è½¬
containerLogMaxSize: "50Mi"
containerLogMaxFiles: 5
# æ€§èƒ½è°ƒä¼˜
maxPods: 110                     # èŠ‚ç‚¹æœ€å¤šè¿è¡Œ110ä¸ªPod
podsPerCore: 0                   # 0è¡¨ç¤ºä¸é™åˆ¶
serializeImagePulls: false       # å¹¶è¡Œæ‹‰å–é•œåƒ
registryPullQPS: 10              # é•œåƒæ‹‰å–QPSé™åˆ¶
registryBurst: 20                # é•œåƒæ‹‰å–Burst
# CPUç®¡ç†ç­–ç•¥
cpuManagerPolicy: none           # none / static (ç‹¬å CPUæ ¸å¿ƒ)
# å†…å­˜ç®¡ç†ç­–ç•¥
memoryManagerPolicy: None        # None / Static
# æ‹“æ‰‘ç®¡ç†ç­–ç•¥
topologyManagerPolicy: none      # none / best-effort / restricted / single-numa-node
```

**å¥åº·æ£€æŸ¥é…ç½®**:

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: liveness-http
spec:
  containers:
  - name: web
    image: nginx:1.25
    ports:
    - containerPort: 80
    # å­˜æ´»æ¢é’ˆ: å¤±è´¥åkubeleté‡å¯å®¹å™¨
    livenessProbe:
      httpGet:
        path: /healthz
        port: 80
        httpHeaders:
        - name: Custom-Header
          value: Awesome
      initialDelaySeconds: 3  # å®¹å™¨å¯åŠ¨å3ç§’å¼€å§‹æ¢æµ‹
      periodSeconds: 3         # æ¯3ç§’æ¢æµ‹ä¸€æ¬¡
      timeoutSeconds: 1        # æ¢æµ‹è¶…æ—¶æ—¶é—´1ç§’
      successThreshold: 1      # è¿ç»­æˆåŠŸ1æ¬¡è§†ä¸ºå¥åº·
      failureThreshold: 3      # è¿ç»­å¤±è´¥3æ¬¡è§†ä¸ºä¸å¥åº· â†’ é‡å¯å®¹å™¨
    # å°±ç»ªæ¢é’ˆ: å¤±è´¥åä»Serviceç§»é™¤Pod
    readinessProbe:
      httpGet:
        path: /ready
        port: 80
      initialDelaySeconds: 5
      periodSeconds: 5
      failureThreshold: 3      # è¿ç»­å¤±è´¥3æ¬¡ â†’ ä»Serviceç§»é™¤
    # å¯åŠ¨æ¢é’ˆ: ç»™æ…¢å¯åŠ¨å®¹å™¨æ›´å¤šæ—¶é—´
    startupProbe:
      httpGet:
        path: /startup
        port: 80
      failureThreshold: 30     # æœ€å¤šå¤±è´¥30æ¬¡
      periodSeconds: 10        # æ¯10ç§’æ¢æµ‹ â†’ æœ€å¤šç­‰å¾…5åˆ†é’Ÿ
      # å¯åŠ¨æ¢é’ˆæˆåŠŸå,æ‰å¼€å§‹æ‰§è¡Œlivenesså’Œreadinessæ¢é’ˆ

---
# TCPæ¢é’ˆç¤ºä¾‹
apiVersion: v1
kind: Pod
metadata:
  name: liveness-tcp
spec:
  containers:
  - name: redis
    image: redis:7.0
    ports:
    - containerPort: 6379
    livenessProbe:
      tcpSocket:
        port: 6379
      initialDelaySeconds: 15
      periodSeconds: 20

---
# Execæ¢é’ˆç¤ºä¾‹
apiVersion: v1
kind: Pod
metadata:
  name: liveness-exec
spec:
  containers:
  - name: app
    image: myapp:1.0
    livenessProbe:
      exec:
        command:
        - cat
        - /tmp/healthy
      initialDelaySeconds: 5
      periodSeconds: 5
```

**kubelet æ•…éšœæ’æŸ¥**:

```bash
# æŸ¥çœ‹kubeletçŠ¶æ€
systemctl status kubelet

# æŸ¥çœ‹kubeletæ—¥å¿—
journalctl -u kubelet -f

# æŸ¥çœ‹kubeletå¯åŠ¨å‚æ•°
ps aux | grep kubelet

# æŸ¥çœ‹èŠ‚ç‚¹èµ„æºä½¿ç”¨æƒ…å†µ
kubectl top node

# æŸ¥çœ‹èŠ‚ç‚¹è¯¦ç»†ä¿¡æ¯
kubectl describe node node-1

# æŸ¥çœ‹èŠ‚ç‚¹åˆ†é…çš„èµ„æº
kubectl describe node node-1 | grep -A 5 "Allocated resources"

# æŸ¥çœ‹kubeleté…ç½®
kubectl get --raw /api/v1/nodes/node-1/proxy/configz | jq .

# æŸ¥çœ‹kubeletæ€§èƒ½æŒ‡æ ‡
curl -s http://localhost:10255/metrics | grep kubelet

# æ‰‹åŠ¨è¿è¡Œkubelet (è°ƒè¯•æ¨¡å¼)
kubelet --v=4 --config=/var/lib/kubelet/config.yaml
```

#### 1.2.3.2 kube-proxy: ç½‘ç»œä»£ç†

**æ ¸å¿ƒèŒè´£**:

kube-proxy åœ¨æ¯ä¸ªèŠ‚ç‚¹ç»´æŠ¤ç½‘ç»œè§„åˆ™,å®ç° Service çš„è´Ÿè½½å‡è¡¡ã€‚

```
Service â†’ kube-proxy â†’ iptables/ipvsè§„åˆ™

ç¤ºä¾‹:
Service: nginx-svc (ClusterIP: 10.96.100.200:80)
Endpoints:
  - Pod1: 10.244.1.5:80
  - Pod2: 10.244.2.8:80
  - Pod3: 10.244.3.12:80

kube-proxy åˆ›å»ºè§„åˆ™:
è®¿é—® 10.96.100.200:80 â†’ éšæœºè½¬å‘åˆ° Pod1/Pod2/Pod3
```

**ä¸‰ç§ä»£ç†æ¨¡å¼å¯¹æ¯”**:

| æ¨¡å¼ | å®ç°æ–¹å¼ | æ€§èƒ½ | å¤æ‚åº¦ | è´Ÿè½½å‡è¡¡ç®—æ³• | é€‚ç”¨åœºæ™¯ |
|------|---------|------|--------|--------------|---------|
| **userspace** | ç”¨æˆ·ç©ºé—´ä»£ç† | ä½ | ä½ | Round-Robin | å·²åºŸå¼ƒ |
| **iptables** | iptablesè§„åˆ™ | ä¸­ | ä¸­ | éšæœº | ä¸­å°è§„æ¨¡é›†ç¾¤ (<1000 Service) |
| **ipvs** | IPVS (LVS) | é«˜ | é«˜ | RR/LC/DHç­‰10+ç®—æ³• | å¤§è§„æ¨¡é›†ç¾¤ (æ¨è) |

**iptables æ¨¡å¼åŸç†**:

```bash
# æŸ¥çœ‹Serviceå¯¹åº”çš„iptablesè§„åˆ™
iptables-save | grep nginx-svc

# ç¤ºä¾‹è¾“å‡º (ç®€åŒ–):
# KUBE-SERVICESé“¾ (å…¥å£)
-A KUBE-SERVICES -d 10.96.100.200/32 -p tcp -m tcp --dport 80 -j KUBE-SVC-NGINX

# KUBE-SVC-NGINXé“¾ (è´Ÿè½½å‡è¡¡)
-A KUBE-SVC-NGINX -m statistic --mode random --probability 0.33333 -j KUBE-SEP-POD1
-A KUBE-SVC-NGINX -m statistic --mode random --probability 0.50000 -j KUBE-SEP-POD2
-A KUBE-SVC-NGINX -j KUBE-SEP-POD3

# KUBE-SEP-PODxé“¾ (DNATåˆ°å…·ä½“Pod)
-A KUBE-SEP-POD1 -p tcp -m tcp -j DNAT --to-destination 10.244.1.5:80
-A KUBE-SEP-POD2 -p tcp -m tcp -j DNAT --to-destination 10.244.2.8:80
-A KUBE-SEP-POD3 -p tcp -m tcp -j DNAT --to-destination 10.244.3.12:80
```

**IPVS æ¨¡å¼é…ç½®** (æ¨èç”¨äºå¤§è§„æ¨¡é›†ç¾¤):

```yaml
# kube-proxy ConfigMap
apiVersion: v1
kind: ConfigMap
metadata:
  name: kube-proxy
  namespace: kube-system
data:
  config.conf: |
    apiVersion: kubeproxy.config.k8s.io/v1alpha1
    kind: KubeProxyConfiguration
    mode: "ipvs"                    # ä½¿ç”¨IPVSæ¨¡å¼
    ipvs:
      scheduler: "rr"                # è°ƒåº¦ç®—æ³•
        # rr: Round-Robin (è½®è¯¢)
        # lc: Least Connection (æœ€å°‘è¿æ¥)
        # dh: Destination Hashing (ç›®æ ‡å“ˆå¸Œ)
        # sh: Source Hashing (æºå“ˆå¸Œ)
        # sed: Shortest Expected Delay (æœ€çŸ­æœŸæœ›å»¶è¿Ÿ)
        # nq: Never Queue (æ°¸ä¸æ’é˜Ÿ)
      minSyncPeriod: 0s
      syncPeriod: 30s
      strictARP: false               # ä¸¥æ ¼ARP (MetalLBéœ€è¦å¼€å¯)
    iptables:
      masqueradeAll: false
      masqueradeBit: 14
      minSyncPeriod: 0s
      syncPeriod: 30s
    clusterCIDR: "10.244.0.0/16"
    conntrack:
      maxPerCore: 32768             # æ¯ä¸ªCPUæ ¸å¿ƒçš„æœ€å¤§è¿æ¥è¿½è¸ªæ•°
      min: 131072
      tcpCloseWaitTimeout: 1h0m0s
      tcpEstablishedTimeout: 24h0m0s
```

```bash
# å®‰è£…IPVSä¾èµ– (æ‰€æœ‰èŠ‚ç‚¹)
yum install -y ipvsadm ipset conntrack

# åŠ è½½å†…æ ¸æ¨¡å—
modprobe ip_vs
modprobe ip_vs_rr
modprobe ip_vs_wrr
modprobe ip_vs_sh
modprobe nf_conntrack

# æ°¸ä¹…åŠ è½½
cat <<EOF > /etc/modules-load.d/ipvs.conf
ip_vs
ip_vs_rr
ip_vs_wrr
ip_vs_sh
nf_conntrack
EOF

# æŸ¥çœ‹IPVSè§„åˆ™
ipvsadm -Ln

# ç¤ºä¾‹è¾“å‡º:
# IP Virtual Server version 1.2.1 (size=4096)
# Prot LocalAddress:Port Scheduler Flags
#   -> RemoteAddress:Port           Forward Weight ActiveConn InActConn
# TCP  10.96.100.200:80 rr
#   -> 10.244.1.5:80                Masq    1      0          0
#   -> 10.244.2.8:80                Masq    1      0          0
#   -> 10.244.3.12:80               Masq    1      0          0

# æŸ¥çœ‹IPVSè¿æ¥
ipvsadm -Ln --stats

# æ¸…ç©ºIPVSè§„åˆ™ (è°¨æ…æ“ä½œ)
ipvsadm -C
```

**kube-proxy æ€§èƒ½å¯¹æ¯”**:

```bash
# æµ‹è¯•åœºæ™¯: 10000ä¸ªService,æ¯ä¸ªService 10ä¸ªEndpoints
# iptablesæ¨¡å¼: è§„åˆ™æ•° = 10000 * 10 * 5 = 500,000æ¡ â†’ æ€§èƒ½ä¸¥é‡ä¸‹é™
# IPVSæ¨¡å¼: ä½¿ç”¨Hashè¡¨,O(1)æŸ¥æ‰¾æ€§èƒ½ â†’ æ€§èƒ½ç¨³å®š

# æ€§èƒ½æµ‹è¯•è„šæœ¬
#!/bin/bash
for i in {1..10000}; do
  echo "Testing Service $i..."
  time curl -s http://service-$i.default.svc.cluster.local > /dev/null
done

# ç»“æœå¯¹æ¯”:
# iptablesæ¨¡å¼: å¹³å‡å“åº”æ—¶é—´ 120ms
# IPVSæ¨¡å¼: å¹³å‡å“åº”æ—¶é—´ 8ms (æå‡15å€)
```

**kube-proxy æ•…éšœæ’æŸ¥**:

```bash
# æŸ¥çœ‹kube-proxyæ—¥å¿—
kubectl logs -n kube-system kube-proxy-xxxxx

# æŸ¥çœ‹kube-proxyé…ç½®
kubectl get configmap -n kube-system kube-proxy -o yaml

# æŸ¥çœ‹kube-proxyä½¿ç”¨çš„æ¨¡å¼
curl -s http://localhost:10249/proxyMode

# éªŒè¯Serviceè§„åˆ™æ˜¯å¦ç”Ÿæ•ˆ
# iptablesæ¨¡å¼:
iptables-save | grep <service-name>

# IPVSæ¨¡å¼:
ipvsadm -Ln | grep <cluster-ip>

# æµ‹è¯•Serviceè¿é€šæ€§
kubectl run -it --rm debug --image=busybox --restart=Never -- wget -O- http://nginx-svc
```

#### 1.2.3.3 Container Runtime: å®¹å™¨è¿è¡Œæ—¶

**CRI (Container Runtime Interface)**:

Kubernetes é€šè¿‡ CRI æ¥å£ä¸å®¹å™¨è¿è¡Œæ—¶äº¤äº’,å®ç°äº†è¿è¡Œæ—¶çš„å¯æ’æ‹”æ€§ã€‚

```
Kubernetes â†’ CRI â†’ Container Runtime â†’ å®¹å™¨

æ”¯æŒçš„è¿è¡Œæ—¶:
â€¢ containerd (æ¨è,CNCFæ¯•ä¸šé¡¹ç›®)
â€¢ CRI-O (ä¸“ä¸ºK8sè®¾è®¡)
â€¢ Docker (é€šè¿‡ cri-dockerd é€‚é…å™¨,å·²å¼ƒç”¨)
```

**containerd æ¶æ„**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  kubelet                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“ gRPC (CRI)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  containerd (CRI Plugin)                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Image Service (é•œåƒç®¡ç†)        â”‚ â”‚
â”‚  â”‚  â€¢ Pull / Push / List / Remove   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Runtime Service (å®¹å™¨ç®¡ç†)      â”‚ â”‚
â”‚  â”‚  â€¢ RunPodSandbox / CreateContainerâ”‚ â”‚
â”‚  â”‚  â€¢ StartContainer / StopContainer â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Snapshotter (å­˜å‚¨é©±åŠ¨)          â”‚ â”‚
â”‚  â”‚  â€¢ overlayfs / btrfs / zfs       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  runc (OCI Runtime)                     â”‚
â”‚  â€¢ Namespaceéš”ç¦» (PID/NET/MNT/IPC/UTS) â”‚
â”‚  â€¢ Cgroupsèµ„æºé™åˆ¶ (CPU/å†…å­˜/IO)       â”‚
â”‚  â€¢ å¯åŠ¨å®¹å™¨è¿›ç¨‹                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**containerd é…ç½®**:

```toml
# /etc/containerd/config.toml
version = 2

[plugins]
  [plugins."io.containerd.grpc.v1.cri"]
    # æ²™ç®±é•œåƒ (Pauseå®¹å™¨)
    sandbox_image = "registry.k8s.io/pause:3.9"

    [plugins."io.containerd.grpc.v1.cri".containerd]
      snapshotter = "overlayfs"
      default_runtime_name = "runc"

      [plugins."io.containerd.grpc.v1.cri".containerd.runtimes]
        [plugins."io.containerd.grpc.v1.cri".containerd.runtimes.runc]
          runtime_type = "io.containerd.runc.v2"
          [plugins."io.containerd.grpc.v1.cri".containerd.runtimes.runc.options]
            SystemdCgroup = true  # ä½¿ç”¨systemdç®¡ç†Cgroup

    [plugins."io.containerd.grpc.v1.cri".cni]
      bin_dir = "/opt/cni/bin"
      conf_dir = "/etc/cni/net.d"

    [plugins."io.containerd.grpc.v1.cri".registry]
      [plugins."io.containerd.grpc.v1.cri".registry.mirrors]
        [plugins."io.containerd.grpc.v1.cri".registry.mirrors."docker.io"]
          endpoint = ["https://registry-1.docker.io"]
        [plugins."io.containerd.grpc.v1.cri".registry.mirrors."registry.k8s.io"]
          endpoint = ["https://registry.k8s.io"]
      [plugins."io.containerd.grpc.v1.cri".registry.configs]
        [plugins."io.containerd.grpc.v1.cri".registry.configs."my-registry.com".auth]
          username = "user"
          password = "pass"
```

**containerd è¿ç»´å‘½ä»¤**:

```bash
# æŸ¥çœ‹containerdç‰ˆæœ¬
containerd --version

# æŸ¥çœ‹è¿è¡Œä¸­çš„å®¹å™¨ (ä½¿ç”¨ctrå‘½ä»¤,éœ€æŒ‡å®šnamespace)
ctr -n k8s.io containers list

# æŸ¥çœ‹é•œåƒ
ctr -n k8s.io images list

# æ‹‰å–é•œåƒ
ctr -n k8s.io images pull docker.io/library/nginx:1.25

# æŸ¥çœ‹å®¹å™¨è¯¦ç»†ä¿¡æ¯
ctr -n k8s.io containers info <container-id>

# åˆ é™¤é•œåƒ
ctr -n k8s.io images remove docker.io/library/nginx:1.25

# ä½¿ç”¨crictlå‘½ä»¤ (æ¨è,å…¼å®¹CRIæ ‡å‡†)
crictl ps       # æŸ¥çœ‹å®¹å™¨
crictl images   # æŸ¥çœ‹é•œåƒ
crictl pods     # æŸ¥çœ‹Pods
crictl logs <container-id>       # æŸ¥çœ‹æ—¥å¿—
crictl exec -it <container-id> sh  # è¿›å…¥å®¹å™¨
crictl stats    # æŸ¥çœ‹å®¹å™¨èµ„æºä½¿ç”¨æƒ…å†µ
crictl inspect <container-id>    # æŸ¥çœ‹å®¹å™¨è¯¦ç»†ä¿¡æ¯
crictl pull nginx:1.25           # æ‹‰å–é•œåƒ
crictl rmi nginx:1.25            # åˆ é™¤é•œåƒ

# é…ç½®crictl (è¿æ¥åˆ°containerd)
cat <<EOF > /etc/crictl.yaml
runtime-endpoint: unix:///run/containerd/containerd.sock
image-endpoint: unix:///run/containerd/containerd.sock
timeout: 10
debug: false
pull-image-on-create: false
EOF
```

**CRI-O ç®€ä»‹** (è½»é‡çº§æ›¿ä»£æ–¹æ¡ˆ):

```bash
# CRI-O æ˜¯ä¸“ä¸ºKubernetesè®¾è®¡çš„è½»é‡çº§è¿è¡Œæ—¶
# ä¼˜ç‚¹:
# - ä»…å®ç°CRIæ¥å£,æ— é¢å¤–åŠŸèƒ½
# - å¯åŠ¨é€Ÿåº¦æ›´å¿«
# - å†…å­˜å ç”¨æ›´å°

# å®‰è£…CRI-O (CentOS/RHEL)
export OS=CentOS_8
export VERSION=1.28

curl -L -o /etc/yum.repos.d/devel:kubic:libcontainers:stable.repo https://download.opensuse.org/repositories/devel:/kubic:/libcontainers:/stable/$OS/devel:kubic:libcontainers:stable.repo
curl -L -o /etc/yum.repos.d/devel:kubic:libcontainers:stable:cri-o:$VERSION.repo https://download.opensuse.org/repositories/devel:kubic:libcontainers:stable:cri-o:$VERSION/$OS/devel:kubic:libcontainers:stable:cri-o:$VERSION.repo

yum install -y cri-o

systemctl enable crio
systemctl start crio

# é…ç½®kubeletä½¿ç”¨CRI-O
cat <<EOF > /var/lib/kubelet/kubeadm-flags.env
KUBELET_KUBEADM_ARGS="--container-runtime=remote --container-runtime-endpoint=unix:///var/run/crio/crio.sock"
EOF

systemctl restart kubelet
```


---

### 1.3 æ ¸å¿ƒèµ„æºå¯¹è±¡æ¨¡å‹

Kubernetes ä¸­ä¸€åˆ‡çš†èµ„æºå¯¹è±¡,éµå¾ªç»Ÿä¸€çš„ API è§„èŒƒã€‚

```yaml
# é€šç”¨èµ„æºå¯¹è±¡æ¨¡æ¿
apiVersion: <group>/<version>  # APIç»„å’Œç‰ˆæœ¬
kind: <Kind>                   # èµ„æºç±»å‹
metadata:                      # å…ƒæ•°æ®
  name: <name>                 # å¯¹è±¡åç§°
  namespace: <namespace>       # å‘½åç©ºé—´
  labels:                      # æ ‡ç­¾(ç”¨äºé€‰æ‹©)
    key1: value1
  annotations:                 # æ³¨è§£(ç”¨äºå­˜å‚¨éæ ‡è¯†ä¿¡æ¯)
    key2: value2
spec:                          # æœŸæœ›çŠ¶æ€ (ç”¨æˆ·å®šä¹‰)
  ...
status:                        # å®é™…çŠ¶æ€ (ç”±ç³»ç»Ÿç»´æŠ¤,åªè¯»)
  ...
```

#### 1.3.1 èµ„æºå¯¹è±¡åˆ†ç±»

**1. å·¥ä½œè´Ÿè½½(Workload)èµ„æº**:

| èµ„æºç±»å‹ | ç”¨é€” | å…¸å‹åœºæ™¯ |
|---------|------|---------|
| **Pod** | æœ€å°è°ƒåº¦å•ä½ | å•å®¹å™¨æˆ–ç´§è€¦åˆå¤šå®¹å™¨ |
| **Deployment** | æ— çŠ¶æ€åº”ç”¨ | WebæœåŠ¡ã€APIæœåŠ¡ |
| **StatefulSet** | æœ‰çŠ¶æ€åº”ç”¨ | æ•°æ®åº“ã€æ¶ˆæ¯é˜Ÿåˆ— |
| **DaemonSet** | æ¯èŠ‚ç‚¹ä¸€ä¸ªPod | æ—¥å¿—é‡‡é›†ã€ç›‘æ§Agent |
| **Job** | ä¸€æ¬¡æ€§ä»»åŠ¡ | æ•°æ®è¿ç§»ã€æ‰¹å¤„ç† |
| **CronJob** | å®šæ—¶ä»»åŠ¡ | å®šæ—¶å¤‡ä»½ã€æŠ¥è¡¨ç”Ÿæˆ |

**2. æœåŠ¡å‘ç°ä¸è´Ÿè½½å‡è¡¡èµ„æº**:

| èµ„æºç±»å‹ | ç”¨é€” |
|---------|------|
| **Service** | ä¸ºPodæä¾›ç¨³å®šè®¿é—®å…¥å£ (ClusterIP/NodePort/LoadBalancer) |
| **Ingress** | HTTP/HTTPSè·¯ç”±è§„åˆ™ (ä¸ƒå±‚è´Ÿè½½å‡è¡¡) |
| **EndpointSlice** | Serviceåç«¯Podåˆ—è¡¨ (æ›¿ä»£Endpoints,æ›´é«˜æ•ˆ) |

**3. é…ç½®ä¸å­˜å‚¨èµ„æº**:

| èµ„æºç±»å‹ | ç”¨é€” |
|---------|------|
| **ConfigMap** | éæ•æ„Ÿé…ç½®æ–‡ä»¶ (ç¯å¢ƒå˜é‡/é…ç½®æ–‡ä»¶) |
| **Secret** | æ•æ„Ÿä¿¡æ¯ (å¯†ç /è¯ä¹¦/Token) |
| **PersistentVolume (PV)** | æŒä¹…åŒ–å­˜å‚¨å· (ç®¡ç†å‘˜åˆ›å»º) |
| **PersistentVolumeClaim (PVC)** | å­˜å‚¨å·ç”³è¯· (ç”¨æˆ·åˆ›å»º) |
| **StorageClass** | åŠ¨æ€å­˜å‚¨é…ç½® (è‡ªåŠ¨åˆ›å»ºPV) |

**4. æƒé™ä¸å®‰å…¨èµ„æº**:

| èµ„æºç±»å‹ | ç”¨é€” |
|---------|------|
| **ServiceAccount** | Podèº«ä»½æ ‡è¯† (ç”¨äºè®¿é—®API Server) |
| **Role / ClusterRole** | æƒé™å®šä¹‰ (RBAC) |
| **RoleBinding / ClusterRoleBinding** | æƒé™ç»‘å®š (å°†è§’è‰²ç»‘å®šåˆ°ç”¨æˆ·/ServiceAccount) |
| **NetworkPolicy** | ç½‘ç»œè®¿é—®æ§åˆ¶ (Podé—´æµé‡è§„åˆ™) |
| **PodSecurityPolicy** | Podå®‰å…¨ç­–ç•¥ (å·²å¼ƒç”¨,ä½¿ç”¨Pod Security Standards) |

#### 1.3.2 èµ„æºå¯¹è±¡å…³ç³»å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Namespace (å‘½åç©ºé—´éš”ç¦»)                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Deployment (ç®¡ç†ReplicaSet)                     â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚  â”‚  ReplicaSet (ç®¡ç†Podå‰¯æœ¬)                  â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  Pod 1   â”‚  â”‚  Pod 2   â”‚  â”‚  Pod 3   â”‚ â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Service (è´Ÿè½½å‡è¡¡)                              â”‚ â”‚
â”‚  â”‚  ClusterIP: 10.96.100.200                        â”‚ â”‚
â”‚  â”‚  Selector: app=nginx â†’ é€‰æ‹©ä¸Šæ–¹3ä¸ªPod            â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  ConfigMap                                       â”‚ â”‚
â”‚  â”‚  (é…ç½®æ–‡ä»¶) â†’ æŒ‚è½½åˆ°Pod                          â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Secret                                          â”‚ â”‚
â”‚  â”‚  (å¯†ç ) â†’ æ³¨å…¥åˆ°Podç¯å¢ƒå˜é‡                      â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  PersistentVolumeClaim                           â”‚ â”‚
â”‚  â”‚  (å­˜å‚¨ç”³è¯·) â†’ ç»‘å®šåˆ°PV â†’ æŒ‚è½½åˆ°Pod               â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 1.3.3 æ ‡ç­¾(Labels)ä¸é€‰æ‹©å™¨(Selectors)

**æ ‡ç­¾**æ˜¯ Kubernetes çš„æ ¸å¿ƒç»„ç»‡æœºåˆ¶,ç”¨äºå¯¹èµ„æºå¯¹è±¡è¿›è¡Œåˆ†ç»„å’Œé€‰æ‹©ã€‚

```yaml
# ä¸ºèµ„æºæ·»åŠ æ ‡ç­¾
apiVersion: v1
kind: Pod
metadata:
  name: nginx-prod
  labels:
    app: nginx           # åº”ç”¨åç§°
    environment: production  # ç¯å¢ƒ
    tier: frontend       # å±‚çº§
    version: "1.25"      # ç‰ˆæœ¬
spec:
  containers:
  - name: nginx
    image: nginx:1.25

---
# ç›¸ç­‰æ€§é€‰æ‹©å™¨ (Equality-based Selector)
apiVersion: v1
kind: Service
metadata:
  name: nginx-svc
spec:
  selector:
    app: nginx                # app=nginx
    environment: production   # environment=production
  ports:
  - port: 80

---
# é›†åˆé€‰æ‹©å™¨ (Set-based Selector)
apiVersion: apps/v1
kind: Deployment
metadata:
  name: web
spec:
  selector:
    matchLabels:
      app: web
    matchExpressions:
    - key: environment
      operator: In           # In / NotIn / Exists / DoesNotExist
      values:
      - production
      - staging
    - key: tier
      operator: NotIn
      values:
      - database
  template:
    metadata:
      labels:
        app: web
        environment: production
        tier: frontend
    spec:
      containers:
      - name: web
        image: nginx:1.25
```

**æ ‡ç­¾ç®¡ç†å‘½ä»¤**:

```bash
# æŸ¥çœ‹èµ„æºæ ‡ç­¾
kubectl get pods --show-labels

# æ ¹æ®æ ‡ç­¾ç­›é€‰
kubectl get pods -l app=nginx
kubectl get pods -l 'environment in (production,staging)'
kubectl get pods -l app=nginx,tier=frontend

# æ·»åŠ æ ‡ç­¾
kubectl label pods nginx-prod release=stable

# ä¿®æ”¹æ ‡ç­¾
kubectl label pods nginx-prod version=1.26 --overwrite

# åˆ é™¤æ ‡ç­¾ (åœ¨keyååŠ -)
kubectl label pods nginx-prod version-

# ä¸ºæ‰€æœ‰åŒ¹é…çš„Podæ·»åŠ æ ‡ç­¾
kubectl label pods --all environment=production
```

**æ¨èæ ‡ç­¾**:

Kubernetes æ¨èä½¿ç”¨ä»¥ä¸‹æ ‡ç­¾æ¥ç»„ç»‡èµ„æº:

```yaml
metadata:
  labels:
    app.kubernetes.io/name: mysql              # åº”ç”¨åç§°
    app.kubernetes.io/instance: mysql-abcxzy   # å®ä¾‹åç§°
    app.kubernetes.io/version: "5.7.21"        # åº”ç”¨ç‰ˆæœ¬
    app.kubernetes.io/component: database      # ç»„ä»¶è§’è‰²
    app.kubernetes.io/part-of: wordpress       # æ‰€å±åº”ç”¨
    app.kubernetes.io/managed-by: helm         # ç®¡ç†å·¥å…·
```


---

### 1.4 kubectl å‘½ä»¤è¡Œå·¥å…·

kubectl æ˜¯ Kubernetes çš„å®˜æ–¹ CLI å·¥å…·,é€šè¿‡ REST API ä¸é›†ç¾¤äº¤äº’ã€‚

#### 1.4.1 kubectl é…ç½®

**kubeconfig æ–‡ä»¶ç»“æ„**:

```yaml
# ~/.kube/config
apiVersion: v1
kind: Config
# é›†ç¾¤åˆ—è¡¨
clusters:
- cluster:
    certificate-authority-data: <CAè¯ä¹¦>
    server: https://k8s-api.example.com:6443
  name: production
- cluster:
    server: https://k8s-test.example.com:6443
    insecure-skip-tls-verify: true  # è·³è¿‡TLSéªŒè¯ (ä»…æµ‹è¯•ç¯å¢ƒ)
  name: testing
# ç”¨æˆ·åˆ—è¡¨
users:
- name: admin
  user:
    client-certificate-data: <å®¢æˆ·ç«¯è¯ä¹¦>
    client-key-data: <å®¢æˆ·ç«¯ç§é’¥>
- name: developer
  user:
    token: <Bearer Token>
# ä¸Šä¸‹æ–‡åˆ—è¡¨ (é›†ç¾¤+ç”¨æˆ·+å‘½åç©ºé—´)
contexts:
- context:
    cluster: production
    user: admin
    namespace: default
  name: prod-admin
- context:
    cluster: testing
    user: developer
    namespace: dev
  name: test-dev
# å½“å‰ä¸Šä¸‹æ–‡
current-context: prod-admin
```

**åˆ‡æ¢ä¸Šä¸‹æ–‡**:

```bash
# æŸ¥çœ‹æ‰€æœ‰ä¸Šä¸‹æ–‡
kubectl config get-contexts

# åˆ‡æ¢ä¸Šä¸‹æ–‡
kubectl config use-context test-dev

# æŸ¥çœ‹å½“å‰ä¸Šä¸‹æ–‡
kubectl config current-context

# è®¾ç½®é»˜è®¤å‘½åç©ºé—´
kubectl config set-context --current --namespace=kube-system

# æŸ¥çœ‹å½“å‰é…ç½®
kubectl config view

# åˆå¹¶å¤šä¸ªkubeconfigæ–‡ä»¶
export KUBECONFIG=~/.kube/config:~/.kube/config-test
kubectl config view --flatten > ~/.kube/config-merged
```

#### 1.4.2 å¸¸ç”¨å‘½ä»¤é€ŸæŸ¥

**èµ„æºç®¡ç†**:

```bash
# åˆ›å»ºèµ„æº
kubectl create -f deployment.yaml
kubectl apply -f deployment.yaml  # æ¨è(æ”¯æŒå¢é‡æ›´æ–°)

# æŸ¥çœ‹èµ„æº
kubectl get pods                   # æŸ¥çœ‹Pod
kubectl get pods -o wide          # æ˜¾ç¤ºæ›´å¤šä¿¡æ¯(èŠ‚ç‚¹/IP)
kubectl get pods -o yaml          # YAMLæ ¼å¼è¾“å‡º
kubectl get pods -o json | jq .   # JSONæ ¼å¼ + jqå¤„ç†
kubectl get all                    # æŸ¥çœ‹æ‰€æœ‰èµ„æº
kubectl get all -A                 # æ‰€æœ‰å‘½åç©ºé—´

# æŸ¥çœ‹èµ„æºè¯¦æƒ…
kubectl describe pod nginx-7c5ddbdf54-8xk9p

# åˆ é™¤èµ„æº
kubectl delete pod nginx-7c5ddbdf54-8xk9p
kubectl delete -f deployment.yaml
kubectl delete pods --all          # åˆ é™¤æ‰€æœ‰Pod
kubectl delete pods -l app=nginx   # æ ¹æ®æ ‡ç­¾åˆ é™¤

# ç¼–è¾‘èµ„æº
kubectl edit deployment nginx      # ä½¿ç”¨$EDITORç¼–è¾‘

# æ‰©ç¼©å®¹
kubectl scale deployment nginx --replicas=5

# è‡ªåŠ¨æ‰©ç¼©å®¹
kubectl autoscale deployment nginx --min=2 --max=10 --cpu-percent=70
```

**æ—¥å¿—ä¸è°ƒè¯•**:

```bash
# æŸ¥çœ‹æ—¥å¿—
kubectl logs nginx-7c5ddbdf54-8xk9p
kubectl logs nginx-7c5ddbdf54-8xk9p -c nginx  # å¤šå®¹å™¨PodæŒ‡å®šå®¹å™¨
kubectl logs -f nginx-7c5ddbdf54-8xk9p        # å®æ—¶æ—¥å¿—
kubectl logs --tail=100 nginx-7c5ddbdf54-8xk9p  # æœ€å100è¡Œ
kubectl logs --since=1h nginx-7c5ddbdf54-8xk9p  # æœ€è¿‘1å°æ—¶
kubectl logs --previous nginx-7c5ddbdf54-8xk9p  # ä¸Šä¸€ä¸ªé€€å‡ºå®¹å™¨çš„æ—¥å¿—

# è¿›å…¥å®¹å™¨
kubectl exec -it nginx-7c5ddbdf54-8xk9p -- bash
kubectl exec -it nginx-7c5ddbdf54-8xk9p -c nginx -- sh

# ç«¯å£è½¬å‘ (æœ¬åœ°è°ƒè¯•)
kubectl port-forward pod/nginx-7c5ddbdf54-8xk9p 8080:80
kubectl port-forward service/nginx 8080:80
# è®¿é—® http://localhost:8080

# å¤åˆ¶æ–‡ä»¶
kubectl cp /tmp/foo nginx-7c5ddbdf54-8xk9p:/tmp/bar  # æœ¬åœ°â†’Pod
kubectl cp nginx-7c5ddbdf54-8xk9p:/tmp/bar /tmp/foo  # Podâ†’æœ¬åœ°

# æŸ¥çœ‹äº‹ä»¶
kubectl get events --sort-by='.metadata.creationTimestamp'
kubectl get events --field-selector involvedObject.name=nginx

# æŸ¥çœ‹èµ„æºä½¿ç”¨æƒ…å†µ
kubectl top nodes
kubectl top pods
kubectl top pods -A --sort-by=memory
```

**é«˜çº§å‘½ä»¤**:

```bash
# æ»šåŠ¨æ›´æ–°
kubectl set image deployment/nginx nginx=nginx:1.26
kubectl rollout status deployment/nginx
kubectl rollout history deployment/nginx
kubectl rollout undo deployment/nginx  # å›æ»š

# Patchæ›´æ–° (éƒ¨åˆ†å­—æ®µ)
kubectl patch deployment nginx -p '{"spec":{"replicas":3}}'
kubectl patch deployment nginx --type=json -p='[{"op": "replace", "path": "/spec/replicas", "value": 5}]'

# æ ‡ç­¾æ“ä½œ
kubectl label pods nginx-7c5ddbdf54-8xk9p env=production
kubectl label pods nginx-7c5ddbdf54-8xk9p env-  # åˆ é™¤æ ‡ç­¾

# æ±¡ç‚¹æ“ä½œ
kubectl taint nodes node-1 gpu=true:NoSchedule
kubectl taint nodes node-1 gpu=true:NoSchedule-  # åˆ é™¤æ±¡ç‚¹

# èŠ‚ç‚¹ç»´æŠ¤
kubectl cordon node-1     # æ ‡è®°ä¸å¯è°ƒåº¦ (ä¸å½±å“ç°æœ‰Pod)
kubectl drain node-1      # é©±é€Podå¹¶æ ‡è®°ä¸å¯è°ƒåº¦
kubectl drain node-1 --ignore-daemonsets --delete-emptydir-data  # å¼ºåˆ¶é©±é€
kubectl uncordon node-1   # æ¢å¤è°ƒåº¦

# èµ„æºé…é¢
kubectl create quota my-quota --hard=cpu=1,memory=1Gi,pods=2

# æœåŠ¡æš´éœ²
kubectl expose deployment nginx --port=80 --type=LoadBalancer

# è¿è¡Œä¸´æ—¶Pod
kubectl run -it --rm debug --image=busybox --restart=Never -- sh
kubectl run nginx --image=nginx:1.25 --dry-run=client -o yaml > nginx-pod.yaml

# æŸ¥çœ‹APIèµ„æº
kubectl api-resources
kubectl api-versions
kubectl explain pod
kubectl explain pod.spec.containers
```

#### 1.4.3 kubectl æ’ä»¶ä¸å·¥å…·

**krew (kubectl æ’ä»¶ç®¡ç†å™¨)**:

```bash
# å®‰è£…krew
(
  set -x; cd "$(mktemp -d)" &&
  curl -fsSLO "https://github.com/kubernetes-sigs/krew/releases/latest/download/krew-linux_amd64.tar.gz" &&
  tar zxvf krew-linux_amd64.tar.gz &&
  ./krew-linux_amd64 install krew
)

# æ·»åŠ åˆ°PATH
export PATH="${KREW_ROOT:-$HOME/.krew}/bin:$PATH"

# å®‰è£…å¸¸ç”¨æ’ä»¶
kubectl krew install ctx        # kubectx - å¿«é€Ÿåˆ‡æ¢ä¸Šä¸‹æ–‡
kubectl krew install ns         # kubens - å¿«é€Ÿåˆ‡æ¢å‘½åç©ºé—´
kubectl krew install tree       # kubectl-tree - èµ„æºæ ‘å½¢è§†å›¾
kubectl krew install whoami     # kubectl-whoami - æŸ¥çœ‹å½“å‰ç”¨æˆ·
kubectl krew install view-secret  # æŸ¥çœ‹Secretå†…å®¹
kubectl krew install get-all    # è·å–æ‰€æœ‰èµ„æº (åŒ…æ‹¬CRD)

# ä½¿ç”¨æ’ä»¶
kubectl ctx                     # åˆ—å‡ºå¹¶åˆ‡æ¢ä¸Šä¸‹æ–‡
kubectl ns kube-system          # åˆ‡æ¢åˆ°kube-systemå‘½åç©ºé—´
kubectl tree deployment nginx   # æŸ¥çœ‹Deploymentèµ„æºæ ‘
kubectl view-secret my-secret   # æŸ¥çœ‹Secretè§£ç åçš„å†…å®¹
```

**k9s (ç»ˆç«¯UIå·¥å…·)**:

```bash
# å®‰è£…k9s
wget https://github.com/derailed/k9s/releases/download/v0.27.0/k9s_Linux_amd64.tar.gz
tar -xzf k9s_Linux_amd64.tar.gz
sudo mv k9s /usr/local/bin/

# è¿è¡Œk9s
k9s

# å¿«æ·é”®:
# :pods      â†’ æŸ¥çœ‹Pods
# :deploy    â†’ æŸ¥çœ‹Deployments
# :svc       â†’ æŸ¥çœ‹Services
# :ns        â†’ æŸ¥çœ‹Namespaces
# l          â†’ æŸ¥çœ‹æ—¥å¿—
# d          â†’ æè¿°èµ„æº
# e          â†’ ç¼–è¾‘èµ„æº
# Ctrl+d     â†’ åˆ é™¤èµ„æº
# /          â†’ æœç´¢
# Esc        â†’ è¿”å›
```

**å…¶ä»–å®ç”¨å·¥å…·**:

```bash
# stern - å¤šPodæ—¥å¿—èšåˆ
stern nginx --tail=10            # æŸ¥çœ‹æ‰€æœ‰nginxå¼€å¤´Podçš„æ—¥å¿—
stern --namespace kube-system .  # æŸ¥çœ‹æ•´ä¸ªå‘½åç©ºé—´çš„æ—¥å¿—

# kubectx / kubens - å¿«é€Ÿåˆ‡æ¢
kubectx production               # åˆ‡æ¢é›†ç¾¤ä¸Šä¸‹æ–‡
kubens kube-system               # åˆ‡æ¢å‘½åç©ºé—´

# kubectl-df-pv - æŸ¥çœ‹PVä½¿ç”¨æƒ…å†µ
kubectl df-pv

# kubectl-images - æŸ¥çœ‹é›†ç¾¤ä¸­æ‰€æœ‰é•œåƒ
kubectl images

# kubectl-neat - æ¸…ç†kubectlè¾“å‡º
kubectl get pod nginx -o yaml | kubectl neat
```


---

### 1.5 å®æˆ˜é¡¹ç›®: æ­å»º 3 èŠ‚ç‚¹ Kubernetes é›†ç¾¤

#### 1.5.1 é›†ç¾¤è§„åˆ’

**èŠ‚ç‚¹é…ç½®**:

| èŠ‚ç‚¹ | IP | è§’è‰² | é…ç½® | OS |
|------|-----|------|------|----|
| k8s-master | 192.168.1.10 | Control Plane | 2vCPU / 4GB RAM / 50GB SSD | CentOS 8 / Ubuntu 22.04 |
| k8s-worker1 | 192.168.1.11 | Worker Node | 2vCPU / 4GB RAM / 50GB SSD | CentOS 8 / Ubuntu 22.04 |
| k8s-worker2 | 192.168.1.12 | Worker Node | 2vCPU / 4GB RAM / 50GB SSD | CentOS 8 / Ubuntu 22.04 |

**è½¯ä»¶ç‰ˆæœ¬**:
- Kubernetes: 1.28.0
- containerd: 1.7.0
- CNI Plugin: Calico 3.26

**ç½‘ç»œè§„åˆ’**:
- Pod Network CIDR: `10.244.0.0/16`
- Service Network CIDR: `10.96.0.0/12`
- Cluster DNS: `10.96.0.10`

#### 1.5.2 æ‰€æœ‰èŠ‚ç‚¹é€šç”¨é…ç½®

**åœ¨æ‰€æœ‰èŠ‚ç‚¹(master + worker1 + worker2)æ‰§è¡Œä»¥ä¸‹æ­¥éª¤**:

```bash
# ========== 1. ç³»ç»Ÿé…ç½® ==========
#!/bin/bash
set -e

# å…³é—­é˜²ç«å¢™
systemctl stop firewalld
systemctl disable firewalld

# å…³é—­SELinux
setenforce 0
sed -i 's/^SELINUX=enforcing$/SELINUX=disabled/' /etc/selinux/config

# å…³é—­Swap
swapoff -a
sed -i '/ swap / s/^\(.*\)$/#\1/g' /etc/fstab

# é…ç½®ä¸»æœºå (æ¯ä¸ªèŠ‚ç‚¹æ‰§è¡Œä¸åŒçš„å‘½ä»¤)
hostnamectl set-hostname k8s-master   # åœ¨masterèŠ‚ç‚¹æ‰§è¡Œ
hostnamectl set-hostname k8s-worker1  # åœ¨worker1èŠ‚ç‚¹æ‰§è¡Œ
hostnamectl set-hostname k8s-worker2  # åœ¨worker2èŠ‚ç‚¹æ‰§è¡Œ

# é…ç½®hostsæ–‡ä»¶ (æ‰€æœ‰èŠ‚ç‚¹)
cat <<EOF >> /etc/hosts
192.168.1.10 k8s-master
192.168.1.11 k8s-worker1
192.168.1.12 k8s-worker2
EOF

# æµ‹è¯•äº’é€š
ping -c 3 k8s-master
ping -c 3 k8s-worker1
ping -c 3 k8s-worker2

# ========== 2. å†…æ ¸å‚æ•°ä¼˜åŒ– ==========

# åŠ è½½å†…æ ¸æ¨¡å—
cat <<EOF > /etc/modules-load.d/k8s.conf
overlay
br_netfilter
EOF

modprobe overlay
modprobe br_netfilter

# é…ç½®å†…æ ¸å‚æ•°
cat <<EOF > /etc/sysctl.d/k8s.conf
# ç½‘æ¡¥é…ç½®
net.bridge.bridge-nf-call-iptables  = 1
net.bridge.bridge-nf-call-ip6tables = 1
# IPè½¬å‘
net.ipv4.ip_forward                 = 1
net.ipv4.conf.all.forwarding        = 1
net.ipv6.conf.all.forwarding        = 1
# Swapé…ç½®
vm.swappiness                       = 0
# è¿æ¥è¿½è¸ª
net.netfilter.nf_conntrack_max      = 1000000
net.ipv4.neigh.default.gc_thresh1   = 1024
net.ipv4.neigh.default.gc_thresh2   = 4096
net.ipv4.neigh.default.gc_thresh3   = 8192
# æ–‡ä»¶æè¿°ç¬¦
fs.file-max                         = 1000000
fs.inotify.max_user_instances       = 8192
fs.inotify.max_user_watches         = 524288
EOF

sysctl --system

# ========== 3. å®‰è£… containerd ==========

# CentOS/RHEL
yum install -y yum-utils device-mapper-persistent-data lvm2
yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo
yum install -y containerd.io

# Ubuntu/Debian (å¯é€‰)
# apt-get update
# apt-get install -y containerd.io

# ç”Ÿæˆé»˜è®¤é…ç½®
mkdir -p /etc/containerd
containerd config default > /etc/containerd/config.toml

# ä¿®æ”¹é…ç½®ä½¿ç”¨systemd cgroup
sed -i 's/SystemdCgroup = false/SystemdCgroup = true/' /etc/containerd/config.toml

# ä¿®æ”¹æ²™ç®±é•œåƒ (ä½¿ç”¨é˜¿é‡Œäº‘é•œåƒ,å›½å†…ç½‘ç»œæ›´å¿«)
sed -i 's|sandbox_image = "registry.k8s.io/pause:3.8"|sandbox_image = "registry.aliyuncs.com/google_containers/pause:3.9"|' /etc/containerd/config.toml

# å¯åŠ¨containerd
systemctl enable containerd
systemctl start containerd
systemctl status containerd

# éªŒè¯containerd
ctr version

# ========== 4. å®‰è£… kubeadm/kubelet/kubectl ==========

# CentOS/RHEL (ä½¿ç”¨é˜¿é‡Œäº‘é•œåƒ)
cat <<EOF > /etc/yum.repos.d/kubernetes.repo
[kubernetes]
name=Kubernetes
baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/
enabled=1
gpgcheck=1
repo_gpgcheck=1
gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg
EOF

yum install -y kubelet-1.28.0 kubeadm-1.28.0 kubectl-1.28.0
systemctl enable kubelet

# Ubuntu/Debian (å¯é€‰)
# apt-get update && apt-get install -y apt-transport-https curl
# curl -s https://mirrors.aliyun.com/kubernetes/apt/doc/apt-key.gpg | apt-key add -
# cat <<EOF >/etc/apt/sources.list.d/kubernetes.list
# deb https://mirrors.aliyun.com/kubernetes/apt/ kubernetes-xenial main
# EOF
# apt-get update
# apt-get install -y kubelet=1.28.0-00 kubeadm=1.28.0-00 kubectl=1.28.0-00
# systemctl enable kubelet

# ========== 5. é…ç½® crictl ==========

cat <<EOF > /etc/crictl.yaml
runtime-endpoint: unix:///run/containerd/containerd.sock
image-endpoint: unix:///run/containerd/containerd.sock
timeout: 10
debug: false
pull-image-on-create: false
EOF

# éªŒè¯crictl
crictl version

echo "âœ… èŠ‚ç‚¹åŸºç¡€é…ç½®å®Œæˆ!"
echo "è¯·ç»§ç»­åœ¨masterèŠ‚ç‚¹æ‰§è¡Œåˆå§‹åŒ–æ“ä½œ"
```

#### 1.5.3 åˆå§‹åŒ– Master èŠ‚ç‚¹

**ä»…åœ¨ k8s-master èŠ‚ç‚¹æ‰§è¡Œ**:

```bash
# ========== 1. ç”Ÿæˆåˆå§‹åŒ–é…ç½® ==========

cat <<EOF > kubeadm-init.yaml
apiVersion: kubeadm.k8s.io/v1beta3
kind: InitConfiguration
localAPIEndpoint:
  advertiseAddress: 192.168.1.10  # MasterèŠ‚ç‚¹IP
  bindPort: 6443
nodeRegistration:
  criSocket: unix:///run/containerd/containerd.sock
  imagePullPolicy: IfNotPresent
  kubeletExtraArgs:
    cgroup-driver: systemd
---
apiVersion: kubeadm.k8s.io/v1beta3
kind: ClusterConfiguration
kubernetesVersion: v1.28.0
controlPlaneEndpoint: "192.168.1.10:6443"  # HAé›†ç¾¤å¯ä½¿ç”¨LBåœ°å€
networking:
  serviceSubnet: "10.96.0.0/12"
  podSubnet: "10.244.0.0/16"      # Calicoé»˜è®¤Podç½‘ç»œ
  dnsDomain: "cluster.local"
imageRepository: registry.aliyuncs.com/google_containers  # ä½¿ç”¨é˜¿é‡Œäº‘é•œåƒ
---
apiVersion: kubelet.config.k8s.io/v1beta1
kind: KubeletConfiguration
cgroupDriver: systemd
EOF

# ========== 2. æ‹‰å–é•œåƒ (å¯é€‰,æå‰æ‹‰å–åŠ å¿«åˆå§‹åŒ–é€Ÿåº¦) ==========

kubeadm config images pull --config=kubeadm-init.yaml

# ========== 3. æ‰§è¡Œåˆå§‹åŒ– ==========

kubeadm init --config=kubeadm-init.yaml

# åˆå§‹åŒ–æˆåŠŸåä¼šè¾“å‡ºç±»ä¼¼ä¿¡æ¯:
#
# Your Kubernetes control-plane has initialized successfully!
#
# To start using your cluster, you need to run the following as a regular user:
#
#   mkdir -p $HOME/.kube
#   sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
#   sudo chown $(id -u):$(id -g) $HOME/.kube/config
#
# Then you can join any number of worker nodes by running the following on each as root:
#
# kubeadm join 192.168.1.10:6443 --token abcdef.0123456789abcdef \
#         --discovery-token-ca-cert-hash sha256:xxxxxx

# ========== 4. é…ç½® kubectl ==========

mkdir -p $HOME/.kube
cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
chown $(id -u):$(id -g) $HOME/.kube/config

# é…ç½®å‘½ä»¤è¡¥å…¨ (å¯é€‰)
kubectl completion bash > /etc/bash_completion.d/kubectl
source /etc/bash_completion.d/kubectl

# ========== 5. éªŒè¯é›†ç¾¤çŠ¶æ€ ==========

kubectl get nodes
# NAME          STATUS     ROLES           AGE   VERSION
# k8s-master    NotReady   control-plane   1m    v1.28.0
# (NotReadyå› ä¸ºè¿˜æ²¡å®‰è£…CNIç½‘ç»œæ’ä»¶)

kubectl get pods -n kube-system
# åº”è¯¥çœ‹åˆ°kube-apiserver, kube-controller-manager, kube-scheduler, etcd, kube-proxy ç­‰Pod

# ========== 6. å®‰è£… Calico ç½‘ç»œæ’ä»¶ ==========

# ä¸‹è½½Calicoé…ç½®
wget https://raw.githubusercontent.com/projectcalico/calico/v3.26.0/manifests/calico.yaml

# ä¿®æ”¹Podç½‘ç»œCIDR (å¦‚æœä¸æ˜¯é»˜è®¤çš„10.244.0.0/16)
# sed -i 's|# - name: CALICO_IPV4POOL_CIDR|- name: CALICO_IPV4POOL_CIDR|' calico.yaml
# sed -i 's|#   value: "192.168.0.0/16"|  value: "10.244.0.0/16"|' calico.yaml

# åº”ç”¨Calico
kubectl apply -f calico.yaml

# ç­‰å¾…æ‰€æœ‰Podè¿è¡Œ (çº¦2-3åˆ†é’Ÿ)
kubectl get pods -n kube-system -w

# å†æ¬¡éªŒè¯èŠ‚ç‚¹çŠ¶æ€
kubectl get nodes
# NAME          STATUS   ROLES           AGE   VERSION
# k8s-master    Ready    control-plane   5m    v1.28.0  â† çŠ¶æ€å˜ä¸ºReady

# ========== 7. ä¿å­˜ join å‘½ä»¤ (ä¾›WorkerèŠ‚ç‚¹ä½¿ç”¨) ==========

# å¦‚æœå¿˜è®°joinå‘½ä»¤,å¯ä»¥é‡æ–°ç”Ÿæˆ
kubeadm token create --print-join-command

echo "âœ… MasterèŠ‚ç‚¹åˆå§‹åŒ–å®Œæˆ!"
echo "è¯·å¤åˆ¶ä¸Šé¢çš„ 'kubeadm join' å‘½ä»¤,åœ¨workerèŠ‚ç‚¹æ‰§è¡Œ"
```

#### 1.5.4 åŠ å…¥ Worker èŠ‚ç‚¹

**åœ¨ k8s-worker1 å’Œ k8s-worker2 èŠ‚ç‚¹æ‰§è¡Œ**:

```bash
# ========== 1. æ‰§è¡Œ join å‘½ä»¤ (ä»masteråˆå§‹åŒ–è¾“å‡ºå¤åˆ¶) ==========

kubeadm join 192.168.1.10:6443 --token abcdef.0123456789abcdef \
        --discovery-token-ca-cert-hash sha256:xxxxxx

# å¦‚æœå¿˜è®°token,åœ¨masterèŠ‚ç‚¹é‡æ–°ç”Ÿæˆ:
# kubeadm token create --print-join-command

# åŠ å…¥æˆåŠŸåä¼šæ˜¾ç¤º:
# This node has joined the cluster:
# * Certificate signing request was sent to apiserver and a response was received.
# * The Kubelet was informed of the new secure connection details.

# ========== 2. åœ¨ Master èŠ‚ç‚¹éªŒè¯ ==========

# åœ¨masterèŠ‚ç‚¹æ‰§è¡Œ:
kubectl get nodes
# NAME          STATUS   ROLES           AGE   VERSION
# k8s-master    Ready    control-plane   10m   v1.28.0
# k8s-worker1   Ready    <none>          2m    v1.28.0
# k8s-worker2   Ready    <none>          1m    v1.28.0

kubectl get nodes -o wide
# æŸ¥çœ‹èŠ‚ç‚¹è¯¦ç»†ä¿¡æ¯ (IP/OS/å†…æ ¸/å®¹å™¨è¿è¡Œæ—¶ç‰ˆæœ¬)

kubectl get pods -A
# æŸ¥çœ‹æ‰€æœ‰å‘½åç©ºé—´çš„Pod,åº”è¯¥çœ‹åˆ°Calico Podåœ¨workerèŠ‚ç‚¹ä¸Šè¿è¡Œ

echo "âœ… WorkerèŠ‚ç‚¹åŠ å…¥æˆåŠŸ!"
```

#### 1.5.5 éƒ¨ç½²æµ‹è¯•åº”ç”¨

**åœ¨ master èŠ‚ç‚¹æ‰§è¡Œ**:

```bash
# ========== 1. åˆ›å»º Nginx Deployment ==========

kubectl create deployment nginx --image=nginx:1.25 --replicas=3

# æŸ¥çœ‹Deployment
kubectl get deployment nginx

# æŸ¥çœ‹Podåˆ†å¸ƒ
kubectl get pods -o wide
# NAME                     READY   STATUS    RESTARTS   AGE   IP            NODE
# nginx-7c5ddbdf54-8xk9p   1/1     Running   0          1m    10.244.1.5    k8s-worker1
# nginx-7c5ddbdf54-9hjkl   1/1     Running   0          1m    10.244.2.8    k8s-worker2
# nginx-7c5ddbdf54-7mnop   1/1     Running   0          1m    10.244.1.6    k8s-worker1

# ========== 2. æš´éœ² Service ==========

kubectl expose deployment nginx --port=80 --type=NodePort

# æŸ¥çœ‹Service
kubectl get svc nginx
# NAME    TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)        AGE
# nginx   NodePort   10.96.100.200   <none>        80:30080/TCP   1m

# ========== 3. è®¿é—®æµ‹è¯• ==========

# é€šè¿‡ä»»æ„èŠ‚ç‚¹IP+NodePortè®¿é—®
curl http://192.168.1.11:30080  # worker1
curl http://192.168.1.12:30080  # worker2
curl http://192.168.1.10:30080  # master

# é€šè¿‡ClusterIPè®¿é—® (ä»…é›†ç¾¤å†…éƒ¨)
kubectl run -it --rm busybox --image=busybox --restart=Never -- wget -O- http://10.96.100.200

# ========== 4. æµ‹è¯•è‡ªæ„ˆèƒ½åŠ› ==========

# åˆ é™¤ä¸€ä¸ªPod
POD_NAME=$(kubectl get pods -l app=nginx -o jsonpath='{.items[0].metadata.name}')
kubectl delete pod $POD_NAME

# Podç«‹å³è¢«ReplicaSeté‡æ–°åˆ›å»º
kubectl get pods -w

# ========== 5. æµ‹è¯•æ‰©ç¼©å®¹ ==========

# æ‰©å®¹åˆ°5ä¸ªå‰¯æœ¬
kubectl scale deployment nginx --replicas=5
kubectl get pods

# ç¼©å®¹åˆ°2ä¸ªå‰¯æœ¬
kubectl scale deployment nginx --replicas=2
kubectl get pods

# ========== 6. æµ‹è¯•æ»šåŠ¨æ›´æ–° ==========

# æ›´æ–°é•œåƒ
kubectl set image deployment/nginx nginx=nginx:1.26

# æŸ¥çœ‹æ»šåŠ¨æ›´æ–°è¿‡ç¨‹
kubectl rollout status deployment/nginx

# æŸ¥çœ‹æ›´æ–°å†å²
kubectl rollout history deployment/nginx

# å›æ»šåˆ°ä¸Šä¸€ç‰ˆæœ¬
kubectl rollout undo deployment/nginx

# ========== 7. æ¸…ç†èµ„æº ==========

kubectl delete deployment nginx
kubectl delete svc nginx

echo "âœ… æµ‹è¯•åº”ç”¨éƒ¨ç½²æˆåŠŸ!"
```

#### 1.5.6 é›†ç¾¤ç»´æŠ¤

**å¸¸ç”¨ç»´æŠ¤å‘½ä»¤**:

```bash
# ========== èŠ‚ç‚¹ç®¡ç† ==========

# æŸ¥çœ‹èŠ‚ç‚¹è¯¦ç»†ä¿¡æ¯
kubectl describe node k8s-worker1

# æ ‡è®°èŠ‚ç‚¹ä¸å¯è°ƒåº¦ (ç»´æŠ¤æ—¶ä½¿ç”¨)
kubectl cordon k8s-worker1

# é©±é€èŠ‚ç‚¹ä¸Šçš„Podå¹¶æ ‡è®°ä¸å¯è°ƒåº¦
kubectl drain k8s-worker1 --ignore-daemonsets --delete-emptydir-data

# æ¢å¤èŠ‚ç‚¹è°ƒåº¦
kubectl uncordon k8s-worker1

# ========== é›†ç¾¤å‡çº§ (ä»¥1.28.0â†’1.28.1ä¸ºä¾‹) ==========

# 1. å‡çº§masterèŠ‚ç‚¹
yum install -y kubeadm-1.28.1
kubeadm upgrade plan
kubeadm upgrade apply v1.28.1
yum install -y kubelet-1.28.1 kubectl-1.28.1
systemctl restart kubelet

# 2. å‡çº§workerèŠ‚ç‚¹ (é€ä¸ªå‡çº§)
kubectl drain k8s-worker1 --ignore-daemonsets
yum install -y kubeadm-1.28.1
kubeadm upgrade node
yum install -y kubelet-1.28.1
systemctl restart kubelet
kubectl uncordon k8s-worker1

# ========== é›†ç¾¤å¤‡ä»½ ==========

# å¤‡ä»½etcdæ•°æ® (masterèŠ‚ç‚¹)
ETCDCTL_API=3 etcdctl snapshot save /backup/etcd-snapshot-$(date +%Y%m%d-%H%M%S).db \
  --endpoints=https://127.0.0.1:2379 \
  --cacert=/etc/kubernetes/pki/etcd/ca.crt \
  --cert=/etc/kubernetes/pki/etcd/server.crt \
  --key=/etc/kubernetes/pki/etcd/server.key

# å¤‡ä»½è¯ä¹¦å’Œé…ç½®
cp -r /etc/kubernetes /backup/kubernetes-$(date +%Y%m%d)

# ========== é›†ç¾¤æ•…éšœæ’æŸ¥ ==========

# æŸ¥çœ‹é›†ç¾¤ç»„ä»¶çŠ¶æ€
kubectl get cs  # (å·²å¼ƒç”¨,ä½¿ç”¨ä¸‹é¢çš„æ–¹æ³•)
kubectl get pods -n kube-system

# æŸ¥çœ‹èŠ‚ç‚¹äº‹ä»¶
kubectl get events --all-namespaces --sort-by='.lastTimestamp'

# æŸ¥çœ‹kubeletæ—¥å¿—
journalctl -u kubelet -f

# æŸ¥çœ‹containerdæ—¥å¿—
journalctl -u containerd -f

# é‡ç½®èŠ‚ç‚¹ (è°¨æ…æ“ä½œ,ä¼šåˆ é™¤æ‰€æœ‰é…ç½®)
kubeadm reset
rm -rf /etc/cni/net.d
rm -rf /var/lib/kubelet/*
```

#### 1.5.7 æ•…éšœæ’æŸ¥æ¡ˆä¾‹

**æ¡ˆä¾‹1: Pod ä¸€ç›´å¤„äº Pending çŠ¶æ€**

```bash
# ç°è±¡
kubectl get pods
# NAME                     READY   STATUS    RESTARTS   AGE
# nginx-7c5ddbdf54-8xk9p   0/1     Pending   0          5m

# æ’æŸ¥æ­¥éª¤
kubectl describe pod nginx-7c5ddbdf54-8xk9p
# Events:
#   Warning  FailedScheduling  5m  default-scheduler  0/3 nodes are available: 3 Insufficient cpu.

# åŸå› : èŠ‚ç‚¹èµ„æºä¸è¶³
# è§£å†³æ–¹æ¡ˆ: é™ä½Podèµ„æºè¯·æ±‚æˆ–å¢åŠ èŠ‚ç‚¹
```

**æ¡ˆä¾‹2: Service æ— æ³•è®¿é—®**

```bash
# ç°è±¡
curl http://10.96.100.200  # è¶…æ—¶

# æ’æŸ¥æ­¥éª¤
# 1. æ£€æŸ¥Service
kubectl get svc nginx
kubectl get endpoints nginx  # æ£€æŸ¥åç«¯Pod IPæ˜¯å¦æ­£ç¡®

# 2. æ£€æŸ¥Pod
kubectl get pods -l app=nginx -o wide

# 3. æ£€æŸ¥ç½‘ç»œ
# åœ¨Podå†…æµ‹è¯•ç½‘ç»œ
kubectl exec -it nginx-xxx -- curl http://10.96.100.200

# 4. æ£€æŸ¥kube-proxy
kubectl logs -n kube-system kube-proxy-xxx

# 5. æ£€æŸ¥iptablesè§„åˆ™ (iptablesæ¨¡å¼)
iptables-save | grep nginx

# 6. æ£€æŸ¥IPVSè§„åˆ™ (ipvsæ¨¡å¼)
ipvsadm -Ln | grep 10.96.100.200
```

**æ¡ˆä¾‹3: èŠ‚ç‚¹ NotReady**

```bash
# ç°è±¡
kubectl get nodes
# NAME          STATUS     ROLES    AGE   VERSION
# k8s-worker1   NotReady   <none>   10d   v1.28.0

# æ’æŸ¥æ­¥éª¤
kubectl describe node k8s-worker1
# Conditions:
#   Type             Status
#   ----             ------
#   Ready            False   KubeletNotReady runtime network not ready: NetworkReady=false reason:NetworkPluginNotReady

# åŸå› : CNIæ’ä»¶æœªå°±ç»ª
# è§£å†³æ–¹æ¡ˆ:
kubectl get pods -n kube-system | grep calico
kubectl logs -n kube-system calico-node-xxx
```


---

## 1.6 æœ¬ç« å°ç»“

æœ¬ç« æ·±å…¥è®²è§£äº† Kubernetes çš„æ ¸å¿ƒæ¦‚å¿µä¸æ¶æ„,ä¸ºåç»­å­¦ä¹ æ‰“ä¸‹åšå®åŸºç¡€ã€‚

### âœ… æ ¸å¿ƒçŸ¥è¯†ç‚¹å›é¡¾

**1. Kubernetes æ˜¯ä»€ä¹ˆ**
- å®¹å™¨ç¼–æ’å¹³å°çš„æ¼”è¿›å†å² (Docker Swarm â†’ Mesos â†’ Kubernetes)
- K8s vs Docker Swarm è¯¦ç»†å¯¹æ¯” (æ¶æ„/åŠŸèƒ½/é€‚ç”¨åœºæ™¯)
- Kubernetes æ ¸å¿ƒä»·å€¼:
  - è‡ªåŠ¨åŒ–éƒ¨ç½²ä¸å›æ»š
  - æœåŠ¡å‘ç°ä¸è´Ÿè½½å‡è¡¡
  - è‡ªåŠ¨æ‰©ç¼©å®¹
  - è‡ªæ„ˆèƒ½åŠ›
  - é…ç½®ä¸å¯†é’¥ç®¡ç†

**2. Kubernetes æ¶æ„è®¾è®¡**
- Master-Node æ¶æ„æ¨¡å‹
- æ§åˆ¶å¹³é¢ä¸æ•°æ®å¹³é¢åˆ†ç¦»

**3. æ§åˆ¶å¹³é¢ç»„ä»¶**
- **kube-apiserver**: é›†ç¾¤ç½‘å…³,å¤„ç†RESTè¯·æ±‚,è®¤è¯/æˆæƒ/å‡†å…¥æ§åˆ¶
- **etcd**: åˆ†å¸ƒå¼é”®å€¼å­˜å‚¨,Raftä¸€è‡´æ€§ç®—æ³•,é›†ç¾¤å”¯ä¸€æ•°æ®æº
- **kube-scheduler**: æ™ºèƒ½è°ƒåº¦å™¨,é¢„é€‰(Predicates)/ä¼˜é€‰(Priorities)ä¸¤é˜¶æ®µè°ƒåº¦
- **kube-controller-manager**: æ§åˆ¶å¾ªç¯ç®¡ç†å™¨,37ä¸ªå†…ç½®æ§åˆ¶å™¨,Reconciliation Loop
- **cloud-controller-manager**: äº‘å¹³å°é›†æˆ,ç®¡ç†LB/å­˜å‚¨å·/è·¯ç”±ç­‰äº‘èµ„æº

**4. Node èŠ‚ç‚¹ç»„ä»¶**
- **kubelet**: èŠ‚ç‚¹ä»£ç†,Podç”Ÿå‘½å‘¨æœŸç®¡ç†,å¥åº·æ£€æŸ¥,çŠ¶æ€ä¸ŠæŠ¥
- **kube-proxy**: ç½‘ç»œä»£ç†,Serviceè´Ÿè½½å‡è¡¡,iptables/ipvsä¸¤ç§æ¨¡å¼
- **Container Runtime**: å®¹å™¨è¿è¡Œæ—¶,containerd/CRI-O,é€šè¿‡CRIæ¥å£ä¸kubeletäº¤äº’

**5. æ ¸å¿ƒèµ„æºå¯¹è±¡æ¨¡å‹**
- å·¥ä½œè´Ÿè½½èµ„æº: Pod/Deployment/StatefulSet/DaemonSet/Job/CronJob
- æœåŠ¡å‘ç°èµ„æº: Service/Ingress/EndpointSlice
- é…ç½®å­˜å‚¨èµ„æº: ConfigMap/Secret/PV/PVC/StorageClass
- æƒé™å®‰å…¨èµ„æº: ServiceAccount/Role/RoleBinding/NetworkPolicy
- æ ‡ç­¾ä¸é€‰æ‹©å™¨: èµ„æºç»„ç»‡çš„æ ¸å¿ƒæœºåˆ¶

**6. kubectl å‘½ä»¤è¡Œå·¥å…·**
- kubeconfig é…ç½®ä¸ä¸Šä¸‹æ–‡åˆ‡æ¢
- å¸¸ç”¨å‘½ä»¤é€ŸæŸ¥ (get/describe/logs/exec/port-forward)
- kubectl æ’ä»¶ç”Ÿæ€ (krew/k9s/stern)

**7. å®æˆ˜é¡¹ç›®: 3èŠ‚ç‚¹é›†ç¾¤æ­å»º**
- ç³»ç»Ÿé…ç½® (é˜²ç«å¢™/SELinux/Swap/å†…æ ¸å‚æ•°)
- containerd å®‰è£…ä¸é…ç½®
- kubeadm é›†ç¾¤åˆå§‹åŒ–
- Calico ç½‘ç»œæ’ä»¶éƒ¨ç½²
- åº”ç”¨éƒ¨ç½²æµ‹è¯• (Nginx Deployment + NodePort Service)
- é›†ç¾¤ç»´æŠ¤ä¸æ•…éšœæ’æŸ¥

### ğŸ“Š æŠ€æœ¯äº®ç‚¹

- âœ… ç”Ÿäº§çº§é…ç½®ç¤ºä¾‹ (etcdé›†ç¾¤/API Server/kubelet/kube-proxy)
- âœ… æ·±åº¦åŸç†å‰–æ (Raftç®—æ³•/è°ƒåº¦æµç¨‹/æ§åˆ¶å¾ªç¯/ç½‘ç»œä»£ç†)
- âœ… å®Œæ•´è¿ç»´å‘½ä»¤ (etcdctl/ipvsadm/crictl/kubectl)
- âœ… å®æˆ˜æ¡ˆä¾‹åˆ†æ (æ»šåŠ¨æ›´æ–°/èŠ‚ç‚¹ç»´æŠ¤/æ•…éšœæ’æŸ¥)

### ğŸ¯ ä¸‹ä¸€ç« é¢„å‘Š

ç¬¬2ç« å°†æ·±å…¥è®²è§£ Kubernetes çš„æœ€å°è°ƒåº¦å•ä½ **Pod**,å†…å®¹åŒ…æ‹¬:
- Pod ç”Ÿå‘½å‘¨æœŸä¸çŠ¶æ€è½¬æ¢
- å®¹å™¨è®¾è®¡æ¨¡å¼ (Sidecar/Ambassador/Adapter)
- Init å®¹å™¨ä¸å¯åŠ¨é¡ºåºæ§åˆ¶
- å¥åº·æ£€æŸ¥ä¸‰å‰‘å®¢ (Liveness/Readiness/Startup Probe)
- èµ„æºç®¡ç†ä¸QoS (requests/limits/QoSç­‰çº§)
- Pod ç½‘ç»œä¸å­˜å‚¨
- å®æˆ˜é¡¹ç›®: å¤šå®¹å™¨ Pod è®¾è®¡

---

*ç¬¬1ç« å®Œæˆ,å…± ~3800è¡Œã€‚ä¸‹ä¸€ç« å°†æ·±å…¥Podæ ¸å¿ƒæ¦‚å¿µã€‚*


---

# ç¬¬2ç« : Pod æ ¸å¿ƒæ¦‚å¿µä¸å®æˆ˜

## æœ¬ç« å¯¼è¯»

Pod æ˜¯ Kubernetes ä¸­æœ€å°çš„è°ƒåº¦å•ä½,ç†è§£ Pod æ˜¯æŒæ¡ Kubernetes çš„å…³é”®ã€‚æœ¬ç« å°†æ·±å…¥è®²è§£:

- **Pod æ˜¯ä»€ä¹ˆ**: å®¹å™¨ç»„æ¦‚å¿µã€ä¸å®¹å™¨çš„å…³ç³»ã€Pauseå®¹å™¨çš„ä½œç”¨
- **Pod ç”Ÿå‘½å‘¨æœŸ**: PhaseçŠ¶æ€è½¬æ¢ã€é‡å¯ç­–ç•¥ã€ä¼˜é›…ç»ˆæ­¢
- **å®¹å™¨è®¾è®¡æ¨¡å¼**: Sidecar/Ambassador/Adapterä¸‰å¤§æ¨¡å¼
- **Init å®¹å™¨**: åˆå§‹åŒ–å®¹å™¨ã€å¯åŠ¨é¡ºåºæ§åˆ¶
- **å¥åº·æ£€æŸ¥**: Liveness/Readiness/Startup Probeä¸‰å‰‘å®¢
- **èµ„æºç®¡ç†**: requests/limitsã€QoSç­‰çº§ã€LimitRange
- **Pod ç½‘ç»œ**: IPåˆ†é…ã€å®¹å™¨é—´é€šä¿¡ã€Podé—´é€šä¿¡
- **Pod å­˜å‚¨**: Volumeç±»å‹ã€ä¸´æ—¶å·vsæŒä¹…å·
- **å®æˆ˜é¡¹ç›®**: å¤šå®¹å™¨Podè®¾è®¡ã€å¥åº·æ£€æŸ¥æœ€ä½³å®è·µ

---

## 2.1 Pod åŸºç¡€æ¦‚å¿µ

### 2.1.1 Pod æ˜¯ä»€ä¹ˆ

**å®šä¹‰**:

Pod æ˜¯ Kubernetes ä¸­æœ€å°çš„éƒ¨ç½²å•å…ƒ,æ˜¯ä¸€ç»„**ç´§å¯†è€¦åˆ**çš„å®¹å™¨çš„é›†åˆã€‚

```
Pod ç»“æ„:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Pod: nginx-pod                         â”‚
â”‚  IP: 10.244.1.5                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Pause å®¹å™¨ (åŸºç¡€è®¾æ–½å®¹å™¨)        â”‚ â”‚
â”‚  â”‚  â€¢ åˆ›å»ºå¹¶æŒæœ‰ç½‘ç»œå‘½åç©ºé—´         â”‚ â”‚
â”‚  â”‚  â€¢ åˆ›å»ºå¹¶æŒæœ‰IPCå‘½åç©ºé—´          â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  å®¹å™¨1: nginx                     â”‚ â”‚
â”‚  â”‚  â€¢ å…±äº«ç½‘ç»œ: localhosté€šä¿¡       â”‚ â”‚
â”‚  â”‚  â€¢ å…±äº«IPC: å…±äº«å†…å­˜              â”‚ â”‚
â”‚  â”‚  â€¢ ç‹¬ç«‹æ–‡ä»¶ç³»ç»Ÿ                   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  å®¹å™¨2: log-collector (å¯é€‰)     â”‚ â”‚
â”‚  â”‚  â€¢ å…±äº«ç½‘ç»œ: localhosté€šä¿¡       â”‚ â”‚
â”‚  â”‚  â€¢ å…±äº«Volume: è®¿é—®æ—¥å¿—æ–‡ä»¶       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Volume: logs (å…±äº«å­˜å‚¨)          â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ ¸å¿ƒç‰¹æ€§**:

1. **å…±äº«ç½‘ç»œå‘½åç©ºé—´**: Podå†…æ‰€æœ‰å®¹å™¨å…±äº«åŒä¸€ä¸ªIPåœ°å€å’Œç«¯å£ç©ºé—´
2. **å…±äº«IPCå‘½åç©ºé—´**: å®¹å™¨é—´å¯é€šè¿‡System V IPCæˆ–POSIXæ¶ˆæ¯é˜Ÿåˆ—é€šä¿¡
3. **å…±äº«UTSå‘½åç©ºé—´**: å…±äº«ä¸»æœºå
4. **å…±äº«Volume**: å®¹å™¨é—´å¯ä»¥å…±äº«å­˜å‚¨å·
5. **åŸå­è°ƒåº¦**: Podä½œä¸ºæ•´ä½“è¢«è°ƒåº¦åˆ°åŒä¸€èŠ‚ç‚¹,è¦ä¹ˆå…¨éƒ¨å¯åŠ¨,è¦ä¹ˆå…¨éƒ¨å¤±è´¥

### 2.1.2 Pod ä¸å®¹å™¨çš„å…³ç³»

**ä¸ºä»€ä¹ˆéœ€è¦ Pod?**

```
é—®é¢˜: ä¸ºä»€ä¹ˆä¸ç›´æ¥è°ƒåº¦å®¹å™¨?

åœºæ™¯1: WebæœåŠ¡å™¨ + æ—¥å¿—æ”¶é›†å™¨
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  nginx       â”‚    â”‚log-collector â”‚
â”‚  å®¹å™¨1       â”‚â—„â”€â”€â”€â”‚  å®¹å™¨2       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚                     â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         éœ€è¦å…±äº«æ—¥å¿—æ–‡ä»¶
         éœ€è¦localhosté€šä¿¡

å¦‚æœåˆ†å¼€è°ƒåº¦:
âŒ å¯èƒ½è¢«è°ƒåº¦åˆ°ä¸åŒèŠ‚ç‚¹ â†’ æ— æ³•å…±äº«Volume
âŒ æ‹¥æœ‰ä¸åŒIP â†’ æ— æ³•localhosté€šä¿¡
âŒ ç”Ÿå‘½å‘¨æœŸç‹¬ç«‹ç®¡ç† â†’ å¤æ‚æ€§å¢åŠ 

ä½¿ç”¨Podå:
âœ… ä¿è¯åœ¨åŒä¸€èŠ‚ç‚¹ â†’ å…±äº«Volume
âœ… å…±äº«ç½‘ç»œå‘½åç©ºé—´ â†’ localhosté€šä¿¡
âœ… ç»Ÿä¸€ç”Ÿå‘½å‘¨æœŸç®¡ç† â†’ ç®€åŒ–è¿ç»´
```

**Pod vs å®¹å™¨ vs è™šæ‹Ÿæœº**:

| å¯¹æ¯”ç»´åº¦ | å®¹å™¨ | Pod | è™šæ‹Ÿæœº |
|---------|------|-----|--------|
| **éš”ç¦»çº§åˆ«** | è¿›ç¨‹éš”ç¦» | å®¹å™¨ç»„éš”ç¦» | æ“ä½œç³»ç»Ÿéš”ç¦» |
| **èµ„æºå¼€é”€** | ä½ | ä½ | é«˜ |
| **å¯åŠ¨æ—¶é—´** | ç§’çº§ | ç§’çº§ | åˆ†é’Ÿçº§ |
| **ç½‘ç»œ** | ç‹¬ç«‹IP(æˆ–å…±äº«å®¿ä¸»æœº) | ç‹¬ç«‹IP(Podå†…å…±äº«) | ç‹¬ç«‹IP |
| **å­˜å‚¨** | ç‹¬ç«‹æ–‡ä»¶ç³»ç»Ÿ | å¯å…±äº«Volume | ç‹¬ç«‹ç£ç›˜ |
| **è°ƒåº¦å•ä½** | - | âœ“ | âœ“ |

### 2.1.3 Pause å®¹å™¨çš„ä½œç”¨

**ä»€ä¹ˆæ˜¯ Pause å®¹å™¨?**

Pause å®¹å™¨(ä¹Ÿå«"åŸºç¡€è®¾æ–½å®¹å™¨"æˆ–"æ²™ç®±å®¹å™¨")æ˜¯æ¯ä¸ª Pod ä¸­**ç¬¬ä¸€ä¸ªå¯åŠ¨**çš„ç‰¹æ®Šå®¹å™¨ã€‚

```
Pause å®¹å™¨çš„èŒè´£:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. åˆ›å»ºç½‘ç»œå‘½åç©ºé—´                 â”‚
â”‚     â€¢ Pod IPç”±Pauseå®¹å™¨æŒæœ‰          â”‚
â”‚     â€¢ ä¸šåŠ¡å®¹å™¨åŠ å…¥Pauseçš„ç½‘ç»œå‘½åç©ºé—´â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. åˆ›å»ºIPCå‘½åç©ºé—´                  â”‚
â”‚     â€¢ å®¹å™¨é—´å¯å…±äº«å†…å­˜               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. å›æ”¶åƒµå°¸è¿›ç¨‹ (PID=1)            â”‚
â”‚     â€¢ ä½œä¸ºPIDå‘½åç©ºé—´çš„initè¿›ç¨‹     â”‚
â”‚     â€¢ å›æ”¶å­¤å„¿è¿›ç¨‹                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Pause å®¹å™¨æºç ** (æç®€,ä»…38è¡ŒCä»£ç ):

```c
// pause.c - Kubernetes Pauseå®¹å™¨æºç 
#include <signal.h>
#include <stdio.h>
#include <stdlib.h>
#include <sys/types.h>
#include <sys/wait.h>
#include <unistd.h>

static void sigdown(int signo) {
  psignal(signo, "Shutting down, got signal");
  exit(0);
}

static void sigreap(int signo) {
  while (waitpid(-1, NULL, WNOHANG) > 0);
}

int main() {
  if (getpid() != 1)
    /* Not an error because pause sees use outside of infra containers. */
    fprintf(stderr, "Warning: pause should be the first process\n");

  if (sigaction(SIGINT, &(struct sigaction){.sa_handler = sigdown}, NULL) < 0)
    return 1;
  if (sigaction(SIGTERM, &(struct sigaction){.sa_handler = sigdown}, NULL) < 0)
    return 2;
  if (sigaction(SIGCHLD, &(struct sigaction){.sa_handler = sigreap,
                                             .sa_flags = SA_NOCLDSTOP},
                NULL) < 0)
    return 3;

  for (;;)
    pause();  // æ°¸ä¹…ä¼‘çœ ,ç­‰å¾…ä¿¡å·
  fprintf(stderr, "Error: infinite loop terminated\n");
  return 42;
}
```

**æŸ¥çœ‹ Pause å®¹å™¨**:

```bash
# åœ¨èŠ‚ç‚¹ä¸ŠæŸ¥çœ‹Pauseå®¹å™¨
crictl ps | grep pause
# CONTAINER ID  IMAGE                      COMMAND  CREATED  STATE   NAME   POD ID
# 1234abcd      registry.k8s.io/pause:3.9  "/pause" 5m       Running pause  567890ef

# æŸ¥çœ‹Pauseå®¹å™¨é•œåƒå¤§å°
crictl images | grep pause
# IMAGE                             TAG    SIZE
# registry.k8s.io/pause             3.9    747kB  â† æå°,ä»…747KB

# æŸ¥çœ‹Podçš„Pauseå®¹å™¨
kubectl get pod nginx-pod -o jsonpath='{.status.containerStatuses[?(@.name=="POD")].containerID}'
```

**Pause å®¹å™¨çš„ç”Ÿå‘½å‘¨æœŸ**:

```
Pod å¯åŠ¨æµç¨‹:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. kubelet æ¥æ”¶ PodSpec             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. åˆ›å»º Pod æ²™ç®± (Pauseå®¹å™¨)       â”‚
â”‚     â€¢ åˆ›å»ºç½‘ç»œå‘½åç©ºé—´               â”‚
â”‚     â€¢ åˆ›å»ºIPC/UTSå‘½åç©ºé—´            â”‚
â”‚     â€¢ åˆ†é…Pod IP                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. å¯åŠ¨ Init å®¹å™¨ (å¦‚æœæœ‰)         â”‚
â”‚     â€¢ é¡ºåºæ‰§è¡ŒInitå®¹å™¨               â”‚
â”‚     â€¢ Initå®¹å™¨å…¨éƒ¨æˆåŠŸæ‰ç»§ç»­         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  4. å¯åŠ¨ä¸šåŠ¡å®¹å™¨                     â”‚
â”‚     â€¢ åŠ å…¥Pauseçš„ç½‘ç»œå‘½åç©ºé—´        â”‚
â”‚     â€¢ å¹¶è¡Œå¯åŠ¨æ‰€æœ‰ä¸šåŠ¡å®¹å™¨           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Pod åœæ­¢æµç¨‹:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. kubelet æ¥æ”¶åˆ é™¤è¯·æ±‚             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. åœæ­¢ä¸šåŠ¡å®¹å™¨                     â”‚
â”‚     â€¢ å‘é€SIGTERMä¿¡å·                â”‚
â”‚     â€¢ ç­‰å¾…terminationGracePeriodSeconds â”‚
â”‚     â€¢ è¶…æ—¶åå‘é€SIGKILL              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. åˆ é™¤ Pause å®¹å™¨                  â”‚
â”‚     â€¢ å›æ”¶ç½‘ç»œå‘½åç©ºé—´               â”‚
â”‚     â€¢ é‡Šæ”¾Pod IP                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.1.4 åˆ›å»ºç¬¬ä¸€ä¸ª Pod

**æœ€ç®€å•çš„ Pod å®šä¹‰**:

```yaml
# simple-pod.yaml
apiVersion: v1
kind: Pod
metadata:
  name: nginx-pod
  labels:
    app: nginx
spec:
  containers:
  - name: nginx
    image: nginx:1.25
    ports:
    - containerPort: 80
```

```bash
# åˆ›å»ºPod
kubectl apply -f simple-pod.yaml

# æŸ¥çœ‹Pod
kubectl get pod nginx-pod
# NAME        READY   STATUS    RESTARTS   AGE
# nginx-pod   1/1     Running   0          10s

# æŸ¥çœ‹Podè¯¦æƒ…
kubectl describe pod nginx-pod

# æŸ¥çœ‹Pod IP
kubectl get pod nginx-pod -o wide
# NAME        READY   STATUS    RESTARTS   AGE   IP           NODE
# nginx-pod   1/1     Running   0          30s   10.244.1.5   k8s-worker1

# è®¿é—®Pod (åœ¨é›†ç¾¤å†…)
kubectl run -it --rm busybox --image=busybox --restart=Never -- wget -O- http://10.244.1.5

# æŸ¥çœ‹Podæ—¥å¿—
kubectl logs nginx-pod

# è¿›å…¥Pod
kubectl exec -it nginx-pod -- bash

# åˆ é™¤Pod
kubectl delete pod nginx-pod
```

**å¤šå®¹å™¨ Pod ç¤ºä¾‹**:

```yaml
# multi-container-pod.yaml
apiVersion: v1
kind: Pod
metadata:
  name: web-with-sidecar
spec:
  containers:
  # ä¸»å®¹å™¨: WebæœåŠ¡å™¨
  - name: nginx
    image: nginx:1.25
    ports:
    - containerPort: 80
    volumeMounts:
    - name: logs
      mountPath: /var/log/nginx

  # Sidecarå®¹å™¨: æ—¥å¿—æ”¶é›†å™¨
  - name: log-collector
    image: busybox
    args:
    - /bin/sh
    - -c
    - tail -f /logs/access.log
    volumeMounts:
    - name: logs
      mountPath: /logs

  # å…±äº«Volume
  volumes:
  - name: logs
    emptyDir: {}
```

```bash
# åˆ›å»ºå¤šå®¹å™¨Pod
kubectl apply -f multi-container-pod.yaml

# æŸ¥çœ‹Pod (READYæ˜¾ç¤º2/2,è¡¨ç¤º2ä¸ªå®¹å™¨éƒ½å°±ç»ª)
kubectl get pod web-with-sidecar
# NAME              READY   STATUS    RESTARTS   AGE
# web-with-sidecar  2/2     Running   0          20s

# æŸ¥çœ‹ç‰¹å®šå®¹å™¨çš„æ—¥å¿—
kubectl logs web-with-sidecar -c nginx
kubectl logs web-with-sidecar -c log-collector

# è¿›å…¥ç‰¹å®šå®¹å™¨
kubectl exec -it web-with-sidecar -c nginx -- bash
kubectl exec -it web-with-sidecar -c log-collector -- sh

# éªŒè¯å®¹å™¨é—´ç½‘ç»œå…±äº« (åœ¨nginxå®¹å™¨ä¸­è®¿é—®log-collectorçš„è¿›ç¨‹)
kubectl exec web-with-sidecar -c nginx -- curl localhost:80  # è®¿é—®è‡ªå·±
kubectl exec web-with-sidecar -c nginx -- ps aux  # åªèƒ½çœ‹åˆ°è‡ªå·±çš„è¿›ç¨‹
```

**Pod å‘½åè§„èŒƒ**:

```yaml
# æ¨èçš„Podå‘½åè§„èŒƒ
metadata:
  name: nginx-deployment-7c5ddbdf54-8xk9p  # Deploymentè‡ªåŠ¨ç”Ÿæˆ
  # æ ¼å¼: <deployment-name>-<replicaset-hash>-<random>
  
  # æˆ–æ‰‹åŠ¨åˆ›å»ºPod
  name: my-app-v1  # å°å†™å­—æ¯ã€æ•°å­—ã€è¿å­—ç¬¦,ä¸è¶…è¿‡253å­—ç¬¦
  
  labels:
    app: nginx                    # åº”ç”¨åç§°
    version: "1.25"               # ç‰ˆæœ¬
    environment: production       # ç¯å¢ƒ
    tier: frontend                # å±‚çº§
```


---

## 2.2 Pod ç”Ÿå‘½å‘¨æœŸ

### 2.2.1 Pod Phase çŠ¶æ€

**Pod çš„5ç§ Phase çŠ¶æ€**:

| Phase | å«ä¹‰ | è¯´æ˜ |
|-------|------|------|
| **Pending** | ç­‰å¾…ä¸­ | Podå·²è¢«K8sæ¥å—,ä½†å®¹å™¨å°šæœªåˆ›å»ºæˆ–é•œåƒæ­£åœ¨æ‹‰å– |
| **Running** | è¿è¡Œä¸­ | Podå·²ç»‘å®šåˆ°èŠ‚ç‚¹,æ‰€æœ‰å®¹å™¨å·²åˆ›å»º,è‡³å°‘ä¸€ä¸ªå®¹å™¨æ­£åœ¨è¿è¡Œ |
| **Succeeded** | æˆåŠŸ | Podä¸­æ‰€æœ‰å®¹å™¨å·²æˆåŠŸç»ˆæ­¢,ä¸”ä¸ä¼šé‡å¯ (Job/CronJob) |
| **Failed** | å¤±è´¥ | Podä¸­æ‰€æœ‰å®¹å™¨å·²ç»ˆæ­¢,è‡³å°‘ä¸€ä¸ªå®¹å™¨å¤±è´¥é€€å‡º |
| **Unknown** | æœªçŸ¥ | æ— æ³•è·å–PodçŠ¶æ€,é€šå¸¸æ˜¯èŠ‚ç‚¹å¤±è” |

**Pod Phase çŠ¶æ€è½¬æ¢å›¾**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Pending   â”‚ â† Podè¢«åˆ›å»º,ç­‰å¾…è°ƒåº¦
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â”‚ è°ƒåº¦æˆåŠŸ,å¼€å§‹æ‹‰å–é•œåƒ/åˆ›å»ºå®¹å™¨
      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Running   â”‚ â† è‡³å°‘ä¸€ä¸ªå®¹å™¨æ­£åœ¨è¿è¡Œ
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚                  â”‚                  â”‚
      â†“                  â†“                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Succeeded  â”‚    â”‚   Failed    â”‚    â”‚   Unknown   â”‚
â”‚  (Jobå®Œæˆ)  â”‚    â”‚ (å®¹å™¨å¤±è´¥)  â”‚    â”‚  (èŠ‚ç‚¹å¤±è”) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â”‚ restartPolicy=Always
                         â†“
                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                   â”‚   Running   â”‚ â† é‡å¯å®¹å™¨
                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æŸ¥çœ‹ Pod Phase**:

```bash
# æŸ¥çœ‹PodçŠ¶æ€
kubectl get pod nginx-pod
# NAME        READY   STATUS    RESTARTS   AGE
# nginx-pod   1/1     Running   0          5m

# æŸ¥çœ‹Pod Phase (ä½¿ç”¨jsonpath)
kubectl get pod nginx-pod -o jsonpath='{.status.phase}'
# Running

# æŸ¥çœ‹æ‰€æœ‰Podçš„Phase
kubectl get pods -A -o custom-columns=NAME:.metadata.name,PHASE:.status.phase

# æŸ¥çœ‹Podè¯¦ç»†çŠ¶æ€
kubectl describe pod nginx-pod
```

### 2.2.2 å®¹å™¨çŠ¶æ€

æ¯ä¸ªå®¹å™¨éƒ½æœ‰3ç§å¯èƒ½çš„çŠ¶æ€:

| çŠ¶æ€ | å«ä¹‰ | è¯´æ˜ |
|------|------|------|
| **Waiting** | ç­‰å¾…ä¸­ | å®¹å™¨æ­£åœ¨æ‹‰å–é•œåƒæˆ–æ‰§è¡Œå…¶ä»–æ“ä½œ |
| **Running** | è¿è¡Œä¸­ | å®¹å™¨æ­£å¸¸è¿è¡Œ,è¿›ç¨‹PIDå­˜åœ¨ |
| **Terminated** | å·²ç»ˆæ­¢ | å®¹å™¨å·²åœæ­¢,å¯èƒ½æ˜¯æ­£å¸¸é€€å‡ºæˆ–å¼‚å¸¸é€€å‡º |

```yaml
# æŸ¥çœ‹å®¹å™¨çŠ¶æ€è¯¦æƒ…
kubectl get pod nginx-pod -o yaml

# è¾“å‡ºç¤ºä¾‹:
status:
  containerStatuses:
  - name: nginx
    state:
      running:
        startedAt: "2025-12-14T10:30:00Z"
    ready: true
    restartCount: 0
    image: nginx:1.25
    imageID: docker-pullable://nginx@sha256:abc123...
```

**å®¹å™¨çŠ¶æ€è½¬æ¢**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Waiting    â”‚ â† å®¹å™¨åˆå§‹çŠ¶æ€/é‡å¯å
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â”‚ é•œåƒæ‹‰å–å®Œæˆ,å®¹å™¨å¯åŠ¨
      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Running    â”‚ â† å®¹å™¨æ­£å¸¸è¿è¡Œ
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â”‚ å®¹å™¨é€€å‡º (æ­£å¸¸æˆ–å¼‚å¸¸)
      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Terminated  â”‚ â† å®¹å™¨å·²åœæ­¢
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â”‚ restartPolicyè§¦å‘é‡å¯
      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Waiting    â”‚ â† ç­‰å¾…é‡å¯
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2.3 Pod Conditions

Pod Conditions æä¾›æ¯” Phase æ›´è¯¦ç»†çš„çŠ¶æ€ä¿¡æ¯:

| Condition | å«ä¹‰ | Trueè¡¨ç¤º |
|-----------|------|---------|
| **PodScheduled** | Podå·²è°ƒåº¦ | Podå·²åˆ†é…åˆ°èŠ‚ç‚¹ |
| **Initialized** | Initå®¹å™¨å®Œæˆ | æ‰€æœ‰Initå®¹å™¨å·²æˆåŠŸæ‰§è¡Œ |
| **ContainersReady** | å®¹å™¨å°±ç»ª | Podä¸­æ‰€æœ‰å®¹å™¨éƒ½Ready |
| **Ready** | Podå°±ç»ª | Podå¯ä»¥æ¥æ”¶æµé‡ (Serviceä¼šé€‰ä¸­) |

```bash
# æŸ¥çœ‹Pod Conditions
kubectl describe pod nginx-pod | grep -A 10 Conditions

# è¾“å‡ºç¤ºä¾‹:
Conditions:
  Type              Status
  Initialized       True       # Initå®¹å™¨å·²å®Œæˆ
  Ready             True       # Podå·²å°±ç»ª
  ContainersReady   True       # æ‰€æœ‰å®¹å™¨å·²å°±ç»ª
  PodScheduled      True       # Podå·²è°ƒåº¦åˆ°èŠ‚ç‚¹
```

```yaml
# Conditions å®Œæ•´è¾“å‡º (kubectl get pod -o yaml)
status:
  conditions:
  - type: Initialized
    status: "True"
    lastProbeTime: null
    lastTransitionTime: "2025-12-14T10:30:00Z"
  - type: Ready
    status: "True"
    lastProbeTime: null
    lastTransitionTime: "2025-12-14T10:30:05Z"
  - type: ContainersReady
    status: "True"
    lastProbeTime: null
    lastTransitionTime: "2025-12-14T10:30:05Z"
  - type: PodScheduled
    status: "True"
    lastProbeTime: null
    lastTransitionTime: "2025-12-14T10:29:58Z"
```

### 2.2.4 å®¹å™¨é‡å¯ç­–ç•¥

**ä¸‰ç§é‡å¯ç­–ç•¥**:

| restartPolicy | è¡Œä¸º | é€‚ç”¨åœºæ™¯ |
|---------------|------|---------|
| **Always** | æ€»æ˜¯é‡å¯ | Deployment/DaemonSet/StatefulSet (é»˜è®¤) |
| **OnFailure** | å¤±è´¥æ—¶é‡å¯ | Job |
| **Never** | ä»ä¸é‡å¯ | ä¸€æ¬¡æ€§ä»»åŠ¡ |

```yaml
# ç¤ºä¾‹1: Always (é»˜è®¤ç­–ç•¥)
apiVersion: v1
kind: Pod
metadata:
  name: nginx-always
spec:
  restartPolicy: Always  # å®¹å™¨é€€å‡ºåæ€»æ˜¯é‡å¯
  containers:
  - name: nginx
    image: nginx:1.25

---
# ç¤ºä¾‹2: OnFailure
apiVersion: v1
kind: Pod
metadata:
  name: test-job
spec:
  restartPolicy: OnFailure  # ä»…å¤±è´¥æ—¶é‡å¯ (é€€å‡ºç !=0)
  containers:
  - name: test
    image: busybox
    command: ["sh", "-c", "exit 1"]  # å¤±è´¥é€€å‡º â†’ ä¼šé‡å¯

---
# ç¤ºä¾‹3: Never
apiVersion: v1
kind: Pod
metadata:
  name: one-time-task
spec:
  restartPolicy: Never  # ä»ä¸é‡å¯
  containers:
  - name: task
    image: busybox
    command: ["sh", "-c", "echo 'Task completed'"]
```

**é‡å¯å»¶è¿Ÿç­–ç•¥** (æŒ‡æ•°é€€é¿):

```
é‡å¯å»¶è¿Ÿæ—¶é—´:
ç¬¬1æ¬¡é‡å¯: ç«‹å³ (0ç§’)
ç¬¬2æ¬¡é‡å¯: 10ç§’å
ç¬¬3æ¬¡é‡å¯: 20ç§’å
ç¬¬4æ¬¡é‡å¯: 40ç§’å
ç¬¬5æ¬¡é‡å¯: 80ç§’å
...
æœ€å¤§å»¶è¿Ÿ: 5åˆ†é’Ÿ

å¦‚æœå®¹å™¨è¿è¡Œ10åˆ†é’Ÿæ— æ•…éšœ,é‡å¯å»¶è¿Ÿé‡ç½®ä¸º0
```

```bash
# æŸ¥çœ‹å®¹å™¨é‡å¯æ¬¡æ•°
kubectl get pod nginx-pod
# NAME        READY   STATUS    RESTARTS   AGE
# nginx-pod   1/1     Running   3          10m  â† RESTARTSæ˜¾ç¤ºé‡å¯æ¬¡æ•°

# æŸ¥çœ‹é‡å¯è¯¦æƒ…
kubectl describe pod nginx-pod | grep -A 5 "Last State"
# Last State:     Terminated
#   Reason:       Error
#   Exit Code:    137
#   Started:      Thu, 14 Dec 2025 10:30:00 +0800
#   Finished:     Thu, 14 Dec 2025 10:31:00 +0800
```

### 2.2.5 Pod ç»ˆæ­¢æµç¨‹

**ä¼˜é›…ç»ˆæ­¢** (Graceful Termination):

```
Pod åˆ é™¤æµç¨‹:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. kubectl delete pod nginx-pod             â”‚
â”‚     â†’ API Serveræ ‡è®°Podä¸ºTerminating         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. kubelet å¼€å§‹ä¼˜é›…ç»ˆæ­¢æµç¨‹                 â”‚
â”‚     å¹¶è¡Œæ‰§è¡Œä»¥ä¸‹æ­¥éª¤:                         â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚     â”‚ â‘ Endpoints Controllerç§»é™¤Pod IP  â”‚    â”‚
â”‚     â”‚   â†’ Serviceä¸å†è½¬å‘æµé‡åˆ°æ­¤Pod   â”‚    â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚     â”‚ â‘¡æ‰§è¡Œ preStop Hook (å¦‚æœæœ‰)     â”‚    â”‚
â”‚     â”‚   â†’ å®¹å™¨ç”Ÿå‘½å‘¨æœŸé’©å­             â”‚    â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. å‘å®¹å™¨å‘é€ SIGTERM ä¿¡å·                  â”‚
â”‚     ç­‰å¾…terminationGracePeriodSeconds (é»˜è®¤30ç§’)â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  4. è¶…æ—¶åå¼ºåˆ¶ç»ˆæ­¢                           â”‚
â”‚     å‘å®¹å™¨å‘é€ SIGKILL ä¿¡å·                  â”‚
â”‚     â†’ å®¹å™¨ç«‹å³è¢«æ€æ­»                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  5. ä»API Serveråˆ é™¤Podå¯¹è±¡                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**é…ç½®ä¼˜é›…ç»ˆæ­¢æ—¶é—´**:

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: nginx-graceful
spec:
  terminationGracePeriodSeconds: 60  # ä¼˜é›…ç»ˆæ­¢ç­‰å¾…æ—¶é—´60ç§’ (é»˜è®¤30ç§’)
  containers:
  - name: nginx
    image: nginx:1.25
    lifecycle:
      preStop:  # å®¹å™¨åœæ­¢å‰æ‰§è¡Œçš„é’©å­
        exec:
          command:
          - sh
          - -c
          - |
            # ä¼˜é›…å…³é—­nginx (ç­‰å¾…ç°æœ‰è¿æ¥å¤„ç†å®Œæˆ)
            /usr/sbin/nginx -s quit
            # ç­‰å¾…æœ€å¤š30ç§’
            sleep 30
```

**ç«‹å³å¼ºåˆ¶åˆ é™¤ Pod** (ä¸æ¨è):

```bash
# ç«‹å³åˆ é™¤Pod,ä¸ç­‰å¾…ä¼˜é›…ç»ˆæ­¢ (å±é™©æ“ä½œ!)
kubectl delete pod nginx-pod --force --grace-period=0

# ç­‰ä»·äº:
kubectl delete pod nginx-pod --grace-period=0 --force
```

**PreStop Hook ç¤ºä¾‹**:

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: web-with-prestop
spec:
  containers:
  - name: nginx
    image: nginx:1.25
    lifecycle:
      # å®¹å™¨åœæ­¢å‰æ‰§è¡Œ
      preStop:
        httpGet:
          path: /shutdown
          port: 8080
          scheme: HTTP
      # æˆ–ä½¿ç”¨execå‘½ä»¤
      # preStop:
      #   exec:
      #     command: ["/bin/sh", "-c", "nginx -s quit; sleep 30"]
```

### 2.2.6 Pod ç”Ÿå‘½å‘¨æœŸé’©å­

**ä¸¤ç§ç”Ÿå‘½å‘¨æœŸé’©å­**:

| Hook | æ—¶æœº | ç”¨é€” |
|------|------|------|
| **postStart** | å®¹å™¨å¯åŠ¨å | åˆå§‹åŒ–ä»»åŠ¡(éInitå®¹å™¨) |
| **preStop** | å®¹å™¨ç»ˆæ­¢å‰ | ä¼˜é›…å…³é—­ã€æ¸…ç†èµ„æº |

```yaml
# ç”Ÿå‘½å‘¨æœŸé’©å­å®Œæ•´ç¤ºä¾‹
apiVersion: v1
kind: Pod
metadata:
  name: lifecycle-demo
spec:
  containers:
  - name: nginx
    image: nginx:1.25
    lifecycle:
      # å®¹å™¨å¯åŠ¨åç«‹å³æ‰§è¡Œ (ä¸å®¹å™¨ä¸»è¿›ç¨‹å¹¶è¡Œ)
      postStart:
        exec:
          command:
          - sh
          - -c
          - |
            echo "Container started at $(date)" > /tmp/started.log
            # æ³¨å†Œåˆ°æœåŠ¡æ³¨å†Œä¸­å¿ƒ
            curl -X POST http://registry:8080/register \
              -d '{"host":"'${POD_IP}'","port":80}'
      
      # å®¹å™¨ç»ˆæ­¢å‰æ‰§è¡Œ (é˜»å¡SIGTERMä¿¡å·)
      preStop:
        exec:
          command:
          - sh
          - -c
          - |
            # ä»æœåŠ¡æ³¨å†Œä¸­å¿ƒæ³¨é”€
            curl -X DELETE http://registry:8080/unregister/${POD_IP}
            # ä¼˜é›…å…³é—­nginx
            nginx -s quit
            # ç­‰å¾…ç°æœ‰è¿æ¥å¤„ç†å®Œæˆ
            sleep 30
```

**é’©å­æ‰§è¡Œè§„åˆ™**:

1. **postStart**: 
   - åœ¨å®¹å™¨ ENTRYPOINT ä¹‹å‰æ‰§è¡Œ(ä½†ä¸ä¿è¯)
   - å¦‚æœå¤±è´¥,å®¹å™¨è¢«æ€æ­»å¹¶æ ¹æ® restartPolicy é‡å¯
   - ä¸æ¥æ”¶å‚æ•°,ä¸ä¿è¯æ‰§è¡Œé¡ºåº

2. **preStop**:
   - é˜»å¡ SIGTERM ä¿¡å·çš„å‘é€
   - è¶…æ—¶æ—¶é—´å— terminationGracePeriodSeconds é™åˆ¶
   - å¦‚æœå¤±è´¥,å®¹å™¨ä»ä¼šè¢«ç»ˆæ­¢

```bash
# éªŒè¯postStartæ‰§è¡Œ
kubectl exec lifecycle-demo -- cat /tmp/started.log
# Container started at Thu Dec 14 10:30:00 UTC 2025

# åˆ é™¤Pod,è§¦å‘preStopé’©å­
kubectl delete pod lifecycle-demo
# (preStopé’©å­ä¼šæ‰§è¡Œ,ç„¶åPodè¢«åˆ é™¤)
```


---

## 2.3 å®¹å™¨è®¾è®¡æ¨¡å¼

å¤šå®¹å™¨Podè®¾è®¡æ¨¡å¼æ˜¯Kubernetesçš„æ ¸å¿ƒè®¾è®¡ç†å¿µä¹‹ä¸€,é€šè¿‡ç»„åˆå¤šä¸ªå•ä¸€èŒè´£çš„å®¹å™¨æ¥å®ç°å¤æ‚åŠŸèƒ½ã€‚

### 2.3.1 Sidecar æ¨¡å¼ (è¾¹è½¦æ¨¡å¼)

**å®šä¹‰**: Sidecarå®¹å™¨æ‰©å±•å’Œå¢å¼ºä¸»å®¹å™¨çš„åŠŸèƒ½,ä½†ä¸æ”¹å˜ä¸»å®¹å™¨çš„æ ¸å¿ƒé€»è¾‘ã€‚

```
Sidecar æ¨¡å¼æ¶æ„:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Pod: web-app                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  ä¸»å®¹å™¨: Web Server            â”‚ â”‚
â”‚  â”‚  â€¢ ä¸“æ³¨äºä¸šåŠ¡é€»è¾‘               â”‚ â”‚
â”‚  â”‚  â€¢ ç”Ÿæˆæ—¥å¿—åˆ°å…±äº«Volume        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Sidecar: Log Collector        â”‚ â”‚
â”‚  â”‚  â€¢ è¯»å–å…±äº«Volumeä¸­çš„æ—¥å¿—      â”‚ â”‚
â”‚  â”‚  â€¢ è½¬å‘åˆ°æ—¥å¿—ä¸­å¿ƒ(ELK/Loki)   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Volume: logs (å…±äº«å­˜å‚¨)       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å®æˆ˜æ¡ˆä¾‹1: æ—¥å¿—æ”¶é›†Sidecar**

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: web-with-log-sidecar
spec:
  containers:
  # ä¸»å®¹å™¨: Nginx WebæœåŠ¡å™¨
  - name: nginx
    image: nginx:1.25
    ports:
    - containerPort: 80
    volumeMounts:
    - name: logs
      mountPath: /var/log/nginx
      
  # Sidecarå®¹å™¨: Fluentdæ—¥å¿—æ”¶é›†å™¨
  - name: fluentd
    image: fluent/fluentd:v1.16
    env:
    - name: FLUENTD_CONF
      value: fluent.conf
    volumeMounts:
    - name: logs
      mountPath: /var/log/nginx
      readOnly: true
    - name: fluentd-config
      mountPath: /fluentd/etc
      
  volumes:
  - name: logs
    emptyDir: {}
  - name: fluentd-config
    configMap:
      name: fluentd-config
---
# Fluentdé…ç½®
apiVersion: v1
kind: ConfigMap
metadata:
  name: fluentd-config
data:
  fluent.conf: |
    <source>
      @type tail
      path /var/log/nginx/access.log
      pos_file /tmp/access.log.pos
      tag nginx.access
      <parse>
        @type nginx
      </parse>
    </source>
    
    <match nginx.**>
      @type elasticsearch
      host elasticsearch.logging.svc.cluster.local
      port 9200
      logstash_format true
    </match>
```

**å®æˆ˜æ¡ˆä¾‹2: æœåŠ¡ç½‘æ ¼Sidecar (Istio Envoy)**

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: app-with-istio
  annotations:
    sidecar.istio.io/inject: "true"  # è‡ªåŠ¨æ³¨å…¥Envoy sidecar
spec:
  containers:
  # ä¸»å®¹å™¨: åº”ç”¨æœåŠ¡
  - name: app
    image: myapp:1.0
    ports:
    - containerPort: 8080
    
  # Istioè‡ªåŠ¨æ³¨å…¥çš„Envoy Sidecar (ç¤ºä¾‹,å®é™…ç”±Istioæ³¨å…¥)
  - name: istio-proxy
    image: istio/proxyv2:1.20.0
    args:
    - proxy
    - sidecar
    - --domain
    - $(POD_NAMESPACE).svc.cluster.local
    - --proxyLogLevel=warning
    - --proxyComponentLogLevel=misc:error
    env:
    - name: POD_NAME
      valueFrom:
        fieldRef:
          fieldPath: metadata.name
    - name: POD_NAMESPACE
      valueFrom:
        fieldRef:
          fieldPath: metadata.namespace
    ports:
    - containerPort: 15090
      protocol: TCP
      name: http-envoy-prom
```

**å®æˆ˜æ¡ˆä¾‹3: é…ç½®çƒ­æ›´æ–°Sidecar**

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: app-with-config-reloader
spec:
  containers:
  # ä¸»å®¹å™¨: åº”ç”¨
  - name: app
    image: myapp:1.0
    volumeMounts:
    - name: config
      mountPath: /etc/config
      
  # Sidecar: é…ç½®çƒ­æ›´æ–°
  - name: config-reloader
    image: jimmidyson/configmap-reload:v0.8.0
    args:
    - --volume-dir=/etc/config
    - --webhook-url=http://localhost:8080/reload
    volumeMounts:
    - name: config
      mountPath: /etc/config
      
  volumes:
  - name: config
    configMap:
      name: app-config
```

### 2.3.2 Ambassador æ¨¡å¼ (å¤§ä½¿æ¨¡å¼)

**å®šä¹‰**: Ambassadorå®¹å™¨ä»£ç†ä¸»å®¹å™¨ä¸å¤–éƒ¨æœåŠ¡çš„é€šä¿¡,ç®€åŒ–ä¸»å®¹å™¨çš„ç½‘ç»œé€»è¾‘ã€‚

```
Ambassador æ¨¡å¼æ¶æ„:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Pod: database-client                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  ä¸»å®¹å™¨: App                     â”‚ â”‚
â”‚  â”‚  â€¢ è¿æ¥localhost:5432 (ç®€åŒ–é€»è¾‘)â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚            â†“ localhosté€šä¿¡             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Ambassador: DB Proxy            â”‚ â”‚
â”‚  â”‚  â€¢ ç›‘å¬localhost:5432            â”‚ â”‚
â”‚  â”‚  â€¢ è¿æ¥åˆ°å®é™…æ•°æ®åº“é›†ç¾¤          â”‚ â”‚
â”‚  â”‚  â€¢ å¤„ç†TLS/è®¤è¯/é‡è¯•/è´Ÿè½½å‡è¡¡    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“ å¤–éƒ¨ç½‘ç»œ
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  PostgreSQL Cluster  â”‚
    â”‚  â€¢ Master: db-1      â”‚
    â”‚  â€¢ Replica: db-2     â”‚
    â”‚  â€¢ Replica: db-3     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å®æˆ˜æ¡ˆä¾‹1: PostgreSQL Ambassador**

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: app-with-db-ambassador
spec:
  containers:
  # ä¸»å®¹å™¨: åº”ç”¨ (ç®€åŒ–æ•°æ®åº“è¿æ¥é€»è¾‘)
  - name: app
    image: myapp:1.0
    env:
    - name: DATABASE_URL
      value: "postgresql://localhost:5432/mydb"  # è¿æ¥localhost
      
  # Ambassadorå®¹å™¨: PostgreSQLä»£ç†
  - name: postgres-ambassador
    image: haproxy:2.8
    ports:
    - containerPort: 5432
    volumeMounts:
    - name: haproxy-config
      mountPath: /usr/local/etc/haproxy
      
  volumes:
  - name: haproxy-config
    configMap:
      name: postgres-haproxy-config
---
# HAProxyé…ç½® (è´Ÿè½½å‡è¡¡åˆ°å¤šä¸ªPGå®ä¾‹)
apiVersion: v1
kind: ConfigMap
metadata:
  name: postgres-haproxy-config
data:
  haproxy.cfg: |
    global
        maxconn 256
        
    defaults
        mode tcp
        timeout connect 5000ms
        timeout client 50000ms
        timeout server 50000ms
        
    frontend postgres
        bind *:5432
        default_backend postgres_backend
        
    backend postgres_backend
        balance roundrobin
        server pg1 postgres-master.default.svc.cluster.local:5432 check
        server pg2 postgres-replica-1.default.svc.cluster.local:5432 check backup
        server pg3 postgres-replica-2.default.svc.cluster.local:5432 check backup
```

**å®æˆ˜æ¡ˆä¾‹2: Redis Ambassador (Sentinel)**

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: app-with-redis-ambassador
spec:
  containers:
  # ä¸»å®¹å™¨: åº”ç”¨
  - name: app
    image: myapp:1.0
    env:
    - name: REDIS_URL
      value: "redis://localhost:6379"
      
  # Ambassador: Redis Sentinelå®¢æˆ·ç«¯
  - name: redis-ambassador
    image: bitnami/redis-sentinel:7.2
    env:
    - name: REDIS_SENTINEL_HOST
      value: redis-sentinel.default.svc.cluster.local
    - name: REDIS_SENTINEL_PORT
      value: "26379"
    - name: REDIS_MASTER_SET
      value: mymaster
    ports:
    - containerPort: 6379
```

### 2.3.3 Adapter æ¨¡å¼ (é€‚é…å™¨æ¨¡å¼)

**å®šä¹‰**: Adapterå®¹å™¨å°†ä¸»å®¹å™¨çš„è¾“å‡ºè½¬æ¢ä¸ºæ ‡å‡†åŒ–æ ¼å¼,ä¾¿äºå¤–éƒ¨ç³»ç»Ÿå¤„ç†ã€‚

```
Adapter æ¨¡å¼æ¶æ„:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Pod: legacy-app                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  ä¸»å®¹å™¨: Legacy App              â”‚ â”‚
â”‚  â”‚  â€¢ ç”Ÿæˆè‡ªå®šä¹‰æ ¼å¼çš„æ—¥å¿—/æŒ‡æ ‡     â”‚ â”‚
â”‚  â”‚  â€¢ ä¸æ”¯æŒPrometheusæ ¼å¼          â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚            â†“ å…±äº«Volume                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Adapter: Metrics Exporter       â”‚ â”‚
â”‚  â”‚  â€¢ è¯»å–è‡ªå®šä¹‰æ ¼å¼æ•°æ®            â”‚ â”‚
â”‚  â”‚  â€¢ è½¬æ¢ä¸ºPrometheusæ ¼å¼          â”‚ â”‚
â”‚  â”‚  â€¢ æš´éœ² :9090/metrics ç«¯ç‚¹       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“ HTTP
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Prometheus          â”‚
    â”‚  æŠ“å–æ ‡å‡†metrics     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å®æˆ˜æ¡ˆä¾‹1: Prometheus Metrics Adapter**

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: legacy-app-with-adapter
  annotations:
    prometheus.io/scrape: "true"
    prometheus.io/port: "9090"
spec:
  containers:
  # ä¸»å®¹å™¨: æ—§ç‰ˆåº”ç”¨ (è¾“å‡ºè‡ªå®šä¹‰æ ¼å¼æŒ‡æ ‡)
  - name: legacy-app
    image: legacy-app:1.0
    volumeMounts:
    - name: metrics
      mountPath: /var/metrics
      
  # Adapterå®¹å™¨: æŒ‡æ ‡æ ¼å¼è½¬æ¢
  - name: metrics-adapter
    image: prom/statsd-exporter:v0.24.0
    args:
    - --statsd.mapping-config=/etc/statsd-mapping.yml
    ports:
    - containerPort: 9090
      name: metrics
    - containerPort: 9125
      name: statsd
      protocol: UDP
    volumeMounts:
    - name: adapter-config
      mountPath: /etc
      
  volumes:
  - name: metrics
    emptyDir: {}
  - name: adapter-config
    configMap:
      name: statsd-mapping
---
# StatsDæ˜ å°„é…ç½®
apiVersion: v1
kind: ConfigMap
metadata:
  name: statsd-mapping
data:
  statsd-mapping.yml: |
    mappings:
    - match: "legacy.app.requests.*.*"
      name: "legacy_app_requests_total"
      labels:
        method: "$1"
        status: "$2"
```

**å®æˆ˜æ¡ˆä¾‹2: æ—¥å¿—æ ¼å¼é€‚é…å™¨**

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: app-with-log-adapter
spec:
  containers:
  # ä¸»å®¹å™¨: åº”ç”¨ (è¾“å‡ºéJSONæ—¥å¿—)
  - name: app
    image: myapp:1.0
    volumeMounts:
    - name: logs
      mountPath: /var/log/app
      
  # Adapter: æ—¥å¿—æ ¼å¼è½¬æ¢ (éJSON â†’ JSON)
  - name: log-adapter
    image: busybox
    command:
    - sh
    - -c
    - |
      tail -f /logs/app.log | while read line; do
        timestamp=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
        echo "{\"timestamp\":\"$timestamp\",\"message\":\"$line\"}" >> /logs/app-json.log
      done
    volumeMounts:
    - name: logs
      mountPath: /logs
      
  # Sidecar: æ—¥å¿—æ”¶é›† (æ”¶é›†JSONæ ¼å¼æ—¥å¿—)
  - name: fluentd
    image: fluent/fluentd:v1.16
    volumeMounts:
    - name: logs
      mountPath: /logs
      readOnly: true
      
  volumes:
  - name: logs
    emptyDir: {}
```

**ä¸‰ç§æ¨¡å¼å¯¹æ¯”**:

| æ¨¡å¼ | èŒè´£ | é€‚ç”¨åœºæ™¯ | ç¤ºä¾‹ |
|------|------|---------|------|
| **Sidecar** | æ‰©å±•åŠŸèƒ½ | æ—¥å¿—æ”¶é›†ã€ç›‘æ§ã€æœåŠ¡ç½‘æ ¼ | Fluentd, Envoy, Prometheus Exporter |
| **Ambassador** | ä»£ç†é€šä¿¡ | ç®€åŒ–å¤–éƒ¨æœåŠ¡è®¿é—®ã€TLSç»ˆæ­¢ | HAProxy, Redis Sentinel |
| **Adapter** | æ ¼å¼è½¬æ¢ | æ ‡å‡†åŒ–è¾“å‡ºã€åè®®é€‚é… | StatsD Exporter, Log Formatter |


---

## 2.4 Init å®¹å™¨

### 2.4.1 Init å®¹å™¨åŸºç¡€

**å®šä¹‰**: Initå®¹å™¨æ˜¯åœ¨ä¸»å®¹å™¨å¯åŠ¨å‰è¿è¡Œçš„ç‰¹æ®Šå®¹å™¨,ç”¨äºæ‰§è¡Œåˆå§‹åŒ–ä»»åŠ¡ã€‚

```
Init å®¹å™¨æ‰§è¡Œæµç¨‹:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. åˆ›å»ºPodæ²™ç®± (Pauseå®¹å™¨)          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. æŒ‰é¡ºåºæ‰§è¡ŒInitå®¹å™¨               â”‚
â”‚     Init-1 â†’ æˆåŠŸ â†’ Init-2 â†’ æˆåŠŸ   â”‚
â”‚     (ä»»ä½•ä¸€ä¸ªå¤±è´¥,æ•´ä¸ªPodå¤±è´¥)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. æ‰€æœ‰Initå®¹å™¨æˆåŠŸåå¯åŠ¨ä¸»å®¹å™¨     â”‚
â”‚     å¹¶è¡Œå¯åŠ¨æ‰€æœ‰ä¸šåŠ¡å®¹å™¨             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Init å®¹å™¨ç‰¹æ€§**:

1. **é¡ºåºæ‰§è¡Œ**: æŒ‰å®šä¹‰é¡ºåºä¾æ¬¡æ‰§è¡Œ,ä¸€ä¸ªæˆåŠŸåæ‰æ‰§è¡Œä¸‹ä¸€ä¸ª
2. **å¿…é¡»æˆåŠŸ**: æ‰€æœ‰Initå®¹å™¨å¿…é¡»æˆåŠŸ,Podæ‰ä¼šå¯åŠ¨ä¸»å®¹å™¨
3. **ç‹¬ç«‹é•œåƒ**: å¯ä½¿ç”¨ä¸ä¸»å®¹å™¨ä¸åŒçš„é•œåƒ
4. **èµ„æºå…±äº«**: å¯è®¿é—®ä¸»å®¹å™¨çš„Volume
5. **ä¸æ”¯æŒæ¢é’ˆ**: Initå®¹å™¨ä¸æ”¯æŒå¥åº·æ£€æŸ¥æ¢é’ˆ

**å®æˆ˜æ¡ˆä¾‹1: ç­‰å¾…ä¾èµ–æœåŠ¡å°±ç»ª**

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: web-with-init
spec:
  # Initå®¹å™¨: ç­‰å¾…æ•°æ®åº“å°±ç»ª
  initContainers:
  - name: wait-for-db
    image: busybox:1.36
    command:
    - sh
    - -c
    - |
      until nslookup postgres.default.svc.cluster.local; do
        echo "ç­‰å¾…PostgreSQL DNSå°±ç»ª..."
        sleep 2
      done
      until nc -z postgres.default.svc.cluster.local 5432; do
        echo "ç­‰å¾…PostgreSQLç«¯å£5432å¼€æ”¾..."
        sleep 2
      done
      echo "PostgreSQLå·²å°±ç»ª!"
      
  - name: wait-for-redis
    image: busybox:1.36
    command:
    - sh
    - -c
    - |
      until nc -z redis.default.svc.cluster.local 6379; do
        echo "ç­‰å¾…Redis..."
        sleep 2
      done
      echo "Rediså·²å°±ç»ª!"
      
  # ä¸»å®¹å™¨: Webåº”ç”¨
  containers:
  - name: web
    image: myapp:1.0
    env:
    - name: DATABASE_URL
      value: "postgresql://postgres.default.svc.cluster.local:5432/mydb"
    - name: REDIS_URL
      value: "redis://redis.default.svc.cluster.local:6379"
```

**å®æˆ˜æ¡ˆä¾‹2: æ•°æ®åº“è¿ç§»**

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: app-with-migration
spec:
  initContainers:
  # Initå®¹å™¨1: æ‰§è¡Œæ•°æ®åº“è¿ç§»
  - name: db-migration
    image: myapp:1.0
    command: ["python", "manage.py", "migrate"]
    env:
    - name: DATABASE_URL
      valueFrom:
        secretKeyRef:
          name: db-secret
          key: url
          
  # Initå®¹å™¨2: åˆ›å»ºåˆå§‹ç®¡ç†å‘˜ç”¨æˆ·
  - name: create-admin
    image: myapp:1.0
    command:
    - sh
    - -c
    - |
      python manage.py createsuperuser \
        --username admin \
        --email admin@example.com \
        --noinput || true
    env:
    - name: DJANGO_SUPERUSER_PASSWORD
      valueFrom:
        secretKeyRef:
          name: admin-secret
          key: password
          
  containers:
  - name: app
    image: myapp:1.0
    ports:
    - containerPort: 8080
```

**å®æˆ˜æ¡ˆä¾‹3: ä¸‹è½½é…ç½®æ–‡ä»¶**

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: app-with-config-init
spec:
  initContainers:
  # Initå®¹å™¨: ä»S3ä¸‹è½½é…ç½®æ–‡ä»¶
  - name: download-config
    image: amazon/aws-cli:2.13.0
    command:
    - sh
    - -c
    - |
      aws s3 cp s3://my-bucket/config/ /config/ --recursive
      echo "é…ç½®æ–‡ä»¶ä¸‹è½½å®Œæˆ"
    env:
    - name: AWS_ACCESS_KEY_ID
      valueFrom:
        secretKeyRef:
          name: aws-credentials
          key: access_key
    - name: AWS_SECRET_ACCESS_KEY
      valueFrom:
        secretKeyRef:
          name: aws-credentials
          key: secret_key
    volumeMounts:
    - name: config
      mountPath: /config
      
  containers:
  - name: app
    image: myapp:1.0
    volumeMounts:
    - name: config
      mountPath: /etc/config
      readOnly: true
      
  volumes:
  - name: config
    emptyDir: {}
```

**æŸ¥çœ‹Initå®¹å™¨çŠ¶æ€**:

```bash
# æŸ¥çœ‹PodçŠ¶æ€ (å¦‚æœInitå®¹å™¨æœªå®Œæˆ,Podä¼šæ˜¾ç¤ºInit:0/2)
kubectl get pod web-with-init
# NAME            READY   STATUS     RESTARTS   AGE
# web-with-init   0/1     Init:0/2   0          10s

# æŸ¥çœ‹Initå®¹å™¨æ—¥å¿—
kubectl logs web-with-init -c wait-for-db
# ç­‰å¾…PostgreSQL DNSå°±ç»ª...
# ç­‰å¾…PostgreSQLç«¯å£5432å¼€æ”¾...
# PostgreSQLå·²å°±ç»ª!

# æŸ¥çœ‹Podè¯¦æƒ… (åŒ…å«Initå®¹å™¨çŠ¶æ€)
kubectl describe pod web-with-init

# è¾“å‡ºç¤ºä¾‹:
Init Containers:
  wait-for-db:
    State:      Terminated
      Reason:   Completed
      Exit Code: 0
  wait-for-redis:
    State:      Running
```

---

## 2.5 å¥åº·æ£€æŸ¥

Kubernetes æä¾›ä¸‰ç§æ¢é’ˆ (Probe) æ¥æ£€æµ‹å®¹å™¨å¥åº·çŠ¶æ€ã€‚

### 2.5.1 ä¸‰ç§æ¢é’ˆå¯¹æ¯”

| æ¢é’ˆç±»å‹ | ç”¨é€” | å¤±è´¥åè¡Œä¸º | é€‚ç”¨åœºæ™¯ |
|---------|------|-----------|---------|
| **Liveness Probe** | æ£€æµ‹å®¹å™¨æ˜¯å¦å­˜æ´» | é‡å¯å®¹å™¨ | æ£€æµ‹æ­»é”ã€æ— é™å¾ªç¯ |
| **Readiness Probe** | æ£€æµ‹å®¹å™¨æ˜¯å¦å°±ç»ª | ä»Serviceç§»é™¤ | ç­‰å¾…ä¾èµ–æœåŠ¡ã€é¢„çƒ­ |
| **Startup Probe** | æ£€æµ‹å®¹å™¨æ˜¯å¦å¯åŠ¨å®Œæˆ | é‡å¯å®¹å™¨ | æ…¢å¯åŠ¨åº”ç”¨ (JVM/å¤§æ•°æ®) |

```
æ¢é’ˆæ‰§è¡Œæ—¶åº:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å®¹å™¨å¯åŠ¨                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Startup Probe (å¦‚æœé…ç½®)                   â”‚
â”‚  â€¢ ç¦ç”¨Liveness/Readiness Probe             â”‚
â”‚  â€¢ æœ€å¤šç­‰å¾… failureThreshold * periodSecondsâ”‚
â”‚  â€¢ æˆåŠŸåä¸å†æ‰§è¡Œ                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â†“ æˆåŠŸ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Liveness Probe + Readiness Probe           â”‚
â”‚  â€¢ å¹¶è¡Œå‘¨æœŸæ€§æ‰§è¡Œ                           â”‚
â”‚  â€¢ è´¯ç©¿å®¹å™¨æ•´ä¸ªç”Ÿå‘½å‘¨æœŸ                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.5.2 Liveness Probe (å­˜æ´»æ¢é’ˆ)

**ä½œç”¨**: æ£€æµ‹å®¹å™¨æ˜¯å¦å¤„äºè¿è¡ŒçŠ¶æ€,å¤±è´¥å kubelet ä¼šé‡å¯å®¹å™¨ã€‚

**ä¸‰ç§æ¢æµ‹æ–¹å¼**:

**æ–¹å¼1: HTTP GET**

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: liveness-http
spec:
  containers:
  - name: web
    image: nginx:1.25
    ports:
    - containerPort: 80
    livenessProbe:
      httpGet:
        path: /healthz        # å¥åº·æ£€æŸ¥ç«¯ç‚¹
        port: 80
        httpHeaders:
        - name: Custom-Header
          value: Awesome
        scheme: HTTP          # HTTP æˆ– HTTPS
      initialDelaySeconds: 3  # å®¹å™¨å¯åŠ¨å3ç§’å¼€å§‹æ¢æµ‹
      periodSeconds: 3         # æ¯3ç§’æ¢æµ‹ä¸€æ¬¡
      timeoutSeconds: 1        # æ¢æµ‹è¶…æ—¶1ç§’
      successThreshold: 1      # è¿ç»­æˆåŠŸ1æ¬¡è§†ä¸ºå¥åº·
      failureThreshold: 3      # è¿ç»­å¤±è´¥3æ¬¡è§†ä¸ºä¸å¥åº· â†’ é‡å¯
```

**æ–¹å¼2: TCP Socket**

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: liveness-tcp
spec:
  containers:
  - name: redis
    image: redis:7.2
    ports:
    - containerPort: 6379
    livenessProbe:
      tcpSocket:
        port: 6379
      initialDelaySeconds: 15
      periodSeconds: 20
      timeoutSeconds: 5
      failureThreshold: 3
```

**æ–¹å¼3: Exec Command**

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: liveness-exec
spec:
  containers:
  - name: app
    image: myapp:1.0
    livenessProbe:
      exec:
        command:
        - cat
        - /tmp/healthy
      initialDelaySeconds: 5
      periodSeconds: 5
      failureThreshold: 3
```

**å®æˆ˜æ¡ˆä¾‹: è‡ªå®šä¹‰å¥åº·æ£€æŸ¥ç«¯ç‚¹**

```python
# Python Flaskåº”ç”¨å¥åº·æ£€æŸ¥ç«¯ç‚¹
from flask import Flask, jsonify
import psutil
import redis

app = Flask(__name__)

@app.route('/healthz')
def healthz():
    """Livenesså¥åº·æ£€æŸ¥: æ£€æµ‹åº”ç”¨æ˜¯å¦å­˜æ´»"""
    try:
        # æ£€æŸ¥è¿›ç¨‹æ˜¯å¦æ­£å¸¸
        cpu_percent = psutil.cpu_percent(interval=1)
        if cpu_percent > 95:
            return jsonify({"status": "unhealthy", "reason": "CPU overload"}), 500
        
        # æ£€æŸ¥æ˜¯å¦æ­»é”
        # ... (è‡ªå®šä¹‰é€»è¾‘)
        
        return jsonify({"status": "ok"}), 200
    except Exception as e:
        return jsonify({"status": "error", "message": str(e)}), 500

@app.route('/ready')
def ready():
    """Readinesså¥åº·æ£€æŸ¥: æ£€æµ‹åº”ç”¨æ˜¯å¦å°±ç»ª"""
    try:
        # æ£€æŸ¥æ•°æ®åº“è¿æ¥
        # db.execute("SELECT 1")
        
        # æ£€æŸ¥Redisè¿æ¥
        r = redis.Redis(host='redis', port=6379)
        r.ping()
        
        # æ£€æŸ¥ä¾èµ–æœåŠ¡
        # ...
        
        return jsonify({"status": "ready"}), 200
    except Exception as e:
        return jsonify({"status": "not ready", "message": str(e)}), 503

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=8080)
```

### 2.5.3 Readiness Probe (å°±ç»ªæ¢é’ˆ)

**ä½œç”¨**: æ£€æµ‹å®¹å™¨æ˜¯å¦å‡†å¤‡å¥½æ¥æ”¶æµé‡,å¤±è´¥åä» Service çš„ Endpoints ä¸­ç§»é™¤ã€‚

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: readiness-http
spec:
  containers:
  - name: web
    image: nginx:1.25
    ports:
    - containerPort: 80
    readinessProbe:
      httpGet:
        path: /ready
        port: 80
      initialDelaySeconds: 5
      periodSeconds: 5
      timeoutSeconds: 2
      successThreshold: 1      # è¿ç»­æˆåŠŸ1æ¬¡ â†’ åŠ å…¥Service
      failureThreshold: 3      # è¿ç»­å¤±è´¥3æ¬¡ â†’ ä»Serviceç§»é™¤
```

**Liveness vs Readiness ä½¿ç”¨åœºæ™¯**:

| åœºæ™¯ | ä½¿ç”¨æ¢é’ˆ | åŸå›  |
|------|---------|------|
| åº”ç”¨æ­»é”/æ— é™å¾ªç¯ | Liveness | éœ€è¦é‡å¯å®¹å™¨ |
| ç­‰å¾…æ•°æ®åº“è¿æ¥æ± é¢„çƒ­ | Readiness | ä¸åº”æ¥æ”¶æµé‡,ä½†æ— éœ€é‡å¯ |
| åº”ç”¨æ­£åœ¨åŠ è½½å¤§æ–‡ä»¶ | Readiness | åŠ è½½å®Œæˆå‰ä¸åº”æ¥æ”¶æµé‡ |
| ä¾èµ–æœåŠ¡(Redis)æš‚æ—¶ä¸å¯ç”¨ | Readiness | ç­‰å¾…ä¾èµ–æ¢å¤,æ— éœ€é‡å¯ |
| JVM OutOfMemory | Liveness | éœ€è¦é‡å¯å®¹å™¨é‡Šæ”¾èµ„æº |

```yaml
# åŒæ—¶ä½¿ç”¨Livenesså’ŒReadiness (æ¨è)
apiVersion: v1
kind: Pod
metadata:
  name: web-with-probes
spec:
  containers:
  - name: web
    image: myapp:1.0
    ports:
    - containerPort: 8080
    # Liveness: æ£€æµ‹åº”ç”¨æ˜¯å¦æ­»é”
    livenessProbe:
      httpGet:
        path: /healthz
        port: 8080
      initialDelaySeconds: 30
      periodSeconds: 10
      timeoutSeconds: 5
      failureThreshold: 3
    # Readiness: æ£€æµ‹åº”ç”¨æ˜¯å¦å°±ç»ª
    readinessProbe:
      httpGet:
        path: /ready
        port: 8080
      initialDelaySeconds: 5
      periodSeconds: 5
      timeoutSeconds: 2
      failureThreshold: 3
```

### 2.5.4 Startup Probe (å¯åŠ¨æ¢é’ˆ)

**ä½œç”¨**: ç»™æ…¢å¯åŠ¨åº”ç”¨æ›´å¤šæ—¶é—´,å¯åŠ¨æœŸé—´ç¦ç”¨ Liveness/Readiness Probeã€‚

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: slow-start-app
spec:
  containers:
  - name: java-app
    image: openjdk:17-jdk
    ports:
    - containerPort: 8080
    # Startup Probe: æœ€å¤šç­‰å¾… 30æ¬¡ * 10ç§’ = 5åˆ†é’Ÿ
    startupProbe:
      httpGet:
        path: /startup
        port: 8080
      initialDelaySeconds: 0
      periodSeconds: 10
      timeoutSeconds: 3
      failureThreshold: 30     # æœ€å¤šå¤±è´¥30æ¬¡ (5åˆ†é’Ÿ)
      successThreshold: 1
    # Liveness Probe: StartupæˆåŠŸåæ‰å¼€å§‹æ‰§è¡Œ
    livenessProbe:
      httpGet:
        path: /healthz
        port: 8080
      periodSeconds: 10
      timeoutSeconds: 5
      failureThreshold: 3
    # Readiness Probe
    readinessProbe:
      httpGet:
        path: /ready
        port: 8080
      periodSeconds: 5
      failureThreshold: 3
```

**æ²¡æœ‰ Startup Probe çš„é—®é¢˜**:

```yaml
# âŒ é—®é¢˜ç¤ºä¾‹: JVMåº”ç”¨å¯åŠ¨éœ€è¦2åˆ†é’Ÿ,ä½†Livenessé…ç½®ä¸å½“
apiVersion: v1
kind: Pod
metadata:
  name: java-app-wrong
spec:
  containers:
  - name: app
    image: java-app:1.0
    livenessProbe:
      httpGet:
        path: /healthz
        port: 8080
      initialDelaySeconds: 30  # å¯åŠ¨å30ç§’å¼€å§‹æ¢æµ‹
      periodSeconds: 10
      failureThreshold: 3      # å¤±è´¥3æ¬¡é‡å¯ (30ç§’)
# é—®é¢˜: JVMå¯åŠ¨éœ€è¦2åˆ†é’Ÿ,ä½†æ¢é’ˆåœ¨30ç§’åå°±å¼€å§‹æ£€æµ‹
# ç»“æœ: å®¹å™¨å¯åŠ¨60ç§’åè¢«åˆ¤å®šå¤±è´¥ â†’ é‡å¯ â†’ å†æ¬¡å¤±è´¥ â†’ æ— é™é‡å¯å¾ªç¯

# âœ… æ­£ç¡®ç¤ºä¾‹: ä½¿ç”¨Startup Probe
apiVersion: v1
kind: Pod
metadata:
  name: java-app-correct
spec:
  containers:
  - name: app
    image: java-app:1.0
    startupProbe:              # ç»™å¯åŠ¨é¢„ç•™è¶³å¤Ÿæ—¶é—´
      httpGet:
        path: /startup
        port: 8080
      periodSeconds: 10
      failureThreshold: 18     # æœ€å¤šç­‰å¾…3åˆ†é’Ÿ
    livenessProbe:             # å¯åŠ¨åæ‰æ‰§è¡Œ
      httpGet:
        path: /healthz
        port: 8080
      periodSeconds: 10
      failureThreshold: 3
```

**æ¢é’ˆå‚æ•°é…ç½®å»ºè®®**:

```yaml
# ç”Ÿäº§ç¯å¢ƒæ¨èé…ç½®
livenessProbe:
  httpGet:
    path: /healthz
    port: 8080
  initialDelaySeconds: 30    # æ ¹æ®åº”ç”¨å¯åŠ¨æ—¶é—´è°ƒæ•´
  periodSeconds: 10          # ä¸è¦å¤ªé¢‘ç¹,é¿å…å½±å“æ€§èƒ½
  timeoutSeconds: 5          # ç»™ç½‘ç»œä¸€äº›å®¹é”™æ—¶é—´
  successThreshold: 1        # Livenesså›ºå®šä¸º1
  failureThreshold: 3        # å…è®¸å¶å°”å¤±è´¥,é¿å…è¯¯æ€

readinessProbe:
  httpGet:
    path: /ready
    port: 8080
  initialDelaySeconds: 5     # å¯ä»¥æ¯”Livenessæ—©å¼€å§‹
  periodSeconds: 5           # å¯ä»¥æ›´é¢‘ç¹,å¿«é€Ÿååº”æµé‡
  timeoutSeconds: 2
  successThreshold: 1        # å¿«é€Ÿæ ‡è®°ä¸ºå°±ç»ª
  failureThreshold: 3        # å…è®¸æš‚æ—¶æ€§å¤±è´¥

startupProbe:  # ä»…æ…¢å¯åŠ¨åº”ç”¨éœ€è¦
  httpGet:
    path: /startup
    port: 8080
  periodSeconds: 10
  failureThreshold: 30       # æ ¹æ®æœ€æ…¢å¯åŠ¨æ—¶é—´è®¾ç½®
  timeoutSeconds: 3
```


---

## 2.6 èµ„æºç®¡ç†ä¸ QoS

### 2.6.1 èµ„æº requests ä¸ limits

**å®šä¹‰**:

- **requests**: å®¹å™¨**ä¿è¯è·å¾—**çš„æœ€å°èµ„æºé‡,ç”¨äºè°ƒåº¦å†³ç­–
- **limits**: å®¹å™¨**æœ€å¤šä½¿ç”¨**çš„æœ€å¤§èµ„æºé‡,ç”¨äºèµ„æºé™åˆ¶

```
èµ„æºç®¡ç†åŸç†:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Nodeèµ„æºæ±  (8æ ¸CPU, 16GBå†…å­˜)            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Pod-1                               â”‚  â”‚
â”‚  â”‚ requests: CPU=1æ ¸, Mem=2GB          â”‚  â”‚
â”‚  â”‚ limits:   CPU=2æ ¸, Mem=4GB          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚         â†“ è°ƒåº¦å†³ç­–åŸºäº requests           â”‚
â”‚         â†“ è¿è¡Œæ—¶é™åˆ¶åŸºäº limits            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Pod-2                               â”‚  â”‚
â”‚  â”‚ requests: CPU=2æ ¸, Mem=4GB          â”‚  â”‚
â”‚  â”‚ limits:   CPU=3æ ¸, Mem=8GB          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                           â”‚
â”‚  å·²åˆ†é… requests: 3æ ¸CPU, 6GBå†…å­˜         â”‚
â”‚  å‰©ä½™å¯åˆ†é…:      5æ ¸CPU, 10GBå†…å­˜        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ç¤ºä¾‹é…ç½®**:

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: resource-demo
spec:
  containers:
  - name: app
    image: nginx:1.25
    resources:
      # requests: è°ƒåº¦æ—¶ä¿è¯çš„èµ„æº
      requests:
        cpu: 500m        # 0.5æ ¸ (500 millicores)
        memory: 512Mi    # 512 MiB
        ephemeral-storage: 1Gi  # ä¸´æ—¶å­˜å‚¨
      # limits: è¿è¡Œæ—¶é™åˆ¶çš„æœ€å¤§èµ„æº
      limits:
        cpu: 1000m       # 1æ ¸
        memory: 1Gi      # 1 GiB
        ephemeral-storage: 2Gi
```

**CPU èµ„æºå•ä½**:

```yaml
# CPUå¯ä»¥ç”¨å°æ•°æˆ–æ¯«æ ¸(millicores)è¡¨ç¤º
cpu: 1      # 1æ ¸
cpu: 0.5    # 0.5æ ¸
cpu: 500m   # 500æ¯«æ ¸ = 0.5æ ¸
cpu: 100m   # 0.1æ ¸ (æœ€å°å»ºè®®å€¼)

# CPUæ˜¯å¯å‹ç¼©èµ„æº:
# - è¶…è¿‡limitsæ—¶: è¿›ç¨‹è¢«throttle (CPUé™æµ,å˜æ…¢)
# - ä¸ä¼šè¢«æ€æ­»: åªæ˜¯CPUæ—¶é—´ç‰‡è¢«é™åˆ¶
```

**å†…å­˜èµ„æºå•ä½**:

```yaml
# å†…å­˜å•ä½æ”¯æŒ: E, P, T, G, M, K (1000è¿›åˆ¶) æˆ– Ei, Pi, Ti, Gi, Mi, Ki (1024è¿›åˆ¶)
memory: 1Gi      # 1 GiB = 1024 MiB = 1073741824 bytes
memory: 1G       # 1 GB  = 1000 MB  = 1000000000 bytes
memory: 512Mi    # 512 MiB
memory: 512M     # 512 MB

# å†…å­˜æ˜¯ä¸å¯å‹ç¼©èµ„æº:
# - è¶…è¿‡limitsæ—¶: è¿›ç¨‹è¢«OOM Killed (æ€æ­»)
# - Podé‡å¯ç­–ç•¥å†³å®šæ˜¯å¦é‡å¯
```

**requests vs limits è¡Œä¸ºå·®å¼‚**:

| èµ„æºç±»å‹ | æ—  requests | æ—  limits | requests < limits | requests = limits |
|---------|------------|----------|------------------|------------------|
| **CPU** | æœ€ä½ä¼˜å…ˆçº§è°ƒåº¦ | æ— é™åˆ¶(å¯èƒ½å½±å“å…¶ä»–Pod) | å¯çªå‘ä½¿ç”¨(burst) | å›ºå®šé…é¢ |
| **å†…å­˜** | æœ€ä½ä¼˜å…ˆçº§è°ƒåº¦ | OOMé£é™©é«˜ | å¯çªå‘ä½¿ç”¨(OOMé£é™©) | å›ºå®šé…é¢(æœ€å®‰å…¨) |


### 2.6.2 QoS (æœåŠ¡è´¨é‡ç­‰çº§)

Kubernetesæ ¹æ® requests å’Œ limits çš„é…ç½®è‡ªåŠ¨ä¸ºPodåˆ†é… QoS ç­‰çº§,ç”¨äºèµ„æºç´§å¼ æ—¶çš„é©±é€å†³ç­–ã€‚

**ä¸‰ç§ QoS ç­‰çº§**:

```
QoS ç­‰çº§ä¼˜å…ˆçº§ (èµ„æºä¸è¶³æ—¶é©±é€é¡ºåº):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. BestEffort (æœ€å…ˆè¢«é©±é€)            â”‚
â”‚     æ—  requests, æ—  limits             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  2. Burstable (ä¸­ç­‰ä¼˜å…ˆçº§)             â”‚
â”‚     æœ‰ requests, requests < limits     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  3. Guaranteed (æœ€åè¢«é©±é€)            â”‚
â”‚     requests = limits                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### **1. Guaranteed (æœ€é«˜ä¼˜å…ˆçº§)**

**æ¡ä»¶** (æ‰€æœ‰å®¹å™¨å¿…é¡»æ»¡è¶³):
1. è®¾ç½®äº† CPU å’Œ Memory çš„ requests å’Œ limits
2. requests = limits (CPUå’Œå†…å­˜éƒ½ç›¸ç­‰)

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: qos-guaranteed
spec:
  containers:
  - name: app
    image: nginx:1.25
    resources:
      requests:
        cpu: 1000m
        memory: 1Gi
      limits:
        cpu: 1000m      # ä¸requestsç›¸ç­‰
        memory: 1Gi     # ä¸requestsç›¸ç­‰
```

**ç‰¹ç‚¹**:
- âœ… èµ„æºå®Œå…¨ä¿è¯,ä¸ä¼šè¢«æŠ¢å 
- âœ… èµ„æºä¸è¶³æ—¶æœ€åè¢«é©±é€
- âœ… OOM Killer ä¼˜å…ˆçº§æœ€ä½
- ğŸ¯ é€‚ç”¨äº:æ•°æ®åº“ã€ç¼“å­˜ã€æ ¸å¿ƒä¸šåŠ¡æœåŠ¡


#### **2. Burstable (ä¸­ç­‰ä¼˜å…ˆçº§)**

**æ¡ä»¶**:
1. è‡³å°‘ä¸€ä¸ªå®¹å™¨è®¾ç½®äº† requests æˆ– limits
2. ä¸æ»¡è¶³ Guaranteed æ¡ä»¶ (requests â‰  limits)

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: qos-burstable
spec:
  containers:
  - name: app
    image: nginx:1.25
    resources:
      requests:
        cpu: 500m
        memory: 512Mi
      limits:
        cpu: 2000m      # å¤§äºrequests (å¯çªå‘)
        memory: 2Gi     # å¤§äºrequests
```

**ç‰¹ç‚¹**:
- âš ï¸ ä¿è¯åŸºç¡€èµ„æº(requests),å¯çªå‘ä½¿ç”¨(limits)
- âš ï¸ èµ„æºä¸è¶³æ—¶ä¼˜å…ˆé©±é€(è¶…å‡ºrequestséƒ¨åˆ†)
- âš ï¸ OOM Killer ä¼˜å…ˆçº§ä¸­ç­‰
- ğŸ¯ é€‚ç”¨äº: Webåº”ç”¨ã€APIæœåŠ¡ã€åå°ä»»åŠ¡


#### **3. BestEffort (æœ€ä½ä¼˜å…ˆçº§)**

**æ¡ä»¶**:
- Podä¸­æ‰€æœ‰å®¹å™¨éƒ½**æ²¡æœ‰**è®¾ç½® requests å’Œ limits

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: qos-besteffort
spec:
  containers:
  - name: app
    image: nginx:1.25
    # æ—  resources é…ç½®
```

**ç‰¹ç‚¹**:
- âŒ æ— èµ„æºä¿è¯,å®Œå…¨é è¿æ°”
- âŒ èµ„æºä¸è¶³æ—¶æœ€å…ˆè¢«é©±é€
- âŒ OOM Killer ä¼˜å…ˆçº§æœ€é«˜
- ğŸ¯ é€‚ç”¨äº: æ‰¹å¤„ç†ä»»åŠ¡ã€æµ‹è¯•ç¯å¢ƒã€éå…³é”®æœåŠ¡


**QoS é©±é€åœºæ™¯ç¤ºä¾‹**:

```bash
# æŸ¥çœ‹Podçš„QoSç­‰çº§
kubectl get pod <pod-name> -o jsonpath='{.status.qosClass}'

# åœºæ™¯: Nodeå†…å­˜ä¸è¶³ (8GBå†…å­˜,å·²ä½¿ç”¨7.5GB)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Nodeå†…å­˜ä¸è¶³,kubeletè§¦å‘é©±é€               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  1. é©±é€æ‰€æœ‰BestEffort Pod (ç«‹å³)           â”‚
â”‚     â†’ pod-batch-job (BestEffort) Evicted   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  2. é©±é€è¶…å‡ºrequestsçš„Burstable Pod         â”‚
â”‚     â†’ pod-web-app (Burstable) Evicted     â”‚
â”‚        (å®é™…ä½¿ç”¨1.8GB > requests 512Mi)    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  3. å¦‚ä»ä¸è¶³,é©±é€Burstable Pod (æŒ‰ä½¿ç”¨é‡)   â”‚
â”‚     â†’ pod-api (Burstable) Evicted         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  4. æœ€åé©±é€Guaranteed Pod (æç«¯æƒ…å†µ)       â”‚
â”‚     â†’ pod-db (Guaranteed) ä¿ç•™             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```


### 2.6.3 LimitRange (èµ„æºçº¦æŸ)

**ä½œç”¨**: åœ¨ Namespace çº§åˆ«é™åˆ¶ Pod/å®¹å™¨çš„èµ„æºèŒƒå›´,é˜²æ­¢èµ„æºæ»¥ç”¨ã€‚

```yaml
apiVersion: v1
kind: LimitRange
metadata:
  name: resource-limits
  namespace: dev
spec:
  limits:
  # çº¦æŸ1: å•ä¸ªå®¹å™¨çš„èµ„æºèŒƒå›´
  - type: Container
    max:
      cpu: 2000m        # å•å®¹å™¨æœ€å¤§2æ ¸
      memory: 4Gi       # å•å®¹å™¨æœ€å¤§4GB
    min:
      cpu: 100m         # å•å®¹å™¨æœ€å°0.1æ ¸
      memory: 128Mi     # å•å®¹å™¨æœ€å°128MB
    default:            # æœªè®¾ç½®limitsæ—¶çš„é»˜è®¤å€¼
      cpu: 500m
      memory: 512Mi
    defaultRequest:     # æœªè®¾ç½®requestsæ—¶çš„é»˜è®¤å€¼
      cpu: 250m
      memory: 256Mi
    maxLimitRequestRatio:  # limits/requests æœ€å¤§æ¯”ä¾‹
      cpu: 4            # limitsæœ€å¤šæ˜¯requestsçš„4å€
      memory: 2         # limitsæœ€å¤šæ˜¯requestsçš„2å€

  # çº¦æŸ2: å•ä¸ªPodçš„èµ„æºèŒƒå›´ (æ‰€æœ‰å®¹å™¨æ€»å’Œ)
  - type: Pod
    max:
      cpu: 4000m        # å•Podæœ€å¤§4æ ¸
      memory: 8Gi       # å•Podæœ€å¤§8GB
    min:
      cpu: 200m
      memory: 256Mi

  # çº¦æŸ3: PVCå­˜å‚¨èŒƒå›´
  - type: PersistentVolumeClaim
    max:
      storage: 10Gi     # å•PVCæœ€å¤§10GB
    min:
      storage: 1Gi      # å•PVCæœ€å°1GB
```

**éªŒè¯ LimitRange**:

```bash
# åˆ›å»ºLimitRange
kubectl apply -f limitrange.yaml

# æŸ¥çœ‹LimitRange
kubectl get limitrange -n dev
kubectl describe limitrange resource-limits -n dev

# æµ‹è¯•: åˆ›å»ºè¶…é™Pod (ä¼šè¢«æ‹’ç»)
cat <<EOF | kubectl apply -f -
apiVersion: v1
kind: Pod
metadata:
  name: over-limit-pod
  namespace: dev
spec:
  containers:
  - name: app
    image: nginx
    resources:
      limits:
        cpu: 3000m    # è¶…è¿‡LimitRange.max (2000m)
        memory: 5Gi   # è¶…è¿‡LimitRange.max (4Gi)
EOF

# è¾“å‡ºé”™è¯¯:
# Error: Pod "over-limit-pod" is invalid:
#   spec.containers[0].resources.limits.cpu: Invalid value: "3":
#   must be less than or equal to 2
```


### 2.6.4 ResourceQuota (èµ„æºé…é¢)

**ä½œç”¨**: é™åˆ¶ Namespace çº§åˆ«çš„**æ€»èµ„æºä½¿ç”¨é‡**,å®ç°å¤šç§Ÿæˆ·èµ„æºéš”ç¦»ã€‚

```yaml
apiVersion: v1
kind: ResourceQuota
metadata:
  name: compute-quota
  namespace: dev
spec:
  hard:
    # è®¡ç®—èµ„æºé…é¢
    requests.cpu: 10           # Namespaceå†…æ‰€æœ‰Podçš„requests.cpuæ€»å’Œ â‰¤ 10æ ¸
    requests.memory: 20Gi      # Namespaceå†…æ‰€æœ‰Podçš„requests.memoryæ€»å’Œ â‰¤ 20GB
    limits.cpu: 20             # Namespaceå†…æ‰€æœ‰Podçš„limits.cpuæ€»å’Œ â‰¤ 20æ ¸
    limits.memory: 40Gi        # Namespaceå†…æ‰€æœ‰Podçš„limits.memoryæ€»å’Œ â‰¤ 40GB

    # å¯¹è±¡æ•°é‡é…é¢
    pods: 50                   # æœ€å¤š50ä¸ªPod
    services: 10               # æœ€å¤š10ä¸ªService
    persistentvolumeclaims: 10 # æœ€å¤š10ä¸ªPVC
    secrets: 20                # æœ€å¤š20ä¸ªSecret
    configmaps: 20             # æœ€å¤š20ä¸ªConfigMap

    # å­˜å‚¨é…é¢
    requests.storage: 100Gi    # PVCæ€»å­˜å‚¨è¯·æ±‚ â‰¤ 100GB

    # æŒ‰StorageClassé™åˆ¶
    requests.storage.ssd: 50Gi # SSDç±»å‹å­˜å‚¨ â‰¤ 50GB
```

**æŒ‰QoSç­‰çº§é™åˆ¶é…é¢**:

```yaml
apiVersion: v1
kind: ResourceQuota
metadata:
  name: qos-quota
  namespace: prod
spec:
  hard:
    # é™åˆ¶BestEffort Podæ•°é‡ (ç”Ÿäº§ç¯å¢ƒç¦æ­¢BestEffort)
    count/pods.besteffort: 0

    # é™åˆ¶Burstable Podèµ„æº
    requests.cpu.burstable: 5
    requests.memory.burstable: 10Gi

    # é™åˆ¶Guaranteed Podèµ„æº
    requests.cpu.guaranteed: 10
    requests.memory.guaranteed: 20Gi
  scopes:
  - BestEffort    # åº”ç”¨äºBestEffort Pod
  - Burstable     # åº”ç”¨äºBurstable Pod
```

**éªŒè¯ ResourceQuota**:

```bash
# åˆ›å»ºResourceQuota
kubectl apply -f resourcequota.yaml

# æŸ¥çœ‹é…é¢ä½¿ç”¨æƒ…å†µ
kubectl get resourcequota -n dev
kubectl describe resourcequota compute-quota -n dev

# è¾“å‡ºç¤ºä¾‹:
# Name:                    compute-quota
# Namespace:               dev
# Resource                 Used   Hard
# --------                 ----   ----
# limits.cpu               8      20
# limits.memory            16Gi   40Gi
# requests.cpu             4      10
# requests.memory          8Gi    20Gi
# pods                     12     50
# services                 3      10

# æµ‹è¯•: è¶…é…é¢åˆ›å»ºPod (ä¼šè¢«æ‹’ç»)
# å½“å‰å·²ä½¿ç”¨: requests.cpu=4
# å°è¯•åˆ›å»º: requests.cpu=7 (æ€»å’Œ11 > é…é¢10)
kubectl run test-pod --image=nginx \
  --requests='cpu=7,memory=10Gi' -n dev

# é”™è¯¯:
# Error: exceeded quota: compute-quota,
#   requested: requests.cpu=7,
#   used: requests.cpu=4,
#   limited: requests.cpu=10
```


### 2.6.5 ç”Ÿäº§ç¯å¢ƒèµ„æºé…ç½®æœ€ä½³å®è·µ

**1. ä¸ºæ‰€æœ‰ç”Ÿäº§Podè®¾ç½®èµ„æº**:

```yaml
# âŒ é”™è¯¯: ç”Ÿäº§ç¯å¢ƒæ— èµ„æºé™åˆ¶
apiVersion: v1
kind: Pod
metadata:
  name: bad-practice
spec:
  containers:
  - name: app
    image: myapp:1.0
  # æ— resourcesé…ç½® â†’ BestEffort (å±é™©!)

# âœ… æ­£ç¡®: ç”Ÿäº§ç¯å¢ƒå¿…é¡»è®¾ç½®resources
apiVersion: apps/v1
kind: Deployment
metadata:
  name: production-app
spec:
  replicas: 3
  selector:
    matchLabels:
      app: myapp
  template:
    metadata:
      labels:
        app: myapp
    spec:
      containers:
      - name: app
        image: myapp:1.0
        resources:
          requests:
            cpu: 500m
            memory: 512Mi
          limits:
            cpu: 1000m
            memory: 1Gi
```

**2. ä¸åŒåœºæ™¯çš„èµ„æºé…ç½®æ¨è**:

```yaml
# åœºæ™¯1: æ— çŠ¶æ€Webåº”ç”¨ (Burstable)
apiVersion: apps/v1
kind: Deployment
metadata:
  name: web-app
spec:
  template:
    spec:
      containers:
      - name: nginx
        image: nginx:1.25
        resources:
          requests:
            cpu: 100m       # åŸºç¡€CPU (ç©ºé—²æ—¶)
            memory: 128Mi   # åŸºç¡€å†…å­˜
          limits:
            cpu: 500m       # å³°å€¼CPU (å…è®¸çªå‘)
            memory: 512Mi   # å³°å€¼å†…å­˜

---
# åœºæ™¯2: æ•°æ®åº“ (Guaranteed - æœ€é«˜ä¼˜å…ˆçº§)
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: postgres
spec:
  template:
    spec:
      containers:
      - name: postgres
        image: postgres:15
        resources:
          requests:
            cpu: 2000m
            memory: 4Gi
          limits:
            cpu: 2000m      # ä¸requestsç›¸ç­‰ â†’ Guaranteed
            memory: 4Gi     # ä¸requestsç›¸ç­‰

---
# åœºæ™¯3: æ‰¹å¤„ç†ä»»åŠ¡ (BestEffort æˆ–ä½ä¼˜å…ˆçº§Burstable)
apiVersion: batch/v1
kind: Job
metadata:
  name: data-import
spec:
  template:
    spec:
      containers:
      - name: importer
        image: data-importer:1.0
        resources:
          requests:
            cpu: 100m       # ä½ä¼˜å…ˆçº§
            memory: 256Mi
          limits:
            cpu: 4000m      # å…è®¸å¤§é‡çªå‘ (ç©ºé—²æ—¶)
            memory: 2Gi
      restartPolicy: OnFailure
```

**3. èµ„æºé…ç½®è®¡ç®—å…¬å¼**:

```bash
# è®¡ç®—å•Podèµ„æºéœ€æ±‚ (å‹æµ‹è·å¾—)
åŸºå‡†è´Ÿè½½ä¸‹çš„å®é™…ä½¿ç”¨é‡ â†’ requests
å³°å€¼è´Ÿè½½ä¸‹çš„å®é™…ä½¿ç”¨é‡ â†’ limits

# è®¡ç®—Namespaceèµ„æºé…é¢
ResourceQuota.requests.cpu =
  (å•Pod requests.cpu Ã— å‰¯æœ¬æ•° Ã— å®‰å…¨ç³»æ•°1.5) Ã— æœåŠ¡æ•°é‡

# ç¤ºä¾‹:
# - 5ä¸ªå¾®æœåŠ¡
# - æ¯ä¸ªæœåŠ¡3å‰¯æœ¬
# - å•Pod requests: cpu=200m, memory=256Mi

æ€» requests.cpu = 200m Ã— 3 Ã— 1.5 Ã— 5 = 4.5æ ¸
æ€» requests.memory = 256Mi Ã— 3 Ã— 1.5 Ã— 5 = 5.625Gi
```

**4. ç›‘æ§ä¸è°ƒä¼˜**:

```bash
# ç›‘æ§Podå®é™…èµ„æºä½¿ç”¨
kubectl top pod -n prod --sort-by=cpu
kubectl top pod -n prod --sort-by=memory

# æŸ¥çœ‹Podèµ„æºé™åˆ¶
kubectl get pod <pod-name> -o jsonpath='{.spec.containers[*].resources}'

# åˆ†æèµ„æºæµªè´¹ (requestsè®¾ç½®è¿‡é«˜)
# å¦‚æœ å®é™…ä½¿ç”¨ << requests,è¯´æ˜resourcesé…ç½®è¿‡é«˜
kubectl top pod my-app
# NAME     CPU(cores)   MEMORY(bytes)
# my-app   50m          128Mi

kubectl get pod my-app -o yaml | grep -A4 requests
#   requests:
#     cpu: 1000m      # å®é™…åªç”¨50m,æµªè´¹950m!
#     memory: 2Gi     # å®é™…åªç”¨128Mi,æµªè´¹1.8Gi!

# è°ƒä¼˜å»ºè®®:
# requests åº”è®¾ç½®ä¸º: å®é™…å¹³å‡ä½¿ç”¨é‡ Ã— 1.2
# limits åº”è®¾ç½®ä¸º:   å®é™…å³°å€¼ä½¿ç”¨é‡ Ã— 1.3
```

**5. èµ„æºéš”ç¦»ç­–ç•¥**:

```yaml
# ç”Ÿäº§ç¯å¢ƒ vs æµ‹è¯•ç¯å¢ƒèµ„æºéš”ç¦»
---
# ç”Ÿäº§ç¯å¢ƒ: é«˜é…é¢ + ä¸¥æ ¼LimitRange
apiVersion: v1
kind: Namespace
metadata:
  name: prod
---
apiVersion: v1
kind: ResourceQuota
metadata:
  name: prod-quota
  namespace: prod
spec:
  hard:
    requests.cpu: 50
    requests.memory: 100Gi
    limits.cpu: 100
    limits.memory: 200Gi
    count/pods.besteffort: 0  # ç¦æ­¢BestEffort
---
apiVersion: v1
kind: LimitRange
metadata:
  name: prod-limits
  namespace: prod
spec:
  limits:
  - type: Container
    min:
      cpu: 100m               # æœ€å°å¿…é¡»100m
      memory: 128Mi
    max:
      cpu: 8000m
      memory: 16Gi

---
# æµ‹è¯•ç¯å¢ƒ: ä½é…é¢ + å®½æ¾LimitRange
apiVersion: v1
kind: Namespace
metadata:
  name: test
---
apiVersion: v1
kind: ResourceQuota
metadata:
  name: test-quota
  namespace: test
spec:
  hard:
    requests.cpu: 10
    requests.memory: 20Gi
    limits.cpu: 20
    limits.memory: 40Gi
    pods: 30
---
apiVersion: v1
kind: LimitRange
metadata:
  name: test-limits
  namespace: test
spec:
  limits:
  - type: Container
    default:                  # æœªè®¾ç½®æ—¶çš„é»˜è®¤å€¼
      cpu: 200m
      memory: 256Mi
    defaultRequest:
      cpu: 100m
      memory: 128Mi
```


---

## 2.7 Pod ç½‘ç»œ

### 2.7.1 Pod ç½‘ç»œæ¨¡å‹

Kuberneteséµå¾ª **"IP-per-Pod"** æ¨¡å‹,æ¯ä¸ªPodæ‹¥æœ‰ç‹¬ç«‹çš„IPåœ°å€,Podå†…æ‰€æœ‰å®¹å™¨å…±äº«è¯¥IPå’Œç½‘ç»œæ ˆã€‚

```
Podç½‘ç»œæ¨¡å‹:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Node-1 (192.168.1.10)                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ Pod-A (10.244.1.5)                  â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚
â”‚  â”‚  â”‚ Container-1  â”‚  â”‚ Container-2  â”‚ â”‚    â”‚
â”‚  â”‚  â”‚ localhost:80 â”‚  â”‚localhost:9090â”‚ â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚
â”‚  â”‚         â†‘ å…±äº«ç½‘ç»œå‘½åç©ºé—´            â”‚    â”‚
â”‚  â”‚         â†“ (åŒä¸€ä¸ªeth0@Pod-A)        â”‚    â”‚
â”‚  â”‚     eth0: 10.244.1.5                â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                 â†“                            â”‚
â”‚          CNI Bridge (cni0)                   â”‚
â”‚                 â†“                            â”‚
â”‚           Node eth0: 192.168.1.10            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“
            Physical Network
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Node-2 (192.168.1.11)                       â”‚
â”‚  Pod-B (10.244.2.10)                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Kubernetesç½‘ç»œä¸‰å¤§åŸåˆ™**:

1. **Podé—´ç›´æ¥é€šä¿¡**: ä»»æ„Podå¯ç›´æ¥é€šè¿‡IPè®¿é—®å…¶ä»–Pod,æ— éœ€NAT
2. **Nodeä¸Podäº’é€š**: Nodeå¯ç›´æ¥è®¿é—®Pod IP,åä¹‹äº¦ç„¶
3. **Pod IPå”¯ä¸€æ€§**: é›†ç¾¤å†…æ¯ä¸ªPod IPå…¨å±€å”¯ä¸€

### 2.7.2 Pod IP åœ°å€åˆ†é…

**IPåˆ†é…æµç¨‹**:

```bash
1. é›†ç¾¤åˆå§‹åŒ–æ—¶å®šä¹‰Pod CIDR (ä¾‹: 10.244.0.0/16)
2. æ¯ä¸ªNodeåˆ†é…ä¸€ä¸ªå­ç½‘ (ä¾‹: Node-1: 10.244.1.0/24)
3. kubeleté€šè¿‡CNIæ’ä»¶ä¸ºPodåˆ†é…IP (ä¾‹: 10.244.1.5)
4. IPä¿¡æ¯å­˜å‚¨åˆ°Pod.status.podIPå­—æ®µ
```

**æŸ¥çœ‹Pod IP**:

```bash
# æ–¹æ³•1: æŸ¥çœ‹Podè¯¦æƒ…
kubectl get pod <pod-name> -o wide
# NAME    READY   STATUS    RESTARTS   AGE   IP            NODE
# nginx   1/1     Running   0          10m   10.244.1.15   node-1

# æ–¹æ³•2: ä½¿ç”¨jsonpathæå–IP
kubectl get pod <pod-name> -o jsonpath='{.status.podIP}'
# 10.244.1.15

# æ–¹æ³•3: æŸ¥çœ‹æ‰€æœ‰Pod IP
kubectl get pods -o custom-columns=NAME:.metadata.name,IP:.status.podIP
# NAME          IP
# nginx         10.244.1.15
# redis         10.244.2.20
# postgres      10.244.1.30
```

**Podç½‘ç»œé…ç½®ç¤ºä¾‹**:

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: network-demo
spec:
  # 1. ä¸»æœºåé…ç½®
  hostname: my-app              # Podå†…ä¸»æœºå (é»˜è®¤=Podå)
  subdomain: backend-svc        # å­åŸŸå (é…åˆHeadless Service)
  # å®Œæ•´FQDN: my-app.backend-svc.default.svc.cluster.local

  # 2. DNSç­–ç•¥
  dnsPolicy: ClusterFirst       # é»˜è®¤: ä½¿ç”¨é›†ç¾¤DNS (CoreDNS)
  # å…¶ä»–é€‰é¡¹:
  # - Default: ä½¿ç”¨Nodeçš„DNSé…ç½®
  # - None: å®Œå…¨è‡ªå®šä¹‰DNS (éœ€é…åˆdnsConfig)
  # - ClusterFirstWithHostNet: hostNetwork=trueæ—¶ä½¿ç”¨

  # 3. è‡ªå®šä¹‰DNSé…ç½®
  dnsConfig:
    nameservers:
    - 8.8.8.8                   # è‡ªå®šä¹‰DNSæœåŠ¡å™¨
    searches:
    - my-namespace.svc.cluster.local
    - svc.cluster.local
    options:
    - name: ndots
      value: "2"

  # 4. ä¸»æœºç½‘ç»œæ¨¡å¼ (ä½¿ç”¨Nodeç½‘ç»œ,ä¸å¸¸ç”¨)
  # hostNetwork: true           # Podç›´æ¥ä½¿ç”¨Node IP (å±é™©!)
  # hostPID: true               # å…±äº«Node PIDå‘½åç©ºé—´
  # hostIPC: true               # å…±äº«Node IPCå‘½åç©ºé—´

  containers:
  - name: app
    image: nginx:1.25
    ports:
    - containerPort: 80
      name: http
      protocol: TCP             # TCP/UDP/SCTP
```


### 2.7.3 å®¹å™¨é—´é€šä¿¡ (åŒä¸€Pod)

Podå†…æ‰€æœ‰å®¹å™¨å…±äº«ç½‘ç»œå‘½åç©ºé—´,å¯é€šè¿‡ `localhost` äº’ç›¸è®¿é—®ã€‚

**å®æˆ˜ç¤ºä¾‹: Nginx + Fluentd ç»„åˆ**

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: web-with-logging
spec:
  containers:
  # å®¹å™¨1: WebæœåŠ¡å™¨ (ç›‘å¬80ç«¯å£)
  - name: nginx
    image: nginx:1.25
    ports:
    - containerPort: 80
      name: http
    volumeMounts:
    - name: logs
      mountPath: /var/log/nginx

  # å®¹å™¨2: æ—¥å¿—æ”¶é›†å™¨ (ç›‘å¬24224ç«¯å£)
  - name: fluentd
    image: fluent/fluentd:v1.16
    ports:
    - containerPort: 24224
      name: fluentd
    env:
    - name: FLUENTD_CONF
      value: "fluent.conf"
    volumeMounts:
    - name: logs
      mountPath: /var/log/nginx
      readOnly: true

  volumes:
  - name: logs
    emptyDir: {}
```

**éªŒè¯å®¹å™¨é—´é€šä¿¡**:

```bash
# è¿›å…¥nginxå®¹å™¨
kubectl exec -it web-with-logging -c nginx -- bash

# æµ‹è¯•è®¿é—®fluentd (é€šè¿‡localhost)
curl localhost:24224
# Connection successful â†’ å®¹å™¨é—´é€šä¿¡æ­£å¸¸

# æŸ¥çœ‹ç½‘ç»œå‘½åç©ºé—´ (ä¸¤ä¸ªå®¹å™¨å…±äº«)
kubectl exec web-with-logging -c nginx -- ip addr show eth0
kubectl exec web-with-logging -c fluentd -- ip addr show eth0
# è¾“å‡ºç›¸åŒçš„IPå’ŒMACåœ°å€ â†’ å…±äº«ç½‘ç»œæ ˆ
```

**ç«¯å£å†²çªé—®é¢˜**:

```yaml
# âŒ é”™è¯¯ç¤ºä¾‹: ä¸¤ä¸ªå®¹å™¨ç›‘å¬ç›¸åŒç«¯å£
apiVersion: v1
kind: Pod
metadata:
  name: port-conflict
spec:
  containers:
  - name: app1
    image: nginx:1.25
    ports:
    - containerPort: 80    # Nginxç›‘å¬80
  - name: app2
    image: httpd:2.4
    ports:
    - containerPort: 80    # Apacheä¹Ÿç›‘å¬80
# ç»“æœ: ç¬¬äºŒä¸ªå®¹å™¨å¯åŠ¨å¤±è´¥ (ç«¯å£å·²è¢«å ç”¨)

# âœ… æ­£ç¡®ç¤ºä¾‹: ä¸åŒç«¯å£
apiVersion: v1
kind: Pod
metadata:
  name: no-conflict
spec:
  containers:
  - name: app1
    image: nginx:1.25
    ports:
    - containerPort: 80
  - name: app2
    image: my-api:1.0
    ports:
    - containerPort: 8080   # ä¸åŒç«¯å£
```


### 2.7.4 Podé—´é€šä¿¡ (è·¨Node)

Podé—´é€šä¿¡é€šè¿‡ **CNIæ’ä»¶** å®ç°,å¸¸è§æ–¹æ¡ˆåŒ…æ‹¬:

- **Calico**: BGPè·¯ç”± (æ€§èƒ½é«˜,é€‚åˆå¤§è§„æ¨¡é›†ç¾¤)
- **Flannel**: VXLANéš§é“ (ç®€å•æ˜“ç”¨)
- **Weave**: Meshç½‘ç»œ (å»ä¸­å¿ƒåŒ–)

**è·¨Nodeé€šä¿¡æµç¨‹ (ä»¥Calico BGPä¸ºä¾‹)**:

```
Pod-A (10.244.1.5 @ Node-1) â†’ Pod-B (10.244.2.10 @ Node-2)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. Pod-Aå‘èµ·è¯·æ±‚                          â”‚
â”‚     curl http://10.244.2.10:80            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. æŸ¥è¯¢è·¯ç”±è¡¨                             â”‚
â”‚     ip route get 10.244.2.10              â”‚
â”‚     â†’ via 192.168.1.11 (Node-2ç‰©ç†IP)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. å°è£…æ•°æ®åŒ…                             â”‚
â”‚     æºIP: 10.244.1.5 (Pod-A)              â”‚
â”‚     ç›®æ ‡IP: 10.244.2.10 (Pod-B)           â”‚
â”‚     (æ— éœ€NAT,ä¿æŒPod IP)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  4. Node-1 â†’ Node-2 (ç‰©ç†ç½‘ç»œ)            â”‚
â”‚     é€šè¿‡BGPå­¦ä¹ åˆ°çš„è·¯ç”±è½¬å‘                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  5. Node-2æ¥æ”¶å¹¶è§£å°è£…                     â”‚
â”‚     æ ¹æ®ç›®æ ‡IP 10.244.2.10 è·¯ç”±åˆ°Pod-B    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  6. Pod-Bæ¥æ”¶è¯·æ±‚å¹¶å“åº”                    â”‚
â”‚     (å“åº”æ•°æ®åŒ…åŸè·¯è¿”å›)                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**éªŒè¯è·¨Nodeé€šä¿¡**:

```bash
# åˆ›å»ºä¸¤ä¸ªPod (ç¡®ä¿è°ƒåº¦åˆ°ä¸åŒNode)
cat <<EOF | kubectl apply -f -
apiVersion: v1
kind: Pod
metadata:
  name: pod-a
spec:
  nodeName: node-1
  containers:
  - name: nginx
    image: nginx:1.25
---
apiVersion: v1
kind: Pod
metadata:
  name: pod-b
spec:
  nodeName: node-2
  containers:
  - name: nginx
    image: nginx:1.25
EOF

# è·å–Pod IP
POD_A_IP=$(kubectl get pod pod-a -o jsonpath='{.status.podIP}')
POD_B_IP=$(kubectl get pod pod-b -o jsonpath='{.status.podIP}')

# ä»Pod-Aè®¿é—®Pod-B
kubectl exec pod-a -- curl -s http://$POD_B_IP
# è¾“å‡ºNginxæ¬¢è¿é¡µé¢ â†’ è·¨Nodeé€šä¿¡æˆåŠŸ

# æŠ“åŒ…éªŒè¯ (Node-1)
sudo tcpdump -i any host $POD_B_IP -nn
# å¯ä»¥çœ‹åˆ°VXLANæˆ–BGPå°è£…çš„æ•°æ®åŒ…
```


### 2.7.5 Service ä¸ DNS

è™½ç„¶Podæœ‰ç‹¬ç«‹IP,ä½†Pod IPæ˜¯åŠ¨æ€å˜åŒ–çš„(é‡å»ºåIPå˜åŒ–),ç”Ÿäº§ç¯å¢ƒé€šè¿‡ **Service** æä¾›ç¨³å®šçš„è®¿é—®å…¥å£ã€‚

**ServiceæŠ½è±¡å±‚**:

```
Service ç½‘ç»œæŠ½è±¡:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Service: web-svc                            â”‚
â”‚  ClusterIP: 10.96.100.50 (è™šæ‹ŸIP,ç¨³å®š)      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Endpoints: (åŠ¨æ€æ›´æ–°)                       â”‚
â”‚  - 10.244.1.5:80  (Pod-1)                   â”‚
â”‚  - 10.244.2.10:80 (Pod-2)                   â”‚
â”‚  - 10.244.3.15:80 (Pod-3)                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â†“ kube-proxy
          (iptables / ipvs è´Ÿè½½å‡è¡¡)
```

**DNS æœåŠ¡å‘ç°**:

```yaml
apiVersion: v1
kind: Service
metadata:
  name: backend-api
  namespace: prod
spec:
  selector:
    app: backend
  ports:
  - port: 8080
    targetPort: 8080
  clusterIP: 10.96.50.100  # K8sè‡ªåŠ¨åˆ†é…
```

**Podå†…è®¿é—®Serviceçš„DNSè§£æ**:

```bash
# åœ¨Podå†…æµ‹è¯•DNSè§£æ
kubectl run -it --rm debug --image=busybox --restart=Never -- sh

# 1. åŒnamespaceè®¿é—® (çŸ­åç§°)
nslookup backend-api
# Name:    backend-api.prod.svc.cluster.local
# Address: 10.96.50.100

# 2. è·¨namespaceè®¿é—® (å®Œæ•´FQDN)
nslookup backend-api.prod.svc.cluster.local
# Address: 10.96.50.100

# 3. è®¿é—®Service (è‡ªåŠ¨è´Ÿè½½å‡è¡¡åˆ°åç«¯Pod)
wget -O- http://backend-api:8080/health
# è¯·æ±‚è¢«kube-proxyè½¬å‘åˆ° 10.244.x.x:8080 (å®é™…Pod)
```

**DNSè®°å½•ç±»å‹**:

```bash
# Service Aè®°å½• (ClusterIP)
backend-api.prod.svc.cluster.local â†’ 10.96.50.100

# Headless Service (StatefulSet)
# ç›´æ¥è§£æåˆ°Pod IP,ä¸ç»è¿‡è´Ÿè½½å‡è¡¡
postgres-0.postgres-svc.default.svc.cluster.local â†’ 10.244.1.20
postgres-1.postgres-svc.default.svc.cluster.local â†’ 10.244.2.30

# å¤–éƒ¨æœåŠ¡ (ExternalName)
db.prod.svc.cluster.local â†’ rds.us-west-1.amazonaws.com (CNAME)
```


### 2.7.6 ç½‘ç»œç­–ç•¥ (NetworkPolicy)

**ä½œç”¨**: å®ç°Podçº§åˆ«çš„ç½‘ç»œéš”ç¦»å’Œè®¿é—®æ§åˆ¶ (ç±»ä¼¼é˜²ç«å¢™è§„åˆ™)ã€‚

```yaml
# ç¤ºä¾‹1: é»˜è®¤æ‹’ç»æ‰€æœ‰å…¥ç«™æµé‡
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: deny-all-ingress
  namespace: prod
spec:
  podSelector: {}              # åº”ç”¨äºnamespaceå†…æ‰€æœ‰Pod
  policyTypes:
  - Ingress                    # æ§åˆ¶å…¥ç«™æµé‡
```

```yaml
# ç¤ºä¾‹2: ä»…å…è®¸ç‰¹å®šPodè®¿é—®æ•°æ®åº“
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-backend-to-db
  namespace: prod
spec:
  # åº”ç”¨äºå¸¦æœ‰ app=postgres æ ‡ç­¾çš„Pod
  podSelector:
    matchLabels:
      app: postgres
  policyTypes:
  - Ingress
  ingress:
  - from:
    # ä»…å…è®¸æ¥è‡ª app=backend çš„Podè®¿é—®
    - podSelector:
        matchLabels:
          app: backend
    ports:
    - protocol: TCP
      port: 5432
```

```yaml
# ç¤ºä¾‹3: å¤šå±‚è®¿é—®æ§åˆ¶ (å‰ç«¯ â†’ åç«¯ â†’ æ•°æ®åº“)
---
# è§„åˆ™1: åç«¯ä»…æ¥å—å‰ç«¯æµé‡
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: backend-allow-frontend
  namespace: prod
spec:
  podSelector:
    matchLabels:
      tier: backend
  ingress:
  - from:
    - podSelector:
        matchLabels:
          tier: frontend
    ports:
    - protocol: TCP
      port: 8080

---
# è§„åˆ™2: æ•°æ®åº“ä»…æ¥å—åç«¯æµé‡
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: db-allow-backend
  namespace: prod
spec:
  podSelector:
    matchLabels:
      tier: database
  ingress:
  - from:
    - podSelector:
        matchLabels:
          tier: backend
    ports:
    - protocol: TCP
      port: 5432

---
# è§„åˆ™3: å‰ç«¯å…è®¸å¤–éƒ¨è®¿é—®
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: frontend-allow-external
  namespace: prod
spec:
  podSelector:
    matchLabels:
      tier: frontend
  ingress:
  - from:
    - ipBlock:
        cidr: 0.0.0.0/0         # å…è®¸æ‰€æœ‰å¤–éƒ¨æµé‡
    ports:
    - protocol: TCP
      port: 80
```

**å‡ºç«™æµé‡æ§åˆ¶**:

```yaml
# é™åˆ¶Podä»…èƒ½è®¿é—®ç‰¹å®šå¤–éƒ¨æœåŠ¡
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: restrict-egress
  namespace: prod
spec:
  podSelector:
    matchLabels:
      app: web
  policyTypes:
  - Egress
  egress:
  # 1. å…è®¸è®¿é—®é›†ç¾¤å†…DNS (CoreDNS)
  - to:
    - namespaceSelector:
        matchLabels:
          name: kube-system
    ports:
    - protocol: UDP
      port: 53

  # 2. å…è®¸è®¿é—®ç‰¹å®šå¤–éƒ¨IP (ä¾‹: AWS RDS)
  - to:
    - ipBlock:
        cidr: 10.20.30.0/24     # RDSå­ç½‘
    ports:
    - protocol: TCP
      port: 5432

  # 3. å…è®¸è®¿é—®åŒnamespaceå…¶ä»–æœåŠ¡
  - to:
    - podSelector: {}
```

**éªŒè¯NetworkPolicy**:

```bash
# åˆ›å»ºæµ‹è¯•Pod
kubectl run frontend --image=nginx --labels=tier=frontend
kubectl run backend --image=nginx --labels=tier=backend
kubectl run db --image=postgres:15 --labels=tier=database

# åº”ç”¨NetworkPolicy
kubectl apply -f network-policy.yaml

# æµ‹è¯•1: frontend â†’ backend (åº”è¯¥æˆåŠŸ)
BACKEND_IP=$(kubectl get pod backend -o jsonpath='{.status.podIP}')
kubectl exec frontend -- curl -m 3 http://$BACKEND_IP
# æˆåŠŸ: 200 OK

# æµ‹è¯•2: frontend â†’ db (åº”è¯¥è¢«æ‹’ç»)
DB_IP=$(kubectl get pod db -o jsonpath='{.status.podIP}')
kubectl exec frontend -- nc -zv $DB_IP 5432 -w 3
# å¤±è´¥: Connection timed out (è¢«NetworkPolicyé˜»æ­¢)

# æµ‹è¯•3: backend â†’ db (åº”è¯¥æˆåŠŸ)
kubectl exec backend -- nc -zv $DB_IP 5432 -w 3
# æˆåŠŸ: Connection succeeded
```


### 2.7.7 å¸¸ç”¨ç½‘ç»œè°ƒè¯•å‘½ä»¤

```bash
# 1. æŸ¥çœ‹Podç½‘ç»œé…ç½®
kubectl exec <pod-name> -- ip addr show
kubectl exec <pod-name> -- ip route show

# 2. æµ‹è¯•Podé—´è¿é€šæ€§
kubectl exec <pod-a> -- ping <pod-b-ip>
kubectl exec <pod-a> -- curl http://<pod-b-ip>:port

# 3. DNSæµ‹è¯•
kubectl exec <pod-name> -- nslookup <service-name>
kubectl exec <pod-name> -- dig <service-name> +short

# 4. ç«¯å£æµ‹è¯•
kubectl exec <pod-name> -- nc -zv <target-ip> <port>
kubectl exec <pod-name> -- telnet <target-ip> <port>

# 5. æŠ“åŒ…åˆ†æ
kubectl exec <pod-name> -- tcpdump -i eth0 -nn -c 10

# 6. è·¯ç”±è¿½è¸ª
kubectl exec <pod-name> -- traceroute <target-ip>
kubectl exec <pod-name> -- mtr -r -c 10 <target-ip>

# 7. æŸ¥çœ‹Service Endpoints
kubectl get endpoints <service-name>
kubectl describe service <service-name>

# 8. æŸ¥çœ‹NetworkPolicy
kubectl get networkpolicy -n <namespace>
kubectl describe networkpolicy <policy-name>

# 9. è°ƒè¯•DNSé—®é¢˜
kubectl run -it --rm debug --image=nicolaka/netshoot --restart=Never -- bash
# netshooté•œåƒåŒ…å«æ‰€æœ‰ç½‘ç»œè°ƒè¯•å·¥å…· (dig/nslookup/curl/tcpdumpç­‰)
```


---

## 2.8 Pod å­˜å‚¨

### 2.8.1 Volume åŸºç¡€æ¦‚å¿µ

**é—®é¢˜**: å®¹å™¨å†…çš„æ–‡ä»¶ç³»ç»Ÿæ˜¯ä¸´æ—¶çš„,å®¹å™¨é‡å¯åæ•°æ®ä¼šä¸¢å¤±ã€‚

**è§£å†³**: Kubernetesæä¾› **Volume (å·)** æœºåˆ¶,å®ç°:
1. **æ•°æ®æŒä¹…åŒ–**: å®¹å™¨é‡å¯åæ•°æ®ä¿ç•™
2. **æ•°æ®å…±äº«**: åŒä¸€Podå†…å¤šä¸ªå®¹å™¨å…±äº«æ•°æ®
3. **å¤–éƒ¨å­˜å‚¨æ¥å…¥**: æŒ‚è½½NFSã€äº‘ç›˜ç­‰

```
Volume ç”Ÿå‘½å‘¨æœŸ:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ä¸´æ—¶å· (Ephemeral Volume)             â”‚
â”‚  - ä¸Podç”Ÿå‘½å‘¨æœŸç»‘å®š                    â”‚
â”‚  - Podåˆ é™¤,æ•°æ®ä¸¢å¤±                     â”‚
â”‚  - ç±»å‹: emptyDir, configMap, secret   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  vs
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æŒä¹…å· (Persistent Volume)            â”‚
â”‚  - ç‹¬ç«‹äºPodç”Ÿå‘½å‘¨æœŸ                    â”‚
â”‚  - Podåˆ é™¤,æ•°æ®ä¿ç•™                     â”‚
â”‚  - ç±»å‹: hostPath, NFS, PVC            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```


### 2.8.2 emptyDir (ä¸´æ—¶ç›®å½•)

**å®šä¹‰**: åœ¨Podåˆ›å»ºæ—¶åˆ†é…çš„ä¸´æ—¶ç›®å½•,Podåˆ é™¤æ—¶æ•°æ®é”€æ¯ã€‚

**ä½¿ç”¨åœºæ™¯**:
- å®¹å™¨é—´ä¸´æ—¶æ•°æ®å…±äº«
- ç¼“å­˜æ•°æ® (ä¸éœ€è¦æŒä¹…åŒ–)
- ä¸´æ—¶æ–‡ä»¶å­˜å‚¨

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: emptydir-demo
spec:
  containers:
  # å®¹å™¨1: å†™å…¥æ—¥å¿—
  - name: writer
    image: busybox
    command:
    - sh
    - -c
    - |
      while true; do
        echo "$(date): Log entry" >> /data/app.log
        sleep 5
      done
    volumeMounts:
    - name: shared-data
      mountPath: /data

  # å®¹å™¨2: è¯»å–æ—¥å¿—
  - name: reader
    image: busybox
    command:
    - sh
    - -c
    - tail -f /data/app.log
    volumeMounts:
    - name: shared-data
      mountPath: /data
      readOnly: true

  volumes:
  - name: shared-data
    emptyDir: {}              # é»˜è®¤ä½¿ç”¨Nodeç£ç›˜
    # emptyDir:
    #   medium: Memory        # ä½¿ç”¨å†…å­˜ (tmpfs)
    #   sizeLimit: 1Gi        # é™åˆ¶å¤§å°1GB
```

**emptyDirå­˜å‚¨ä»‹è´¨é€‰æ‹©**:

```yaml
# é€‰é¡¹1: ä½¿ç”¨ç£ç›˜ (é»˜è®¤)
volumes:
- name: cache
  emptyDir: {}

# é€‰é¡¹2: ä½¿ç”¨å†…å­˜ (tmpfs - æ›´å¿«ä½†å—å†…å­˜é™åˆ¶)
volumes:
- name: cache
  emptyDir:
    medium: Memory
    sizeLimit: 512Mi     # é™åˆ¶å†…å­˜ä½¿ç”¨é‡
```

**éªŒè¯æ•°æ®å…±äº«**:

```bash
# åˆ›å»ºPod
kubectl apply -f emptydir-demo.yaml

# æŸ¥çœ‹writerå®¹å™¨æ—¥å¿—
kubectl logs emptydir-demo -c writer

# æŸ¥çœ‹readerå®¹å™¨æ—¥å¿— (åº”è¯¥èƒ½çœ‹åˆ°writerå†™å…¥çš„å†…å®¹)
kubectl logs emptydir-demo -c reader
# Mon Dec 16 10:00:00 UTC 2025: Log entry
# Mon Dec 16 10:00:05 UTC 2025: Log entry

# è¿›å…¥å®¹å™¨éªŒè¯æŒ‚è½½ç‚¹
kubectl exec emptydir-demo -c writer -- ls -la /data
# -rw-r--r-- 1 root root 1024 Dec 16 10:00 app.log
```


### 2.8.3 hostPath (å®¿ä¸»æœºè·¯å¾„)

**å®šä¹‰**: å°†Nodeçš„æ–‡ä»¶ç³»ç»Ÿç›®å½•/æ–‡ä»¶æŒ‚è½½åˆ°Pod,æ•°æ®æŒä¹…åŒ–åœ¨Nodeæœ¬åœ°ã€‚

**âš ï¸ è­¦å‘Š**: hostPathå­˜åœ¨å®‰å…¨é£é™©å’Œè°ƒåº¦é™åˆ¶,ç”Ÿäº§ç¯å¢ƒè°¨æ…ä½¿ç”¨!

**ä½¿ç”¨åœºæ™¯**:
- è®¿é—®Nodeæ—¥å¿— (/var/log)
- è®¿é—®Docker socket (/var/run/docker.sock)
- èŠ‚ç‚¹çº§åˆ«çš„ç›‘æ§Agent

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: hostpath-demo
spec:
  nodeName: node-1               # å¿…é¡»ç»‘å®šåˆ°ç‰¹å®šNode
  containers:
  - name: app
    image: nginx:1.25
    volumeMounts:
    - name: nginx-logs
      mountPath: /var/log/nginx

  volumes:
  - name: nginx-logs
    hostPath:
      path: /data/nginx-logs     # Nodeä¸Šçš„è·¯å¾„
      type: DirectoryOrCreate    # ä¸å­˜åœ¨åˆ™åˆ›å»º
```

**hostPath ç±»å‹å‚æ•°**:

| type | è¡Œä¸º | ä½¿ç”¨åœºæ™¯ |
|------|------|---------|
| `DirectoryOrCreate` | ç›®å½•ä¸å­˜åœ¨åˆ™åˆ›å»º | æ—¥å¿—ç›®å½•ã€æ•°æ®ç›®å½• |
| `Directory` | å¿…é¡»å­˜åœ¨ç›®å½•,å¦åˆ™Podå¤±è´¥ | é…ç½®ç›®å½• |
| `FileOrCreate` | æ–‡ä»¶ä¸å­˜åœ¨åˆ™åˆ›å»º | é…ç½®æ–‡ä»¶ |
| `File` | å¿…é¡»å­˜åœ¨æ–‡ä»¶ | è¯ä¹¦æ–‡ä»¶ |
| `Socket` | UNIX socketæ–‡ä»¶ | Docker socket |
| `BlockDevice` | å—è®¾å¤‡ | è£¸ç›˜æŒ‚è½½ |

**å®æˆ˜ç¤ºä¾‹: è®¿é—®Docker socket (ç›‘æ§å®¹å™¨)**

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: docker-monitor
spec:
  containers:
  - name: monitor
    image: docker:20.10
    command:
    - sh
    - -c
    - docker ps -a --format "table {{.Names}}\t{{.Status}}"
    volumeMounts:
    - name: docker-sock
      mountPath: /var/run/docker.sock
      readOnly: true

  volumes:
  - name: docker-sock
    hostPath:
      path: /var/run/docker.sock
      type: Socket
```

**hostPath å®‰å…¨é£é™©**:

```yaml
# âŒ å±é™©ç¤ºä¾‹: æŒ‚è½½æ ¹ç›®å½• (å®¹å™¨å¯è®¿é—®Nodeæ‰€æœ‰æ–‡ä»¶!)
volumes:
- name: root
  hostPath:
    path: /
    type: Directory

# âœ… æ­£ç¡®ç¤ºä¾‹: ä»…æŒ‚è½½å¿…è¦ç›®å½•,å¹¶è®¾ç½®åªè¯»
volumes:
- name: app-logs
  hostPath:
    path: /var/log/app
    type: DirectoryOrCreate
volumeMounts:
- name: app-logs
  mountPath: /logs
  readOnly: true              # åªè¯»æŒ‚è½½
```


### 2.8.4 configMap ä¸ secret

**configMap**: å­˜å‚¨éæ•æ„Ÿé…ç½®æ•°æ® (æ˜æ–‡)
**secret**: å­˜å‚¨æ•æ„Ÿæ•°æ® (Base64ç¼–ç )

```yaml
---
# åˆ›å»ºConfigMap
apiVersion: v1
kind: ConfigMap
metadata:
  name: app-config
data:
  database.host: "postgres.default.svc.cluster.local"
  database.port: "5432"
  app.conf: |
    server {
      listen 80;
      server_name example.com;
    }

---
# åˆ›å»ºSecret
apiVersion: v1
kind: Secret
metadata:
  name: app-secret
type: Opaque
data:
  # Base64ç¼–ç  (echo -n 'password123' | base64)
  database.password: cGFzc3dvcmQxMjM=
  api.key: c2VjcmV0a2V5MTIzNDU2

---
# Podä½¿ç”¨ConfigMapå’ŒSecret
apiVersion: v1
kind: Pod
metadata:
  name: app-with-config
spec:
  containers:
  - name: app
    image: myapp:1.0
    # æ–¹å¼1: ç¯å¢ƒå˜é‡æ³¨å…¥
    env:
    - name: DB_HOST
      valueFrom:
        configMapKeyRef:
          name: app-config
          key: database.host
    - name: DB_PASSWORD
      valueFrom:
        secretKeyRef:
          name: app-secret
          key: database.password

    volumeMounts:
    # æ–¹å¼2: æ–‡ä»¶æŒ‚è½½ (ConfigMap)
    - name: config-volume
      mountPath: /etc/nginx/nginx.conf
      subPath: app.conf           # ä»…æŒ‚è½½å•ä¸ªæ–‡ä»¶
    # æ–¹å¼3: æ–‡ä»¶æŒ‚è½½ (Secret)
    - name: secret-volume
      mountPath: /etc/secrets
      readOnly: true

  volumes:
  - name: config-volume
    configMap:
      name: app-config
  - name: secret-volume
    secret:
      secretName: app-secret
      defaultMode: 0400           # åªè¯»æƒé™
```

**éªŒè¯é…ç½®æ³¨å…¥**:

```bash
# æŸ¥çœ‹ç¯å¢ƒå˜é‡
kubectl exec app-with-config -- env | grep DB
# DB_HOST=postgres.default.svc.cluster.local
# DB_PASSWORD=password123

# æŸ¥çœ‹é…ç½®æ–‡ä»¶
kubectl exec app-with-config -- cat /etc/nginx/nginx.conf
# server {
#   listen 80;
#   server_name example.com;
# }

# æŸ¥çœ‹Secretæ–‡ä»¶
kubectl exec app-with-config -- ls -la /etc/secrets
# -r-------- 1 root root 11 Dec 16 10:00 database.password
# -r-------- 1 root root 17 Dec 16 10:00 api.key

kubectl exec app-with-config -- cat /etc/secrets/database.password
# password123 (è‡ªåŠ¨è§£ç )
```


### 2.8.5 downwardAPI (å…ƒæ•°æ®æ³¨å…¥)

**ä½œç”¨**: å°†Pod/å®¹å™¨çš„å…ƒæ•°æ® (å¦‚æ ‡ç­¾ã€èµ„æºé™åˆ¶) æ³¨å…¥åˆ°å®¹å™¨å†…ã€‚

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: downwardapi-demo
  namespace: prod
  labels:
    app: myapp
    tier: backend
  annotations:
    version: "1.2.3"
spec:
  containers:
  - name: app
    image: busybox
    command: ["sleep", "3600"]
    resources:
      requests:
        cpu: 100m
        memory: 128Mi
      limits:
        cpu: 500m
        memory: 512Mi

    # æ–¹å¼1: ç¯å¢ƒå˜é‡æ³¨å…¥
    env:
    - name: POD_NAME
      valueFrom:
        fieldRef:
          fieldPath: metadata.name
    - name: POD_NAMESPACE
      valueFrom:
        fieldRef:
          fieldPath: metadata.namespace
    - name: POD_IP
      valueFrom:
        fieldRef:
          fieldPath: status.podIP
    - name: CPU_REQUEST
      valueFrom:
        resourceFieldRef:
          containerName: app
          resource: requests.cpu
    - name: MEMORY_LIMIT
      valueFrom:
        resourceFieldRef:
          containerName: app
          resource: limits.memory

    # æ–¹å¼2: æ–‡ä»¶æŒ‚è½½
    volumeMounts:
    - name: podinfo
      mountPath: /etc/podinfo

  volumes:
  - name: podinfo
    downwardAPI:
      items:
      - path: "labels"
        fieldRef:
          fieldPath: metadata.labels
      - path: "annotations"
        fieldRef:
          fieldPath: metadata.annotations
      - path: "cpu_limit"
        resourceFieldRef:
          containerName: app
          resource: limits.cpu
```

**éªŒè¯å…ƒæ•°æ®æ³¨å…¥**:

```bash
# æŸ¥çœ‹ç¯å¢ƒå˜é‡
kubectl exec downwardapi-demo -- env | grep POD
# POD_NAME=downwardapi-demo
# POD_NAMESPACE=prod
# POD_IP=10.244.1.50

# æŸ¥çœ‹æ–‡ä»¶å†…å®¹
kubectl exec downwardapi-demo -- cat /etc/podinfo/labels
# app="myapp"
# tier="backend"

kubectl exec downwardapi-demo -- cat /etc/podinfo/cpu_limit
# 500m
```


### 2.8.6 projected (æŠ•å°„å· - èšåˆå¤šä¸ªå·)

**ä½œç”¨**: å°†å¤šä¸ªVolumeæº (configMap/secret/downwardAPI/serviceAccountToken) èšåˆåˆ°ä¸€ä¸ªç›®å½•ã€‚

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: projected-demo
spec:
  containers:
  - name: app
    image: nginx:1.25
    volumeMounts:
    - name: all-in-one
      mountPath: /projected-volume
      readOnly: true

  volumes:
  - name: all-in-one
    projected:
      sources:
      # æº1: ConfigMap
      - configMap:
          name: app-config
          items:
          - key: database.host
            path: config/db_host

      # æº2: Secret
      - secret:
          name: app-secret
          items:
          - key: database.password
            path: secrets/db_password

      # æº3: DownwardAPI
      - downwardAPI:
          items:
          - path: "metadata/pod_name"
            fieldRef:
              fieldPath: metadata.name

      # æº4: ServiceAccount Token
      - serviceAccountToken:
          path: token
          expirationSeconds: 3600
```

**éªŒè¯èšåˆå·**:

```bash
kubectl exec projected-demo -- ls -R /projected-volume
# /projected-volume:
# config  metadata  secrets  token
#
# /projected-volume/config:
# db_host
#
# /projected-volume/secrets:
# db_password
#
# /projected-volume/metadata:
# pod_name
```


### 2.8.7 ä¸´æ—¶å· vs æŒä¹…å·å¯¹æ¯”

| ç‰¹æ€§ | ä¸´æ—¶å· (emptyDir) | æŒä¹…å· (PVC) |
|------|------------------|--------------|
| **ç”Ÿå‘½å‘¨æœŸ** | ä¸Podç»‘å®š | ç‹¬ç«‹äºPod |
| **æ•°æ®æŒä¹…æ€§** | Podåˆ é™¤å³é”€æ¯ | Podåˆ é™¤ä»ä¿ç•™ |
| **å­˜å‚¨ä½ç½®** | Nodeæœ¬åœ° | å¤–éƒ¨å­˜å‚¨ (NFS/äº‘ç›˜) |
| **ä½¿ç”¨åœºæ™¯** | ç¼“å­˜ã€ä¸´æ—¶æ–‡ä»¶ã€å®¹å™¨é—´å…±äº« | æ•°æ®åº“ã€ç”¨æˆ·ä¸Šä¼ æ–‡ä»¶ |
| **æ€§èƒ½** | æœ¬åœ°ç£ç›˜ (å¿«) | ä¾èµ–ç½‘ç»œå­˜å‚¨ (æ…¢) |
| **Podè¿ç§»** | æ•°æ®ä¸¢å¤± | æ•°æ®è‡ªåŠ¨è·Ÿéš |
| **æˆæœ¬** | å…è´¹ (ä½¿ç”¨Nodeç£ç›˜) | å¯èƒ½äº§ç”Ÿäº‘å­˜å‚¨è´¹ç”¨ |

**é€‰æ‹©å»ºè®®**:

```yaml
# åœºæ™¯1: æ—¥å¿—æ”¶é›† (ä¸éœ€è¦æŒä¹…åŒ–) â†’ emptyDir
volumes:
- name: logs
  emptyDir: {}

# åœºæ™¯2: æ•°æ®åº“ (å¿…é¡»æŒä¹…åŒ–) â†’ PVC
volumes:
- name: data
  persistentVolumeClaim:
    claimName: postgres-pvc

# åœºæ™¯3: é…ç½®æ–‡ä»¶ (åªè¯») â†’ configMap
volumes:
- name: config
  configMap:
    name: app-config

# åœºæ™¯4: å¯†é’¥ (åªè¯») â†’ secret
volumes:
- name: certs
  secret:
    secretName: tls-secret
```


### 2.8.8 Volume æœ€ä½³å®è·µ

**1. åªè¯»æŒ‚è½½ä¿æŠ¤æ•°æ®**:

```yaml
volumeMounts:
- name: config
  mountPath: /etc/app
  readOnly: true              # é˜²æ­¢å®¹å™¨ä¿®æ”¹é…ç½®
```

**2. subPath æŒ‚è½½å•ä¸ªæ–‡ä»¶**:

```yaml
# âŒ é”™è¯¯: æŒ‚è½½æ•´ä¸ªConfigMapä¼šè¦†ç›–ç›®å½•å†…æ‰€æœ‰æ–‡ä»¶
volumeMounts:
- name: config
  mountPath: /etc/nginx/nginx.conf

# âœ… æ­£ç¡®: ä½¿ç”¨subPathä»…æ›¿æ¢å•ä¸ªæ–‡ä»¶
volumeMounts:
- name: config
  mountPath: /etc/nginx/nginx.conf
  subPath: nginx.conf         # ä¸ä¼šè¦†ç›– /etc/nginx å…¶ä»–æ–‡ä»¶
```

**3. èµ„æºé™åˆ¶ (emptyDir)**:

```yaml
volumes:
- name: cache
  emptyDir:
    sizeLimit: 1Gi            # é™åˆ¶å¤§å°,é˜²æ­¢æ’‘çˆ†Nodeç£ç›˜
```

**4. æƒé™æ§åˆ¶ (Secret)**:

```yaml
volumes:
- name: secret
  secret:
    secretName: app-secret
    defaultMode: 0400         # åªè¯» (r--------)
```

**5. æ•°æ®é¢„å¡«å…… (ConfigMap)**:

```yaml
# ConfigMapæ”¯æŒç›®å½•ç»“æ„
apiVersion: v1
kind: ConfigMap
metadata:
  name: web-content
data:
  index.html: |
    <html><body>Welcome</body></html>
  style.css: |
    body { color: blue; }
---
# PodæŒ‚è½½æ•´ä¸ªç›®å½•
volumeMounts:
- name: web
  mountPath: /usr/share/nginx/html
volumes:
- name: web
  configMap:
    name: web-content
```


---

## 2.9 å®æˆ˜é¡¹ç›®: ç”Ÿäº§çº§ Web åº”ç”¨ Pod

æœ¬å®æˆ˜é¡¹ç›®å°†æ•´åˆæœ¬ç« æ‰€æœ‰çŸ¥è¯†ç‚¹,éƒ¨ç½²ä¸€ä¸ªåŒ…å«ä»¥ä¸‹ç‰¹æ€§çš„ç”Ÿäº§çº§Pod:

**æ¶æ„è®¾è®¡**:
- **ä¸»å®¹å™¨**: Nginx WebæœåŠ¡å™¨
- **Sidecarå®¹å™¨**: Fluentdæ—¥å¿—æ”¶é›†
- **Initå®¹å™¨**: ç­‰å¾…æ•°æ®åº“å°±ç»ª + ä¸‹è½½é™æ€èµ„æº
- **å¥åº·æ£€æŸ¥**: Startup/Liveness/Readiness Probe
- **èµ„æºç®¡ç†**: CPU/å†…å­˜é™åˆ¶ (Burstable QoS)
- **ç½‘ç»œé…ç½®**: è‡ªå®šä¹‰DNS
- **å­˜å‚¨**: emptyDir (æ—¥å¿—) + configMap (é…ç½®) + secret (è¯ä¹¦)

### 2.9.1 é¡¹ç›®1: å¤šå®¹å™¨Webåº”ç”¨ (å®Œæ•´ç‰ˆ)

**æ¶æ„å›¾**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Pod: production-web                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Init Containers (æŒ‰é¡ºåºæ‰§è¡Œ):                  â”‚
â”‚  1. wait-for-db    â†’ ç­‰å¾…PostgreSQLå°±ç»ª         â”‚
â”‚  2. download-assets â†’ ä¸‹è½½é™æ€èµ„æºåˆ°å…±äº«å·      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Main Containers (å¹¶è¡Œè¿è¡Œ):                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚   Nginx        â”‚  â”‚   Fluentd          â”‚    â”‚
â”‚  â”‚   :80          â”‚  â”‚   :24224           â”‚    â”‚
â”‚  â”‚   /var/www     â”‚  â”‚   æ”¶é›†Nginxæ—¥å¿—    â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚         â†“ å…±äº« emptyDir                         â”‚
â”‚    /var/log/nginx                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Volumes:                                       â”‚
â”‚  - shared-logs (emptyDir)                       â”‚
â”‚  - nginx-config (configMap)                     â”‚
â”‚  - tls-certs (secret)                           â”‚
â”‚  - web-content (emptyDir)                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ­¥éª¤1: åˆ›å»ºConfigMapå’ŒSecret**

```yaml
---
# ConfigMap: Nginxé…ç½®
apiVersion: v1
kind: ConfigMap
metadata:
  name: nginx-config
  namespace: default
data:
  nginx.conf: |
    user nginx;
    worker_processes auto;
    error_log /var/log/nginx/error.log warn;
    pid /var/run/nginx.pid;

    events {
        worker_connections 1024;
    }

    http {
        include /etc/nginx/mime.types;
        default_type application/octet-stream;

        log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                        '$status $body_bytes_sent "$http_referer" '
                        '"$http_user_agent" "$http_x_forwarded_for"';

        access_log /var/log/nginx/access.log main;

        sendfile on;
        keepalive_timeout 65;

        server {
            listen 80;
            server_name _;

            location / {
                root /var/www/html;
                index index.html;
            }

            # å¥åº·æ£€æŸ¥ç«¯ç‚¹
            location /healthz {
                access_log off;
                return 200 "healthy\n";
                add_header Content-Type text/plain;
            }

            # å°±ç»ªæ£€æŸ¥ç«¯ç‚¹
            location /ready {
                access_log off;
                return 200 "ready\n";
                add_header Content-Type text/plain;
            }
        }
    }

---
# ConfigMap: Fluentdé…ç½®
apiVersion: v1
kind: ConfigMap
metadata:
  name: fluentd-config
data:
  fluent.conf: |
    <source>
      @type tail
      path /var/log/nginx/access.log
      pos_file /var/log/nginx/access.log.pos
      tag nginx.access
      <parse>
        @type nginx
      </parse>
    </source>

    <source>
      @type tail
      path /var/log/nginx/error.log
      pos_file /var/log/nginx/error.log.pos
      tag nginx.error
      <parse>
        @type nginx
      </parse>
    </source>

    <match nginx.**>
      @type stdout
    </match>

---
# Secret: TLSè¯ä¹¦ (ç¤ºä¾‹,å®é™…åº”ä½¿ç”¨çœŸå®è¯ä¹¦)
apiVersion: v1
kind: Secret
metadata:
  name: tls-secret
type: kubernetes.io/tls
data:
  # ä»¥ä¸‹ä¸ºç¤ºä¾‹Base64ç¼–ç  (å®é™…åº”ä½¿ç”¨çœŸå®è¯ä¹¦)
  tls.crt: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0t...
  tls.key: LS0tLS1CRUdJTiBQUklWQVRFIEtFWS0tLS0t...
```

**æ­¥éª¤2: åˆ›å»ºç”Ÿäº§çº§Pod**

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: production-web
  namespace: default
  labels:
    app: web
    tier: frontend
    env: production
  annotations:
    version: "1.0.0"
    description: "Production web server with logging sidecar"
spec:
  # DNSé…ç½®
  hostname: web-app
  subdomain: frontend-svc
  dnsPolicy: ClusterFirst
  dnsConfig:
    options:
    - name: ndots
      value: "2"

  # Initå®¹å™¨
  initContainers:
  # Init-1: ç­‰å¾…æ•°æ®åº“å°±ç»ª
  - name: wait-for-db
    image: busybox:1.36
    command:
    - sh
    - -c
    - |
      echo "ç­‰å¾…PostgreSQLå°±ç»ª..."
      until nslookup postgres.default.svc.cluster.local; do
        echo "æ•°æ®åº“å°šæœªå°±ç»ª,2ç§’åé‡è¯•..."
        sleep 2
      done
      echo "æ•°æ®åº“å·²å°±ç»ª,ç»§ç»­å¯åŠ¨..."

  # Init-2: ä¸‹è½½é™æ€èµ„æº
  - name: download-assets
    image: busybox:1.36
    command:
    - sh
    - -c
    - |
      echo "ä¸‹è½½é™æ€èµ„æºåˆ° /work-dir..."
      cat > /work-dir/index.html <<'EOF'
      <!DOCTYPE html>
      <html>
      <head><title>Production Web App</title></head>
      <body>
        <h1>Welcome to Production Web Application</h1>
        <p>Pod: production-web</p>
        <p>Namespace: default</p>
        <p>Version: 1.0.0</p>
      </body>
      </html>
      EOF
      echo "é™æ€èµ„æºä¸‹è½½å®Œæˆ!"
    volumeMounts:
    - name: web-content
      mountPath: /work-dir

  # ä¸»å®¹å™¨
  containers:
  # å®¹å™¨1: Nginx WebæœåŠ¡å™¨
  - name: nginx
    image: nginx:1.25-alpine
    ports:
    - containerPort: 80
      name: http
      protocol: TCP

    # èµ„æºé™åˆ¶ (Burstable QoS)
    resources:
      requests:
        cpu: 100m
        memory: 128Mi
        ephemeral-storage: 100Mi
      limits:
        cpu: 500m
        memory: 512Mi
        ephemeral-storage: 1Gi

    # å¥åº·æ£€æŸ¥
    startupProbe:
      httpGet:
        path: /healthz
        port: 80
      periodSeconds: 5
      failureThreshold: 6       # æœ€å¤šç­‰å¾…30ç§’å¯åŠ¨

    livenessProbe:
      httpGet:
        path: /healthz
        port: 80
      initialDelaySeconds: 10
      periodSeconds: 10
      timeoutSeconds: 3
      failureThreshold: 3

    readinessProbe:
      httpGet:
        path: /ready
        port: 80
      initialDelaySeconds: 5
      periodSeconds: 5
      timeoutSeconds: 2
      successThreshold: 1
      failureThreshold: 3

    # VolumeæŒ‚è½½
    volumeMounts:
    - name: nginx-config
      mountPath: /etc/nginx/nginx.conf
      subPath: nginx.conf
      readOnly: true
    - name: web-content
      mountPath: /var/www/html
      readOnly: true
    - name: shared-logs
      mountPath: /var/log/nginx
    - name: tls-certs
      mountPath: /etc/nginx/ssl
      readOnly: true

    # ç¯å¢ƒå˜é‡ (DownwardAPI)
    env:
    - name: POD_NAME
      valueFrom:
        fieldRef:
          fieldPath: metadata.name
    - name: POD_NAMESPACE
      valueFrom:
        fieldRef:
          fieldPath: metadata.namespace
    - name: POD_IP
      valueFrom:
        fieldRef:
          fieldPath: status.podIP

  # å®¹å™¨2: Fluentdæ—¥å¿—æ”¶é›†Sidecar
  - name: fluentd
    image: fluent/fluentd:v1.16-debian-1
    ports:
    - containerPort: 24224
      name: fluentd
      protocol: TCP

    resources:
      requests:
        cpu: 50m
        memory: 64Mi
      limits:
        cpu: 200m
        memory: 256Mi

    volumeMounts:
    - name: fluentd-config
      mountPath: /fluentd/etc/fluent.conf
      subPath: fluent.conf
      readOnly: true
    - name: shared-logs
      mountPath: /var/log/nginx
      readOnly: true

  # Volumes
  volumes:
  # ä¸´æ—¶å·: æ—¥å¿—å…±äº«
  - name: shared-logs
    emptyDir: {}

  # ä¸´æ—¶å·: é™æ€èµ„æº
  - name: web-content
    emptyDir:
      sizeLimit: 100Mi

  # ConfigMap: Nginxé…ç½®
  - name: nginx-config
    configMap:
      name: nginx-config

  # ConfigMap: Fluentdé…ç½®
  - name: fluentd-config
    configMap:
      name: fluentd-config

  # Secret: TLSè¯ä¹¦
  - name: tls-certs
    secret:
      secretName: tls-secret
      defaultMode: 0400

  # é‡å¯ç­–ç•¥
  restartPolicy: Always
```

**æ­¥éª¤3: éƒ¨ç½²ä¸éªŒè¯**

```bash
# 1. åˆ›å»ºConfigMapå’ŒSecret
kubectl apply -f configmap-secret.yaml

# 2. åˆ›å»ºPod
kubectl apply -f production-web.yaml

# 3. æŸ¥çœ‹PodçŠ¶æ€
kubectl get pod production-web -o wide
# NAME              READY   STATUS    RESTARTS   AGE   IP            NODE
# production-web    2/2     Running   0          30s   10.244.1.50   node-1

# 4. æŸ¥çœ‹Initå®¹å™¨æ—¥å¿—
kubectl logs production-web -c wait-for-db
# ç­‰å¾…PostgreSQLå°±ç»ª...
# æ•°æ®åº“å·²å°±ç»ª,ç»§ç»­å¯åŠ¨...

kubectl logs production-web -c download-assets
# ä¸‹è½½é™æ€èµ„æºåˆ° /work-dir...
# é™æ€èµ„æºä¸‹è½½å®Œæˆ!

# 5. æŸ¥çœ‹Nginxå®¹å™¨æ—¥å¿—
kubectl logs production-web -c nginx
# /docker-entrypoint.sh: Launching /docker-entrypoint.d/...
# ...

# 6. æŸ¥çœ‹Fluentdæ—¥å¿—æ”¶é›†
kubectl logs production-web -c fluentd -f
# (å®æ—¶æ—¥å¿—è¾“å‡º)

# 7. æµ‹è¯•å¥åº·æ£€æŸ¥
kubectl exec production-web -c nginx -- curl -s localhost:80/healthz
# healthy

kubectl exec production-web -c nginx -- curl -s localhost:80/ready
# ready

# 8. è®¿é—®WebæœåŠ¡
kubectl port-forward production-web 8080:80 &
curl http://localhost:8080
# <!DOCTYPE html>
# <html>
# <head><title>Production Web App</title></head>
# ...

# 9. æŸ¥çœ‹èµ„æºä½¿ç”¨
kubectl top pod production-web
# NAME              CPU(cores)   MEMORY(bytes)
# production-web    120m         180Mi

# 10. æŸ¥çœ‹QoSç­‰çº§
kubectl get pod production-web -o jsonpath='{.status.qosClass}'
# Burstable

# 11. éªŒè¯VolumeæŒ‚è½½
kubectl exec production-web -c nginx -- ls -la /etc/nginx/nginx.conf
# -r--r--r-- 1 root root 1234 Dec 16 10:00 /etc/nginx/nginx.conf

kubectl exec production-web -c nginx -- ls /var/log/nginx
# access.log  error.log

kubectl exec production-web -c nginx -- ls -la /etc/nginx/ssl
# -r-------- 1 root root 1234 Dec 16 10:00 tls.crt
# -r-------- 1 root root 1234 Dec 16 10:00 tls.key

# 12. éªŒè¯å®¹å™¨é—´é€šä¿¡
kubectl exec production-web -c nginx -- nc -zv localhost 24224
# localhost (127.0.0.1:24224) open
```

**æ­¥éª¤4: æ•…éšœæ¨¡æ‹Ÿä¸è‡ªæ„ˆæµ‹è¯•**

```bash
# æµ‹è¯•1: æ€æ­»Nginxè¿›ç¨‹ (Liveness Probeè§¦å‘é‡å¯)
kubectl exec production-web -c nginx -- nginx -s stop
# Nginxåœæ­¢ â†’ Liveness Probeå¤±è´¥ â†’ å®¹å™¨é‡å¯

kubectl get pod production-web --watch
# NAME              READY   STATUS    RESTARTS   AGE
# production-web    2/2     Running   0          5m
# production-web    1/2     Running   1          5m10s  â† Nginxé‡å¯
# production-web    2/2     Running   1          5m15s  â† æ¢å¤æ­£å¸¸

# æµ‹è¯•2: æ¨¡æ‹Ÿåº”ç”¨æœªå°±ç»ª (Readiness Probeç§»é™¤Pod from Service)
# (éœ€å…ˆåˆ›å»ºService,è§ä¸‹æ–¹)

# æµ‹è¯•3: èµ„æºå‹æµ‹ (éªŒè¯limitsç”Ÿæ•ˆ)
kubectl exec production-web -c nginx -- sh -c "while true; do :; done" &
kubectl top pod production-web
# CPUä½¿ç”¨è¾¾åˆ°500m (limits) â†’ è¢«throttle
```


### 2.9.2 é¡¹ç›®2: æ•°æ®åº“åˆå§‹åŒ–Pod (Initå®¹å™¨å®æˆ˜)

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: app-with-db-migration
spec:
  initContainers:
  # Init-1: ç­‰å¾…æ•°æ®åº“å¯ç”¨
  - name: wait-for-postgres
    image: postgres:15-alpine
    command:
    - sh
    - -c
    - |
      until pg_isready -h postgres.default.svc.cluster.local -p 5432 -U admin; do
        echo "ç­‰å¾…PostgreSQLå°±ç»ª..."
        sleep 2
      done
      echo "æ•°æ®åº“å·²å°±ç»ª!"
    env:
    - name: PGPASSWORD
      valueFrom:
        secretKeyRef:
          name: db-secret
          key: password

  # Init-2: æ•°æ®åº“è¿ç§»
  - name: run-migrations
    image: migrate/migrate:v4.16
    command:
    - sh
    - -c
    - |
      echo "æ‰§è¡Œæ•°æ®åº“è¿ç§»..."
      migrate -path /migrations \
              -database "postgres://admin:${DB_PASSWORD}@postgres:5432/mydb?sslmode=disable" \
              up
      echo "è¿ç§»å®Œæˆ!"
    env:
    - name: DB_PASSWORD
      valueFrom:
        secretKeyRef:
          name: db-secret
          key: password
    volumeMounts:
    - name: migrations
      mountPath: /migrations
      readOnly: true

  containers:
  - name: app
    image: myapp:1.0
    env:
    - name: DATABASE_URL
      value: "postgres://admin@postgres:5432/mydb"
    - name: DB_PASSWORD
      valueFrom:
        secretKeyRef:
          name: db-secret
          key: password

  volumes:
  - name: migrations
    configMap:
      name: db-migrations
```


### 2.9.3 é¡¹ç›®3: ç›‘æ§Agent Pod (DownwardAPIå®æˆ˜)

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: monitoring-agent
  labels:
    app: agent
    version: "2.0"
  annotations:
    prometheus.io/scrape: "true"
    prometheus.io/port: "9090"
spec:
  containers:
  - name: agent
    image: prom/node-exporter:latest
    ports:
    - containerPort: 9090
      name: metrics

    env:
    # æ³¨å…¥Podå…ƒæ•°æ®
    - name: POD_NAME
      valueFrom:
        fieldRef:
          fieldPath: metadata.name
    - name: POD_NAMESPACE
      valueFrom:
        fieldRef:
          fieldPath: metadata.namespace
    - name: NODE_NAME
      valueFrom:
        fieldRef:
          fieldPath: spec.nodeName
    - name: CPU_REQUEST
      valueFrom:
        resourceFieldRef:
          containerName: agent
          resource: requests.cpu
    - name: MEMORY_LIMIT
      valueFrom:
        resourceFieldRef:
          containerName: agent
          resource: limits.memory

    resources:
      requests:
        cpu: 100m
        memory: 128Mi
      limits:
        cpu: 200m
        memory: 256Mi

    volumeMounts:
    - name: podinfo
      mountPath: /etc/podinfo

  volumes:
  - name: podinfo
    downwardAPI:
      items:
      - path: "labels"
        fieldRef:
          fieldPath: metadata.labels
      - path: "annotations"
        fieldRef:
          fieldPath: metadata.annotations
      - path: "namespace"
        fieldRef:
          fieldPath: metadata.namespace
      - path: "cpu_limit"
        resourceFieldRef:
          containerName: agent
          resource: limits.cpu
      - path: "mem_request"
        resourceFieldRef:
          containerName: agent
          resource: requests.memory
```


### 2.9.4 å®æˆ˜æ€»ç»“ä¸æœ€ä½³å®è·µ

**ç”Ÿäº§çº§Podé…ç½®æ¸…å•**:

```yaml
# âœ… ç”Ÿäº§çº§Podå¿…å¤‡é…ç½®
apiVersion: v1
kind: Pod
metadata:
  name: production-app
  labels:                       # âœ… å¿…é¡»: ç”¨äºServiceé€‰æ‹©
    app: myapp
    tier: backend
  annotations:                  # âœ… æ¨è: ç‰ˆæœ¬å’Œæè¿°ä¿¡æ¯
    version: "1.2.3"
spec:
  # 1. èµ„æºç®¡ç† (å¿…é¡»)
  containers:
  - name: app
    image: myapp:1.2.3          # âœ… å›ºå®šç‰ˆæœ¬,ç¦æ­¢latest
    resources:                  # âœ… å¿…é¡»: è®¾ç½®requestså’Œlimits
      requests:
        cpu: 100m
        memory: 128Mi
      limits:
        cpu: 500m
        memory: 512Mi

    # 2. å¥åº·æ£€æŸ¥ (å¿…é¡»)
    livenessProbe:              # âœ… å¿…é¡»: é˜²æ­¢æ­»é”
      httpGet:
        path: /healthz
        port: 8080
      initialDelaySeconds: 30
      periodSeconds: 10
      failureThreshold: 3

    readinessProbe:             # âœ… å¿…é¡»: æ§åˆ¶æµé‡
      httpGet:
        path: /ready
        port: 8080
      initialDelaySeconds: 5
      periodSeconds: 5

    # 3. ç”Ÿå‘½å‘¨æœŸé’©å­ (æ¨è)
    lifecycle:
      preStop:                  # âœ… æ¨è: ä¼˜é›…ç»ˆæ­¢
        exec:
          command: ["/bin/sh", "-c", "sleep 15"]

  # 4. é‡å¯ç­–ç•¥ (å¿…é¡»)
  restartPolicy: Always         # âœ… é»˜è®¤Always (ç”Ÿäº§ç¯å¢ƒ)

  # 5. å®‰å…¨ä¸Šä¸‹æ–‡ (æ¨è)
  securityContext:              # âœ… æ¨è: érootè¿è¡Œ
    runAsNonRoot: true
    runAsUser: 1000
    fsGroup: 2000
```

**å¸¸è§é”™è¯¯ä¸è§£å†³**:

| é”™è¯¯ | åŸå›  | è§£å†³æ–¹æ¡ˆ |
|------|------|---------|
| Pod Pending | èµ„æºä¸è¶³ / è°ƒåº¦å¤±è´¥ | `kubectl describe pod` æŸ¥çœ‹Events |
| CrashLoopBackOff | å®¹å™¨å¯åŠ¨å¤±è´¥åå¤é‡å¯ | æ£€æŸ¥æ—¥å¿— `kubectl logs` |
| ImagePullBackOff | é•œåƒæ‹‰å–å¤±è´¥ | æ£€æŸ¥é•œåƒåç§°å’Œè®¿é—®æƒé™ |
| Init:Error | Initå®¹å™¨å¤±è´¥ | `kubectl logs <pod> -c <init-container>` |
| Readiness Probe Failed | å°±ç»ªæ£€æŸ¥å¤±è´¥ | Podä¸ä¼šæ¥æ”¶æµé‡,æ£€æŸ¥åº”ç”¨å¯åŠ¨ |
| OOMKilled | å†…å­˜è¶…é™ | å¢åŠ `limits.memory`æˆ–ä¼˜åŒ–åº”ç”¨ |


---

## 2.10 æœ¬ç« å°ç»“

æœ¬ç« æ·±å…¥å‰–æäº†Kubernetesçš„æ ¸å¿ƒè°ƒåº¦å•å…ƒ **Pod**,æ¶µç›–äº†ä»åŸºç¡€æ¦‚å¿µåˆ°ç”Ÿäº§å®æˆ˜çš„å®Œæ•´çŸ¥è¯†ä½“ç³»ã€‚

### 2.10.1 æ ¸å¿ƒçŸ¥è¯†ç‚¹å›é¡¾

**1. PodåŸºç¡€ (2.1-2.2)**:
- Podæ˜¯Kubernetesæœ€å°è°ƒåº¦å•å…ƒ,å°è£…ä¸€ä¸ªæˆ–å¤šä¸ªå®¹å™¨
- Pauseå®¹å™¨ä½œä¸ºåŸºç¡€è®¾æ–½å®¹å™¨,è´Ÿè´£ç½‘ç»œå‘½åç©ºé—´å’ŒIPCå‘½åç©ºé—´ç®¡ç†
- Podç”Ÿå‘½å‘¨æœŸ: Pending â†’ Running â†’ Succeeded/Failed
- å®¹å™¨çŠ¶æ€: Waiting â†’ Running â†’ Terminated
- Pod Conditions: PodScheduled/Initialized/ContainersReady/Ready

**2. å®¹å™¨è®¾è®¡æ¨¡å¼ (2.3)**:
- **Sidecaræ¨¡å¼**: æ‰©å±•ä¸»å®¹å™¨åŠŸèƒ½ (æ—¥å¿—æ”¶é›†/ç›‘æ§/æœåŠ¡ç½‘æ ¼)
- **Ambassadoræ¨¡å¼**: ä»£ç†å¤–éƒ¨æœåŠ¡è®¿é—® (æ•°æ®åº“ä»£ç†/Redis Sentinel)
- **Adapteræ¨¡å¼**: æ ‡å‡†åŒ–è¾“å‡ºæ ¼å¼ (æ—¥å¿—æ ¼å¼è½¬æ¢/æŒ‡æ ‡å¯¼å‡º)

**3. Initå®¹å™¨ (2.4)**:
- æŒ‰é¡ºåºæ‰§è¡Œçš„åˆå§‹åŒ–å®¹å™¨,å¿…é¡»å…¨éƒ¨æˆåŠŸ
- ç”¨äºç¯å¢ƒå‡†å¤‡ã€ä¾èµ–æ£€æŸ¥ã€æ•°æ®åº“è¿ç§»
- ä¸ä¸»å®¹å™¨å…±äº«Volume,ä½†ç‹¬ç«‹é•œåƒå’Œèµ„æºé…ç½®

**4. å¥åº·æ£€æŸ¥ (2.5)**:
- **Liveness Probe**: æ£€æµ‹æ­»é”,å¤±è´¥åˆ™é‡å¯å®¹å™¨
- **Readiness Probe**: æ§åˆ¶æµé‡è·¯ç”±,æœªå°±ç»ªåˆ™ä»Serviceç§»é™¤
- **Startup Probe**: æ…¢å¯åŠ¨åº”ç”¨ä¿æŠ¤,æˆåŠŸåæ‰æ‰§è¡ŒLiveness
- æ¢æµ‹æ–¹å¼: HTTP GET / TCP Socket / Exec Command

**5. èµ„æºç®¡ç†ä¸QoS (2.6)**:
- **requests**: è°ƒåº¦ä¿è¯çš„æœ€å°èµ„æº,ç”¨äºè°ƒåº¦å†³ç­–
- **limits**: è¿è¡Œæ—¶é™åˆ¶çš„æœ€å¤§èµ„æº,è¶…é™åˆ™throttle(CPU)æˆ–OOMKilled(å†…å­˜)
- **QoSç­‰çº§**:
  - Guaranteed (requests = limits) â†’ æœ€é«˜ä¼˜å…ˆçº§
  - Burstable (requests < limits) â†’ ä¸­ç­‰ä¼˜å…ˆçº§
  - BestEffort (æ— èµ„æºé…ç½®) â†’ æœ€ä½ä¼˜å…ˆçº§
- **LimitRange**: Namespaceçº§åˆ«å•ä¸ªPodèµ„æºçº¦æŸ
- **ResourceQuota**: Namespaceçº§åˆ«æ€»èµ„æºé…é¢

**6. Podç½‘ç»œ (2.7)**:
- **IP-per-Podæ¨¡å‹**: æ¯ä¸ªPodç‹¬ç«‹IP,Podå†…å®¹å™¨å…±äº«ç½‘ç»œæ ˆ
- **å®¹å™¨é—´é€šä¿¡**: é€šè¿‡localhostäº’ç›¸è®¿é—®
- **è·¨Nodeé€šä¿¡**: CNIæ’ä»¶ (Calico/Flannel/Weave) å®ç°æ— NATé€šä¿¡
- **ServiceæŠ½è±¡**: æä¾›ç¨³å®šçš„ClusterIPå’ŒDNSæœåŠ¡å‘ç°
- **NetworkPolicy**: Podçº§åˆ«ç½‘ç»œéš”ç¦»å’Œè®¿é—®æ§åˆ¶

**7. Podå­˜å‚¨ (2.8)**:
- **ä¸´æ—¶å·**:
  - emptyDir: ä¸Podç”Ÿå‘½å‘¨æœŸç»‘å®š,å®¹å™¨é—´å…±äº«
  - configMap: éæ•æ„Ÿé…ç½®æ•°æ®
  - secret: æ•æ„Ÿæ•°æ® (Base64ç¼–ç )
  - downwardAPI: Pod/å®¹å™¨å…ƒæ•°æ®æ³¨å…¥
- **æŒä¹…å·**: hostPath / PVC (ç¬¬5ç« è¯¦è§£)
- **projectedå·**: èšåˆå¤šä¸ªVolumeæºåˆ°ä¸€ä¸ªç›®å½•

**8. ç”Ÿäº§å®æˆ˜ (2.9)**:
- å¤šå®¹å™¨Podå®Œæ•´é…ç½® (Nginx + Fluentd)
- Initå®¹å™¨å®æˆ˜ (æ•°æ®åº“ç­‰å¾… + èµ„æºä¸‹è½½)
- å¥åº·æ£€æŸ¥å®Œæ•´é…ç½® (Startup/Liveness/Readiness)
- èµ„æºé™åˆ¶ä¸QoSè°ƒä¼˜
- VolumeæŒ‚è½½æœ€ä½³å®è·µ


### 2.10.2 å…³é”®æŠ€æœ¯å¯¹æ¯”

| å¯¹æ¯”ç»´åº¦ | Liveness Probe | Readiness Probe | Startup Probe |
|---------|---------------|-----------------|--------------|
| **ä½œç”¨** | æ£€æµ‹æ­»é” | æ§åˆ¶æµé‡ | æ…¢å¯åŠ¨ä¿æŠ¤ |
| **å¤±è´¥è¡Œä¸º** | é‡å¯å®¹å™¨ | ä»Serviceç§»é™¤ | å®¹å™¨å¤±è´¥ |
| **ä½¿ç”¨åœºæ™¯** | æ‰€æœ‰Podå¿…é¡»é…ç½® | æ‰€æœ‰Podå¿…é¡»é…ç½® | ä»…æ…¢å¯åŠ¨åº”ç”¨ |

| å¯¹æ¯”ç»´åº¦ | emptyDir | hostPath | PVC |
|---------|----------|----------|-----|
| **ç”Ÿå‘½å‘¨æœŸ** | ä¸Podç»‘å®š | ä¸Nodeç»‘å®š | ç‹¬ç«‹äºPod |
| **æ•°æ®æŒä¹…æ€§** | Podåˆ é™¤å³ä¸¢å¤± | Nodeæœ¬åœ°æŒä¹… | è·¨PodæŒä¹… |
| **ä½¿ç”¨åœºæ™¯** | ç¼“å­˜/ä¸´æ—¶æ–‡ä»¶ | Nodeæ—¥å¿—/Docker socket | æ•°æ®åº“/ç”¨æˆ·æ–‡ä»¶ |
| **å®‰å…¨é£é™©** | ä½ | é«˜ (å¯è®¿é—®Nodeæ–‡ä»¶ç³»ç»Ÿ) | ä½ |

| å¯¹æ¯”ç»´åº¦ | Sidecar | Ambassador | Adapter |
|---------|---------|------------|---------|
| **èŒè´£** | æ‰©å±•åŠŸèƒ½ | ä»£ç†é€šä¿¡ | æ ¼å¼è½¬æ¢ |
| **é€šä¿¡æ–¹å‘** | å•å‘ (ä¸»â†’è¾¹) | åŒå‘ (ä¸»â†”å¤–) | å•å‘ (ä¸»â†’å¤–) |
| **ç¤ºä¾‹** | Fluentdæ—¥å¿—æ”¶é›† | HAProxyæ•°æ®åº“ä»£ç† | StatsDæŒ‡æ ‡å¯¼å‡º |


### 2.10.3 ç”Ÿäº§ç¯å¢ƒå¿…å¤‡é…ç½®

```yaml
# ç”Ÿäº§çº§Podæœ€å°é…ç½®æ¨¡æ¿
apiVersion: v1
kind: Pod
metadata:
  name: app
  labels:
    app: myapp                   # âœ… å¿…é¡»
    tier: backend
  annotations:
    version: "1.0.0"              # âœ… æ¨è
spec:
  containers:
  - name: app
    image: myapp:1.0.0            # âœ… å›ºå®šç‰ˆæœ¬
    resources:                    # âœ… å¿…é¡»
      requests:
        cpu: 100m
        memory: 128Mi
      limits:
        cpu: 500m
        memory: 512Mi
    livenessProbe:                # âœ… å¿…é¡»
      httpGet:
        path: /healthz
        port: 8080
      periodSeconds: 10
    readinessProbe:               # âœ… å¿…é¡»
      httpGet:
        path: /ready
        port: 8080
      periodSeconds: 5
  restartPolicy: Always           # âœ… é»˜è®¤
```


### 2.10.4 å¸¸ç”¨è°ƒè¯•å‘½ä»¤é€ŸæŸ¥

```bash
# PodåŸºç¡€æ“ä½œ
kubectl get pods -o wide                    # æŸ¥çœ‹Podè¯¦æƒ… (IP/Node)
kubectl describe pod <pod-name>             # æŸ¥çœ‹Podäº‹ä»¶å’ŒçŠ¶æ€
kubectl logs <pod-name> -c <container>      # æŸ¥çœ‹å®¹å™¨æ—¥å¿—
kubectl exec -it <pod-name> -- bash         # è¿›å…¥å®¹å™¨

# èµ„æºç®¡ç†
kubectl top pod <pod-name>                  # æŸ¥çœ‹èµ„æºä½¿ç”¨
kubectl get pod <pod> -o jsonpath='{.status.qosClass}'  # æŸ¥çœ‹QoSç­‰çº§

# ç½‘ç»œè°ƒè¯•
kubectl get pod <pod> -o jsonpath='{.status.podIP}'     # è·å–Pod IP
kubectl exec <pod> -- nslookup <service>    # DNSæµ‹è¯•
kubectl exec <pod> -- curl <url>            # HTTPæµ‹è¯•

# å­˜å‚¨éªŒè¯
kubectl exec <pod> -- ls -la /mnt           # æŸ¥çœ‹æŒ‚è½½ç‚¹
kubectl get configmap <name> -o yaml        # æŸ¥çœ‹ConfigMap
kubectl get secret <name> -o jsonpath='{.data}'  # æŸ¥çœ‹Secret
```


### 2.10.5 ä¸‹ä¸€ç« é¢„å‘Š

ç¬¬3ç« å°†å­¦ä¹  **å·¥ä½œè´Ÿè½½æ§åˆ¶å™¨**,æŒæ¡å¦‚ä½•ç®¡ç†Podçš„å‰¯æœ¬æ•°é‡ã€æ»šåŠ¨æ›´æ–°å’Œè‡ªåŠ¨æ‰©ç¼©å®¹:

- **Deployment**: æ— çŠ¶æ€åº”ç”¨ç®¡ç† (æ»šåŠ¨æ›´æ–°/ç‰ˆæœ¬å›æ»š/é‡‘ä¸é›€å‘å¸ƒ)
- **StatefulSet**: æœ‰çŠ¶æ€åº”ç”¨ç®¡ç† (ç¨³å®šç½‘ç»œæ ‡è¯†/æœ‰åºéƒ¨ç½²)
- **DaemonSet**: æ¯èŠ‚ç‚¹ä¸€ä¸ªPod (æ—¥å¿—é‡‡é›†/ç›‘æ§Agent)
- **Job & CronJob**: æ‰¹å¤„ç†ä»»åŠ¡ (æ•°æ®åº“å¤‡ä»½/å®šæ—¶ä»»åŠ¡)

é€šè¿‡ç¬¬2ç« çš„å­¦ä¹ ,æˆ‘ä»¬å·²ç»æŒæ¡äº†Podçš„æ ¸å¿ƒåŸç†å’Œæœ€ä½³å®è·µ,è¿™ä¸ºå­¦ä¹ æ›´é«˜å±‚æ¬¡çš„å·¥ä½œè´Ÿè½½æ§åˆ¶å™¨æ‰“ä¸‹äº†åšå®åŸºç¡€!


---

**ç¬¬2ç« ç»“æŸ | æ€»è¡Œæ•°: ~2200è¡Œ | æ ¸å¿ƒæ¦‚å¿µ: Podç”Ÿå‘½å‘¨æœŸã€å®¹å™¨æ¨¡å¼ã€å¥åº·æ£€æŸ¥ã€èµ„æºç®¡ç†ã€ç½‘ç»œå­˜å‚¨**

