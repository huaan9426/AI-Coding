# ç¬¬13ç« ï¼šè‡ªå®šä¹‰èµ„æºä¸Operatorå¼€å‘

## ç« èŠ‚æ¦‚è¿°

åœ¨å‰12ç« ä¸­ï¼Œæˆ‘ä»¬æ·±å…¥å­¦ä¹ äº†Kubernetesçš„æ ¸å¿ƒæ¦‚å¿µå’ŒåŸºç¡€å®æˆ˜ã€‚ä»æœ¬ç« å¼€å§‹ï¼Œæˆ‘ä»¬å°†è¿›å…¥**ä¸­å·ï¼šé«˜çº§ç‰¹æ€§ä¸ç”Ÿæ€é›†æˆ**çš„å­¦ä¹ ã€‚

**æœ¬ç« æ ¸å¿ƒç›®æ ‡**ï¼š
- æ·±å…¥ç†è§£CRDï¼ˆCustom Resource Definitionï¼‰çš„åŸç†ä¸ä½¿ç”¨
- æŒæ¡Operatoræ¨¡å¼çš„è®¾è®¡ç†å¿µ
- å­¦ä¼šä½¿ç”¨Kubebuilderå’ŒOperator SDKå¼€å‘Operator
- å®æˆ˜å¼€å‘ä¸€ä¸ªå®Œæ•´çš„MySQL Operator

**ä¸ºä»€ä¹ˆéœ€è¦CRDå’ŒOperatorï¼Ÿ**

```
Kuberneteså†…ç½®èµ„æºçš„å±€é™æ€§ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  é—®é¢˜1ï¼šæ— æ³•è¡¨è¾¾å¤æ‚çš„åº”ç”¨é€»è¾‘          â”‚
â”‚  ä¾‹å¦‚ï¼šMySQLä¸»ä»å¤åˆ¶ã€Redis Cluster    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  é—®é¢˜2ï¼šæ— æ³•å°è£…è¿ç»´çŸ¥è¯†                â”‚
â”‚  ä¾‹å¦‚ï¼šæ•°æ®åº“å¤‡ä»½ã€æ•…éšœè‡ªåŠ¨æ¢å¤        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  é—®é¢˜3ï¼šæ— æ³•å®ç°åº”ç”¨çº§åˆ«çš„è‡ªåŠ¨åŒ–        â”‚
â”‚  ä¾‹å¦‚ï¼šè‡ªåŠ¨æ‰©å®¹ã€è‡ªåŠ¨å‡çº§ã€è‡ªåŠ¨ä¿®å¤    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

CRD + Operatorçš„è§£å†³æ–¹æ¡ˆï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  âœ… CRDï¼šæ‰©å±•Kubernetes API             â”‚
â”‚     å®šä¹‰è‡ªå®šä¹‰èµ„æºç±»å‹ï¼ˆå¦‚MySQLï¼‰       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  âœ… Operatorï¼šå®ç°è‡ªå®šä¹‰æ§åˆ¶å™¨          â”‚
â”‚     å°è£…è¿ç»´çŸ¥è¯†ï¼Œå®ç°è‡ªåŠ¨åŒ–ç®¡ç†        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  âœ… å£°æ˜å¼APIï¼šç”¨æˆ·åªéœ€å£°æ˜æœŸæœ›çŠ¶æ€     â”‚
â”‚     Operatorè´Ÿè´£å®ç°å’Œç»´æŠ¤è¯¥çŠ¶æ€        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Operatoræ¨¡å¼çš„æ ¸å¿ƒæ€æƒ³**ï¼š

Operator = CRD + Controller + é¢†åŸŸçŸ¥è¯†

```
Operatorå·¥ä½œæµç¨‹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. ç”¨æˆ·åˆ›å»ºè‡ªå®šä¹‰èµ„æºï¼ˆCRï¼‰              â”‚
â”‚     kubectl apply -f mysql-cluster.yaml  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. Operatorç›‘å¬CRå˜åŒ–                   â”‚
â”‚     Watch API Server                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. Operatoræ‰§è¡Œåè°ƒé€»è¾‘ï¼ˆReconcileï¼‰    â”‚
â”‚     - åˆ›å»ºStatefulSetã€Serviceç­‰èµ„æº     â”‚
â”‚     - é…ç½®ä¸»ä»å¤åˆ¶                       â”‚
â”‚     - æ‰§è¡Œå¤‡ä»½ä»»åŠ¡                       â”‚
â”‚     - ç›‘æ§å¥åº·çŠ¶æ€                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  4. æŒç»­ç›‘æ§å¹¶ç»´æŠ¤æœŸæœ›çŠ¶æ€                â”‚
â”‚     - æ•…éšœè‡ªåŠ¨æ¢å¤                       â”‚
â”‚     - è‡ªåŠ¨æ‰©ç¼©å®¹                         â”‚
â”‚     - è‡ªåŠ¨å‡çº§                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æœ¬ç« å­¦ä¹ è·¯å¾„**ï¼š

```
13.1 CRDæ·±å…¥ç†è§£
  â†“
13.2 Operatoræ¨¡å¼ä¸åŸç†
  â†“
13.3 ä½¿ç”¨Kubebuilderå¼€å‘Operator
  â†“
13.4 ä½¿ç”¨Operator SDKå¼€å‘Operator
  â†“
13.5 Operatoræœ€ä½³å®è·µ
  â†“
13.6 å®æˆ˜ï¼šå¼€å‘MySQL Operator
```

---

## 13.1 CRDæ·±å…¥ç†è§£

### 13.1.1 ä»€ä¹ˆæ˜¯CRD

CRD (Custom Resource Definition) æ˜¯Kubernetesæä¾›çš„æ‰©å±•æœºåˆ¶ï¼Œå…è®¸ç”¨æˆ·å®šä¹‰è‡ªå·±çš„èµ„æºç±»å‹ã€‚

**CRD vs å†…ç½®èµ„æº**ï¼š

| ç‰¹æ€§ | å†…ç½®èµ„æº (Pod/Deployment) | è‡ªå®šä¹‰èµ„æº (CRD) |
|------|--------------------------|------------------|
| **å®šä¹‰æ–¹å¼** | Kuberneteså†…ç½® | ç”¨æˆ·è‡ªå®šä¹‰ |
| **APIç«¯ç‚¹** | /api/v1/pods | /apis/group/version/resources |
| **æ§åˆ¶å™¨** | å†…ç½®æ§åˆ¶å™¨ | ç”¨æˆ·å®ç° |
| **éªŒè¯** | å†…ç½®éªŒè¯ | è‡ªå®šä¹‰éªŒè¯ |
| **å­˜å‚¨** | etcd | etcd |
| **kubectlæ”¯æŒ** | åŸç”Ÿæ”¯æŒ | è‡ªåŠ¨æ”¯æŒ |

### 13.1.2 CRDçš„ç»„æˆéƒ¨åˆ†

ä¸€ä¸ªå®Œæ•´çš„CRDåŒ…å«ä»¥ä¸‹éƒ¨åˆ†ï¼š

```yaml
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: mysqls.database.example.com  # å¿…é¡»æ˜¯ <plural>.<group>
spec:
  # 1. APIç»„å’Œç‰ˆæœ¬
  group: database.example.com
  versions:
    - name: v1
      served: true
      storage: true
      schema:
        openAPIV3Schema:
          type: object
          properties:
            spec:
              type: object
              properties:
                replicas:
                  type: integer
                  minimum: 1
                  maximum: 10
                version:
                  type: string
                  enum: ["5.7", "8.0"]
                storage:
                  type: string
                  pattern: '^[0-9]+Gi$'
            status:
              type: object
              properties:
                phase:
                  type: string
                ready:
                  type: integer
  
  # 2. ä½œç”¨åŸŸ
  scope: Namespaced  # æˆ– Cluster
  
  # 3. èµ„æºåç§°
  names:
    plural: mysqls
    singular: mysql
    kind: MySQL
    shortNames:
      - my
  
  # 4. å­èµ„æº
  subresources:
    status: {}
    scale:
      specReplicasPath: .spec.replicas
      statusReplicasPath: .status.ready
```

### 13.1.3 åˆ›å»ºç¬¬ä¸€ä¸ªCRD

**æ­¥éª¤1ï¼šå®šä¹‰CRD**

```yaml
# mysql-crd.yaml
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: mysqls.database.example.com
spec:
  group: database.example.com
  versions:
    - name: v1
      served: true
      storage: true
      schema:
        openAPIV3Schema:
          type: object
          properties:
            spec:
              type: object
              required: ["version", "storage"]
              properties:
                version:
                  type: string
                  description: "MySQL version"
                  enum: ["5.7", "8.0"]
                storage:
                  type: string
                  description: "Storage size"
                  pattern: '^[0-9]+Gi$'
                replicas:
                  type: integer
                  description: "Number of replicas"
                  minimum: 1
                  maximum: 10
                  default: 1
            status:
              type: object
              properties:
                phase:
                  type: string
                  description: "Current phase"
                ready:
                  type: integer
                  description: "Number of ready replicas"
                message:
                  type: string
                  description: "Status message"
      # å®šä¹‰é¢å¤–çš„æ‰“å°åˆ—
      additionalPrinterColumns:
        - name: Version
          type: string
          jsonPath: .spec.version
        - name: Replicas
          type: integer
          jsonPath: .spec.replicas
        - name: Ready
          type: integer
          jsonPath: .status.ready
        - name: Phase
          type: string
          jsonPath: .status.phase
        - name: Age
          type: date
          jsonPath: .metadata.creationTimestamp
  scope: Namespaced
  names:
    plural: mysqls
    singular: mysql
    kind: MySQL
    shortNames:
      - my
  # å¯ç”¨å­èµ„æº
  subresources:
    status: {}
```

**æ­¥éª¤2ï¼šåº”ç”¨CRD**

```bash
# åˆ›å»ºCRD
kubectl apply -f mysql-crd.yaml

# éªŒè¯CRDå·²åˆ›å»º
kubectl get crd mysqls.database.example.com

# æŸ¥çœ‹CRDè¯¦æƒ…
kubectl describe crd mysqls.database.example.com

# æŸ¥çœ‹APIèµ„æº
kubectl api-resources | grep mysql
```

**æ­¥éª¤3ï¼šåˆ›å»ºè‡ªå®šä¹‰èµ„æºå®ä¾‹ï¼ˆCRï¼‰**

```yaml
# mysql-instance.yaml
apiVersion: database.example.com/v1
kind: MySQL
metadata:
  name: my-mysql
  namespace: default
spec:
  version: "8.0"
  storage: "10Gi"
  replicas: 3
```

```bash
# åˆ›å»ºMySQLå®ä¾‹
kubectl apply -f mysql-instance.yaml

# æŸ¥çœ‹MySQLèµ„æº
kubectl get mysql
kubectl get my  # ä½¿ç”¨çŸ­åç§°

# æŸ¥çœ‹è¯¦æƒ…
kubectl describe mysql my-mysql

# ä½¿ç”¨kubectl explainæŸ¥çœ‹å­—æ®µè¯´æ˜
kubectl explain mysql
kubectl explain mysql.spec
kubectl explain mysql.spec.version
```

### 13.1.4 CRDéªŒè¯

Kubernetesæ”¯æŒä¸‰ç§éªŒè¯æ–¹å¼ï¼š

**1. OpenAPI v3 SchemaéªŒè¯ï¼ˆæ¨èï¼‰**

```yaml
schema:
  openAPIV3Schema:
    type: object
    properties:
      spec:
        type: object
        required: ["version"]  # å¿…å¡«å­—æ®µ
        properties:
          version:
            type: string
            enum: ["5.7", "8.0"]  # æšä¸¾å€¼
          replicas:
            type: integer
            minimum: 1  # æœ€å°å€¼
            maximum: 10  # æœ€å¤§å€¼
          storage:
            type: string
            pattern: '^[0-9]+Gi$'  # æ­£åˆ™è¡¨è¾¾å¼
          config:
            type: object
            additionalProperties:  # å…è®¸é¢å¤–å±æ€§
              type: string
```

**2. Validating Webhookï¼ˆé«˜çº§éªŒè¯ï¼‰**

```yaml
# åœ¨CRDä¸­é…ç½®webhook
conversion:
  strategy: Webhook
  webhook:
    clientConfig:
      service:
        namespace: default
        name: mysql-webhook
        path: /validate
    conversionReviewVersions: ["v1"]
```

**3. CEL (Common Expression Language) éªŒè¯ï¼ˆK8S 1.25+ï¼‰**

```yaml
schema:
  openAPIV3Schema:
    type: object
    properties:
      spec:
        type: object
        properties:
          replicas:
            type: integer
          storage:
            type: string
        # CELéªŒè¯è§„åˆ™
        x-kubernetes-validations:
          - rule: "self.replicas <= 10"
            message: "replicas must be <= 10"
          - rule: "self.storage.matches('^[0-9]+Gi$')"
            message: "storage must be in format like 10Gi"
```

### 13.1.5 CRDç‰ˆæœ¬ç®¡ç†

CRDæ”¯æŒå¤šç‰ˆæœ¬ï¼Œå®ç°APIæ¼”è¿›ï¼š

```yaml
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: mysqls.database.example.com
spec:
  group: database.example.com
  versions:
    # v1ç‰ˆæœ¬ï¼ˆå½“å‰å­˜å‚¨ç‰ˆæœ¬ï¼‰
    - name: v1
      served: true
      storage: true  # åªèƒ½æœ‰ä¸€ä¸ªç‰ˆæœ¬è®¾ç½®ä¸ºstorage: true
      schema:
        openAPIV3Schema:
          type: object
          properties:
            spec:
              type: object
              properties:
                version:
                  type: string
                replicas:
                  type: integer
                storage:
                  type: string
    
    # v1beta1ç‰ˆæœ¬ï¼ˆå·²å¼ƒç”¨ï¼‰
    - name: v1beta1
      served: true
      storage: false
      deprecated: true
      deprecationWarning: "database.example.com/v1beta1 MySQL is deprecated; use database.example.com/v1 MySQL"
      schema:
        openAPIV3Schema:
          type: object
          properties:
            spec:
              type: object
              properties:
                mysqlVersion:  # æ—§å­—æ®µå
                  type: string
                instanceCount:  # æ—§å­—æ®µå
                  type: integer
  
  # ç‰ˆæœ¬è½¬æ¢ç­–ç•¥
  conversion:
    strategy: Webhook
    webhook:
      clientConfig:
        service:
          namespace: default
          name: mysql-webhook
          path: /convert
      conversionReviewVersions: ["v1", "v1beta1"]
```

**ç‰ˆæœ¬è½¬æ¢ç¤ºä¾‹**ï¼š

```go
// ç‰ˆæœ¬è½¬æ¢é€»è¾‘
func convertV1beta1ToV1(src *v1beta1.MySQL) *v1.MySQL {
    return &v1.MySQL{
        Spec: v1.MySQLSpec{
            Version:  src.Spec.MysqlVersion,  // å­—æ®µåè½¬æ¢
            Replicas: src.Spec.InstanceCount,
            Storage:  src.Spec.Storage,
        },
    }
}
```

### 13.1.6 CRDå­èµ„æº

**1. Statuså­èµ„æº**

å¯ç”¨statuså­èµ„æºåï¼Œspecå’Œstatuså¯ä»¥åˆ†åˆ«æ›´æ–°ï¼š

```yaml
subresources:
  status: {}
```

```bash
# æ›´æ–°specï¼ˆä¸å½±å“statusï¼‰
kubectl patch mysql my-mysql --type=merge -p '{"spec":{"replicas":5}}'

# æ›´æ–°statusï¼ˆéœ€è¦ç‰¹æ®Šæƒé™ï¼‰
kubectl patch mysql my-mysql --subresource=status --type=merge -p '{"status":{"ready":5}}'
```

**2. Scaleå­èµ„æº**

å¯ç”¨scaleå­èµ„æºåï¼Œå¯ä»¥ä½¿ç”¨kubectl scaleå‘½ä»¤ï¼š

```yaml
subresources:
  scale:
    specReplicasPath: .spec.replicas
    statusReplicasPath: .status.ready
    labelSelectorPath: .status.labelSelector
```

```bash
# ä½¿ç”¨kubectl scale
kubectl scale mysql my-mysql --replicas=5

# ä½¿ç”¨HPAè‡ªåŠ¨æ‰©ç¼©å®¹
kubectl autoscale mysql my-mysql --min=1 --max=10 --cpu-percent=80
```

### 13.1.7 CRDæœ€ä½³å®è·µ

**1. å‘½åè§„èŒƒ**

```yaml
# âœ… å¥½çš„å‘½å
group: database.example.com
kind: MySQL
plural: mysqls
singular: mysql

# âŒ ä¸å¥½çš„å‘½å
group: mygroup
kind: mysql  # é¦–å­—æ¯åº”å¤§å†™
plural: mysql  # åº”è¯¥æ˜¯å¤æ•°å½¢å¼
```

**2. å­—æ®µè®¾è®¡**

```yaml
spec:
  # âœ… ä½¿ç”¨æ˜ç¡®çš„å­—æ®µå
  version: "8.0"
  replicas: 3
  
  # âŒ é¿å…æ¨¡ç³Šçš„å­—æ®µå
  config: "some-config"
  data: "some-data"
  
  # âœ… ä½¿ç”¨åµŒå¥—ç»“æ„ç»„ç»‡ç›¸å…³å­—æ®µ
  storage:
    size: "10Gi"
    storageClassName: "fast-ssd"
  
  # âœ… ä½¿ç”¨æšä¸¾é™åˆ¶å¯é€‰å€¼
  version:
    type: string
    enum: ["5.7", "8.0", "8.1"]
```

**3. éªŒè¯è§„åˆ™**

```yaml
# âœ… æ·»åŠ å®Œæ•´çš„éªŒè¯è§„åˆ™
schema:
  openAPIV3Schema:
    type: object
    required: ["spec"]  # å¿…å¡«å­—æ®µ
    properties:
      spec:
        type: object
        required: ["version", "storage"]
        properties:
          version:
            type: string
            enum: ["5.7", "8.0"]
          replicas:
            type: integer
            minimum: 1
            maximum: 100
          storage:
            type: string
            pattern: '^[0-9]+Gi$'
```

**4. çŠ¶æ€ç®¡ç†**

```yaml
status:
  # âœ… ä½¿ç”¨æ¸…æ™°çš„çŠ¶æ€å­—æ®µ
  phase: "Running"  # Pending/Running/Failed
  ready: 3
  message: "All replicas are ready"
  conditions:
    - type: "Ready"
      status: "True"
      lastTransitionTime: "2024-01-01T00:00:00Z"
      reason: "AllReplicasReady"
      message: "All 3 replicas are ready"
```

### 13.1.8 CRDå®æˆ˜ç»ƒä¹ 

**ç»ƒä¹ 1ï¼šåˆ›å»ºRedis CRD**

```yaml
# redis-crd.yaml
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: redisclusters.cache.example.com
spec:
  group: cache.example.com
  versions:
    - name: v1
      served: true
      storage: true
      schema:
        openAPIV3Schema:
          type: object
          properties:
            spec:
              type: object
              required: ["mode", "replicas"]
              properties:
                mode:
                  type: string
                  enum: ["standalone", "sentinel", "cluster"]
                replicas:
                  type: integer
                  minimum: 1
                version:
                  type: string
                  default: "7.0"
                storage:
                  type: string
                  pattern: '^[0-9]+Gi$'
                  default: "1Gi"
            status:
              type: object
              properties:
                phase:
                  type: string
                ready:
                  type: integer
      additionalPrinterColumns:
        - name: Mode
          type: string
          jsonPath: .spec.mode
        - name: Replicas
          type: integer
          jsonPath: .spec.replicas
        - name: Ready
          type: integer
          jsonPath: .status.ready
        - name: Phase
          type: string
          jsonPath: .status.phase
        - name: Age
          type: date
          jsonPath: .metadata.creationTimestamp
  scope: Namespaced
  names:
    plural: redisclusters
    singular: rediscluster
    kind: RedisCluster
    shortNames:
      - rc
  subresources:
    status: {}
    scale:
      specReplicasPath: .spec.replicas
      statusReplicasPath: .status.ready
```

```bash
# åº”ç”¨CRD
kubectl apply -f redis-crd.yaml

# åˆ›å»ºRediså®ä¾‹
cat <<EOF | kubectl apply -f -
apiVersion: cache.example.com/v1
kind: RedisCluster
metadata:
  name: my-redis
spec:
  mode: cluster
  replicas: 6
  version: "7.0"
  storage: "5Gi"
EOF

# æŸ¥çœ‹Redisèµ„æº
kubectl get rediscluster
kubectl get rc
kubectl describe rc my-redis
```

---

## 13.2 Operatoræ¨¡å¼ä¸åŸç†

### 13.2.1 ä»€ä¹ˆæ˜¯Operator

Operatoræ˜¯ä¸€ç§Kubernetesæ‰©å±•æ¨¡å¼ï¼Œå®ƒä½¿ç”¨è‡ªå®šä¹‰èµ„æºï¼ˆCRï¼‰æ¥ç®¡ç†åº”ç”¨åŠå…¶ç»„ä»¶ã€‚

**Operatorçš„æ ¸å¿ƒç»„æˆ**ï¼š

```
Operator = CRD + Controller + Domain Knowledge

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  CRD (Custom Resource Definition)          â”‚
â”‚  å®šä¹‰è‡ªå®šä¹‰èµ„æºçš„ç»“æ„                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Controller (æ§åˆ¶å™¨)                        â”‚
â”‚  ç›‘å¬èµ„æºå˜åŒ–ï¼Œæ‰§è¡Œåè°ƒé€»è¾‘                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Domain Knowledge (é¢†åŸŸçŸ¥è¯†)                â”‚
â”‚  å°è£…åº”ç”¨çš„è¿ç»´çŸ¥è¯†å’Œæœ€ä½³å®è·µ                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 13.2.2 Operatorçš„å·¥ä½œåŸç†

**æ§åˆ¶å¾ªç¯ï¼ˆControl Loopï¼‰**ï¼š

```go
// Operatoræ§åˆ¶å¾ªç¯ä¼ªä»£ç 
for {
    // 1. ç›‘å¬èµ„æºå˜åŒ–
    event := watchResource()
    
    // 2. è·å–æœŸæœ›çŠ¶æ€
    desired := event.Object.Spec
    
    // 3. è·å–å½“å‰çŠ¶æ€
    current := getCurrentState()
    
    // 4. åè°ƒï¼ˆReconcileï¼‰
    if current != desired {
        // æ‰§è¡Œæ“ä½œä½¿å½“å‰çŠ¶æ€æ¥è¿‘æœŸæœ›çŠ¶æ€
        reconcile(current, desired)
    }
    
    // 5. æ›´æ–°çŠ¶æ€
    updateStatus(current)
}
```

**Reconcileåè°ƒé€»è¾‘**ï¼š

```
Reconcileæµç¨‹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. è·å–CRï¼ˆCustom Resourceï¼‰            â”‚
â”‚     å¦‚æœä¸å­˜åœ¨ï¼Œæ‰§è¡Œæ¸…ç†é€»è¾‘å¹¶è¿”å›        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. æ£€æŸ¥Finalizer                        â”‚
â”‚     å¦‚æœCRè¢«åˆ é™¤ï¼Œæ‰§è¡Œæ¸…ç†é€»è¾‘            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. åè°ƒå­èµ„æº                           â”‚
â”‚     - åˆ›å»º/æ›´æ–°StatefulSet               â”‚
â”‚     - åˆ›å»º/æ›´æ–°Service                   â”‚
â”‚     - åˆ›å»º/æ›´æ–°ConfigMap                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  4. æ‰§è¡Œä¸šåŠ¡é€»è¾‘                         â”‚
â”‚     - é…ç½®ä¸»ä»å¤åˆ¶                       â”‚
â”‚     - æ‰§è¡Œå¤‡ä»½ä»»åŠ¡                       â”‚
â”‚     - ç›‘æ§å¥åº·çŠ¶æ€                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  5. æ›´æ–°Status                           â”‚
â”‚     è®°å½•å½“å‰çŠ¶æ€å’Œé”™è¯¯ä¿¡æ¯                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 13.2.3 Operatorèƒ½åŠ›ç­‰çº§

CNCFå®šä¹‰äº†Operatorçš„5ä¸ªèƒ½åŠ›ç­‰çº§ï¼š

```
Operatorèƒ½åŠ›ç­‰çº§æ¨¡å‹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Level 5: Auto Pilot (è‡ªåŠ¨é©¾é©¶)            â”‚
â”‚  âœ… è‡ªåŠ¨æ‰©ç¼©å®¹                             â”‚
â”‚  âœ… è‡ªåŠ¨è°ƒä¼˜                               â”‚
â”‚  âœ… å¼‚å¸¸æ£€æµ‹ä¸è‡ªåŠ¨ä¿®å¤                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Level 4: Deep Insights (æ·±åº¦æ´å¯Ÿ)         â”‚
â”‚  âœ… ç›‘æ§æŒ‡æ ‡                               â”‚
â”‚  âœ… å‘Šè­¦                                   â”‚
â”‚  âœ… æ—¥å¿—èšåˆ                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Level 3: Full Lifecycle (å…¨ç”Ÿå‘½å‘¨æœŸ)      â”‚
â”‚  âœ… åº”ç”¨å‡çº§                               â”‚
â”‚  âœ… å¤‡ä»½ä¸æ¢å¤                             â”‚
â”‚  âœ… æ•…éšœè½¬ç§»                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Level 2: Seamless Upgrades (æ— ç¼å‡çº§)     â”‚
â”‚  âœ… æ»šåŠ¨æ›´æ–°                               â”‚
â”‚  âœ… ç‰ˆæœ¬ç®¡ç†                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Level 1: Basic Install (åŸºç¡€å®‰è£…)         â”‚
â”‚  âœ… è‡ªåŠ¨åŒ–éƒ¨ç½²                             â”‚
â”‚  âœ… é…ç½®ç®¡ç†                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 13.2.4 å¸¸è§çš„Operatorç¤ºä¾‹

**1. Prometheus Operator**

```yaml
apiVersion: monitoring.coreos.com/v1
kind: Prometheus
metadata:
  name: prometheus
spec:
  replicas: 2
  serviceAccountName: prometheus
  serviceMonitorSelector:
    matchLabels:
      team: frontend
  resources:
    requests:
      memory: 400Mi
```

**2. MySQL Operator (Percona)**

```yaml
apiVersion: pxc.percona.com/v1
kind: PerconaXtraDBCluster
metadata:
  name: cluster1
spec:
  crVersion: 1.12.0
  secretsName: my-cluster-secrets
  pxc:
    size: 3
    image: percona/percona-xtradb-cluster:8.0.27
    resources:
      requests:
        memory: 1G
        cpu: 600m
```

**3. Elasticsearch Operator**

```yaml
apiVersion: elasticsearch.k8s.elastic.co/v1
kind: Elasticsearch
metadata:
  name: quickstart
spec:
  version: 8.5.0
  nodeSets:
  - name: default
    count: 3
    config:
      node.store.allow_mmap: false
```

### 13.2.5 Operatorå¼€å‘æ¡†æ¶å¯¹æ¯”

| ç‰¹æ€§ | Kubebuilder | Operator SDK | KUDO |
|------|-------------|--------------|------|
| **è¯­è¨€** | Go | Go/Ansible/Helm | YAML |
| **å­¦ä¹ æ›²çº¿** | ä¸­ç­‰ | ä¸­ç­‰ | ç®€å• |
| **çµæ´»æ€§** | é«˜ | é«˜ | ä¸­ |
| **ç¤¾åŒºæ”¯æŒ** | å®˜æ–¹ | Red Hat | D2iQ |
| **é€‚ç”¨åœºæ™¯** | å¤æ‚Operator | é€šç”¨Operator | ç®€å•Operator |
| **ä»£ç ç”Ÿæˆ** | å®Œæ•´ | å®Œæ•´ | æœ‰é™ |

æˆ‘ä»¬å°†é‡ç‚¹å­¦ä¹ **Kubebuilder**å’Œ**Operator SDK**ã€‚

---

æ¥ä¸‹æ¥çš„13.3èŠ‚å°†è¯¦ç»†ä»‹ç»å¦‚ä½•ä½¿ç”¨Kubebuilderå¼€å‘Operatorã€‚ç”±äºå†…å®¹è¾ƒé•¿ï¼Œæˆ‘å°†åœ¨ä¸‹ä¸€æ¬¡ç»§ç»­ç¼–å†™ã€‚

**å½“å‰è¿›åº¦**ï¼š
- âœ… 13.1 CRDæ·±å…¥ç†è§£ï¼ˆå®Œæˆï¼‰
- âœ… 13.2 Operatoræ¨¡å¼ä¸åŸç†ï¼ˆå®Œæˆï¼‰
- â³ 13.3 ä½¿ç”¨Kubebuilderå¼€å‘Operatorï¼ˆè¿›è¡Œä¸­ï¼‰
- ğŸ“… 13.4 ä½¿ç”¨Operator SDKå¼€å‘Operatorï¼ˆå¾…ç¼–å†™ï¼‰
- ğŸ“… 13.5 Operatoræœ€ä½³å®è·µï¼ˆå¾…ç¼–å†™ï¼‰
- ğŸ“… 13.6 å®æˆ˜ï¼šå¼€å‘MySQL Operatorï¼ˆå¾…ç¼–å†™ï¼‰

---

## 13.3 ä½¿ç”¨Kubebuilderå¼€å‘Operator

### 13.3.1 Kubebuilderç®€ä»‹

Kubebuilderæ˜¯Kuberneteså®˜æ–¹æ¨èçš„Operatorå¼€å‘æ¡†æ¶ï¼Œç”±Kubernetes SIG API Machineryç»´æŠ¤ã€‚

**Kubebuilderçš„ä¼˜åŠ¿**ï¼š
- âœ… å®˜æ–¹æ”¯æŒï¼Œä¸Kubernetes APIç´§å¯†é›†æˆ
- âœ… è‡ªåŠ¨ç”Ÿæˆè„šæ‰‹æ¶ä»£ç 
- âœ… å†…ç½®æµ‹è¯•æ¡†æ¶
- âœ… æ”¯æŒWebhook
- âœ… å®Œå–„çš„æ–‡æ¡£å’Œç¤¾åŒºæ”¯æŒ

**Kubebuilderé¡¹ç›®ç»“æ„**ï¼š

```
myoperator/
â”œâ”€â”€ api/
â”‚   â””â”€â”€ v1/
â”‚       â”œâ”€â”€ groupversion_info.go
â”‚       â”œâ”€â”€ myresource_types.go      # CRDå®šä¹‰
â”‚       â””â”€â”€ zz_generated.deepcopy.go
â”œâ”€â”€ config/
â”‚   â”œâ”€â”€ crd/                         # CRD YAML
â”‚   â”œâ”€â”€ rbac/                        # RBACé…ç½®
â”‚   â”œâ”€â”€ manager/                     # Operatoréƒ¨ç½²é…ç½®
â”‚   â””â”€â”€ samples/                     # CRç¤ºä¾‹
â”œâ”€â”€ controllers/
â”‚   â”œâ”€â”€ myresource_controller.go     # æ§åˆ¶å™¨é€»è¾‘
â”‚   â””â”€â”€ suite_test.go
â”œâ”€â”€ main.go                          # å…¥å£æ–‡ä»¶
â”œâ”€â”€ Dockerfile
â”œâ”€â”€ Makefile
â””â”€â”€ go.mod
```

### 13.3.2 ç¯å¢ƒå‡†å¤‡

**å®‰è£…ä¾èµ–**ï¼š

```bash
# 1. å®‰è£…Go (1.20+)
wget https://go.dev/dl/go1.21.5.linux-amd64.tar.gz
sudo tar -C /usr/local -xzf go1.21.5.linux-amd64.tar.gz
export PATH=$PATH:/usr/local/go/bin

# 2. å®‰è£…Kubebuilder
curl -L -o kubebuilder https://go.kubebuilder.io/dl/latest/$(go env GOOS)/$(go env GOARCH)
chmod +x kubebuilder && sudo mv kubebuilder /usr/local/bin/

# 3. éªŒè¯å®‰è£…
kubebuilder version

# 4. å®‰è£…kubectlå’Œkindï¼ˆç”¨äºæœ¬åœ°æµ‹è¯•ï¼‰
# kubectlå·²å®‰è£…
kind create cluster --name operator-test

# 5. å®‰è£…controller-genï¼ˆä»£ç ç”Ÿæˆå·¥å…·ï¼‰
go install sigs.k8s.io/controller-tools/cmd/controller-gen@latest
```

### 13.3.3 åˆ›å»ºOperatoré¡¹ç›®

**æ­¥éª¤1ï¼šåˆå§‹åŒ–é¡¹ç›®**

```bash
# åˆ›å»ºé¡¹ç›®ç›®å½•
mkdir guestbook-operator
cd guestbook-operator

# åˆå§‹åŒ–é¡¹ç›®
kubebuilder init   --domain example.com   --repo github.com/example/guestbook-operator   --owner "Your Name"

# æŸ¥çœ‹ç”Ÿæˆçš„æ–‡ä»¶
tree -L 2
```

**æ­¥éª¤2ï¼šåˆ›å»ºAPI**

```bash
# åˆ›å»ºAPIå’ŒController
kubebuilder create api   --group webapp   --version v1   --kind Guestbook   --resource   --controller

# è¿™å°†ç”Ÿæˆï¼š
# - api/v1/guestbook_types.go (CRDå®šä¹‰)
# - controllers/guestbook_controller.go (æ§åˆ¶å™¨)
# - config/crd/bases/webapp.example.com_guestbooks.yaml (CRD YAML)
# - config/samples/webapp_v1_guestbook.yaml (CRç¤ºä¾‹)
```

### 13.3.4 å®šä¹‰CRD

ç¼–è¾‘ `api/v1/guestbook_types.go`ï¼š

```go
package v1

import (
	metav1 "k8s.io/apimachinery/pkg/apis/meta/v1"
)

// GuestbookSpec defines the desired state of Guestbook
type GuestbookSpec struct {
	// +kubebuilder:validation:Minimum=1
	// +kubebuilder:validation:Maximum=10
	// +kubebuilder:default=1
	// Replicas is the number of frontend replicas
	Replicas int32 `json:"replicas,omitempty"`

	// +kubebuilder:validation:Required
	// +kubebuilder:validation:Pattern=`^[a-z0-9]([-a-z0-9]*[a-z0-9])?$`
	// RedisName is the name of the Redis instance
	RedisName string `json:"redisName"`

	// +kubebuilder:validation:Enum=ClusterIP;NodePort;LoadBalancer
	// +kubebuilder:default=ClusterIP
	// ServiceType is the type of Service
	ServiceType string `json:"serviceType,omitempty"`
}

// GuestbookStatus defines the observed state of Guestbook
type GuestbookStatus struct {
	// Phase represents the current phase of the Guestbook
	// +kubebuilder:validation:Enum=Pending;Running;Failed
	Phase string `json:"phase,omitempty"`

	// ReadyReplicas is the number of ready replicas
	ReadyReplicas int32 `json:"readyReplicas,omitempty"`

	// Conditions represent the latest available observations
	Conditions []metav1.Condition `json:"conditions,omitempty"`
}

// +kubebuilder:object:root=true
// +kubebuilder:subresource:status
// +kubebuilder:subresource:scale:specpath=.spec.replicas,statuspath=.status.readyReplicas
// +kubebuilder:printcolumn:name="Replicas",type=integer,JSONPath=`.spec.replicas`
// +kubebuilder:printcolumn:name="Ready",type=integer,JSONPath=`.status.readyReplicas`
// +kubebuilder:printcolumn:name="Phase",type=string,JSONPath=`.status.phase`
// +kubebuilder:printcolumn:name="Age",type=date,JSONPath=`.metadata.creationTimestamp`

// Guestbook is the Schema for the guestbooks API
type Guestbook struct {
	metav1.TypeMeta   `json:",inline"`
	metav1.ObjectMeta `json:"metadata,omitempty"`

	Spec   GuestbookSpec   `json:"spec,omitempty"`
	Status GuestbookStatus `json:"status,omitempty"`
}

// +kubebuilder:object:root=true

// GuestbookList contains a list of Guestbook
type GuestbookList struct {
	metav1.TypeMeta `json:",inline"`
	metav1.ListMeta `json:"metadata,omitempty"`
	Items           []Guestbook `json:"items"`
}

func init() {
	SchemeBuilder.Register(&Guestbook{}, &GuestbookList{})
}
```

**Kubebuilderæ ‡è®°è¯´æ˜**ï¼š

```go
// éªŒè¯æ ‡è®°
// +kubebuilder:validation:Minimum=1              // æœ€å°å€¼
// +kubebuilder:validation:Maximum=10             // æœ€å¤§å€¼
// +kubebuilder:validation:Required               // å¿…å¡«
// +kubebuilder:validation:Pattern=`^[a-z]+$`     // æ­£åˆ™è¡¨è¾¾å¼
// +kubebuilder:validation:Enum=A;B;C             // æšä¸¾å€¼
// +kubebuilder:default=value                     // é»˜è®¤å€¼

// å­èµ„æºæ ‡è®°
// +kubebuilder:subresource:status                // å¯ç”¨statuså­èµ„æº
// +kubebuilder:subresource:scale                 // å¯ç”¨scaleå­èµ„æº

// æ‰“å°åˆ—æ ‡è®°
// +kubebuilder:printcolumn:name="Name",type=string,JSONPath=`.spec.field`

// RBACæ ‡è®°
// +kubebuilder:rbac:groups=webapp.example.com,resources=guestbooks,verbs=get;list;watch;create;update;patch;delete
```

### 13.3.5 ç”Ÿæˆä»£ç å’ŒCRD

```bash
# ç”ŸæˆDeepCopyæ–¹æ³•å’ŒCRD YAML
make generate
make manifests

# æŸ¥çœ‹ç”Ÿæˆçš„CRD
cat config/crd/bases/webapp.example.com_guestbooks.yaml
```

### 13.3.6 å®ç°Controlleré€»è¾‘

ç¼–è¾‘ `controllers/guestbook_controller.go`ï¼š

```go
package controllers

import (
	"context"
	"fmt"

	appsv1 "k8s.io/api/apps/v1"
	corev1 "k8s.io/api/core/v1"
	"k8s.io/apimachinery/pkg/api/errors"
	metav1 "k8s.io/apimachinery/pkg/apis/meta/v1"
	"k8s.io/apimachinery/pkg/runtime"
	"k8s.io/apimachinery/pkg/types"
	ctrl "sigs.k8s.io/controller-runtime"
	"sigs.k8s.io/controller-runtime/pkg/client"
	"sigs.k8s.io/controller-runtime/pkg/controller/controllerutil"
	"sigs.k8s.io/controller-runtime/pkg/log"

	webappv1 "github.com/example/guestbook-operator/api/v1"
)

// GuestbookReconciler reconciles a Guestbook object
type GuestbookReconciler struct {
	client.Client
	Scheme *runtime.Scheme
}

// +kubebuilder:rbac:groups=webapp.example.com,resources=guestbooks,verbs=get;list;watch;create;update;patch;delete
// +kubebuilder:rbac:groups=webapp.example.com,resources=guestbooks/status,verbs=get;update;patch
// +kubebuilder:rbac:groups=webapp.example.com,resources=guestbooks/finalizers,verbs=update
// +kubebuilder:rbac:groups=apps,resources=deployments,verbs=get;list;watch;create;update;patch;delete
// +kubebuilder:rbac:groups=core,resources=services,verbs=get;list;watch;create;update;patch;delete

// Reconcile is part of the main kubernetes reconciliation loop
func (r *GuestbookReconciler) Reconcile(ctx context.Context, req ctrl.Request) (ctrl.Result, error) {
	log := log.FromContext(ctx)

	// 1. è·å–Guestbookå®ä¾‹
	guestbook := &webappv1.Guestbook{}
	err := r.Get(ctx, req.NamespacedName, guestbook)
	if err != nil {
		if errors.IsNotFound(err) {
			// èµ„æºå·²è¢«åˆ é™¤
			log.Info("Guestbook resource not found. Ignoring since object must be deleted")
			return ctrl.Result{}, nil
		}
		// è¯»å–å¤±è´¥
		log.Error(err, "Failed to get Guestbook")
		return ctrl.Result{}, err
	}

	// 2. æ£€æŸ¥Deploymentæ˜¯å¦å­˜åœ¨
	deployment := &appsv1.Deployment{}
	err = r.Get(ctx, types.NamespacedName{
		Name:      guestbook.Name,
		Namespace: guestbook.Namespace,
	}, deployment)

	if err != nil && errors.IsNotFound(err) {
		// Deploymentä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°çš„
		dep := r.deploymentForGuestbook(guestbook)
		log.Info("Creating a new Deployment", "Deployment.Namespace", dep.Namespace, "Deployment.Name", dep.Name)
		err = r.Create(ctx, dep)
		if err != nil {
			log.Error(err, "Failed to create new Deployment", "Deployment.Namespace", dep.Namespace, "Deployment.Name", dep.Name)
			return ctrl.Result{}, err
		}
		// Deploymentåˆ›å»ºæˆåŠŸï¼Œé‡æ–°å…¥é˜Ÿ
		return ctrl.Result{Requeue: true}, nil
	} else if err != nil {
		log.Error(err, "Failed to get Deployment")
		return ctrl.Result{}, err
	}

	// 3. ç¡®ä¿Deploymentçš„å‰¯æœ¬æ•°ä¸Specä¸€è‡´
	size := guestbook.Spec.Replicas
	if *deployment.Spec.Replicas != size {
		deployment.Spec.Replicas = &size
		err = r.Update(ctx, deployment)
		if err != nil {
			log.Error(err, "Failed to update Deployment", "Deployment.Namespace", deployment.Namespace, "Deployment.Name", deployment.Name)
			return ctrl.Result{}, err
		}
		// Specæ›´æ–°æˆåŠŸï¼Œé‡æ–°å…¥é˜Ÿ
		return ctrl.Result{Requeue: true}, nil
	}

	// 4. æ£€æŸ¥Serviceæ˜¯å¦å­˜åœ¨
	service := &corev1.Service{}
	err = r.Get(ctx, types.NamespacedName{
		Name:      guestbook.Name,
		Namespace: guestbook.Namespace,
	}, service)

	if err != nil && errors.IsNotFound(err) {
		// Serviceä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°çš„
		svc := r.serviceForGuestbook(guestbook)
		log.Info("Creating a new Service", "Service.Namespace", svc.Namespace, "Service.Name", svc.Name)
		err = r.Create(ctx, svc)
		if err != nil {
			log.Error(err, "Failed to create new Service", "Service.Namespace", svc.Namespace, "Service.Name", svc.Name)
			return ctrl.Result{}, err
		}
		// Serviceåˆ›å»ºæˆåŠŸ
		return ctrl.Result{Requeue: true}, nil
	} else if err != nil {
		log.Error(err, "Failed to get Service")
		return ctrl.Result{}, err
	}

	// 5. æ›´æ–°Status
	guestbook.Status.ReadyReplicas = deployment.Status.ReadyReplicas
	if deployment.Status.ReadyReplicas == size {
		guestbook.Status.Phase = "Running"
	} else {
		guestbook.Status.Phase = "Pending"
	}

	err = r.Status().Update(ctx, guestbook)
	if err != nil {
		log.Error(err, "Failed to update Guestbook status")
		return ctrl.Result{}, err
	}

	return ctrl.Result{}, nil
}

// deploymentForGuestbook returns a Guestbook Deployment object
func (r *GuestbookReconciler) deploymentForGuestbook(g *webappv1.Guestbook) *appsv1.Deployment {
	ls := labelsForGuestbook(g.Name)
	replicas := g.Spec.Replicas

	dep := &appsv1.Deployment{
		ObjectMeta: metav1.ObjectMeta{
			Name:      g.Name,
			Namespace: g.Namespace,
		},
		Spec: appsv1.DeploymentSpec{
			Replicas: &replicas,
			Selector: &metav1.LabelSelector{
				MatchLabels: ls,
			},
			Template: corev1.PodTemplateSpec{
				ObjectMeta: metav1.ObjectMeta{
					Labels: ls,
				},
				Spec: corev1.PodSpec{
					Containers: []corev1.Container{{
						Image:   "gcr.io/google-samples/gb-frontend:v4",
						Name:    "guestbook",
						Ports: []corev1.ContainerPort{{
							ContainerPort: 80,
							Name:          "http",
						}},
						Env: []corev1.EnvVar{{
							Name:  "GET_HOSTS_FROM",
							Value: "dns",
						}},
					}},
				},
			},
		},
	}

	// è®¾ç½®OwnerReference
	controllerutil.SetControllerReference(g, dep, r.Scheme)
	return dep
}

// serviceForGuestbook returns a Guestbook Service object
func (r *GuestbookReconciler) serviceForGuestbook(g *webappv1.Guestbook) *corev1.Service {
	ls := labelsForGuestbook(g.Name)

	svc := &corev1.Service{
		ObjectMeta: metav1.ObjectMeta{
			Name:      g.Name,
			Namespace: g.Namespace,
		},
		Spec: corev1.ServiceSpec{
			Type:     corev1.ServiceType(g.Spec.ServiceType),
			Selector: ls,
			Ports: []corev1.ServicePort{{
				Port:     80,
				Name:     "http",
				Protocol: corev1.ProtocolTCP,
			}},
		},
	}

	// è®¾ç½®OwnerReference
	controllerutil.SetControllerReference(g, svc, r.Scheme)
	return svc
}

// labelsForGuestbook returns the labels for selecting the resources
func labelsForGuestbook(name string) map[string]string {
	return map[string]string{"app": "guestbook", "guestbook_cr": name}
}

// SetupWithManager sets up the controller with the Manager.
func (r *GuestbookReconciler) SetupWithManager(mgr ctrl.Manager) error {
	return ctrl.NewControllerManagedBy(mgr).
		For(&webappv1.Guestbook{}).
		Owns(&appsv1.Deployment{}).
		Owns(&corev1.Service{}).
		Complete(r)
}
```

### 13.3.7 æœ¬åœ°æµ‹è¯•

```bash
# 1. å®‰è£…CRDåˆ°é›†ç¾¤
make install

# 2. éªŒè¯CRDå·²å®‰è£…
kubectl get crd guestbooks.webapp.example.com

# 3. æœ¬åœ°è¿è¡ŒControllerï¼ˆç”¨äºå¼€å‘è°ƒè¯•ï¼‰
make run

# 4. åœ¨å¦ä¸€ä¸ªç»ˆç«¯åˆ›å»ºCR
kubectl apply -f config/samples/webapp_v1_guestbook.yaml

# 5. æŸ¥çœ‹èµ„æº
kubectl get guestbook
kubectl get deployment
kubectl get service

# 6. æŸ¥çœ‹Controlleræ—¥å¿—
# åœ¨è¿è¡Œmake runçš„ç»ˆç«¯æŸ¥çœ‹æ—¥å¿—è¾“å‡º

# 7. æµ‹è¯•æ›´æ–°
kubectl patch guestbook guestbook-sample --type=merge -p '{"spec":{"replicas":3}}'

# 8. æŸ¥çœ‹çŠ¶æ€
kubectl describe guestbook guestbook-sample

# 9. æ¸…ç†
kubectl delete guestbook guestbook-sample
```

### 13.3.8 æ„å»ºå’Œéƒ¨ç½²

**æ­¥éª¤1ï¼šæ„å»ºé•œåƒ**

```bash
# æ„å»ºDockeré•œåƒ
make docker-build IMG=your-registry/guestbook-operator:v0.1.0

# æ¨é€é•œåƒ
make docker-push IMG=your-registry/guestbook-operator:v0.1.0
```

**æ­¥éª¤2ï¼šéƒ¨ç½²åˆ°é›†ç¾¤**

```bash
# éƒ¨ç½²Operator
make deploy IMG=your-registry/guestbook-operator:v0.1.0

# éªŒè¯éƒ¨ç½²
kubectl get deployment -n guestbook-operator-system
kubectl get pods -n guestbook-operator-system

# æŸ¥çœ‹æ—¥å¿—
kubectl logs -n guestbook-operator-system deployment/guestbook-operator-controller-manager
```

**æ­¥éª¤3ï¼šåˆ›å»ºCR**

```yaml
# guestbook-sample.yaml
apiVersion: webapp.example.com/v1
kind: Guestbook
metadata:
  name: my-guestbook
spec:
  replicas: 3
  redisName: redis-master
  serviceType: LoadBalancer
```

```bash
# åº”ç”¨CR
kubectl apply -f guestbook-sample.yaml

# æŸ¥çœ‹èµ„æº
kubectl get guestbook
kubectl get all -l app=guestbook

# è®¿é—®åº”ç”¨
kubectl get svc my-guestbook
# ä½¿ç”¨LoadBalancerçš„EXTERNAL-IPè®¿é—®
```

### 13.3.9 æ·»åŠ Webhook

Webhookç”¨äºéªŒè¯å’Œä¿®æ”¹èµ„æºã€‚

**åˆ›å»ºWebhook**ï¼š

```bash
# åˆ›å»ºWebhook
kubebuilder create webhook   --group webapp   --version v1   --kind Guestbook   --defaulting   --programmatic-validation
```

**å®ç°Webhooké€»è¾‘**ï¼š

ç¼–è¾‘ `api/v1/guestbook_webhook.go`ï¼š

```go
package v1

import (
	"k8s.io/apimachinery/pkg/runtime"
	ctrl "sigs.k8s.io/controller-runtime"
	logf "sigs.k8s.io/controller-runtime/pkg/log"
	"sigs.k8s.io/controller-runtime/pkg/webhook"
)

var guestbooklog = logf.Log.WithName("guestbook-resource")

func (r *Guestbook) SetupWebhookWithManager(mgr ctrl.Manager) error {
	return ctrl.NewWebhookManagedBy(mgr).
		For(r).
		Complete()
}

// +kubebuilder:webhook:path=/mutate-webapp-example-com-v1-guestbook,mutating=true,failurePolicy=fail,sideEffects=None,groups=webapp.example.com,resources=guestbooks,verbs=create;update,versions=v1,name=mguestbook.kb.io,admissionReviewVersions=v1

var _ webhook.Defaulter = &Guestbook{}

// Default implements webhook.Defaulter
func (r *Guestbook) Default() {
	guestbooklog.Info("default", "name", r.Name)

	// è®¾ç½®é»˜è®¤å€¼
	if r.Spec.Replicas == 0 {
		r.Spec.Replicas = 1
	}
	if r.Spec.ServiceType == "" {
		r.Spec.ServiceType = "ClusterIP"
	}
}

// +kubebuilder:webhook:path=/validate-webapp-example-com-v1-guestbook,mutating=false,failurePolicy=fail,sideEffects=None,groups=webapp.example.com,resources=guestbooks,verbs=create;update,versions=v1,name=vguestbook.kb.io,admissionReviewVersions=v1

var _ webhook.Validator = &Guestbook{}

// ValidateCreate implements webhook.Validator
func (r *Guestbook) ValidateCreate() error {
	guestbooklog.Info("validate create", "name", r.Name)

	// éªŒè¯é€»è¾‘
	if r.Spec.Replicas < 1 || r.Spec.Replicas > 10 {
		return fmt.Errorf("replicas must be between 1 and 10")
	}
	return nil
}

// ValidateUpdate implements webhook.Validator
func (r *Guestbook) ValidateUpdate(old runtime.Object) error {
	guestbooklog.Info("validate update", "name", r.Name)

	// éªŒè¯æ›´æ–°é€»è¾‘
	oldGuestbook := old.(*Guestbook)
	if r.Spec.RedisName != oldGuestbook.Spec.RedisName {
		return fmt.Errorf("redisName is immutable")
	}
	return nil
}

// ValidateDelete implements webhook.Validator
func (r *Guestbook) ValidateDelete() error {
	guestbooklog.Info("validate delete", "name", r.Name)
	return nil
}
```

**éƒ¨ç½²Webhook**ï¼š

```bash
# ç”ŸæˆWebhooké…ç½®
make manifests

# éƒ¨ç½²ï¼ˆéœ€è¦cert-managerï¼‰
kubectl apply -f https://github.com/cert-manager/cert-manager/releases/download/v1.13.0/cert-manager.yaml

# é‡æ–°éƒ¨ç½²Operator
make deploy IMG=your-registry/guestbook-operator:v0.1.0
```

### 13.3.10 ç¼–å†™æµ‹è¯•

ç¼–è¾‘ `controllers/guestbook_controller_test.go`ï¼š

```go
package controllers

import (
	"context"
	"time"

	. "github.com/onsi/ginkgo/v2"
	. "github.com/onsi/gomega"
	appsv1 "k8s.io/api/apps/v1"
	corev1 "k8s.io/api/core/v1"
	metav1 "k8s.io/apimachinery/pkg/apis/meta/v1"
	"k8s.io/apimachinery/pkg/types"

	webappv1 "github.com/example/guestbook-operator/api/v1"
)

var _ = Describe("Guestbook Controller", func() {
	const (
		GuestbookName      = "test-guestbook"
		GuestbookNamespace = "default"
		timeout            = time.Second * 10
		interval           = time.Millisecond * 250
	)

	Context("When creating Guestbook", func() {
		It("Should create Deployment and Service", func() {
			By("Creating a new Guestbook")
			ctx := context.Background()
			guestbook := &webappv1.Guestbook{
				TypeMeta: metav1.TypeMeta{
					APIVersion: "webapp.example.com/v1",
					Kind:       "Guestbook",
				},
				ObjectMeta: metav1.ObjectMeta{
					Name:      GuestbookName,
					Namespace: GuestbookNamespace,
				},
				Spec: webappv1.GuestbookSpec{
					Replicas:    3,
					RedisName:   "redis-master",
					ServiceType: "ClusterIP",
				},
			}
			Expect(k8sClient.Create(ctx, guestbook)).Should(Succeed())

			guestbookLookupKey := types.NamespacedName{Name: GuestbookName, Namespace: GuestbookNamespace}
			createdGuestbook := &webappv1.Guestbook{}

			Eventually(func() bool {
				err := k8sClient.Get(ctx, guestbookLookupKey, createdGuestbook)
				return err == nil
			}, timeout, interval).Should(BeTrue())

			By("Checking the Deployment is created")
			deployment := &appsv1.Deployment{}
			Eventually(func() bool {
				err := k8sClient.Get(ctx, guestbookLookupKey, deployment)
				return err == nil
			}, timeout, interval).Should(BeTrue())

			Expect(*deployment.Spec.Replicas).Should(Equal(int32(3)))

			By("Checking the Service is created")
			service := &corev1.Service{}
			Eventually(func() bool {
				err := k8sClient.Get(ctx, guestbookLookupKey, service)
				return err == nil
			}, timeout, interval).Should(BeTrue())

			Expect(service.Spec.Type).Should(Equal(corev1.ServiceTypeClusterIP))
		})
	})
})
```

**è¿è¡Œæµ‹è¯•**ï¼š

```bash
# è¿è¡Œå•å…ƒæµ‹è¯•
make test

# è¿è¡Œé›†æˆæµ‹è¯•
make test-integration
```

---

**å½“å‰ç¬¬13ç« è¿›åº¦**ï¼š
- âœ… 13.1 CRDæ·±å…¥ç†è§£ï¼ˆå®Œæˆï¼‰
- âœ… 13.2 Operatoræ¨¡å¼ä¸åŸç†ï¼ˆå®Œæˆï¼‰
- âœ… 13.3 ä½¿ç”¨Kubebuilderå¼€å‘Operatorï¼ˆå®Œæˆï¼‰
- â³ 13.4 ä½¿ç”¨Operator SDKå¼€å‘Operatorï¼ˆå¾…ç¼–å†™ï¼‰
- ğŸ“… 13.5 Operatoræœ€ä½³å®è·µï¼ˆå¾…ç¼–å†™ï¼‰
- ğŸ“… 13.6 å®æˆ˜ï¼šå¼€å‘MySQL Operatorï¼ˆå¾…ç¼–å†™ï¼‰

æ¥ä¸‹æ¥å°†ç»§ç»­ç¼–å†™13.4-13.6èŠ‚çš„å†…å®¹ã€‚
